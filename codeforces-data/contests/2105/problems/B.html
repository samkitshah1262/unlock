<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Contract for Multiple Voting Proposals</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    .problem-statement {
      background: #fff;
    }
    .header .title {
      font-size: 1.5em;
      font-weight: bold;
      color: #1a1a1a;
      margin-bottom: 10px;
    }
    .time-limit, .memory-limit, .input-file, .output-file {
      color: #666;
      font-size: 0.9em;
      margin: 5px 0;
    }
    .property-title {
      display: inline;
      font-weight: normal;
    }
    .input-specification, .output-specification, .note {
      margin: 20px 0;
    }
    .section-title {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 10px;
      color: #1a1a1a;
    }
    .sample-tests {
      margin: 20px 0;
    }
    .sample-test {
      display: flex;
      gap: 20px;
      margin: 10px 0;
    }
    .input, .output {
      flex: 1;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.9em;
    }
    .MathJax {
      font-size: 1.1em;
    }
    p {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="problem-statement"><div class="header"><div class="title">B. Master Contract for Multiple Voting Proposals</div><div class="time-limit"><div class="property-title">time limit per test</div>60 s</div><div class="memory-limit"><div class="property-title">memory limit per test</div>1024 MB</div><div class="input-file input-standard"><div class="property-title">input</div>standard input</div><div class="output-file output-standard"><div class="property-title">output</div>standard output</div></div><div><p><span>Level 2: Master Contract for Multiple Voting Proposals</span></p><p><span class="tex-font-style-bf">1. Problem Statement</span></p><p>You need to implement two contracts: the <span class="tex-font-style-tt">ProposalMaster</span> contract acting as a proxy that deploys voting proposal contracts very similar to the <span class="tex-font-style-tt">Proposal</span> contract from Level 1, which records users' votes as before.</p><ol> <li> Each <span class="tex-font-style-tt">Proposal</span> contract is identified by its master address and a unique <span class="tex-font-style-tt">proposalId</span> number, which should start from zero and increase by one each time a new proposal is deployed. </li><li> Anyone can deploy a new proposal contract via the <span class="tex-font-style-tt">ProposalMaster</span> contract. </li></ol><p>Each deployed <span class="tex-font-style-tt">Proposal</span> contract must satisfy the following requirements:</p><ol> <li> The voting is time-limited: no more votes can be accepted after the specified duration. </li><li> Only the first hundred (100) votes can be accepted. </li><li> No votes can be accepted after the voting deadline. </li><li> A voter is uniquely identified by their blockchain address. </li><li> Any voter can vote only one time. </li><li> A voter cannot change their mind and change how they cast their vote. </li><li> If a vote is not accepted, an exit code indicating unsuccessful execution must be thrown. </li><li> Your contracts' receivers should not consume too much gas: most tests won't send more than 0.1 Toncoin (the reference solution consumes way below this limit). </li><li> If someone tries to impersonate the <span class="tex-font-style-tt">ProposalMaster</span> contract, the <span class="tex-font-style-tt">Proposal</span> contract should throw exit code <span class="tex-font-style-tt">2025</span>. </li></ol><p><span class="tex-font-style-bf">2. Interfaces</span></p><p>Your submission must adhere to the interfaces described in this section to ensure your contract can be tested automatically.</p><p>If your contract's interfaces are different, the tests will fail.</p><p><span class="tex-font-style-bf">2.1 File name and contract names</span></p><p>Your solution must be submitted in a file named <span class="tex-font-style-tt">solution2.tact</span>, and the contracts must be named <span class="tex-font-style-tt">ProposalMaster</span> and <span class="tex-font-style-tt">Proposal</span>. Both contracts must be implemented in the same file: this is a feature Tact supports.</p><p><span class="tex-font-style-bf">2.2 <span class="tex-font-style-tt">ProposalMaster</span> contract</span></p><p>The <span class="tex-font-style-tt">ProposalMaster</span> contract <a href="https://docs.tact-lang.org/book/contracts/#init-function"><span class="tex-font-style-tt">init()</span> function</a> must not have any arguments. One way to achieve this would be not to have an <span class="tex-font-style-tt">init()</span> function at all.</p><p>An <a href="https://docs.tact-lang.org/book/receive/#receive-internal-messages">empty receiver</a> should be available to deploy the <span class="tex-font-style-tt">ProposalMaster</span> contract:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="pln">receive</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">}</span><br></code></pre><p>To deploy a new voting proposal the <span class="tex-font-style-tt">ProposalMaster</span> contract must accept messages of the <span class="tex-font-style-tt">DeployNewProposal</span> message type:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="pln">message </span><span class="typ">DeployNewProposal</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    votingEndingAt</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Int</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> uint32</span><span class="pun">;</span><br><span class="pun">}</span><br></code></pre><ul> <li> If the current <a href="https://en.wikipedia.org/wiki/Unix_time">Unix time</a> is greater than the value of the <span class="tex-font-style-tt">votingEndingAt</span> field, the new <span class="tex-font-style-tt">Proposal</span> contract must not get deployed. </li></ul><p>The <span class="tex-font-style-tt">ProposalMaster</span> contract needs to have a getter named <span class="tex-font-style-tt">nextProposalId</span> to retrieve the id of the next proposal with the following signature:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="kwd">get</span><span class="pln"> fun nextProposalId</span><span class="pun">():</span><span class="pln"> </span><span class="typ">Int</span><br></code></pre><p><span class="tex-font-style-bf">2.3 <span class="tex-font-style-tt">Proposal</span> contract</span></p><p>Your contract's <a href="https://docs.tact-lang.org/book/contracts/#init-function"><span class="tex-font-style-tt">init()</span> function</a> should receive a single argument of the following type:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="kwd">struct</span><span class="pln"> </span><span class="typ">ProposalInit</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    master</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Address</span><span class="pun">;</span><br><span class="pln">    proposalId</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Int</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> uint32</span><span class="pun">;</span><br><span class="pun">}</span><br></code></pre><ul> <li> The <span class="tex-font-style-tt">master</span> field record the address of the <span class="tex-font-style-tt">ProposalMaster</span> contract that deployed the current voting proposal. </li><li> The <span class="tex-font-style-tt">proposalId</span> field in the init structure ensures that more than one proposal contract can be deployed on the blockchain. </li></ul><p>The <span class="tex-font-style-tt">Proposal</span> contracts need to be initialized with zero vote counts upon deployment.</p><p>To allow casting votes, your <span class="tex-font-style-tt">Proposal</span> contracts need to have a receiver accepting the <span class="tex-font-style-tt">Vote</span> message type:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="pln">message </span><span class="typ">Vote</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Bool</span><span class="pln"> </span><span class="pun">}</span><br></code></pre><p>The <span class="tex-font-style-tt">value</span> field of a <span class="tex-font-style-tt">Vote</span> message means "yes" if it is <span class="tex-font-style-tt">true</span>, or "no" otherwise.</p><p>Your contract needs to have a getter named <span class="tex-font-style-tt">proposalState</span> to retrieve the current voting results with the following signature:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="kwd">get</span><span class="pln"> fun proposalState</span><span class="pun">():</span><span class="pln"> </span><span class="typ">ProposalState</span><br></code></pre><p>This getter above needs to return the following <span class="tex-font-style-tt">ProposalState</span> structure:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="kwd">struct</span><span class="pln"> </span><span class="typ">ProposalState</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    yesCount</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Int</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> uint32</span><span class="pun">;</span><br><span class="pln">    noCount</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Int</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> uint32</span><span class="pun">;</span><br><span class="pln">    master</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Address</span><span class="pun">;</span><br><span class="pln">    proposalId</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Int</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> uint32</span><span class="pun">;</span><br><span class="pln">    votingEndingAt</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Int</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> uint32</span><span class="pun">;</span><br><span class="pun">}</span><br></code></pre><p>If the current <a href="https://en.wikipedia.org/wiki/Unix_time">Unix time</a> is greater than the value of the <span class="tex-font-style-tt">votingEndingAt</span> field, no more votes will be accepted by the <span class="tex-font-style-tt">Proposal</span> contract which gets deployed with this deadline information.</p><p><span class="tex-font-style-bf">2.4 Solution template</span></p><p>You can find the contract interfaces described above in <a href="https://github.com/ton-studio/tact-smart-battle/blob/main/problem2/solution2.tact"><span class="tex-font-style-tt">solution2.tact</span></a>. Notice that you can add new receivers to your contracts in addition to the ones specified in the template.</p><p><span class="tex-font-style-bf">3. Public tests</span></p><p>For a deeper understanding of how your contract will be tested and to ensure full compatibility, please refer to the public interface compatibility test: <a href="https://github.com/ton-studio/tact-smart-battle/blob/main/problem2/public2.spec.ts"><span class="tex-font-style-tt">public2.spec.ts</span></a>.</p><p>Use the following command to execute the automated tests specifically for Level 2:</p><pre class="lstlisting"><code class="prettyprint prettyprinted" style=""><span class="pln">npm run test public2</span><br></code></pre><p>The <span class="tex-font-style-tt">test</span> script automatically compiles all the Tact contracts before running the tests.</p><p>Good luck with implementing <span class="tex-font-style-bf">Level 2</span>!</p></div></div>
</body>
</html>