[
  {
    "id": "ai-mixture-of-experts-taxonomy-of-modern-moe-architectures-1",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Overview",
    "title": "Taxonomy of Modern MoE Architectures",
    "order": 1,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>As Mixture-of-Experts architectures have evolved, researchers have introduced a variety of formulations tailored for efficiency, specialization, and scalability across modalities and tasks. Modern MoE systems can be organized into several key categories—each representing a distinct approach to expert routing, activation, and integration within large-scale models.</li>\n</ul>\n<h4 id=\"sparse-moe-architectures\">Sparse MoE Architectures</h4>\n<ul>\n  <li>\n    <p>Sparse MoE models activate only a small subset of experts for each input, achieving massive parameter scaling while maintaining computational efficiency.</p>\n\n    <ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a></strong> by Fedus et al. (2021) exemplifies this paradigm, using <em>top-1 routing</em> to send each token to a single expert.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a></strong> by Du et al. (2021) extends this with balanced token-to-expert assignments and importance-weighted routing.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2401.04088\">Mixtral-8×7B</a></strong> by Mistral AI (2024) improves upon Switch’s efficiency with optimized load balancing and routing parallelism.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Key property:</strong> Sparse activation ensures that only a fraction of model parameters are active per token, making these architectures ideal for large-scale pretraining.</p>\n  </li>\n</ul>\n<p>Sparse MoE models activate only a small subset of experts for each input, achieving massive parameter scaling while maintaining computational efficiency.</p>\n<ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a></strong> by Fedus et al. (2021) exemplifies this paradigm, using <em>top-1 routing</em> to send each token to a single expert.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a></strong> by Du et al. (2021) extends this with balanced token-to-expert assignments and importance-weighted routing.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2401.04088\">Mixtral-8×7B</a></strong> by Mistral AI (2024) improves upon Switch’s efficiency with optimized load balancing and routing parallelism.</li>\n    </ul>\n<p><strong>Key property:</strong> Sparse activation ensures that only a fraction of model parameters are active per token, making these architectures ideal for large-scale pretraining.</p>\n<h4 id=\"densehybrid-moe-architectures\">Dense–Hybrid MoE Architectures</h4>\n<ul>\n  <li>\n    <p>Dense–Hybrid models blend the efficiency of sparse MoE layers with the robustness of dense transformer blocks. They selectively introduce MoE layers into deeper or more specialized parts of the network.</p>\n\n    <ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2202.08906\">T5-MoE</a></strong> by Zoph et al. (2022) incorporates sparse experts within the feed-forward layers of T5, combining dense attention with sparse computation.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2405.04434\">DeepSeek-V2</a></strong> introduces hybrid routing within both encoder and decoder stacks, adapting expert utilization based on modality and context complexity.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Key property:</strong> Hybrid models retain the stability of dense layers while exploiting MoE sparsity for scaling efficiency.</p>\n  </li>\n</ul>\n<p>Dense–Hybrid models blend the efficiency of sparse MoE layers with the robustness of dense transformer blocks. They selectively introduce MoE layers into deeper or more specialized parts of the network.</p>\n<ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2202.08906\">T5-MoE</a></strong> by Zoph et al. (2022) incorporates sparse experts within the feed-forward layers of T5, combining dense attention with sparse computation.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2405.04434\">DeepSeek-V2</a></strong> introduces hybrid routing within both encoder and decoder stacks, adapting expert utilization based on modality and context complexity.</li>\n    </ul>\n<p><strong>Key property:</strong> Hybrid models retain the stability of dense layers while exploiting MoE sparsity for scaling efficiency.</p>\n<h4 id=\"hierarchical-and-structured-moe-architectures\">Hierarchical and Structured MoE Architectures</h4>\n<ul>\n  <li>\n    <p>Hierarchical MoEs introduce multiple layers or levels of routing, enabling structured specialization. Experts can operate at different semantic or abstraction levels (e.g., local vs. global).</p>\n\n    <ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2210.05144\">Hierarchical Mixture of Experts (HMoE)</a></strong> by Zhou et al. (2022) models expert hierarchies explicitly, allowing high-level experts to coordinate low-level ones.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2505.07260\">Sparse-Transformer++</a></strong> by Xu et al. (2025) implements multi-stage routing—first among global experts, then among local sub-experts—enhancing interpretability and specialization.</li>\n      <li><strong><a href=\"https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf\">HC-SMoE</a></strong> by Chen et al. (2025) clusters experts post-training using hierarchical clustering, merging redundant experts without retraining.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Key property:</strong> These models enable <em>multi-granular routing</em>, improving efficiency and interpretability across hierarchical representations.</p>\n  </li>\n</ul>\n<p>Hierarchical MoEs introduce multiple layers or levels of routing, enabling structured specialization. Experts can operate at different semantic or abstraction levels (e.g., local vs. global).</p>\n<ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2210.05144\">Hierarchical Mixture of Experts (HMoE)</a></strong> by Zhou et al. (2022) models expert hierarchies explicitly, allowing high-level experts to coordinate low-level ones.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2505.07260\">Sparse-Transformer++</a></strong> by Xu et al. (2025) implements multi-stage routing—first among global experts, then among local sub-experts—enhancing interpretability and specialization.</li>\n      <li><strong><a href=\"https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf\">HC-SMoE</a></strong> by Chen et al. (2025) clusters experts post-training using hierarchical clustering, merging redundant experts without retraining.</li>\n    </ul>\n<p><strong>Key property:</strong> These models enable <em>multi-granular routing</em>, improving efficiency and interpretability across hierarchical representations.</p>\n<h4 id=\"joint-moe-and-multimodal-architectures\">Joint MoE and Multimodal Architectures</h4>\n<ul>\n  <li>\n    <p>In multimodal MoE systems, both attention and feed-forward components are expert-based, allowing cross-modal interaction and dynamic parameter sharing.</p>\n\n    <ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2405.11273\">Uni-MoE</a></strong> by Li et al. (2024) jointly routes text and vision tokens through shared experts, unifying multimodal learning.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2503.02495\">Union of Experts</a></strong> by Yang et al. (2025) employs hierarchical routing where global experts manage modality fusion, while local experts refine within-modality reasoning.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Key property:</strong> Joint MoEs exploit shared structure across modalities, enabling scalable multimodal reasoning and cross-domain generalization.</p>\n  </li>\n</ul>\n<p>In multimodal MoE systems, both attention and feed-forward components are expert-based, allowing cross-modal interaction and dynamic parameter sharing.</p>\n<ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2405.11273\">Uni-MoE</a></strong> by Li et al. (2024) jointly routes text and vision tokens through shared experts, unifying multimodal learning.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2503.02495\">Union of Experts</a></strong> by Yang et al. (2025) employs hierarchical routing where global experts manage modality fusion, while local experts refine within-modality reasoning.</li>\n    </ul>\n<p><strong>Key property:</strong> Joint MoEs exploit shared structure across modalities, enabling scalable multimodal reasoning and cross-domain generalization.</p>\n<h4 id=\"adaptive-and-dynamic-moe-architectures\">Adaptive and Dynamic MoE Architectures</h4>\n<ul>\n  <li>\n    <p>These architectures dynamically adjust the number of active experts or routing intensity based on input complexity or importance.</p>\n\n    <ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2406.13233\">AdaMoE</a></strong> by Zeng et al. (2024) introduces token-adaptive routing with <em>null experts</em>, which skip computation for trivial tokens.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2202.09368\">Expert Choice Routing (EC-MoE)</a></strong> by Zhou et al. (2022) reverses the routing direction—allowing experts to choose tokens—achieving better load balancing and conceptual clustering.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Key property:</strong> Adaptive MoEs align compute allocation with token complexity, improving efficiency and semantic coherence.</p>\n  </li>\n</ul>\n<p>These architectures dynamically adjust the number of active experts or routing intensity based on input complexity or importance.</p>\n<ul>\n      <li><strong><a href=\"https://arxiv.org/abs/2406.13233\">AdaMoE</a></strong> by Zeng et al. (2024) introduces token-adaptive routing with <em>null experts</em>, which skip computation for trivial tokens.</li>\n      <li><strong><a href=\"https://arxiv.org/abs/2202.09368\">Expert Choice Routing (EC-MoE)</a></strong> by Zhou et al. (2022) reverses the routing direction—allowing experts to choose tokens—achieving better load balancing and conceptual clustering.</li>\n    </ul>\n<p><strong>Key property:</strong> Adaptive MoEs align compute allocation with token complexity, improving efficiency and semantic coherence.</p>\n<h4 id=\"modern-moe-landscape\">Modern MoE Landscape</h4>\n<div align=\"center\">\n<table class=\"tg\">\n<thead>\n<tr>\n<th class=\"tg-hcenter-valign-first\"><strong>Type</strong></th>\n<th class=\"tg-hcenter-valign-first\"><strong>Representative Models</strong></th>\n<th class=\"tg-hcenter-valign-first\"><strong>Routing Mechanism</strong></th>\n<th class=\"tg-hcenter-valign-second\"><strong>Key Advantage</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tg-tleft-valign-first\">Sparse</td>\n<td class=\"tg-tleft-valign-first\">Switch Transformer, GLaM, Mixtral</td>\n<td class=\"tg-tleft-valign-first\">Top-k token routing</td>\n<td class=\"tg-tleft-valign-second\">Extreme scalability</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Dense–Hybrid</td>\n<td class=\"tg-tleft-valign-first\">T5-MoE, DeepSeek-V2</td>\n<td class=\"tg-tleft-valign-first\">Partial MoE integration</td>\n<td class=\"tg-tleft-valign-second\">Stability + efficiency</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Hierarchical</td>\n<td class=\"tg-tleft-valign-first\">HMoE, Sparse-Transformer++, HC-SMoE</td>\n<td class=\"tg-tleft-valign-first\">Multi-level expert routing</td>\n<td class=\"tg-tleft-valign-second\">Interpretability, multi-scale reasoning</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Joint / Multimodal</td>\n<td class=\"tg-tleft-valign-first\">Uni-MoE, Union of Experts</td>\n<td class=\"tg-tleft-valign-first\">Cross-modal routing</td>\n<td class=\"tg-tleft-valign-second\">Unified multimodal processing</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Adaptive / Dynamic</td>\n<td class=\"tg-tleft-valign-first\">AdaMoE, EC-MoE</td>\n<td class=\"tg-tleft-valign-first\">Token- or expert-adaptive</td>\n<td class=\"tg-tleft-valign-second\">Compute proportional to complexity</td>\n</tr>\n</tbody>\n</table>\n</div>\n<table class=\"tg\">\n<thead>\n<tr>\n<th class=\"tg-hcenter-valign-first\"><strong>Type</strong></th>\n<th class=\"tg-hcenter-valign-first\"><strong>Representative Models</strong></th>\n<th class=\"tg-hcenter-valign-first\"><strong>Routing Mechanism</strong></th>\n<th class=\"tg-hcenter-valign-second\"><strong>Key Advantage</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tg-tleft-valign-first\">Sparse</td>\n<td class=\"tg-tleft-valign-first\">Switch Transformer, GLaM, Mixtral</td>\n<td class=\"tg-tleft-valign-first\">Top-k token routing</td>\n<td class=\"tg-tleft-valign-second\">Extreme scalability</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Dense–Hybrid</td>\n<td class=\"tg-tleft-valign-first\">T5-MoE, DeepSeek-V2</td>\n<td class=\"tg-tleft-valign-first\">Partial MoE integration</td>\n<td class=\"tg-tleft-valign-second\">Stability + efficiency</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Hierarchical</td>\n<td class=\"tg-tleft-valign-first\">HMoE, Sparse-Transformer++, HC-SMoE</td>\n<td class=\"tg-tleft-valign-first\">Multi-level expert routing</td>\n<td class=\"tg-tleft-valign-second\">Interpretability, multi-scale reasoning</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Joint / Multimodal</td>\n<td class=\"tg-tleft-valign-first\">Uni-MoE, Union of Experts</td>\n<td class=\"tg-tleft-valign-first\">Cross-modal routing</td>\n<td class=\"tg-tleft-valign-second\">Unified multimodal processing</td>\n</tr>\n<tr>\n<td class=\"tg-tleft-valign-first\">Adaptive / Dynamic</td>\n<td class=\"tg-tleft-valign-first\">AdaMoE, EC-MoE</td>\n<td class=\"tg-tleft-valign-first\">Token- or expert-adaptive</td>\n<td class=\"tg-tleft-valign-second\">Compute proportional to complexity</td>\n</tr>\n</tbody>\n</table>\n<ul>\n  <li>In essence, modern MoE systems are evolving from simple token-wise routers into <strong>hierarchically organized, multimodal, and adaptive ecosystems</strong> of experts. This taxonomy captures the expanding design space of MoEs — from sparse parameter efficiency to cross-modal intelligence — underscoring their central role in next-generation AI architectures.</li>\n</ul>",
    "contentMarkdown": "*   As Mixture-of-Experts architectures have evolved, researchers have introduced a variety of formulations tailored for efficiency, specialization, and scalability across modalities and tasks. Modern MoE systems can be organized into several key categories—each representing a distinct approach to expert routing, activation, and integration within large-scale models.\n\n#### Sparse MoE Architectures\n\n*   Sparse MoE models activate only a small subset of experts for each input, achieving massive parameter scaling while maintaining computational efficiency.\n    \n    *   **[Switch Transformer](https://arxiv.org/abs/2101.03961)** by Fedus et al. (2021) exemplifies this paradigm, using _top-1 routing_ to send each token to a single expert.\n    *   **[GLaM](https://arxiv.org/abs/2112.06905)** by Du et al. (2021) extends this with balanced token-to-expert assignments and importance-weighted routing.\n    *   **[Mixtral-8×7B](https://arxiv.org/abs/2401.04088)** by Mistral AI (2024) improves upon Switch’s efficiency with optimized load balancing and routing parallelism.\n*   **Key property:** Sparse activation ensures that only a fraction of model parameters are active per token, making these architectures ideal for large-scale pretraining.\n    \n\nSparse MoE models activate only a small subset of experts for each input, achieving massive parameter scaling while maintaining computational efficiency.\n\n*   **[Switch Transformer](https://arxiv.org/abs/2101.03961)** by Fedus et al. (2021) exemplifies this paradigm, using _top-1 routing_ to send each token to a single expert.\n*   **[GLaM](https://arxiv.org/abs/2112.06905)** by Du et al. (2021) extends this with balanced token-to-expert assignments and importance-weighted routing.\n*   **[Mixtral-8×7B](https://arxiv.org/abs/2401.04088)** by Mistral AI (2024) improves upon Switch’s efficiency with optimized load balancing and routing parallelism.\n\n**Key property:** Sparse activation ensures that only a fraction of model parameters are active per token, making these architectures ideal for large-scale pretraining.\n\n#### Dense–Hybrid MoE Architectures\n\n*   Dense–Hybrid models blend the efficiency of sparse MoE layers with the robustness of dense transformer blocks. They selectively introduce MoE layers into deeper or more specialized parts of the network.\n    \n    *   **[T5-MoE](https://arxiv.org/abs/2202.08906)** by Zoph et al. (2022) incorporates sparse experts within the feed-forward layers of T5, combining dense attention with sparse computation.\n    *   **[DeepSeek-V2](https://arxiv.org/abs/2405.04434)** introduces hybrid routing within both encoder and decoder stacks, adapting expert utilization based on modality and context complexity.\n*   **Key property:** Hybrid models retain the stability of dense layers while exploiting MoE sparsity for scaling efficiency.\n    \n\nDense–Hybrid models blend the efficiency of sparse MoE layers with the robustness of dense transformer blocks. They selectively introduce MoE layers into deeper or more specialized parts of the network.\n\n*   **[T5-MoE](https://arxiv.org/abs/2202.08906)** by Zoph et al. (2022) incorporates sparse experts within the feed-forward layers of T5, combining dense attention with sparse computation.\n*   **[DeepSeek-V2](https://arxiv.org/abs/2405.04434)** introduces hybrid routing within both encoder and decoder stacks, adapting expert utilization based on modality and context complexity.\n\n**Key property:** Hybrid models retain the stability of dense layers while exploiting MoE sparsity for scaling efficiency.\n\n#### Hierarchical and Structured MoE Architectures\n\n*   Hierarchical MoEs introduce multiple layers or levels of routing, enabling structured specialization. Experts can operate at different semantic or abstraction levels (e.g., local vs. global).\n    \n    *   **[Hierarchical Mixture of Experts (HMoE)](https://arxiv.org/abs/2210.05144)** by Zhou et al. (2022) models expert hierarchies explicitly, allowing high-level experts to coordinate low-level ones.\n    *   **[Sparse-Transformer++](https://arxiv.org/abs/2505.07260)** by Xu et al. (2025) implements multi-stage routing—first among global experts, then among local sub-experts—enhancing interpretability and specialization.\n    *   **[HC-SMoE](https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf)** by Chen et al. (2025) clusters experts post-training using hierarchical clustering, merging redundant experts without retraining.\n*   **Key property:** These models enable _multi-granular routing_, improving efficiency and interpretability across hierarchical representations.\n    \n\nHierarchical MoEs introduce multiple layers or levels of routing, enabling structured specialization. Experts can operate at different semantic or abstraction levels (e.g., local vs. global).\n\n*   **[Hierarchical Mixture of Experts (HMoE)](https://arxiv.org/abs/2210.05144)** by Zhou et al. (2022) models expert hierarchies explicitly, allowing high-level experts to coordinate low-level ones.\n*   **[Sparse-Transformer++](https://arxiv.org/abs/2505.07260)** by Xu et al. (2025) implements multi-stage routing—first among global experts, then among local sub-experts—enhancing interpretability and specialization.\n*   **[HC-SMoE](https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf)** by Chen et al. (2025) clusters experts post-training using hierarchical clustering, merging redundant experts without retraining.\n\n**Key property:** These models enable _multi-granular routing_, improving efficiency and interpretability across hierarchical representations.\n\n#### Joint MoE and Multimodal Architectures\n\n*   In multimodal MoE systems, both attention and feed-forward components are expert-based, allowing cross-modal interaction and dynamic parameter sharing.\n    \n    *   **[Uni-MoE](https://arxiv.org/abs/2405.11273)** by Li et al. (2024) jointly routes text and vision tokens through shared experts, unifying multimodal learning.\n    *   **[Union of Experts](https://arxiv.org/abs/2503.02495)** by Yang et al. (2025) employs hierarchical routing where global experts manage modality fusion, while local experts refine within-modality reasoning.\n*   **Key property:** Joint MoEs exploit shared structure across modalities, enabling scalable multimodal reasoning and cross-domain generalization.\n    \n\nIn multimodal MoE systems, both attention and feed-forward components are expert-based, allowing cross-modal interaction and dynamic parameter sharing.\n\n*   **[Uni-MoE](https://arxiv.org/abs/2405.11273)** by Li et al. (2024) jointly routes text and vision tokens through shared experts, unifying multimodal learning.\n*   **[Union of Experts](https://arxiv.org/abs/2503.02495)** by Yang et al. (2025) employs hierarchical routing where global experts manage modality fusion, while local experts refine within-modality reasoning.\n\n**Key property:** Joint MoEs exploit shared structure across modalities, enabling scalable multimodal reasoning and cross-domain generalization.\n\n#### Adaptive and Dynamic MoE Architectures\n\n*   These architectures dynamically adjust the number of active experts or routing intensity based on input complexity or importance.\n    \n    *   **[AdaMoE](https://arxiv.org/abs/2406.13233)** by Zeng et al. (2024) introduces token-adaptive routing with _null experts_, which skip computation for trivial tokens.\n    *   **[Expert Choice Routing (EC-MoE)](https://arxiv.org/abs/2202.09368)** by Zhou et al. (2022) reverses the routing direction—allowing experts to choose tokens—achieving better load balancing and conceptual clustering.\n*   **Key property:** Adaptive MoEs align compute allocation with token complexity, improving efficiency and semantic coherence.\n    \n\nThese architectures dynamically adjust the number of active experts or routing intensity based on input complexity or importance.\n\n*   **[AdaMoE](https://arxiv.org/abs/2406.13233)** by Zeng et al. (2024) introduces token-adaptive routing with _null experts_, which skip computation for trivial tokens.\n*   **[Expert Choice Routing (EC-MoE)](https://arxiv.org/abs/2202.09368)** by Zhou et al. (2022) reverses the routing direction—allowing experts to choose tokens—achieving better load balancing and conceptual clustering.\n\n**Key property:** Adaptive MoEs align compute allocation with token complexity, improving efficiency and semantic coherence.\n\n#### Modern MoE Landscape\n\n**Type**\n\n**Representative Models**\n\n**Routing Mechanism**\n\n**Key Advantage**\n\nSparse\n\nSwitch Transformer, GLaM, Mixtral\n\nTop-k token routing\n\nExtreme scalability\n\nDense–Hybrid\n\nT5-MoE, DeepSeek-V2\n\nPartial MoE integration\n\nStability + efficiency\n\nHierarchical\n\nHMoE, Sparse-Transformer++, HC-SMoE\n\nMulti-level expert routing\n\nInterpretability, multi-scale reasoning\n\nJoint / Multimodal\n\nUni-MoE, Union of Experts\n\nCross-modal routing\n\nUnified multimodal processing\n\nAdaptive / Dynamic\n\nAdaMoE, EC-MoE\n\nToken- or expert-adaptive\n\nCompute proportional to complexity\n\n**Type**\n\n**Representative Models**\n\n**Routing Mechanism**\n\n**Key Advantage**\n\nSparse\n\nSwitch Transformer, GLaM, Mixtral\n\nTop-k token routing\n\nExtreme scalability\n\nDense–Hybrid\n\nT5-MoE, DeepSeek-V2\n\nPartial MoE integration\n\nStability + efficiency\n\nHierarchical\n\nHMoE, Sparse-Transformer++, HC-SMoE\n\nMulti-level expert routing\n\nInterpretability, multi-scale reasoning\n\nJoint / Multimodal\n\nUni-MoE, Union of Experts\n\nCross-modal routing\n\nUnified multimodal processing\n\nAdaptive / Dynamic\n\nAdaMoE, EC-MoE\n\nToken- or expert-adaptive\n\nCompute proportional to complexity\n\n*   In essence, modern MoE systems are evolving from simple token-wise routers into **hierarchically organized, multimodal, and adaptive ecosystems** of experts. This taxonomy captures the expanding design space of MoEs — from sparse parameter efficiency to cross-modal intelligence — underscoring their central role in next-generation AI architectures.",
    "contentLength": 13851,
    "wordCount": 1133,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#taxonomy-of-modern-moe-architectures"
  },
  {
    "id": "ai-mixture-of-experts-the-scaling-bottleneck-of-dense-neural-networks-2",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Motivation: Why Mixture-of-Experts?",
    "title": "The Scaling Bottleneck of Dense Neural Networks",
    "order": 2,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>Modern deep learning has been driven by a clear empirical trend: increasing model capacity improves performance when sufficient data and optimization stability are available. This pattern underlies the success of large Transformer-based models such as <a href=\"https://arxiv.org/abs/1810.04805\">BERT</a> by Devlin et al. (2018), <a href=\"https://arxiv.org/abs/2005.14165\">GPT-3</a> by Brown et al. (2020), and <a href=\"https://arxiv.org/abs/2204.02311\">PaLM</a> by Chowdhery et al. (2022). However, dense scaling suffers from a fundamental inefficiency: all parameters are activated for every token.</p>\n  </li>\n  <li>\n    <p>As model size grows, this dense activation regime causes training and inference costs to rise sharply, not only due to increased FLOPs but also because of memory bandwidth pressure, inter-device communication, and synchronization overheads. Shazeer et al. explicitly describe this issue as a “quadratic blow-up” when both model size and dataset size increase in dense architectures (<a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017)). This dense-activation regime quickly becomes economically and physically infeasible at trillion-parameter scale.</p>\n  </li>\n  <li>\n    <p>The core challenge is therefore not a lack of representational power, but the inability of dense architectures to scale computation efficiently with model capacity.</p>\n  </li>\n</ul>\n<p>Modern deep learning has been driven by a clear empirical trend: increasing model capacity improves performance when sufficient data and optimization stability are available. This pattern underlies the success of large Transformer-based models such as <a href=\"https://arxiv.org/abs/1810.04805\">BERT</a> by Devlin et al. (2018), <a href=\"https://arxiv.org/abs/2005.14165\">GPT-3</a> by Brown et al. (2020), and <a href=\"https://arxiv.org/abs/2204.02311\">PaLM</a> by Chowdhery et al. (2022). However, dense scaling suffers from a fundamental inefficiency: all parameters are activated for every token.</p>\n<p>As model size grows, this dense activation regime causes training and inference costs to rise sharply, not only due to increased FLOPs but also because of memory bandwidth pressure, inter-device communication, and synchronization overheads. Shazeer et al. explicitly describe this issue as a “quadratic blow-up” when both model size and dataset size increase in dense architectures (<a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017)). This dense-activation regime quickly becomes economically and physically infeasible at trillion-parameter scale.</p>\n<p>The core challenge is therefore not a lack of representational power, but the inability of dense architectures to scale computation efficiently with model capacity.</p>",
    "contentMarkdown": "*   Modern deep learning has been driven by a clear empirical trend: increasing model capacity improves performance when sufficient data and optimization stability are available. This pattern underlies the success of large Transformer-based models such as [BERT](https://arxiv.org/abs/1810.04805) by Devlin et al. (2018), [GPT-3](https://arxiv.org/abs/2005.14165) by Brown et al. (2020), and [PaLM](https://arxiv.org/abs/2204.02311) by Chowdhery et al. (2022). However, dense scaling suffers from a fundamental inefficiency: all parameters are activated for every token.\n    \n*   As model size grows, this dense activation regime causes training and inference costs to rise sharply, not only due to increased FLOPs but also because of memory bandwidth pressure, inter-device communication, and synchronization overheads. Shazeer et al. explicitly describe this issue as a “quadratic blow-up” when both model size and dataset size increase in dense architectures ([Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017)). This dense-activation regime quickly becomes economically and physically infeasible at trillion-parameter scale.\n    \n*   The core challenge is therefore not a lack of representational power, but the inability of dense architectures to scale computation efficiently with model capacity.\n    \n\nModern deep learning has been driven by a clear empirical trend: increasing model capacity improves performance when sufficient data and optimization stability are available. This pattern underlies the success of large Transformer-based models such as [BERT](https://arxiv.org/abs/1810.04805) by Devlin et al. (2018), [GPT-3](https://arxiv.org/abs/2005.14165) by Brown et al. (2020), and [PaLM](https://arxiv.org/abs/2204.02311) by Chowdhery et al. (2022). However, dense scaling suffers from a fundamental inefficiency: all parameters are activated for every token.\n\nAs model size grows, this dense activation regime causes training and inference costs to rise sharply, not only due to increased FLOPs but also because of memory bandwidth pressure, inter-device communication, and synchronization overheads. Shazeer et al. explicitly describe this issue as a “quadratic blow-up” when both model size and dataset size increase in dense architectures ([Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017)). This dense-activation regime quickly becomes economically and physically infeasible at trillion-parameter scale.\n\nThe core challenge is therefore not a lack of representational power, but the inability of dense architectures to scale computation efficiently with model capacity.",
    "contentLength": 2939,
    "wordCount": 351,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#the-scaling-bottleneck-of-dense-neural-networks"
  },
  {
    "id": "ai-mixture-of-experts-conditional-computation-as-a-principled-solution-3",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Motivation: Why Mixture-of-Experts?",
    "title": "Conditional Computation As a Principled Solution",
    "order": 3,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>\n    <p>Mixture-of-Experts (MoE) architectures address this challenge by introducing conditional computation. Rather than executing the full network for every token, an MoE model activates only a small subset of specialized sub-networks (experts), selected dynamically by a learned routing function.</p>\n  </li>\n  <li>\n    <p>This idea traces back to early modular and ensemble methods such as <a href=\"https://www.cs.toronto.edu/~hinton/absps/jj.pdf\">Adaptive Mixtures of Local Experts</a> by Jacobs et al. (1991) and was later formalized in deep learning contexts through conditional computation frameworks like <a href=\"https://arxiv.org/abs/1308.3432\">Conditional Computation in Neural Networks</a> by Bengio et al. (2013).</p>\n  </li>\n  <li>\n    <p>Formally, given a token representation <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-5-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-13\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-14\"><span class=\"mi\" id=\"MathJax-Span-15\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-5\">x</script>, a router produces a sparse gating vector <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-6-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mi>N</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-16\" style=\"width: 5.107em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.221em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1004.22em, 2.607em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-17\"><span class=\"mi\" id=\"MathJax-Span-18\" style=\"font-family: STIXGeneral-Italic;\">g</span><span class=\"mo\" id=\"MathJax-Span-19\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-20\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-21\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-22\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-23\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-24\"><span class=\"mrow\" id=\"MathJax-Span-25\"><span class=\"mi\" id=\"MathJax-Span-26\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-27\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mi>N</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-6\">g(x) \\in \\mathbb{R}^N</script> over <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-7-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-28\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-29\"><span class=\"mi\" id=\"MathJax-Span-30\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-7\">N</script> experts, and only the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-8-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-31\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-32\"><span class=\"mi\" id=\"MathJax-Span-33\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-8\">k</script> experts are evaluated:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-9-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>y</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mtext>Top-</mtext><mi>k</mi><mo stretchy=&quot;false&quot;>(</mo><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-34\" style=\"width: 13.544em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1011.2em, 3.753em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-35\"><span class=\"mi\" id=\"MathJax-Span-36\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-37\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-38\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-39\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-40\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-41\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 1.357em;\"><span class=\"mo\" id=\"MathJax-Span-42\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1003.96em, 4.43em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-43\"><span class=\"mrow\" id=\"MathJax-Span-44\"><span class=\"mi\" id=\"MathJax-Span-45\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-46\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"mtext\" id=\"MathJax-Span-47\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">Top-</span><span class=\"mi\" id=\"MathJax-Span-48\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-49\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-50\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span class=\"mo\" id=\"MathJax-Span-51\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-52\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-53\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-54\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-55\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-56\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-57\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-58\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-59\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-60\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-61\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-62\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-63\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-64\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-65\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-66\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-67\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.747em; border-left: 0px solid; width: 0px; height: 3.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>y</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><mtext>Top-</mtext><mi>k</mi><mo stretchy=\"false\">(</mo><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow></munder><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>,</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-9\">y(x) = \\sum_{i \\in \\text{Top-}k(g(x))} g_i(x), f_i(x)</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-10-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-68\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-69\"><span class=\"msubsup\" id=\"MathJax-Span-70\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-71\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-72\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-10\">f_i</script> denotes the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-11-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-73\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.94em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-74\"><span class=\"msubsup\" id=\"MathJax-Span-75\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-76\" style=\"font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-77\"><span class=\"mrow\" id=\"MathJax-Span-78\"><span class=\"mi\" id=\"MathJax-Span-79\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-80\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-11\">i^{th}</script> expert network.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This mechanism decouples model capacity from per-token compute, enabling models to grow in parameter count without incurring a proportional increase in computational cost.</p>\n  </li>\n</ul>\n<p>Mixture-of-Experts (MoE) architectures address this challenge by introducing conditional computation. Rather than executing the full network for every token, an MoE model activates only a small subset of specialized sub-networks (experts), selected dynamically by a learned routing function.</p>\n<p>This idea traces back to early modular and ensemble methods such as <a href=\"https://www.cs.toronto.edu/~hinton/absps/jj.pdf\">Adaptive Mixtures of Local Experts</a> by Jacobs et al. (1991) and was later formalized in deep learning contexts through conditional computation frameworks like <a href=\"https://arxiv.org/abs/1308.3432\">Conditional Computation in Neural Networks</a> by Bengio et al. (2013).</p>\n<p>Formally, given a token representation <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-5-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-13\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-14\"><span class=\"mi\" id=\"MathJax-Span-15\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-5\">x</script>, a router produces a sparse gating vector <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-6-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mi>N</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-16\" style=\"width: 5.107em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.221em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1004.22em, 2.607em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-17\"><span class=\"mi\" id=\"MathJax-Span-18\" style=\"font-family: STIXGeneral-Italic;\">g</span><span class=\"mo\" id=\"MathJax-Span-19\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-20\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-21\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-22\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-23\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-24\"><span class=\"mrow\" id=\"MathJax-Span-25\"><span class=\"mi\" id=\"MathJax-Span-26\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-27\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mi>N</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-6\">g(x) \\in \\mathbb{R}^N</script> over <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-7-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-28\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-29\"><span class=\"mi\" id=\"MathJax-Span-30\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-7\">N</script> experts, and only the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-8-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-31\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-32\"><span class=\"mi\" id=\"MathJax-Span-33\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-8\">k</script> experts are evaluated:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-10-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-68\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-69\"><span class=\"msubsup\" id=\"MathJax-Span-70\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-71\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-72\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-10\">f_i</script> denotes the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-11-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-73\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.94em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-74\"><span class=\"msubsup\" id=\"MathJax-Span-75\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-76\" style=\"font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-77\"><span class=\"mrow\" id=\"MathJax-Span-78\"><span class=\"mi\" id=\"MathJax-Span-79\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-80\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-11\">i^{th}</script> expert network.</li>\n    </ul>\n<p>This mechanism decouples model capacity from per-token compute, enabling models to grow in parameter count without incurring a proportional increase in computational cost.</p>",
    "contentMarkdown": "*   Mixture-of-Experts (MoE) architectures address this challenge by introducing conditional computation. Rather than executing the full network for every token, an MoE model activates only a small subset of specialized sub-networks (experts), selected dynamically by a learned routing function.\n    \n*   This idea traces back to early modular and ensemble methods such as [Adaptive Mixtures of Local Experts](https://www.cs.toronto.edu/~hinton/absps/jj.pdf) by Jacobs et al. (1991) and was later formalized in deep learning contexts through conditional computation frameworks like [Conditional Computation in Neural Networks](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013).\n    \n*   Formally, given a token representation xxx, a router produces a sparse gating vector g(x)∈ℝNg(x)∈RNg(x) \\\\in \\\\mathbb{R}^N over NNN experts, and only the top-kkk experts are evaluated:\n    \n    y(x)\\=∑i∈Top-k(g(x))gi(x),fi(x)y(x)\\=∑i∈Top-k(g(x))gi(x),fi(x)\n    \n    y(x) = \\\\sum\\_{i \\\\in \\\\text{Top-}k(g(x))} g\\_i(x), f\\_i(x)\n    *   where fifif\\_i denotes the ithithi^{th} expert network.\n*   This mechanism decouples model capacity from per-token compute, enabling models to grow in parameter count without incurring a proportional increase in computational cost.\n    \n\nMixture-of-Experts (MoE) architectures address this challenge by introducing conditional computation. Rather than executing the full network for every token, an MoE model activates only a small subset of specialized sub-networks (experts), selected dynamically by a learned routing function.\n\nThis idea traces back to early modular and ensemble methods such as [Adaptive Mixtures of Local Experts](https://www.cs.toronto.edu/~hinton/absps/jj.pdf) by Jacobs et al. (1991) and was later formalized in deep learning contexts through conditional computation frameworks like [Conditional Computation in Neural Networks](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013).\n\nFormally, given a token representation xxx, a router produces a sparse gating vector g(x)∈ℝNg(x)∈RNg(x) \\\\in \\\\mathbb{R}^N over NNN experts, and only the top-kkk experts are evaluated:\n\n*   where fifif\\_i denotes the ithithi^{th} expert network.\n\nThis mechanism decouples model capacity from per-token compute, enabling models to grow in parameter count without incurring a proportional increase in computational cost.",
    "contentLength": 31319,
    "wordCount": 292,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#conditional-computation-as-a-principled-solution"
  },
  {
    "id": "ai-mixture-of-experts-scaling-training-with-sparse-activation-4",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Motivation: Why Mixture-of-Experts?",
    "title": "Scaling Training with Sparse Activation",
    "order": 4,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>\n    <p>The primary training advantage of MoE lies in compute-efficient scaling. By activating only a small fraction of parameters per token, MoE models can dramatically increase total parameter count while keeping training FLOPs nearly constant relative to a dense baseline.</p>\n  </li>\n  <li>\n    <p>The sparsely-gated MoE layer introduced by Shazeer et al. (2017) demonstrated that it is possible to train models with orders-of-magnitude more parameters than dense Transformers, while maintaining similar training throughput. This insight was extended to large-scale distributed systems by <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020), which showed that expert parameters could be sharded across thousands of accelerators and trained jointly using sparse routing.</p>\n  </li>\n  <li>\n    <p>Further simplification came from <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021), which demonstrated that routing each token to a single expert is sufficient to retain model quality while substantially reducing communication overhead. These results established sparse MoE as a practical path to training trillion-parameter models.</p>\n  </li>\n  <li>\n    <p>In effect, MoE allows training compute to scale with the number of active experts per token rather than the total number of parameters, fundamentally altering the economics of large-scale pretraining.</p>\n  </li>\n</ul>\n<p>The primary training advantage of MoE lies in compute-efficient scaling. By activating only a small fraction of parameters per token, MoE models can dramatically increase total parameter count while keeping training FLOPs nearly constant relative to a dense baseline.</p>\n<p>The sparsely-gated MoE layer introduced by Shazeer et al. (2017) demonstrated that it is possible to train models with orders-of-magnitude more parameters than dense Transformers, while maintaining similar training throughput. This insight was extended to large-scale distributed systems by <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020), which showed that expert parameters could be sharded across thousands of accelerators and trained jointly using sparse routing.</p>\n<p>Further simplification came from <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021), which demonstrated that routing each token to a single expert is sufficient to retain model quality while substantially reducing communication overhead. These results established sparse MoE as a practical path to training trillion-parameter models.</p>\n<p>In effect, MoE allows training compute to scale with the number of active experts per token rather than the total number of parameters, fundamentally altering the economics of large-scale pretraining.</p>",
    "contentMarkdown": "*   The primary training advantage of MoE lies in compute-efficient scaling. By activating only a small fraction of parameters per token, MoE models can dramatically increase total parameter count while keeping training FLOPs nearly constant relative to a dense baseline.\n    \n*   The sparsely-gated MoE layer introduced by Shazeer et al. (2017) demonstrated that it is possible to train models with orders-of-magnitude more parameters than dense Transformers, while maintaining similar training throughput. This insight was extended to large-scale distributed systems by [GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020), which showed that expert parameters could be sharded across thousands of accelerators and trained jointly using sparse routing.\n    \n*   Further simplification came from [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), which demonstrated that routing each token to a single expert is sufficient to retain model quality while substantially reducing communication overhead. These results established sparse MoE as a practical path to training trillion-parameter models.\n    \n*   In effect, MoE allows training compute to scale with the number of active experts per token rather than the total number of parameters, fundamentally altering the economics of large-scale pretraining.\n    \n\nThe primary training advantage of MoE lies in compute-efficient scaling. By activating only a small fraction of parameters per token, MoE models can dramatically increase total parameter count while keeping training FLOPs nearly constant relative to a dense baseline.\n\nThe sparsely-gated MoE layer introduced by Shazeer et al. (2017) demonstrated that it is possible to train models with orders-of-magnitude more parameters than dense Transformers, while maintaining similar training throughput. This insight was extended to large-scale distributed systems by [GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020), which showed that expert parameters could be sharded across thousands of accelerators and trained jointly using sparse routing.\n\nFurther simplification came from [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), which demonstrated that routing each token to a single expert is sufficient to retain model quality while substantially reducing communication overhead. These results established sparse MoE as a practical path to training trillion-parameter models.\n\nIn effect, MoE allows training compute to scale with the number of active experts per token rather than the total number of parameters, fundamentally altering the economics of large-scale pretraining.",
    "contentLength": 2826,
    "wordCount": 358,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#scaling-training-with-sparse-activation"
  },
  {
    "id": "ai-mixture-of-experts-training-efficiency-and-expert-specialization-5",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Motivation: Why Mixture-of-Experts?",
    "title": "Training Efficiency and Expert Specialization",
    "order": 5,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>\n    <p>From a learning perspective, MoE enables specialization without explicit supervision. Empirical evidence suggests that experts self-organize around latent structures in the data, such as syntax, domain, or modality (<a href=\"https://arxiv.org/abs/2208.02868\">Towards Understanding Mixture of Experts in Deep Learning</a> by Chen et al. (2022)). Because each expert processes a narrower distribution of inputs, gradients are less noisy and convergence can be faster than in dense counterparts of comparable quality.</p>\n  </li>\n  <li>\n    <p>This specialization effect becomes especially important in multilingual, multimodal, and instruction-tuned models, as demonstrated in <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2021), <a href=\"https://arxiv.org/abs/2401.04088\">Mixtral of Experts</a> by Jiang et al. (2024), and <a href=\"https://arxiv.org/abs/2401.08017\">MoE-LLaVA</a> by Xu et al. (2024).</p>\n  </li>\n  <li>\n    <p>In large-scale pretraining regimes, this implicit specialization improves representational efficiency by reducing interference between unrelated patterns, allowing different experts to focus on distinct subspaces of the data distribution while sharing a common embedding and attention backbone.</p>\n  </li>\n</ul>\n<p>From a learning perspective, MoE enables specialization without explicit supervision. Empirical evidence suggests that experts self-organize around latent structures in the data, such as syntax, domain, or modality (<a href=\"https://arxiv.org/abs/2208.02868\">Towards Understanding Mixture of Experts in Deep Learning</a> by Chen et al. (2022)). Because each expert processes a narrower distribution of inputs, gradients are less noisy and convergence can be faster than in dense counterparts of comparable quality.</p>\n<p>This specialization effect becomes especially important in multilingual, multimodal, and instruction-tuned models, as demonstrated in <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2021), <a href=\"https://arxiv.org/abs/2401.04088\">Mixtral of Experts</a> by Jiang et al. (2024), and <a href=\"https://arxiv.org/abs/2401.08017\">MoE-LLaVA</a> by Xu et al. (2024).</p>\n<p>In large-scale pretraining regimes, this implicit specialization improves representational efficiency by reducing interference between unrelated patterns, allowing different experts to focus on distinct subspaces of the data distribution while sharing a common embedding and attention backbone.</p>",
    "contentMarkdown": "*   From a learning perspective, MoE enables specialization without explicit supervision. Empirical evidence suggests that experts self-organize around latent structures in the data, such as syntax, domain, or modality ([Towards Understanding Mixture of Experts in Deep Learning](https://arxiv.org/abs/2208.02868) by Chen et al. (2022)). Because each expert processes a narrower distribution of inputs, gradients are less noisy and convergence can be faster than in dense counterparts of comparable quality.\n    \n*   This specialization effect becomes especially important in multilingual, multimodal, and instruction-tuned models, as demonstrated in [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2021), [Mixtral of Experts](https://arxiv.org/abs/2401.04088) by Jiang et al. (2024), and [MoE-LLaVA](https://arxiv.org/abs/2401.08017) by Xu et al. (2024).\n    \n*   In large-scale pretraining regimes, this implicit specialization improves representational efficiency by reducing interference between unrelated patterns, allowing different experts to focus on distinct subspaces of the data distribution while sharing a common embedding and attention backbone.\n    \n\nFrom a learning perspective, MoE enables specialization without explicit supervision. Empirical evidence suggests that experts self-organize around latent structures in the data, such as syntax, domain, or modality ([Towards Understanding Mixture of Experts in Deep Learning](https://arxiv.org/abs/2208.02868) by Chen et al. (2022)). Because each expert processes a narrower distribution of inputs, gradients are less noisy and convergence can be faster than in dense counterparts of comparable quality.\n\nThis specialization effect becomes especially important in multilingual, multimodal, and instruction-tuned models, as demonstrated in [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2021), [Mixtral of Experts](https://arxiv.org/abs/2401.04088) by Jiang et al. (2024), and [MoE-LLaVA](https://arxiv.org/abs/2401.08017) by Xu et al. (2024).\n\nIn large-scale pretraining regimes, this implicit specialization improves representational efficiency by reducing interference between unrelated patterns, allowing different experts to focus on distinct subspaces of the data distribution while sharing a common embedding and attention backbone.",
    "contentLength": 2487,
    "wordCount": 279,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#training-efficiency-and-expert-specialization"
  },
  {
    "id": "ai-mixture-of-experts-efficient-inference-through-conditional-routing-6",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Motivation: Why Mixture-of-Experts?",
    "title": "Efficient Inference Through Conditional Routing",
    "order": 6,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>\n    <p>At inference time, MoE architectures provide a compelling quality–cost trade-off. Although the total parameter count may be extremely large, inference cost per token depends only on the number of activated experts, not on the full model size.</p>\n  </li>\n  <li>\n    <p>This enables MoE models to achieve performance comparable to very large dense models while maintaining inference latency closer to that of much smaller networks. As a result, MoE is particularly attractive for deployment scenarios where throughput and cost efficiency are critical.</p>\n  </li>\n  <li>\n    <p>Moreover, conditional routing allows computation to adapt to input complexity. Simple or redundant tokens can be handled by a small subset of experts, while more complex tokens may engage more specialized computation paths. This form of adaptive inference is fundamentally unavailable in fully dense architectures.</p>\n  </li>\n</ul>\n<p>At inference time, MoE architectures provide a compelling quality–cost trade-off. Although the total parameter count may be extremely large, inference cost per token depends only on the number of activated experts, not on the full model size.</p>\n<p>This enables MoE models to achieve performance comparable to very large dense models while maintaining inference latency closer to that of much smaller networks. As a result, MoE is particularly attractive for deployment scenarios where throughput and cost efficiency are critical.</p>\n<p>Moreover, conditional routing allows computation to adapt to input complexity. Simple or redundant tokens can be handled by a small subset of experts, while more complex tokens may engage more specialized computation paths. This form of adaptive inference is fundamentally unavailable in fully dense architectures.</p>",
    "contentMarkdown": "*   At inference time, MoE architectures provide a compelling quality–cost trade-off. Although the total parameter count may be extremely large, inference cost per token depends only on the number of activated experts, not on the full model size.\n    \n*   This enables MoE models to achieve performance comparable to very large dense models while maintaining inference latency closer to that of much smaller networks. As a result, MoE is particularly attractive for deployment scenarios where throughput and cost efficiency are critical.\n    \n*   Moreover, conditional routing allows computation to adapt to input complexity. Simple or redundant tokens can be handled by a small subset of experts, while more complex tokens may engage more specialized computation paths. This form of adaptive inference is fundamentally unavailable in fully dense architectures.\n    \n\nAt inference time, MoE architectures provide a compelling quality–cost trade-off. Although the total parameter count may be extremely large, inference cost per token depends only on the number of activated experts, not on the full model size.\n\nThis enables MoE models to achieve performance comparable to very large dense models while maintaining inference latency closer to that of much smaller networks. As a result, MoE is particularly attractive for deployment scenarios where throughput and cost efficiency are critical.\n\nMoreover, conditional routing allows computation to adapt to input complexity. Simple or redundant tokens can be handled by a small subset of experts, while more complex tokens may engage more specialized computation paths. This form of adaptive inference is fundamentally unavailable in fully dense architectures.",
    "contentLength": 1789,
    "wordCount": 249,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#efficient-inference-through-conditional-routing"
  },
  {
    "id": "ai-mixture-of-experts-why-moe-enables-scalable-neural-networks-7",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Motivation: Why Mixture-of-Experts?",
    "title": "Why MoE Enables Scalable Neural Networks",
    "order": 7,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p>Taken together, Mixture-of-Experts architectures provide a structural solution to the scaling limits of dense neural networks. By introducing sparsity at the level of parameter activation, MoE enables:</p>\n\n    <ul>\n      <li>massive increases in model capacity without proportional training cost,</li>\n      <li>improved representational efficiency through expert specialization,</li>\n      <li>inference costs that scale with active computation rather than total parameters,</li>\n      <li>adaptive computation aligned with input complexity.</li>\n    </ul>\n  </li>\n  <li>\n    <p>As summarized in <a href=\"https://arxiv.org/abs/2402.14393\">A Comprehensive Survey of Mixture-of-Experts</a> by Jiang et al. (2025), MoE has evolved from an ensemble-learning technique into a central architectural principle for large-scale neural networks. Its success reflects a broader shift away from uniform computation toward models that allocate resources dynamically—making MoE a cornerstone of scalable training and inference in next-generation AI systems.</p>\n  </li>\n</ul>\n<p>Taken together, Mixture-of-Experts architectures provide a structural solution to the scaling limits of dense neural networks. By introducing sparsity at the level of parameter activation, MoE enables:</p>\n<ul>\n      <li>massive increases in model capacity without proportional training cost,</li>\n      <li>improved representational efficiency through expert specialization,</li>\n      <li>inference costs that scale with active computation rather than total parameters,</li>\n      <li>adaptive computation aligned with input complexity.</li>\n    </ul>\n<p>As summarized in <a href=\"https://arxiv.org/abs/2402.14393\">A Comprehensive Survey of Mixture-of-Experts</a> by Jiang et al. (2025), MoE has evolved from an ensemble-learning technique into a central architectural principle for large-scale neural networks. Its success reflects a broader shift away from uniform computation toward models that allocate resources dynamically—making MoE a cornerstone of scalable training and inference in next-generation AI systems.</p>",
    "contentMarkdown": "*   Taken together, Mixture-of-Experts architectures provide a structural solution to the scaling limits of dense neural networks. By introducing sparsity at the level of parameter activation, MoE enables:\n    \n    *   massive increases in model capacity without proportional training cost,\n    *   improved representational efficiency through expert specialization,\n    *   inference costs that scale with active computation rather than total parameters,\n    *   adaptive computation aligned with input complexity.\n*   As summarized in [A Comprehensive Survey of Mixture-of-Experts](https://arxiv.org/abs/2402.14393) by Jiang et al. (2025), MoE has evolved from an ensemble-learning technique into a central architectural principle for large-scale neural networks. Its success reflects a broader shift away from uniform computation toward models that allocate resources dynamically—making MoE a cornerstone of scalable training and inference in next-generation AI systems.\n    \n\nTaken together, Mixture-of-Experts architectures provide a structural solution to the scaling limits of dense neural networks. By introducing sparsity at the level of parameter activation, MoE enables:\n\n*   massive increases in model capacity without proportional training cost,\n*   improved representational efficiency through expert specialization,\n*   inference costs that scale with active computation rather than total parameters,\n*   adaptive computation aligned with input complexity.\n\nAs summarized in [A Comprehensive Survey of Mixture-of-Experts](https://arxiv.org/abs/2402.14393) by Jiang et al. (2025), MoE has evolved from an ensemble-learning technique into a central architectural principle for large-scale neural networks. Its success reflects a broader shift away from uniform computation toward models that allocate resources dynamically—making MoE a cornerstone of scalable training and inference in next-generation AI systems.",
    "contentLength": 2111,
    "wordCount": 242,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#why-moe-enables-scalable-neural-networks"
  },
  {
    "id": "ai-mixture-of-experts-top-level-intuition-8",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts: the Classic Approach",
    "title": "Top-level Intuition",
    "order": 8,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>MoE leverages multiple specialized models (experts) to solve complex tasks by dividing the problem space. Each expert becomes proficient in a specific subset of the data, leading to more efficient learning and problem-solving.\n    <ul>\n      <li>Specifically, in the feed-forward parts of the model (not the attention blocks) the router selects an expert layer for every token. In the architecture proposed in the seminal paper <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a>, within the feed-forward components of the model (excluding the attention blocks), the router assigns an expert layer for each token. The figures below (source: <a href=\"https://twitter.com/natolambert/status/1734326629521035588\">Nathan Lambert’s tweet</a>, the <a href=\"https://arxiv.org/abs/1706.03762\">Transformers</a> and <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> paper) illustrates this feed-forward-based MoE architecture.</li>\n    </ul>\n\n    <p><img src=\"/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE1.jpg\" alt=\"\"></p>\n\n    <p><img src=\"/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE2.jpg\" alt=\"\"></p>\n\n    <ul>\n      <li>Conversely, recent publications such as <a href=\"https://arxiv.org/abs/2404.07413\">JetMoE: Reaching Llama2 Performance with 0.1M Dollars</a> have expanded this approach, modeling both feed-forward and attention blocks as MoEs.</li>\n    </ul>\n  </li>\n  <li>A gating network determines which expert(s) to activate for a given input, ensuring the most relevant expertise is applied. The gate learns to assign inputs to experts dynamically, optimizing performance based on the task’s needs.</li>\n  <li>MoE architectures reduce computational cost by only activating a subset of experts for each input, rather than the entire model. This approach allows for scalability and adaptability, making MoE suitable for large-scale and diverse datasets.</li>\n</ul>\n<ul>\n      <li>Specifically, in the feed-forward parts of the model (not the attention blocks) the router selects an expert layer for every token. In the architecture proposed in the seminal paper <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a>, within the feed-forward components of the model (excluding the attention blocks), the router assigns an expert layer for each token. The figures below (source: <a href=\"https://twitter.com/natolambert/status/1734326629521035588\">Nathan Lambert’s tweet</a>, the <a href=\"https://arxiv.org/abs/1706.03762\">Transformers</a> and <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> paper) illustrates this feed-forward-based MoE architecture.</li>\n    </ul>\n<p><img src=\"/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE1.jpg\" alt=\"\"></p>\n<p><img src=\"/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE2.jpg\" alt=\"\"></p>\n<ul>\n      <li>Conversely, recent publications such as <a href=\"https://arxiv.org/abs/2404.07413\">JetMoE: Reaching Llama2 Performance with 0.1M Dollars</a> have expanded this approach, modeling both feed-forward and attention blocks as MoEs.</li>\n    </ul>\n<h4 id=\"gate-functionality\">Gate Functionality</h4>\n<ul>\n  <li>This section seeks to answer how the gating network (also called gate, router, or switch) in MoE models works under the hood.</li>\n  <li>Let’s explore two distinct but interconnected functions of the gate in a MoE model:\n    <ol>\n      <li><strong>Clustering the Data</strong>: In the context of an MoE model, clustering the data means that the gate is learning to identify and group together similar data points. This is not clustering in the traditional unsupervised learning sense, where the algorithm discovers clusters without any external labels. Instead, the gate is using the training process to recognize patterns or features in the data that suggest which data points are similar to each other and should be treated similarly. This is a crucial step because it determines how the data is organized and interpreted by the model.</li>\n      <li><strong>Mapping Experts to Clusters</strong>: Once the gate has identified clusters within the data, its next role is to assign or map each cluster to the most appropriate expert within the MoE model. Each expert in the model is specialized to handle different types of data or different aspects of the problem. The gate’s function here is to direct each data point (or each group of similar data points) to the expert that is best suited to process it. This mapping is dynamic and is based on the strengths and specialties of each expert as they evolve during the training process.</li>\n    </ol>\n  </li>\n  <li>In summary, the gate in an MoE model is responsible for organizing the incoming data into meaningful groups (clustering) and then efficiently allocating these groups to the most relevant expert models within the MoE system for further processing. This dual role of the gate is critical for the overall performance and efficiency of the MoE model, enabling it to handle complex tasks by leveraging the specialized skills of its various expert components.</li>\n</ul>\n<ol>\n      <li><strong>Clustering the Data</strong>: In the context of an MoE model, clustering the data means that the gate is learning to identify and group together similar data points. This is not clustering in the traditional unsupervised learning sense, where the algorithm discovers clusters without any external labels. Instead, the gate is using the training process to recognize patterns or features in the data that suggest which data points are similar to each other and should be treated similarly. This is a crucial step because it determines how the data is organized and interpreted by the model.</li>\n      <li><strong>Mapping Experts to Clusters</strong>: Once the gate has identified clusters within the data, its next role is to assign or map each cluster to the most appropriate expert within the MoE model. Each expert in the model is specialized to handle different types of data or different aspects of the problem. The gate’s function here is to direct each data point (or each group of similar data points) to the expert that is best suited to process it. This mapping is dynamic and is based on the strengths and specialties of each expert as they evolve during the training process.</li>\n    </ol>",
    "contentMarkdown": "*   MoE leverages multiple specialized models (experts) to solve complex tasks by dividing the problem space. Each expert becomes proficient in a specific subset of the data, leading to more efficient learning and problem-solving.\n    \n    *   Specifically, in the feed-forward parts of the model (not the attention blocks) the router selects an expert layer for every token. In the architecture proposed in the seminal paper [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538), within the feed-forward components of the model (excluding the attention blocks), the router assigns an expert layer for each token. The figures below (source: [Nathan Lambert’s tweet](https://twitter.com/natolambert/status/1734326629521035588), the [Transformers](https://arxiv.org/abs/1706.03762) and [Switch Transformers](https://arxiv.org/abs/2101.03961) paper) illustrates this feed-forward-based MoE architecture.\n    \n    ![](/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE1.jpg)\n    \n    ![](/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE2.jpg)\n    \n    *   Conversely, recent publications such as [JetMoE: Reaching Llama2 Performance with 0.1M Dollars](https://arxiv.org/abs/2404.07413) have expanded this approach, modeling both feed-forward and attention blocks as MoEs.\n*   A gating network determines which expert(s) to activate for a given input, ensuring the most relevant expertise is applied. The gate learns to assign inputs to experts dynamically, optimizing performance based on the task’s needs.\n*   MoE architectures reduce computational cost by only activating a subset of experts for each input, rather than the entire model. This approach allows for scalability and adaptability, making MoE suitable for large-scale and diverse datasets.\n\n*   Specifically, in the feed-forward parts of the model (not the attention blocks) the router selects an expert layer for every token. In the architecture proposed in the seminal paper [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538), within the feed-forward components of the model (excluding the attention blocks), the router assigns an expert layer for each token. The figures below (source: [Nathan Lambert’s tweet](https://twitter.com/natolambert/status/1734326629521035588), the [Transformers](https://arxiv.org/abs/1706.03762) and [Switch Transformers](https://arxiv.org/abs/2101.03961) paper) illustrates this feed-forward-based MoE architecture.\n\n![](/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE1.jpg)\n\n![](/primers/ai/assets/mixture-of-experts/feed-forward-basedMoE2.jpg)\n\n*   Conversely, recent publications such as [JetMoE: Reaching Llama2 Performance with 0.1M Dollars](https://arxiv.org/abs/2404.07413) have expanded this approach, modeling both feed-forward and attention blocks as MoEs.\n\n#### Gate Functionality\n\n*   This section seeks to answer how the gating network (also called gate, router, or switch) in MoE models works under the hood.\n*   Let’s explore two distinct but interconnected functions of the gate in a MoE model:\n    1.  **Clustering the Data**: In the context of an MoE model, clustering the data means that the gate is learning to identify and group together similar data points. This is not clustering in the traditional unsupervised learning sense, where the algorithm discovers clusters without any external labels. Instead, the gate is using the training process to recognize patterns or features in the data that suggest which data points are similar to each other and should be treated similarly. This is a crucial step because it determines how the data is organized and interpreted by the model.\n    2.  **Mapping Experts to Clusters**: Once the gate has identified clusters within the data, its next role is to assign or map each cluster to the most appropriate expert within the MoE model. Each expert in the model is specialized to handle different types of data or different aspects of the problem. The gate’s function here is to direct each data point (or each group of similar data points) to the expert that is best suited to process it. This mapping is dynamic and is based on the strengths and specialties of each expert as they evolve during the training process.\n*   In summary, the gate in an MoE model is responsible for organizing the incoming data into meaningful groups (clustering) and then efficiently allocating these groups to the most relevant expert models within the MoE system for further processing. This dual role of the gate is critical for the overall performance and efficiency of the MoE model, enabling it to handle complex tasks by leveraging the specialized skills of its various expert components.\n\n1.  **Clustering the Data**: In the context of an MoE model, clustering the data means that the gate is learning to identify and group together similar data points. This is not clustering in the traditional unsupervised learning sense, where the algorithm discovers clusters without any external labels. Instead, the gate is using the training process to recognize patterns or features in the data that suggest which data points are similar to each other and should be treated similarly. This is a crucial step because it determines how the data is organized and interpreted by the model.\n2.  **Mapping Experts to Clusters**: Once the gate has identified clusters within the data, its next role is to assign or map each cluster to the most appropriate expert within the MoE model. Each expert in the model is specialized to handle different types of data or different aspects of the problem. The gate’s function here is to direct each data point (or each group of similar data points) to the expert that is best suited to process it. This mapping is dynamic and is based on the strengths and specialties of each expert as they evolve during the training process.",
    "contentLength": 6448,
    "wordCount": 820,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#top-level-intuition"
  },
  {
    "id": "ai-mixture-of-experts-overview-9",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Capacity and Capacity Factor",
    "title": "Overview",
    "order": 9,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>In a MoE model, expert capacity defines the upper bound on how many tokens, samples, or activations may be routed to each expert during a training (or inference) step. This concept is essential for ensuring balanced expert utilization, computational efficiency, and stability in distributed training.</p>\n  </li>\n  <li>\n    <p>Although the foundational work on <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a> by Shazeer et al. (2017) introduced much of the routing mechanism, the explicit formalization of <em>expert capacity</em> and the associated <em>capacity factor</em> appear in later work — in particular in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, which defines expert capacity approximately as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-22-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>expert_capacity</mtext><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-127\" style=\"width: 12.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1010.26em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-128\"><span class=\"mtext\" id=\"MathJax-Span-129\" style=\"font-family: STIXGeneral-Regular;\">expert_capacity</span><span class=\"mo\" id=\"MathJax-Span-130\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-131\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-132\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-133\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-134\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-135\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mtext>expert_capacity</mtext><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-22\">\\text{expert_capacity} = \\frac{T}{N} \\times \\alpha</script>\n\n    <ul>\n      <li>\n        <p>where:</p>\n\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-23-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-136\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-137\"><span class=\"mi\" id=\"MathJax-Span-138\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-23\">T</script> is the number of tokens (or routed activations) in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-24-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-139\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-140\"><span class=\"mi\" id=\"MathJax-Span-141\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-24\">N</script> is the number of experts, and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-25-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-142\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-143\"><span class=\"mi\" id=\"MathJax-Span-144\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-25\">\\alpha</script> is the capacity factor (a hyper-parameter)</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n</ul>\n<p>In a MoE model, expert capacity defines the upper bound on how many tokens, samples, or activations may be routed to each expert during a training (or inference) step. This concept is essential for ensuring balanced expert utilization, computational efficiency, and stability in distributed training.</p>\n<p>Although the foundational work on <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a> by Shazeer et al. (2017) introduced much of the routing mechanism, the explicit formalization of <em>expert capacity</em> and the associated <em>capacity factor</em> appear in later work — in particular in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, which defines expert capacity approximately as:</p>\n<ul>\n      <li>\n        <p>where:</p>\n\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-23-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-136\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-137\"><span class=\"mi\" id=\"MathJax-Span-138\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-23\">T</script> is the number of tokens (or routed activations) in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-24-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-139\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-140\"><span class=\"mi\" id=\"MathJax-Span-141\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-24\">N</script> is the number of experts, and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-25-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-142\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-143\"><span class=\"mi\" id=\"MathJax-Span-144\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-25\">\\alpha</script> is the capacity factor (a hyper-parameter)</li>\n        </ul>\n      </li>\n    </ul>\n<p>where:</p>\n<ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-23-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-136\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-137\"><span class=\"mi\" id=\"MathJax-Span-138\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-23\">T</script> is the number of tokens (or routed activations) in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-24-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-139\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-140\"><span class=\"mi\" id=\"MathJax-Span-141\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-24\">N</script> is the number of experts, and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-25-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-142\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-143\"><span class=\"mi\" id=\"MathJax-Span-144\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-25\">\\alpha</script> is the capacity factor (a hyper-parameter)</li>\n        </ul>",
    "contentMarkdown": "*   In a MoE model, expert capacity defines the upper bound on how many tokens, samples, or activations may be routed to each expert during a training (or inference) step. This concept is essential for ensuring balanced expert utilization, computational efficiency, and stability in distributed training.\n    \n*   Although the foundational work on [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) introduced much of the routing mechanism, the explicit formalization of _expert capacity_ and the associated _capacity factor_ appear in later work — in particular in [Switch Transformer](https://arxiv.org/abs/2101.03961), which defines expert capacity approximately as:\n    \n    expert\\_capacity\\=TN×αexpert\\_capacity\\=TN×α\n    \n    \\\\text{expert\\_capacity} = \\\\frac{T}{N} \\\\times \\\\alpha\n    *   where:\n        \n        *   TTT is the number of tokens (or routed activations) in the batch,\n        *   NNN is the number of experts, and\n        *   αα\\\\alpha is the capacity factor (a hyper-parameter)\n\nIn a MoE model, expert capacity defines the upper bound on how many tokens, samples, or activations may be routed to each expert during a training (or inference) step. This concept is essential for ensuring balanced expert utilization, computational efficiency, and stability in distributed training.\n\nAlthough the foundational work on [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) introduced much of the routing mechanism, the explicit formalization of _expert capacity_ and the associated _capacity factor_ appear in later work — in particular in [Switch Transformer](https://arxiv.org/abs/2101.03961), which defines expert capacity approximately as:\n\n*   where:\n    \n    *   TTT is the number of tokens (or routed activations) in the batch,\n    *   NNN is the number of experts, and\n    *   αα\\\\alpha is the capacity factor (a hyper-parameter)\n\nwhere:\n\n*   TTT is the number of tokens (or routed activations) in the batch,\n*   NNN is the number of experts, and\n*   αα\\\\alpha is the capacity factor (a hyper-parameter)",
    "contentLength": 16795,
    "wordCount": 280,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#overview"
  },
  {
    "id": "ai-mixture-of-experts-historical-context-and-related-work-10",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Capacity and Capacity Factor",
    "title": "Historical Context and Related Work",
    "order": 10,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>The concept of expert capacity and its controlling hyper-parameter, the capacity factor, evolved through multiple generations of research in conditional computation and large-scale MoE models.</li>\n  <li>\n    <p>In summary:</p>\n\n    <ol>\n      <li>\n        <p><strong>Early conditional-computation research</strong> introduced sparse activation but lacked an explicit notion of capacity — for example, early adaptive computation work like <a href=\"https://arxiv.org/abs/1308.3432\">Conditional Computation in Neural Networks</a> by Bengio et al. (2013) discussed conditional activation without a formal capacity limit.</p>\n      </li>\n      <li>\n        <p><a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017) scaled sparse routing to hundreds of experts, revealing the need for explicit load control and motivating later formulations of expert capacity.</p>\n      </li>\n      <li>\n        <p><a href=\"https://arxiv.org/abs/2006.16668\">GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding</a> by Lepikhin et al. (2020) addressed large-scale MoE training and system-level scaling but treated expert capacity implicitly as an implementation-level constraint rather than a tunable hyper-parameter.</p>\n      </li>\n      <li>\n        <p><a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</a> by Fedus, Zoph &amp; Shazeer (2021) formally defined the expert capacity equation and the capacity factor as explicit, first-class hyper-parameters.</p>\n      </li>\n      <li>\n        <p>Subsequent studies such as <a href=\"https://arxiv.org/abs/2103.16716\">BASE Layers: Simplifying Training of Large, Sparse Models</a> by Lewis et al. (2021), <a href=\"https://arxiv.org/abs/2202.08906\">ST-MoE: Designing Stable and Transferable Sparse Expert Models</a> by Zoph et al. (2022), and <a href=\"https://arxiv.org/abs/2312.03863\">Efficient Large Language Models: A Survey</a> by Dai et al. (2023) have expanded this idea into capacity-aware training and inference strategies — highlighting expert capacity as a controllable mechanism for efficiency, stability, and specialization.</p>\n      </li>\n    </ol>\n  </li>\n  <li>This evolution transformed expert capacity from a pragmatic load-balancing technique into a theoretically grounded and tunable component essential for scalable sparse neural networks, as reflected in later frameworks like <a href=\"https://arxiv.org/abs/2211.15841\">Dropless MoE (MegaBlocks)</a> by Kang et al. (2022) and <a href=\"https://arxiv.org/abs/2401.04088\">Mixtral: Sparse Mixture of Experts</a> by Jiang et al. (2024), which continue to refine capacity management in trillion-parameter architectures.</li>\n</ul>\n<p>In summary:</p>\n<ol>\n      <li>\n        <p><strong>Early conditional-computation research</strong> introduced sparse activation but lacked an explicit notion of capacity — for example, early adaptive computation work like <a href=\"https://arxiv.org/abs/1308.3432\">Conditional Computation in Neural Networks</a> by Bengio et al. (2013) discussed conditional activation without a formal capacity limit.</p>\n      </li>\n      <li>\n        <p><a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017) scaled sparse routing to hundreds of experts, revealing the need for explicit load control and motivating later formulations of expert capacity.</p>\n      </li>\n      <li>\n        <p><a href=\"https://arxiv.org/abs/2006.16668\">GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding</a> by Lepikhin et al. (2020) addressed large-scale MoE training and system-level scaling but treated expert capacity implicitly as an implementation-level constraint rather than a tunable hyper-parameter.</p>\n      </li>\n      <li>\n        <p><a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</a> by Fedus, Zoph &amp; Shazeer (2021) formally defined the expert capacity equation and the capacity factor as explicit, first-class hyper-parameters.</p>\n      </li>\n      <li>\n        <p>Subsequent studies such as <a href=\"https://arxiv.org/abs/2103.16716\">BASE Layers: Simplifying Training of Large, Sparse Models</a> by Lewis et al. (2021), <a href=\"https://arxiv.org/abs/2202.08906\">ST-MoE: Designing Stable and Transferable Sparse Expert Models</a> by Zoph et al. (2022), and <a href=\"https://arxiv.org/abs/2312.03863\">Efficient Large Language Models: A Survey</a> by Dai et al. (2023) have expanded this idea into capacity-aware training and inference strategies — highlighting expert capacity as a controllable mechanism for efficiency, stability, and specialization.</p>\n      </li>\n    </ol>\n<p><strong>Early conditional-computation research</strong> introduced sparse activation but lacked an explicit notion of capacity — for example, early adaptive computation work like <a href=\"https://arxiv.org/abs/1308.3432\">Conditional Computation in Neural Networks</a> by Bengio et al. (2013) discussed conditional activation without a formal capacity limit.</p>\n<p><a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017) scaled sparse routing to hundreds of experts, revealing the need for explicit load control and motivating later formulations of expert capacity.</p>\n<p><a href=\"https://arxiv.org/abs/2006.16668\">GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding</a> by Lepikhin et al. (2020) addressed large-scale MoE training and system-level scaling but treated expert capacity implicitly as an implementation-level constraint rather than a tunable hyper-parameter.</p>\n<p><a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</a> by Fedus, Zoph &amp; Shazeer (2021) formally defined the expert capacity equation and the capacity factor as explicit, first-class hyper-parameters.</p>\n<p>Subsequent studies such as <a href=\"https://arxiv.org/abs/2103.16716\">BASE Layers: Simplifying Training of Large, Sparse Models</a> by Lewis et al. (2021), <a href=\"https://arxiv.org/abs/2202.08906\">ST-MoE: Designing Stable and Transferable Sparse Expert Models</a> by Zoph et al. (2022), and <a href=\"https://arxiv.org/abs/2312.03863\">Efficient Large Language Models: A Survey</a> by Dai et al. (2023) have expanded this idea into capacity-aware training and inference strategies — highlighting expert capacity as a controllable mechanism for efficiency, stability, and specialization.</p>\n<h4 id=\"early-conditional-computation-and-moe-origins\">Early Conditional-Computation and MoE Origins</h4>\n<ul>\n  <li>\n    <p>The notion of dividing computation among multiple experts dates back to early modular neural networks such as <em>adaptive mixtures of local experts</em> by Michael I. Jordan and Robert A. Jacobs (1991), described in <a href=\"https://dl.acm.org/doi/10.1162/neco.1991.3.1.79\">Adaptive Mixtures of Local Experts</a>. These early architectures introduced the idea of a <strong>gating network</strong> that learns how to distribute inputs to specialized sub-networks.</p>\n  </li>\n  <li>\n    <p>Later, conditional computation became central to deep learning research. According to <a href=\"https://arxiv.org/abs/1312.4314\">Learning Factored Representations in a Deep Mixture of Experts</a> by Eigen et al. (2013), the model proposed activating only subsets of a deep network for each input, foreshadowing the sparse-activation ideas used in modern MoE architectures. Similarly, <a href=\"https://arxiv.org/abs/1511.06297\">Estimating or Propagating Gradients Through Stochastic Neurons for Conditional Computation</a> by Bengio et al. (2015) extended this to <em>stochastic routing</em>, introducing probabilistic gating mechanisms that enabled selective activation of sub-networks.</p>\n  </li>\n  <li>\n    <p>These early efforts laid the groundwork for modern sparse expert activation but did <strong>not</strong> define an explicit per-expert token capacity or a capacity-factor hyper-parameter. That formalism would only emerge years later with large-scale transformer-based MoE systems.</p>\n  </li>\n</ul>\n<p>The notion of dividing computation among multiple experts dates back to early modular neural networks such as <em>adaptive mixtures of local experts</em> by Michael I. Jordan and Robert A. Jacobs (1991), described in <a href=\"https://dl.acm.org/doi/10.1162/neco.1991.3.1.79\">Adaptive Mixtures of Local Experts</a>. These early architectures introduced the idea of a <strong>gating network</strong> that learns how to distribute inputs to specialized sub-networks.</p>\n<p>Later, conditional computation became central to deep learning research. According to <a href=\"https://arxiv.org/abs/1312.4314\">Learning Factored Representations in a Deep Mixture of Experts</a> by Eigen et al. (2013), the model proposed activating only subsets of a deep network for each input, foreshadowing the sparse-activation ideas used in modern MoE architectures. Similarly, <a href=\"https://arxiv.org/abs/1511.06297\">Estimating or Propagating Gradients Through Stochastic Neurons for Conditional Computation</a> by Bengio et al. (2015) extended this to <em>stochastic routing</em>, introducing probabilistic gating mechanisms that enabled selective activation of sub-networks.</p>\n<p>These early efforts laid the groundwork for modern sparse expert activation but did <strong>not</strong> define an explicit per-expert token capacity or a capacity-factor hyper-parameter. That formalism would only emerge years later with large-scale transformer-based MoE systems.</p>\n<h4 id=\"the-first-large-scale-sparse-moe-sparsely-gated-moe-2017\">The First Large-Scale Sparse MoE: “Sparsely-Gated MoE” (2017)</h4>\n<ul>\n  <li>\n    <p>A major leap in scalability came with <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017). This seminal work operationalized Mixture-of-Experts at unprecedented scale, introducing thousands of feed-forward experts within Transformer-style architectures.</p>\n  </li>\n  <li>\n    <p>The key innovation was the <strong>sparsely-gated routing mechanism</strong>, where a learned gating network dynamically selected only the <em>top-1</em> or <em>top-2</em> experts for each input token. This selective activation made it possible to scale model size without linearly increasing computational cost.</p>\n  </li>\n  <li>\n    <p>The gating network was trained jointly with the experts and included an <strong>auxiliary load-balancing loss</strong> to encourage even expert utilization and prevent routing collapse (where a few experts dominate). The paper demonstrated how sparse activation could extend model capacity while maintaining manageable training costs on large distributed systems such as TensorFlow.</p>\n  </li>\n  <li>\n    <p>Despite these breakthroughs, the framework did not yet define a formal notion of <em>expert capacity</em> or a <em>capacity factor</em>. Instead, expert load control was managed heuristically through the gating loss and token-dropping mechanisms. These ideas laid the foundation for later work such as <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> and <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, which explicitly quantified and parameterized per-expert capacity.</p>\n  </li>\n</ul>\n<p>A major leap in scalability came with <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017). This seminal work operationalized Mixture-of-Experts at unprecedented scale, introducing thousands of feed-forward experts within Transformer-style architectures.</p>\n<p>The key innovation was the <strong>sparsely-gated routing mechanism</strong>, where a learned gating network dynamically selected only the <em>top-1</em> or <em>top-2</em> experts for each input token. This selective activation made it possible to scale model size without linearly increasing computational cost.</p>\n<p>The gating network was trained jointly with the experts and included an <strong>auxiliary load-balancing loss</strong> to encourage even expert utilization and prevent routing collapse (where a few experts dominate). The paper demonstrated how sparse activation could extend model capacity while maintaining manageable training costs on large distributed systems such as TensorFlow.</p>\n<p>Despite these breakthroughs, the framework did not yet define a formal notion of <em>expert capacity</em> or a <em>capacity factor</em>. Instead, expert load control was managed heuristically through the gating loss and token-dropping mechanisms. These ideas laid the foundation for later work such as <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> and <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, which explicitly quantified and parameterized per-expert capacity.</p>\n<h4 id=\"scaling-to-conditional-models-gshard-2020\">Scaling to Conditional Models: GShard (2020)</h4>\n<ul>\n  <li>\n    <p>The next turning point in scaling conditional computation came with <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>. This system enabled training of multilingual Transformer models exceeding <strong>600 billion parameters</strong>, establishing a new paradigm for distributed sparse computation across large clusters.</p>\n  </li>\n  <li>\n    <p>GShard introduced several key innovations that made large-scale sparse MoE training practical:</p>\n\n    <ul>\n      <li><strong>Automatic sharding</strong> across thousands of devices, enabling each expert to reside on separate compute nodes while maintaining efficient communication via <em>all-to-all</em> token exchange.</li>\n      <li><strong>Top-2 routing</strong>, which improved stability compared to earlier top-1 gating, ensuring that each token could leverage two complementary experts.</li>\n      <li><strong>Dynamic load-balancing loss</strong>, inherited from <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a>, to prevent expert overloading and under-utilization during distributed training.</li>\n    </ul>\n  </li>\n  <li>\n    <p>While GShard significantly advanced the scalability of MoE systems, its treatment of <strong>expert capacity</strong> remained <em>implicit</em>. Each expert’s token processing limit was defined as a systems-level constant rather than a tunable model hyper-parameter. This approach worked for engineering stability but limited fine-grained control over computational balance and token overflow.</p>\n  </li>\n  <li>\n    <p>The insights from GShard directly influenced later developments such as <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, which explicitly formulated the <strong>expert capacity equation</strong> and introduced the <strong>capacity factor (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-26-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-145\" style=\"width: 0.777em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.622em; height: 0px; font-size: 121%;\"><span style=\"position: absolute; clip: rect(1.552em, 1000.62em, 2.327em, -999.997em); top: -2.167em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-146\"><span class=\"mi\" id=\"MathJax-Span-147\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.172em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-26\">\\alpha</script>)</strong> as a first-class hyper-parameter governing token allocation per expert. This formalization transformed capacity management from a systems constraint into a learnable and optimizable design variable within large-scale MoE architectures.</p>\n  </li>\n</ul>\n<p>The next turning point in scaling conditional computation came with <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>. This system enabled training of multilingual Transformer models exceeding <strong>600 billion parameters</strong>, establishing a new paradigm for distributed sparse computation across large clusters.</p>\n<p>GShard introduced several key innovations that made large-scale sparse MoE training practical:</p>\n<ul>\n      <li><strong>Automatic sharding</strong> across thousands of devices, enabling each expert to reside on separate compute nodes while maintaining efficient communication via <em>all-to-all</em> token exchange.</li>\n      <li><strong>Top-2 routing</strong>, which improved stability compared to earlier top-1 gating, ensuring that each token could leverage two complementary experts.</li>\n      <li><strong>Dynamic load-balancing loss</strong>, inherited from <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a>, to prevent expert overloading and under-utilization during distributed training.</li>\n    </ul>\n<p>While GShard significantly advanced the scalability of MoE systems, its treatment of <strong>expert capacity</strong> remained <em>implicit</em>. Each expert’s token processing limit was defined as a systems-level constant rather than a tunable model hyper-parameter. This approach worked for engineering stability but limited fine-grained control over computational balance and token overflow.</p>\n<p>The insights from GShard directly influenced later developments such as <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, which explicitly formulated the <strong>expert capacity equation</strong> and introduced the <strong>capacity factor (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-26-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-145\" style=\"width: 0.777em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.622em; height: 0px; font-size: 121%;\"><span style=\"position: absolute; clip: rect(1.552em, 1000.62em, 2.327em, -999.997em); top: -2.167em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-146\"><span class=\"mi\" id=\"MathJax-Span-147\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.172em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-26\">\\alpha</script>)</strong> as a first-class hyper-parameter governing token allocation per expert. This formalization transformed capacity management from a systems constraint into a learnable and optimizable design variable within large-scale MoE architectures.</p>\n<h4 id=\"formalization-of-capacity-factor-switch-transformer-2021\">Formalization of “Capacity Factor”: Switch Transformer (2021)</h4>\n<ul>\n  <li>\n    <p>The formal definition of <strong>expert capacity</strong> emerged in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>. This work extended the MoE paradigm to trillion-parameter scale while preserving training efficiency and stability. Its key contribution was the explicit mathematical formulation of <em>expert capacity</em> and the <em>capacity factor</em>, which collectively defined a tunable upper bound on how many tokens could be routed to each expert per training step.</p>\n  </li>\n  <li>\n    <p>The expert capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-27-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-148\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-149\"><span class=\"mi\" id=\"MathJax-Span-150\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-27\">C</script> is defined as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-28-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-151\" style=\"width: 5.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.638em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1004.64em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-152\"><span class=\"mi\" id=\"MathJax-Span-153\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-154\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-155\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-156\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-157\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-158\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-159\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-28\">C = \\frac{T}{N} \\times \\alpha</script>\n\n    <ul>\n      <li>\n        <p>where:</p>\n\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-29-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-160\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-161\"><span class=\"mi\" id=\"MathJax-Span-162\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-29\">T</script> — total number of tokens in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-30-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-163\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-164\"><span class=\"mi\" id=\"MathJax-Span-165\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-30\">N</script> — total number of experts,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-31-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-166\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-167\"><span class=\"mi\" id=\"MathJax-Span-168\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-31\">\\alpha</script> — <em>capacity factor</em>, a tunable scalar that expands or contracts per-expert token capacity.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>The capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-32-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-169\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-170\"><span class=\"mi\" id=\"MathJax-Span-171\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-32\">\\alpha</script> was introduced to manage the natural variability in token-to-expert assignment. Since routing is probabilistic, some experts receive more tokens than others. Setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-33-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;gt;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-172\" style=\"width: 2.763em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.294em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-173\"><span class=\"mi\" id=\"MathJax-Span-174\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-175\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-176\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>&gt;</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-33\">\\alpha > 1</script> provides a buffer to accommodate these fluctuations, while <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-34-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;lt;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-177\" style=\"width: 2.763em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.294em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-178\"><span class=\"mi\" id=\"MathJax-Span-179\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-180\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&lt;</span><span class=\"mn\" id=\"MathJax-Span-181\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>&lt;</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-34\">\\alpha < 1</script> enforces stricter token limits, increasing efficiency at the risk of dropping excess tokens.</p>\n  </li>\n  <li>\n    <p>According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, “A capacity factor greater than 1.0 creates additional buffer to accommodate when tokens are not perfectly balanced across experts.” This insight formally linked the idea of routing imbalance to a <em>controllable hyper-parameter</em>, enabling model designers to trade off between computational efficiency, overflow tolerance, and token drop rates.</p>\n  </li>\n  <li>\n    <p>This formulation also introduced a deterministic rule for dropped tokens — when a particular expert exceeds its capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-35-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-182\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-183\"><span class=\"mi\" id=\"MathJax-Span-184\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-35\">C</script>, the overflow tokens are either <strong>skipped</strong> (via residual pathways) or <strong>rerouted</strong> to other experts, depending on the implementation. The result was a predictable and efficient routing framework that made trillion-parameter training feasible for the first time.</p>\n  </li>\n  <li>\n    <p>The explicit introduction of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-36-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-185\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-186\"><span class=\"mi\" id=\"MathJax-Span-187\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-36\">C</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-37-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-188\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-189\"><span class=\"mi\" id=\"MathJax-Span-190\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-37\">\\alpha</script> thus transformed what had previously been a system-level constraint (as in <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>) into a <em>model-level hyper-parameter</em>. This shift made expert capacity an essential design tool for controlling load balance, efficiency, and overall throughput in sparse architectures.</p>\n  </li>\n</ul>\n<p>The formal definition of <strong>expert capacity</strong> emerged in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>. This work extended the MoE paradigm to trillion-parameter scale while preserving training efficiency and stability. Its key contribution was the explicit mathematical formulation of <em>expert capacity</em> and the <em>capacity factor</em>, which collectively defined a tunable upper bound on how many tokens could be routed to each expert per training step.</p>\n<p>The expert capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-27-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-148\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-149\"><span class=\"mi\" id=\"MathJax-Span-150\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-27\">C</script> is defined as:</p>\n<ul>\n      <li>\n        <p>where:</p>\n\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-29-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-160\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-161\"><span class=\"mi\" id=\"MathJax-Span-162\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-29\">T</script> — total number of tokens in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-30-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-163\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-164\"><span class=\"mi\" id=\"MathJax-Span-165\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-30\">N</script> — total number of experts,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-31-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-166\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-167\"><span class=\"mi\" id=\"MathJax-Span-168\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-31\">\\alpha</script> — <em>capacity factor</em>, a tunable scalar that expands or contracts per-expert token capacity.</li>\n        </ul>\n      </li>\n    </ul>\n<p>where:</p>\n<ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-29-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-160\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-161\"><span class=\"mi\" id=\"MathJax-Span-162\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-29\">T</script> — total number of tokens in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-30-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-163\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-164\"><span class=\"mi\" id=\"MathJax-Span-165\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-30\">N</script> — total number of experts,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-31-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-166\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-167\"><span class=\"mi\" id=\"MathJax-Span-168\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-31\">\\alpha</script> — <em>capacity factor</em>, a tunable scalar that expands or contracts per-expert token capacity.</li>\n        </ul>\n<p>The capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-32-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-169\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-170\"><span class=\"mi\" id=\"MathJax-Span-171\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-32\">\\alpha</script> was introduced to manage the natural variability in token-to-expert assignment. Since routing is probabilistic, some experts receive more tokens than others. Setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-33-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;gt;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-172\" style=\"width: 2.763em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.294em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-173\"><span class=\"mi\" id=\"MathJax-Span-174\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-175\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-176\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>&gt;</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-33\">\\alpha > 1</script> provides a buffer to accommodate these fluctuations, while <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-34-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;lt;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-177\" style=\"width: 2.763em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.294em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-178\"><span class=\"mi\" id=\"MathJax-Span-179\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-180\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&lt;</span><span class=\"mn\" id=\"MathJax-Span-181\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>&lt;</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-34\">\\alpha < 1</script> enforces stricter token limits, increasing efficiency at the risk of dropping excess tokens.</p>\n<p>According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, “A capacity factor greater than 1.0 creates additional buffer to accommodate when tokens are not perfectly balanced across experts.” This insight formally linked the idea of routing imbalance to a <em>controllable hyper-parameter</em>, enabling model designers to trade off between computational efficiency, overflow tolerance, and token drop rates.</p>\n<p>This formulation also introduced a deterministic rule for dropped tokens — when a particular expert exceeds its capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-35-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-182\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-183\"><span class=\"mi\" id=\"MathJax-Span-184\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-35\">C</script>, the overflow tokens are either <strong>skipped</strong> (via residual pathways) or <strong>rerouted</strong> to other experts, depending on the implementation. The result was a predictable and efficient routing framework that made trillion-parameter training feasible for the first time.</p>\n<p>The explicit introduction of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-36-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-185\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-186\"><span class=\"mi\" id=\"MathJax-Span-187\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-36\">C</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-37-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-188\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-189\"><span class=\"mi\" id=\"MathJax-Span-190\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-37\">\\alpha</script> thus transformed what had previously been a system-level constraint (as in <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>) into a <em>model-level hyper-parameter</em>. This shift made expert capacity an essential design tool for controlling load balance, efficiency, and overall throughput in sparse architectures.</p>\n<h4 id=\"subsequent-research-variations-and-deeper-analysis\">Subsequent Research: Variations and Deeper Analysis</h4>\n<ul>\n  <li>\n    <p>Following the introduction of <em>expert capacity</em> and the <em>capacity factor</em> in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, subsequent research expanded the theoretical and empirical understanding of how these parameters affect efficiency, load balance, and convergence in MoE architectures.</p>\n  </li>\n  <li>\n    <p>According to <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications</a> by Jiang et al. (2025), expert capacity and the capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-38-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-191\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-192\"><span class=\"mi\" id=\"MathJax-Span-193\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-38\">\\alpha</script> are “crucial for ensuring balanced load distribution and efficient utilization of the model’s experts.” This survey synthesizes evidence showing that proper tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-39-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-194\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-195\"><span class=\"mi\" id=\"MathJax-Span-196\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-39\">\\alpha</script> directly improves FLOPs utilization and mitigates <em>expert under-training</em>, a phenomenon where certain experts receive insufficient tokens to learn meaningful specializations.</p>\n  </li>\n  <li>\n    <p>The <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022) explored the relationship between capacity and routing in detail. The authors demonstrated that lowering the capacity factor from 2.0 to 1.0 increased token drop rates, leading to performance degradation on language modeling benchmarks. Their experiments highlighted that <em>balanced routing and sufficient per-expert capacity</em> are essential for stable optimization and reduced gradient variance across experts.</p>\n  </li>\n  <li>\n    <p>Meanwhile, <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) focused on inference-time efficiency, proposing <strong>capacity-aware token dropping</strong> and <strong>rerouting mechanisms</strong> to avoid the “straggler effect,” where overloaded experts slow down batch inference. These methods adaptively monitor per-expert load and dynamically reassign tokens to maintain predictable latency, demonstrating that expert capacity also governs runtime stability, not just training efficiency.</p>\n  </li>\n  <li>\n    <p>Finally, industry practitioners and open-source frameworks have reinforced these insights. For example, <em>Mixture-of-Experts Explained</em> on the <a href=\"https://huggingface.co/blog/moe\">Hugging Face Blog</a> emphasizes that setting the capacity factor between 1.0 and 1.25 achieves an optimal trade-off between throughput and overflow safety in top-2 routing configurations.</p>\n  </li>\n  <li>\n    <p>Collectively, these studies established <em>expert capacity</em> as a tunable control variable central to both system design and model convergence. It governs the interaction between routing stochasticity, memory provisioning, and distributed synchronization—making it one of the most practically significant hyper-parameters in large-scale MoE architectures.</p>\n  </li>\n</ul>\n<p>Following the introduction of <em>expert capacity</em> and the <em>capacity factor</em> in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, subsequent research expanded the theoretical and empirical understanding of how these parameters affect efficiency, load balance, and convergence in MoE architectures.</p>\n<p>According to <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications</a> by Jiang et al. (2025), expert capacity and the capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-38-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-191\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-192\"><span class=\"mi\" id=\"MathJax-Span-193\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-38\">\\alpha</script> are “crucial for ensuring balanced load distribution and efficient utilization of the model’s experts.” This survey synthesizes evidence showing that proper tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-39-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-194\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-195\"><span class=\"mi\" id=\"MathJax-Span-196\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-39\">\\alpha</script> directly improves FLOPs utilization and mitigates <em>expert under-training</em>, a phenomenon where certain experts receive insufficient tokens to learn meaningful specializations.</p>\n<p>The <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022) explored the relationship between capacity and routing in detail. The authors demonstrated that lowering the capacity factor from 2.0 to 1.0 increased token drop rates, leading to performance degradation on language modeling benchmarks. Their experiments highlighted that <em>balanced routing and sufficient per-expert capacity</em> are essential for stable optimization and reduced gradient variance across experts.</p>\n<p>Meanwhile, <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) focused on inference-time efficiency, proposing <strong>capacity-aware token dropping</strong> and <strong>rerouting mechanisms</strong> to avoid the “straggler effect,” where overloaded experts slow down batch inference. These methods adaptively monitor per-expert load and dynamically reassign tokens to maintain predictable latency, demonstrating that expert capacity also governs runtime stability, not just training efficiency.</p>\n<p>Finally, industry practitioners and open-source frameworks have reinforced these insights. For example, <em>Mixture-of-Experts Explained</em> on the <a href=\"https://huggingface.co/blog/moe\">Hugging Face Blog</a> emphasizes that setting the capacity factor between 1.0 and 1.25 achieves an optimal trade-off between throughput and overflow safety in top-2 routing configurations.</p>\n<p>Collectively, these studies established <em>expert capacity</em> as a tunable control variable central to both system design and model convergence. It governs the interaction between routing stochasticity, memory provisioning, and distributed synchronization—making it one of the most practically significant hyper-parameters in large-scale MoE architectures.</p>",
    "contentMarkdown": "*   The concept of expert capacity and its controlling hyper-parameter, the capacity factor, evolved through multiple generations of research in conditional computation and large-scale MoE models.\n*   In summary:\n    \n    1.  **Early conditional-computation research** introduced sparse activation but lacked an explicit notion of capacity — for example, early adaptive computation work like [Conditional Computation in Neural Networks](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013) discussed conditional activation without a formal capacity limit.\n        \n    2.  [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) scaled sparse routing to hundreds of experts, revealing the need for explicit load control and motivating later formulations of expert capacity.\n        \n    3.  [GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020) addressed large-scale MoE training and system-level scaling but treated expert capacity implicitly as an implementation-level constraint rather than a tunable hyper-parameter.\n        \n    4.  [Switch Transformer: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity](https://arxiv.org/abs/2101.03961) by Fedus, Zoph & Shazeer (2021) formally defined the expert capacity equation and the capacity factor as explicit, first-class hyper-parameters.\n        \n    5.  Subsequent studies such as [BASE Layers: Simplifying Training of Large, Sparse Models](https://arxiv.org/abs/2103.16716) by Lewis et al. (2021), [ST-MoE: Designing Stable and Transferable Sparse Expert Models](https://arxiv.org/abs/2202.08906) by Zoph et al. (2022), and [Efficient Large Language Models: A Survey](https://arxiv.org/abs/2312.03863) by Dai et al. (2023) have expanded this idea into capacity-aware training and inference strategies — highlighting expert capacity as a controllable mechanism for efficiency, stability, and specialization.\n        \n*   This evolution transformed expert capacity from a pragmatic load-balancing technique into a theoretically grounded and tunable component essential for scalable sparse neural networks, as reflected in later frameworks like [Dropless MoE (MegaBlocks)](https://arxiv.org/abs/2211.15841) by Kang et al. (2022) and [Mixtral: Sparse Mixture of Experts](https://arxiv.org/abs/2401.04088) by Jiang et al. (2024), which continue to refine capacity management in trillion-parameter architectures.\n\nIn summary:\n\n1.  **Early conditional-computation research** introduced sparse activation but lacked an explicit notion of capacity — for example, early adaptive computation work like [Conditional Computation in Neural Networks](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013) discussed conditional activation without a formal capacity limit.\n    \n2.  [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) scaled sparse routing to hundreds of experts, revealing the need for explicit load control and motivating later formulations of expert capacity.\n    \n3.  [GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020) addressed large-scale MoE training and system-level scaling but treated expert capacity implicitly as an implementation-level constraint rather than a tunable hyper-parameter.\n    \n4.  [Switch Transformer: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity](https://arxiv.org/abs/2101.03961) by Fedus, Zoph & Shazeer (2021) formally defined the expert capacity equation and the capacity factor as explicit, first-class hyper-parameters.\n    \n5.  Subsequent studies such as [BASE Layers: Simplifying Training of Large, Sparse Models](https://arxiv.org/abs/2103.16716) by Lewis et al. (2021), [ST-MoE: Designing Stable and Transferable Sparse Expert Models](https://arxiv.org/abs/2202.08906) by Zoph et al. (2022), and [Efficient Large Language Models: A Survey](https://arxiv.org/abs/2312.03863) by Dai et al. (2023) have expanded this idea into capacity-aware training and inference strategies — highlighting expert capacity as a controllable mechanism for efficiency, stability, and specialization.\n    \n\n**Early conditional-computation research** introduced sparse activation but lacked an explicit notion of capacity — for example, early adaptive computation work like [Conditional Computation in Neural Networks](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013) discussed conditional activation without a formal capacity limit.\n\n[Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) scaled sparse routing to hundreds of experts, revealing the need for explicit load control and motivating later formulations of expert capacity.\n\n[GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020) addressed large-scale MoE training and system-level scaling but treated expert capacity implicitly as an implementation-level constraint rather than a tunable hyper-parameter.\n\n[Switch Transformer: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity](https://arxiv.org/abs/2101.03961) by Fedus, Zoph & Shazeer (2021) formally defined the expert capacity equation and the capacity factor as explicit, first-class hyper-parameters.\n\nSubsequent studies such as [BASE Layers: Simplifying Training of Large, Sparse Models](https://arxiv.org/abs/2103.16716) by Lewis et al. (2021), [ST-MoE: Designing Stable and Transferable Sparse Expert Models](https://arxiv.org/abs/2202.08906) by Zoph et al. (2022), and [Efficient Large Language Models: A Survey](https://arxiv.org/abs/2312.03863) by Dai et al. (2023) have expanded this idea into capacity-aware training and inference strategies — highlighting expert capacity as a controllable mechanism for efficiency, stability, and specialization.\n\n#### Early Conditional-Computation and MoE Origins\n\n*   The notion of dividing computation among multiple experts dates back to early modular neural networks such as _adaptive mixtures of local experts_ by Michael I. Jordan and Robert A. Jacobs (1991), described in [Adaptive Mixtures of Local Experts](https://dl.acm.org/doi/10.1162/neco.1991.3.1.79). These early architectures introduced the idea of a **gating network** that learns how to distribute inputs to specialized sub-networks.\n    \n*   Later, conditional computation became central to deep learning research. According to [Learning Factored Representations in a Deep Mixture of Experts](https://arxiv.org/abs/1312.4314) by Eigen et al. (2013), the model proposed activating only subsets of a deep network for each input, foreshadowing the sparse-activation ideas used in modern MoE architectures. Similarly, [Estimating or Propagating Gradients Through Stochastic Neurons for Conditional Computation](https://arxiv.org/abs/1511.06297) by Bengio et al. (2015) extended this to _stochastic routing_, introducing probabilistic gating mechanisms that enabled selective activation of sub-networks.\n    \n*   These early efforts laid the groundwork for modern sparse expert activation but did **not** define an explicit per-expert token capacity or a capacity-factor hyper-parameter. That formalism would only emerge years later with large-scale transformer-based MoE systems.\n    \n\nThe notion of dividing computation among multiple experts dates back to early modular neural networks such as _adaptive mixtures of local experts_ by Michael I. Jordan and Robert A. Jacobs (1991), described in [Adaptive Mixtures of Local Experts](https://dl.acm.org/doi/10.1162/neco.1991.3.1.79). These early architectures introduced the idea of a **gating network** that learns how to distribute inputs to specialized sub-networks.\n\nLater, conditional computation became central to deep learning research. According to [Learning Factored Representations in a Deep Mixture of Experts](https://arxiv.org/abs/1312.4314) by Eigen et al. (2013), the model proposed activating only subsets of a deep network for each input, foreshadowing the sparse-activation ideas used in modern MoE architectures. Similarly, [Estimating or Propagating Gradients Through Stochastic Neurons for Conditional Computation](https://arxiv.org/abs/1511.06297) by Bengio et al. (2015) extended this to _stochastic routing_, introducing probabilistic gating mechanisms that enabled selective activation of sub-networks.\n\nThese early efforts laid the groundwork for modern sparse expert activation but did **not** define an explicit per-expert token capacity or a capacity-factor hyper-parameter. That formalism would only emerge years later with large-scale transformer-based MoE systems.\n\n#### The First Large-Scale Sparse MoE: “Sparsely-Gated MoE” (2017)\n\n*   A major leap in scalability came with [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017). This seminal work operationalized Mixture-of-Experts at unprecedented scale, introducing thousands of feed-forward experts within Transformer-style architectures.\n    \n*   The key innovation was the **sparsely-gated routing mechanism**, where a learned gating network dynamically selected only the _top-1_ or _top-2_ experts for each input token. This selective activation made it possible to scale model size without linearly increasing computational cost.\n    \n*   The gating network was trained jointly with the experts and included an **auxiliary load-balancing loss** to encourage even expert utilization and prevent routing collapse (where a few experts dominate). The paper demonstrated how sparse activation could extend model capacity while maintaining manageable training costs on large distributed systems such as TensorFlow.\n    \n*   Despite these breakthroughs, the framework did not yet define a formal notion of _expert capacity_ or a _capacity factor_. Instead, expert load control was managed heuristically through the gating loss and token-dropping mechanisms. These ideas laid the foundation for later work such as [GShard](https://arxiv.org/abs/2006.16668) and [Switch Transformer](https://arxiv.org/abs/2101.03961), which explicitly quantified and parameterized per-expert capacity.\n    \n\nA major leap in scalability came with [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017). This seminal work operationalized Mixture-of-Experts at unprecedented scale, introducing thousands of feed-forward experts within Transformer-style architectures.\n\nThe key innovation was the **sparsely-gated routing mechanism**, where a learned gating network dynamically selected only the _top-1_ or _top-2_ experts for each input token. This selective activation made it possible to scale model size without linearly increasing computational cost.\n\nThe gating network was trained jointly with the experts and included an **auxiliary load-balancing loss** to encourage even expert utilization and prevent routing collapse (where a few experts dominate). The paper demonstrated how sparse activation could extend model capacity while maintaining manageable training costs on large distributed systems such as TensorFlow.\n\nDespite these breakthroughs, the framework did not yet define a formal notion of _expert capacity_ or a _capacity factor_. Instead, expert load control was managed heuristically through the gating loss and token-dropping mechanisms. These ideas laid the foundation for later work such as [GShard](https://arxiv.org/abs/2006.16668) and [Switch Transformer](https://arxiv.org/abs/2101.03961), which explicitly quantified and parameterized per-expert capacity.\n\n#### Scaling to Conditional Models: GShard (2020)\n\n*   The next turning point in scaling conditional computation came with [GShard](https://arxiv.org/abs/2006.16668). This system enabled training of multilingual Transformer models exceeding **600 billion parameters**, establishing a new paradigm for distributed sparse computation across large clusters.\n    \n*   GShard introduced several key innovations that made large-scale sparse MoE training practical:\n    \n    *   **Automatic sharding** across thousands of devices, enabling each expert to reside on separate compute nodes while maintaining efficient communication via _all-to-all_ token exchange.\n    *   **Top-2 routing**, which improved stability compared to earlier top-1 gating, ensuring that each token could leverage two complementary experts.\n    *   **Dynamic load-balancing loss**, inherited from [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538), to prevent expert overloading and under-utilization during distributed training.\n*   While GShard significantly advanced the scalability of MoE systems, its treatment of **expert capacity** remained _implicit_. Each expert’s token processing limit was defined as a systems-level constant rather than a tunable model hyper-parameter. This approach worked for engineering stability but limited fine-grained control over computational balance and token overflow.\n    \n*   The insights from GShard directly influenced later developments such as [Switch Transformer](https://arxiv.org/abs/2101.03961), which explicitly formulated the **expert capacity equation** and introduced the **capacity factor (αα\\\\alpha)** as a first-class hyper-parameter governing token allocation per expert. This formalization transformed capacity management from a systems constraint into a learnable and optimizable design variable within large-scale MoE architectures.\n    \n\nThe next turning point in scaling conditional computation came with [GShard](https://arxiv.org/abs/2006.16668). This system enabled training of multilingual Transformer models exceeding **600 billion parameters**, establishing a new paradigm for distributed sparse computation across large clusters.\n\nGShard introduced several key innovations that made large-scale sparse MoE training practical:\n\n*   **Automatic sharding** across thousands of devices, enabling each expert to reside on separate compute nodes while maintaining efficient communication via _all-to-all_ token exchange.\n*   **Top-2 routing**, which improved stability compared to earlier top-1 gating, ensuring that each token could leverage two complementary experts.\n*   **Dynamic load-balancing loss**, inherited from [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538), to prevent expert overloading and under-utilization during distributed training.\n\nWhile GShard significantly advanced the scalability of MoE systems, its treatment of **expert capacity** remained _implicit_. Each expert’s token processing limit was defined as a systems-level constant rather than a tunable model hyper-parameter. This approach worked for engineering stability but limited fine-grained control over computational balance and token overflow.\n\nThe insights from GShard directly influenced later developments such as [Switch Transformer](https://arxiv.org/abs/2101.03961), which explicitly formulated the **expert capacity equation** and introduced the **capacity factor (αα\\\\alpha)** as a first-class hyper-parameter governing token allocation per expert. This formalization transformed capacity management from a systems constraint into a learnable and optimizable design variable within large-scale MoE architectures.\n\n#### Formalization of “Capacity Factor”: Switch Transformer (2021)\n\n*   The formal definition of **expert capacity** emerged in [Switch Transformers](https://arxiv.org/abs/2101.03961). This work extended the MoE paradigm to trillion-parameter scale while preserving training efficiency and stability. Its key contribution was the explicit mathematical formulation of _expert capacity_ and the _capacity factor_, which collectively defined a tunable upper bound on how many tokens could be routed to each expert per training step.\n    \n*   The expert capacity CCC is defined as:\n    \n    C\\=TN×αC\\=TN×α\n    \n    C = \\\\frac{T}{N} \\\\times \\\\alpha\n    *   where:\n        \n        *   TTT — total number of tokens in the batch,\n        *   NNN — total number of experts,\n        *   αα\\\\alpha — _capacity factor_, a tunable scalar that expands or contracts per-expert token capacity.\n*   The capacity factor αα\\\\alpha was introduced to manage the natural variability in token-to-expert assignment. Since routing is probabilistic, some experts receive more tokens than others. Setting α\\>1α\\>1\\\\alpha > 1 provides a buffer to accommodate these fluctuations, while α<1α<1\\\\alpha < 1 enforces stricter token limits, increasing efficiency at the risk of dropping excess tokens.\n    \n*   According to [Switch Transformers](https://arxiv.org/abs/2101.03961), “A capacity factor greater than 1.0 creates additional buffer to accommodate when tokens are not perfectly balanced across experts.” This insight formally linked the idea of routing imbalance to a _controllable hyper-parameter_, enabling model designers to trade off between computational efficiency, overflow tolerance, and token drop rates.\n    \n*   This formulation also introduced a deterministic rule for dropped tokens — when a particular expert exceeds its capacity CCC, the overflow tokens are either **skipped** (via residual pathways) or **rerouted** to other experts, depending on the implementation. The result was a predictable and efficient routing framework that made trillion-parameter training feasible for the first time.\n    \n*   The explicit introduction of CCC and αα\\\\alpha thus transformed what had previously been a system-level constraint (as in [GShard](https://arxiv.org/abs/2006.16668)) into a _model-level hyper-parameter_. This shift made expert capacity an essential design tool for controlling load balance, efficiency, and overall throughput in sparse architectures.\n    \n\nThe formal definition of **expert capacity** emerged in [Switch Transformers](https://arxiv.org/abs/2101.03961). This work extended the MoE paradigm to trillion-parameter scale while preserving training efficiency and stability. Its key contribution was the explicit mathematical formulation of _expert capacity_ and the _capacity factor_, which collectively defined a tunable upper bound on how many tokens could be routed to each expert per training step.\n\nThe expert capacity CCC is defined as:\n\n*   where:\n    \n    *   TTT — total number of tokens in the batch,\n    *   NNN — total number of experts,\n    *   αα\\\\alpha — _capacity factor_, a tunable scalar that expands or contracts per-expert token capacity.\n\nwhere:\n\n*   TTT — total number of tokens in the batch,\n*   NNN — total number of experts,\n*   αα\\\\alpha — _capacity factor_, a tunable scalar that expands or contracts per-expert token capacity.\n\nThe capacity factor αα\\\\alpha was introduced to manage the natural variability in token-to-expert assignment. Since routing is probabilistic, some experts receive more tokens than others. Setting α\\>1α\\>1\\\\alpha > 1 provides a buffer to accommodate these fluctuations, while α<1α<1\\\\alpha < 1 enforces stricter token limits, increasing efficiency at the risk of dropping excess tokens.\n\nAccording to [Switch Transformers](https://arxiv.org/abs/2101.03961), “A capacity factor greater than 1.0 creates additional buffer to accommodate when tokens are not perfectly balanced across experts.” This insight formally linked the idea of routing imbalance to a _controllable hyper-parameter_, enabling model designers to trade off between computational efficiency, overflow tolerance, and token drop rates.\n\nThis formulation also introduced a deterministic rule for dropped tokens — when a particular expert exceeds its capacity CCC, the overflow tokens are either **skipped** (via residual pathways) or **rerouted** to other experts, depending on the implementation. The result was a predictable and efficient routing framework that made trillion-parameter training feasible for the first time.\n\nThe explicit introduction of CCC and αα\\\\alpha thus transformed what had previously been a system-level constraint (as in [GShard](https://arxiv.org/abs/2006.16668)) into a _model-level hyper-parameter_. This shift made expert capacity an essential design tool for controlling load balance, efficiency, and overall throughput in sparse architectures.\n\n#### Subsequent Research: Variations and Deeper Analysis\n\n*   Following the introduction of _expert capacity_ and the _capacity factor_ in [Switch Transformer](https://arxiv.org/abs/2101.03961), subsequent research expanded the theoretical and empirical understanding of how these parameters affect efficiency, load balance, and convergence in MoE architectures.\n    \n*   According to [A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), expert capacity and the capacity factor αα\\\\alpha are “crucial for ensuring balanced load distribution and efficient utilization of the model’s experts.” This survey synthesizes evidence showing that proper tuning of αα\\\\alpha directly improves FLOPs utilization and mitigates _expert under-training_, a phenomenon where certain experts receive insufficient tokens to learn meaningful specializations.\n    \n*   The [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022) explored the relationship between capacity and routing in detail. The authors demonstrated that lowering the capacity factor from 2.0 to 1.0 increased token drop rates, leading to performance degradation on language modeling benchmarks. Their experiments highlighted that _balanced routing and sufficient per-expert capacity_ are essential for stable optimization and reduced gradient variance across experts.\n    \n*   Meanwhile, [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) focused on inference-time efficiency, proposing **capacity-aware token dropping** and **rerouting mechanisms** to avoid the “straggler effect,” where overloaded experts slow down batch inference. These methods adaptively monitor per-expert load and dynamically reassign tokens to maintain predictable latency, demonstrating that expert capacity also governs runtime stability, not just training efficiency.\n    \n*   Finally, industry practitioners and open-source frameworks have reinforced these insights. For example, _Mixture-of-Experts Explained_ on the [Hugging Face Blog](https://huggingface.co/blog/moe) emphasizes that setting the capacity factor between 1.0 and 1.25 achieves an optimal trade-off between throughput and overflow safety in top-2 routing configurations.\n    \n*   Collectively, these studies established _expert capacity_ as a tunable control variable central to both system design and model convergence. It governs the interaction between routing stochasticity, memory provisioning, and distributed synchronization—making it one of the most practically significant hyper-parameters in large-scale MoE architectures.\n    \n\nFollowing the introduction of _expert capacity_ and the _capacity factor_ in [Switch Transformer](https://arxiv.org/abs/2101.03961), subsequent research expanded the theoretical and empirical understanding of how these parameters affect efficiency, load balance, and convergence in MoE architectures.\n\nAccording to [A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), expert capacity and the capacity factor αα\\\\alpha are “crucial for ensuring balanced load distribution and efficient utilization of the model’s experts.” This survey synthesizes evidence showing that proper tuning of αα\\\\alpha directly improves FLOPs utilization and mitigates _expert under-training_, a phenomenon where certain experts receive insufficient tokens to learn meaningful specializations.\n\nThe [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022) explored the relationship between capacity and routing in detail. The authors demonstrated that lowering the capacity factor from 2.0 to 1.0 increased token drop rates, leading to performance degradation on language modeling benchmarks. Their experiments highlighted that _balanced routing and sufficient per-expert capacity_ are essential for stable optimization and reduced gradient variance across experts.\n\nMeanwhile, [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) focused on inference-time efficiency, proposing **capacity-aware token dropping** and **rerouting mechanisms** to avoid the “straggler effect,” where overloaded experts slow down batch inference. These methods adaptively monitor per-expert load and dynamically reassign tokens to maintain predictable latency, demonstrating that expert capacity also governs runtime stability, not just training efficiency.\n\nFinally, industry practitioners and open-source frameworks have reinforced these insights. For example, _Mixture-of-Experts Explained_ on the [Hugging Face Blog](https://huggingface.co/blog/moe) emphasizes that setting the capacity factor between 1.0 and 1.25 achieves an optimal trade-off between throughput and overflow safety in top-2 routing configurations.\n\nCollectively, these studies established _expert capacity_ as a tunable control variable central to both system design and model convergence. It governs the interaction between routing stochasticity, memory provisioning, and distributed synchronization—making it one of the most practically significant hyper-parameters in large-scale MoE architectures.",
    "contentLength": 68704,
    "wordCount": 3180,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#historical-context-and-related-work"
  },
  {
    "id": "ai-mixture-of-experts-formal-definition-and-role-11",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Capacity and Capacity Factor",
    "title": "Formal Definition and Role",
    "order": 11,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>The formal notion of <strong>expert capacity</strong> was first articulated in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>. This definition quantifies the number of tokens (or activations) each expert can process in a single forward pass, offering a mathematical framework for balancing computational efficiency and routing uniformity.</li>\n</ul>\n<h4 id=\"definition\">Definition</h4>\n<ul>\n  <li>\n    <p>Suppose a MoE layer receives a batch of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-40-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-197\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-198\"><span class=\"mi\" id=\"MathJax-Span-199\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-40\">T</script> tokens that are distributed among <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-41-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-200\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-201\"><span class=\"mi\" id=\"MathJax-Span-202\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-41\">N</script> experts. Each expert can handle at most <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-42-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-203\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-204\"><span class=\"mi\" id=\"MathJax-Span-205\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-42\">C</script> tokens per step, where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-43-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-206\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-207\"><span class=\"mi\" id=\"MathJax-Span-208\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-43\">C</script> — the <strong>expert capacity</strong> — is defined as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-44-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-209\" style=\"width: 5.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.638em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1004.64em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-210\"><span class=\"mi\" id=\"MathJax-Span-211\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-212\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-213\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-214\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-215\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-216\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-217\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-44\">C = \\frac{T}{N} \\times \\alpha</script>\n\n    <ul>\n      <li>\n        <p>where:</p>\n\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-45-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-218\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-219\"><span class=\"mi\" id=\"MathJax-Span-220\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-45\">T</script> = total number of tokens in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-46-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-221\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-222\"><span class=\"mi\" id=\"MathJax-Span-223\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-46\">N</script> = total number of experts,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-47-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-224\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-225\"><span class=\"mi\" id=\"MathJax-Span-226\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-47\">\\alpha</script> = capacity factor (a tunable hyper-parameter controlling the per-expert buffer).</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>As described in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, this formulation ensures that each expert processes approximately an equal share of the total tokens while allowing flexibility through <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-48-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-227\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-228\"><span class=\"mi\" id=\"MathJax-Span-229\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-48\">\\alpha</script>. When routing exceeds <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-49-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-230\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-231\"><span class=\"mi\" id=\"MathJax-Span-232\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-49\">C</script> tokens for any expert, the surplus tokens are either <strong>dropped</strong> (skipped via a residual connection) or <strong>rerouted</strong> to other experts, depending on the implementation.</p>\n  </li>\n</ul>\n<p>Suppose a MoE layer receives a batch of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-40-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-197\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-198\"><span class=\"mi\" id=\"MathJax-Span-199\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-40\">T</script> tokens that are distributed among <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-41-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-200\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-201\"><span class=\"mi\" id=\"MathJax-Span-202\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-41\">N</script> experts. Each expert can handle at most <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-42-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-203\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-204\"><span class=\"mi\" id=\"MathJax-Span-205\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-42\">C</script> tokens per step, where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-43-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-206\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-207\"><span class=\"mi\" id=\"MathJax-Span-208\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-43\">C</script> — the <strong>expert capacity</strong> — is defined as:</p>\n<ul>\n      <li>\n        <p>where:</p>\n\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-45-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-218\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-219\"><span class=\"mi\" id=\"MathJax-Span-220\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-45\">T</script> = total number of tokens in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-46-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-221\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-222\"><span class=\"mi\" id=\"MathJax-Span-223\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-46\">N</script> = total number of experts,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-47-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-224\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-225\"><span class=\"mi\" id=\"MathJax-Span-226\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-47\">\\alpha</script> = capacity factor (a tunable hyper-parameter controlling the per-expert buffer).</li>\n        </ul>\n      </li>\n    </ul>\n<p>where:</p>\n<ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-45-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-218\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-219\"><span class=\"mi\" id=\"MathJax-Span-220\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-45\">T</script> = total number of tokens in the batch,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-46-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-221\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-222\"><span class=\"mi\" id=\"MathJax-Span-223\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-46\">N</script> = total number of experts,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-47-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-224\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-225\"><span class=\"mi\" id=\"MathJax-Span-226\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-47\">\\alpha</script> = capacity factor (a tunable hyper-parameter controlling the per-expert buffer).</li>\n        </ul>\n<p>As described in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, this formulation ensures that each expert processes approximately an equal share of the total tokens while allowing flexibility through <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-48-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-227\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-228\"><span class=\"mi\" id=\"MathJax-Span-229\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-48\">\\alpha</script>. When routing exceeds <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-49-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-230\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-231\"><span class=\"mi\" id=\"MathJax-Span-232\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-49\">C</script> tokens for any expert, the surplus tokens are either <strong>dropped</strong> (skipped via a residual connection) or <strong>rerouted</strong> to other experts, depending on the implementation.</p>\n<h4 id=\"role-of-expert-capacity\">Role of Expert Capacity</h4>\n<ul>\n  <li>\n    <p>Expert capacity plays a <strong>dual role</strong> in MoE design:</p>\n\n    <ol>\n      <li>as a <strong>control mechanism</strong> for maintaining balanced token routing, and</li>\n      <li>as a <strong>stability constraint</strong> to prevent computational overload.</li>\n    </ol>\n  </li>\n</ul>\n<p>Expert capacity plays a <strong>dual role</strong> in MoE design:</p>\n<ol>\n      <li>as a <strong>control mechanism</strong> for maintaining balanced token routing, and</li>\n      <li>as a <strong>stability constraint</strong> to prevent computational overload.</li>\n    </ol>\n<ol>\n  <li>\n    <p><strong>Load Control and Fair Routing</strong></p>\n\n    <ul>\n      <li>According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, dividing total tokens evenly across experts prevents a single expert from becoming a bottleneck. This equalization maintains high hardware utilization and mitigates under-training of less frequently selected experts.</li>\n      <li>The <strong>auxiliary load-balancing loss</strong>, introduced originally in <a href=\"https://arxiv.org/abs/1701.06538\">Sparely-gated MoE</a>, complements this constraint by encouraging the router to distribute tokens uniformly.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Safety Buffer and Drop-Rate Management</strong></p>\n\n    <ul>\n      <li>A capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-50-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;gt;</mo><mn>1.0</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-233\" style=\"width: 3.701em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.076em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.08em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-234\"><span class=\"mi\" id=\"MathJax-Span-235\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-236\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-237\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>&gt;</mo><mn>1.0</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-50\">\\alpha > 1.0</script> provides a <strong>safety margin</strong> that accounts for random variation in token-to-expert assignment. For example, with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-51-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-238\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-239\"><span class=\"mi\" id=\"MathJax-Span-240\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-241\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-242\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-51\">\\alpha = 1.25</script>, each expert can process up to 25 % more tokens than its nominal share.</li>\n      <li>Empirically, <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> demonstrated that using <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-52-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-243\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-244\"><span class=\"mi\" id=\"MathJax-Span-245\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-246\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-247\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-52\">\\alpha = 1.25</script> reduced token drop rates below 1 % without sacrificing efficiency. Similarly, <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022) found that setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-53-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-248\" style=\"width: 3.701em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.076em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.08em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-249\"><span class=\"mi\" id=\"MathJax-Span-250\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-251\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-252\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-53\">\\alpha = 1.0</script> increased overflow events and degraded perplexity, reinforcing the value of moderate over-capacity.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Trade-Off Between Efficiency and Robustness</strong></p>\n\n    <ul>\n      <li>Larger capacity factors <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-54-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03B1;</mi><mo>&amp;gt;</mo><mn>1.5</mn><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-253\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.65em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-254\"><span class=\"mo\" id=\"MathJax-Span-255\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-256\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-257\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-258\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.5</span><span class=\"mo\" id=\"MathJax-Span-259\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><mi>α</mi><mo>&gt;</mo><mn>1.5</mn><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-54\">(\\alpha > 1.5)</script> enhance routing robustness but raise computational and communication costs proportionally. As noted in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> and reaffirmed by <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts</a> by Jiang et al. (2025), tuning <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-55-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-260\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-261\"><span class=\"mi\" id=\"MathJax-Span-262\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-55\">\\alpha</script> is a key system-level optimization that balances FLOPs utilization, throughput, and memory overhead.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Interaction with Distributed Training</strong></p>\n\n    <ul>\n      <li>In distributed systems like <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>, expert capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-56-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-263\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-264\"><span class=\"mi\" id=\"MathJax-Span-265\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-56\">C</script> also serves as a <strong>communication boundary</strong>. Each device processes a predictable token budget, facilitating efficient <em>all-to-all</em> routing and minimizing synchronization delays.</li>\n      <li>Predictable per-expert capacity ensures deterministic scheduling, allowing large-scale models to maintain parallel efficiency without exceeding memory constraints.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Mathematical Interpretation</strong></p>\n\n    <ul>\n      <li>\n        <p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-57-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-266\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-267\"><span class=\"msubsup\" id=\"MathJax-Span-268\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-269\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-270\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-57\">p_i</script> denote the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-58-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-271\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-272\"><span class=\"mi\" id=\"MathJax-Span-273\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-58\">i</script>. Ideally, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-59-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-274\" style=\"width: 3.388em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.82em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-275\"><span class=\"msubsup\" id=\"MathJax-Span-276\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-277\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-278\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-279\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mfrac\" id=\"MathJax-Span-280\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-281\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-282\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-59\">p_i \\approx \\frac{1}{N}</script>. When routing noise causes imbalance, the overflow tokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-60-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-283\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-284\"><span class=\"msubsup\" id=\"MathJax-Span-285\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-286\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-287\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-60\">O_i</script> can be modeled as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-61-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mi>C</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-288\" style=\"width: 10.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.753em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.7em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-289\"><span class=\"msubsup\" id=\"MathJax-Span-290\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-291\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-292\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-293\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-294\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">max</span><span class=\"mo\" id=\"MathJax-Span-295\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mn\" id=\"MathJax-Span-296\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-297\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-298\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-299\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-300\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-301\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-302\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mi\" id=\"MathJax-Span-303\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-304\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=\"true\" form=\"prefix\">max</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>p</mi><mi>i</mi></msub><mo>−</mo><mi>C</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-61\">O_i = \\max(0, T p_i - C)</script>\n      </li>\n      <li>\n        <p>The total <strong>drop rate</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-62-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-305\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-306\"><span class=\"mi\" id=\"MathJax-Span-307\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-62\">r</script> is then given by:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-63-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>r</mi><mo>=</mo><mfrac><mrow><munder><mo>&amp;#x2211;</mo><mi>i</mi></munder><msub><mi>O</mi><mi>i</mi></msub></mrow><mi>T</mi></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-308\" style=\"width: 5.159em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.273em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.523em, 1004.27em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-309\"><span class=\"mi\" id=\"MathJax-Span-310\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-311\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-312\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.503em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.076em, 1002.4em, 4.482em, -999.997em); top: -4.789em; left: 50%; margin-left: -1.195em;\"><span class=\"mrow\" id=\"MathJax-Span-313\"><span class=\"munderover\" id=\"MathJax-Span-314\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-315\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-316\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-317\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-318\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-319\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-320\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1002.5em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 2.503em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>r</mi><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>O</mi><mi>i</mi></msub></mrow><mi>T</mi></mfrac></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-63\">r = \\frac{\\sum_i O_i}{T}</script>\n      </li>\n      <li>\n        <p>Minimizing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-64-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-321\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-322\"><span class=\"mi\" id=\"MathJax-Span-323\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-64\">r</script> while maintaining low compute cost is a primary optimization objective in MoE design. Effective tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-65-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-324\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-325\"><span class=\"mi\" id=\"MathJax-Span-326\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-65\">\\alpha</script> thus directly impacts stability, fairness, and hardware efficiency.</p>\n      </li>\n    </ul>\n  </li>\n</ol>\n<p><strong>Load Control and Fair Routing</strong></p>\n<ul>\n      <li>According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, dividing total tokens evenly across experts prevents a single expert from becoming a bottleneck. This equalization maintains high hardware utilization and mitigates under-training of less frequently selected experts.</li>\n      <li>The <strong>auxiliary load-balancing loss</strong>, introduced originally in <a href=\"https://arxiv.org/abs/1701.06538\">Sparely-gated MoE</a>, complements this constraint by encouraging the router to distribute tokens uniformly.</li>\n    </ul>\n<p><strong>Safety Buffer and Drop-Rate Management</strong></p>\n<ul>\n      <li>A capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-50-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;gt;</mo><mn>1.0</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-233\" style=\"width: 3.701em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.076em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.08em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-234\"><span class=\"mi\" id=\"MathJax-Span-235\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-236\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-237\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>&gt;</mo><mn>1.0</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-50\">\\alpha > 1.0</script> provides a <strong>safety margin</strong> that accounts for random variation in token-to-expert assignment. For example, with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-51-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-238\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-239\"><span class=\"mi\" id=\"MathJax-Span-240\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-241\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-242\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-51\">\\alpha = 1.25</script>, each expert can process up to 25 % more tokens than its nominal share.</li>\n      <li>Empirically, <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> demonstrated that using <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-52-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-243\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-244\"><span class=\"mi\" id=\"MathJax-Span-245\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-246\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-247\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-52\">\\alpha = 1.25</script> reduced token drop rates below 1 % without sacrificing efficiency. Similarly, <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022) found that setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-53-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-248\" style=\"width: 3.701em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.076em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.08em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-249\"><span class=\"mi\" id=\"MathJax-Span-250\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-251\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-252\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-53\">\\alpha = 1.0</script> increased overflow events and degraded perplexity, reinforcing the value of moderate over-capacity.</li>\n    </ul>\n<p><strong>Trade-Off Between Efficiency and Robustness</strong></p>\n<ul>\n      <li>Larger capacity factors <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-54-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03B1;</mi><mo>&amp;gt;</mo><mn>1.5</mn><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-253\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.65em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-254\"><span class=\"mo\" id=\"MathJax-Span-255\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-256\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-257\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-258\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.5</span><span class=\"mo\" id=\"MathJax-Span-259\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><mi>α</mi><mo>&gt;</mo><mn>1.5</mn><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-54\">(\\alpha > 1.5)</script> enhance routing robustness but raise computational and communication costs proportionally. As noted in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> and reaffirmed by <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts</a> by Jiang et al. (2025), tuning <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-55-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-260\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-261\"><span class=\"mi\" id=\"MathJax-Span-262\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-55\">\\alpha</script> is a key system-level optimization that balances FLOPs utilization, throughput, and memory overhead.</li>\n    </ul>\n<p><strong>Interaction with Distributed Training</strong></p>\n<ul>\n      <li>In distributed systems like <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>, expert capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-56-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-263\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-264\"><span class=\"mi\" id=\"MathJax-Span-265\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-56\">C</script> also serves as a <strong>communication boundary</strong>. Each device processes a predictable token budget, facilitating efficient <em>all-to-all</em> routing and minimizing synchronization delays.</li>\n      <li>Predictable per-expert capacity ensures deterministic scheduling, allowing large-scale models to maintain parallel efficiency without exceeding memory constraints.</li>\n    </ul>\n<p><strong>Mathematical Interpretation</strong></p>\n<ul>\n      <li>\n        <p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-57-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-266\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-267\"><span class=\"msubsup\" id=\"MathJax-Span-268\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-269\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-270\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-57\">p_i</script> denote the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-58-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-271\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-272\"><span class=\"mi\" id=\"MathJax-Span-273\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-58\">i</script>. Ideally, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-59-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-274\" style=\"width: 3.388em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.82em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-275\"><span class=\"msubsup\" id=\"MathJax-Span-276\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-277\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-278\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-279\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mfrac\" id=\"MathJax-Span-280\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-281\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-282\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-59\">p_i \\approx \\frac{1}{N}</script>. When routing noise causes imbalance, the overflow tokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-60-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-283\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-284\"><span class=\"msubsup\" id=\"MathJax-Span-285\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-286\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-287\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-60\">O_i</script> can be modeled as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-61-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mi>C</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-288\" style=\"width: 10.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.753em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.7em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-289\"><span class=\"msubsup\" id=\"MathJax-Span-290\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-291\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-292\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-293\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-294\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">max</span><span class=\"mo\" id=\"MathJax-Span-295\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mn\" id=\"MathJax-Span-296\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-297\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-298\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-299\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-300\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-301\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-302\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mi\" id=\"MathJax-Span-303\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-304\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=\"true\" form=\"prefix\">max</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>p</mi><mi>i</mi></msub><mo>−</mo><mi>C</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-61\">O_i = \\max(0, T p_i - C)</script>\n      </li>\n      <li>\n        <p>The total <strong>drop rate</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-62-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-305\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-306\"><span class=\"mi\" id=\"MathJax-Span-307\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-62\">r</script> is then given by:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-63-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>r</mi><mo>=</mo><mfrac><mrow><munder><mo>&amp;#x2211;</mo><mi>i</mi></munder><msub><mi>O</mi><mi>i</mi></msub></mrow><mi>T</mi></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-308\" style=\"width: 5.159em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.273em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.523em, 1004.27em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-309\"><span class=\"mi\" id=\"MathJax-Span-310\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-311\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-312\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.503em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.076em, 1002.4em, 4.482em, -999.997em); top: -4.789em; left: 50%; margin-left: -1.195em;\"><span class=\"mrow\" id=\"MathJax-Span-313\"><span class=\"munderover\" id=\"MathJax-Span-314\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-315\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-316\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-317\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-318\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-319\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-320\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1002.5em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 2.503em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>r</mi><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>O</mi><mi>i</mi></msub></mrow><mi>T</mi></mfrac></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-63\">r = \\frac{\\sum_i O_i}{T}</script>\n      </li>\n      <li>\n        <p>Minimizing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-64-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-321\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-322\"><span class=\"mi\" id=\"MathJax-Span-323\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-64\">r</script> while maintaining low compute cost is a primary optimization objective in MoE design. Effective tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-65-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-324\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-325\"><span class=\"mi\" id=\"MathJax-Span-326\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-65\">\\alpha</script> thus directly impacts stability, fairness, and hardware efficiency.</p>\n      </li>\n    </ul>\n<p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-57-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-266\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-267\"><span class=\"msubsup\" id=\"MathJax-Span-268\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-269\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-270\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-57\">p_i</script> denote the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-58-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-271\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-272\"><span class=\"mi\" id=\"MathJax-Span-273\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-58\">i</script>. Ideally, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-59-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-274\" style=\"width: 3.388em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.82em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-275\"><span class=\"msubsup\" id=\"MathJax-Span-276\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-277\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-278\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-279\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mfrac\" id=\"MathJax-Span-280\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-281\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-282\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-59\">p_i \\approx \\frac{1}{N}</script>. When routing noise causes imbalance, the overflow tokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-60-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-283\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-284\"><span class=\"msubsup\" id=\"MathJax-Span-285\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-286\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-287\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-60\">O_i</script> can be modeled as:</p>\n<p>The total <strong>drop rate</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-62-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-305\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-306\"><span class=\"mi\" id=\"MathJax-Span-307\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-62\">r</script> is then given by:</p>\n<p>Minimizing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-64-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-321\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-322\"><span class=\"mi\" id=\"MathJax-Span-323\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-64\">r</script> while maintaining low compute cost is a primary optimization objective in MoE design. Effective tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-65-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-324\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-325\"><span class=\"mi\" id=\"MathJax-Span-326\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-65\">\\alpha</script> thus directly impacts stability, fairness, and hardware efficiency.</p>",
    "contentMarkdown": "*   The formal notion of **expert capacity** was first articulated in [Switch Transformers](https://arxiv.org/abs/2101.03961). This definition quantifies the number of tokens (or activations) each expert can process in a single forward pass, offering a mathematical framework for balancing computational efficiency and routing uniformity.\n\n#### Definition\n\n*   Suppose a MoE layer receives a batch of TTT tokens that are distributed among NNN experts. Each expert can handle at most CCC tokens per step, where CCC — the **expert capacity** — is defined as:\n    \n    C\\=TN×αC\\=TN×α\n    \n    C = \\\\frac{T}{N} \\\\times \\\\alpha\n    *   where:\n        \n        *   TTT = total number of tokens in the batch,\n        *   NNN = total number of experts,\n        *   αα\\\\alpha = capacity factor (a tunable hyper-parameter controlling the per-expert buffer).\n*   As described in [Switch Transformers](https://arxiv.org/abs/2101.03961), this formulation ensures that each expert processes approximately an equal share of the total tokens while allowing flexibility through αα\\\\alpha. When routing exceeds CCC tokens for any expert, the surplus tokens are either **dropped** (skipped via a residual connection) or **rerouted** to other experts, depending on the implementation.\n    \n\nSuppose a MoE layer receives a batch of TTT tokens that are distributed among NNN experts. Each expert can handle at most CCC tokens per step, where CCC — the **expert capacity** — is defined as:\n\n*   where:\n    \n    *   TTT = total number of tokens in the batch,\n    *   NNN = total number of experts,\n    *   αα\\\\alpha = capacity factor (a tunable hyper-parameter controlling the per-expert buffer).\n\nwhere:\n\n*   TTT = total number of tokens in the batch,\n*   NNN = total number of experts,\n*   αα\\\\alpha = capacity factor (a tunable hyper-parameter controlling the per-expert buffer).\n\nAs described in [Switch Transformers](https://arxiv.org/abs/2101.03961), this formulation ensures that each expert processes approximately an equal share of the total tokens while allowing flexibility through αα\\\\alpha. When routing exceeds CCC tokens for any expert, the surplus tokens are either **dropped** (skipped via a residual connection) or **rerouted** to other experts, depending on the implementation.\n\n#### Role of Expert Capacity\n\n*   Expert capacity plays a **dual role** in MoE design:\n    \n    1.  as a **control mechanism** for maintaining balanced token routing, and\n    2.  as a **stability constraint** to prevent computational overload.\n\nExpert capacity plays a **dual role** in MoE design:\n\n1.  as a **control mechanism** for maintaining balanced token routing, and\n2.  as a **stability constraint** to prevent computational overload.\n\n1.  **Load Control and Fair Routing**\n    \n    *   According to [Switch Transformers](https://arxiv.org/abs/2101.03961), dividing total tokens evenly across experts prevents a single expert from becoming a bottleneck. This equalization maintains high hardware utilization and mitigates under-training of less frequently selected experts.\n    *   The **auxiliary load-balancing loss**, introduced originally in [Sparely-gated MoE](https://arxiv.org/abs/1701.06538), complements this constraint by encouraging the router to distribute tokens uniformly.\n2.  **Safety Buffer and Drop-Rate Management**\n    \n    *   A capacity factor α\\>1.0α\\>1.0\\\\alpha > 1.0 provides a **safety margin** that accounts for random variation in token-to-expert assignment. For example, with α\\=1.25α\\=1.25\\\\alpha = 1.25, each expert can process up to 25 % more tokens than its nominal share.\n    *   Empirically, [Switch Transformers](https://arxiv.org/abs/2101.03961) demonstrated that using α\\=1.25α\\=1.25\\\\alpha = 1.25 reduced token drop rates below 1 % without sacrificing efficiency. Similarly, [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022) found that setting α\\=1.0α\\=1.0\\\\alpha = 1.0 increased overflow events and degraded perplexity, reinforcing the value of moderate over-capacity.\n3.  **Trade-Off Between Efficiency and Robustness**\n    \n    *   Larger capacity factors (α\\>1.5)(α\\>1.5)(\\\\alpha > 1.5) enhance routing robustness but raise computational and communication costs proportionally. As noted in [Switch Transformers](https://arxiv.org/abs/2101.03961) and reaffirmed by [A Comprehensive Survey of Mixture-of-Experts](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), tuning αα\\\\alpha is a key system-level optimization that balances FLOPs utilization, throughput, and memory overhead.\n4.  **Interaction with Distributed Training**\n    \n    *   In distributed systems like [GShard](https://arxiv.org/abs/2006.16668), expert capacity CCC also serves as a **communication boundary**. Each device processes a predictable token budget, facilitating efficient _all-to-all_ routing and minimizing synchronization delays.\n    *   Predictable per-expert capacity ensures deterministic scheduling, allowing large-scale models to maintain parallel efficiency without exceeding memory constraints.\n5.  **Mathematical Interpretation**\n    \n    *   Let pipip\\_i denote the fraction of tokens routed to expert iii. Ideally, pi≈1Npi≈1Np\\_i \\\\approx \\\\frac{1}{N}. When routing noise causes imbalance, the overflow tokens OiOiO\\_i can be modeled as:\n        \n        Oi\\=max(0,Tpi−C)Oi\\=max(0,Tpi−C)\n        \n        O\\_i = \\\\max(0, T p\\_i - C)\n    *   The total **drop rate** rrr is then given by:\n        \n        r\\=∑iOiTr\\=∑iOiT\n        \n        r = \\\\frac{\\\\sum\\_i O\\_i}{T}\n    *   Minimizing rrr while maintaining low compute cost is a primary optimization objective in MoE design. Effective tuning of αα\\\\alpha thus directly impacts stability, fairness, and hardware efficiency.\n        \n\n**Load Control and Fair Routing**\n\n*   According to [Switch Transformers](https://arxiv.org/abs/2101.03961), dividing total tokens evenly across experts prevents a single expert from becoming a bottleneck. This equalization maintains high hardware utilization and mitigates under-training of less frequently selected experts.\n*   The **auxiliary load-balancing loss**, introduced originally in [Sparely-gated MoE](https://arxiv.org/abs/1701.06538), complements this constraint by encouraging the router to distribute tokens uniformly.\n\n**Safety Buffer and Drop-Rate Management**\n\n*   A capacity factor α\\>1.0α\\>1.0\\\\alpha > 1.0 provides a **safety margin** that accounts for random variation in token-to-expert assignment. For example, with α\\=1.25α\\=1.25\\\\alpha = 1.25, each expert can process up to 25 % more tokens than its nominal share.\n*   Empirically, [Switch Transformers](https://arxiv.org/abs/2101.03961) demonstrated that using α\\=1.25α\\=1.25\\\\alpha = 1.25 reduced token drop rates below 1 % without sacrificing efficiency. Similarly, [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022) found that setting α\\=1.0α\\=1.0\\\\alpha = 1.0 increased overflow events and degraded perplexity, reinforcing the value of moderate over-capacity.\n\n**Trade-Off Between Efficiency and Robustness**\n\n*   Larger capacity factors (α\\>1.5)(α\\>1.5)(\\\\alpha > 1.5) enhance routing robustness but raise computational and communication costs proportionally. As noted in [Switch Transformers](https://arxiv.org/abs/2101.03961) and reaffirmed by [A Comprehensive Survey of Mixture-of-Experts](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), tuning αα\\\\alpha is a key system-level optimization that balances FLOPs utilization, throughput, and memory overhead.\n\n**Interaction with Distributed Training**\n\n*   In distributed systems like [GShard](https://arxiv.org/abs/2006.16668), expert capacity CCC also serves as a **communication boundary**. Each device processes a predictable token budget, facilitating efficient _all-to-all_ routing and minimizing synchronization delays.\n*   Predictable per-expert capacity ensures deterministic scheduling, allowing large-scale models to maintain parallel efficiency without exceeding memory constraints.\n\n**Mathematical Interpretation**\n\n*   Let pipip\\_i denote the fraction of tokens routed to expert iii. Ideally, pi≈1Npi≈1Np\\_i \\\\approx \\\\frac{1}{N}. When routing noise causes imbalance, the overflow tokens OiOiO\\_i can be modeled as:\n    \n    Oi\\=max(0,Tpi−C)Oi\\=max(0,Tpi−C)\n    \n    O\\_i = \\\\max(0, T p\\_i - C)\n*   The total **drop rate** rrr is then given by:\n    \n    r\\=∑iOiTr\\=∑iOiT\n    \n    r = \\\\frac{\\\\sum\\_i O\\_i}{T}\n*   Minimizing rrr while maintaining low compute cost is a primary optimization objective in MoE design. Effective tuning of αα\\\\alpha thus directly impacts stability, fairness, and hardware efficiency.\n    \n\nLet pipip\\_i denote the fraction of tokens routed to expert iii. Ideally, pi≈1Npi≈1Np\\_i \\\\approx \\\\frac{1}{N}. When routing noise causes imbalance, the overflow tokens OiOiO\\_i can be modeled as:\n\nThe total **drop rate** rrr is then given by:\n\nMinimizing rrr while maintaining low compute cost is a primary optimization objective in MoE design. Effective tuning of αα\\\\alpha thus directly impacts stability, fairness, and hardware efficiency.",
    "contentLength": 112811,
    "wordCount": 1137,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#formal-definition-and-role"
  },
  {
    "id": "ai-mixture-of-experts-implications-for-routing-load-balancing-and-effici-12",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Capacity and Capacity Factor",
    "title": "Implications for Routing, Load-Balancing, and Efficiency",
    "order": 12,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>The expert capacity formula <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-66-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-327\" style=\"width: 5.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.43em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1004.43em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-328\"><span class=\"mi\" id=\"MathJax-Span-329\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-330\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-331\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-332\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-333\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-334\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-335\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-66\">C = \\frac{T}{N} \\times \\alpha</script> introduced in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, governs how efficiently tokens are distributed among experts, how evenly computation is balanced, and how throughput scales in large sparse architectures. This parameter serves as the primary control mechanism linking <em>routing behavior</em>, <em>hardware efficiency</em>, and <em>training stability</em>.</li>\n</ul>\n<h4 id=\"token-overflow-and-drop-rate\">Token Overflow and Drop Rate</h4>\n<ul>\n  <li>When more than <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-67-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-336\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-337\"><span class=\"mi\" id=\"MathJax-Span-338\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-67\">C</script> tokens are routed to an expert, the excess — called <strong>overflow tokens</strong> — must be dropped or rerouted. In <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, overflow tokens are typically <strong>dropped</strong>, with their unmodified embeddings passed forward through residual connections.</li>\n  <li>This approach preserves computational determinism and avoids memory overload, but it may slightly reduce representational richness. Empirically, <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> observed that setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-68-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;#x2248;</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-339\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-340\"><span class=\"mi\" id=\"MathJax-Span-341\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-342\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mn\" id=\"MathJax-Span-343\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>≈</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-68\">\\alpha \\approx 1.25</script> maintained &lt;1% token drop rate with minimal performance degradation.</li>\n  <li>Similar observations were made in <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), where lowering <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-69-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-344\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-345\"><span class=\"mi\" id=\"MathJax-Span-346\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-69\">\\alpha</script> to 1.0 increased token drop rate and worsened perplexity scores — demonstrating the sensitivity of model performance to overflow handling.</li>\n</ul>\n<h4 id=\"load-balancing-and-routing-dynamics\">Load-Balancing and Routing Dynamics</h4>\n<ul>\n  <li>Expert capacity directly interacts with <strong>load-balancing objectives</strong>. Ideally, the routing mechanism assigns each expert a uniform fraction <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-70-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mfrac><mi>T</mi><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-347\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1000.84em, 2.659em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-348\"><span class=\"mfrac\" id=\"MathJax-Span-349\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-350\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-351\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mfrac><mi>T</mi><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-70\">\\frac{T}{N}</script> of tokens. However, probabilistic gating (as in <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al., 2017) often leads to skewed utilization.</li>\n  <li>To counteract this, an <strong>auxiliary load-balancing loss</strong> is employed to regularize the router’s token distribution. As introduced in GShard by (<a href=\"https://arxiv.org/abs/2006.16668\">Lepikhin et al. (2020)</a>), this loss penalizes uneven expert selection and helps minimize the risk of saturation or underuse.</li>\n  <li>\n    <p>The loss function is often expressed as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-71-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub><mo>=</mo><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-352\" style=\"width: 9.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.867em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1007.87em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-353\"><span class=\"msubsup\" id=\"MathJax-Span-354\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-355\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-356\"><span class=\"mrow\" id=\"MathJax-Span-357\"><span class=\"mtext\" id=\"MathJax-Span-358\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-359\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-360\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-361\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-362\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-363\"><span class=\"mrow\" id=\"MathJax-Span-364\"><span class=\"mi\" id=\"MathJax-Span-365\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-366\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-367\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-368\"><span class=\"mrow\" id=\"MathJax-Span-369\"><span class=\"mi\" id=\"MathJax-Span-370\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-371\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-372\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-373\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-374\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-375\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-376\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub><mo>=</mo><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-71\">L_{\\text{balance}} = N \\sum_{i=1}^{N} f_i p_i</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-72-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-377\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-378\"><span class=\"msubsup\" id=\"MathJax-Span-379\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-380\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-381\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-72\">f_i</script> is the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-73-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-382\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-383\"><span class=\"mi\" id=\"MathJax-Span-384\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-73\">i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-74-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-385\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-386\"><span class=\"msubsup\" id=\"MathJax-Span-387\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-388\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-389\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-74\">p_i</script> is the corresponding gating probability. Minimizing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-75-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-390\" style=\"width: 3.388em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1002.82em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-391\"><span class=\"msubsup\" id=\"MathJax-Span-392\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-393\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-394\"><span class=\"mrow\" id=\"MathJax-Span-395\"><span class=\"mtext\" id=\"MathJax-Span-396\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-75\">L_{\\text{balance}}</script> encourages equitable routing, reducing the chance that any expert exceeds its capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-76-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-397\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-398\"><span class=\"mi\" id=\"MathJax-Span-399\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-76\">C</script>.</li>\n    </ul>\n  </li>\n</ul>\n<p>The loss function is often expressed as:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-72-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-377\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-378\"><span class=\"msubsup\" id=\"MathJax-Span-379\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-380\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-381\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-72\">f_i</script> is the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-73-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-382\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-383\"><span class=\"mi\" id=\"MathJax-Span-384\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-73\">i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-74-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-385\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-386\"><span class=\"msubsup\" id=\"MathJax-Span-387\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-388\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-389\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-74\">p_i</script> is the corresponding gating probability. Minimizing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-75-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-390\" style=\"width: 3.388em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1002.82em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-391\"><span class=\"msubsup\" id=\"MathJax-Span-392\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-393\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-394\"><span class=\"mrow\" id=\"MathJax-Span-395\"><span class=\"mtext\" id=\"MathJax-Span-396\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-75\">L_{\\text{balance}}</script> encourages equitable routing, reducing the chance that any expert exceeds its capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-76-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-397\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-398\"><span class=\"mi\" id=\"MathJax-Span-399\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-76\">C</script>.</li>\n    </ul>\n<h4 id=\"computational-and-communication-trade-offs\">Computational and Communication Trade-offs</h4>\n<ul>\n  <li>Increasing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-77-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-400\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-401\"><span class=\"mi\" id=\"MathJax-Span-402\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-77\">\\alpha</script> expands per-expert workload, improving tolerance to routing variance but increasing compute and memory cost. As reported by Fedus et al. (2021), this trade-off grows linearly — both computation and communication scale with the effective capacity per expert.</li>\n  <li>Distributed MoE systems like <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> rely on <strong>all-to-all communication</strong> to exchange token representations between devices. When actual token loads exceed the expected <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-78-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-403\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-404\"><span class=\"mi\" id=\"MathJax-Span-405\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-78\">C</script>, communication overhead rises sharply, leading to network congestion and synchronization delays. Hence, moderate capacity factors (typically <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-79-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>1.0</mn><mo>&amp;#x2264;</mo><mi>&amp;#x03B1;</mi><mo>&amp;#x2264;</mo><mn>1.5</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-406\" style=\"width: 6.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.42em, 2.451em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-407\"><span class=\"mn\" id=\"MathJax-Span-408\" style=\"font-family: STIXGeneral-Regular;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-409\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≤</span><span class=\"mi\" id=\"MathJax-Span-410\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mo\" id=\"MathJax-Span-411\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≤</span><span class=\"mn\" id=\"MathJax-Span-412\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.5</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.184em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mn>1.0</mn><mo>≤</mo><mi>α</mi><mo>≤</mo><mn>1.5</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-79\">1.0 \\leq \\alpha \\leq 1.5</script>) are preferred in large production-scale MoE implementations.</li>\n</ul>\n<h4 id=\"scaling-behavior\">Scaling Behavior</h4>\n<ul>\n  <li>Empirical studies show that the optimal capacity factor scales inversely with the number of experts. According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> and <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts</a> by Jiang et al. (2025), as <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-80-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-413\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-414\"><span class=\"mi\" id=\"MathJax-Span-415\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-80\">N</script> increases, the statistical variance of token routing per expert decreases approximately as <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-81-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-416\" style=\"width: 2.711em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.242em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.19em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-417\"><span class=\"mi\" id=\"MathJax-Span-418\" style=\"font-family: STIXGeneral-Italic;\">O</span><span class=\"mo\" id=\"MathJax-Span-419\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mfrac\" id=\"MathJax-Span-420\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-421\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-422\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-423\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>O</mi><mo stretchy=\"false\">(</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-81\">O(\\frac{1}{N})</script>.</li>\n  <li>Consequently, very large MoE systems (hundreds of experts) can maintain low drop rates even with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-82-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;#x2248;</mo><mn>1.0</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-424\" style=\"width: 3.648em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.023em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.02em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-425\"><span class=\"mi\" id=\"MathJax-Span-426\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-427\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mn\" id=\"MathJax-Span-428\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>≈</mo><mn>1.0</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-82\">\\alpha \\approx 1.0</script>, while smaller MoEs require slightly higher values (e.g., <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-83-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-429\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-430\"><span class=\"mi\" id=\"MathJax-Span-431\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-432\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-433\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-83\">\\alpha = 1.25</script>) for stable load distribution.</li>\n</ul>\n<h4 id=\"capacity-in-inference-and-dynamic-routing\">Capacity in Inference and Dynamic Routing</h4>\n<ul>\n  <li>During inference, expert capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-84-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-434\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-435\"><span class=\"mi\" id=\"MathJax-Span-436\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-84\">C</script> becomes critical for <strong>latency predictability</strong>. <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) proposes <em>capacity-aware token dropping</em> and <em>rerouting strategies</em> that dynamically adjust per-expert loads to prevent slowdowns.</li>\n  <li>These methods maintain consistent throughput by enforcing per-step load constraints — ensuring that no expert becomes a straggler even under dynamic or adversarial input distributions.</li>\n</ul>",
    "contentMarkdown": "*   The expert capacity formula C\\=TN×αC\\=TN×αC = \\\\frac{T}{N} \\\\times \\\\alpha introduced in [Switch Transformers](https://arxiv.org/abs/2101.03961), governs how efficiently tokens are distributed among experts, how evenly computation is balanced, and how throughput scales in large sparse architectures. This parameter serves as the primary control mechanism linking _routing behavior_, _hardware efficiency_, and _training stability_.\n\n#### Token Overflow and Drop Rate\n\n*   When more than CCC tokens are routed to an expert, the excess — called **overflow tokens** — must be dropped or rerouted. In [Switch Transformers](https://arxiv.org/abs/2101.03961), overflow tokens are typically **dropped**, with their unmodified embeddings passed forward through residual connections.\n*   This approach preserves computational determinism and avoids memory overload, but it may slightly reduce representational richness. Empirically, [Switch Transformers](https://arxiv.org/abs/2101.03961) observed that setting α≈1.25α≈1.25\\\\alpha \\\\approx 1.25 maintained <1% token drop rate with minimal performance degradation.\n*   Similar observations were made in [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022), where lowering αα\\\\alpha to 1.0 increased token drop rate and worsened perplexity scores — demonstrating the sensitivity of model performance to overflow handling.\n\n#### Load-Balancing and Routing Dynamics\n\n*   Expert capacity directly interacts with **load-balancing objectives**. Ideally, the routing mechanism assigns each expert a uniform fraction TNTN\\\\frac{T}{N} of tokens. However, probabilistic gating (as in [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al., 2017) often leads to skewed utilization.\n*   To counteract this, an **auxiliary load-balancing loss** is employed to regularize the router’s token distribution. As introduced in GShard by ([Lepikhin et al. (2020)](https://arxiv.org/abs/2006.16668)), this loss penalizes uneven expert selection and helps minimize the risk of saturation or underuse.\n*   The loss function is often expressed as:\n    \n    Lbalance\\=N∑i\\=1NfipiLbalance\\=N∑i\\=1Nfipi\n    \n    L\\_{\\\\text{balance}} = N \\\\sum\\_{i=1}^{N} f\\_i p\\_i\n    *   where fifif\\_i is the fraction of tokens routed to expert iii and pipip\\_i is the corresponding gating probability. Minimizing LbalanceLbalanceL\\_{\\\\text{balance}} encourages equitable routing, reducing the chance that any expert exceeds its capacity CCC.\n\nThe loss function is often expressed as:\n\n*   where fifif\\_i is the fraction of tokens routed to expert iii and pipip\\_i is the corresponding gating probability. Minimizing LbalanceLbalanceL\\_{\\\\text{balance}} encourages equitable routing, reducing the chance that any expert exceeds its capacity CCC.\n\n#### Computational and Communication Trade-offs\n\n*   Increasing αα\\\\alpha expands per-expert workload, improving tolerance to routing variance but increasing compute and memory cost. As reported by Fedus et al. (2021), this trade-off grows linearly — both computation and communication scale with the effective capacity per expert.\n*   Distributed MoE systems like [GShard](https://arxiv.org/abs/2006.16668) rely on **all-to-all communication** to exchange token representations between devices. When actual token loads exceed the expected CCC, communication overhead rises sharply, leading to network congestion and synchronization delays. Hence, moderate capacity factors (typically 1.0≤α≤1.51.0≤α≤1.51.0 \\\\leq \\\\alpha \\\\leq 1.5) are preferred in large production-scale MoE implementations.\n\n#### Scaling Behavior\n\n*   Empirical studies show that the optimal capacity factor scales inversely with the number of experts. According to [Switch Transformers](https://arxiv.org/abs/2101.03961) and [A Comprehensive Survey of Mixture-of-Experts](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), as NNN increases, the statistical variance of token routing per expert decreases approximately as O(1N)O(1N)O(\\\\frac{1}{N}).\n*   Consequently, very large MoE systems (hundreds of experts) can maintain low drop rates even with α≈1.0α≈1.0\\\\alpha \\\\approx 1.0, while smaller MoEs require slightly higher values (e.g., α\\=1.25α\\=1.25\\\\alpha = 1.25) for stable load distribution.\n\n#### Capacity in Inference and Dynamic Routing\n\n*   During inference, expert capacity CCC becomes critical for **latency predictability**. [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) proposes _capacity-aware token dropping_ and _rerouting strategies_ that dynamically adjust per-expert loads to prevent slowdowns.\n*   These methods maintain consistent throughput by enforcing per-step load constraints — ensuring that no expert becomes a straggler even under dynamic or adversarial input distributions.",
    "contentLength": 50182,
    "wordCount": 604,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#implications-for-routing,-load-balancing,-and-efficiency"
  },
  {
    "id": "ai-mixture-of-experts-practical-considerations-and-tuning-guidelines-13",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Capacity and Capacity Factor",
    "title": "Practical Considerations and Tuning Guidelines",
    "order": 13,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>Deploying large-scale MoE systems requires careful tuning of the <strong>expert capacity</strong> and <strong>capacity factor</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-85-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03B1;</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-437\" style=\"width: 1.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.25em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-438\"><span class=\"mo\" id=\"MathJax-Span-439\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-440\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-441\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><mi>α</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-85\">(\\alpha)</script> to balance <em>model quality</em>, <em>system efficiency</em>, and <em>training stability</em>. As shown in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus, Zoph &amp; Shazeer (2021), small misconfigurations in these parameters can cause severe routing imbalance, elevated token drop rates, or underutilized experts—undermining the benefits of sparse activation.</li>\n</ul>\n<h4 id=\"choosing-the-capacity-factor\">Choosing the Capacity Factor</h4>\n<ul>\n  <li>Selecting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-86-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-442\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-443\"><span class=\"mi\" id=\"MathJax-Span-444\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-86\">\\alpha</script> is one of the most critical system-level hyperparameter choices. In <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>, capacity factors between <strong>1.0 and 1.25</strong> achieved an optimal trade-off between routing efficiency and drop rate (&lt;1%), maintaining high throughput without saturating hardware.</li>\n  <li>\n    <p>In contrast, <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022) showed that reducing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-87-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-445\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-446\"><span class=\"mi\" id=\"MathJax-Span-447\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-87\">\\alpha</script> to 1.0 increased token drop rates and degraded performance, emphasizing that modest overcapacity buffers are essential for robustness.</p>\n  </li>\n  <li>\n    <p><strong>Empirical guidelines:</strong></p>\n\n    <ul>\n      <li>Small MoE models (few experts): <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-88-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn><mo>&amp;#x2013;</mo><mn>1.5</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-448\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-449\"><span class=\"mi\" id=\"MathJax-Span-450\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-451\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-452\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span><span class=\"mo\" id=\"MathJax-Span-453\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-454\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.5</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn><mo>–</mo><mn>1.5</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-88\">\\alpha = 1.25–1.5</script></li>\n      <li>Large MoE systems (hundreds of experts): <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-89-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn><mo>&amp;#x2013;</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-455\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-456\"><span class=\"mi\" id=\"MathJax-Span-457\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-458\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-459\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-460\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-461\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn><mo>–</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-89\">\\alpha = 1.0–1.25</script></li>\n      <li>Highly dynamic or imbalanced routing: adaptive or per-expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-90-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-462\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-463\"><span class=\"mi\" id=\"MathJax-Span-464\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-90\">\\alpha</script> (as in <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference</a> by He et al., 2025)</li>\n    </ul>\n  </li>\n</ul>\n<p>In contrast, <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022) showed that reducing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-87-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-445\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-446\"><span class=\"mi\" id=\"MathJax-Span-447\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-87\">\\alpha</script> to 1.0 increased token drop rates and degraded performance, emphasizing that modest overcapacity buffers are essential for robustness.</p>\n<p><strong>Empirical guidelines:</strong></p>\n<ul>\n      <li>Small MoE models (few experts): <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-88-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn><mo>&amp;#x2013;</mo><mn>1.5</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-448\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-449\"><span class=\"mi\" id=\"MathJax-Span-450\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-451\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-452\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span><span class=\"mo\" id=\"MathJax-Span-453\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-454\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.5</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn><mo>–</mo><mn>1.5</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-88\">\\alpha = 1.25–1.5</script></li>\n      <li>Large MoE systems (hundreds of experts): <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-89-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn><mo>&amp;#x2013;</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-455\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-456\"><span class=\"mi\" id=\"MathJax-Span-457\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-458\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-459\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-460\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-461\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn><mo>–</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-89\">\\alpha = 1.0–1.25</script></li>\n      <li>Highly dynamic or imbalanced routing: adaptive or per-expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-90-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-462\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-463\"><span class=\"mi\" id=\"MathJax-Span-464\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-90\">\\alpha</script> (as in <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference</a> by He et al., 2025)</li>\n    </ul>\n<h4 id=\"monitoring-routing-distribution-and-drop-rate\">Monitoring Routing Distribution and Drop Rate</h4>\n<ul>\n  <li>\n    <p><a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> emphasized runtime monitoring of token assignments <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-91-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-465\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-466\"><span class=\"msubsup\" id=\"MathJax-Span-467\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-468\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-469\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-91\">f_i</script> across experts to detect imbalance early. Ideally, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-92-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-470\" style=\"width: 3.128em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.61em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-471\"><span class=\"msubsup\" id=\"MathJax-Span-472\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-473\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-474\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-475\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mfrac\" id=\"MathJax-Span-476\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-477\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-478\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-92\">f_i \\approx \\frac{1}{N}</script> for all experts.</p>\n  </li>\n  <li>\n    <p>Overflow per expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-93-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-479\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-480\"><span class=\"msubsup\" id=\"MathJax-Span-481\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-482\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-483\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-93\">O_i</script> can be modeled as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-94-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mi>C</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-484\" style=\"width: 10.263em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.49em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-485\"><span class=\"msubsup\" id=\"MathJax-Span-486\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-487\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-488\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-489\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-490\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">max</span><span class=\"mo\" id=\"MathJax-Span-491\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mn\" id=\"MathJax-Span-492\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-493\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-494\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-495\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-496\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-497\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-498\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mi\" id=\"MathJax-Span-499\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-500\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=\"true\" form=\"prefix\">max</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>f</mi><mi>i</mi></msub><mo>−</mo><mi>C</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-94\">O_i = \\max(0, T f_i - C)</script>\n\n    <ul>\n      <li>… and global drop rate <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-95-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-501\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-502\"><span class=\"mi\" id=\"MathJax-Span-503\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-95\">r</script> as:</li>\n    </ul>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-96-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>r</mi><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-504\" style=\"width: 6.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.211em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1005.21em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-505\"><span class=\"mi\" id=\"MathJax-Span-506\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-507\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-508\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-509\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-510\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-511\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-512\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-513\"><span class=\"mrow\" id=\"MathJax-Span-514\"><span class=\"mi\" id=\"MathJax-Span-515\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-516\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-517\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-518\"><span class=\"mrow\" id=\"MathJax-Span-519\"><span class=\"mi\" id=\"MathJax-Span-520\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-521\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-522\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-523\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>r</mi><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>O</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-96\">r = \\frac{1}{T}\\sum_{i=1}^{N} O_i</script>\n  </li>\n  <li>\n    <p>Persistent drop rates <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-97-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>r</mi><mo>&amp;gt;</mo><mn>1</mn><mi mathvariant=&quot;normal&quot;>&amp;#x0025;</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-524\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1003.49em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-525\"><span class=\"mo\" id=\"MathJax-Span-526\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-527\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-528\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-529\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span><span class=\"mi\" id=\"MathJax-Span-530\" style=\"font-family: STIXGeneral-Regular;\">%</span><span class=\"mo\" id=\"MathJax-Span-531\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><mi>r</mi><mo>&gt;</mo><mn>1</mn><mi mathvariant=\"normal\">%</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-97\">(r > 1\\%)</script> usually indicate an insufficient capacity factor or a weak auxiliary load-balancing loss (see <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a>). Strengthening this auxiliary term can improve routing uniformity and reduce overflow.</p>\n  </li>\n</ul>\n<p><a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> emphasized runtime monitoring of token assignments <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-91-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-465\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-466\"><span class=\"msubsup\" id=\"MathJax-Span-467\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-468\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-469\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-91\">f_i</script> across experts to detect imbalance early. Ideally, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-92-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-470\" style=\"width: 3.128em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.61em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-471\"><span class=\"msubsup\" id=\"MathJax-Span-472\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-473\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-474\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-475\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mfrac\" id=\"MathJax-Span-476\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-477\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-478\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-92\">f_i \\approx \\frac{1}{N}</script> for all experts.</p>\n<p>Overflow per expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-93-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-479\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-480\"><span class=\"msubsup\" id=\"MathJax-Span-481\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-482\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-483\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-93\">O_i</script> can be modeled as:</p>\n<ul>\n      <li>… and global drop rate <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-95-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-501\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-502\"><span class=\"mi\" id=\"MathJax-Span-503\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-95\">r</script> as:</li>\n    </ul>\n<p>Persistent drop rates <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-97-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>r</mi><mo>&amp;gt;</mo><mn>1</mn><mi mathvariant=&quot;normal&quot;>&amp;#x0025;</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-524\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1003.49em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-525\"><span class=\"mo\" id=\"MathJax-Span-526\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-527\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-528\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-529\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span><span class=\"mi\" id=\"MathJax-Span-530\" style=\"font-family: STIXGeneral-Regular;\">%</span><span class=\"mo\" id=\"MathJax-Span-531\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><mi>r</mi><mo>&gt;</mo><mn>1</mn><mi mathvariant=\"normal\">%</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-97\">(r > 1\\%)</script> usually indicate an insufficient capacity factor or a weak auxiliary load-balancing loss (see <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a>). Strengthening this auxiliary term can improve routing uniformity and reduce overflow.</p>\n<h4 id=\"hardware-and-memory-provisioning\">Hardware and Memory Provisioning</h4>\n<ul>\n  <li>Each expert must pre-allocate buffers for <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-98-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-532\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-533\"><span class=\"mi\" id=\"MathJax-Span-534\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-98\">C</script> tokens, even if average routing loads are lower. <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> note that this “worst-case provisioning” ensures determinism and prevents runtime allocation stalls but slightly increases memory overhead.</li>\n  <li>In distributed systems like <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a>, predictable per-expert capacity simplifies <strong>all-to-all communication scheduling</strong> across GPUs or TPUs, reducing synchronization latency and variance in step time.</li>\n</ul>\n<h4 id=\"dynamic-capacity-adjustment\">Dynamic Capacity Adjustment</h4>\n<ul>\n  <li>\n    <p>Adaptive approaches can tune <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-99-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-535\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-536\"><span class=\"mi\" id=\"MathJax-Span-537\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-99\">\\alpha</script> in real time during training or inference:</p>\n\n    <ul>\n      <li><a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference</a> by He et al. (2025) adjusts routing thresholds dynamically to maintain near-constant inference latency.</li>\n      <li><a href=\"https://arxiv.org/abs/2203.12533\">Pathways: Asynchronous Distributed Training of Large Sparse Models</a> by Barham et al. (2022) introduces runtime heuristics to reallocate capacity across experts based on observed workloads—improving utilization and scaling efficiency.</li>\n    </ul>\n  </li>\n</ul>\n<p>Adaptive approaches can tune <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-99-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-535\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-536\"><span class=\"mi\" id=\"MathJax-Span-537\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-99\">\\alpha</script> in real time during training or inference:</p>\n<ul>\n      <li><a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference</a> by He et al. (2025) adjusts routing thresholds dynamically to maintain near-constant inference latency.</li>\n      <li><a href=\"https://arxiv.org/abs/2203.12533\">Pathways: Asynchronous Distributed Training of Large Sparse Models</a> by Barham et al. (2022) introduces runtime heuristics to reallocate capacity across experts based on observed workloads—improving utilization and scaling efficiency.</li>\n    </ul>\n<h4 id=\"balancing-model-scale-and-expert-utilization\">Balancing Model Scale and Expert Utilization</h4>\n<ul>\n  <li>Increasing the number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-100-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-538\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-539\"><span class=\"mi\" id=\"MathJax-Span-540\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-100\">N</script> without proportionally scaling batch size <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-101-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-541\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-542\"><span class=\"mi\" id=\"MathJax-Span-543\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-101\">T</script> reduces average per-expert token count <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-102-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-544\" style=\"width: 1.826em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.46em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-545\"><span class=\"mo\" id=\"MathJax-Span-546\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mfrac\" id=\"MathJax-Span-547\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-548\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-549\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-550\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-102\">(\\frac{T}{N})</script>, leading to sparse or unstable expert training.</li>\n  <li><a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts</a> by Jiang et al. (2025) emphasizes maintaining sufficient token diversity per expert to ensure specialization. Solutions include increasing batch size, reducing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-103-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-551\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-552\"><span class=\"mi\" id=\"MathJax-Span-553\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-103\">N</script>, or enabling expert-sharing mechanisms.</li>\n</ul>\n<h4 id=\"practical-recommendations-summary\">Practical Recommendations Summary</h4>\n<ol>\n  <li><strong>Default tuning:</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-104-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-554\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-555\"><span class=\"mi\" id=\"MathJax-Span-556\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-557\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-558\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-104\">\\alpha = 1.25</script> for top-1 routing, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-105-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-559\" style=\"width: 3.701em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.076em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.08em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-560\"><span class=\"mi\" id=\"MathJax-Span-561\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-562\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-563\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-105\">\\alpha = 1.0</script> for top-2 routing (as proposed in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>).</li>\n  <li><strong>Monitor early:</strong> Track routing histograms and drop rates; increase <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-106-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-564\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-565\"><span class=\"mi\" id=\"MathJax-Span-566\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-106\">\\alpha</script> if overflow exceeds 1%.</li>\n  <li><strong>Balance loss:</strong> Use auxiliary load-balancing loss (as proposed in <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a>) to stabilize routing.</li>\n  <li><strong>Over-provision memory:</strong> Allocate buffers for <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-107-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-567\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-568\"><span class=\"mi\" id=\"MathJax-Span-569\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-107\">C</script> tokens per expert to prevent runtime failures.</li>\n  <li><strong>Dynamic allocation:</strong> Use adaptive capacity adjustment (He et al., 2025) for latency-sensitive inference.</li>\n</ol>",
    "contentMarkdown": "*   Deploying large-scale MoE systems requires careful tuning of the **expert capacity** and **capacity factor** (α)(α)(\\\\alpha) to balance _model quality_, _system efficiency_, and _training stability_. As shown in [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus, Zoph & Shazeer (2021), small misconfigurations in these parameters can cause severe routing imbalance, elevated token drop rates, or underutilized experts—undermining the benefits of sparse activation.\n\n#### Choosing the Capacity Factor\n\n*   Selecting αα\\\\alpha is one of the most critical system-level hyperparameter choices. In [Switch Transformers](https://arxiv.org/abs/2101.03961), capacity factors between **1.0 and 1.25** achieved an optimal trade-off between routing efficiency and drop rate (<1%), maintaining high throughput without saturating hardware.\n*   In contrast, [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022) showed that reducing αα\\\\alpha to 1.0 increased token drop rates and degraded performance, emphasizing that modest overcapacity buffers are essential for robustness.\n    \n*   **Empirical guidelines:**\n    \n    *   Small MoE models (few experts): α\\=1.25–1.5α\\=1.25–1.5\\\\alpha = 1.25–1.5\n    *   Large MoE systems (hundreds of experts): α\\=1.0–1.25α\\=1.0–1.25\\\\alpha = 1.0–1.25\n    *   Highly dynamic or imbalanced routing: adaptive or per-expert αα\\\\alpha (as in [Capacity-Aware Inference](https://arxiv.org/abs/2503.05066) by He et al., 2025)\n\nIn contrast, [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022) showed that reducing αα\\\\alpha to 1.0 increased token drop rates and degraded performance, emphasizing that modest overcapacity buffers are essential for robustness.\n\n**Empirical guidelines:**\n\n*   Small MoE models (few experts): α\\=1.25–1.5α\\=1.25–1.5\\\\alpha = 1.25–1.5\n*   Large MoE systems (hundreds of experts): α\\=1.0–1.25α\\=1.0–1.25\\\\alpha = 1.0–1.25\n*   Highly dynamic or imbalanced routing: adaptive or per-expert αα\\\\alpha (as in [Capacity-Aware Inference](https://arxiv.org/abs/2503.05066) by He et al., 2025)\n\n#### Monitoring Routing Distribution and Drop Rate\n\n*   [GShard](https://arxiv.org/abs/2006.16668) emphasized runtime monitoring of token assignments fifif\\_i across experts to detect imbalance early. Ideally, fi≈1Nfi≈1Nf\\_i \\\\approx \\\\frac{1}{N} for all experts.\n    \n*   Overflow per expert OiOiO\\_i can be modeled as:\n    \n    Oi\\=max(0,Tfi−C)Oi\\=max(0,Tfi−C)\n    \n    O\\_i = \\\\max(0, T f\\_i - C)\n    \n    *   … and global drop rate rrr as:\n    \n    r\\=1T∑i\\=1NOir\\=1T∑i\\=1NOi\n    \n    r = \\\\frac{1}{T}\\\\sum\\_{i=1}^{N} O\\_i\n*   Persistent drop rates (r\\>1%)(r\\>1%)(r > 1\\\\%) usually indicate an insufficient capacity factor or a weak auxiliary load-balancing loss (see [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538)). Strengthening this auxiliary term can improve routing uniformity and reduce overflow.\n    \n\n[GShard](https://arxiv.org/abs/2006.16668) emphasized runtime monitoring of token assignments fifif\\_i across experts to detect imbalance early. Ideally, fi≈1Nfi≈1Nf\\_i \\\\approx \\\\frac{1}{N} for all experts.\n\nOverflow per expert OiOiO\\_i can be modeled as:\n\n*   … and global drop rate rrr as:\n\nPersistent drop rates (r\\>1%)(r\\>1%)(r > 1\\\\%) usually indicate an insufficient capacity factor or a weak auxiliary load-balancing loss (see [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538)). Strengthening this auxiliary term can improve routing uniformity and reduce overflow.\n\n#### Hardware and Memory Provisioning\n\n*   Each expert must pre-allocate buffers for CCC tokens, even if average routing loads are lower. [Switch Transformers](https://arxiv.org/abs/2101.03961) note that this “worst-case provisioning” ensures determinism and prevents runtime allocation stalls but slightly increases memory overhead.\n*   In distributed systems like [GShard](https://arxiv.org/abs/2006.16668), predictable per-expert capacity simplifies **all-to-all communication scheduling** across GPUs or TPUs, reducing synchronization latency and variance in step time.\n\n#### Dynamic Capacity Adjustment\n\n*   Adaptive approaches can tune αα\\\\alpha in real time during training or inference:\n    \n    *   [Capacity-Aware Inference](https://arxiv.org/abs/2503.05066) by He et al. (2025) adjusts routing thresholds dynamically to maintain near-constant inference latency.\n    *   [Pathways: Asynchronous Distributed Training of Large Sparse Models](https://arxiv.org/abs/2203.12533) by Barham et al. (2022) introduces runtime heuristics to reallocate capacity across experts based on observed workloads—improving utilization and scaling efficiency.\n\nAdaptive approaches can tune αα\\\\alpha in real time during training or inference:\n\n*   [Capacity-Aware Inference](https://arxiv.org/abs/2503.05066) by He et al. (2025) adjusts routing thresholds dynamically to maintain near-constant inference latency.\n*   [Pathways: Asynchronous Distributed Training of Large Sparse Models](https://arxiv.org/abs/2203.12533) by Barham et al. (2022) introduces runtime heuristics to reallocate capacity across experts based on observed workloads—improving utilization and scaling efficiency.\n\n#### Balancing Model Scale and Expert Utilization\n\n*   Increasing the number of experts NNN without proportionally scaling batch size TTT reduces average per-expert token count (TN)(TN)(\\\\frac{T}{N}), leading to sparse or unstable expert training.\n*   [A Comprehensive Survey of Mixture-of-Experts](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025) emphasizes maintaining sufficient token diversity per expert to ensure specialization. Solutions include increasing batch size, reducing NNN, or enabling expert-sharing mechanisms.\n\n#### Practical Recommendations Summary\n\n1.  **Default tuning:** α\\=1.25α\\=1.25\\\\alpha = 1.25 for top-1 routing, α\\=1.0α\\=1.0\\\\alpha = 1.0 for top-2 routing (as proposed in [Switch Transformers](https://arxiv.org/abs/2101.03961)).\n2.  **Monitor early:** Track routing histograms and drop rates; increase αα\\\\alpha if overflow exceeds 1%.\n3.  **Balance loss:** Use auxiliary load-balancing loss (as proposed in [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538)) to stabilize routing.\n4.  **Over-provision memory:** Allocate buffers for CCC tokens per expert to prevent runtime failures.\n5.  **Dynamic allocation:** Use adaptive capacity adjustment (He et al., 2025) for latency-sensitive inference.",
    "contentLength": 68015,
    "wordCount": 747,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#practical-considerations-and-tuning-guidelines"
  },
  {
    "id": "ai-mixture-of-experts-overview-14",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Load Balancing",
    "title": "Overview",
    "order": 14,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>Load balancing is a critical issue in MoE models, ensuring that all experts are used evenly. Without proper load balancing, some experts might be over-utilized while others are under-utilized, leading to inefficiencies and degraded model performance. Effective load balancing ensures that the computational resources are fully utilized, which enhances the model’s overall effectiveness and efficiency.</li>\n  <li>\n    <p>In the context of an MoE layer with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-108-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-570\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-571\"><span class=\"mi\" id=\"MathJax-Span-572\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-108\">N</script> experts and a batch of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-109-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-573\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-574\"><span class=\"mi\" id=\"MathJax-Span-575\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-109\">T</script> tokens, one way to view the problem is via two metrics:</p>\n\n    <ol>\n      <li>\n        <p><strong>Token‐assignment fraction</strong>:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-110-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-576\" style=\"width: 13.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.992em, 1010.94em, 3.909em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-577\"><span class=\"msubsup\" id=\"MathJax-Span-578\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-579\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-580\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-581\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-582\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-583\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-584\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-585\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-586\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-587\"><span class=\"mrow\" id=\"MathJax-Span-588\"><span class=\"mi\" id=\"MathJax-Span-589\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-590\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-591\"><span class=\"mrow\" id=\"MathJax-Span-592\"><span class=\"mi\" id=\"MathJax-Span-593\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-594\" style=\"padding-left: 0.211em;\"><span class=\"mrow\" id=\"MathJax-Span-595\"><span class=\"mn\" id=\"MathJax-Span-596\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-597\"><span class=\"mrow\" id=\"MathJax-Span-598\"><span class=\"mo\" id=\"MathJax-Span-599\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-600\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-601\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-602\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-603\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-604\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-605\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-606\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-110\">f_i = \\frac1T \\sum_{x \\in \\mathcal B} \\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-111-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-607\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-608\"><span class=\"texatom\" id=\"MathJax-Span-609\"><span class=\"mrow\" id=\"MathJax-Span-610\"><span class=\"mi\" id=\"MathJax-Span-611\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-111\">\\mathcal B</script> is the token batch and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-112-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi><mi>x</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-612\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.65em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-613\"><span class=\"mi\" id=\"MathJax-Span-614\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mi\" id=\"MathJax-Span-615\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-616\" style=\"font-family: STIXGeneral-Italic;\">p</span><span class=\"mi\" id=\"MathJax-Span-617\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mi\" id=\"MathJax-Span-618\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-619\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-620\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-621\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-622\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi><mi>x</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-112\">expert(x)</script> is the index of expert chosen for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-113-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-623\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-624\"><span class=\"mi\" id=\"MathJax-Span-625\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-113\">x</script>.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Routing‐probability average</strong>:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-114-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-626\" style=\"width: 8.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.721em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1006.67em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-627\"><span class=\"msubsup\" id=\"MathJax-Span-628\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-629\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-630\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-631\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-632\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-633\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-634\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-635\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-636\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-637\"><span class=\"mrow\" id=\"MathJax-Span-638\"><span class=\"mi\" id=\"MathJax-Span-639\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-640\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-641\"><span class=\"mrow\" id=\"MathJax-Span-642\"><span class=\"mi\" id=\"MathJax-Span-643\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-644\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-645\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-646\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-647\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-648\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-649\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-114\">P_i = \\frac1T \\sum_{x \\in \\mathcal B} p_i (x)</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-115-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-650\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-651\"><span class=\"msubsup\" id=\"MathJax-Span-652\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-653\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-654\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-655\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-656\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-657\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-115\">p_i (x)</script> is the gating network’s probability that token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-116-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-658\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-659\"><span class=\"mi\" id=\"MathJax-Span-660\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-116\">x</script> is assigned to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-117-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-661\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-662\"><span class=\"mi\" id=\"MathJax-Span-663\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-117\">i</script>. This formulation is used in the auxiliary load balancing loss in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>.</li>\n        </ul>\n      </li>\n    </ol>\n  </li>\n  <li>Without balancing, a “rich gets richer” effect can happen: a few experts get many tokens, improve fast, get more tokens, while others stay stagnant and under-trained — reducing the benefit of having many experts and hurting specialization and efficiency.</li>\n</ul>\n<p>In the context of an MoE layer with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-108-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-570\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-571\"><span class=\"mi\" id=\"MathJax-Span-572\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-108\">N</script> experts and a batch of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-109-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-573\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-574\"><span class=\"mi\" id=\"MathJax-Span-575\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-109\">T</script> tokens, one way to view the problem is via two metrics:</p>\n<ol>\n      <li>\n        <p><strong>Token‐assignment fraction</strong>:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-110-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-576\" style=\"width: 13.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.992em, 1010.94em, 3.909em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-577\"><span class=\"msubsup\" id=\"MathJax-Span-578\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-579\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-580\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-581\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-582\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-583\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-584\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-585\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-586\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-587\"><span class=\"mrow\" id=\"MathJax-Span-588\"><span class=\"mi\" id=\"MathJax-Span-589\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-590\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-591\"><span class=\"mrow\" id=\"MathJax-Span-592\"><span class=\"mi\" id=\"MathJax-Span-593\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-594\" style=\"padding-left: 0.211em;\"><span class=\"mrow\" id=\"MathJax-Span-595\"><span class=\"mn\" id=\"MathJax-Span-596\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-597\"><span class=\"mrow\" id=\"MathJax-Span-598\"><span class=\"mo\" id=\"MathJax-Span-599\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-600\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-601\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-602\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-603\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-604\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-605\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-606\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-110\">f_i = \\frac1T \\sum_{x \\in \\mathcal B} \\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-111-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-607\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-608\"><span class=\"texatom\" id=\"MathJax-Span-609\"><span class=\"mrow\" id=\"MathJax-Span-610\"><span class=\"mi\" id=\"MathJax-Span-611\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-111\">\\mathcal B</script> is the token batch and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-112-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi><mi>x</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-612\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.65em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-613\"><span class=\"mi\" id=\"MathJax-Span-614\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mi\" id=\"MathJax-Span-615\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-616\" style=\"font-family: STIXGeneral-Italic;\">p</span><span class=\"mi\" id=\"MathJax-Span-617\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mi\" id=\"MathJax-Span-618\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-619\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-620\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-621\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-622\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi><mi>x</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-112\">expert(x)</script> is the index of expert chosen for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-113-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-623\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-624\"><span class=\"mi\" id=\"MathJax-Span-625\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-113\">x</script>.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Routing‐probability average</strong>:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-114-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-626\" style=\"width: 8.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.721em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1006.67em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-627\"><span class=\"msubsup\" id=\"MathJax-Span-628\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-629\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-630\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-631\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-632\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-633\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-634\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-635\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-636\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-637\"><span class=\"mrow\" id=\"MathJax-Span-638\"><span class=\"mi\" id=\"MathJax-Span-639\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-640\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-641\"><span class=\"mrow\" id=\"MathJax-Span-642\"><span class=\"mi\" id=\"MathJax-Span-643\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-644\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-645\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-646\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-647\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-648\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-649\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-114\">P_i = \\frac1T \\sum_{x \\in \\mathcal B} p_i (x)</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-115-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-650\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-651\"><span class=\"msubsup\" id=\"MathJax-Span-652\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-653\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-654\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-655\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-656\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-657\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-115\">p_i (x)</script> is the gating network’s probability that token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-116-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-658\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-659\"><span class=\"mi\" id=\"MathJax-Span-660\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-116\">x</script> is assigned to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-117-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-661\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-662\"><span class=\"mi\" id=\"MathJax-Span-663\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-117\">i</script>. This formulation is used in the auxiliary load balancing loss in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>.</li>\n        </ul>\n      </li>\n    </ol>\n<p><strong>Token‐assignment fraction</strong>:</p>\n<ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-111-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-607\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-608\"><span class=\"texatom\" id=\"MathJax-Span-609\"><span class=\"mrow\" id=\"MathJax-Span-610\"><span class=\"mi\" id=\"MathJax-Span-611\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-111\">\\mathcal B</script> is the token batch and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-112-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi><mi>x</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-612\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.65em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-613\"><span class=\"mi\" id=\"MathJax-Span-614\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mi\" id=\"MathJax-Span-615\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-616\" style=\"font-family: STIXGeneral-Italic;\">p</span><span class=\"mi\" id=\"MathJax-Span-617\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mi\" id=\"MathJax-Span-618\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-619\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-620\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-621\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-622\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi><mi>x</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-112\">expert(x)</script> is the index of expert chosen for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-113-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-623\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-624\"><span class=\"mi\" id=\"MathJax-Span-625\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-113\">x</script>.</li>\n        </ul>\n<p><strong>Routing‐probability average</strong>:</p>\n<ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-115-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-650\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-651\"><span class=\"msubsup\" id=\"MathJax-Span-652\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-653\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-654\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-655\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-656\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-657\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-115\">p_i (x)</script> is the gating network’s probability that token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-116-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-658\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-659\"><span class=\"mi\" id=\"MathJax-Span-660\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-116\">x</script> is assigned to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-117-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-661\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-662\"><span class=\"mi\" id=\"MathJax-Span-663\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-117\">i</script>. This formulation is used in the auxiliary load balancing loss in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a>.</li>\n        </ul>",
    "contentMarkdown": "*   Load balancing is a critical issue in MoE models, ensuring that all experts are used evenly. Without proper load balancing, some experts might be over-utilized while others are under-utilized, leading to inefficiencies and degraded model performance. Effective load balancing ensures that the computational resources are fully utilized, which enhances the model’s overall effectiveness and efficiency.\n*   In the context of an MoE layer with NNN experts and a batch of TTT tokens, one way to view the problem is via two metrics:\n    \n    1.  **Token‐assignment fraction**:\n        \n        fi\\=1T∑x∈1{expert(x)\\=i}fi\\=1T∑x∈B1{expert(x)\\=i}\n        \n        f\\_i = \\\\frac1T \\\\sum\\_{x \\\\in \\\\mathcal B} \\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}}\n        *   where B\\\\mathcal B is the token batch and expert(x)expert(x)expert(x) is the index of expert chosen for token xxx.\n    2.  **Routing‐probability average**:\n        \n        Pi\\=1T∑x∈pi(x)Pi\\=1T∑x∈Bpi(x)\n        \n        P\\_i = \\\\frac1T \\\\sum\\_{x \\\\in \\\\mathcal B} p\\_i (x)\n        *   where pi(x)pi(x)p\\_i (x) is the gating network’s probability that token xxx is assigned to expert iii. This formulation is used in the auxiliary load balancing loss in [Switch Transformers](https://arxiv.org/abs/2101.03961).\n*   Without balancing, a “rich gets richer” effect can happen: a few experts get many tokens, improve fast, get more tokens, while others stay stagnant and under-trained — reducing the benefit of having many experts and hurting specialization and efficiency.\n\nIn the context of an MoE layer with NNN experts and a batch of TTT tokens, one way to view the problem is via two metrics:\n\n1.  **Token‐assignment fraction**:\n    \n    fi\\=1T∑x∈1{expert(x)\\=i}fi\\=1T∑x∈B1{expert(x)\\=i}\n    \n    f\\_i = \\\\frac1T \\\\sum\\_{x \\\\in \\\\mathcal B} \\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}}\n    *   where B\\\\mathcal B is the token batch and expert(x)expert(x)expert(x) is the index of expert chosen for token xxx.\n2.  **Routing‐probability average**:\n    \n    Pi\\=1T∑x∈pi(x)Pi\\=1T∑x∈Bpi(x)\n    \n    P\\_i = \\\\frac1T \\\\sum\\_{x \\\\in \\\\mathcal B} p\\_i (x)\n    *   where pi(x)pi(x)p\\_i (x) is the gating network’s probability that token xxx is assigned to expert iii. This formulation is used in the auxiliary load balancing loss in [Switch Transformers](https://arxiv.org/abs/2101.03961).\n\n**Token‐assignment fraction**:\n\n*   where B\\\\mathcal B is the token batch and expert(x)expert(x)expert(x) is the index of expert chosen for token xxx.\n\n**Routing‐probability average**:\n\n*   where pi(x)pi(x)p\\_i (x) is the gating network’s probability that token xxx is assigned to expert iii. This formulation is used in the auxiliary load balancing loss in [Switch Transformers](https://arxiv.org/abs/2101.03961).",
    "contentLength": 65008,
    "wordCount": 354,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#overview"
  },
  {
    "id": "ai-mixture-of-experts-total-load-on-expert-15",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Load Balancing",
    "title": "Total Load on Expert",
    "order": 15,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>\n    <p>A precise mathematical characterization of the <em>load</em> on each expert was introduced in the <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>. Assume:</p>\n\n    <ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-118-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-664\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-665\"><span class=\"mi\" id=\"MathJax-Span-666\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-118\">T</script> = total number of tokens in the current batch,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-119-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-667\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-668\"><span class=\"msubsup\" id=\"MathJax-Span-669\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-670\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-671\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-672\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-673\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-674\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-119\">p_i (x)</script> = the router’s probability of selecting expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-120-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-675\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-676\"><span class=\"mi\" id=\"MathJax-Span-677\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-120\">i</script> for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-121-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-678\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-679\"><span class=\"mi\" id=\"MathJax-Span-680\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-121\">x</script>,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-122-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-681\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-682\"><span class=\"texatom\" id=\"MathJax-Span-683\"><span class=\"mrow\" id=\"MathJax-Span-684\"><span class=\"mi\" id=\"MathJax-Span-685\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-122\">\\mathcal{B}</script> = the set of tokens in the batch, and</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-123-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-686\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.669em, 1006.51em, 2.867em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-687\"><span class=\"texatom\" id=\"MathJax-Span-688\"><span class=\"mrow\" id=\"MathJax-Span-689\"><span class=\"mn\" id=\"MathJax-Span-690\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-691\"><span class=\"mrow\" id=\"MathJax-Span-692\"><span class=\"mo\" id=\"MathJax-Span-693\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-694\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-695\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-696\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-697\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-698\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-699\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-700\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-123\">\\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script> = indicator function showing whether expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-124-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-701\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-702\"><span class=\"mi\" id=\"MathJax-Span-703\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-124\">i</script> was chosen for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-125-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-704\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-705\"><span class=\"mi\" id=\"MathJax-Span-706\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-125\">x</script>.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Then, the <strong>fraction of tokens</strong> actually routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-126-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-707\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-708\"><span class=\"mi\" id=\"MathJax-Span-709\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-126\">i</script> is:</p>\n  </li>\n</ul>\n<p>A precise mathematical characterization of the <em>load</em> on each expert was introduced in the <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>. Assume:</p>\n<ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-118-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-664\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-665\"><span class=\"mi\" id=\"MathJax-Span-666\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-118\">T</script> = total number of tokens in the current batch,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-119-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-667\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-668\"><span class=\"msubsup\" id=\"MathJax-Span-669\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-670\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-671\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-672\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-673\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-674\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-119\">p_i (x)</script> = the router’s probability of selecting expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-120-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-675\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-676\"><span class=\"mi\" id=\"MathJax-Span-677\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-120\">i</script> for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-121-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-678\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-679\"><span class=\"mi\" id=\"MathJax-Span-680\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-121\">x</script>,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-122-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-681\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-682\"><span class=\"texatom\" id=\"MathJax-Span-683\"><span class=\"mrow\" id=\"MathJax-Span-684\"><span class=\"mi\" id=\"MathJax-Span-685\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-122\">\\mathcal{B}</script> = the set of tokens in the batch, and</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-123-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-686\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.669em, 1006.51em, 2.867em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-687\"><span class=\"texatom\" id=\"MathJax-Span-688\"><span class=\"mrow\" id=\"MathJax-Span-689\"><span class=\"mn\" id=\"MathJax-Span-690\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-691\"><span class=\"mrow\" id=\"MathJax-Span-692\"><span class=\"mo\" id=\"MathJax-Span-693\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-694\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-695\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-696\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-697\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-698\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-699\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-700\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-123\">\\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script> = indicator function showing whether expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-124-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-701\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-702\"><span class=\"mi\" id=\"MathJax-Span-703\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-124\">i</script> was chosen for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-125-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-704\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-705\"><span class=\"mi\" id=\"MathJax-Span-706\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-125\">x</script>.</li>\n    </ul>\n<p>Then, the <strong>fraction of tokens</strong> actually routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-126-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-707\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-708\"><span class=\"mi\" id=\"MathJax-Span-709\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-126\">i</script> is:</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-127-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-710\" style=\"width: 13.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.992em, 1010.94em, 3.909em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-711\"><span class=\"msubsup\" id=\"MathJax-Span-712\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-713\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-714\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-715\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-716\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-717\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-718\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-719\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-720\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-721\"><span class=\"mrow\" id=\"MathJax-Span-722\"><span class=\"mi\" id=\"MathJax-Span-723\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-724\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-725\"><span class=\"mrow\" id=\"MathJax-Span-726\"><span class=\"mi\" id=\"MathJax-Span-727\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-728\" style=\"padding-left: 0.211em;\"><span class=\"mrow\" id=\"MathJax-Span-729\"><span class=\"mn\" id=\"MathJax-Span-730\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-731\"><span class=\"mrow\" id=\"MathJax-Span-732\"><span class=\"mo\" id=\"MathJax-Span-733\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-734\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-735\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-736\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-737\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-738\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-739\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-740\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span></div>\n<ul>\n  <li>and the <strong>average routing probability</strong> of that expert is:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-128-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-741\" style=\"width: 8.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.721em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1006.67em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-742\"><span class=\"msubsup\" id=\"MathJax-Span-743\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-744\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-745\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-746\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-747\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-748\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-749\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-750\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-751\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-752\"><span class=\"mrow\" id=\"MathJax-Span-753\"><span class=\"mi\" id=\"MathJax-Span-754\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-755\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-756\"><span class=\"mrow\" id=\"MathJax-Span-757\"><span class=\"mi\" id=\"MathJax-Span-758\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-759\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-760\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-761\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-762\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-763\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-764\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>The <strong>total load</strong> on expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-129-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-765\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-766\"><span class=\"mi\" id=\"MathJax-Span-767\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-129\">i</script> can then be expressed as:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-130-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mtext>Load</mtext><mi>i</mi></msub><mo>=</mo><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-768\" style=\"width: 6.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.003em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-769\"><span class=\"msubsup\" id=\"MathJax-Span-770\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-771\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-773\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-774\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-775\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-776\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-777\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-778\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-779\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mtext>Load</mtext><mi>i</mi></msub><mo>=</mo><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span></div>\n<ul>\n  <li>Summing across all experts gives the global load metric:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-131-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mtext>Load</mtext><mi>i</mi></msub><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-780\" style=\"width: 9.638em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.023em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1008.02em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-781\"><span class=\"munderover\" id=\"MathJax-Span-782\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-783\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-784\"><span class=\"mrow\" id=\"MathJax-Span-785\"><span class=\"mi\" id=\"MathJax-Span-786\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-787\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-788\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-789\"><span class=\"mrow\" id=\"MathJax-Span-790\"><span class=\"mi\" id=\"MathJax-Span-791\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-792\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-793\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-794\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-795\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-796\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-797\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-798\"><span class=\"mrow\" id=\"MathJax-Span-799\"><span class=\"mi\" id=\"MathJax-Span-800\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-801\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-802\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-803\"><span class=\"mrow\" id=\"MathJax-Span-804\"><span class=\"mi\" id=\"MathJax-Span-805\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-806\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-807\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-808\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-809\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-810\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-811\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mtext>Load</mtext><mi>i</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span></div>\n<ul>\n  <li>\n    <p>This product <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-132-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-812\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.46em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-813\"><span class=\"msubsup\" id=\"MathJax-Span-814\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-815\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-816\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-817\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-818\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-819\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-132\">f_i P_i</script> combines <em>how often</em> an expert is selected <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-133-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-820\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.2em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-821\"><span class=\"mo\" id=\"MathJax-Span-822\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-823\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-824\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-826\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-133\">(f_i)</script> and <em>how confidently</em> it is chosen <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-134-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>P</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi></mrow></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-827\" style=\"width: 1.878em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.565em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.51em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-828\"><span class=\"mo\" id=\"MathJax-Span-829\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-830\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-831\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-832\"><span class=\"mrow\" id=\"MathJax-Span-833\"><span class=\"mi\" id=\"MathJax-Span-834\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-835\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><msub><mi>P</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi></mrow></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-134\">(P_{i})</script>. A model with perfectly balanced routing would satisfy <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-135-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-836\" style=\"width: 5.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.69em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1004.69em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-837\"><span class=\"msubsup\" id=\"MathJax-Span-838\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-839\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-840\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-841\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-842\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-843\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-844\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-845\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-846\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-847\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-848\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-135\">f_i = P_i = \\frac{1}{N}</script>, ensuring uniform load across experts.</p>\n  </li>\n  <li>\n    <p>The <strong>auxiliary load-balancing loss</strong> introduced in <a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. (2021)</a> penalizes deviations from this uniformity:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-136-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>bal</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-849\" style=\"width: 9.326em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.763em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1007.76em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-850\"><span class=\"msubsup\" id=\"MathJax-Span-851\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-852\"><span class=\"mrow\" id=\"MathJax-Span-853\"><span class=\"mi\" id=\"MathJax-Span-854\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-855\"><span class=\"mrow\" id=\"MathJax-Span-856\"><span class=\"mtext\" id=\"MathJax-Span-857\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">bal</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-858\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-859\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">λ</span><span class=\"mo\" id=\"MathJax-Span-860\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-861\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-862\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-863\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-864\"><span class=\"mrow\" id=\"MathJax-Span-865\"><span class=\"mi\" id=\"MathJax-Span-866\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-867\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-868\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-869\"><span class=\"mrow\" id=\"MathJax-Span-870\"><span class=\"mi\" id=\"MathJax-Span-871\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-872\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-873\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-874\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-875\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-876\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-877\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>bal</mtext></mrow></msub><mo>=</mo><mi>λ</mi><mo>,</mo><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-136\">\\mathcal{L}_{\\text{bal}} = \\lambda, N \\sum_{i=1}^{N} f_i P_i</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-137-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-878\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-879\"><span class=\"mi\" id=\"MathJax-Span-880\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-137\">\\lambda</script> is a tunable weight controlling how strongly load balancing influences training.</li>\n    </ul>\n  </li>\n  <li>\n    <p>If all experts are used evenly, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-138-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-881\" style=\"width: 5.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.69em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1004.69em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-882\"><span class=\"msubsup\" id=\"MathJax-Span-883\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-884\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-885\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-886\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-887\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-888\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-889\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-890\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-891\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-892\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-893\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-138\">f_i = P_i = \\frac{1}{N}</script>, giving <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-139-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>bal</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-894\" style=\"width: 4.013em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.28em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-895\"><span class=\"msubsup\" id=\"MathJax-Span-896\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-897\"><span class=\"mrow\" id=\"MathJax-Span-898\"><span class=\"mi\" id=\"MathJax-Span-899\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-900\"><span class=\"mrow\" id=\"MathJax-Span-901\"><span class=\"mtext\" id=\"MathJax-Span-902\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">bal</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-903\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-904\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>bal</mtext></mrow></msub><mo>=</mo><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-139\">\\mathcal{L}_{\\text{bal}} = \\lambda</script>. Conversely, if routing skews toward certain experts, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-140-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><munder><mo>&amp;#x2211;</mo><mi>i</mi></munder><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-905\" style=\"width: 3.44em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.867em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1002.87em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-906\"><span class=\"munderover\" id=\"MathJax-Span-907\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-908\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-909\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-910\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-911\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-912\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-913\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-914\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-915\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-140\">\\sum_i f_i P_i</script> drops below <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-141-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-916\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1000.84em, 2.659em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-917\"><span class=\"mfrac\" id=\"MathJax-Span-918\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-919\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-920\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-141\">\\frac{1}{N}</script>, increasing the penalty.</p>\n  </li>\n  <li>\n    <p>This formulation replaces the earlier coefficient-of-variation-based loss used in <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a>, offering a simpler and more stable gradient signal that scales efficiently to large expert counts.</p>\n  </li>\n  <li>\n    <p>For an intuitive discussion of this loss and its dynamics, see also <a href=\"https://www.reddit.com/r/MachineLearning/comments/1k8gsfe/d_intuition_behind_loadbalancing_loss_in_the/\">Intuition Behind Load Balancing Loss in the Switch Transformer</a> and <a href=\"https://yuxi-liu-wired.github.io/essays/posts/mixture-of-experts/\">Yuxi Liu’s MoE Analysis</a>.</p>\n  </li>\n</ul>\n<p>This product <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-132-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-812\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.46em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-813\"><span class=\"msubsup\" id=\"MathJax-Span-814\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-815\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-816\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-817\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-818\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-819\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-132\">f_i P_i</script> combines <em>how often</em> an expert is selected <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-133-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-820\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.2em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-821\"><span class=\"mo\" id=\"MathJax-Span-822\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-823\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-824\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-826\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-133\">(f_i)</script> and <em>how confidently</em> it is chosen <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-134-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>P</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi></mrow></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-827\" style=\"width: 1.878em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.565em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.51em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-828\"><span class=\"mo\" id=\"MathJax-Span-829\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-830\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-831\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-832\"><span class=\"mrow\" id=\"MathJax-Span-833\"><span class=\"mi\" id=\"MathJax-Span-834\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-835\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><msub><mi>P</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi></mrow></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-134\">(P_{i})</script>. A model with perfectly balanced routing would satisfy <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-135-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-836\" style=\"width: 5.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.69em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1004.69em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-837\"><span class=\"msubsup\" id=\"MathJax-Span-838\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-839\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-840\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-841\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-842\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-843\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-844\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-845\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-846\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-847\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-848\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-135\">f_i = P_i = \\frac{1}{N}</script>, ensuring uniform load across experts.</p>\n<p>The <strong>auxiliary load-balancing loss</strong> introduced in <a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. (2021)</a> penalizes deviations from this uniformity:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-137-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-878\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-879\"><span class=\"mi\" id=\"MathJax-Span-880\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-137\">\\lambda</script> is a tunable weight controlling how strongly load balancing influences training.</li>\n    </ul>\n<p>If all experts are used evenly, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-138-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-881\" style=\"width: 5.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.69em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1004.69em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-882\"><span class=\"msubsup\" id=\"MathJax-Span-883\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-884\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-885\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-886\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-887\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-888\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-889\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-890\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-891\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-892\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-893\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-138\">f_i = P_i = \\frac{1}{N}</script>, giving <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-139-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>bal</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-894\" style=\"width: 4.013em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.28em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-895\"><span class=\"msubsup\" id=\"MathJax-Span-896\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-897\"><span class=\"mrow\" id=\"MathJax-Span-898\"><span class=\"mi\" id=\"MathJax-Span-899\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-900\"><span class=\"mrow\" id=\"MathJax-Span-901\"><span class=\"mtext\" id=\"MathJax-Span-902\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">bal</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-903\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-904\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>bal</mtext></mrow></msub><mo>=</mo><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-139\">\\mathcal{L}_{\\text{bal}} = \\lambda</script>. Conversely, if routing skews toward certain experts, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-140-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><munder><mo>&amp;#x2211;</mo><mi>i</mi></munder><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-905\" style=\"width: 3.44em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.867em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1002.87em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-906\"><span class=\"munderover\" id=\"MathJax-Span-907\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-908\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-909\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-910\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-911\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-912\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-913\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-914\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-915\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-140\">\\sum_i f_i P_i</script> drops below <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-141-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mfrac><mn>1</mn><mi>N</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-916\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1000.84em, 2.659em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-917\"><span class=\"mfrac\" id=\"MathJax-Span-918\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-919\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-920\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mfrac><mn>1</mn><mi>N</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-141\">\\frac{1}{N}</script>, increasing the penalty.</p>\n<p>This formulation replaces the earlier coefficient-of-variation-based loss used in <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a>, offering a simpler and more stable gradient signal that scales efficiently to large expert counts.</p>\n<p>For an intuitive discussion of this loss and its dynamics, see also <a href=\"https://www.reddit.com/r/MachineLearning/comments/1k8gsfe/d_intuition_behind_loadbalancing_loss_in_the/\">Intuition Behind Load Balancing Loss in the Switch Transformer</a> and <a href=\"https://yuxi-liu-wired.github.io/essays/posts/mixture-of-experts/\">Yuxi Liu’s MoE Analysis</a>.</p>",
    "contentMarkdown": "*   A precise mathematical characterization of the _load_ on each expert was introduced in the [Switch Transformer](https://arxiv.org/abs/2101.03961). Assume:\n    \n    *   TTT = total number of tokens in the current batch,\n    *   pi(x)pi(x)p\\_i (x) = the router’s probability of selecting expert iii for token xxx,\n    *   B\\\\mathcal{B} = the set of tokens in the batch, and\n    *   1{expert(x)\\=i}1{expert(x)\\=i}\\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}} = indicator function showing whether expert iii was chosen for token xxx.\n*   Then, the **fraction of tokens** actually routed to expert iii is:\n    \n\nA precise mathematical characterization of the _load_ on each expert was introduced in the [Switch Transformer](https://arxiv.org/abs/2101.03961). Assume:\n\n*   TTT = total number of tokens in the current batch,\n*   pi(x)pi(x)p\\_i (x) = the router’s probability of selecting expert iii for token xxx,\n*   B\\\\mathcal{B} = the set of tokens in the batch, and\n*   1{expert(x)\\=i}1{expert(x)\\=i}\\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}} = indicator function showing whether expert iii was chosen for token xxx.\n\nThen, the **fraction of tokens** actually routed to expert iii is:\n\nfi\\=1T∑x∈1{expert(x)\\=i}fi\\=1T∑x∈B1{expert(x)\\=i}\n\n*   and the **average routing probability** of that expert is:\n\nPi\\=1T∑x∈pi(x)Pi\\=1T∑x∈Bpi(x)\n\n*   The **total load** on expert iii can then be expressed as:\n\nLoadi\\=fiPiLoadi\\=fiPi\n\n*   Summing across all experts gives the global load metric:\n\n∑i\\=1NLoadi\\=∑i\\=1NfiPi∑i\\=1NLoadi\\=∑i\\=1NfiPi\n\n*   This product fiPifiPif\\_i P\\_i combines _how often_ an expert is selected (fi)(fi)(f\\_i) and _how confidently_ it is chosen (Pi)(Pi)(P\\_{i}). A model with perfectly balanced routing would satisfy fi\\=Pi\\=1Nfi\\=Pi\\=1Nf\\_i = P\\_i = \\\\frac{1}{N}, ensuring uniform load across experts.\n    \n*   The **auxiliary load-balancing loss** introduced in [Fedus et al. (2021)](https://arxiv.org/abs/2101.03961) penalizes deviations from this uniformity:\n    \n    bal\\=λ,N∑i\\=1NfiPiLbal\\=λ,N∑i\\=1NfiPi\n    \n    \\\\mathcal{L}\\_{\\\\text{bal}} = \\\\lambda, N \\\\sum\\_{i=1}^{N} f\\_i P\\_i\n    *   where λλ\\\\lambda is a tunable weight controlling how strongly load balancing influences training.\n*   If all experts are used evenly, fi\\=Pi\\=1Nfi\\=Pi\\=1Nf\\_i = P\\_i = \\\\frac{1}{N}, giving bal\\=λLbal\\=λ\\\\mathcal{L}\\_{\\\\text{bal}} = \\\\lambda. Conversely, if routing skews toward certain experts, ∑ifiPi∑ifiPi\\\\sum\\_i f\\_i P\\_i drops below 1N1N\\\\frac{1}{N}, increasing the penalty.\n    \n*   This formulation replaces the earlier coefficient-of-variation-based loss used in [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538), offering a simpler and more stable gradient signal that scales efficiently to large expert counts.\n    \n*   For an intuitive discussion of this loss and its dynamics, see also [Intuition Behind Load Balancing Loss in the Switch Transformer](https://www.reddit.com/r/MachineLearning/comments/1k8gsfe/d_intuition_behind_loadbalancing_loss_in_the/) and [Yuxi Liu’s MoE Analysis](https://yuxi-liu-wired.github.io/essays/posts/mixture-of-experts/).\n    \n\nThis product fiPifiPif\\_i P\\_i combines _how often_ an expert is selected (fi)(fi)(f\\_i) and _how confidently_ it is chosen (Pi)(Pi)(P\\_{i}). A model with perfectly balanced routing would satisfy fi\\=Pi\\=1Nfi\\=Pi\\=1Nf\\_i = P\\_i = \\\\frac{1}{N}, ensuring uniform load across experts.\n\nThe **auxiliary load-balancing loss** introduced in [Fedus et al. (2021)](https://arxiv.org/abs/2101.03961) penalizes deviations from this uniformity:\n\n*   where λλ\\\\lambda is a tunable weight controlling how strongly load balancing influences training.\n\nIf all experts are used evenly, fi\\=Pi\\=1Nfi\\=Pi\\=1Nf\\_i = P\\_i = \\\\frac{1}{N}, giving bal\\=λLbal\\=λ\\\\mathcal{L}\\_{\\\\text{bal}} = \\\\lambda. Conversely, if routing skews toward certain experts, ∑ifiPi∑ifiPi\\\\sum\\_i f\\_i P\\_i drops below 1N1N\\\\frac{1}{N}, increasing the penalty.\n\nThis formulation replaces the earlier coefficient-of-variation-based loss used in [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538), offering a simpler and more stable gradient signal that scales efficiently to large expert counts.\n\nFor an intuitive discussion of this loss and its dynamics, see also [Intuition Behind Load Balancing Loss in the Switch Transformer](https://www.reddit.com/r/MachineLearning/comments/1k8gsfe/d_intuition_behind_loadbalancing_loss_in_the/) and [Yuxi Liu’s MoE Analysis](https://yuxi-liu-wired.github.io/essays/posts/mixture-of-experts/).",
    "contentLength": 115388,
    "wordCount": 513,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#total-load-on-expert"
  },
  {
    "id": "ai-mixture-of-experts-loss-function-component-16",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Load Balancing",
    "title": "Loss Function Component",
    "order": 16,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>To promote balanced expert usage, the total training loss typically includes a <strong>load-balancing auxiliary term</strong>:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-142-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mo>=</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>task</mtext></mrow></msub><mo>+</mo><mi>&amp;#x03BB;</mi><mo>,</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>load_balancing</mtext></mrow></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-921\" style=\"width: 13.232em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1010.99em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-922\"><span class=\"texatom\" id=\"MathJax-Span-923\"><span class=\"mrow\" id=\"MathJax-Span-924\"><span class=\"mi\" id=\"MathJax-Span-925\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span class=\"mo\" id=\"MathJax-Span-926\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-927\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-928\"><span class=\"mrow\" id=\"MathJax-Span-929\"><span class=\"mi\" id=\"MathJax-Span-930\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-931\"><span class=\"mrow\" id=\"MathJax-Span-932\"><span class=\"mtext\" id=\"MathJax-Span-933\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">task</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-934\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-935\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">λ</span><span class=\"mo\" id=\"MathJax-Span-936\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-937\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-938\"><span class=\"mrow\" id=\"MathJax-Span-939\"><span class=\"mi\" id=\"MathJax-Span-940\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-941\"><span class=\"mrow\" id=\"MathJax-Span-942\"><span class=\"mtext\" id=\"MathJax-Span-943\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">load_balancing</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mo>=</mo><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>task</mtext></mrow></msub><mo>+</mo><mi>λ</mi><mo>,</mo><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>load_balancing</mtext></mrow></msub></math></span></span></div>\n<ul>\n  <li>\n    <p>where:</p>\n\n    <ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-143-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>task</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-944\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.93em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-945\"><span class=\"msubsup\" id=\"MathJax-Span-946\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-947\"><span class=\"mrow\" id=\"MathJax-Span-948\"><span class=\"mi\" id=\"MathJax-Span-949\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-950\"><span class=\"mrow\" id=\"MathJax-Span-951\"><span class=\"mtext\" id=\"MathJax-Span-952\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">task</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>task</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-143\">\\mathcal{L}_{\\text{task}}</script>: main task-specific loss (e.g., cross-entropy for classification),</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-144-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>load_balancing</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-953\" style=\"width: 6.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1005.11em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-954\"><span class=\"msubsup\" id=\"MathJax-Span-955\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-956\"><span class=\"mrow\" id=\"MathJax-Span-957\"><span class=\"mi\" id=\"MathJax-Span-958\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-959\"><span class=\"mrow\" id=\"MathJax-Span-960\"><span class=\"mtext\" id=\"MathJax-Span-961\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">load_balancing</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>load_balancing</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-144\">\\mathcal{L}_{\\text{load_balancing}}</script>: penalty encouraging uniform expert utilization,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-145-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-962\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-963\"><span class=\"mi\" id=\"MathJax-Span-964\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-145\">\\lambda</script>: hyperparameter controlling the strength of this regularization.</li>\n    </ul>\n  </li>\n  <li>\n    <p>One early formulation uses entropy of expert selection probabilities (<a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al., 2017</a>):</p>\n  </li>\n</ul>\n<p>where:</p>\n<ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-143-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>task</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-944\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.93em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-945\"><span class=\"msubsup\" id=\"MathJax-Span-946\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-947\"><span class=\"mrow\" id=\"MathJax-Span-948\"><span class=\"mi\" id=\"MathJax-Span-949\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-950\"><span class=\"mrow\" id=\"MathJax-Span-951\"><span class=\"mtext\" id=\"MathJax-Span-952\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">task</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>task</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-143\">\\mathcal{L}_{\\text{task}}</script>: main task-specific loss (e.g., cross-entropy for classification),</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-144-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>load_balancing</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-953\" style=\"width: 6.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1005.11em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-954\"><span class=\"msubsup\" id=\"MathJax-Span-955\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-956\"><span class=\"mrow\" id=\"MathJax-Span-957\"><span class=\"mi\" id=\"MathJax-Span-958\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-959\"><span class=\"mrow\" id=\"MathJax-Span-960\"><span class=\"mtext\" id=\"MathJax-Span-961\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">load_balancing</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>load_balancing</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-144\">\\mathcal{L}_{\\text{load_balancing}}</script>: penalty encouraging uniform expert utilization,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-145-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-962\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-963\"><span class=\"mi\" id=\"MathJax-Span-964\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-145\">\\lambda</script>: hyperparameter controlling the strength of this regularization.</li>\n    </ul>\n<p>One early formulation uses entropy of expert selection probabilities (<a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al., 2017</a>):</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-146-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>load_balancing</mtext></mrow></msub><mo>=</mo><mo>&amp;#x2212;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>p</mi><mi>i</mi></msub><mi>log</mi><mo>&amp;#x2061;</mo><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-965\" style=\"width: 14.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.878em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1011.88em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-966\"><span class=\"msubsup\" id=\"MathJax-Span-967\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-968\"><span class=\"mrow\" id=\"MathJax-Span-969\"><span class=\"mi\" id=\"MathJax-Span-970\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-971\"><span class=\"mrow\" id=\"MathJax-Span-972\"><span class=\"mtext\" id=\"MathJax-Span-973\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">load_balancing</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-974\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-975\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">−</span><span class=\"munderover\" id=\"MathJax-Span-976\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-977\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-978\"><span class=\"mrow\" id=\"MathJax-Span-979\"><span class=\"mi\" id=\"MathJax-Span-980\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-981\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-982\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-983\"><span class=\"mrow\" id=\"MathJax-Span-984\"><span class=\"mi\" id=\"MathJax-Span-985\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-986\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-987\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-988\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-989\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">log</span><span class=\"mo\" id=\"MathJax-Span-990\"></span><span class=\"msubsup\" id=\"MathJax-Span-991\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-992\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-993\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>load_balancing</mtext></mrow></msub><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>p</mi><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><msub><mi>p</mi><mi>i</mi></msub></math></span></span></div>\n<ul>\n  <li>\n    <p>… encouraging uniformity across expert selection probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-147-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-994\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-995\"><span class=\"msubsup\" id=\"MathJax-Span-996\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-997\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-998\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-147\">p_i</script>.</p>\n  </li>\n  <li>\n    <p>However, later work introduced a <strong>probabilistic load-based formulation</strong>, now standard in modern MoE architectures (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al., 2021</a>):</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-148-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>load_balancing</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03B1;</mi><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-999\" style=\"width: 13.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1010.89em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1000\"><span class=\"msubsup\" id=\"MathJax-Span-1001\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1002\"><span class=\"mrow\" id=\"MathJax-Span-1003\"><span class=\"mi\" id=\"MathJax-Span-1004\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-1005\"><span class=\"mrow\" id=\"MathJax-Span-1006\"><span class=\"mtext\" id=\"MathJax-Span-1007\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">load_balancing</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1008\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-1009\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mi\" id=\"MathJax-Span-1010\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-1011\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1012\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-1013\"><span class=\"mrow\" id=\"MathJax-Span-1014\"><span class=\"mi\" id=\"MathJax-Span-1015\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1016\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1017\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-1018\"><span class=\"mrow\" id=\"MathJax-Span-1019\"><span class=\"mi\" id=\"MathJax-Span-1020\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1021\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1022\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1023\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1024\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1025\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1026\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>load_balancing</mtext></mrow></msub><mo>=</mo><mi>α</mi><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-148\">\\mathcal{L}_{\\text{load_balancing}} = \\alpha N \\sum_{i=1}^{N} f_i P_i</script>\n\n    <ul>\n      <li>Here, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-149-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1027\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1028\"><span class=\"mi\" id=\"MathJax-Span-1029\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-149\">\\alpha</script> scales the auxiliary penalty, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-150-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1030\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1031\"><span class=\"msubsup\" id=\"MathJax-Span-1032\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1033\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1034\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-150\">f_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-151-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1035\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1036\"><span class=\"msubsup\" id=\"MathJax-Span-1037\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1038\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1039\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-151\">P_i</script> are defined as above, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-152-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1040\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1041\"><span class=\"mi\" id=\"MathJax-Span-1042\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-152\">N</script> normalizes by the number of experts.</li>\n    </ul>\n  </li>\n  <li>\n    <p>When all experts are perfectly balanced <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-153-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1043\" style=\"width: 6.461em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.367em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1005.32em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1044\"><span class=\"mo\" id=\"MathJax-Span-1045\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1046\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1047\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1048\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1049\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1050\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1051\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1052\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1053\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1054\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-1055\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-1056\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1057\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-153\">(f_i = P_i = \\frac{1}{N})</script>, we obtain:</p>\n  </li>\n</ul>\n<p>… encouraging uniformity across expert selection probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-147-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-994\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-995\"><span class=\"msubsup\" id=\"MathJax-Span-996\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-997\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-998\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-147\">p_i</script>.</p>\n<p>However, later work introduced a <strong>probabilistic load-based formulation</strong>, now standard in modern MoE architectures (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al., 2021</a>):</p>\n<ul>\n      <li>Here, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-149-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1027\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1028\"><span class=\"mi\" id=\"MathJax-Span-1029\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-149\">\\alpha</script> scales the auxiliary penalty, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-150-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1030\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1031\"><span class=\"msubsup\" id=\"MathJax-Span-1032\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1033\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1034\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-150\">f_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-151-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1035\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1036\"><span class=\"msubsup\" id=\"MathJax-Span-1037\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1038\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1039\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-151\">P_i</script> are defined as above, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-152-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1040\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1041\"><span class=\"mi\" id=\"MathJax-Span-1042\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-152\">N</script> normalizes by the number of experts.</li>\n    </ul>\n<p>When all experts are perfectly balanced <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-153-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1043\" style=\"width: 6.461em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.367em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1005.32em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1044\"><span class=\"mo\" id=\"MathJax-Span-1045\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1046\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1047\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1048\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1049\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1050\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1051\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1052\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1053\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1054\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-1055\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-1056\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1057\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-153\">(f_i = P_i = \\frac{1}{N})</script>, we obtain:</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-154-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo>,</mo><mspace width=&quot;1em&quot; /><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>load_balancing</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03B1;</mi><mo>.</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1058\" style=\"width: 16.826em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 14.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1013.96em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1059\"><span class=\"munderover\" id=\"MathJax-Span-1060\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1061\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-1062\"><span class=\"mrow\" id=\"MathJax-Span-1063\"><span class=\"mi\" id=\"MathJax-Span-1064\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1065\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1066\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-1067\"><span class=\"mrow\" id=\"MathJax-Span-1068\"><span class=\"mi\" id=\"MathJax-Span-1069\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1070\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1071\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1072\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1073\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1074\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1075\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1076\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1077\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-1078\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1079\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1080\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mspace\" id=\"MathJax-Span-1081\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"msubsup\" id=\"MathJax-Span-1082\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1083\"><span class=\"mrow\" id=\"MathJax-Span-1084\"><span class=\"mi\" id=\"MathJax-Span-1085\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-1086\"><span class=\"mrow\" id=\"MathJax-Span-1087\"><span class=\"mtext\" id=\"MathJax-Span-1088\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">load_balancing</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1089\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-1090\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mo\" id=\"MathJax-Span-1091\" style=\"font-family: STIXGeneral-Regular;\">.</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mo>,</mo><mspace width=\"1em\"></mspace><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>load_balancing</mtext></mrow></msub><mo>=</mo><mi>α</mi><mo>.</mo></math></span></span></div>\n<ul>\n  <li>This constant lower bound provides a convenient diagnostic for imbalance during training, as noted in <a href=\"https://medium.com/@ikim1994914/advanced-modern-llm-part-5-mixture-of-experts-moe-and-switch-transformer-b3d1ce40ced2\">Advanced Modern LLM Part 5: Mixture of Experts(MoE) and Switch Transformer</a> by Kim (2023).</li>\n</ul>",
    "contentMarkdown": "*   To promote balanced expert usage, the total training loss typically includes a **load-balancing auxiliary term**:\n\n\\=task+λ,load\\_balancingL\\=Ltask+λ,Lload\\_balancing\n\n*   where:\n    \n    *   taskLtask\\\\mathcal{L}\\_{\\\\text{task}}: main task-specific loss (e.g., cross-entropy for classification),\n    *   load\\_balancingLload\\_balancing\\\\mathcal{L}\\_{\\\\text{load\\_balancing}}: penalty encouraging uniform expert utilization,\n    *   λλ\\\\lambda: hyperparameter controlling the strength of this regularization.\n*   One early formulation uses entropy of expert selection probabilities ([Shazeer et al., 2017](https://arxiv.org/abs/1701.06538)):\n    \n\nwhere:\n\n*   taskLtask\\\\mathcal{L}\\_{\\\\text{task}}: main task-specific loss (e.g., cross-entropy for classification),\n*   load\\_balancingLload\\_balancing\\\\mathcal{L}\\_{\\\\text{load\\_balancing}}: penalty encouraging uniform expert utilization,\n*   λλ\\\\lambda: hyperparameter controlling the strength of this regularization.\n\nOne early formulation uses entropy of expert selection probabilities ([Shazeer et al., 2017](https://arxiv.org/abs/1701.06538)):\n\nload\\_balancing\\=−∑i\\=1NpilogpiLload\\_balancing\\=−∑i\\=1Npilog⁡pi\n\n*   … encouraging uniformity across expert selection probabilities pipip\\_i.\n    \n*   However, later work introduced a **probabilistic load-based formulation**, now standard in modern MoE architectures ([Fedus et al., 2021](https://arxiv.org/abs/2101.03961)):\n    \n    load\\_balancing\\=αN∑i\\=1NfiPiLload\\_balancing\\=αN∑i\\=1NfiPi\n    \n    \\\\mathcal{L}\\_{\\\\text{load\\_balancing}} = \\\\alpha N \\\\sum\\_{i=1}^{N} f\\_i P\\_i\n    *   Here, αα\\\\alpha scales the auxiliary penalty, fifif\\_i and PiPiP\\_i are defined as above, and NNN normalizes by the number of experts.\n*   When all experts are perfectly balanced (fi\\=Pi\\=1N)(fi\\=Pi\\=1N)(f\\_i = P\\_i = \\\\frac{1}{N}), we obtain:\n    \n\n… encouraging uniformity across expert selection probabilities pipip\\_i.\n\nHowever, later work introduced a **probabilistic load-based formulation**, now standard in modern MoE architectures ([Fedus et al., 2021](https://arxiv.org/abs/2101.03961)):\n\n*   Here, αα\\\\alpha scales the auxiliary penalty, fifif\\_i and PiPiP\\_i are defined as above, and NNN normalizes by the number of experts.\n\nWhen all experts are perfectly balanced (fi\\=Pi\\=1N)(fi\\=Pi\\=1N)(f\\_i = P\\_i = \\\\frac{1}{N}), we obtain:\n\n∑i\\=1NfiPi\\=1N,load\\_balancing\\=α.∑i\\=1NfiPi\\=1N,Lload\\_balancing\\=α.\n\n*   This constant lower bound provides a convenient diagnostic for imbalance during training, as noted in [Advanced Modern LLM Part 5: Mixture of Experts(MoE) and Switch Transformer](https://medium.com/@ikim1994914/advanced-modern-llm-part-5-mixture-of-experts-moe-and-switch-transformer-b3d1ce40ced2) by Kim (2023).",
    "contentLength": 65194,
    "wordCount": 262,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#loss-function-component"
  },
  {
    "id": "ai-mixture-of-experts-potential-solutions-for-load-balancing-17",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Load Balancing",
    "title": "Potential Solutions for Load Balancing",
    "order": 17,
    "orderInChapter": 4,
    "contentHtml": "<ol>\n  <li>\n    <p><strong>Regularization Terms in Loss Function</strong></p>\n\n    <ul>\n      <li>Add explicit penalties for uneven expert utilization, such as entropy-based or <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-155-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1092\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.46em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1093\"><span class=\"msubsup\" id=\"MathJax-Span-1094\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1095\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1096\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1097\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1098\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1099\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-155\">f_i P_i</script>-based losses.</li>\n      <li>Early work by <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a> used the <em>coefficient of variation</em> of expert importance to penalize skewed loads:</li>\n    </ul>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-156-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;normal&quot;>C</mi><mi mathvariant=&quot;normal&quot;>V</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mtext>Importance</mtext><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mfrac><msqrt><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;normal&quot;>V</mi><mi mathvariant=&quot;normal&quot;>a</mi><mi mathvariant=&quot;normal&quot;>r</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mtext>Importance</mtext><mo stretchy=&quot;false&quot;>)</mo></msqrt><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>[</mo><mtext>Importance</mtext><mo stretchy=&quot;false&quot;>]</mo></mrow></mfrac><mo>,</mo><mspace width=&quot;1em&quot; /><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>CV</mtext></mrow></msub><mo>=</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;normal&quot;>C</mi><mi mathvariant=&quot;normal&quot;>V</mi></mrow><mn>2</mn></msup></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1100\" style=\"width: 26.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 22.242em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.315em, 1022.24em, 3.232em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1101\"><span class=\"texatom\" id=\"MathJax-Span-1102\"><span class=\"mrow\" id=\"MathJax-Span-1103\"><span class=\"mi\" id=\"MathJax-Span-1104\" style=\"font-family: STIXGeneral-Regular;\">C</span><span class=\"mi\" id=\"MathJax-Span-1105\" style=\"font-family: STIXGeneral-Regular;\">V</span></span></span><span class=\"mo\" id=\"MathJax-Span-1106\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mtext\" id=\"MathJax-Span-1107\" style=\"font-family: STIXGeneral-Regular;\">Importance</span><span class=\"mo\" id=\"MathJax-Span-1108\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1109\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1110\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 7.815em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.023em, 1007.66em, 4.534em, -999.997em); top: -4.841em; left: 50%; margin-left: -3.852em;\"><span class=\"msqrt\" id=\"MathJax-Span-1111\"><span style=\"display: inline-block; position: relative; width: 7.659em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1006.67em, 4.378em, -999.997em); top: -4.008em; left: 0.94em;\"><span class=\"mrow\" id=\"MathJax-Span-1112\"><span class=\"texatom\" id=\"MathJax-Span-1113\"><span class=\"mrow\" id=\"MathJax-Span-1114\"><span class=\"mi\" id=\"MathJax-Span-1115\" style=\"font-family: STIXGeneral-Regular;\">V</span><span class=\"mi\" id=\"MathJax-Span-1116\" style=\"font-family: STIXGeneral-Regular;\">a</span><span class=\"mi\" id=\"MathJax-Span-1117\" style=\"font-family: STIXGeneral-Regular;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1118\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mtext\" id=\"MathJax-Span-1119\" style=\"font-family: STIXGeneral-Regular;\">Importance</span><span class=\"mo\" id=\"MathJax-Span-1120\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.023em, 1006.77em, 3.388em, -999.997em); top: -4.008em; left: 0.94em;\"><span style=\"display: inline-block; position: relative; width: 6.773em; height: 0px;\"><span style=\"position: absolute; font-family: STIXGeneral-Regular; top: -4.008em; left: 0em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; font-family: STIXGeneral-Regular; top: -4.008em; left: 6.253em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 0.419em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 0.888em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 1.305em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 1.773em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 2.242em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 2.659em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 3.128em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 3.544em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 4.013em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 4.482em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 4.898em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 5.367em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"font-family: STIXGeneral-Regular; position: absolute; top: -4.008em; left: 5.784em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(2.867em, 1000.94em, 4.43em, -999.997em); top: -3.904em; left: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">√</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1005.73em, 4.378em, -999.997em); top: -3.331em; left: 50%; margin-left: -2.914em;\"><span class=\"mrow\" id=\"MathJax-Span-1121\"><span class=\"texatom\" id=\"MathJax-Span-1122\"><span class=\"mrow\" id=\"MathJax-Span-1123\"><span class=\"mi\" id=\"MathJax-Span-1124\" style=\"font-family: STIXGeneral-Regular;\">𝔼</span></span></span><span class=\"mo\" id=\"MathJax-Span-1125\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mtext\" id=\"MathJax-Span-1126\" style=\"font-family: STIXGeneral-Regular;\">Importance</span><span class=\"mo\" id=\"MathJax-Span-1127\" style=\"font-family: STIXGeneral-Regular;\">]</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1007.82em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 7.815em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1128\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mspace\" id=\"MathJax-Span-1129\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"msubsup\" id=\"MathJax-Span-1130\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.773em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1131\"><span class=\"mrow\" id=\"MathJax-Span-1132\"><span class=\"mi\" id=\"MathJax-Span-1133\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-1134\"><span class=\"mrow\" id=\"MathJax-Span-1135\"><span class=\"mtext\" id=\"MathJax-Span-1136\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">CV</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1137\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1138\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.826em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.36em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1139\"><span class=\"mrow\" id=\"MathJax-Span-1140\"><span class=\"mi\" id=\"MathJax-Span-1141\" style=\"font-family: STIXGeneral-Regular;\">C</span><span class=\"mi\" id=\"MathJax-Span-1142\" style=\"font-family: STIXGeneral-Regular;\">V</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.424em; left: 1.409em;\"><span class=\"mn\" id=\"MathJax-Span-1143\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.122em; border-left: 0px solid; width: 0px; height: 3.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"normal\">C</mi><mi mathvariant=\"normal\">V</mi></mrow><mo stretchy=\"false\">(</mo><mtext>Importance</mtext><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><msqrt><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"normal\">V</mi><mi mathvariant=\"normal\">a</mi><mi mathvariant=\"normal\">r</mi></mrow><mo stretchy=\"false\">(</mo><mtext>Importance</mtext><mo stretchy=\"false\">)</mo></msqrt><mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">E</mi></mrow><mo stretchy=\"false\">[</mo><mtext>Importance</mtext><mo stretchy=\"false\">]</mo></mrow></mfrac><mo>,</mo><mspace width=\"1em\"></mspace><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>CV</mtext></mrow></msub><mo>=</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"normal\">C</mi><mi mathvariant=\"normal\">V</mi></mrow><mn>2</mn></msup></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-156\">\\mathrm{CV}(\\text{Importance}) = \\frac{\\sqrt{\\mathrm{Var}(\\text{Importance})}}{\\mathbb{E}[\\text{Importance}]},\n\\quad\n\\mathcal{L}_{\\text{CV}} = \\mathrm{CV}^2</script>\n\n    <ul>\n      <li>This idea evolved into the simpler Switch Transformer formulation where the balancing loss is linear in <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-157-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1144\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.46em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1145\"><span class=\"msubsup\" id=\"MathJax-Span-1146\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1147\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1148\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1149\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1150\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1151\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-157\">f_i P_i</script>.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Gating Networks and Routing Strategies</strong></p>\n\n    <ul>\n      <li>Employ top-k gating with added Gaussian noise to encourage exploration, as introduced in <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a>.</li>\n      <li>In later models, <em>top-1 routing</em> (as in Switch Transformer) improved efficiency but required stronger balancing loss to prevent expert collapse (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n      <li>Adaptive gating mechanisms can further adjust routing probabilities based on historical load statistics (<a href=\"https://arxiv.org/abs/2104.14632\">Lewis et al., 2021</a>).</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Expert Capacity Constraints</strong></p>\n\n    <ul>\n      <li>\n        <p>As discussed in the <strong>Expert Capacity</strong> section, Switch Transformer defines per-expert capacity as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-158-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1152\" style=\"width: 5.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.846em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1004.79em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1153\"><span class=\"mi\" id=\"MathJax-Span-1154\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1155\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1156\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1157\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1158\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1159\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-1160\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span><span class=\"mo\" id=\"MathJax-Span-1161\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi><mo>,</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-158\">C = \\frac{T}{N} \\times \\alpha,</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-159-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1162\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1163\"><span class=\"mi\" id=\"MathJax-Span-1164\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-159\">T</script> is the number of tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-160-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1165\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1166\"><span class=\"mi\" id=\"MathJax-Span-1167\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-160\">\\alpha</script> is the capacity factor (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n        </ul>\n      </li>\n      <li>Tokens exceeding capacity are dropped or rerouted, ensuring no single expert dominates.</li>\n      <li>Proper tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-161-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1168\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1169\"><span class=\"mi\" id=\"MathJax-Span-1170\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-161\">\\alpha</script> (typically between 1.0 and 1.25) minimizes token drops while maintaining computational efficiency.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>MegaBlocks Approach</strong></p>\n\n    <ul>\n      <li>The <strong>MegaBlocks</strong> framework introduced by <a href=\"https://arxiv.org/abs/2211.15841\">Gholami et al. (2022)</a> improves load balancing by using <em>block-wise parallelism</em> and <em>structured sparsity</em>.</li>\n      <li>It divides the model into independent blocks that can be executed in parallel, using sparse activation to ensure that only a subset of experts or blocks activates for each input.</li>\n      <li>Real-time algorithms dynamically redistribute workloads to prevent bottlenecks, and capacity can be adjusted adaptively.</li>\n    </ul>\n  </li>\n</ol>\n<p><strong>Regularization Terms in Loss Function</strong></p>\n<ul>\n      <li>Add explicit penalties for uneven expert utilization, such as entropy-based or <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-155-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1092\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.46em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1093\"><span class=\"msubsup\" id=\"MathJax-Span-1094\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1095\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1096\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1097\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1098\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1099\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-155\">f_i P_i</script>-based losses.</li>\n      <li>Early work by <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a> used the <em>coefficient of variation</em> of expert importance to penalize skewed loads:</li>\n    </ul>\n<ul>\n      <li>This idea evolved into the simpler Switch Transformer formulation where the balancing loss is linear in <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-157-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1144\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.46em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1145\"><span class=\"msubsup\" id=\"MathJax-Span-1146\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1147\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1148\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1149\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1150\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1151\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-157\">f_i P_i</script>.</li>\n    </ul>\n<p><strong>Gating Networks and Routing Strategies</strong></p>\n<ul>\n      <li>Employ top-k gating with added Gaussian noise to encourage exploration, as introduced in <a href=\"https://arxiv.org/abs/1701.06538\">Shazeer et al. (2017)</a>.</li>\n      <li>In later models, <em>top-1 routing</em> (as in Switch Transformer) improved efficiency but required stronger balancing loss to prevent expert collapse (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n      <li>Adaptive gating mechanisms can further adjust routing probabilities based on historical load statistics (<a href=\"https://arxiv.org/abs/2104.14632\">Lewis et al., 2021</a>).</li>\n    </ul>\n<p><strong>Expert Capacity Constraints</strong></p>\n<ul>\n      <li>\n        <p>As discussed in the <strong>Expert Capacity</strong> section, Switch Transformer defines per-expert capacity as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-158-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1152\" style=\"width: 5.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.846em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1004.79em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1153\"><span class=\"mi\" id=\"MathJax-Span-1154\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1155\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1156\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1157\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1158\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1159\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-1160\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span><span class=\"mo\" id=\"MathJax-Span-1161\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi><mo>,</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-158\">C = \\frac{T}{N} \\times \\alpha,</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-159-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1162\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1163\"><span class=\"mi\" id=\"MathJax-Span-1164\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-159\">T</script> is the number of tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-160-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1165\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1166\"><span class=\"mi\" id=\"MathJax-Span-1167\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-160\">\\alpha</script> is the capacity factor (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n        </ul>\n      </li>\n      <li>Tokens exceeding capacity are dropped or rerouted, ensuring no single expert dominates.</li>\n      <li>Proper tuning of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-161-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1168\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1169\"><span class=\"mi\" id=\"MathJax-Span-1170\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-161\">\\alpha</script> (typically between 1.0 and 1.25) minimizes token drops while maintaining computational efficiency.</li>\n    </ul>\n<p>As discussed in the <strong>Expert Capacity</strong> section, Switch Transformer defines per-expert capacity as:</p>\n<ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-159-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1162\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1163\"><span class=\"mi\" id=\"MathJax-Span-1164\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-159\">T</script> is the number of tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-160-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1165\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1166\"><span class=\"mi\" id=\"MathJax-Span-1167\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-160\">\\alpha</script> is the capacity factor (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n        </ul>\n<p><strong>MegaBlocks Approach</strong></p>\n<ul>\n      <li>The <strong>MegaBlocks</strong> framework introduced by <a href=\"https://arxiv.org/abs/2211.15841\">Gholami et al. (2022)</a> improves load balancing by using <em>block-wise parallelism</em> and <em>structured sparsity</em>.</li>\n      <li>It divides the model into independent blocks that can be executed in parallel, using sparse activation to ensure that only a subset of experts or blocks activates for each input.</li>\n      <li>Real-time algorithms dynamically redistribute workloads to prevent bottlenecks, and capacity can be adjusted adaptively.</li>\n    </ul>",
    "contentMarkdown": "1.  **Regularization Terms in Loss Function**\n    \n    *   Add explicit penalties for uneven expert utilization, such as entropy-based or fiPifiPif\\_i P\\_i\\-based losses.\n    *   Early work by [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538) used the _coefficient of variation_ of expert importance to penalize skewed loads:\n    \n    CV(Importance)\\=Var(Importance)‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾√𝔼\\[Importance\\],CV\\=CV2CV(Importance)\\=Var(Importance)E\\[Importance\\],LCV\\=CV2\n    \n    \\\\mathrm{CV}(\\\\text{Importance}) = \\\\frac{\\\\sqrt{\\\\mathrm{Var}(\\\\text{Importance})}}{\\\\mathbb{E}\\[\\\\text{Importance}\\]}, \\\\quad \\\\mathcal{L}\\_{\\\\text{CV}} = \\\\mathrm{CV}^2\n    *   This idea evolved into the simpler Switch Transformer formulation where the balancing loss is linear in fiPifiPif\\_i P\\_i.\n2.  **Gating Networks and Routing Strategies**\n    \n    *   Employ top-k gating with added Gaussian noise to encourage exploration, as introduced in [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538).\n    *   In later models, _top-1 routing_ (as in Switch Transformer) improved efficiency but required stronger balancing loss to prevent expert collapse ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n    *   Adaptive gating mechanisms can further adjust routing probabilities based on historical load statistics ([Lewis et al., 2021](https://arxiv.org/abs/2104.14632)).\n3.  **Expert Capacity Constraints**\n    \n    *   As discussed in the **Expert Capacity** section, Switch Transformer defines per-expert capacity as:\n        \n        C\\=TN×α,C\\=TN×α,\n        \n        C = \\\\frac{T}{N} \\\\times \\\\alpha,\n        *   where TTT is the number of tokens and αα\\\\alpha is the capacity factor ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n    *   Tokens exceeding capacity are dropped or rerouted, ensuring no single expert dominates.\n    *   Proper tuning of αα\\\\alpha (typically between 1.0 and 1.25) minimizes token drops while maintaining computational efficiency.\n4.  **MegaBlocks Approach**\n    \n    *   The **MegaBlocks** framework introduced by [Gholami et al. (2022)](https://arxiv.org/abs/2211.15841) improves load balancing by using _block-wise parallelism_ and _structured sparsity_.\n    *   It divides the model into independent blocks that can be executed in parallel, using sparse activation to ensure that only a subset of experts or blocks activates for each input.\n    *   Real-time algorithms dynamically redistribute workloads to prevent bottlenecks, and capacity can be adjusted adaptively.\n\n**Regularization Terms in Loss Function**\n\n*   Add explicit penalties for uneven expert utilization, such as entropy-based or fiPifiPif\\_i P\\_i\\-based losses.\n*   Early work by [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538) used the _coefficient of variation_ of expert importance to penalize skewed loads:\n\n*   This idea evolved into the simpler Switch Transformer formulation where the balancing loss is linear in fiPifiPif\\_i P\\_i.\n\n**Gating Networks and Routing Strategies**\n\n*   Employ top-k gating with added Gaussian noise to encourage exploration, as introduced in [Shazeer et al. (2017)](https://arxiv.org/abs/1701.06538).\n*   In later models, _top-1 routing_ (as in Switch Transformer) improved efficiency but required stronger balancing loss to prevent expert collapse ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n*   Adaptive gating mechanisms can further adjust routing probabilities based on historical load statistics ([Lewis et al., 2021](https://arxiv.org/abs/2104.14632)).\n\n**Expert Capacity Constraints**\n\n*   As discussed in the **Expert Capacity** section, Switch Transformer defines per-expert capacity as:\n    \n    C\\=TN×α,C\\=TN×α,\n    \n    C = \\\\frac{T}{N} \\\\times \\\\alpha,\n    *   where TTT is the number of tokens and αα\\\\alpha is the capacity factor ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n*   Tokens exceeding capacity are dropped or rerouted, ensuring no single expert dominates.\n*   Proper tuning of αα\\\\alpha (typically between 1.0 and 1.25) minimizes token drops while maintaining computational efficiency.\n\nAs discussed in the **Expert Capacity** section, Switch Transformer defines per-expert capacity as:\n\n*   where TTT is the number of tokens and αα\\\\alpha is the capacity factor ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n\n**MegaBlocks Approach**\n\n*   The **MegaBlocks** framework introduced by [Gholami et al. (2022)](https://arxiv.org/abs/2211.15841) improves load balancing by using _block-wise parallelism_ and _structured sparsity_.\n*   It divides the model into independent blocks that can be executed in parallel, using sparse activation to ensure that only a subset of experts or blocks activates for each input.\n*   Real-time algorithms dynamically redistribute workloads to prevent bottlenecks, and capacity can be adjusted adaptively.",
    "contentLength": 44728,
    "wordCount": 571,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#potential-solutions-for-load-balancing"
  },
  {
    "id": "ai-mixture-of-experts-additional-insights-18",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Load Balancing",
    "title": "Additional Insights",
    "order": 18,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li><strong>Capacity vs Load</strong>:\n    <ul>\n      <li>Expert capacity defines a theoretical upper bound per expert, while the load <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-162-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mtext>Load</mtext><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1171\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1002.35em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1172\"><span class=\"msubsup\" id=\"MathJax-Span-1173\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-1174\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-1175\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mtext>Load</mtext><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-162\">\\text{Load}_i</script> measures actual utilization. Balanced MoE systems require both constraints and dynamic adjustments.</li>\n    </ul>\n  </li>\n  <li><strong>Load Variance and Utilization Efficiency</strong>:\n    <ul>\n      <li>Minimizing the variance of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-163-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mtext>Load</mtext><mi>i</mi></msub></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1176\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1002.35em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1177\"><span class=\"texatom\" id=\"MathJax-Span-1178\"><span class=\"mrow\" id=\"MathJax-Span-1179\"><span class=\"msubsup\" id=\"MathJax-Span-1180\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-1181\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-1182\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><msub><mtext>Load</mtext><mi>i</mi></msub></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-163\">{\\text{Load}_i}</script> improves throughput in distributed setups, as uneven loads cause idle GPU time. Empirical studies such as <a href=\"https://arxiv.org/abs/2202.08906\">Zoph et al. (2022)</a> demonstrate that balanced routing directly correlates with higher training efficiency.</li>\n    </ul>\n  </li>\n  <li><strong>Training Stability</strong>:\n    <ul>\n      <li>Unbalanced expert loads may cause gradient collapse, as a few experts dominate updates. ST-MoE (Stable MoE) by <a href=\"https://arxiv.org/abs/2202.08906\">Zoph et al. (2022)</a> explicitly incorporates regularized routing to mitigate this.</li>\n    </ul>\n  </li>\n  <li><strong>Hyperparameter Selection</strong>:\n    <ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-164-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1183\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1184\"><span class=\"mi\" id=\"MathJax-Span-1185\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-164\">\\lambda</script> (balancing-loss weight) and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-165-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1186\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1187\"><span class=\"mi\" id=\"MathJax-Span-1188\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-165\">\\alpha</script> (capacity factor) are critical: too small → imbalance; too large → under-training of the main task.</li>\n      <li>Typical Switch settings use <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-166-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi><mo>&amp;#x2248;</mo><mn>0.01</mn><mo>&amp;#x2013;</mo><mn>0.1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1189\" style=\"width: 6.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.419em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1190\"><span class=\"mi\" id=\"MathJax-Span-1191\" style=\"font-family: STIXGeneral-Italic;\">λ</span><span class=\"mo\" id=\"MathJax-Span-1192\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mn\" id=\"MathJax-Span-1193\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span><span class=\"mo\" id=\"MathJax-Span-1194\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-1195\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">0.1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi><mo>≈</mo><mn>0.01</mn><mo>–</mo><mn>0.1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-166\">\\lambda\\approx 0.01–0.1</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-167-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn><mo>&amp;#x2013;</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1196\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1197\"><span class=\"mi\" id=\"MathJax-Span-1198\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-1199\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1200\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-1201\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-1202\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn><mo>–</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-167\">\\alpha=1.0–1.25</script> (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n    </ul>\n  </li>\n  <li><strong>Hardware and Scalability Considerations</strong>:\n    <ul>\n      <li>In distributed expert-parallel systems, uneven loads increase inter-device communication overhead. Balanced routing directly translates to higher GPU utilization and lower synchronization latency, as discussed in <a href=\"https://arxiv.org/abs/2104.14632\">Lewis et al. (2021)</a>.</li>\n    </ul>\n  </li>\n</ul>\n<ul>\n      <li>Expert capacity defines a theoretical upper bound per expert, while the load <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-162-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mtext>Load</mtext><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1171\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1002.35em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1172\"><span class=\"msubsup\" id=\"MathJax-Span-1173\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-1174\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-1175\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mtext>Load</mtext><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-162\">\\text{Load}_i</script> measures actual utilization. Balanced MoE systems require both constraints and dynamic adjustments.</li>\n    </ul>\n<ul>\n      <li>Minimizing the variance of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-163-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mtext>Load</mtext><mi>i</mi></msub></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1176\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1002.35em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1177\"><span class=\"texatom\" id=\"MathJax-Span-1178\"><span class=\"mrow\" id=\"MathJax-Span-1179\"><span class=\"msubsup\" id=\"MathJax-Span-1180\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-1181\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-1182\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><msub><mtext>Load</mtext><mi>i</mi></msub></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-163\">{\\text{Load}_i}</script> improves throughput in distributed setups, as uneven loads cause idle GPU time. Empirical studies such as <a href=\"https://arxiv.org/abs/2202.08906\">Zoph et al. (2022)</a> demonstrate that balanced routing directly correlates with higher training efficiency.</li>\n    </ul>\n<ul>\n      <li>Unbalanced expert loads may cause gradient collapse, as a few experts dominate updates. ST-MoE (Stable MoE) by <a href=\"https://arxiv.org/abs/2202.08906\">Zoph et al. (2022)</a> explicitly incorporates regularized routing to mitigate this.</li>\n    </ul>\n<ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-164-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1183\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1184\"><span class=\"mi\" id=\"MathJax-Span-1185\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-164\">\\lambda</script> (balancing-loss weight) and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-165-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1186\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1187\"><span class=\"mi\" id=\"MathJax-Span-1188\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-165\">\\alpha</script> (capacity factor) are critical: too small → imbalance; too large → under-training of the main task.</li>\n      <li>Typical Switch settings use <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-166-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi><mo>&amp;#x2248;</mo><mn>0.01</mn><mo>&amp;#x2013;</mo><mn>0.1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1189\" style=\"width: 6.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.419em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1190\"><span class=\"mi\" id=\"MathJax-Span-1191\" style=\"font-family: STIXGeneral-Italic;\">λ</span><span class=\"mo\" id=\"MathJax-Span-1192\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mn\" id=\"MathJax-Span-1193\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span><span class=\"mo\" id=\"MathJax-Span-1194\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-1195\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">0.1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi><mo>≈</mo><mn>0.01</mn><mo>–</mo><mn>0.1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-166\">\\lambda\\approx 0.01–0.1</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-167-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.0</mn><mo>&amp;#x2013;</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1196\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1197\"><span class=\"mi\" id=\"MathJax-Span-1198\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-1199\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1200\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-1201\" style=\"font-family: STIXGeneral-Regular;\">–</span><span class=\"mn\" id=\"MathJax-Span-1202\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.0</mn><mo>–</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-167\">\\alpha=1.0–1.25</script> (<a href=\"https://arxiv.org/abs/2101.03961\">Fedus et al. 2021</a>).</li>\n    </ul>\n<ul>\n      <li>In distributed expert-parallel systems, uneven loads increase inter-device communication overhead. Balanced routing directly translates to higher GPU utilization and lower synchronization latency, as discussed in <a href=\"https://arxiv.org/abs/2104.14632\">Lewis et al. (2021)</a>.</li>\n    </ul>",
    "contentMarkdown": "*   **Capacity vs Load**:\n    *   Expert capacity defines a theoretical upper bound per expert, while the load LoadiLoadi\\\\text{Load}\\_i measures actual utilization. Balanced MoE systems require both constraints and dynamic adjustments.\n*   **Load Variance and Utilization Efficiency**:\n    *   Minimizing the variance of LoadiLoadi{\\\\text{Load}\\_i} improves throughput in distributed setups, as uneven loads cause idle GPU time. Empirical studies such as [Zoph et al. (2022)](https://arxiv.org/abs/2202.08906) demonstrate that balanced routing directly correlates with higher training efficiency.\n*   **Training Stability**:\n    *   Unbalanced expert loads may cause gradient collapse, as a few experts dominate updates. ST-MoE (Stable MoE) by [Zoph et al. (2022)](https://arxiv.org/abs/2202.08906) explicitly incorporates regularized routing to mitigate this.\n*   **Hyperparameter Selection**:\n    *   λλ\\\\lambda (balancing-loss weight) and αα\\\\alpha (capacity factor) are critical: too small → imbalance; too large → under-training of the main task.\n    *   Typical Switch settings use λ≈0.01–0.1λ≈0.01–0.1\\\\lambda\\\\approx 0.01–0.1 and α\\=1.0–1.25α\\=1.0–1.25\\\\alpha=1.0–1.25 ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n*   **Hardware and Scalability Considerations**:\n    *   In distributed expert-parallel systems, uneven loads increase inter-device communication overhead. Balanced routing directly translates to higher GPU utilization and lower synchronization latency, as discussed in [Lewis et al. (2021)](https://arxiv.org/abs/2104.14632).\n\n*   Expert capacity defines a theoretical upper bound per expert, while the load LoadiLoadi\\\\text{Load}\\_i measures actual utilization. Balanced MoE systems require both constraints and dynamic adjustments.\n\n*   Minimizing the variance of LoadiLoadi{\\\\text{Load}\\_i} improves throughput in distributed setups, as uneven loads cause idle GPU time. Empirical studies such as [Zoph et al. (2022)](https://arxiv.org/abs/2202.08906) demonstrate that balanced routing directly correlates with higher training efficiency.\n\n*   Unbalanced expert loads may cause gradient collapse, as a few experts dominate updates. ST-MoE (Stable MoE) by [Zoph et al. (2022)](https://arxiv.org/abs/2202.08906) explicitly incorporates regularized routing to mitigate this.\n\n*   λλ\\\\lambda (balancing-loss weight) and αα\\\\alpha (capacity factor) are critical: too small → imbalance; too large → under-training of the main task.\n*   Typical Switch settings use λ≈0.01–0.1λ≈0.01–0.1\\\\lambda\\\\approx 0.01–0.1 and α\\=1.0–1.25α\\=1.0–1.25\\\\alpha=1.0–1.25 ([Fedus et al. 2021](https://arxiv.org/abs/2101.03961)).\n\n*   In distributed expert-parallel systems, uneven loads increase inter-device communication overhead. Balanced routing directly translates to higher GPU utilization and lower synchronization latency, as discussed in [Lewis et al. (2021)](https://arxiv.org/abs/2104.14632).",
    "contentLength": 22710,
    "wordCount": 333,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#additional-insights"
  },
  {
    "id": "ai-mixture-of-experts-overview-19",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Overview",
    "order": 19,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>In a MoE model, token dropping refers to the situation where one or more input tokens are <strong>not processed by any expert</strong> (or their expert processing is skipped) typically because the assigned expert has already hit its capacity limit. This arises from the interplay of routing, expert capacity, and implementation constraints. Token dropping is important because although dropped tokens often still flow through the residual connection, skipping expert computation can reduce the model’s expressivity or degrade utilization of the large expert pool.</p>\n  </li>\n  <li>\n    <p>Token dropping typically occurs when:</p>\n\n    <ul>\n      <li>A token is routed to an expert whose capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-168-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1203\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1204\"><span class=\"mi\" id=\"MathJax-Span-1205\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-168\">C</script> (cf. <a href=\"#expert-capacity-and-capacity-factor\">Expert Capacity</a> section) is already full.</li>\n      <li>The routing mechanism chooses an expert but the expert cannot accept more tokens due to the capacity limit or system constraints.</li>\n      <li>As a result the token either bypasses the expert, remains at the residual path, or is rerouted according to a policy.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Token dropping has implications for model training and inference: it influences token-expert load balancing, affects gradients (since skipping experts means no expert computation for that token), can change generalization behaviour, and may act implicitly as a form of regularization. For example, according to <a href=\"https://huggingface.co/blog/moe\">Mixture-of-Experts Explained</a> by Hugging Face (2023), “Up to ~11% of the tokens were dropped” in fine-tuning of sparse MoE models and token dropping “might be a form of regularization” rather than solely a negative effect.</p>\n  </li>\n</ul>\n<p>In a MoE model, token dropping refers to the situation where one or more input tokens are <strong>not processed by any expert</strong> (or their expert processing is skipped) typically because the assigned expert has already hit its capacity limit. This arises from the interplay of routing, expert capacity, and implementation constraints. Token dropping is important because although dropped tokens often still flow through the residual connection, skipping expert computation can reduce the model’s expressivity or degrade utilization of the large expert pool.</p>\n<p>Token dropping typically occurs when:</p>\n<ul>\n      <li>A token is routed to an expert whose capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-168-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1203\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1204\"><span class=\"mi\" id=\"MathJax-Span-1205\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-168\">C</script> (cf. <a href=\"#expert-capacity-and-capacity-factor\">Expert Capacity</a> section) is already full.</li>\n      <li>The routing mechanism chooses an expert but the expert cannot accept more tokens due to the capacity limit or system constraints.</li>\n      <li>As a result the token either bypasses the expert, remains at the residual path, or is rerouted according to a policy.</li>\n    </ul>\n<p>Token dropping has implications for model training and inference: it influences token-expert load balancing, affects gradients (since skipping experts means no expert computation for that token), can change generalization behaviour, and may act implicitly as a form of regularization. For example, according to <a href=\"https://huggingface.co/blog/moe\">Mixture-of-Experts Explained</a> by Hugging Face (2023), “Up to ~11% of the tokens were dropped” in fine-tuning of sparse MoE models and token dropping “might be a form of regularization” rather than solely a negative effect.</p>",
    "contentMarkdown": "*   In a MoE model, token dropping refers to the situation where one or more input tokens are **not processed by any expert** (or their expert processing is skipped) typically because the assigned expert has already hit its capacity limit. This arises from the interplay of routing, expert capacity, and implementation constraints. Token dropping is important because although dropped tokens often still flow through the residual connection, skipping expert computation can reduce the model’s expressivity or degrade utilization of the large expert pool.\n    \n*   Token dropping typically occurs when:\n    \n    *   A token is routed to an expert whose capacity CCC (cf. [Expert Capacity](#expert-capacity-and-capacity-factor) section) is already full.\n    *   The routing mechanism chooses an expert but the expert cannot accept more tokens due to the capacity limit or system constraints.\n    *   As a result the token either bypasses the expert, remains at the residual path, or is rerouted according to a policy.\n*   Token dropping has implications for model training and inference: it influences token-expert load balancing, affects gradients (since skipping experts means no expert computation for that token), can change generalization behaviour, and may act implicitly as a form of regularization. For example, according to [Mixture-of-Experts Explained](https://huggingface.co/blog/moe) by Hugging Face (2023), “Up to ~11% of the tokens were dropped” in fine-tuning of sparse MoE models and token dropping “might be a form of regularization” rather than solely a negative effect.\n    \n\nIn a MoE model, token dropping refers to the situation where one or more input tokens are **not processed by any expert** (or their expert processing is skipped) typically because the assigned expert has already hit its capacity limit. This arises from the interplay of routing, expert capacity, and implementation constraints. Token dropping is important because although dropped tokens often still flow through the residual connection, skipping expert computation can reduce the model’s expressivity or degrade utilization of the large expert pool.\n\nToken dropping typically occurs when:\n\n*   A token is routed to an expert whose capacity CCC (cf. [Expert Capacity](#expert-capacity-and-capacity-factor) section) is already full.\n*   The routing mechanism chooses an expert but the expert cannot accept more tokens due to the capacity limit or system constraints.\n*   As a result the token either bypasses the expert, remains at the residual path, or is rerouted according to a policy.\n\nToken dropping has implications for model training and inference: it influences token-expert load balancing, affects gradients (since skipping experts means no expert computation for that token), can change generalization behaviour, and may act implicitly as a form of regularization. For example, according to [Mixture-of-Experts Explained](https://huggingface.co/blog/moe) by Hugging Face (2023), “Up to ~11% of the tokens were dropped” in fine-tuning of sparse MoE models and token dropping “might be a form of regularization” rather than solely a negative effect.",
    "contentLength": 5930,
    "wordCount": 457,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#overview"
  },
  {
    "id": "ai-mixture-of-experts-mathematical-formulation-of-token-dropping-20",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Mathematical Formulation of Token Dropping",
    "order": 20,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>In the context of a MoE model, token dropping occurs when tokens fail to be processed by their assigned expert(s) — either because the expert is at capacity or because routing constraints force the token to bypass the expert step entirely. The phenomenon has both routing and capacity components and can be formulated mathematically to reason about its impact.</li>\n</ul>\n<h4 id=\"routing-and-capacity-background\">Routing and Capacity Background</h4>\n<ul>\n  <li>\n    <p>Recall from the expert capacity formulation that for a MoE layer with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-169-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1206\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1207\"><span class=\"mi\" id=\"MathJax-Span-1208\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-169\">T</script> tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-170-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1209\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1210\"><span class=\"mi\" id=\"MathJax-Span-1211\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-170\">N</script> experts, each expert has a capacity:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-171-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1212\" style=\"width: 5.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.638em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1004.64em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1213\"><span class=\"mi\" id=\"MathJax-Span-1214\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1215\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1216\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1217\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1218\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1219\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-1220\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-171\">C = \\frac{T}{N} \\times \\alpha</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-172-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1221\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1222\"><span class=\"mi\" id=\"MathJax-Span-1223\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-172\">\\alpha</script> is the capacity factor.</li>\n    </ul>\n  </li>\n  <li>\n    <p>When routing assigns token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-173-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1224\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1225\"><span class=\"mi\" id=\"MathJax-Span-1226\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-173\">x</script> to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-174-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1227\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1228\"><span class=\"mi\" id=\"MathJax-Span-1229\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-174\">i</script>, let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-175-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1230\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.669em, 1006.51em, 2.867em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1231\"><span class=\"texatom\" id=\"MathJax-Span-1232\"><span class=\"mrow\" id=\"MathJax-Span-1233\"><span class=\"mn\" id=\"MathJax-Span-1234\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-1235\"><span class=\"mrow\" id=\"MathJax-Span-1236\"><span class=\"mo\" id=\"MathJax-Span-1237\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-1238\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-1239\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1240\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1241\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1242\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-1243\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-1244\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-175\">\\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script> indicate that the token was routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-176-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1245\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1246\"><span class=\"mi\" id=\"MathJax-Span-1247\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-176\">i</script>. Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-177-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1248\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1249\"><span class=\"msubsup\" id=\"MathJax-Span-1250\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1251\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1252\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1253\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1254\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1255\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-177\">p_i(x)</script> be the gating probability that token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-178-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1256\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1257\"><span class=\"mi\" id=\"MathJax-Span-1258\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-178\">x</script> would go to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-179-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1259\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1260\"><span class=\"mi\" id=\"MathJax-Span-1261\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-179\">i</script>.</p>\n  </li>\n  <li>\n    <p>Define the actual number of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-180-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1262\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1263\"><span class=\"mi\" id=\"MathJax-Span-1264\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-180\">i</script> as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-181-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></mrow></munder><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1265\" style=\"width: 12.19em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.159em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1010.05em, 3.909em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1266\"><span class=\"msubsup\" id=\"MathJax-Span-1267\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1268\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1269\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1270\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-1271\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.003em;\"><span class=\"mo\" id=\"MathJax-Span-1272\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.3em, 4.273em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1273\"><span class=\"mrow\" id=\"MathJax-Span-1274\"><span class=\"mi\" id=\"MathJax-Span-1275\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1276\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-1277\"><span class=\"mrow\" id=\"MathJax-Span-1278\"><span class=\"mi\" id=\"MathJax-Span-1279\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-1280\" style=\"padding-left: 0.211em;\"><span class=\"mrow\" id=\"MathJax-Span-1281\"><span class=\"mn\" id=\"MathJax-Span-1282\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-1283\"><span class=\"mrow\" id=\"MathJax-Span-1284\"><span class=\"mo\" id=\"MathJax-Span-1285\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-1286\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-1287\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1288\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1289\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1290\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-1291\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-1292\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 2.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>T</mi><mi>i</mi></msub><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></mrow></munder><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-181\">T_i = \\sum_{x \\in \\mathcal{B}} \\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-182-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1293\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1294\"><span class=\"texatom\" id=\"MathJax-Span-1295\"><span class=\"mrow\" id=\"MathJax-Span-1296\"><span class=\"mi\" id=\"MathJax-Span-1297\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-182\">\\mathcal{B}</script> is the token batch.</li>\n    </ul>\n  </li>\n  <li>\n    <p>If <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-183-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1298\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.71em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1299\"><span class=\"msubsup\" id=\"MathJax-Span-1300\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1301\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1302\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1303\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-1304\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-183\">T_i > C</script>, then expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-184-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1305\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1306\"><span class=\"mi\" id=\"MathJax-Span-1307\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-184\">i</script> is <em>over-capacity</em>. Depending on implementation, the extra tokens beyond capacity may be <strong>dropped</strong>, i.e., they skip the expert, or be re-routed.</p>\n  </li>\n</ul>\n<p>Recall from the expert capacity formulation that for a MoE layer with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-169-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1206\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1207\"><span class=\"mi\" id=\"MathJax-Span-1208\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-169\">T</script> tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-170-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1209\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1210\"><span class=\"mi\" id=\"MathJax-Span-1211\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-170\">N</script> experts, each expert has a capacity:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-172-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1221\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1222\"><span class=\"mi\" id=\"MathJax-Span-1223\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-172\">\\alpha</script> is the capacity factor.</li>\n    </ul>\n<p>When routing assigns token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-173-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1224\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1225\"><span class=\"mi\" id=\"MathJax-Span-1226\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-173\">x</script> to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-174-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1227\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1228\"><span class=\"mi\" id=\"MathJax-Span-1229\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-174\">i</script>, let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-175-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn mathvariant=&quot;bold&quot;>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><mtext>expert</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>i</mi><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1230\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.669em, 1006.51em, 2.867em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1231\"><span class=\"texatom\" id=\"MathJax-Span-1232\"><span class=\"mrow\" id=\"MathJax-Span-1233\"><span class=\"mn\" id=\"MathJax-Span-1234\" style=\"font-family: STIXGeneral; font-weight: bold;\">1</span></span></span><span class=\"texatom\" id=\"MathJax-Span-1235\"><span class=\"mrow\" id=\"MathJax-Span-1236\"><span class=\"mo\" id=\"MathJax-Span-1237\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mtext\" id=\"MathJax-Span-1238\" style=\"font-family: STIXGeneral-Regular;\">expert</span><span class=\"mo\" id=\"MathJax-Span-1239\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1240\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1241\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1242\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-1243\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">i</span><span class=\"mo\" id=\"MathJax-Span-1244\" style=\"font-family: STIXGeneral-Regular;\">}</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mn mathvariant=\"bold\">1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo fence=\"false\" stretchy=\"false\">{</mo><mtext>expert</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>i</mi><mo fence=\"false\" stretchy=\"false\">}</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-175\">\\mathbf{1}{\\{\\text{expert}(x) = i\\}}</script> indicate that the token was routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-176-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1245\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1246\"><span class=\"mi\" id=\"MathJax-Span-1247\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-176\">i</script>. Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-177-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1248\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1249\"><span class=\"msubsup\" id=\"MathJax-Span-1250\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1251\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1252\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1253\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1254\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1255\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-177\">p_i(x)</script> be the gating probability that token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-178-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1256\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1257\"><span class=\"mi\" id=\"MathJax-Span-1258\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-178\">x</script> would go to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-179-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1259\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1260\"><span class=\"mi\" id=\"MathJax-Span-1261\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-179\">i</script>.</p>\n<p>Define the actual number of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-180-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1262\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1263\"><span class=\"mi\" id=\"MathJax-Span-1264\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-180\">i</script> as:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-182-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>B</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1293\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1294\"><span class=\"texatom\" id=\"MathJax-Span-1295\"><span class=\"mrow\" id=\"MathJax-Span-1296\"><span class=\"mi\" id=\"MathJax-Span-1297\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">B</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-182\">\\mathcal{B}</script> is the token batch.</li>\n    </ul>\n<p>If <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-183-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1298\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.71em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1299\"><span class=\"msubsup\" id=\"MathJax-Span-1300\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1301\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1302\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1303\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-1304\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-183\">T_i > C</script>, then expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-184-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1305\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1306\"><span class=\"mi\" id=\"MathJax-Span-1307\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-184\">i</script> is <em>over-capacity</em>. Depending on implementation, the extra tokens beyond capacity may be <strong>dropped</strong>, i.e., they skip the expert, or be re-routed.</p>\n<h4 id=\"dropped-token-count-and-drop-rate\">Dropped Token Count and Drop Rate</h4>\n<ul>\n  <li>\n    <p>Define the overflow for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-185-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1308\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1309\"><span class=\"mi\" id=\"MathJax-Span-1310\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-185\">i</script> as <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-186-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>0</mn><mo>,</mo><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mi>C</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1311\" style=\"width: 9.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.128em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.08em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1312\"><span class=\"msubsup\" id=\"MathJax-Span-1313\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1314\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-1315\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1316\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-1317\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">max</span><span class=\"mo\" id=\"MathJax-Span-1318\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mn\" id=\"MathJax-Span-1319\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-1320\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1321\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1322\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1323\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1324\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mi\" id=\"MathJax-Span-1325\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1326\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=\"true\" form=\"prefix\">max</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>,</mo><msub><mi>T</mi><mi>i</mi></msub><mo>−</mo><mi>C</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-186\">O_i = \\max(0, T_i - C)</script>.</p>\n  </li>\n  <li>\n    <p>These <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-187-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1327\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1328\"><span class=\"msubsup\" id=\"MathJax-Span-1329\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1330\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-1331\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-187\">O_i</script> tokens are the ones that cannot be processed by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-188-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1332\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1333\"><span class=\"mi\" id=\"MathJax-Span-1334\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-188\">i</script> under the capacity constraint.</p>\n  </li>\n  <li>\n    <p>The total number of dropped tokens (assuming they are dropped rather than rerouted) is:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-189-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>O</mi><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1335\" style=\"width: 5.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.43em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1004.43em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1336\"><span class=\"mi\" id=\"MathJax-Span-1337\" style=\"font-family: STIXGeneral-Italic;\">O</span><span class=\"mo\" id=\"MathJax-Span-1338\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-1339\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1340\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-1341\"><span class=\"mrow\" id=\"MathJax-Span-1342\"><span class=\"mi\" id=\"MathJax-Span-1343\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1344\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1345\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-1346\"><span class=\"mrow\" id=\"MathJax-Span-1347\"><span class=\"mi\" id=\"MathJax-Span-1348\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1349\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1350\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-1351\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>O</mi><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>O</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-189\">O = \\sum_{i=1}^{N} O_i</script>\n  </li>\n  <li>\n    <p>Hence, the <strong>token drop rate</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-190-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1352\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1353\"><span class=\"mi\" id=\"MathJax-Span-1354\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-190\">r</script> can be defined as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-191-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>r</mi><mo>=</mo><mfrac><mi>O</mi><mi>T</mi></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1355\" style=\"width: 3.128em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1002.61em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1356\"><span class=\"mi\" id=\"MathJax-Span-1357\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1358\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1359\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1360\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1361\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>r</mi><mo>=</mo><mfrac><mi>O</mi><mi>T</mi></mfrac></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-191\">r = \\frac{O}{T}</script>\n  </li>\n  <li>\n    <p>A high drop-rate <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-192-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1362\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1363\"><span class=\"mi\" id=\"MathJax-Span-1364\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-192\">r</script> means many tokens did not receive expert processing — this can degrade model performance because those tokens effectively skip the expert transformation and proceed via the residual connection.</p>\n  </li>\n</ul>\n<p>Define the overflow for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-185-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1308\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1309\"><span class=\"mi\" id=\"MathJax-Span-1310\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-185\">i</script> as <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-186-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>0</mn><mo>,</mo><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mi>C</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1311\" style=\"width: 9.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.128em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.08em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1312\"><span class=\"msubsup\" id=\"MathJax-Span-1313\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1314\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-1315\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1316\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-1317\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">max</span><span class=\"mo\" id=\"MathJax-Span-1318\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mn\" id=\"MathJax-Span-1319\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-1320\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1321\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1322\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1323\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1324\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mi\" id=\"MathJax-Span-1325\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1326\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mo movablelimits=\"true\" form=\"prefix\">max</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>,</mo><msub><mi>T</mi><mi>i</mi></msub><mo>−</mo><mi>C</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-186\">O_i = \\max(0, T_i - C)</script>.</p>\n<p>These <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-187-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>O</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1327\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1328\"><span class=\"msubsup\" id=\"MathJax-Span-1329\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1330\" style=\"font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-1331\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>O</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-187\">O_i</script> tokens are the ones that cannot be processed by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-188-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1332\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1333\"><span class=\"mi\" id=\"MathJax-Span-1334\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-188\">i</script> under the capacity constraint.</p>\n<p>The total number of dropped tokens (assuming they are dropped rather than rerouted) is:</p>\n<p>Hence, the <strong>token drop rate</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-190-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1352\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1353\"><span class=\"mi\" id=\"MathJax-Span-1354\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-190\">r</script> can be defined as:</p>\n<p>A high drop-rate <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-192-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1362\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1363\"><span class=\"mi\" id=\"MathJax-Span-1364\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-192\">r</script> means many tokens did not receive expert processing — this can degrade model performance because those tokens effectively skip the expert transformation and proceed via the residual connection.</p>",
    "contentMarkdown": "*   In the context of a MoE model, token dropping occurs when tokens fail to be processed by their assigned expert(s) — either because the expert is at capacity or because routing constraints force the token to bypass the expert step entirely. The phenomenon has both routing and capacity components and can be formulated mathematically to reason about its impact.\n\n#### Routing and Capacity Background\n\n*   Recall from the expert capacity formulation that for a MoE layer with TTT tokens and NNN experts, each expert has a capacity:\n    \n    C\\=TN×αC\\=TN×α\n    \n    C = \\\\frac{T}{N} \\\\times \\\\alpha\n    *   where αα\\\\alpha is the capacity factor.\n*   When routing assigns token xxx to expert iii, let 1{expert(x)\\=i}1{expert(x)\\=i}\\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}} indicate that the token was routed to expert iii. Let pi(x)pi(x)p\\_i(x) be the gating probability that token xxx would go to expert iii.\n    \n*   Define the actual number of tokens routed to expert iii as:\n    \n    Ti\\=∑x∈1{expert(x)\\=i}Ti\\=∑x∈B1{expert(x)\\=i}\n    \n    T\\_i = \\\\sum\\_{x \\\\in \\\\mathcal{B}} \\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}}\n    *   where B\\\\mathcal{B} is the token batch.\n*   If Ti\\>CTi\\>CT\\_i > C, then expert iii is _over-capacity_. Depending on implementation, the extra tokens beyond capacity may be **dropped**, i.e., they skip the expert, or be re-routed.\n    \n\nRecall from the expert capacity formulation that for a MoE layer with TTT tokens and NNN experts, each expert has a capacity:\n\n*   where αα\\\\alpha is the capacity factor.\n\nWhen routing assigns token xxx to expert iii, let 1{expert(x)\\=i}1{expert(x)\\=i}\\\\mathbf{1}{\\\\{\\\\text{expert}(x) = i\\\\}} indicate that the token was routed to expert iii. Let pi(x)pi(x)p\\_i(x) be the gating probability that token xxx would go to expert iii.\n\nDefine the actual number of tokens routed to expert iii as:\n\n*   where B\\\\mathcal{B} is the token batch.\n\nIf Ti\\>CTi\\>CT\\_i > C, then expert iii is _over-capacity_. Depending on implementation, the extra tokens beyond capacity may be **dropped**, i.e., they skip the expert, or be re-routed.\n\n#### Dropped Token Count and Drop Rate\n\n*   Define the overflow for expert iii as Oi\\=max(0,Ti−C)Oi\\=max(0,Ti−C)O\\_i = \\\\max(0, T\\_i - C).\n    \n*   These OiOiO\\_i tokens are the ones that cannot be processed by expert iii under the capacity constraint.\n    \n*   The total number of dropped tokens (assuming they are dropped rather than rerouted) is:\n    \n    O\\=∑i\\=1NOiO\\=∑i\\=1NOi\n    \n    O = \\\\sum\\_{i=1}^{N} O\\_i\n*   Hence, the **token drop rate** rrr can be defined as:\n    \n    r\\=OTr\\=OT\n    \n    r = \\\\frac{O}{T}\n*   A high drop-rate rrr means many tokens did not receive expert processing — this can degrade model performance because those tokens effectively skip the expert transformation and proceed via the residual connection.\n    \n\nDefine the overflow for expert iii as Oi\\=max(0,Ti−C)Oi\\=max(0,Ti−C)O\\_i = \\\\max(0, T\\_i - C).\n\nThese OiOiO\\_i tokens are the ones that cannot be processed by expert iii under the capacity constraint.\n\nThe total number of dropped tokens (assuming they are dropped rather than rerouted) is:\n\nHence, the **token drop rate** rrr can be defined as:\n\nA high drop-rate rrr means many tokens did not receive expert processing — this can degrade model performance because those tokens effectively skip the expert transformation and proceed via the residual connection.",
    "contentLength": 83367,
    "wordCount": 497,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mathematical-formulation-of-token-dropping"
  },
  {
    "id": "ai-mixture-of-experts-token-dropping-scenarios-21",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Token Dropping Scenarios",
    "order": 21,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>\n    <p>There are different mechanisms by which tokens may be dropped:</p>\n\n    <ol>\n      <li><strong>Capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-193-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1365\" style=\"width: 0.829em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.674em; height: 0px; font-size: 121%;\"><span style=\"position: absolute; clip: rect(1.346em, 1000.67em, 2.327em, -999.997em); top: -2.167em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1366\"><span class=\"mi\" id=\"MathJax-Span-1367\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.172em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-193\">C</script> reached:</strong> When <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-194-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1368\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1369\"><span class=\"msubsup\" id=\"MathJax-Span-1370\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1371\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1372\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-194\">T_i</script> exceeds <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-195-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1373\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1374\"><span class=\"mi\" id=\"MathJax-Span-1375\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-195\">C</script>, the simplest policy is to drop any tokens over the threshold; these tokens bypass the expert layer.</li>\n      <li><strong>No valid expert assignment:</strong> In more extreme cases (e.g., expert-choice routing), some tokens may not be selected by any expert; such tokens automatically become dropped.</li>\n      <li><strong>Inference-time straggler mitigation:</strong> <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) utilizes token dropping deliberately at inference to regulate the maximum latency of MoE.</li>\n    </ol>\n  </li>\n</ul>\n<p>There are different mechanisms by which tokens may be dropped:</p>\n<ol>\n      <li><strong>Capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-193-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1365\" style=\"width: 0.829em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.674em; height: 0px; font-size: 121%;\"><span style=\"position: absolute; clip: rect(1.346em, 1000.67em, 2.327em, -999.997em); top: -2.167em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1366\"><span class=\"mi\" id=\"MathJax-Span-1367\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.172em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-193\">C</script> reached:</strong> When <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-194-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1368\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1369\"><span class=\"msubsup\" id=\"MathJax-Span-1370\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1371\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1372\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-194\">T_i</script> exceeds <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-195-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1373\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1374\"><span class=\"mi\" id=\"MathJax-Span-1375\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-195\">C</script>, the simplest policy is to drop any tokens over the threshold; these tokens bypass the expert layer.</li>\n      <li><strong>No valid expert assignment:</strong> In more extreme cases (e.g., expert-choice routing), some tokens may not be selected by any expert; such tokens automatically become dropped.</li>\n      <li><strong>Inference-time straggler mitigation:</strong> <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) utilizes token dropping deliberately at inference to regulate the maximum latency of MoE.</li>\n    </ol>",
    "contentMarkdown": "*   There are different mechanisms by which tokens may be dropped:\n    \n    1.  **Capacity CCC reached:** When TiTiT\\_i exceeds CCC, the simplest policy is to drop any tokens over the threshold; these tokens bypass the expert layer.\n    2.  **No valid expert assignment:** In more extreme cases (e.g., expert-choice routing), some tokens may not be selected by any expert; such tokens automatically become dropped.\n    3.  **Inference-time straggler mitigation:** [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) utilizes token dropping deliberately at inference to regulate the maximum latency of MoE.\n\nThere are different mechanisms by which tokens may be dropped:\n\n1.  **Capacity CCC reached:** When TiTiT\\_i exceeds CCC, the simplest policy is to drop any tokens over the threshold; these tokens bypass the expert layer.\n2.  **No valid expert assignment:** In more extreme cases (e.g., expert-choice routing), some tokens may not be selected by any expert; such tokens automatically become dropped.\n3.  **Inference-time straggler mitigation:** [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) utilizes token dropping deliberately at inference to regulate the maximum latency of MoE.",
    "contentLength": 10478,
    "wordCount": 187,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#token-dropping-scenarios"
  },
  {
    "id": "ai-mixture-of-experts-implications-in-formulae-22",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Implications in Formulae",
    "order": 22,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>\n    <p>Given the routing fractions <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-196-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1376\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1377\"><span class=\"msubsup\" id=\"MathJax-Span-1378\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1379\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1380\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1381\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1382\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1383\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-196\">p_i(x)</script> and the resulting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-197-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1384\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1385\"><span class=\"msubsup\" id=\"MathJax-Span-1386\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1387\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1388\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-197\">T_i</script>, we can relate the expected drop rate to imbalance in routing. If we let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-198-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><msub><mi>T</mi><mi>i</mi></msub><mi>T</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1389\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1002.71em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1390\"><span class=\"msubsup\" id=\"MathJax-Span-1391\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1392\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1393\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1394\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1395\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.273em, -999.997em); top: -4.529em; left: 50%; margin-left: -0.31em;\"><span class=\"msubsup\" id=\"MathJax-Span-1396\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1397\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-1398\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-1399\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><msub><mi>T</mi><mi>i</mi></msub><mi>T</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-198\">f_i = \\frac{T_i}{T}</script> be the fraction of total tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-199-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1400\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1401\"><span class=\"mi\" id=\"MathJax-Span-1402\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-199\">i</script>, then overflow occurs when:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-200-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>T</mi><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mi>&amp;#x03B1;</mi><mspace width=&quot;1em&quot; /><mo stretchy=&quot;false&quot;>&amp;#x27F9;</mo><mspace width=&quot;1em&quot; /><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1403\" style=\"width: 16.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.388em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.732em, 1013.39em, 3.076em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1404\"><span class=\"mi\" id=\"MathJax-Span-1405\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-1406\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1407\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1408\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1409\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-1410\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1411\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1412\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1413\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1414\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-1415\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mspace\" id=\"MathJax-Span-1416\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"mo\" id=\"MathJax-Span-1417\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">⟹</span><span class=\"mspace\" id=\"MathJax-Span-1418\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"msubsup\" id=\"MathJax-Span-1419\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1420\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1421\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1422\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mfrac\" id=\"MathJax-Span-1423\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-1424\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1425\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-1426\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>T</mi><msub><mi>f</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mi>α</mi><mspace width=\"1em\"></mspace><mo stretchy=\"false\">⟹</mo><mspace width=\"1em\"></mspace><msub><mi>f</mi><mi>i</mi></msub><mo>&gt;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mi>α</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-200\">T f_i > C = \\frac{T}{N}\\alpha \\quad \\Longrightarrow \\quad f_i > \\frac{1}{N}\\alpha</script>\n  </li>\n  <li>\n    <p>Thus, we can write the drop-rate bound approximately as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-201-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>r</mi><mo>&amp;#x2248;</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mrow><mo>(</mo><mrow><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mi>&amp;#x03B1;</mi></mrow><mo>)</mo></mrow><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mrow><mo>(</mo><mrow><mn>0</mn><mo>,</mo><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2212;</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mi>&amp;#x03B1;</mi></mrow><mo>)</mo></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1427\" style=\"width: 27.19em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 22.659em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.878em, 1022.5em, 5.211em, -999.997em); top: -3.799em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1428\"><span class=\"mi\" id=\"MathJax-Span-1429\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1430\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mfrac\" id=\"MathJax-Span-1431\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-1432\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1433\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-1434\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1435\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-1436\"><span class=\"mrow\" id=\"MathJax-Span-1437\"><span class=\"mi\" id=\"MathJax-Span-1438\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1439\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1440\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-1441\"><span class=\"mrow\" id=\"MathJax-Span-1442\"><span class=\"mi\" id=\"MathJax-Span-1443\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1444\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">max</span><span class=\"mrow\" id=\"MathJax-Span-1445\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-1446\" style=\"vertical-align: -0.466em;\"><span><span style=\"font-size: 111%; font-family: STIXSizeTwoSym;\">(</span></span></span><span class=\"mrow\" id=\"MathJax-Span-1447\"><span class=\"mn\" id=\"MathJax-Span-1448\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-1449\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-1450\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-1451\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1452\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1453\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1454\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mfrac\" id=\"MathJax-Span-1455\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1456\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1457\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-1458\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span class=\"mo\" id=\"MathJax-Span-1459\" style=\"vertical-align: -0.466em;\"><span><span style=\"font-size: 111%; font-family: STIXSizeTwoSym;\">)</span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1460\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-1461\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1462\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-1463\"><span class=\"mrow\" id=\"MathJax-Span-1464\"><span class=\"mi\" id=\"MathJax-Span-1465\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1466\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1467\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-1468\"><span class=\"mrow\" id=\"MathJax-Span-1469\"><span class=\"mi\" id=\"MathJax-Span-1470\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1471\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">max</span><span class=\"mrow\" id=\"MathJax-Span-1472\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-1473\" style=\"vertical-align: -0.466em;\"><span><span style=\"font-size: 111%; font-family: STIXSizeTwoSym;\">(</span></span></span><span class=\"mrow\" id=\"MathJax-Span-1474\"><span class=\"mn\" id=\"MathJax-Span-1475\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-1476\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1477\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1478\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1479\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1480\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mfrac\" id=\"MathJax-Span-1481\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.258em;\"><span class=\"mn\" id=\"MathJax-Span-1482\" style=\"font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1483\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-1484\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span class=\"mo\" id=\"MathJax-Span-1485\" style=\"vertical-align: -0.466em;\"><span><span style=\"font-size: 111%; font-family: STIXSizeTwoSym;\">)</span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.805em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>r</mi><mo>≈</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><mo movablelimits=\"true\" form=\"prefix\">max</mo><mrow><mo>(</mo><mrow><mn>0</mn><mo>,</mo><mi>T</mi><msub><mi>f</mi><mi>i</mi></msub><mo>−</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mi>α</mi></mrow><mo>)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><mo movablelimits=\"true\" form=\"prefix\">max</mo><mrow><mo>(</mo><mrow><mn>0</mn><mo>,</mo><msub><mi>f</mi><mi>i</mi></msub><mo>−</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><mi>α</mi></mrow><mo>)</mo></mrow></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-201\">r \\approx \\frac{1}{T} \\sum_{i=1}^{N} \\max \\left(0, T f_i - \\frac{T}{N}\\alpha\\right)\n= \\sum_{i=1}^{N} \\max \\left(0, f_i - \\frac{1}{N}\\alpha \\right)</script>\n  </li>\n  <li>\n    <p>This shows that the drop rate is driven by the deviation of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-202-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1486\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1487\"><span class=\"msubsup\" id=\"MathJax-Span-1488\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1489\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1490\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-202\">f_i</script> from its target value <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-203-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;false&quot; scriptlevel=&quot;0&quot;><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1491\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1000.84em, 2.659em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1492\"><span class=\"mstyle\" id=\"MathJax-Span-1493\"><span class=\"mrow\" id=\"MathJax-Span-1494\"><span class=\"mfrac\" id=\"MathJax-Span-1495\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-1496\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-1497\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mstyle displaystyle=\"false\" scriptlevel=\"0\"><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-203\">\\tfrac{1}{N}</script> scaled by <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-204-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1498\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1499\"><span class=\"mi\" id=\"MathJax-Span-1500\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-204\">\\alpha</script>. A well-balanced router (so that <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-205-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mstyle displaystyle=&quot;false&quot; scriptlevel=&quot;0&quot;><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1501\" style=\"width: 3.128em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.61em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1502\"><span class=\"msubsup\" id=\"MathJax-Span-1503\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1504\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1505\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1506\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mstyle\" id=\"MathJax-Span-1507\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1508\"><span class=\"mfrac\" id=\"MathJax-Span-1509\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-1510\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-1511\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>≈</mo><mstyle displaystyle=\"false\" scriptlevel=\"0\"><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-205\">f_i \\approx \\tfrac{1}{N}</script> for all <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-206-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1512\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1513\"><span class=\"mi\" id=\"MathJax-Span-1514\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-206\">i</script>) combined with a sufficiently large <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-207-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1515\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1516\"><span class=\"mi\" id=\"MathJax-Span-1517\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-207\">\\alpha</script> yields low drop rates.</p>\n  </li>\n</ul>\n<p>Given the routing fractions <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-196-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1376\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1377\"><span class=\"msubsup\" id=\"MathJax-Span-1378\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1379\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1380\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1381\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1382\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1383\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-196\">p_i(x)</script> and the resulting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-197-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1384\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1385\"><span class=\"msubsup\" id=\"MathJax-Span-1386\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1387\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1388\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-197\">T_i</script>, we can relate the expected drop rate to imbalance in routing. If we let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-198-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><msub><mi>T</mi><mi>i</mi></msub><mi>T</mi></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1389\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1002.71em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1390\"><span class=\"msubsup\" id=\"MathJax-Span-1391\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1392\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1393\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1394\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1395\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.273em, -999.997em); top: -4.529em; left: 50%; margin-left: -0.31em;\"><span class=\"msubsup\" id=\"MathJax-Span-1396\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1397\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-1398\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-1399\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>=</mo><mfrac><msub><mi>T</mi><mi>i</mi></msub><mi>T</mi></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-198\">f_i = \\frac{T_i}{T}</script> be the fraction of total tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-199-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1400\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1401\"><span class=\"mi\" id=\"MathJax-Span-1402\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-199\">i</script>, then overflow occurs when:</p>\n<p>Thus, we can write the drop-rate bound approximately as:</p>\n<p>This shows that the drop rate is driven by the deviation of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-202-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1486\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1487\"><span class=\"msubsup\" id=\"MathJax-Span-1488\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1489\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1490\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-202\">f_i</script> from its target value <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-203-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mstyle displaystyle=&quot;false&quot; scriptlevel=&quot;0&quot;><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1491\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1000.84em, 2.659em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1492\"><span class=\"mstyle\" id=\"MathJax-Span-1493\"><span class=\"mrow\" id=\"MathJax-Span-1494\"><span class=\"mfrac\" id=\"MathJax-Span-1495\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-1496\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-1497\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mstyle displaystyle=\"false\" scriptlevel=\"0\"><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-203\">\\tfrac{1}{N}</script> scaled by <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-204-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1498\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1499\"><span class=\"mi\" id=\"MathJax-Span-1500\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-204\">\\alpha</script>. A well-balanced router (so that <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-205-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mstyle displaystyle=&quot;false&quot; scriptlevel=&quot;0&quot;><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1501\" style=\"width: 3.128em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.61em, 2.711em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1502\"><span class=\"msubsup\" id=\"MathJax-Span-1503\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1504\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1505\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1506\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mstyle\" id=\"MathJax-Span-1507\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1508\"><span class=\"mfrac\" id=\"MathJax-Span-1509\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-1510\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.258em;\"><span class=\"mi\" id=\"MathJax-Span-1511\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.63em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.628em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo>≈</mo><mstyle displaystyle=\"false\" scriptlevel=\"0\"><mfrac><mn>1</mn><mi>N</mi></mfrac></mstyle></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-205\">f_i \\approx \\tfrac{1}{N}</script> for all <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-206-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1512\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1513\"><span class=\"mi\" id=\"MathJax-Span-1514\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-206\">i</script>) combined with a sufficiently large <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-207-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1515\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1516\"><span class=\"mi\" id=\"MathJax-Span-1517\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-207\">\\alpha</script> yields low drop rates.</p>",
    "contentMarkdown": "*   Given the routing fractions pi(x)pi(x)p\\_i(x) and the resulting TiTiT\\_i, we can relate the expected drop rate to imbalance in routing. If we let fi\\=TiTfi\\=TiTf\\_i = \\\\frac{T\\_i}{T} be the fraction of total tokens routed to expert iii, then overflow occurs when:\n    \n    Tfi\\>C\\=TNα⟹fi\\>1NαTfi\\>C\\=TNα⟹fi\\>1Nα\n    \n    T f\\_i > C = \\\\frac{T}{N}\\\\alpha \\\\quad \\\\Longrightarrow \\\\quad f\\_i > \\\\frac{1}{N}\\\\alpha\n*   Thus, we can write the drop-rate bound approximately as:\n    \n    r≈1T∑i\\=1Nmax(0,Tfi−TNα)\\=∑i\\=1Nmax(0,fi−1Nα)r≈1T∑i\\=1Nmax(0,Tfi−TNα)\\=∑i\\=1Nmax(0,fi−1Nα)\n    \n    r \\\\approx \\\\frac{1}{T} \\\\sum\\_{i=1}^{N} \\\\max \\\\left(0, T f\\_i - \\\\frac{T}{N}\\\\alpha\\\\right) = \\\\sum\\_{i=1}^{N} \\\\max \\\\left(0, f\\_i - \\\\frac{1}{N}\\\\alpha \\\\right)\n*   This shows that the drop rate is driven by the deviation of fifif\\_i from its target value 1N1N\\\\tfrac{1}{N} scaled by αα\\\\alpha. A well-balanced router (so that fi≈1Nfi≈1Nf\\_i \\\\approx \\\\tfrac{1}{N} for all iii) combined with a sufficiently large αα\\\\alpha yields low drop rates.\n    \n\nGiven the routing fractions pi(x)pi(x)p\\_i(x) and the resulting TiTiT\\_i, we can relate the expected drop rate to imbalance in routing. If we let fi\\=TiTfi\\=TiTf\\_i = \\\\frac{T\\_i}{T} be the fraction of total tokens routed to expert iii, then overflow occurs when:\n\nThus, we can write the drop-rate bound approximately as:\n\nThis shows that the drop rate is driven by the deviation of fifif\\_i from its target value 1N1N\\\\tfrac{1}{N} scaled by αα\\\\alpha. A well-balanced router (so that fi≈1Nfi≈1Nf\\_i \\\\approx \\\\tfrac{1}{N} for all iii) combined with a sufficiently large αα\\\\alpha yields low drop rates.",
    "contentLength": 65402,
    "wordCount": 217,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#implications-in-formulae"
  },
  {
    "id": "ai-mixture-of-experts-drop-rate-and-model-quality-23",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Drop-Rate and Model Quality",
    "order": 23,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>Empirical results in sparse expert models indicate that modest drop rates (on the order of a few percent) are often acceptable without significant accuracy loss. Indeed, as noted in <a href=\"https://huggingface.co/blog/moe\">Mixture-of-Experts Explained</a> by Hugging Face (2023), token dropping may serve as a <strong>regularizer</strong>, reducing over-specialization of experts and improving generalization in some cases.</li>\n  <li>However, very high drop rates (e.g., <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-208-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi><mo>&amp;gt;</mo><mn>5</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1518\" style=\"width: 2.451em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.98em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1519\"><span class=\"mi\" id=\"MathJax-Span-1520\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1521\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-1522\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">5</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi><mo>&gt;</mo><mn>5</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-208\">r > 5%-10%</script>) can degrade performance since many tokens entirely skip the expert layer. This phenomenon reduces the overall model capacity utilization and weakens specialization, as fewer tokens contribute to expert learning.</li>\n  <li>Monitoring <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-209-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1523\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1524\"><span class=\"mi\" id=\"MathJax-Span-1525\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-209\">r</script> throughout training is thus critical. Modern MoE implementations, such as <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), emphasize maintaining a low drop rate (typically &lt;1%) to ensure both high throughput and effective expert utilization. Balancing the trade-off between efficiency (from sparse activation) and expressivity (from full token coverage) is an essential aspect of MoE optimization.</li>\n</ul>",
    "contentMarkdown": "*   Empirical results in sparse expert models indicate that modest drop rates (on the order of a few percent) are often acceptable without significant accuracy loss. Indeed, as noted in [Mixture-of-Experts Explained](https://huggingface.co/blog/moe) by Hugging Face (2023), token dropping may serve as a **regularizer**, reducing over-specialization of experts and improving generalization in some cases.\n*   However, very high drop rates (e.g., r\\>5r\\>5r > 5%-10%) can degrade performance since many tokens entirely skip the expert layer. This phenomenon reduces the overall model capacity utilization and weakens specialization, as fewer tokens contribute to expert learning.\n*   Monitoring rrr throughout training is thus critical. Modern MoE implementations, such as [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), emphasize maintaining a low drop rate (typically <1%) to ensure both high throughput and effective expert utilization. Balancing the trade-off between efficiency (from sparse activation) and expressivity (from full token coverage) is an essential aspect of MoE optimization.",
    "contentLength": 4011,
    "wordCount": 150,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#drop-rate-and-model-quality"
  },
  {
    "id": "ai-mixture-of-experts-mitigation-and-handling-strategies-24",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Mitigation and Handling Strategies",
    "order": 24,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p>While token dropping can act as a mild form of regularization, excessive dropping severely limits model utilization and stability. To mitigate this, researchers have developed architectural, algorithmic, and systems-level strategies to manage overflow and improve routing robustness. According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, the objective is to maintain token drop rates below 1% while preserving sparse activation efficiency.</p>\n  </li>\n  <li>\n    <p>In summary, token dropping is both a <strong>symptom</strong> of routing imbalance and a <strong>design variable</strong> in MoE systems. Adjusting the capacity factor, improving routing regularization, adopting rerouting or adaptive capacity mechanisms, and monitoring drop statistics are key to controlling it. As observed across works from <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a> by Shazeer et al. (2017) through <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021) to <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference</a> by He et al. (2025), the field has evolved from simple token dropping heuristics to sophisticated dynamic capacity control strategies that ensure high utilization and stable large-scale performance.</p>\n  </li>\n</ul>\n<p>While token dropping can act as a mild form of regularization, excessive dropping severely limits model utilization and stability. To mitigate this, researchers have developed architectural, algorithmic, and systems-level strategies to manage overflow and improve routing robustness. According to <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, the objective is to maintain token drop rates below 1% while preserving sparse activation efficiency.</p>\n<p>In summary, token dropping is both a <strong>symptom</strong> of routing imbalance and a <strong>design variable</strong> in MoE systems. Adjusting the capacity factor, improving routing regularization, adopting rerouting or adaptive capacity mechanisms, and monitoring drop statistics are key to controlling it. As observed across works from <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a> by Shazeer et al. (2017) through <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021) to <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference</a> by He et al. (2025), the field has evolved from simple token dropping heuristics to sophisticated dynamic capacity control strategies that ensure high utilization and stable large-scale performance.</p>\n<h4 id=\"increasing-the-capacity-factor-alpha\">Increasing the Capacity Factor (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-210-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1526\" style=\"width: 0.752em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.627em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.585em, 1000.63em, 2.294em, -999.998em); top: -2.165em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1527\"><span class=\"mi\" id=\"MathJax-Span-1528\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.169em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.653em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-210\">\\alpha</script>)</h4>\n<ul>\n  <li>\n    <p>The most straightforward method to mitigate token dropping is to increase the <strong>capacity factor</strong> (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-211-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1529\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1530\"><span class=\"mi\" id=\"MathJax-Span-1531\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-211\">\\alpha</script>) in the expert capacity equation:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-212-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>&amp;#x00D7;</mo><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1532\" style=\"width: 5.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.638em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1004.64em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1533\"><span class=\"mi\" id=\"MathJax-Span-1534\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1535\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1536\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-1537\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.362em;\"><span class=\"mi\" id=\"MathJax-Span-1538\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.84em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.836em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1539\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-1540\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mfrac><mi>T</mi><mi>N</mi></mfrac><mo>×</mo><mi>α</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-212\">C = \\frac{T}{N} \\times \\alpha</script>\n  </li>\n  <li>\n    <p>By increasing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-213-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1541\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1542\"><span class=\"mi\" id=\"MathJax-Span-1543\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-213\">\\alpha</script>, each expert can process more tokens before reaching its capacity limit, effectively reducing the number of dropped tokens. In <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), capacity factors between 1.0 and 1.25 were found to provide an optimal trade-off between overflow rate and computational cost.</p>\n  </li>\n  <li>\n    <p>However, increasing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-214-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1544\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1545\"><span class=\"mi\" id=\"MathJax-Span-1546\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-214\">\\alpha</script> linearly raises memory and communication requirements, since more token-to-expert activations need to be stored and processed. Thus, while this approach directly reduces overflow, it must be balanced against hardware efficiency and training throughput.</p>\n  </li>\n  <li>\n    <p>Some follow-up works, such as <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2022) and <a href=\"https://arxiv.org/abs/2211.15841\">Dropless MoE (MegaBlocks)</a> by Gale et al. (2022), optimize this trade-off by dynamically adjusting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-215-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1547\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1548\"><span class=\"mi\" id=\"MathJax-Span-1549\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-215\">\\alpha</script> during training or by employing block-sparse matrix operations that maintain high utilization even with moderate capacity factors.</p>\n  </li>\n</ul>\n<p>The most straightforward method to mitigate token dropping is to increase the <strong>capacity factor</strong> (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-211-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1529\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1530\"><span class=\"mi\" id=\"MathJax-Span-1531\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-211\">\\alpha</script>) in the expert capacity equation:</p>\n<p>By increasing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-213-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1541\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1542\"><span class=\"mi\" id=\"MathJax-Span-1543\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-213\">\\alpha</script>, each expert can process more tokens before reaching its capacity limit, effectively reducing the number of dropped tokens. In <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), capacity factors between 1.0 and 1.25 were found to provide an optimal trade-off between overflow rate and computational cost.</p>\n<p>However, increasing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-214-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1544\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1545\"><span class=\"mi\" id=\"MathJax-Span-1546\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-214\">\\alpha</script> linearly raises memory and communication requirements, since more token-to-expert activations need to be stored and processed. Thus, while this approach directly reduces overflow, it must be balanced against hardware efficiency and training throughput.</p>\n<p>Some follow-up works, such as <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2022) and <a href=\"https://arxiv.org/abs/2211.15841\">Dropless MoE (MegaBlocks)</a> by Gale et al. (2022), optimize this trade-off by dynamically adjusting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-215-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1547\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1548\"><span class=\"mi\" id=\"MathJax-Span-1549\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-215\">\\alpha</script> during training or by employing block-sparse matrix operations that maintain high utilization even with moderate capacity factors.</p>\n<h4 id=\"auxiliary-load-balancing-loss\">Auxiliary Load-Balancing Loss</h4>\n<ul>\n  <li>\n    <p>Token dropping often results from uneven routing probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-216-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1550\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1551\"><span class=\"msubsup\" id=\"MathJax-Span-1552\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1553\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1554\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1555\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1556\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1557\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-216\">p_i(x)</script> across experts. To mitigate this imbalance, <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a> by Shazeer et al. (2017) introduced an <strong>auxiliary load-balancing loss</strong> designed to equalize expert utilization and prevent overload. The formulation is given as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-217-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub><mo>=</mo><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1558\" style=\"width: 9.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.867em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1007.87em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1559\"><span class=\"msubsup\" id=\"MathJax-Span-1560\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1561\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-1562\"><span class=\"mrow\" id=\"MathJax-Span-1563\"><span class=\"mtext\" id=\"MathJax-Span-1564\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1565\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-1566\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-1567\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1568\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-1569\"><span class=\"mrow\" id=\"MathJax-Span-1570\"><span class=\"mi\" id=\"MathJax-Span-1571\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1572\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1573\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-1574\"><span class=\"mrow\" id=\"MathJax-Span-1575\"><span class=\"mi\" id=\"MathJax-Span-1576\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1577\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1578\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1579\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-1580\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1581\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1582\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub><mo>=</mo><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-217\">L_{\\text{balance}} = N \\sum_{i=1}^{N} f_i p_i</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-218-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1583\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1584\"><span class=\"msubsup\" id=\"MathJax-Span-1585\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1586\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1587\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-218\">f_i</script> represents the observed fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-219-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1588\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1589\"><span class=\"mi\" id=\"MathJax-Span-1590\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-219\">i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-220-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1591\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1592\"><span class=\"msubsup\" id=\"MathJax-Span-1593\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1594\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1595\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-220\">p_i</script> is the mean gating probability for that expert.</li>\n      <li>This term penalizes both underutilized and overutilized experts, encouraging the router to maintain an even distribution of token assignments.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This auxiliary objective was later refined in <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> and <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), both of which demonstrated that incorporating a load-balancing term significantly reduces token overflow and stabilizes convergence during large-scale pretraining.</p>\n  </li>\n  <li>\n    <p>Empirical studies in these models found that tuning the balancing coefficient (typically denoted <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-221-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1596\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1597\"><span class=\"mi\" id=\"MathJax-Span-1598\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-221\">\\lambda</script> in the total loss function <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-222-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mo>=</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>task</mtext></mrow></msub><mo>+</mo><mi>&amp;#x03BB;</mi><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1599\" style=\"width: 9.898em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.232em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.23em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1600\"><span class=\"texatom\" id=\"MathJax-Span-1601\"><span class=\"mrow\" id=\"MathJax-Span-1602\"><span class=\"mi\" id=\"MathJax-Span-1603\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span class=\"mo\" id=\"MathJax-Span-1604\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1605\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1606\"><span class=\"mrow\" id=\"MathJax-Span-1607\"><span class=\"mi\" id=\"MathJax-Span-1608\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-1609\"><span class=\"mrow\" id=\"MathJax-Span-1610\"><span class=\"mtext\" id=\"MathJax-Span-1611\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">task</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1612\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-1613\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">λ</span><span class=\"msubsup\" id=\"MathJax-Span-1614\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1615\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-1616\"><span class=\"mrow\" id=\"MathJax-Span-1617\"><span class=\"mtext\" id=\"MathJax-Span-1618\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mo>=</mo><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>task</mtext></mrow></msub><mo>+</mo><mi>λ</mi><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-222\">\\mathcal{L} = \\mathcal{L}_{\\text{task}} + \\lambda L_{\\text{balance}}</script>) can control how aggressively the model enforces equalized load. A moderate <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-223-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1619\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1620\"><span class=\"mi\" id=\"MathJax-Span-1621\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-223\">\\lambda</script> ensures smooth expert utilization without over-regularizing routing diversity.</p>\n  </li>\n  <li>\n    <p>More recent works, such as <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks (Dropless MoE)</a> by Gale et al. (2022), demonstrate that efficient block-sparse implementations can achieve implicit load balance without relying on explicit loss regularization, hinting at a new direction for scalable, balance-aware MoE designs.</p>\n  </li>\n</ul>\n<p>Token dropping often results from uneven routing probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-216-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1550\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1551\"><span class=\"msubsup\" id=\"MathJax-Span-1552\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1553\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1554\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1555\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1556\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1557\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-216\">p_i(x)</script> across experts. To mitigate this imbalance, <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated MoE</a> by Shazeer et al. (2017) introduced an <strong>auxiliary load-balancing loss</strong> designed to equalize expert utilization and prevent overload. The formulation is given as:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-218-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1583\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1584\"><span class=\"msubsup\" id=\"MathJax-Span-1585\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1586\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1587\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-218\">f_i</script> represents the observed fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-219-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1588\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1589\"><span class=\"mi\" id=\"MathJax-Span-1590\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-219\">i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-220-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1591\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1592\"><span class=\"msubsup\" id=\"MathJax-Span-1593\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1594\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1595\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-220\">p_i</script> is the mean gating probability for that expert.</li>\n      <li>This term penalizes both underutilized and overutilized experts, encouraging the router to maintain an even distribution of token assignments.</li>\n    </ul>\n<p>This auxiliary objective was later refined in <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> and <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), both of which demonstrated that incorporating a load-balancing term significantly reduces token overflow and stabilizes convergence during large-scale pretraining.</p>\n<p>Empirical studies in these models found that tuning the balancing coefficient (typically denoted <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-221-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1596\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1597\"><span class=\"mi\" id=\"MathJax-Span-1598\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-221\">\\lambda</script> in the total loss function <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-222-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mo>=</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>task</mtext></mrow></msub><mo>+</mo><mi>&amp;#x03BB;</mi><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1599\" style=\"width: 9.898em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.232em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1008.23em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1600\"><span class=\"texatom\" id=\"MathJax-Span-1601\"><span class=\"mrow\" id=\"MathJax-Span-1602\"><span class=\"mi\" id=\"MathJax-Span-1603\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span class=\"mo\" id=\"MathJax-Span-1604\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1605\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1606\"><span class=\"mrow\" id=\"MathJax-Span-1607\"><span class=\"mi\" id=\"MathJax-Span-1608\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-1609\"><span class=\"mrow\" id=\"MathJax-Span-1610\"><span class=\"mtext\" id=\"MathJax-Span-1611\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">task</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1612\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-1613\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">λ</span><span class=\"msubsup\" id=\"MathJax-Span-1614\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1615\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-1616\"><span class=\"mrow\" id=\"MathJax-Span-1617\"><span class=\"mtext\" id=\"MathJax-Span-1618\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mo>=</mo><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>task</mtext></mrow></msub><mo>+</mo><mi>λ</mi><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-222\">\\mathcal{L} = \\mathcal{L}_{\\text{task}} + \\lambda L_{\\text{balance}}</script>) can control how aggressively the model enforces equalized load. A moderate <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-223-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1619\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1620\"><span class=\"mi\" id=\"MathJax-Span-1621\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-223\">\\lambda</script> ensures smooth expert utilization without over-regularizing routing diversity.</p>\n<p>More recent works, such as <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks (Dropless MoE)</a> by Gale et al. (2022), demonstrate that efficient block-sparse implementations can achieve implicit load balance without relying on explicit loss regularization, hinting at a new direction for scalable, balance-aware MoE designs.</p>\n<h4 id=\"rerouting-instead-of-dropping\">Rerouting Instead of Dropping</h4>\n<ul>\n  <li>\n    <p>Instead of discarding overflow tokens when experts reach capacity, modern MoE systems employ <strong>rerouting mechanisms</strong> to preserve computation and reduce inefficiency. This approach ensures that nearly all tokens are processed by some expert, maintaining both expressivity and training stability.</p>\n  </li>\n  <li>\n    <p>In <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), the <strong>Expert Choice (EC) routing</strong> paradigm inverts the conventional routing logic — instead of tokens choosing experts, experts select which tokens they process. This inversion naturally balances expert workloads and significantly reduces token drop rates, as each expert autonomously regulates its assigned token set. The result is better specialization and load uniformity without requiring hard capacity truncation.</p>\n  </li>\n  <li>\n    <p>Similarly, <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) introduces <strong>capacity-aware rerouting</strong>, an inference-time mechanism designed to address latency bottlenecks in distributed systems. When an expert approaches its capacity threshold, excess tokens are dynamically rerouted to less-loaded experts rather than being dropped. This adaptive routing maintains full expert coverage and stabilizes latency across large-scale deployments.</p>\n  </li>\n  <li>\n    <p>Both of these strategies share a common goal: ensuring that <strong>no token is wasted</strong> due to static capacity constraints. Rerouting transforms token dropping from a rigid failure case into a flexible balancing mechanism — one that adapts to runtime conditions and preserves computational efficiency.</p>\n  </li>\n</ul>\n<p>Instead of discarding overflow tokens when experts reach capacity, modern MoE systems employ <strong>rerouting mechanisms</strong> to preserve computation and reduce inefficiency. This approach ensures that nearly all tokens are processed by some expert, maintaining both expressivity and training stability.</p>\n<p>In <a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), the <strong>Expert Choice (EC) routing</strong> paradigm inverts the conventional routing logic — instead of tokens choosing experts, experts select which tokens they process. This inversion naturally balances expert workloads and significantly reduces token drop rates, as each expert autonomously regulates its assigned token set. The result is better specialization and load uniformity without requiring hard capacity truncation.</p>\n<p>Similarly, <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) introduces <strong>capacity-aware rerouting</strong>, an inference-time mechanism designed to address latency bottlenecks in distributed systems. When an expert approaches its capacity threshold, excess tokens are dynamically rerouted to less-loaded experts rather than being dropped. This adaptive routing maintains full expert coverage and stabilizes latency across large-scale deployments.</p>\n<p>Both of these strategies share a common goal: ensuring that <strong>no token is wasted</strong> due to static capacity constraints. Rerouting transforms token dropping from a rigid failure case into a flexible balancing mechanism — one that adapts to runtime conditions and preserves computational efficiency.</p>\n<h4 id=\"dynamic-capacity-allocation\">Dynamic Capacity Allocation</h4>\n<ul>\n  <li>\n    <p>Traditional MoE implementations assign each expert a <strong>fixed capacity</strong> per batch, defined by the capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-224-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1622\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1623\"><span class=\"mi\" id=\"MathJax-Span-1624\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-224\">\\alpha</script>. However, fixed allocation can lead to inefficiency when routing distributions fluctuate — some experts may overflow while others remain underutilized. To address this, <strong>dynamic capacity allocation</strong> strategies adapt expert capacity in real time based on observed token load.</p>\n  </li>\n  <li>\n    <p>In <a href=\"https://arxiv.org/abs/2203.12533\">Pathways: Asynchronous Distributed Training of Large Sparse Models</a> by Barham et al. (2022), Google Research introduced a <strong>runtime feedback loop</strong> that dynamically redistributes capacity among experts. Experts that experience frequent overload receive more capacity in subsequent iterations, while underused experts are scaled down. This adaptive approach maintains throughput and reduces the number of dropped tokens without manually tuning <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-225-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1625\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1626\"><span class=\"mi\" id=\"MathJax-Span-1627\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-225\">\\alpha</script> for each expert.</p>\n  </li>\n  <li>\n    <p>More recently, dynamic mechanisms have been integrated with routing-aware training. For instance, <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks: Efficient Sparse Training with Mixture-of-Experts</a> by Gale et al. (2022) combines block-sparse matrix multiplication with adaptive expert assignment. Here, the system tracks utilization across distributed GPUs and reorganizes token blocks such that computational resources are balanced across experts automatically, eliminating manual capacity configuration.</p>\n  </li>\n  <li>\n    <p>The broader implication of this approach is that <strong>capacity becomes a learned or emergent property</strong> rather than a fixed hyperparameter. By coupling routing statistics (e.g., token density per expert) with adaptive allocation, the model learns to self-regulate load distribution during both training and inference.</p>\n  </li>\n  <li>\n    <p>Mathematically, the dynamic capacity update can be approximated as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-226-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msubsup><mi>C</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><mo>=</mo><msubsup><mi>C</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><mo>+</mo><mi>&amp;#x03B7;</mi><mo>,</mo><mo stretchy=&quot;false&quot;>(</mo><msubsup><mi>T</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><mo>&amp;#x2212;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>T</mi><mo stretchy=&quot;false&quot;>&amp;#x00AF;</mo></mover></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1628\" style=\"width: 14.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.773em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.992em, 1011.72em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1629\"><span class=\"msubsup\" id=\"MathJax-Span-1630\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1631\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.62em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1632\"><span class=\"mrow\" id=\"MathJax-Span-1633\"><span class=\"mo\" id=\"MathJax-Span-1634\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1635\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1636\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">+</span><span class=\"mn\" id=\"MathJax-Span-1637\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-1638\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-1639\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1640\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1641\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1642\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.78em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1643\"><span class=\"mrow\" id=\"MathJax-Span-1644\"><span class=\"mo\" id=\"MathJax-Span-1645\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1646\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1647\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-1648\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1649\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-1650\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">η</span><span class=\"mo\" id=\"MathJax-Span-1651\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1652\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1653\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1654\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.78em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1655\"><span class=\"mrow\" id=\"MathJax-Span-1656\"><span class=\"mo\" id=\"MathJax-Span-1657\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1658\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1659\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1660\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1661\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"msubsup\" id=\"MathJax-Span-1662\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.023em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1663\"><span class=\"mrow\" id=\"MathJax-Span-1664\"><span class=\"munderover\" id=\"MathJax-Span-1665\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1666\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.232em, 1000.32em, 3.596em, -999.997em); top: -4.268em; left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-1667\" style=\"font-family: STIXGeneral-Regular;\">¯</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.581em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-1668\"><span class=\"mrow\" id=\"MathJax-Span-1669\"><span class=\"mo\" id=\"MathJax-Span-1670\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1671\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1672\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1673\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msubsup><mi>C</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow></msubsup><mo>=</mo><msubsup><mi>C</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><mo>+</mo><mi>η</mi><mo>,</mo><mo stretchy=\"false\">(</mo><msubsup><mi>T</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><mo>−</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mover><mi>T</mi><mo stretchy=\"false\">¯</mo></mover></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msup><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-226\">C_i^{(t+1)} = C_i^{(t)} + \\eta , (T_i^{(t)} - \\bar{T}^{(t)})</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-227-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>C</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1674\" style=\"width: 1.826em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.51em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1675\"><span class=\"msubsup\" id=\"MathJax-Span-1676\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1677\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.78em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1678\"><span class=\"mrow\" id=\"MathJax-Span-1679\"><span class=\"mo\" id=\"MathJax-Span-1680\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1681\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1682\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-1683\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>C</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-227\">C_i^{(t)}</script> is the current capacity of expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-228-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1684\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1685\"><span class=\"mi\" id=\"MathJax-Span-1686\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-228\">i</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-229-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>T</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1687\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.46em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1688\"><span class=\"msubsup\" id=\"MathJax-Span-1689\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1690\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.78em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1691\"><span class=\"mrow\" id=\"MathJax-Span-1692\"><span class=\"mo\" id=\"MathJax-Span-1693\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1694\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1695\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1696\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>T</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-229\">T_i^{(t)}</script> is its token load at step <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-230-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1697\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1698\"><span class=\"mi\" id=\"MathJax-Span-1699\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-230\">t</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-231-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>T</mi><mo stretchy=&quot;false&quot;>&amp;#x00AF;</mo></mover></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1700\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.94em, 1001.41em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1701\"><span class=\"msubsup\" id=\"MathJax-Span-1702\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.023em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1703\"><span class=\"mrow\" id=\"MathJax-Span-1704\"><span class=\"munderover\" id=\"MathJax-Span-1705\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1706\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.232em, 1000.32em, 3.596em, -999.997em); top: -4.268em; left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-1707\" style=\"font-family: STIXGeneral-Regular;\">¯</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.581em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-1708\"><span class=\"mrow\" id=\"MathJax-Span-1709\"><span class=\"mo\" id=\"MathJax-Span-1710\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1711\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1712\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mrow class=\"MJX-TeXAtom-ORD\"><mover><mi>T</mi><mo stretchy=\"false\">¯</mo></mover></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-231\">\\bar{T}^{(t)}</script> is the average token load across experts, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-232-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B7;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1713\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1714\"><span class=\"mi\" id=\"MathJax-Span-1715\" style=\"font-family: STIXGeneral-Italic;\">η</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>η</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-232\">\\eta</script> is a learning rate controlling how quickly capacity adapts.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This adaptive strategy enables MoE architectures to maintain high utilization and low drop rates under varying input distributions, marking a step toward <strong>self-optimizing expert architectures</strong> that can flexibly respond to training dynamics and hardware conditions.</p>\n  </li>\n</ul>\n<p>Traditional MoE implementations assign each expert a <strong>fixed capacity</strong> per batch, defined by the capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-224-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1622\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1623\"><span class=\"mi\" id=\"MathJax-Span-1624\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-224\">\\alpha</script>. However, fixed allocation can lead to inefficiency when routing distributions fluctuate — some experts may overflow while others remain underutilized. To address this, <strong>dynamic capacity allocation</strong> strategies adapt expert capacity in real time based on observed token load.</p>\n<p>In <a href=\"https://arxiv.org/abs/2203.12533\">Pathways: Asynchronous Distributed Training of Large Sparse Models</a> by Barham et al. (2022), Google Research introduced a <strong>runtime feedback loop</strong> that dynamically redistributes capacity among experts. Experts that experience frequent overload receive more capacity in subsequent iterations, while underused experts are scaled down. This adaptive approach maintains throughput and reduces the number of dropped tokens without manually tuning <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-225-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1625\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1626\"><span class=\"mi\" id=\"MathJax-Span-1627\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-225\">\\alpha</script> for each expert.</p>\n<p>More recently, dynamic mechanisms have been integrated with routing-aware training. For instance, <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks: Efficient Sparse Training with Mixture-of-Experts</a> by Gale et al. (2022) combines block-sparse matrix multiplication with adaptive expert assignment. Here, the system tracks utilization across distributed GPUs and reorganizes token blocks such that computational resources are balanced across experts automatically, eliminating manual capacity configuration.</p>\n<p>The broader implication of this approach is that <strong>capacity becomes a learned or emergent property</strong> rather than a fixed hyperparameter. By coupling routing statistics (e.g., token density per expert) with adaptive allocation, the model learns to self-regulate load distribution during both training and inference.</p>\n<p>Mathematically, the dynamic capacity update can be approximated as:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-227-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>C</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1674\" style=\"width: 1.826em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.51em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1675\"><span class=\"msubsup\" id=\"MathJax-Span-1676\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1677\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.78em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1678\"><span class=\"mrow\" id=\"MathJax-Span-1679\"><span class=\"mo\" id=\"MathJax-Span-1680\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1681\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1682\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-1683\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>C</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-227\">C_i^{(t)}</script> is the current capacity of expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-228-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1684\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1685\"><span class=\"mi\" id=\"MathJax-Span-1686\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-228\">i</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-229-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>T</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1687\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.46em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1688\"><span class=\"msubsup\" id=\"MathJax-Span-1689\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1690\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.78em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1691\"><span class=\"mrow\" id=\"MathJax-Span-1692\"><span class=\"mo\" id=\"MathJax-Span-1693\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1694\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1695\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-1696\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>T</mi><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-229\">T_i^{(t)}</script> is its token load at step <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-230-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1697\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1698\"><span class=\"mi\" id=\"MathJax-Span-1699\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-230\">t</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-231-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>T</mi><mo stretchy=&quot;false&quot;>&amp;#x00AF;</mo></mover></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1700\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.94em, 1001.41em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1701\"><span class=\"msubsup\" id=\"MathJax-Span-1702\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.023em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1703\"><span class=\"mrow\" id=\"MathJax-Span-1704\"><span class=\"munderover\" id=\"MathJax-Span-1705\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1706\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.232em, 1000.32em, 3.596em, -999.997em); top: -4.268em; left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-1707\" style=\"font-family: STIXGeneral-Regular;\">¯</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.581em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-1708\"><span class=\"mrow\" id=\"MathJax-Span-1709\"><span class=\"mo\" id=\"MathJax-Span-1710\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1711\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1712\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mrow class=\"MJX-TeXAtom-ORD\"><mover><mi>T</mi><mo stretchy=\"false\">¯</mo></mover></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-231\">\\bar{T}^{(t)}</script> is the average token load across experts, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-232-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B7;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1713\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1714\"><span class=\"mi\" id=\"MathJax-Span-1715\" style=\"font-family: STIXGeneral-Italic;\">η</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>η</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-232\">\\eta</script> is a learning rate controlling how quickly capacity adapts.</li>\n    </ul>\n<p>This adaptive strategy enables MoE architectures to maintain high utilization and low drop rates under varying input distributions, marking a step toward <strong>self-optimizing expert architectures</strong> that can flexibly respond to training dynamics and hardware conditions.</p>",
    "contentMarkdown": "*   While token dropping can act as a mild form of regularization, excessive dropping severely limits model utilization and stability. To mitigate this, researchers have developed architectural, algorithmic, and systems-level strategies to manage overflow and improve routing robustness. According to [Switch Transformer](https://arxiv.org/abs/2101.03961), the objective is to maintain token drop rates below 1% while preserving sparse activation efficiency.\n    \n*   In summary, token dropping is both a **symptom** of routing imbalance and a **design variable** in MoE systems. Adjusting the capacity factor, improving routing regularization, adopting rerouting or adaptive capacity mechanisms, and monitoring drop statistics are key to controlling it. As observed across works from [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) through [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021) to [Capacity-Aware Inference](https://arxiv.org/abs/2503.05066) by He et al. (2025), the field has evolved from simple token dropping heuristics to sophisticated dynamic capacity control strategies that ensure high utilization and stable large-scale performance.\n    \n\nWhile token dropping can act as a mild form of regularization, excessive dropping severely limits model utilization and stability. To mitigate this, researchers have developed architectural, algorithmic, and systems-level strategies to manage overflow and improve routing robustness. According to [Switch Transformer](https://arxiv.org/abs/2101.03961), the objective is to maintain token drop rates below 1% while preserving sparse activation efficiency.\n\nIn summary, token dropping is both a **symptom** of routing imbalance and a **design variable** in MoE systems. Adjusting the capacity factor, improving routing regularization, adopting rerouting or adaptive capacity mechanisms, and monitoring drop statistics are key to controlling it. As observed across works from [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) through [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021) to [Capacity-Aware Inference](https://arxiv.org/abs/2503.05066) by He et al. (2025), the field has evolved from simple token dropping heuristics to sophisticated dynamic capacity control strategies that ensure high utilization and stable large-scale performance.\n\n#### Increasing the Capacity Factor (αα\\\\alpha)\n\n*   The most straightforward method to mitigate token dropping is to increase the **capacity factor** (αα\\\\alpha) in the expert capacity equation:\n    \n    C\\=TN×αC\\=TN×α\n    \n    C = \\\\frac{T}{N} \\\\times \\\\alpha\n*   By increasing αα\\\\alpha, each expert can process more tokens before reaching its capacity limit, effectively reducing the number of dropped tokens. In [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), capacity factors between 1.0 and 1.25 were found to provide an optimal trade-off between overflow rate and computational cost.\n    \n*   However, increasing αα\\\\alpha linearly raises memory and communication requirements, since more token-to-expert activations need to be stored and processed. Thus, while this approach directly reduces overflow, it must be balanced against hardware efficiency and training throughput.\n    \n*   Some follow-up works, such as [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2022) and [Dropless MoE (MegaBlocks)](https://arxiv.org/abs/2211.15841) by Gale et al. (2022), optimize this trade-off by dynamically adjusting αα\\\\alpha during training or by employing block-sparse matrix operations that maintain high utilization even with moderate capacity factors.\n    \n\nThe most straightforward method to mitigate token dropping is to increase the **capacity factor** (αα\\\\alpha) in the expert capacity equation:\n\nBy increasing αα\\\\alpha, each expert can process more tokens before reaching its capacity limit, effectively reducing the number of dropped tokens. In [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), capacity factors between 1.0 and 1.25 were found to provide an optimal trade-off between overflow rate and computational cost.\n\nHowever, increasing αα\\\\alpha linearly raises memory and communication requirements, since more token-to-expert activations need to be stored and processed. Thus, while this approach directly reduces overflow, it must be balanced against hardware efficiency and training throughput.\n\nSome follow-up works, such as [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2022) and [Dropless MoE (MegaBlocks)](https://arxiv.org/abs/2211.15841) by Gale et al. (2022), optimize this trade-off by dynamically adjusting αα\\\\alpha during training or by employing block-sparse matrix operations that maintain high utilization even with moderate capacity factors.\n\n#### Auxiliary Load-Balancing Loss\n\n*   Token dropping often results from uneven routing probabilities pi(x)pi(x)p\\_i(x) across experts. To mitigate this imbalance, [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) introduced an **auxiliary load-balancing loss** designed to equalize expert utilization and prevent overload. The formulation is given as:\n    \n    Lbalance\\=N∑i\\=1NfipiLbalance\\=N∑i\\=1Nfipi\n    \n    L\\_{\\\\text{balance}} = N \\\\sum\\_{i=1}^{N} f\\_i p\\_i\n    *   where fifif\\_i represents the observed fraction of tokens routed to expert iii and pipip\\_i is the mean gating probability for that expert.\n    *   This term penalizes both underutilized and overutilized experts, encouraging the router to maintain an even distribution of token assignments.\n*   This auxiliary objective was later refined in [GShard](https://arxiv.org/abs/2006.16668) and [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), both of which demonstrated that incorporating a load-balancing term significantly reduces token overflow and stabilizes convergence during large-scale pretraining.\n    \n*   Empirical studies in these models found that tuning the balancing coefficient (typically denoted λλ\\\\lambda in the total loss function \\=task+λLbalanceL\\=Ltask+λLbalance\\\\mathcal{L} = \\\\mathcal{L}\\_{\\\\text{task}} + \\\\lambda L\\_{\\\\text{balance}}) can control how aggressively the model enforces equalized load. A moderate λλ\\\\lambda ensures smooth expert utilization without over-regularizing routing diversity.\n    \n*   More recent works, such as [MegaBlocks (Dropless MoE)](https://arxiv.org/abs/2211.15841) by Gale et al. (2022), demonstrate that efficient block-sparse implementations can achieve implicit load balance without relying on explicit loss regularization, hinting at a new direction for scalable, balance-aware MoE designs.\n    \n\nToken dropping often results from uneven routing probabilities pi(x)pi(x)p\\_i(x) across experts. To mitigate this imbalance, [Sparsely-Gated MoE](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) introduced an **auxiliary load-balancing loss** designed to equalize expert utilization and prevent overload. The formulation is given as:\n\n*   where fifif\\_i represents the observed fraction of tokens routed to expert iii and pipip\\_i is the mean gating probability for that expert.\n*   This term penalizes both underutilized and overutilized experts, encouraging the router to maintain an even distribution of token assignments.\n\nThis auxiliary objective was later refined in [GShard](https://arxiv.org/abs/2006.16668) and [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), both of which demonstrated that incorporating a load-balancing term significantly reduces token overflow and stabilizes convergence during large-scale pretraining.\n\nEmpirical studies in these models found that tuning the balancing coefficient (typically denoted λλ\\\\lambda in the total loss function \\=task+λLbalanceL\\=Ltask+λLbalance\\\\mathcal{L} = \\\\mathcal{L}\\_{\\\\text{task}} + \\\\lambda L\\_{\\\\text{balance}}) can control how aggressively the model enforces equalized load. A moderate λλ\\\\lambda ensures smooth expert utilization without over-regularizing routing diversity.\n\nMore recent works, such as [MegaBlocks (Dropless MoE)](https://arxiv.org/abs/2211.15841) by Gale et al. (2022), demonstrate that efficient block-sparse implementations can achieve implicit load balance without relying on explicit loss regularization, hinting at a new direction for scalable, balance-aware MoE designs.\n\n#### Rerouting Instead of Dropping\n\n*   Instead of discarding overflow tokens when experts reach capacity, modern MoE systems employ **rerouting mechanisms** to preserve computation and reduce inefficiency. This approach ensures that nearly all tokens are processed by some expert, maintaining both expressivity and training stability.\n    \n*   In [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022), the **Expert Choice (EC) routing** paradigm inverts the conventional routing logic — instead of tokens choosing experts, experts select which tokens they process. This inversion naturally balances expert workloads and significantly reduces token drop rates, as each expert autonomously regulates its assigned token set. The result is better specialization and load uniformity without requiring hard capacity truncation.\n    \n*   Similarly, [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) introduces **capacity-aware rerouting**, an inference-time mechanism designed to address latency bottlenecks in distributed systems. When an expert approaches its capacity threshold, excess tokens are dynamically rerouted to less-loaded experts rather than being dropped. This adaptive routing maintains full expert coverage and stabilizes latency across large-scale deployments.\n    \n*   Both of these strategies share a common goal: ensuring that **no token is wasted** due to static capacity constraints. Rerouting transforms token dropping from a rigid failure case into a flexible balancing mechanism — one that adapts to runtime conditions and preserves computational efficiency.\n    \n\nInstead of discarding overflow tokens when experts reach capacity, modern MoE systems employ **rerouting mechanisms** to preserve computation and reduce inefficiency. This approach ensures that nearly all tokens are processed by some expert, maintaining both expressivity and training stability.\n\nIn [Mixture-of-Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022), the **Expert Choice (EC) routing** paradigm inverts the conventional routing logic — instead of tokens choosing experts, experts select which tokens they process. This inversion naturally balances expert workloads and significantly reduces token drop rates, as each expert autonomously regulates its assigned token set. The result is better specialization and load uniformity without requiring hard capacity truncation.\n\nSimilarly, [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) introduces **capacity-aware rerouting**, an inference-time mechanism designed to address latency bottlenecks in distributed systems. When an expert approaches its capacity threshold, excess tokens are dynamically rerouted to less-loaded experts rather than being dropped. This adaptive routing maintains full expert coverage and stabilizes latency across large-scale deployments.\n\nBoth of these strategies share a common goal: ensuring that **no token is wasted** due to static capacity constraints. Rerouting transforms token dropping from a rigid failure case into a flexible balancing mechanism — one that adapts to runtime conditions and preserves computational efficiency.\n\n#### Dynamic Capacity Allocation\n\n*   Traditional MoE implementations assign each expert a **fixed capacity** per batch, defined by the capacity factor αα\\\\alpha. However, fixed allocation can lead to inefficiency when routing distributions fluctuate — some experts may overflow while others remain underutilized. To address this, **dynamic capacity allocation** strategies adapt expert capacity in real time based on observed token load.\n    \n*   In [Pathways: Asynchronous Distributed Training of Large Sparse Models](https://arxiv.org/abs/2203.12533) by Barham et al. (2022), Google Research introduced a **runtime feedback loop** that dynamically redistributes capacity among experts. Experts that experience frequent overload receive more capacity in subsequent iterations, while underused experts are scaled down. This adaptive approach maintains throughput and reduces the number of dropped tokens without manually tuning αα\\\\alpha for each expert.\n    \n*   More recently, dynamic mechanisms have been integrated with routing-aware training. For instance, [MegaBlocks: Efficient Sparse Training with Mixture-of-Experts](https://arxiv.org/abs/2211.15841) by Gale et al. (2022) combines block-sparse matrix multiplication with adaptive expert assignment. Here, the system tracks utilization across distributed GPUs and reorganizes token blocks such that computational resources are balanced across experts automatically, eliminating manual capacity configuration.\n    \n*   The broader implication of this approach is that **capacity becomes a learned or emergent property** rather than a fixed hyperparameter. By coupling routing statistics (e.g., token density per expert) with adaptive allocation, the model learns to self-regulate load distribution during both training and inference.\n    \n*   Mathematically, the dynamic capacity update can be approximated as:\n    \n    C(t+1)i\\=C(t)i+η,(T(t)i−T¯(t))Ci(t+1)\\=Ci(t)+η,(Ti(t)−T¯(t))\n    \n    C\\_i^{(t+1)} = C\\_i^{(t)} + \\\\eta , (T\\_i^{(t)} - \\\\bar{T}^{(t)})\n    *   where C(t)iCi(t)C\\_i^{(t)} is the current capacity of expert iii, T(t)iTi(t)T\\_i^{(t)} is its token load at step ttt, T¯(t)T¯(t)\\\\bar{T}^{(t)} is the average token load across experts, and ηη\\\\eta is a learning rate controlling how quickly capacity adapts.\n*   This adaptive strategy enables MoE architectures to maintain high utilization and low drop rates under varying input distributions, marking a step toward **self-optimizing expert architectures** that can flexibly respond to training dynamics and hardware conditions.\n    \n\nTraditional MoE implementations assign each expert a **fixed capacity** per batch, defined by the capacity factor αα\\\\alpha. However, fixed allocation can lead to inefficiency when routing distributions fluctuate — some experts may overflow while others remain underutilized. To address this, **dynamic capacity allocation** strategies adapt expert capacity in real time based on observed token load.\n\nIn [Pathways: Asynchronous Distributed Training of Large Sparse Models](https://arxiv.org/abs/2203.12533) by Barham et al. (2022), Google Research introduced a **runtime feedback loop** that dynamically redistributes capacity among experts. Experts that experience frequent overload receive more capacity in subsequent iterations, while underused experts are scaled down. This adaptive approach maintains throughput and reduces the number of dropped tokens without manually tuning αα\\\\alpha for each expert.\n\nMore recently, dynamic mechanisms have been integrated with routing-aware training. For instance, [MegaBlocks: Efficient Sparse Training with Mixture-of-Experts](https://arxiv.org/abs/2211.15841) by Gale et al. (2022) combines block-sparse matrix multiplication with adaptive expert assignment. Here, the system tracks utilization across distributed GPUs and reorganizes token blocks such that computational resources are balanced across experts automatically, eliminating manual capacity configuration.\n\nThe broader implication of this approach is that **capacity becomes a learned or emergent property** rather than a fixed hyperparameter. By coupling routing statistics (e.g., token density per expert) with adaptive allocation, the model learns to self-regulate load distribution during both training and inference.\n\nMathematically, the dynamic capacity update can be approximated as:\n\n*   where C(t)iCi(t)C\\_i^{(t)} is the current capacity of expert iii, T(t)iTi(t)T\\_i^{(t)} is its token load at step ttt, T¯(t)T¯(t)\\\\bar{T}^{(t)} is the average token load across experts, and ηη\\\\eta is a learning rate controlling how quickly capacity adapts.\n\nThis adaptive strategy enables MoE architectures to maintain high utilization and low drop rates under varying input distributions, marking a step toward **self-optimizing expert architectures** that can flexibly respond to training dynamics and hardware conditions.",
    "contentLength": 106929,
    "wordCount": 2080,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mitigation-and-handling-strategies"
  },
  {
    "id": "ai-mixture-of-experts-token-priority-and-drop-policies-25",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Token Priority and Drop Policies",
    "order": 25,
    "orderInChapter": 7,
    "contentHtml": "<ul>\n  <li>\n    <p>Even when token overflow is unavoidable, <strong>drop policy design</strong> plays a critical role in determining which tokens are skipped and how gracefully the model handles overload. The choice of drop strategy can influence both performance and stability during training and inference.</p>\n  </li>\n  <li>\n    <p>The <strong>Switch Transformer</strong> model — <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021) — introduced the <strong>lowest-probability drop policy</strong>, in which tokens with the smallest gating probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-233-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1716\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1717\"><span class=\"msubsup\" id=\"MathJax-Span-1718\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1719\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1720\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1721\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1722\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1723\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-233\">p_i(x)</script> for a given expert are dropped first. This ensures that high-confidence tokens (those most relevant to the expert) are prioritized for computation, while low-confidence tokens pass through the residual pathway. This approach preserves the most informative activations, mitigating quality loss even under heavy load.</p>\n  </li>\n  <li>\n    <p>In contrast, earlier systems like <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated Mixture-of-Experts</a> by Shazeer et al. (2017) used a <strong>random drop</strong> mechanism — when an expert exceeded capacity, excess tokens were discarded at random. While simple to implement, this strategy introduced non-determinism and gradient noise, leading to less stable training and unpredictable load balancing.</p>\n  </li>\n  <li>\n    <p>Newer approaches incorporate <strong>adaptive drop policies</strong> informed by runtime load statistics. For instance, <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) employs latency-aware scheduling that prioritizes tokens based on both routing confidence and hardware availability. Tokens likely to cause straggler delays are deprioritized to ensure consistent inference latency across distributed systems.</p>\n  </li>\n  <li>\n    <p>These developments collectively demonstrate that token dropping is not a binary “keep or skip” operation, but rather a structured decision process. Properly designed drop policies preserve key activations, stabilize expert utilization, and ensure deterministic training dynamics — a critical property for reproducibility in large-scale distributed MoE systems.</p>\n  </li>\n</ul>\n<p>Even when token overflow is unavoidable, <strong>drop policy design</strong> plays a critical role in determining which tokens are skipped and how gracefully the model handles overload. The choice of drop strategy can influence both performance and stability during training and inference.</p>\n<p>The <strong>Switch Transformer</strong> model — <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021) — introduced the <strong>lowest-probability drop policy</strong>, in which tokens with the smallest gating probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-233-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1716\" style=\"width: 2.398em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.982em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.93em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1717\"><span class=\"msubsup\" id=\"MathJax-Span-1718\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1719\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1720\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1721\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1722\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1723\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-233\">p_i(x)</script> for a given expert are dropped first. This ensures that high-confidence tokens (those most relevant to the expert) are prioritized for computation, while low-confidence tokens pass through the residual pathway. This approach preserves the most informative activations, mitigating quality loss even under heavy load.</p>\n<p>In contrast, earlier systems like <a href=\"https://arxiv.org/abs/1701.06538\">Sparsely-Gated Mixture-of-Experts</a> by Shazeer et al. (2017) used a <strong>random drop</strong> mechanism — when an expert exceeded capacity, excess tokens were discarded at random. While simple to implement, this strategy introduced non-determinism and gradient noise, leading to less stable training and unpredictable load balancing.</p>\n<p>Newer approaches incorporate <strong>adaptive drop policies</strong> informed by runtime load statistics. For instance, <a href=\"https://arxiv.org/abs/2503.05066\">Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts</a> by He et al. (2025) employs latency-aware scheduling that prioritizes tokens based on both routing confidence and hardware availability. Tokens likely to cause straggler delays are deprioritized to ensure consistent inference latency across distributed systems.</p>\n<p>These developments collectively demonstrate that token dropping is not a binary “keep or skip” operation, but rather a structured decision process. Properly designed drop policies preserve key activations, stabilize expert utilization, and ensure deterministic training dynamics — a critical property for reproducibility in large-scale distributed MoE systems.</p>",
    "contentMarkdown": "*   Even when token overflow is unavoidable, **drop policy design** plays a critical role in determining which tokens are skipped and how gracefully the model handles overload. The choice of drop strategy can influence both performance and stability during training and inference.\n    \n*   The **Switch Transformer** model — [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021) — introduced the **lowest-probability drop policy**, in which tokens with the smallest gating probabilities pi(x)pi(x)p\\_i(x) for a given expert are dropped first. This ensures that high-confidence tokens (those most relevant to the expert) are prioritized for computation, while low-confidence tokens pass through the residual pathway. This approach preserves the most informative activations, mitigating quality loss even under heavy load.\n    \n*   In contrast, earlier systems like [Sparsely-Gated Mixture-of-Experts](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) used a **random drop** mechanism — when an expert exceeded capacity, excess tokens were discarded at random. While simple to implement, this strategy introduced non-determinism and gradient noise, leading to less stable training and unpredictable load balancing.\n    \n*   Newer approaches incorporate **adaptive drop policies** informed by runtime load statistics. For instance, [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) employs latency-aware scheduling that prioritizes tokens based on both routing confidence and hardware availability. Tokens likely to cause straggler delays are deprioritized to ensure consistent inference latency across distributed systems.\n    \n*   These developments collectively demonstrate that token dropping is not a binary “keep or skip” operation, but rather a structured decision process. Properly designed drop policies preserve key activations, stabilize expert utilization, and ensure deterministic training dynamics — a critical property for reproducibility in large-scale distributed MoE systems.\n    \n\nEven when token overflow is unavoidable, **drop policy design** plays a critical role in determining which tokens are skipped and how gracefully the model handles overload. The choice of drop strategy can influence both performance and stability during training and inference.\n\nThe **Switch Transformer** model — [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021) — introduced the **lowest-probability drop policy**, in which tokens with the smallest gating probabilities pi(x)pi(x)p\\_i(x) for a given expert are dropped first. This ensures that high-confidence tokens (those most relevant to the expert) are prioritized for computation, while low-confidence tokens pass through the residual pathway. This approach preserves the most informative activations, mitigating quality loss even under heavy load.\n\nIn contrast, earlier systems like [Sparsely-Gated Mixture-of-Experts](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) used a **random drop** mechanism — when an expert exceeded capacity, excess tokens were discarded at random. While simple to implement, this strategy introduced non-determinism and gradient noise, leading to less stable training and unpredictable load balancing.\n\nNewer approaches incorporate **adaptive drop policies** informed by runtime load statistics. For instance, [Capacity-Aware Inference: Mitigating the Straggler Effect in Mixture of Experts](https://arxiv.org/abs/2503.05066) by He et al. (2025) employs latency-aware scheduling that prioritizes tokens based on both routing confidence and hardware availability. Tokens likely to cause straggler delays are deprioritized to ensure consistent inference latency across distributed systems.\n\nThese developments collectively demonstrate that token dropping is not a binary “keep or skip” operation, but rather a structured decision process. Properly designed drop policies preserve key activations, stabilize expert utilization, and ensure deterministic training dynamics — a critical property for reproducibility in large-scale distributed MoE systems.",
    "contentLength": 9139,
    "wordCount": 537,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#token-priority-and-drop-policies"
  },
  {
    "id": "ai-mixture-of-experts-monitoring-drop-metrics-26",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Monitoring Drop Metrics",
    "order": 26,
    "orderInChapter": 8,
    "contentHtml": "<ul>\n  <li>\n    <p>Effective management of token dropping in MoE systems requires <strong>continuous monitoring of drop-related statistics</strong> during both training and inference. This enables early detection of imbalances and helps maintain stable utilization across experts.</p>\n  </li>\n  <li>\n    <p>According to <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications</a> by Jiang et al. (2025), drop monitoring should include both <strong>instantaneous</strong> and <strong>aggregate</strong> statistics:</p>\n\n    <ol>\n      <li><strong>Per-step drop rate</strong> (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-234-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1724\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1725\"><span class=\"mi\" id=\"MathJax-Span-1726\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-234\">r</script>): measures the proportion of tokens dropped in the current batch.</li>\n      <li><strong>Cumulative drop rate</strong>: tracks the long-term trend of token loss to detect systematic overload in specific experts.</li>\n      <li><strong>Expert imbalance variance</strong> (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-235-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>Var</mtext><mo stretchy=&quot;false&quot;>(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1727\" style=\"width: 3.232em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.61em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1728\"><span class=\"mtext\" id=\"MathJax-Span-1729\" style=\"font-family: STIXGeneral-Regular;\">Var</span><span class=\"mo\" id=\"MathJax-Span-1730\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1731\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1732\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1733\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1734\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mtext>Var</mtext><mo stretchy=\"false\">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-235\">\\text{Var}(f_i)</script>): quantifies how evenly tokens are distributed across experts, serving as an indirect measure of routing fairness.</li>\n    </ol>\n  </li>\n  <li>\n    <p>Persistent overflow concentrated in specific experts may indicate gate bias, inadequate capacity factors, or uneven gradient updates in the gating network. Logging these metrics can help diagnose routing instability and inform dynamic load rebalancing.</p>\n  </li>\n  <li>\n    <p>In practice, monitoring frameworks such as <a href=\"https://arxiv.org/abs/2203.12533\">Pathways</a> by Barham et al. (2022) and <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020) integrate real-time telemetry for per-expert utilization and drop tracking. These systems use collected data to adapt routing parameters or adjust expert capacity dynamically, preventing underutilization or runaway overload.</p>\n  </li>\n  <li>\n    <p>For large-scale deployments (e.g., <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021)), visualization dashboards that track <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-236-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1735\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1736\"><span class=\"mi\" id=\"MathJax-Span-1737\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-236\">r</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-237-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1738\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1739\"><span class=\"msubsup\" id=\"MathJax-Span-1740\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1741\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1742\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-237\">f_i</script>, and communication latency are essential for debugging distributed bottlenecks. Combining such metrics with adaptive routing policies (e.g., capacity-aware rerouting) closes the control loop between load monitoring and active expert management.</p>\n  </li>\n</ul>\n<p>Effective management of token dropping in MoE systems requires <strong>continuous monitoring of drop-related statistics</strong> during both training and inference. This enables early detection of imbalances and helps maintain stable utilization across experts.</p>\n<p>According to <a href=\"https://arxiv.org/abs/2503.07137\">A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications</a> by Jiang et al. (2025), drop monitoring should include both <strong>instantaneous</strong> and <strong>aggregate</strong> statistics:</p>\n<ol>\n      <li><strong>Per-step drop rate</strong> (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-234-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1724\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1725\"><span class=\"mi\" id=\"MathJax-Span-1726\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-234\">r</script>): measures the proportion of tokens dropped in the current batch.</li>\n      <li><strong>Cumulative drop rate</strong>: tracks the long-term trend of token loss to detect systematic overload in specific experts.</li>\n      <li><strong>Expert imbalance variance</strong> (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-235-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>Var</mtext><mo stretchy=&quot;false&quot;>(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1727\" style=\"width: 3.232em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.61em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1728\"><span class=\"mtext\" id=\"MathJax-Span-1729\" style=\"font-family: STIXGeneral-Regular;\">Var</span><span class=\"mo\" id=\"MathJax-Span-1730\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1731\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1732\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1733\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1734\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mtext>Var</mtext><mo stretchy=\"false\">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-235\">\\text{Var}(f_i)</script>): quantifies how evenly tokens are distributed across experts, serving as an indirect measure of routing fairness.</li>\n    </ol>\n<p>Persistent overflow concentrated in specific experts may indicate gate bias, inadequate capacity factors, or uneven gradient updates in the gating network. Logging these metrics can help diagnose routing instability and inform dynamic load rebalancing.</p>\n<p>In practice, monitoring frameworks such as <a href=\"https://arxiv.org/abs/2203.12533\">Pathways</a> by Barham et al. (2022) and <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020) integrate real-time telemetry for per-expert utilization and drop tracking. These systems use collected data to adapt routing parameters or adjust expert capacity dynamically, preventing underutilization or runaway overload.</p>\n<p>For large-scale deployments (e.g., <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021)), visualization dashboards that track <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-236-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>r</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1735\" style=\"width: 0.419em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.315em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.32em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1736\"><span class=\"mi\" id=\"MathJax-Span-1737\" style=\"font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>r</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-236\">r</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-237-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1738\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1739\"><span class=\"msubsup\" id=\"MathJax-Span-1740\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1741\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-1742\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-237\">f_i</script>, and communication latency are essential for debugging distributed bottlenecks. Combining such metrics with adaptive routing policies (e.g., capacity-aware rerouting) closes the control loop between load monitoring and active expert management.</p>",
    "contentMarkdown": "*   Effective management of token dropping in MoE systems requires **continuous monitoring of drop-related statistics** during both training and inference. This enables early detection of imbalances and helps maintain stable utilization across experts.\n    \n*   According to [A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), drop monitoring should include both **instantaneous** and **aggregate** statistics:\n    \n    1.  **Per-step drop rate** (rrr): measures the proportion of tokens dropped in the current batch.\n    2.  **Cumulative drop rate**: tracks the long-term trend of token loss to detect systematic overload in specific experts.\n    3.  **Expert imbalance variance** (Var(fi)Var(fi)\\\\text{Var}(f\\_i)): quantifies how evenly tokens are distributed across experts, serving as an indirect measure of routing fairness.\n*   Persistent overflow concentrated in specific experts may indicate gate bias, inadequate capacity factors, or uneven gradient updates in the gating network. Logging these metrics can help diagnose routing instability and inform dynamic load rebalancing.\n    \n*   In practice, monitoring frameworks such as [Pathways](https://arxiv.org/abs/2203.12533) by Barham et al. (2022) and [GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020) integrate real-time telemetry for per-expert utilization and drop tracking. These systems use collected data to adapt routing parameters or adjust expert capacity dynamically, preventing underutilization or runaway overload.\n    \n*   For large-scale deployments (e.g., [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021)), visualization dashboards that track rrr, fifif\\_i, and communication latency are essential for debugging distributed bottlenecks. Combining such metrics with adaptive routing policies (e.g., capacity-aware rerouting) closes the control loop between load monitoring and active expert management.\n    \n\nEffective management of token dropping in MoE systems requires **continuous monitoring of drop-related statistics** during both training and inference. This enables early detection of imbalances and helps maintain stable utilization across experts.\n\nAccording to [A Comprehensive Survey of Mixture-of-Experts: Algorithms and Applications](https://arxiv.org/abs/2503.07137) by Jiang et al. (2025), drop monitoring should include both **instantaneous** and **aggregate** statistics:\n\n1.  **Per-step drop rate** (rrr): measures the proportion of tokens dropped in the current batch.\n2.  **Cumulative drop rate**: tracks the long-term trend of token loss to detect systematic overload in specific experts.\n3.  **Expert imbalance variance** (Var(fi)Var(fi)\\\\text{Var}(f\\_i)): quantifies how evenly tokens are distributed across experts, serving as an indirect measure of routing fairness.\n\nPersistent overflow concentrated in specific experts may indicate gate bias, inadequate capacity factors, or uneven gradient updates in the gating network. Logging these metrics can help diagnose routing instability and inform dynamic load rebalancing.\n\nIn practice, monitoring frameworks such as [Pathways](https://arxiv.org/abs/2203.12533) by Barham et al. (2022) and [GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020) integrate real-time telemetry for per-expert utilization and drop tracking. These systems use collected data to adapt routing parameters or adjust expert capacity dynamically, preventing underutilization or runaway overload.\n\nFor large-scale deployments (e.g., [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021)), visualization dashboards that track rrr, fifif\\_i, and communication latency are essential for debugging distributed bottlenecks. Combining such metrics with adaptive routing policies (e.g., capacity-aware rerouting) closes the control loop between load monitoring and active expert management.",
    "contentLength": 17988,
    "wordCount": 481,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#monitoring-drop-metrics"
  },
  {
    "id": "ai-mixture-of-experts-architectural-alternatives-27",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Token Dropping",
    "title": "Architectural Alternatives",
    "order": 27,
    "orderInChapter": 9,
    "contentHtml": "<ul>\n  <li>\n    <p>Instead of attempting to manage or mitigate token dropping through load balancing or rerouting alone, several recent architectures have <strong>redesigned the routing process itself</strong> to eliminate the notion of dropping altogether. These approaches reimagine how experts interact with tokens—favoring continuous mixtures or block-structured routing over discrete, capacity-limited assignment.</p>\n  </li>\n  <li>\n    <p>One of the most influential works in this direction is <a href=\"https://arxiv.org/abs/2308.00951\">Soft MoE: Towards Training Large Sparse Models without Dropping Tokens</a> by Puigcerver et al. (2023). In Soft MoE, the hard top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-238-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1743\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1744\"><span class=\"mi\" id=\"MathJax-Span-1745\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-238\">k</script> selection used in traditional sparse routing is replaced with <strong>soft, differentiable gating</strong>, where each token contributes to all experts with varying weights determined by a softmax function.</p>\n\n    <ul>\n      <li>This eliminates capacity overflow because every token receives some (possibly very small) contribution from every expert.</li>\n      <li>The approach smooths gradients during backpropagation, leading to more stable optimization and improved convergence.</li>\n      <li>While this increases computational cost due to denser activation, Soft MoE achieves <strong>consistent expert utilization</strong> and avoids the instability caused by token dropping or rerouting heuristics.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Another line of architectural innovation stems from <strong>block-sparse formulations</strong> such as <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks: Efficient Sparse Training with Mixture-of-Experts</a> by Gale et al. (2022). Rather than assigning individual tokens to experts, MegaBlocks organizes tokens into fixed-size blocks and performs sparse matrix multiplication at the block level.</p>\n\n    <ul>\n      <li>This structure guarantees balanced workloads by ensuring that each compute block is fully utilized.</li>\n      <li>It also removes per-token routing constraints, as load balancing occurs implicitly through block scheduling.</li>\n      <li>MegaBlocks thus achieves both high efficiency and the elimination of token-level dropping, representing a significant systems-level advance in sparse expert training.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Collectively, these architectural innovations—<strong>Soft MoE</strong> and <strong>block-sparse MoE</strong>—signal a shift from reactive handling of token dropping toward proactive design choices that make dropping unnecessary. By making routing continuous or structured, modern MoE systems achieve the dual goals of <em>smooth training dynamics</em> and <em>near-perfect expert utilization</em>.</p>\n  </li>\n</ul>\n<p>Instead of attempting to manage or mitigate token dropping through load balancing or rerouting alone, several recent architectures have <strong>redesigned the routing process itself</strong> to eliminate the notion of dropping altogether. These approaches reimagine how experts interact with tokens—favoring continuous mixtures or block-structured routing over discrete, capacity-limited assignment.</p>\n<p>One of the most influential works in this direction is <a href=\"https://arxiv.org/abs/2308.00951\">Soft MoE: Towards Training Large Sparse Models without Dropping Tokens</a> by Puigcerver et al. (2023). In Soft MoE, the hard top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-238-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1743\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1744\"><span class=\"mi\" id=\"MathJax-Span-1745\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-238\">k</script> selection used in traditional sparse routing is replaced with <strong>soft, differentiable gating</strong>, where each token contributes to all experts with varying weights determined by a softmax function.</p>\n<ul>\n      <li>This eliminates capacity overflow because every token receives some (possibly very small) contribution from every expert.</li>\n      <li>The approach smooths gradients during backpropagation, leading to more stable optimization and improved convergence.</li>\n      <li>While this increases computational cost due to denser activation, Soft MoE achieves <strong>consistent expert utilization</strong> and avoids the instability caused by token dropping or rerouting heuristics.</li>\n    </ul>\n<p>Another line of architectural innovation stems from <strong>block-sparse formulations</strong> such as <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks: Efficient Sparse Training with Mixture-of-Experts</a> by Gale et al. (2022). Rather than assigning individual tokens to experts, MegaBlocks organizes tokens into fixed-size blocks and performs sparse matrix multiplication at the block level.</p>\n<ul>\n      <li>This structure guarantees balanced workloads by ensuring that each compute block is fully utilized.</li>\n      <li>It also removes per-token routing constraints, as load balancing occurs implicitly through block scheduling.</li>\n      <li>MegaBlocks thus achieves both high efficiency and the elimination of token-level dropping, representing a significant systems-level advance in sparse expert training.</li>\n    </ul>\n<p>Collectively, these architectural innovations—<strong>Soft MoE</strong> and <strong>block-sparse MoE</strong>—signal a shift from reactive handling of token dropping toward proactive design choices that make dropping unnecessary. By making routing continuous or structured, modern MoE systems achieve the dual goals of <em>smooth training dynamics</em> and <em>near-perfect expert utilization</em>.</p>",
    "contentMarkdown": "*   Instead of attempting to manage or mitigate token dropping through load balancing or rerouting alone, several recent architectures have **redesigned the routing process itself** to eliminate the notion of dropping altogether. These approaches reimagine how experts interact with tokens—favoring continuous mixtures or block-structured routing over discrete, capacity-limited assignment.\n    \n*   One of the most influential works in this direction is [Soft MoE: Towards Training Large Sparse Models without Dropping Tokens](https://arxiv.org/abs/2308.00951) by Puigcerver et al. (2023). In Soft MoE, the hard top-kkk selection used in traditional sparse routing is replaced with **soft, differentiable gating**, where each token contributes to all experts with varying weights determined by a softmax function.\n    \n    *   This eliminates capacity overflow because every token receives some (possibly very small) contribution from every expert.\n    *   The approach smooths gradients during backpropagation, leading to more stable optimization and improved convergence.\n    *   While this increases computational cost due to denser activation, Soft MoE achieves **consistent expert utilization** and avoids the instability caused by token dropping or rerouting heuristics.\n*   Another line of architectural innovation stems from **block-sparse formulations** such as [MegaBlocks: Efficient Sparse Training with Mixture-of-Experts](https://arxiv.org/abs/2211.15841) by Gale et al. (2022). Rather than assigning individual tokens to experts, MegaBlocks organizes tokens into fixed-size blocks and performs sparse matrix multiplication at the block level.\n    \n    *   This structure guarantees balanced workloads by ensuring that each compute block is fully utilized.\n    *   It also removes per-token routing constraints, as load balancing occurs implicitly through block scheduling.\n    *   MegaBlocks thus achieves both high efficiency and the elimination of token-level dropping, representing a significant systems-level advance in sparse expert training.\n*   Collectively, these architectural innovations—**Soft MoE** and **block-sparse MoE**—signal a shift from reactive handling of token dropping toward proactive design choices that make dropping unnecessary. By making routing continuous or structured, modern MoE systems achieve the dual goals of _smooth training dynamics_ and _near-perfect expert utilization_.\n    \n\nInstead of attempting to manage or mitigate token dropping through load balancing or rerouting alone, several recent architectures have **redesigned the routing process itself** to eliminate the notion of dropping altogether. These approaches reimagine how experts interact with tokens—favoring continuous mixtures or block-structured routing over discrete, capacity-limited assignment.\n\nOne of the most influential works in this direction is [Soft MoE: Towards Training Large Sparse Models without Dropping Tokens](https://arxiv.org/abs/2308.00951) by Puigcerver et al. (2023). In Soft MoE, the hard top-kkk selection used in traditional sparse routing is replaced with **soft, differentiable gating**, where each token contributes to all experts with varying weights determined by a softmax function.\n\n*   This eliminates capacity overflow because every token receives some (possibly very small) contribution from every expert.\n*   The approach smooths gradients during backpropagation, leading to more stable optimization and improved convergence.\n*   While this increases computational cost due to denser activation, Soft MoE achieves **consistent expert utilization** and avoids the instability caused by token dropping or rerouting heuristics.\n\nAnother line of architectural innovation stems from **block-sparse formulations** such as [MegaBlocks: Efficient Sparse Training with Mixture-of-Experts](https://arxiv.org/abs/2211.15841) by Gale et al. (2022). Rather than assigning individual tokens to experts, MegaBlocks organizes tokens into fixed-size blocks and performs sparse matrix multiplication at the block level.\n\n*   This structure guarantees balanced workloads by ensuring that each compute block is fully utilized.\n*   It also removes per-token routing constraints, as load balancing occurs implicitly through block scheduling.\n*   MegaBlocks thus achieves both high efficiency and the elimination of token-level dropping, representing a significant systems-level advance in sparse expert training.\n\nCollectively, these architectural innovations—**Soft MoE** and **block-sparse MoE**—signal a shift from reactive handling of token dropping toward proactive design choices that make dropping unnecessary. By making routing continuous or structured, modern MoE systems achieve the dual goals of _smooth training dynamics_ and _near-perfect expert utilization_.",
    "contentLength": 7858,
    "wordCount": 616,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#architectural-alternatives"
  },
  {
    "id": "ai-mixture-of-experts-mixtral-of-experts-28",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Specialization",
    "title": "Mixtral of Experts",
    "order": 28,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>In <a href=\"https://arxiv.org/pdf/2401.04088\">Mixtral of Experts</a>, the authors perform a routing analysis (i.e., a study on expert specialization) which indicated showed no significant patterns in expert assignment across different topics such as biology, philosophy, or mathematics within The Pile validation dataset, suggesting a mostly syntactic rather than semantic specialization. However, a notable syntactic specialization was observed, where specific tokens in different domains consistently mapped to the same experts, indicating structured syntactic behavior that impacts the model’s training and inference efficiency. Proportion of tokens assigned to each expert on different domains from The Pile dataset for layers 0, 15, and 31. The gray dashed vertical line marks 1/8, i.e. the proportion expected with uniform sampling. Here, they consider experts that are either selected as a first or second choice by the router.</li>\n</ul>\n<p><img src=\"../../../images/papers/Mixtral.jpg\" alt=\"\"></p>\n<ul>\n  <li>The figure below from the paper shows repeated consecutive assignments per MoE layer. Repeated assignments occur a lot more often than they would with uniform assignments (materialized by the dashed lines). Patterns are similar across datasets with less repetitions for DM Mathematics.</li>\n</ul>\n<p><img src=\"../../../images/papers/Mixtral2.jpg\" alt=\"\"></p>",
    "contentMarkdown": "*   In [Mixtral of Experts](https://arxiv.org/pdf/2401.04088), the authors perform a routing analysis (i.e., a study on expert specialization) which indicated showed no significant patterns in expert assignment across different topics such as biology, philosophy, or mathematics within The Pile validation dataset, suggesting a mostly syntactic rather than semantic specialization. However, a notable syntactic specialization was observed, where specific tokens in different domains consistently mapped to the same experts, indicating structured syntactic behavior that impacts the model’s training and inference efficiency. Proportion of tokens assigned to each expert on different domains from The Pile dataset for layers 0, 15, and 31. The gray dashed vertical line marks 1/8, i.e. the proportion expected with uniform sampling. Here, they consider experts that are either selected as a first or second choice by the router.\n\n![](../../../images/papers/Mixtral.jpg)\n\n*   The figure below from the paper shows repeated consecutive assignments per MoE layer. Repeated assignments occur a lot more often than they would with uniform assignments (materialized by the dashed lines). Patterns are similar across datasets with less repetitions for DM Mathematics.\n\n![](../../../images/papers/Mixtral2.jpg)",
    "contentLength": 1387,
    "wordCount": 175,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mixtral-of-experts"
  },
  {
    "id": "ai-mixture-of-experts-moe-llava-29",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Specialization",
    "title": "MoE-LLaVA",
    "order": 29,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>In <a href=\"https://arxiv.org/abs/2401.15947\">MoE-LLaVA: Mixture of Experts for Large Vision-Language Models</a>, the authors offer the following findings regarding expert loads and preferences from the provided document, highlighting the dynamic allocation of workloads among experts and their balanced handling of multimodal data.</li>\n  <li><strong>Expert Loads</strong>:\n    <ul>\n      <li>The distribution of workloads among experts in the model shows a pattern where different experts take on varying amounts of the total workload depending on the depth of the model layers.</li>\n      <li>In the shallower layers (e.g., layers 5-11), experts 2, 3, and 4 primarily collaborate, while expert 1 is more active in the initial layers but gradually withdraws as the layers deepen.</li>\n      <li>Expert 3, in particular, dominates the workload from layers 17 to 27, indicating a significant increase in its activation, which suggests that specific experts become more prominent at different depths of the model.</li>\n    </ul>\n  </li>\n  <li>The figure below from the paper shows a distribution of expert loadings. The discontinuous lines represent a perfectly balanced distribution of tokens among different experts or modalities. The first figure on the left illustrates the workload among experts, while the remaining four figures depict the preferences of experts towards different modalities.</li>\n</ul>\n<ul>\n      <li>The distribution of workloads among experts in the model shows a pattern where different experts take on varying amounts of the total workload depending on the depth of the model layers.</li>\n      <li>In the shallower layers (e.g., layers 5-11), experts 2, 3, and 4 primarily collaborate, while expert 1 is more active in the initial layers but gradually withdraws as the layers deepen.</li>\n      <li>Expert 3, in particular, dominates the workload from layers 17 to 27, indicating a significant increase in its activation, which suggests that specific experts become more prominent at different depths of the model.</li>\n    </ul>\n<p><img src=\"../../../images/papers/MoE-LLaVA_1.jpg\" alt=\"\"></p>\n<ul>\n  <li><strong>Expert Preferences</strong>:\n    <ul>\n      <li>Each expert develops preferences for handling certain types of data, such as text or image tokens.</li>\n      <li>The routing distributions for text and image modalities are highly similar, indicating that experts do not exhibit a clear preference for any single modality but instead handle both types of data efficiently. This reflects strong multimodal learning capabilities.</li>\n      <li>The visualizations of expert preferences demonstrate how text and image tokens are distributed across different experts, revealing that the model maintains a balanced approach in processing these modalities.</li>\n    </ul>\n  </li>\n  <li>The figure below from the paper shows a distribution of expert loadings. The discontinuous lines represent a perfectly balanced distribution of tokens among different experts or modalities. The first figure on the left illustrates the workload among experts, while the remaining four figures depict the preferences of experts towards different modalities.</li>\n</ul>\n<ul>\n      <li>Each expert develops preferences for handling certain types of data, such as text or image tokens.</li>\n      <li>The routing distributions for text and image modalities are highly similar, indicating that experts do not exhibit a clear preference for any single modality but instead handle both types of data efficiently. This reflects strong multimodal learning capabilities.</li>\n      <li>The visualizations of expert preferences demonstrate how text and image tokens are distributed across different experts, revealing that the model maintains a balanced approach in processing these modalities.</li>\n    </ul>\n<p><img src=\"../../../images/papers/MoE-LLaVA_2.jpg\" alt=\"\"></p>",
    "contentMarkdown": "*   In [MoE-LLaVA: Mixture of Experts for Large Vision-Language Models](https://arxiv.org/abs/2401.15947), the authors offer the following findings regarding expert loads and preferences from the provided document, highlighting the dynamic allocation of workloads among experts and their balanced handling of multimodal data.\n*   **Expert Loads**:\n    *   The distribution of workloads among experts in the model shows a pattern where different experts take on varying amounts of the total workload depending on the depth of the model layers.\n    *   In the shallower layers (e.g., layers 5-11), experts 2, 3, and 4 primarily collaborate, while expert 1 is more active in the initial layers but gradually withdraws as the layers deepen.\n    *   Expert 3, in particular, dominates the workload from layers 17 to 27, indicating a significant increase in its activation, which suggests that specific experts become more prominent at different depths of the model.\n*   The figure below from the paper shows a distribution of expert loadings. The discontinuous lines represent a perfectly balanced distribution of tokens among different experts or modalities. The first figure on the left illustrates the workload among experts, while the remaining four figures depict the preferences of experts towards different modalities.\n\n*   The distribution of workloads among experts in the model shows a pattern where different experts take on varying amounts of the total workload depending on the depth of the model layers.\n*   In the shallower layers (e.g., layers 5-11), experts 2, 3, and 4 primarily collaborate, while expert 1 is more active in the initial layers but gradually withdraws as the layers deepen.\n*   Expert 3, in particular, dominates the workload from layers 17 to 27, indicating a significant increase in its activation, which suggests that specific experts become more prominent at different depths of the model.\n\n![](../../../images/papers/MoE-LLaVA_1.jpg)\n\n*   **Expert Preferences**:\n    *   Each expert develops preferences for handling certain types of data, such as text or image tokens.\n    *   The routing distributions for text and image modalities are highly similar, indicating that experts do not exhibit a clear preference for any single modality but instead handle both types of data efficiently. This reflects strong multimodal learning capabilities.\n    *   The visualizations of expert preferences demonstrate how text and image tokens are distributed across different experts, revealing that the model maintains a balanced approach in processing these modalities.\n*   The figure below from the paper shows a distribution of expert loadings. The discontinuous lines represent a perfectly balanced distribution of tokens among different experts or modalities. The first figure on the left illustrates the workload among experts, while the remaining four figures depict the preferences of experts towards different modalities.\n\n*   Each expert develops preferences for handling certain types of data, such as text or image tokens.\n*   The routing distributions for text and image modalities are highly similar, indicating that experts do not exhibit a clear preference for any single modality but instead handle both types of data efficiently. This reflects strong multimodal learning capabilities.\n*   The visualizations of expert preferences demonstrate how text and image tokens are distributed across different experts, revealing that the model maintains a balanced approach in processing these modalities.\n\n![](../../../images/papers/MoE-LLaVA_2.jpg)",
    "contentLength": 3893,
    "wordCount": 518,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#moe-llava"
  },
  {
    "id": "ai-mixture-of-experts-background-routing-computation-overview-30",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Background: Routing Computation Overview",
    "order": 30,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>Modern sparse MoE layers follow the routing formulation introduced in <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017) and refined in later systems such as <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021).</p>\n  </li>\n  <li>\n    <p>Let a single input token be represented by a vector</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-239-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>x</mi><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>d</mi></mrow></msup></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1746\" style=\"width: 3.544em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.919em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1002.92em, 2.451em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1747\"><span class=\"mi\" id=\"MathJax-Span-1748\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1749\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-1750\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1751\"><span class=\"mrow\" id=\"MathJax-Span-1752\"><span class=\"mi\" id=\"MathJax-Span-1753\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.424em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1754\"><span class=\"mrow\" id=\"MathJax-Span-1755\"><span class=\"mi\" id=\"MathJax-Span-1756\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>x</mi><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>d</mi></mrow></msup></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-239\">x \\in \\mathbb{R}^{d}</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-240-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1757\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.58em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1758\"><span class=\"mi\" id=\"MathJax-Span-1759\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>d</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-240\">d</script> is the hidden dimension of the model.</li>\n    </ul>\n  </li>\n  <li>\n    <p>The router is a learned linear projection that maps this token representation to a vector of expert logits:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-241-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>z</mi><mo>=</mo><msub><mi>W</mi><mi>g</mi></msub><mi>x</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1760\" style=\"width: 4.065em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.388em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.39em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1761\"><span class=\"mi\" id=\"MathJax-Span-1762\" style=\"font-family: STIXGeneral-Italic;\">z</span><span class=\"mo\" id=\"MathJax-Span-1763\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-1764\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1765\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-1766\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-1767\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>z</mi><mo>=</mo><msub><mi>W</mi><mi>g</mi></msub><mi>x</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-241\">z = W_g x</script>\n\n    <ul>\n      <li>where:\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-242-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi><mo>&amp;#x00D7;</mo><mi>d</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1768\" style=\"width: 5.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.586em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1004.59em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1769\"><span class=\"msubsup\" id=\"MathJax-Span-1770\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1771\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-1772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1773\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-1774\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1775\"><span class=\"mrow\" id=\"MathJax-Span-1776\"><span class=\"mi\" id=\"MathJax-Span-1777\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1778\"><span class=\"mrow\" id=\"MathJax-Span-1779\"><span class=\"mi\" id=\"MathJax-Span-1780\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1781\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-1782\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-242\">W_g \\in \\mathbb{R}^{N \\times d}</script> is the router weight matrix, and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-243-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1783\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1784\"><span class=\"mi\" id=\"MathJax-Span-1785\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-243\">N</script> is the total number of experts in the MoE layer.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>The logit vector <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-244-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>z</mi><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>z</mi><mn>1</mn></msub><mo>,</mo><msub><mi>z</mi><mn>2</mn></msub><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><msub><mi>z</mi><mi>N</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1786\" style=\"width: 9.065em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.555em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1007.5em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1787\"><span class=\"mi\" id=\"MathJax-Span-1788\" style=\"font-family: STIXGeneral-Italic;\">z</span><span class=\"mo\" id=\"MathJax-Span-1789\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-1790\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1791\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1792\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mn\" id=\"MathJax-Span-1793\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1794\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1795\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1796\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mn\" id=\"MathJax-Span-1797\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1798\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1799\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1800\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1801\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1802\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-1803\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1804\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>z</mi><mo>=</mo><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mn>1</mn></msub><mo>,</mo><msub><mi>z</mi><mn>2</mn></msub><mo>,</mo><mo>…</mo><mo>,</mo><msub><mi>z</mi><mi>N</mi></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-244\">z = (z_1, z_2, \\dots, z_N)</script> assigns an unnormalized score <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-245-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>z</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1805\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.68em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1806\"><span class=\"msubsup\" id=\"MathJax-Span-1807\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1808\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-1809\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>z</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-245\">z_i</script> to each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-246-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>N</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1810\" style=\"width: 5.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.898em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1004.9em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1811\"><span class=\"mi\" id=\"MathJax-Span-1812\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1813\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-1814\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1815\"><span class=\"mn\" id=\"MathJax-Span-1816\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-1817\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1818\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1819\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-1820\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>N</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-246\">i \\in {1, \\dots, N}</script>.</p>\n  </li>\n  <li>\n    <p>These logits are converted into routing probabilities via a softmax:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-247-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>&amp;#x2061;</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><mi>exp</mi><mo>&amp;#x2061;</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>z</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>)</mo></mrow></mfrac><mo>,</mo><mspace width=&quot;1em&quot; /><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>N</mi></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1821\" style=\"width: 16.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.805em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1013.8em, 3.701em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1822\"><span class=\"msubsup\" id=\"MathJax-Span-1823\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1824\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1826\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-1827\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.71em, 4.378em, -999.997em); top: -4.685em; left: 50%; margin-left: -1.404em;\"><span class=\"mrow\" id=\"MathJax-Span-1828\"><span class=\"mi\" id=\"MathJax-Span-1829\" style=\"font-family: STIXGeneral-Regular;\">exp</span><span class=\"mo\" id=\"MathJax-Span-1830\"></span><span class=\"mo\" id=\"MathJax-Span-1831\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1832\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1833\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-1834\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1835\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(2.919em, 1004.95em, 4.638em, -999.997em); top: -3.07em; left: 50%; margin-left: -2.497em;\"><span class=\"mrow\" id=\"MathJax-Span-1836\"><span class=\"munderover\" id=\"MathJax-Span-1837\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-1838\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-1839\"><span class=\"mrow\" id=\"MathJax-Span-1840\"><span class=\"mi\" id=\"MathJax-Span-1841\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.326em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-1842\"><span class=\"mrow\" id=\"MathJax-Span-1843\"><span class=\"mi\" id=\"MathJax-Span-1844\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1845\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-1846\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-1847\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">exp</span><span class=\"mo\" id=\"MathJax-Span-1848\"></span><span class=\"mo\" id=\"MathJax-Span-1849\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1850\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1851\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-1852\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1853\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1005.11em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 5.107em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1854\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mspace\" id=\"MathJax-Span-1855\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"mi\" id=\"MathJax-Span-1856\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">i</span><span class=\"mo\" id=\"MathJax-Span-1857\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1858\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span><span class=\"mo\" id=\"MathJax-Span-1859\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1860\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1861\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-1862\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.684em; border-left: 0px solid; width: 0px; height: 3.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><mi>exp</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mi>j</mi></msub><mo stretchy=\"false\">)</mo></mrow></mfrac><mo>,</mo><mspace width=\"1em\"></mspace><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>N</mi></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-247\">p_i = \\frac{\\exp(z_i)}{\\sum_{j=1}^{N} \\exp(z_j)}, \\quad i = 1, \\dots, N</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-248-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1863\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1864\"><span class=\"msubsup\" id=\"MathJax-Span-1865\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1866\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1867\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-248\">p_i</script> denotes the probability of routing token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-249-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1868\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1869\"><span class=\"mi\" id=\"MathJax-Span-1870\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-249\">x</script> to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-250-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1871\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1872\"><span class=\"mi\" id=\"MathJax-Span-1873\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-250\">i</script>.</li>\n    </ul>\n  </li>\n  <li>\n    <p>A sparse selection operator then chooses the indices of the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-251-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1874\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1875\"><span class=\"mi\" id=\"MathJax-Span-1876\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-251\">k</script> experts according to these probabilities:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-252-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;normal&quot;>T</mi><mi mathvariant=&quot;normal&quot;>o</mi><mi mathvariant=&quot;normal&quot;>p</mi><mi mathvariant=&quot;normal&quot;>K</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>p</mi><mo>,</mo><mi>k</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1877\" style=\"width: 9.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.607em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1007.55em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1878\"><span class=\"texatom\" id=\"MathJax-Span-1879\"><span class=\"mrow\" id=\"MathJax-Span-1880\"><span class=\"mi\" id=\"MathJax-Span-1881\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1882\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1883\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1884\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1885\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"texatom\" id=\"MathJax-Span-1886\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1887\"><span class=\"mi\" id=\"MathJax-Span-1888\" style=\"font-family: STIXGeneral-Regular;\">T</span><span class=\"mi\" id=\"MathJax-Span-1889\" style=\"font-family: STIXGeneral-Regular;\">o</span><span class=\"mi\" id=\"MathJax-Span-1890\" style=\"font-family: STIXGeneral-Regular;\">p</span><span class=\"mi\" id=\"MathJax-Span-1891\" style=\"font-family: STIXGeneral-Regular;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1892\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1893\" style=\"font-family: STIXGeneral-Italic;\">p</span><span class=\"mo\" id=\"MathJax-Span-1894\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-1895\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1896\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">K</mi></mrow><mo stretchy=\"false\">(</mo><mi>p</mi><mo>,</mo><mi>k</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-252\">\\mathcal{E}(x) = \\mathrm{TopK}(p, k)</script>\n\n    <ul>\n      <li>where:\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-253-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;#x226A;</mo><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1897\" style=\"width: 3.232em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1002.66em, 2.398em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1898\"><span class=\"mi\" id=\"MathJax-Span-1899\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1900\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≪</span><span class=\"mi\" id=\"MathJax-Span-1901\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>≪</mo><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-253\">k \\ll N</script> is a small integer (typically <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-254-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1902\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1903\"><span class=\"mi\" id=\"MathJax-Span-1904\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1905\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1906\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-254\">k = 1</script> or <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-255-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>2</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1907\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1908\"><span class=\"mi\" id=\"MathJax-Span-1909\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1910\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1911\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">2</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>2</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-255\">k = 2</script>), and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-256-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2282;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>N</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1912\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1006.62em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1913\"><span class=\"texatom\" id=\"MathJax-Span-1914\"><span class=\"mrow\" id=\"MathJax-Span-1915\"><span class=\"mi\" id=\"MathJax-Span-1916\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1917\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1918\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1919\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1920\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">⊂</span><span class=\"texatom\" id=\"MathJax-Span-1921\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1922\"><span class=\"mn\" id=\"MathJax-Span-1923\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-1924\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1925\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1926\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-1927\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊂</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>N</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-256\">\\mathcal{E}(x) \\subset {1, \\dots, N}</script> is the set of selected expert indices for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-257-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1928\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1929\"><span class=\"mi\" id=\"MathJax-Span-1930\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-257\">x</script>.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>Only experts whose indices lie in <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-258-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1931\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.88em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1932\"><span class=\"texatom\" id=\"MathJax-Span-1933\"><span class=\"mrow\" id=\"MathJax-Span-1934\"><span class=\"mi\" id=\"MathJax-Span-1935\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1936\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1937\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1938\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-258\">\\mathcal{E}(x)</script> are executed for this token; all others are skipped.</p>\n  </li>\n</ul>\n<p>Modern sparse MoE layers follow the routing formulation introduced in <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017) and refined in later systems such as <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021).</p>\n<p>Let a single input token be represented by a vector</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-240-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1757\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.58em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1758\"><span class=\"mi\" id=\"MathJax-Span-1759\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>d</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-240\">d</script> is the hidden dimension of the model.</li>\n    </ul>\n<p>The router is a learned linear projection that maps this token representation to a vector of expert logits:</p>\n<ul>\n      <li>where:\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-242-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi><mo>&amp;#x00D7;</mo><mi>d</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1768\" style=\"width: 5.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.586em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1004.59em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1769\"><span class=\"msubsup\" id=\"MathJax-Span-1770\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1771\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-1772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1773\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-1774\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1775\"><span class=\"mrow\" id=\"MathJax-Span-1776\"><span class=\"mi\" id=\"MathJax-Span-1777\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1778\"><span class=\"mrow\" id=\"MathJax-Span-1779\"><span class=\"mi\" id=\"MathJax-Span-1780\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1781\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-1782\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-242\">W_g \\in \\mathbb{R}^{N \\times d}</script> is the router weight matrix, and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-243-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1783\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1784\"><span class=\"mi\" id=\"MathJax-Span-1785\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-243\">N</script> is the total number of experts in the MoE layer.</li>\n        </ul>\n      </li>\n    </ul>\n<ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-242-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi><mo>&amp;#x00D7;</mo><mi>d</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1768\" style=\"width: 5.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.586em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1004.59em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1769\"><span class=\"msubsup\" id=\"MathJax-Span-1770\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1771\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-1772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1773\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-1774\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-1775\"><span class=\"mrow\" id=\"MathJax-Span-1776\"><span class=\"mi\" id=\"MathJax-Span-1777\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-1778\"><span class=\"mrow\" id=\"MathJax-Span-1779\"><span class=\"mi\" id=\"MathJax-Span-1780\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1781\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-1782\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-242\">W_g \\in \\mathbb{R}^{N \\times d}</script> is the router weight matrix, and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-243-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1783\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1784\"><span class=\"mi\" id=\"MathJax-Span-1785\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-243\">N</script> is the total number of experts in the MoE layer.</li>\n        </ul>\n<p>The logit vector <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-244-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>z</mi><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>z</mi><mn>1</mn></msub><mo>,</mo><msub><mi>z</mi><mn>2</mn></msub><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><msub><mi>z</mi><mi>N</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1786\" style=\"width: 9.065em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.555em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1007.5em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1787\"><span class=\"mi\" id=\"MathJax-Span-1788\" style=\"font-family: STIXGeneral-Italic;\">z</span><span class=\"mo\" id=\"MathJax-Span-1789\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-1790\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-1791\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1792\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mn\" id=\"MathJax-Span-1793\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1794\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1795\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1796\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mn\" id=\"MathJax-Span-1797\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1798\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1799\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1800\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-1801\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1802\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-1803\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1804\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>z</mi><mo>=</mo><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mn>1</mn></msub><mo>,</mo><msub><mi>z</mi><mn>2</mn></msub><mo>,</mo><mo>…</mo><mo>,</mo><msub><mi>z</mi><mi>N</mi></msub><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-244\">z = (z_1, z_2, \\dots, z_N)</script> assigns an unnormalized score <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-245-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>z</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1805\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.68em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1806\"><span class=\"msubsup\" id=\"MathJax-Span-1807\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1808\" style=\"font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-1809\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>z</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-245\">z_i</script> to each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-246-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>N</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1810\" style=\"width: 5.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.898em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1004.9em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1811\"><span class=\"mi\" id=\"MathJax-Span-1812\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1813\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-1814\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1815\"><span class=\"mn\" id=\"MathJax-Span-1816\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-1817\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1818\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1819\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-1820\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>N</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-246\">i \\in {1, \\dots, N}</script>.</p>\n<p>These logits are converted into routing probabilities via a softmax:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-248-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1863\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1864\"><span class=\"msubsup\" id=\"MathJax-Span-1865\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1866\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-1867\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-248\">p_i</script> denotes the probability of routing token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-249-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1868\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1869\"><span class=\"mi\" id=\"MathJax-Span-1870\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-249\">x</script> to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-250-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1871\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1872\"><span class=\"mi\" id=\"MathJax-Span-1873\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-250\">i</script>.</li>\n    </ul>\n<p>A sparse selection operator then chooses the indices of the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-251-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1874\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1875\"><span class=\"mi\" id=\"MathJax-Span-1876\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-251\">k</script> experts according to these probabilities:</p>\n<ul>\n      <li>where:\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-253-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;#x226A;</mo><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1897\" style=\"width: 3.232em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1002.66em, 2.398em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1898\"><span class=\"mi\" id=\"MathJax-Span-1899\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1900\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≪</span><span class=\"mi\" id=\"MathJax-Span-1901\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>≪</mo><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-253\">k \\ll N</script> is a small integer (typically <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-254-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1902\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1903\"><span class=\"mi\" id=\"MathJax-Span-1904\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1905\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1906\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-254\">k = 1</script> or <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-255-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>2</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1907\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1908\"><span class=\"mi\" id=\"MathJax-Span-1909\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1910\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1911\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">2</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>2</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-255\">k = 2</script>), and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-256-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2282;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>N</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1912\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1006.62em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1913\"><span class=\"texatom\" id=\"MathJax-Span-1914\"><span class=\"mrow\" id=\"MathJax-Span-1915\"><span class=\"mi\" id=\"MathJax-Span-1916\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1917\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1918\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1919\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1920\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">⊂</span><span class=\"texatom\" id=\"MathJax-Span-1921\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1922\"><span class=\"mn\" id=\"MathJax-Span-1923\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-1924\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1925\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1926\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-1927\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊂</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>N</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-256\">\\mathcal{E}(x) \\subset {1, \\dots, N}</script> is the set of selected expert indices for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-257-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1928\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1929\"><span class=\"mi\" id=\"MathJax-Span-1930\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-257\">x</script>.</li>\n        </ul>\n      </li>\n    </ul>\n<ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-253-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;#x226A;</mo><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1897\" style=\"width: 3.232em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1002.66em, 2.398em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1898\"><span class=\"mi\" id=\"MathJax-Span-1899\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1900\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≪</span><span class=\"mi\" id=\"MathJax-Span-1901\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>≪</mo><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-253\">k \\ll N</script> is a small integer (typically <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-254-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1902\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1903\"><span class=\"mi\" id=\"MathJax-Span-1904\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1905\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1906\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-254\">k = 1</script> or <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-255-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>2</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1907\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1908\"><span class=\"mi\" id=\"MathJax-Span-1909\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1910\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1911\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">2</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>2</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-255\">k = 2</script>), and</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-256-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2282;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>N</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1912\" style=\"width: 7.971em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1006.62em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1913\"><span class=\"texatom\" id=\"MathJax-Span-1914\"><span class=\"mrow\" id=\"MathJax-Span-1915\"><span class=\"mi\" id=\"MathJax-Span-1916\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1917\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1918\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1919\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-1920\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">⊂</span><span class=\"texatom\" id=\"MathJax-Span-1921\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1922\"><span class=\"mn\" id=\"MathJax-Span-1923\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-1924\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-1925\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-1926\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-1927\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊂</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>N</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-256\">\\mathcal{E}(x) \\subset {1, \\dots, N}</script> is the set of selected expert indices for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-257-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1928\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1929\"><span class=\"mi\" id=\"MathJax-Span-1930\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-257\">x</script>.</li>\n        </ul>\n<p>Only experts whose indices lie in <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-258-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1931\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.88em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1932\"><span class=\"texatom\" id=\"MathJax-Span-1933\"><span class=\"mrow\" id=\"MathJax-Span-1934\"><span class=\"mi\" id=\"MathJax-Span-1935\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1936\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1937\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1938\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-258\">\\mathcal{E}(x)</script> are executed for this token; all others are skipped.</p>",
    "contentMarkdown": "*   Modern sparse MoE layers follow the routing formulation introduced in [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) and refined in later systems such as [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021).\n    \n*   Let a single input token be represented by a vector\n    \n    x∈ℝdx∈Rd\n    \n    x \\\\in \\\\mathbb{R}^{d}\n    *   where ddd is the hidden dimension of the model.\n*   The router is a learned linear projection that maps this token representation to a vector of expert logits:\n    \n    z\\=Wgxz\\=Wgx\n    \n    z = W\\_g x\n    *   where:\n        *   Wg∈ℝN×dWg∈RN×dW\\_g \\\\in \\\\mathbb{R}^{N \\\\times d} is the router weight matrix, and\n        *   NNN is the total number of experts in the MoE layer.\n*   The logit vector z\\=(z1,z2,…,zN)z\\=(z1,z2,…,zN)z = (z\\_1, z\\_2, \\\\dots, z\\_N) assigns an unnormalized score ziziz\\_i to each expert i∈1,…,Ni∈1,…,Ni \\\\in {1, \\\\dots, N}.\n    \n*   These logits are converted into routing probabilities via a softmax:\n    \n    pi\\=exp(zi)∑Nj\\=1exp(zj),i\\=1,…,Npi\\=exp⁡(zi)∑j\\=1Nexp⁡(zj),i\\=1,…,N\n    \n    p\\_i = \\\\frac{\\\\exp(z\\_i)}{\\\\sum\\_{j=1}^{N} \\\\exp(z\\_j)}, \\\\quad i = 1, \\\\dots, N\n    *   where pipip\\_i denotes the probability of routing token xxx to expert iii.\n*   A sparse selection operator then chooses the indices of the top-kkk experts according to these probabilities:\n    \n    (x)\\=TopK(p,k)E(x)\\=TopK(p,k)\n    \n    \\\\mathcal{E}(x) = \\\\mathrm{TopK}(p, k)\n    *   where:\n        *   k≪Nk≪Nk \\\\ll N is a small integer (typically k\\=1k\\=1k = 1 or k\\=2k\\=2k = 2), and\n        *   (x)⊂1,…,NE(x)⊂1,…,N\\\\mathcal{E}(x) \\\\subset {1, \\\\dots, N} is the set of selected expert indices for token xxx.\n*   Only experts whose indices lie in (x)E(x)\\\\mathcal{E}(x) are executed for this token; all others are skipped.\n    \n\nModern sparse MoE layers follow the routing formulation introduced in [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017) and refined in later systems such as [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021).\n\nLet a single input token be represented by a vector\n\n*   where ddd is the hidden dimension of the model.\n\nThe router is a learned linear projection that maps this token representation to a vector of expert logits:\n\n*   where:\n    *   Wg∈ℝN×dWg∈RN×dW\\_g \\\\in \\\\mathbb{R}^{N \\\\times d} is the router weight matrix, and\n    *   NNN is the total number of experts in the MoE layer.\n\n*   Wg∈ℝN×dWg∈RN×dW\\_g \\\\in \\\\mathbb{R}^{N \\\\times d} is the router weight matrix, and\n*   NNN is the total number of experts in the MoE layer.\n\nThe logit vector z\\=(z1,z2,…,zN)z\\=(z1,z2,…,zN)z = (z\\_1, z\\_2, \\\\dots, z\\_N) assigns an unnormalized score ziziz\\_i to each expert i∈1,…,Ni∈1,…,Ni \\\\in {1, \\\\dots, N}.\n\nThese logits are converted into routing probabilities via a softmax:\n\n*   where pipip\\_i denotes the probability of routing token xxx to expert iii.\n\nA sparse selection operator then chooses the indices of the top-kkk experts according to these probabilities:\n\n*   where:\n    *   k≪Nk≪Nk \\\\ll N is a small integer (typically k\\=1k\\=1k = 1 or k\\=2k\\=2k = 2), and\n    *   (x)⊂1,…,NE(x)⊂1,…,N\\\\mathcal{E}(x) \\\\subset {1, \\\\dots, N} is the set of selected expert indices for token xxx.\n\n*   k≪Nk≪Nk \\\\ll N is a small integer (typically k\\=1k\\=1k = 1 or k\\=2k\\=2k = 2), and\n*   (x)⊂1,…,NE(x)⊂1,…,N\\\\mathcal{E}(x) \\\\subset {1, \\\\dots, N} is the set of selected expert indices for token xxx.\n\nOnly experts whose indices lie in (x)E(x)\\\\mathcal{E}(x) are executed for this token; all others are skipped.",
    "contentLength": 100089,
    "wordCount": 515,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#background:-routing-computation-overview"
  },
  {
    "id": "ai-mixture-of-experts-non-differentiability-of-top-kkk-routing-31",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Non-Differentiability of Top-kkk Routing",
    "order": 31,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>The top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-260-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1942\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1943\"><span class=\"mi\" id=\"MathJax-Span-1944\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-260\">k</script> operator is piecewise constant with respect to the logits <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-261-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>z</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1945\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.47em, 2.451em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1946\"><span class=\"mi\" id=\"MathJax-Span-1947\" style=\"font-family: STIXGeneral-Italic;\">z</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.184em; border-left: 0px solid; width: 0px; height: 0.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>z</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-261\">z</script>. Infinitesimal perturbations to <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-262-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>z</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1948\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.47em, 2.451em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1949\"><span class=\"mi\" id=\"MathJax-Span-1950\" style=\"font-family: STIXGeneral-Italic;\">z</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.184em; border-left: 0px solid; width: 0px; height: 0.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>z</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-262\">z</script> do not change the selected expert set unless the ordering of logits changes. Formally, its gradient is zero almost everywhere:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-263-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mfrac><mrow><mi mathvariant=&quot;normal&quot;>&amp;#x2202;</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;normal&quot;>T</mi><mi mathvariant=&quot;normal&quot;>o</mi><mi mathvariant=&quot;normal&quot;>p</mi><mi mathvariant=&quot;normal&quot;>K</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>p</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow><mi mathvariant=&quot;normal&quot;>&amp;#x2202;</mi><mi>z</mi></mrow></mfrac><mo>=</mo><mn>0</mn><mspace width=&quot;1em&quot; /><mtext>a.e.</mtext></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1951\" style=\"width: 10.263em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1008.49em, 3.128em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1952\"><span class=\"mfrac\" id=\"MathJax-Span-1953\"><span style=\"display: inline-block; position: relative; width: 4.117em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1003.91em, 4.378em, -999.997em); top: -4.685em; left: 50%; margin-left: -1.977em;\"><span class=\"mrow\" id=\"MathJax-Span-1954\"><span class=\"mi\" id=\"MathJax-Span-1955\" style=\"font-family: STIXGeneral-Regular;\">∂</span><span class=\"texatom\" id=\"MathJax-Span-1956\"><span class=\"mrow\" id=\"MathJax-Span-1957\"><span class=\"mi\" id=\"MathJax-Span-1958\" style=\"font-family: STIXGeneral-Regular;\">T</span><span class=\"mi\" id=\"MathJax-Span-1959\" style=\"font-family: STIXGeneral-Regular;\">o</span><span class=\"mi\" id=\"MathJax-Span-1960\" style=\"font-family: STIXGeneral-Regular;\">p</span><span class=\"mi\" id=\"MathJax-Span-1961\" style=\"font-family: STIXGeneral-Regular;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1962\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1963\" style=\"font-family: STIXGeneral-Italic;\">p</span><span class=\"mo\" id=\"MathJax-Span-1964\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.84em, 4.273em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.414em;\"><span class=\"mrow\" id=\"MathJax-Span-1965\"><span class=\"mi\" id=\"MathJax-Span-1966\" style=\"font-family: STIXGeneral-Regular;\">∂</span><span class=\"mi\" id=\"MathJax-Span-1967\" style=\"font-family: STIXGeneral-Italic;\">z</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1004.12em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 4.117em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1968\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-1969\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0</span><span class=\"mspace\" id=\"MathJax-Span-1970\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"mtext\" id=\"MathJax-Span-1971\" style=\"font-family: STIXGeneral-Regular;\">a.e.</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.997em; border-left: 0px solid; width: 0px; height: 2.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mfrac><mrow><mi mathvariant=\"normal\">∂</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"normal\">T</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">K</mi></mrow><mo stretchy=\"false\">(</mo><mi>p</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi mathvariant=\"normal\">∂</mi><mi>z</mi></mrow></mfrac><mo>=</mo><mn>0</mn><mspace width=\"1em\"></mspace><mtext>a.e.</mtext></math></span></span></div>\n<ul>\n  <li>As a result, gradients cannot flow through the expert-selection operation itself. This creates an inherent asymmetry between the forward computation graph, which contains discrete routing decisions, and the backward graph, which cannot differentiate through them. Instead, MoE training relies on a partial gradient path that bypasses the discrete selection.</li>\n</ul>",
    "contentMarkdown": "*   The top-kkk operator is piecewise constant with respect to the logits zzz. Infinitesimal perturbations to zzz do not change the selected expert set unless the ordering of logits changes. Formally, its gradient is zero almost everywhere:\n\n∂TopK(p)∂z\\=0a.e.∂TopK(p)∂z\\=0a.e.\n\n*   As a result, gradients cannot flow through the expert-selection operation itself. This creates an inherent asymmetry between the forward computation graph, which contains discrete routing decisions, and the backward graph, which cannot differentiate through them. Instead, MoE training relies on a partial gradient path that bypasses the discrete selection.",
    "contentLength": 8900,
    "wordCount": 88,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#non-differentiability-of-top-kkk-routing"
  },
  {
    "id": "ai-mixture-of-experts-gradient-flow-to-experts-32",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Gradient Flow to Experts",
    "order": 32,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>\n    <p>Each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-264-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1972\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1973\"><span class=\"msubsup\" id=\"MathJax-Span-1974\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1975\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1976\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-264\">E_i</script> is a neural network with parameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-265-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B8;</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1977\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.73em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1978\"><span class=\"msubsup\" id=\"MathJax-Span-1979\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1980\" style=\"font-family: STIXGeneral-Italic;\">θ<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-1981\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>θ</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-265\">\\theta_i</script>. For experts that are selected (i.e., <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-266-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1982\" style=\"width: 4.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.44em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1003.39em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1983\"><span class=\"mi\" id=\"MathJax-Span-1984\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1985\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-1986\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1987\"><span class=\"mi\" id=\"MathJax-Span-1988\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1989\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1990\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1991\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-266\">i \\in \\mathcal{E}(x)</script>), gradients propagate normally through their computations.</p>\n  </li>\n  <li>\n    <p>If an expert is not selected for a given token, its output is identically zero and it receives no gradient update:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-267-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mfrac><mrow><mi mathvariant=&quot;normal&quot;>&amp;#x2202;</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow></mrow><mrow><mi mathvariant=&quot;normal&quot;>&amp;#x2202;</mi><msub><mi>&amp;#x03B8;</mi><mi>i</mi></msub></mrow></mfrac><mo>=</mo><mn>0</mn><mspace width=&quot;1em&quot; /><mtext>if&amp;#xA0;</mtext><mi>i</mi><mo>&amp;#x2209;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1992\" style=\"width: 10.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.753em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.732em, 1008.7em, 3.232em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1993\"><span class=\"mfrac\" id=\"MathJax-Span-1994\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.15em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.57em;\"><span class=\"mrow\" id=\"MathJax-Span-1995\"><span class=\"mi\" id=\"MathJax-Span-1996\" style=\"font-family: STIXGeneral-Regular;\">∂</span><span class=\"texatom\" id=\"MathJax-Span-1997\"><span class=\"mrow\" id=\"MathJax-Span-1998\"><span class=\"mi\" id=\"MathJax-Span-1999\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1001.2em, 4.326em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.622em;\"><span class=\"mrow\" id=\"MathJax-Span-2000\"><span class=\"mi\" id=\"MathJax-Span-2001\" style=\"font-family: STIXGeneral-Regular;\">∂</span><span class=\"msubsup\" id=\"MathJax-Span-2002\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2003\" style=\"font-family: STIXGeneral-Italic;\">θ<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-2004\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1001.36em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 1.357em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2005\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-2006\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0</span><span class=\"mspace\" id=\"MathJax-Span-2007\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"mtext\" id=\"MathJax-Span-2008\" style=\"font-family: STIXGeneral-Regular;\">if&nbsp;</span><span class=\"mi\" id=\"MathJax-Span-2009\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2010\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∉</span><span class=\"texatom\" id=\"MathJax-Span-2011\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2012\"><span class=\"mi\" id=\"MathJax-Span-2013\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2014\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2015\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2016\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.059em; border-left: 0px solid; width: 0px; height: 2.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mfrac><mrow><mi mathvariant=\"normal\">∂</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow></mrow><mrow><mi mathvariant=\"normal\">∂</mi><msub><mi>θ</mi><mi>i</mi></msub></mrow></mfrac><mo>=</mo><mn>0</mn><mspace width=\"1em\"></mspace><mtext>if&nbsp;</mtext><mi>i</mi><mo>∉</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-267\">\\frac{\\partial \\mathcal{L}}{\\partial \\theta_i} = 0 \\quad \\text{if } i \\notin \\mathcal{E}(x)</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-268-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2017\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2018\"><span class=\"texatom\" id=\"MathJax-Span-2019\"><span class=\"mrow\" id=\"MathJax-Span-2020\"><span class=\"mi\" id=\"MathJax-Span-2021\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-268\">\\mathcal{L}</script> denotes the training loss.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This sparse update pattern is intentional and central to MoE scalability. It ensures that both computation and parameter updates scale with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-269-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2022\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2023\"><span class=\"mi\" id=\"MathJax-Span-2024\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-269\">k</script>, rather than with the total number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-270-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2025\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2026\"><span class=\"mi\" id=\"MathJax-Span-2027\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-270\">N</script> (<a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020)).</p>\n  </li>\n  <li>\n    <p>Notably, this already breaks forward–backward symmetry: all experts exist in the forward model definition, but only a small subset participates in gradient updates for any given token.h <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-271-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2028\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2029\"><span class=\"mi\" id=\"MathJax-Span-2030\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-271\">k</script>, not with the total number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-272-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2031\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2032\"><span class=\"mi\" id=\"MathJax-Span-2033\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-272\">N</script> (<a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020)).</p>\n  </li>\n</ul>\n<p>Each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-264-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1972\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1973\"><span class=\"msubsup\" id=\"MathJax-Span-1974\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1975\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-1976\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-264\">E_i</script> is a neural network with parameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-265-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B8;</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1977\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.73em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1978\"><span class=\"msubsup\" id=\"MathJax-Span-1979\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-1980\" style=\"font-family: STIXGeneral-Italic;\">θ<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-1981\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>θ</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-265\">\\theta_i</script>. For experts that are selected (i.e., <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-266-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-1982\" style=\"width: 4.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.44em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1003.39em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-1983\"><span class=\"mi\" id=\"MathJax-Span-1984\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-1985\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-1986\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-1987\"><span class=\"mi\" id=\"MathJax-Span-1988\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-1989\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-1990\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-1991\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-266\">i \\in \\mathcal{E}(x)</script>), gradients propagate normally through their computations.</p>\n<p>If an expert is not selected for a given token, its output is identically zero and it receives no gradient update:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-268-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2017\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2018\"><span class=\"texatom\" id=\"MathJax-Span-2019\"><span class=\"mrow\" id=\"MathJax-Span-2020\"><span class=\"mi\" id=\"MathJax-Span-2021\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-268\">\\mathcal{L}</script> denotes the training loss.</li>\n    </ul>\n<p>This sparse update pattern is intentional and central to MoE scalability. It ensures that both computation and parameter updates scale with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-269-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2022\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2023\"><span class=\"mi\" id=\"MathJax-Span-2024\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-269\">k</script>, rather than with the total number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-270-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2025\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2026\"><span class=\"mi\" id=\"MathJax-Span-2027\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-270\">N</script> (<a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020)).</p>\n<p>Notably, this already breaks forward–backward symmetry: all experts exist in the forward model definition, but only a small subset participates in gradient updates for any given token.h <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-271-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2028\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2029\"><span class=\"mi\" id=\"MathJax-Span-2030\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-271\">k</script>, not with the total number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-272-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2031\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2032\"><span class=\"mi\" id=\"MathJax-Span-2033\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-272\">N</script> (<a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020)).</p>",
    "contentMarkdown": "*   Each expert EiEiE\\_i is a neural network with parameters θiθi\\\\theta\\_i. For experts that are selected (i.e., i∈(x)i∈E(x)i \\\\in \\\\mathcal{E}(x)), gradients propagate normally through their computations.\n    \n*   If an expert is not selected for a given token, its output is identically zero and it receives no gradient update:\n    \n    ∂∂θi\\=0if i∉(x)∂L∂θi\\=0if i∉E(x)\n    \n    \\\\frac{\\\\partial \\\\mathcal{L}}{\\\\partial \\\\theta\\_i} = 0 \\\\quad \\\\text{if } i \\\\notin \\\\mathcal{E}(x)\n    *   where L\\\\mathcal{L} denotes the training loss.\n*   This sparse update pattern is intentional and central to MoE scalability. It ensures that both computation and parameter updates scale with kkk, rather than with the total number of experts NNN ([GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020)).\n    \n*   Notably, this already breaks forward–backward symmetry: all experts exist in the forward model definition, but only a small subset participates in gradient updates for any given token.h kkk, not with the total number of experts NNN ([GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020)).\n    \n\nEach expert EiEiE\\_i is a neural network with parameters θiθi\\\\theta\\_i. For experts that are selected (i.e., i∈(x)i∈E(x)i \\\\in \\\\mathcal{E}(x)), gradients propagate normally through their computations.\n\nIf an expert is not selected for a given token, its output is identically zero and it receives no gradient update:\n\n*   where L\\\\mathcal{L} denotes the training loss.\n\nThis sparse update pattern is intentional and central to MoE scalability. It ensures that both computation and parameter updates scale with kkk, rather than with the total number of experts NNN ([GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020)).\n\nNotably, this already breaks forward–backward symmetry: all experts exist in the forward model definition, but only a small subset participates in gradient updates for any given token.h kkk, not with the total number of experts NNN ([GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020)).",
    "contentLength": 33612,
    "wordCount": 282,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#gradient-flow-to-experts"
  },
  {
    "id": "ai-mixture-of-experts-gradient-flow-to-the-router-33",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Gradient Flow to the Router",
    "order": 33,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>\n    <p>Although expert selection is discrete, the router still receives gradients through the continuous routing probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-273-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2034\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2035\"><span class=\"msubsup\" id=\"MathJax-Span-2036\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2037\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2038\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-273\">p_i</script>.</p>\n  </li>\n  <li>\n    <p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-274-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2039\" style=\"width: 2.503em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.086em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.03em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2040\"><span class=\"msubsup\" id=\"MathJax-Span-2041\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2042\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2043\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2044\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2045\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2046\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-274\">E_i(x)</script> denote the output of expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-275-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2047\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2048\"><span class=\"mi\" id=\"MathJax-Span-2049\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-275\">i</script> applied to token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-276-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2050\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2051\"><span class=\"mi\" id=\"MathJax-Span-2052\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-276\">x</script>. The MoE layer output is typically formed as a probability-weighted sum over the selected experts:</p>\n  </li>\n</ul>\n<p>Although expert selection is discrete, the router still receives gradients through the continuous routing probabilities <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-273-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2034\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2035\"><span class=\"msubsup\" id=\"MathJax-Span-2036\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2037\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2038\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-273\">p_i</script>.</p>\n<p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-274-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2039\" style=\"width: 2.503em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.086em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.03em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2040\"><span class=\"msubsup\" id=\"MathJax-Span-2041\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2042\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2043\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2044\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2045\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2046\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-274\">E_i(x)</script> denote the output of expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-275-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2047\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2048\"><span class=\"mi\" id=\"MathJax-Span-2049\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-275\">i</script> applied to token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-276-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2050\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2051\"><span class=\"mi\" id=\"MathJax-Span-2052\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-276\">x</script>. The MoE layer output is typically formed as a probability-weighted sum over the selected experts:</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-277-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>y</mi><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo>,</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2053\" style=\"width: 8.544em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.086em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1007.03em, 3.701em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2054\"><span class=\"mi\" id=\"MathJax-Span-2055\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-2056\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2057\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.315em;\"><span class=\"mo\" id=\"MathJax-Span-2058\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.88em, 4.378em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2059\"><span class=\"mrow\" id=\"MathJax-Span-2060\"><span class=\"mi\" id=\"MathJax-Span-2061\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2062\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2063\"><span class=\"mrow\" id=\"MathJax-Span-2064\"><span class=\"mi\" id=\"MathJax-Span-2065\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2066\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2067\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2068\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2069\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2070\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2071\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2072\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2073\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2074\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2075\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2076\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2077\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2078\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.684em; border-left: 0px solid; width: 0px; height: 2.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>y</mi><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo>,</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>For selected experts, the loss depends smoothly on <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-278-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2079\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2080\"><span class=\"msubsup\" id=\"MathJax-Span-2081\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2082\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2083\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-278\">p_i</script>, which implies:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-279-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mfrac><mrow><mi mathvariant=&quot;normal&quot;>&amp;#x2202;</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow></mrow><mrow><mi mathvariant=&quot;normal&quot;>&amp;#x2202;</mi><msub><mi>p</mi><mi>i</mi></msub></mrow></mfrac><mo>&amp;#x2260;</mo><mn>0</mn><mspace width=&quot;1em&quot; /><mtext>if&amp;#xA0;</mtext><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2084\" style=\"width: 10.471em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.732em, 1008.65em, 3.284em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2085\"><span class=\"mfrac\" id=\"MathJax-Span-2086\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.15em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.57em;\"><span class=\"mrow\" id=\"MathJax-Span-2087\"><span class=\"mi\" id=\"MathJax-Span-2088\" style=\"font-family: STIXGeneral-Regular;\">∂</span><span class=\"texatom\" id=\"MathJax-Span-2089\"><span class=\"mrow\" id=\"MathJax-Span-2090\"><span class=\"mi\" id=\"MathJax-Span-2091\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1001.25em, 4.378em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.622em;\"><span class=\"mrow\" id=\"MathJax-Span-2092\"><span class=\"mi\" id=\"MathJax-Span-2093\" style=\"font-family: STIXGeneral-Regular;\">∂</span><span class=\"msubsup\" id=\"MathJax-Span-2094\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2095\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2096\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1001.36em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 1.357em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2097\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≠</span><span class=\"mn\" id=\"MathJax-Span-2098\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0</span><span class=\"mspace\" id=\"MathJax-Span-2099\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"mtext\" id=\"MathJax-Span-2100\" style=\"font-family: STIXGeneral-Regular;\">if&nbsp;</span><span class=\"mi\" id=\"MathJax-Span-2101\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2102\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2103\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2104\"><span class=\"mi\" id=\"MathJax-Span-2105\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2106\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2107\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2108\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.122em; border-left: 0px solid; width: 0px; height: 2.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mfrac><mrow><mi mathvariant=\"normal\">∂</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow></mrow><mrow><mi mathvariant=\"normal\">∂</mi><msub><mi>p</mi><mi>i</mi></msub></mrow></mfrac><mo>≠</mo><mn>0</mn><mspace width=\"1em\"></mspace><mtext>if&nbsp;</mtext><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">E</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>\n    <p>These gradients propagate backward through the softmax into the router parameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-280-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2109\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2110\"><span class=\"msubsup\" id=\"MathJax-Span-2111\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2112\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-2113\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-280\">W_g</script>. For non-selected experts, both the expert output and its contribution to the loss are zero, and thus they provide no routing gradient signal for that token.</p>\n  </li>\n  <li>\n    <p>This results in a biased gradient estimator: the router is optimized only with respect to experts that were chosen in the forward pass. Despite this bias, training remains stable in large-scale regimes (<a href=\"https://arxiv.org/abs/2106.05974\">Scaling Vision with Sparse Mixture of Experts</a> by Riquelme et al. (2021)).</p>\n  </li>\n</ul>\n<p>These gradients propagate backward through the softmax into the router parameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-280-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2109\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2110\"><span class=\"msubsup\" id=\"MathJax-Span-2111\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2112\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-2113\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-280\">W_g</script>. For non-selected experts, both the expert output and its contribution to the loss are zero, and thus they provide no routing gradient signal for that token.</p>\n<p>This results in a biased gradient estimator: the router is optimized only with respect to experts that were chosen in the forward pass. Despite this bias, training remains stable in large-scale regimes (<a href=\"https://arxiv.org/abs/2106.05974\">Scaling Vision with Sparse Mixture of Experts</a> by Riquelme et al. (2021)).</p>",
    "contentMarkdown": "*   Although expert selection is discrete, the router still receives gradients through the continuous routing probabilities pipip\\_i.\n    \n*   Let Ei(x)Ei(x)E\\_i(x) denote the output of expert iii applied to token xxx. The MoE layer output is typically formed as a probability-weighted sum over the selected experts:\n    \n\nAlthough expert selection is discrete, the router still receives gradients through the continuous routing probabilities pipip\\_i.\n\nLet Ei(x)Ei(x)E\\_i(x) denote the output of expert iii applied to token xxx. The MoE layer output is typically formed as a probability-weighted sum over the selected experts:\n\ny\\=∑i∈(x)pi,Ei(x)y\\=∑i∈E(x)pi,Ei(x)\n\n*   For selected experts, the loss depends smoothly on pipip\\_i, which implies:\n\n∂∂pi≠0if i∈(x)∂L∂pi≠0if i∈E(x)\n\n*   These gradients propagate backward through the softmax into the router parameters WgWgW\\_g. For non-selected experts, both the expert output and its contribution to the loss are zero, and thus they provide no routing gradient signal for that token.\n    \n*   This results in a biased gradient estimator: the router is optimized only with respect to experts that were chosen in the forward pass. Despite this bias, training remains stable in large-scale regimes ([Scaling Vision with Sparse Mixture of Experts](https://arxiv.org/abs/2106.05974) by Riquelme et al. (2021)).\n    \n\nThese gradients propagate backward through the softmax into the router parameters WgWgW\\_g. For non-selected experts, both the expert output and its contribution to the loss are zero, and thus they provide no routing gradient signal for that token.\n\nThis results in a biased gradient estimator: the router is optimized only with respect to experts that were chosen in the forward pass. Despite this bias, training remains stable in large-scale regimes ([Scaling Vision with Sparse Mixture of Experts](https://arxiv.org/abs/2106.05974) by Riquelme et al. (2021)).",
    "contentLength": 32500,
    "wordCount": 270,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#gradient-flow-to-the-router"
  },
  {
    "id": "ai-mixture-of-experts-relation-to-straight-through-estimators-34",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Relation to Straight-Through Estimators",
    "order": 34,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>\n    <p>This mechanism is closely related to straight-through estimators used in discrete latent variable models (<a href=\"https://arxiv.org/abs/1308.3432\">Estimating or Propagating Gradients Through Stochastic Neurons</a> by Bengio et al. (2013)). Conceptually, this creates a deliberately asymmetric computation graph::</p>\n\n    <ul>\n      <li>the forward pass uses a hard, discrete decision,</li>\n      <li>the backward pass treats routing weights as if they were continuous (and thus assumes a continuous approximation).</li>\n    </ul>\n  </li>\n  <li>As a result, the router is optimized with respect to a relaxed surrogate objective rather than the exact discrete routing function used at inference time.</li>\n  <li>From a symmetry perspective, this explicitly breaks forward–backward equivalence. In a fully symmetric model, the backward pass would compute exact gradients of the same function evaluated in the forward pass. In MoE routing (and straight-through estimators more generally), the backward pass instead computes gradients of a surrogate function.</li>\n  <li>\n    <p>Note that this asymmetry is not unique to MoEs and appears in several other deep learning settings:</p>\n\n    <ul>\n      <li>\n        <p><strong>Examples of symmetric forward–backward flows</strong>:</p>\n\n        <ul>\n          <li>Standard dense neural networks with continuous activations (e.g., ReLU, GELU), where gradients exactly correspond to the forward computation.</li>\n          <li>Soft attention mechanisms, such as Transformer self-attention, where softmax weights are used identically in both forward and backward passes (<a href=\"https://arxiv.org/abs/1706.03762\">Attention Is All You Need</a> by Vaswani et al. (2017)).</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Examples of asymmetric forward–backward flows</strong>:</p>\n\n        <ul>\n          <li>Straight-through estimators for discrete variables (Bengio et al., 2013).</li>\n          <li>Quantization-aware training, where forward passes use quantized weights but backward passes use full-precision gradients (<a href=\"https://arxiv.org/abs/1712.05877\">Quantization and Training of Neural Networks for Efficient Integer-Arithmetic-Only Inference</a> by Jacob et al. (2018)).</li>\n          <li>Dropout, where units are stochastically removed in the forward pass but gradients are rescaled deterministically (<a href=\"https://jmlr.org/papers/v15/srivastava14a.html\">Dropout: A Simple Way to Prevent Neural Networks from Overfitting</a> by Srivastava et al. (2014)).</li>\n          <li>REINFORCE-style gradient estimators for stochastic routing or sampling (<a href=\"https://link.springer.com/article/10.1007/BF00992696\">Simple Statistical Gradient-Following Algorithms for Connectionist Reinforcement Learning</a> by Williams (1992)).</li>\n          <li>MoE routing fits squarely into this second category: a controlled, engineered asymmetry that trades exactness for scalability.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>While not mathematically exact, this estimator has low variance and scales well in distributed systems, which is critical for large expert counts and trillion-parameter regimes.</li>\n</ul>\n<p>This mechanism is closely related to straight-through estimators used in discrete latent variable models (<a href=\"https://arxiv.org/abs/1308.3432\">Estimating or Propagating Gradients Through Stochastic Neurons</a> by Bengio et al. (2013)). Conceptually, this creates a deliberately asymmetric computation graph::</p>\n<ul>\n      <li>the forward pass uses a hard, discrete decision,</li>\n      <li>the backward pass treats routing weights as if they were continuous (and thus assumes a continuous approximation).</li>\n    </ul>\n<p>Note that this asymmetry is not unique to MoEs and appears in several other deep learning settings:</p>\n<ul>\n      <li>\n        <p><strong>Examples of symmetric forward–backward flows</strong>:</p>\n\n        <ul>\n          <li>Standard dense neural networks with continuous activations (e.g., ReLU, GELU), where gradients exactly correspond to the forward computation.</li>\n          <li>Soft attention mechanisms, such as Transformer self-attention, where softmax weights are used identically in both forward and backward passes (<a href=\"https://arxiv.org/abs/1706.03762\">Attention Is All You Need</a> by Vaswani et al. (2017)).</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Examples of asymmetric forward–backward flows</strong>:</p>\n\n        <ul>\n          <li>Straight-through estimators for discrete variables (Bengio et al., 2013).</li>\n          <li>Quantization-aware training, where forward passes use quantized weights but backward passes use full-precision gradients (<a href=\"https://arxiv.org/abs/1712.05877\">Quantization and Training of Neural Networks for Efficient Integer-Arithmetic-Only Inference</a> by Jacob et al. (2018)).</li>\n          <li>Dropout, where units are stochastically removed in the forward pass but gradients are rescaled deterministically (<a href=\"https://jmlr.org/papers/v15/srivastava14a.html\">Dropout: A Simple Way to Prevent Neural Networks from Overfitting</a> by Srivastava et al. (2014)).</li>\n          <li>REINFORCE-style gradient estimators for stochastic routing or sampling (<a href=\"https://link.springer.com/article/10.1007/BF00992696\">Simple Statistical Gradient-Following Algorithms for Connectionist Reinforcement Learning</a> by Williams (1992)).</li>\n          <li>MoE routing fits squarely into this second category: a controlled, engineered asymmetry that trades exactness for scalability.</li>\n        </ul>\n      </li>\n    </ul>\n<p><strong>Examples of symmetric forward–backward flows</strong>:</p>\n<ul>\n          <li>Standard dense neural networks with continuous activations (e.g., ReLU, GELU), where gradients exactly correspond to the forward computation.</li>\n          <li>Soft attention mechanisms, such as Transformer self-attention, where softmax weights are used identically in both forward and backward passes (<a href=\"https://arxiv.org/abs/1706.03762\">Attention Is All You Need</a> by Vaswani et al. (2017)).</li>\n        </ul>\n<p><strong>Examples of asymmetric forward–backward flows</strong>:</p>\n<ul>\n          <li>Straight-through estimators for discrete variables (Bengio et al., 2013).</li>\n          <li>Quantization-aware training, where forward passes use quantized weights but backward passes use full-precision gradients (<a href=\"https://arxiv.org/abs/1712.05877\">Quantization and Training of Neural Networks for Efficient Integer-Arithmetic-Only Inference</a> by Jacob et al. (2018)).</li>\n          <li>Dropout, where units are stochastically removed in the forward pass but gradients are rescaled deterministically (<a href=\"https://jmlr.org/papers/v15/srivastava14a.html\">Dropout: A Simple Way to Prevent Neural Networks from Overfitting</a> by Srivastava et al. (2014)).</li>\n          <li>REINFORCE-style gradient estimators for stochastic routing or sampling (<a href=\"https://link.springer.com/article/10.1007/BF00992696\">Simple Statistical Gradient-Following Algorithms for Connectionist Reinforcement Learning</a> by Williams (1992)).</li>\n          <li>MoE routing fits squarely into this second category: a controlled, engineered asymmetry that trades exactness for scalability.</li>\n        </ul>",
    "contentMarkdown": "*   This mechanism is closely related to straight-through estimators used in discrete latent variable models ([Estimating or Propagating Gradients Through Stochastic Neurons](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013)). Conceptually, this creates a deliberately asymmetric computation graph::\n    \n    *   the forward pass uses a hard, discrete decision,\n    *   the backward pass treats routing weights as if they were continuous (and thus assumes a continuous approximation).\n*   As a result, the router is optimized with respect to a relaxed surrogate objective rather than the exact discrete routing function used at inference time.\n*   From a symmetry perspective, this explicitly breaks forward–backward equivalence. In a fully symmetric model, the backward pass would compute exact gradients of the same function evaluated in the forward pass. In MoE routing (and straight-through estimators more generally), the backward pass instead computes gradients of a surrogate function.\n*   Note that this asymmetry is not unique to MoEs and appears in several other deep learning settings:\n    \n    *   **Examples of symmetric forward–backward flows**:\n        \n        *   Standard dense neural networks with continuous activations (e.g., ReLU, GELU), where gradients exactly correspond to the forward computation.\n        *   Soft attention mechanisms, such as Transformer self-attention, where softmax weights are used identically in both forward and backward passes ([Attention Is All You Need](https://arxiv.org/abs/1706.03762) by Vaswani et al. (2017)).\n    *   **Examples of asymmetric forward–backward flows**:\n        \n        *   Straight-through estimators for discrete variables (Bengio et al., 2013).\n        *   Quantization-aware training, where forward passes use quantized weights but backward passes use full-precision gradients ([Quantization and Training of Neural Networks for Efficient Integer-Arithmetic-Only Inference](https://arxiv.org/abs/1712.05877) by Jacob et al. (2018)).\n        *   Dropout, where units are stochastically removed in the forward pass but gradients are rescaled deterministically ([Dropout: A Simple Way to Prevent Neural Networks from Overfitting](https://jmlr.org/papers/v15/srivastava14a.html) by Srivastava et al. (2014)).\n        *   REINFORCE-style gradient estimators for stochastic routing or sampling ([Simple Statistical Gradient-Following Algorithms for Connectionist Reinforcement Learning](https://link.springer.com/article/10.1007/BF00992696) by Williams (1992)).\n        *   MoE routing fits squarely into this second category: a controlled, engineered asymmetry that trades exactness for scalability.\n*   While not mathematically exact, this estimator has low variance and scales well in distributed systems, which is critical for large expert counts and trillion-parameter regimes.\n\nThis mechanism is closely related to straight-through estimators used in discrete latent variable models ([Estimating or Propagating Gradients Through Stochastic Neurons](https://arxiv.org/abs/1308.3432) by Bengio et al. (2013)). Conceptually, this creates a deliberately asymmetric computation graph::\n\n*   the forward pass uses a hard, discrete decision,\n*   the backward pass treats routing weights as if they were continuous (and thus assumes a continuous approximation).\n\nNote that this asymmetry is not unique to MoEs and appears in several other deep learning settings:\n\n*   **Examples of symmetric forward–backward flows**:\n    \n    *   Standard dense neural networks with continuous activations (e.g., ReLU, GELU), where gradients exactly correspond to the forward computation.\n    *   Soft attention mechanisms, such as Transformer self-attention, where softmax weights are used identically in both forward and backward passes ([Attention Is All You Need](https://arxiv.org/abs/1706.03762) by Vaswani et al. (2017)).\n*   **Examples of asymmetric forward–backward flows**:\n    \n    *   Straight-through estimators for discrete variables (Bengio et al., 2013).\n    *   Quantization-aware training, where forward passes use quantized weights but backward passes use full-precision gradients ([Quantization and Training of Neural Networks for Efficient Integer-Arithmetic-Only Inference](https://arxiv.org/abs/1712.05877) by Jacob et al. (2018)).\n    *   Dropout, where units are stochastically removed in the forward pass but gradients are rescaled deterministically ([Dropout: A Simple Way to Prevent Neural Networks from Overfitting](https://jmlr.org/papers/v15/srivastava14a.html) by Srivastava et al. (2014)).\n    *   REINFORCE-style gradient estimators for stochastic routing or sampling ([Simple Statistical Gradient-Following Algorithms for Connectionist Reinforcement Learning](https://link.springer.com/article/10.1007/BF00992696) by Williams (1992)).\n    *   MoE routing fits squarely into this second category: a controlled, engineered asymmetry that trades exactness for scalability.\n\n**Examples of symmetric forward–backward flows**:\n\n*   Standard dense neural networks with continuous activations (e.g., ReLU, GELU), where gradients exactly correspond to the forward computation.\n*   Soft attention mechanisms, such as Transformer self-attention, where softmax weights are used identically in both forward and backward passes ([Attention Is All You Need](https://arxiv.org/abs/1706.03762) by Vaswani et al. (2017)).\n\n**Examples of asymmetric forward–backward flows**:\n\n*   Straight-through estimators for discrete variables (Bengio et al., 2013).\n*   Quantization-aware training, where forward passes use quantized weights but backward passes use full-precision gradients ([Quantization and Training of Neural Networks for Efficient Integer-Arithmetic-Only Inference](https://arxiv.org/abs/1712.05877) by Jacob et al. (2018)).\n*   Dropout, where units are stochastically removed in the forward pass but gradients are rescaled deterministically ([Dropout: A Simple Way to Prevent Neural Networks from Overfitting](https://jmlr.org/papers/v15/srivastava14a.html) by Srivastava et al. (2014)).\n*   REINFORCE-style gradient estimators for stochastic routing or sampling ([Simple Statistical Gradient-Following Algorithms for Connectionist Reinforcement Learning](https://link.springer.com/article/10.1007/BF00992696) by Williams (1992)).\n*   MoE routing fits squarely into this second category: a controlled, engineered asymmetry that trades exactness for scalability.",
    "contentLength": 7351,
    "wordCount": 767,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#relation-to-straight-through-estimators"
  },
  {
    "id": "ai-mixture-of-experts-load-balancing-loss-and-dense-router-gradients-35",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Load-Balancing Loss and Dense Router Gradients",
    "order": 35,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p>To prevent routing collapse—where a few experts dominate—modern MoEs introduce an auxiliary load-balancing loss that depends directly on routing probabilities. This idea was introduced in <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017), and refined in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021).</p>\n  </li>\n  <li>\n    <p>Let:</p>\n\n    <ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-281-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2114\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2115\"><span class=\"msubsup\" id=\"MathJax-Span-2116\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2117\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2118\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-281\">f_i</script> be the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-282-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2119\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2120\"><span class=\"mi\" id=\"MathJax-Span-2121\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-282\">i</script>,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-283-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2122\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2123\"><span class=\"msubsup\" id=\"MathJax-Span-2124\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2125\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2126\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-283\">p_i</script> be the mean routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-284-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2127\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2128\"><span class=\"mi\" id=\"MathJax-Span-2129\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-284\">i</script>.</li>\n    </ul>\n  </li>\n  <li>\n    <p>The standard load-balancing loss is:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-285-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>lb</mtext></mrow></msub><mo>=</mo><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2130\" style=\"width: 7.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1006.36em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2131\"><span class=\"msubsup\" id=\"MathJax-Span-2132\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2133\"><span class=\"mrow\" id=\"MathJax-Span-2134\"><span class=\"mi\" id=\"MathJax-Span-2135\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-2136\"><span class=\"mrow\" id=\"MathJax-Span-2137\"><span class=\"mtext\" id=\"MathJax-Span-2138\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">lb</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2139\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-2140\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-2141\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2142\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2143\"><span class=\"mrow\" id=\"MathJax-Span-2144\"><span class=\"mi\" id=\"MathJax-Span-2145\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2146\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2147\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.367em;\"><span class=\"texatom\" id=\"MathJax-Span-2148\"><span class=\"mrow\" id=\"MathJax-Span-2149\"><span class=\"mi\" id=\"MathJax-Span-2150\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2151\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2152\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2153\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2154\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2155\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2156\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>lb</mtext></mrow></msub><mo>=</mo><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-285\">\\mathcal{L}_{\\text{lb}} = N \\sum_{i=1}^{N} f_i p_i</script>\n  </li>\n  <li>\n    <p>This loss is fully differentiable with respect to the router parameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-286-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2157\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2158\"><span class=\"msubsup\" id=\"MathJax-Span-2159\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2160\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-2161\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-286\">W_g</script> and provides gradient signal even for experts that are not selected in the forward pass. Importantly, it partially restores symmetry by introducing a dense, smooth objective that is optimized consistently in both forward statistics and backward gradients. As shown in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021), this term is critical for maintaining expert utilization and training stability.</p>\n  </li>\n</ul>\n<p>To prevent routing collapse—where a few experts dominate—modern MoEs introduce an auxiliary load-balancing loss that depends directly on routing probabilities. This idea was introduced in <a href=\"https://arxiv.org/abs/1701.06538\">Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer</a> by Shazeer et al. (2017), and refined in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021).</p>\n<p>Let:</p>\n<ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-281-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2114\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2115\"><span class=\"msubsup\" id=\"MathJax-Span-2116\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2117\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2118\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-281\">f_i</script> be the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-282-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2119\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2120\"><span class=\"mi\" id=\"MathJax-Span-2121\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-282\">i</script>,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-283-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2122\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2123\"><span class=\"msubsup\" id=\"MathJax-Span-2124\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2125\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2126\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-283\">p_i</script> be the mean routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-284-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2127\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2128\"><span class=\"mi\" id=\"MathJax-Span-2129\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-284\">i</script>.</li>\n    </ul>\n<p>The standard load-balancing loss is:</p>\n<p>This loss is fully differentiable with respect to the router parameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-286-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>g</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2157\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2158\"><span class=\"msubsup\" id=\"MathJax-Span-2159\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2160\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-2161\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>g</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-286\">W_g</script> and provides gradient signal even for experts that are not selected in the forward pass. Importantly, it partially restores symmetry by introducing a dense, smooth objective that is optimized consistently in both forward statistics and backward gradients. As shown in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> by Fedus et al. (2021), this term is critical for maintaining expert utilization and training stability.</p>",
    "contentMarkdown": "*   To prevent routing collapse—where a few experts dominate—modern MoEs introduce an auxiliary load-balancing loss that depends directly on routing probabilities. This idea was introduced in [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017), and refined in [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021).\n    \n*   Let:\n    \n    *   fifif\\_i be the fraction of tokens routed to expert iii,\n    *   pipip\\_i be the mean routing probability for expert iii.\n*   The standard load-balancing loss is:\n    \n    lb\\=N∑i\\=1NfipiLlb\\=N∑i\\=1Nfipi\n    \n    \\\\mathcal{L}\\_{\\\\text{lb}} = N \\\\sum\\_{i=1}^{N} f\\_i p\\_i\n*   This loss is fully differentiable with respect to the router parameters WgWgW\\_g and provides gradient signal even for experts that are not selected in the forward pass. Importantly, it partially restores symmetry by introducing a dense, smooth objective that is optimized consistently in both forward statistics and backward gradients. As shown in [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), this term is critical for maintaining expert utilization and training stability.\n    \n\nTo prevent routing collapse—where a few experts dominate—modern MoEs introduce an auxiliary load-balancing loss that depends directly on routing probabilities. This idea was introduced in [Outrageously Large Neural Networks: The Sparsely-Gated Mixture-of-Experts Layer](https://arxiv.org/abs/1701.06538) by Shazeer et al. (2017), and refined in [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021).\n\nLet:\n\n*   fifif\\_i be the fraction of tokens routed to expert iii,\n*   pipip\\_i be the mean routing probability for expert iii.\n\nThe standard load-balancing loss is:\n\nThis loss is fully differentiable with respect to the router parameters WgWgW\\_g and provides gradient signal even for experts that are not selected in the forward pass. Importantly, it partially restores symmetry by introducing a dense, smooth objective that is optimized consistently in both forward statistics and backward gradients. As shown in [Switch Transformers](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), this term is critical for maintaining expert utilization and training stability.",
    "contentLength": 24885,
    "wordCount": 301,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#load-balancing-loss-and-dense-router-gradients"
  },
  {
    "id": "ai-mixture-of-experts-why-biased-gradients-are-acceptable-36",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Differentiability of Sparse Routing in Mixture-of-Experts",
    "title": "Why Biased Gradients are Acceptable",
    "order": 36,
    "orderInChapter": 7,
    "contentHtml": "<ul>\n  <li>\n    <p>Exact gradients would require evaluating all experts for every token, eliminating the computational advantage of MoEs. Sparse routing therefore trades unbiased gradients for scalability.</p>\n  </li>\n  <li>\n    <p>Empirical evidence across large systems—including <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2022) and <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks</a> by Gale et al. (2022)—shows that expert specialization reduces gradient interference, biased routing gradients do not prevent convergence, and performance improves as model scale increases.</p>\n  </li>\n</ul>\n<p>Exact gradients would require evaluating all experts for every token, eliminating the computational advantage of MoEs. Sparse routing therefore trades unbiased gradients for scalability.</p>\n<p>Empirical evidence across large systems—including <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2022) and <a href=\"https://arxiv.org/abs/2211.15841\">MegaBlocks</a> by Gale et al. (2022)—shows that expert specialization reduces gradient interference, biased routing gradients do not prevent convergence, and performance improves as model scale increases.</p>",
    "contentMarkdown": "*   Exact gradients would require evaluating all experts for every token, eliminating the computational advantage of MoEs. Sparse routing therefore trades unbiased gradients for scalability.\n    \n*   Empirical evidence across large systems—including [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2022) and [MegaBlocks](https://arxiv.org/abs/2211.15841) by Gale et al. (2022)—shows that expert specialization reduces gradient interference, biased routing gradients do not prevent convergence, and performance improves as model scale increases.\n    \n\nExact gradients would require evaluating all experts for every token, eliminating the computational advantage of MoEs. Sparse routing therefore trades unbiased gradients for scalability.\n\nEmpirical evidence across large systems—including [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2022) and [MegaBlocks](https://arxiv.org/abs/2211.15841) by Gale et al. (2022)—shows that expert specialization reduces gradient interference, biased routing gradients do not prevent convergence, and performance improves as model scale increases.",
    "contentLength": 1198,
    "wordCount": 126,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#why-biased-gradients-are-acceptable"
  },
  {
    "id": "ai-mixture-of-experts-overview-37",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Implementation",
    "title": "Overview",
    "order": 37,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>The architecture, as implemented in the above code, uses a routing mechanism to direct each input token to the most relevant experts. The router, implemented as a linear layer in the <code class=\"language-plaintext highlighter-rouge\">gate</code> variable, transforms hidden states into logits that are subsequently converted into selection probabilities. These probabilities determine which experts contribute to the output for each token. The final output for each token is a weighted sum of the outputs from the selected experts, ensuring that each part of the input data is processed by the most suitable parts of the network. This method enhances the model’s efficiency and scalability by leveraging specialized networks (experts) only when they are most relevant.</li>\n</ul>",
    "contentMarkdown": "*   The architecture, as implemented in the above code, uses a routing mechanism to direct each input token to the most relevant experts. The router, implemented as a linear layer in the `gate` variable, transforms hidden states into logits that are subsequently converted into selection probabilities. These probabilities determine which experts contribute to the output for each token. The final output for each token is a weighted sum of the outputs from the selected experts, ensuring that each part of the input data is processed by the most suitable parts of the network. This method enhances the model’s efficiency and scalability by leveraging specialized networks (experts) only when they are most relevant.",
    "contentLength": 790,
    "wordCount": 112,
    "hasCode": true,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#overview"
  },
  {
    "id": "ai-mixture-of-experts-components-38",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Implementation",
    "title": "Components",
    "order": 38,
    "orderInChapter": 2,
    "contentHtml": "<h4 id=\"feedforward-class\"><code class=\"language-plaintext Highlighter-rouge\">FeedForward</code> Class</h4>\n<ul>\n  <li>This class defines an individual expert, which is a basic feed-forward network. It consists of three linear layers:\n    <ul>\n      <li><code class=\"language-plaintext highlighter-rouge\">w1</code> and <code class=\"language-plaintext highlighter-rouge\">w2</code> transform the input tensor, and</li>\n      <li><code class=\"language-plaintext highlighter-rouge\">w3</code> combines these transformations.</li>\n    </ul>\n  </li>\n  <li>The <code class=\"language-plaintext highlighter-rouge\">forward</code> method computes the output of this feed-forward network by applying the sequence of transformations and non-linear activations (SiLU, also known as Swish).</li>\n</ul>\n<ul>\n      <li><code class=\"language-plaintext highlighter-rouge\">w1</code> and <code class=\"language-plaintext highlighter-rouge\">w2</code> transform the input tensor, and</li>\n      <li><code class=\"language-plaintext highlighter-rouge\">w3</code> combines these transformations.</li>\n    </ul>\n<h4 id=\"mixtureofexpertslayer-class\"><code class=\"language-plaintext Highlighter-rouge\">MixtureOfExpertsLayer</code> Class</h4>\n<ul>\n  <li>This class orchestrates the interaction of multiple experts to process the input data.\n    <ul>\n      <li><strong>Initialization (<code class=\"language-plaintext highlighter-rouge\">__init__</code>)</strong>:\n        <ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">num_experts</code>: Total number of expert networks.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">n_experts_per_token</code>: Number of experts that should process each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">experts</code>: A list of expert networks.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">gate</code>: A linear layer that acts as the router, which computes logits (pre-softmax scores) that determine how much each expert contributes to processing each token.</li>\n        </ul>\n      </li>\n      <li><strong>Forward Pass (<code class=\"language-plaintext highlighter-rouge\">forward</code>)</strong>:\n        <ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">gate_logits</code>: The router outputs logits for each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">weights, selected_experts</code>: Using <code class=\"language-plaintext highlighter-rouge\">torch.topk</code>, the top <code class=\"language-plaintext highlighter-rouge\">n_experts_per_token</code> experts are selected based on the highest logits for each token, indicating which experts are most relevant for each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">weights</code>: Normalized using softmax to convert logits into probabilities indicating the importance of each selected expert’s contribution.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">out</code>: Initializes an output tensor with zeros, having the same shape as the input <code class=\"language-plaintext highlighter-rouge\">x</code>.</li>\n          <li>For each expert, the method computes the weighted contribution of the expert’s output to the final output tensor. This is done only for selected experts for each token.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n</ul>\n<ul>\n      <li><strong>Initialization (<code class=\"language-plaintext highlighter-rouge\">__init__</code>)</strong>:\n        <ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">num_experts</code>: Total number of expert networks.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">n_experts_per_token</code>: Number of experts that should process each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">experts</code>: A list of expert networks.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">gate</code>: A linear layer that acts as the router, which computes logits (pre-softmax scores) that determine how much each expert contributes to processing each token.</li>\n        </ul>\n      </li>\n      <li><strong>Forward Pass (<code class=\"language-plaintext highlighter-rouge\">forward</code>)</strong>:\n        <ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">gate_logits</code>: The router outputs logits for each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">weights, selected_experts</code>: Using <code class=\"language-plaintext highlighter-rouge\">torch.topk</code>, the top <code class=\"language-plaintext highlighter-rouge\">n_experts_per_token</code> experts are selected based on the highest logits for each token, indicating which experts are most relevant for each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">weights</code>: Normalized using softmax to convert logits into probabilities indicating the importance of each selected expert’s contribution.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">out</code>: Initializes an output tensor with zeros, having the same shape as the input <code class=\"language-plaintext highlighter-rouge\">x</code>.</li>\n          <li>For each expert, the method computes the weighted contribution of the expert’s output to the final output tensor. This is done only for selected experts for each token.</li>\n        </ul>\n      </li>\n    </ul>\n<ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">num_experts</code>: Total number of expert networks.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">n_experts_per_token</code>: Number of experts that should process each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">experts</code>: A list of expert networks.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">gate</code>: A linear layer that acts as the router, which computes logits (pre-softmax scores) that determine how much each expert contributes to processing each token.</li>\n        </ul>\n<ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">gate_logits</code>: The router outputs logits for each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">weights, selected_experts</code>: Using <code class=\"language-plaintext highlighter-rouge\">torch.topk</code>, the top <code class=\"language-plaintext highlighter-rouge\">n_experts_per_token</code> experts are selected based on the highest logits for each token, indicating which experts are most relevant for each token.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">weights</code>: Normalized using softmax to convert logits into probabilities indicating the importance of each selected expert’s contribution.</li>\n          <li><code class=\"language-plaintext highlighter-rouge\">out</code>: Initializes an output tensor with zeros, having the same shape as the input <code class=\"language-plaintext highlighter-rouge\">x</code>.</li>\n          <li>For each expert, the method computes the weighted contribution of the expert’s output to the final output tensor. This is done only for selected experts for each token.</li>\n        </ul>",
    "contentMarkdown": "#### `FeedForward` Class\n\n*   This class defines an individual expert, which is a basic feed-forward network. It consists of three linear layers:\n    *   `w1` and `w2` transform the input tensor, and\n    *   `w3` combines these transformations.\n*   The `forward` method computes the output of this feed-forward network by applying the sequence of transformations and non-linear activations (SiLU, also known as Swish).\n\n*   `w1` and `w2` transform the input tensor, and\n*   `w3` combines these transformations.\n\n#### `MixtureOfExpertsLayer` Class\n\n*   This class orchestrates the interaction of multiple experts to process the input data.\n    *   **Initialization (`__init__`)**:\n        *   `num_experts`: Total number of expert networks.\n        *   `n_experts_per_token`: Number of experts that should process each token.\n        *   `experts`: A list of expert networks.\n        *   `gate`: A linear layer that acts as the router, which computes logits (pre-softmax scores) that determine how much each expert contributes to processing each token.\n    *   **Forward Pass (`forward`)**:\n        *   `gate_logits`: The router outputs logits for each token.\n        *   `weights, selected_experts`: Using `torch.topk`, the top `n_experts_per_token` experts are selected based on the highest logits for each token, indicating which experts are most relevant for each token.\n        *   `weights`: Normalized using softmax to convert logits into probabilities indicating the importance of each selected expert’s contribution.\n        *   `out`: Initializes an output tensor with zeros, having the same shape as the input `x`.\n        *   For each expert, the method computes the weighted contribution of the expert’s output to the final output tensor. This is done only for selected experts for each token.\n\n*   **Initialization (`__init__`)**:\n    *   `num_experts`: Total number of expert networks.\n    *   `n_experts_per_token`: Number of experts that should process each token.\n    *   `experts`: A list of expert networks.\n    *   `gate`: A linear layer that acts as the router, which computes logits (pre-softmax scores) that determine how much each expert contributes to processing each token.\n*   **Forward Pass (`forward`)**:\n    *   `gate_logits`: The router outputs logits for each token.\n    *   `weights, selected_experts`: Using `torch.topk`, the top `n_experts_per_token` experts are selected based on the highest logits for each token, indicating which experts are most relevant for each token.\n    *   `weights`: Normalized using softmax to convert logits into probabilities indicating the importance of each selected expert’s contribution.\n    *   `out`: Initializes an output tensor with zeros, having the same shape as the input `x`.\n    *   For each expert, the method computes the weighted contribution of the expert’s output to the final output tensor. This is done only for selected experts for each token.\n\n*   `num_experts`: Total number of expert networks.\n*   `n_experts_per_token`: Number of experts that should process each token.\n*   `experts`: A list of expert networks.\n*   `gate`: A linear layer that acts as the router, which computes logits (pre-softmax scores) that determine how much each expert contributes to processing each token.\n\n*   `gate_logits`: The router outputs logits for each token.\n*   `weights, selected_experts`: Using `torch.topk`, the top `n_experts_per_token` experts are selected based on the highest logits for each token, indicating which experts are most relevant for each token.\n*   `weights`: Normalized using softmax to convert logits into probabilities indicating the importance of each selected expert’s contribution.\n*   `out`: Initializes an output tensor with zeros, having the same shape as the input `x`.\n*   For each expert, the method computes the weighted contribution of the expert’s output to the final output tensor. This is done only for selected experts for each token.",
    "contentLength": 7292,
    "wordCount": 556,
    "hasCode": true,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#components"
  },
  {
    "id": "ai-mixture-of-experts-core-idea-reversing-the-routing-direction-39",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Choice Routing",
    "title": "Core Idea: Reversing the Routing Direction",
    "order": 39,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>Traditional MoE models employ a <strong>token-centric routing</strong> strategy. Each token is passed through a gating function that computes a softmax or top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-293-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2206\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2207\"><span class=\"mi\" id=\"MathJax-Span-2208\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-293\">k</script> score over all available experts, selecting the most relevant ones for processing. Consequently, the gating network determines where each token goes, often leading to congestion among experts that receive high routing scores.</p>\n  </li>\n  <li>\n    <p>In contrast, <strong>EC routing</strong> adopts an <strong>expert-centric routing</strong> perspective. Here, the gating network computes a <em>token-to-expert score matrix</em>, where each entry represents how compatible a given token is with a specific expert. Instead of having tokens compete for experts, each expert selects the subset of tokens that it finds most relevant, typically based on the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-294-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2209\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2210\"><span class=\"mi\" id=\"MathJax-Span-2211\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-294\">k</script> scoring values. This inversion ensures that every expert processes approximately the same number of tokens, resulting in better load balancing and more uniform expert utilization.</p>\n  </li>\n  <li>\n    <p>The following figure shows the contrast between <strong>token-to-expert routing</strong> and <strong>expert-to-token routing</strong>, highlighting how EC ensures balanced load distribution and efficient specialization.</p>\n  </li>\n</ul>\n<p>Traditional MoE models employ a <strong>token-centric routing</strong> strategy. Each token is passed through a gating function that computes a softmax or top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-293-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2206\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2207\"><span class=\"mi\" id=\"MathJax-Span-2208\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-293\">k</script> score over all available experts, selecting the most relevant ones for processing. Consequently, the gating network determines where each token goes, often leading to congestion among experts that receive high routing scores.</p>\n<p>In contrast, <strong>EC routing</strong> adopts an <strong>expert-centric routing</strong> perspective. Here, the gating network computes a <em>token-to-expert score matrix</em>, where each entry represents how compatible a given token is with a specific expert. Instead of having tokens compete for experts, each expert selects the subset of tokens that it finds most relevant, typically based on the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-294-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2209\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2210\"><span class=\"mi\" id=\"MathJax-Span-2211\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-294\">k</script> scoring values. This inversion ensures that every expert processes approximately the same number of tokens, resulting in better load balancing and more uniform expert utilization.</p>\n<p>The following figure shows the contrast between <strong>token-to-expert routing</strong> and <strong>expert-to-token routing</strong>, highlighting how EC ensures balanced load distribution and efficient specialization.</p>\n<p><img src=\"/primers/ai/assets/mixture-of-experts/expert_choice_routing.jpg\" alt=\"Illustration of Expert Choice Routing\"></p>",
    "contentMarkdown": "*   Traditional MoE models employ a **token-centric routing** strategy. Each token is passed through a gating function that computes a softmax or top-kkk score over all available experts, selecting the most relevant ones for processing. Consequently, the gating network determines where each token goes, often leading to congestion among experts that receive high routing scores.\n    \n*   In contrast, **EC routing** adopts an **expert-centric routing** perspective. Here, the gating network computes a _token-to-expert score matrix_, where each entry represents how compatible a given token is with a specific expert. Instead of having tokens compete for experts, each expert selects the subset of tokens that it finds most relevant, typically based on the top-kkk scoring values. This inversion ensures that every expert processes approximately the same number of tokens, resulting in better load balancing and more uniform expert utilization.\n    \n*   The following figure shows the contrast between **token-to-expert routing** and **expert-to-token routing**, highlighting how EC ensures balanced load distribution and efficient specialization.\n    \n\nTraditional MoE models employ a **token-centric routing** strategy. Each token is passed through a gating function that computes a softmax or top-kkk score over all available experts, selecting the most relevant ones for processing. Consequently, the gating network determines where each token goes, often leading to congestion among experts that receive high routing scores.\n\nIn contrast, **EC routing** adopts an **expert-centric routing** perspective. Here, the gating network computes a _token-to-expert score matrix_, where each entry represents how compatible a given token is with a specific expert. Instead of having tokens compete for experts, each expert selects the subset of tokens that it finds most relevant, typically based on the top-kkk scoring values. This inversion ensures that every expert processes approximately the same number of tokens, resulting in better load balancing and more uniform expert utilization.\n\nThe following figure shows the contrast between **token-to-expert routing** and **expert-to-token routing**, highlighting how EC ensures balanced load distribution and efficient specialization.\n\n![Illustration of Expert Choice Routing](/primers/ai/assets/mixture-of-experts/expert_choice_routing.jpg)",
    "contentLength": 7722,
    "wordCount": 322,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#core-idea:-reversing-the-routing-direction"
  },
  {
    "id": "ai-mixture-of-experts-step-by-step-workflow-of-expert-choice-routing-40",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Choice Routing",
    "title": "Step-by-Step Workflow of Expert Choice Routing",
    "order": 40,
    "orderInChapter": 2,
    "contentHtml": "<ol>\n  <li>\n    <p><strong>Token-to-Expert Scoring</strong>:</p>\n\n    <ul>\n      <li>\n        <p>The EC routing process begins by computing a <em>token-to-expert score matrix</em>, denoted as</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-295-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>S</mi><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mo>&amp;#x00D7;</mo><mi>E</mi></mrow></msup></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2212\" style=\"width: 4.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.961em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1003.96em, 2.451em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2213\"><span class=\"mi\" id=\"MathJax-Span-2214\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2215\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-2216\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2217\"><span class=\"mrow\" id=\"MathJax-Span-2218\"><span class=\"mi\" id=\"MathJax-Span-2219\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.424em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-2220\"><span class=\"mrow\" id=\"MathJax-Span-2221\"><span class=\"mi\" id=\"MathJax-Span-2222\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2223\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-2224\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>S</mi><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>T</mi><mo>×</mo><mi>E</mi></mrow></msup></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-295\">S \\in \\mathbb{R}^{T \\times E}</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-296-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2225\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2226\"><span class=\"mi\" id=\"MathJax-Span-2227\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-296\">T</script> is the number of tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-297-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2228\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2229\"><span class=\"mi\" id=\"MathJax-Span-2230\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-297\">E</script> is the number of experts.</li>\n        </ul>\n      </li>\n      <li>\n        <p>Each element <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-298-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2231\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2232\"><span class=\"msubsup\" id=\"MathJax-Span-2233\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2234\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2235\"><span class=\"mrow\" id=\"MathJax-Span-2236\"><span class=\"mi\" id=\"MathJax-Span-2237\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2238\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2239\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-298\">S_{t,e}</script> represents the relevance or affinity score between token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-299-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2240\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2241\"><span class=\"mi\" id=\"MathJax-Span-2242\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-299\">t</script> and expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-300-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2243\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2244\"><span class=\"mi\" id=\"MathJax-Span-2245\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-300\">e</script>. This score is typically obtained via a linear projection or dot-product similarity in the embedding space.</p>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Expert Capacity Definition</strong>:</p>\n\n    <ul>\n      <li>Each expert is assigned a maximum capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-301-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2246\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2247\"><span class=\"msubsup\" id=\"MathJax-Span-2248\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2249\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2250\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>C</mi><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-301\">C_e</script>, defined as the number of tokens it can process concurrently.</li>\n      <li>\n        <p>The capacity is determined as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-302-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>C</mi><mi>e</mi></msub><mo>=</mo><mtext>Capacity Factor</mtext><mo>&amp;#x00D7;</mo><mfrac><mi>T</mi><mi>E</mi></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2251\" style=\"width: 12.763em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1010.63em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2252\"><span class=\"msubsup\" id=\"MathJax-Span-2253\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2254\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2255\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2256\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2257\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">Capacity Factor</span><span class=\"mo\" id=\"MathJax-Span-2258\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mfrac\" id=\"MathJax-Span-2259\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-2260\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-2261\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>C</mi><mi>e</mi></msub><mo>=</mo><mtext>Capacity Factor</mtext><mo>×</mo><mfrac><mi>T</mi><mi>E</mi></mfrac></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-302\">C_e = \\text{Capacity Factor} \\times \\frac{T}{E}</script>\n\n        <ul>\n          <li>where the <em>capacity factor</em> is a hyperparameter controlling the trade-off between load balancing and computational efficiency.</li>\n        </ul>\n      </li>\n      <li>If the capacity factor is greater than 1, experts may overlap in token assignments, increasing redundancy but also resilience to routing noise.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Expert Token Selection (top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-303-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2262\" style=\"width: 0.622em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.519em; height: 0px; font-size: 121%;\"><span style=\"position: absolute; clip: rect(1.346em, 1000.52em, 2.327em, -999.997em); top: -2.167em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2263\"><span class=\"mi\" id=\"MathJax-Span-2264\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.172em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-303\">k</script> Selection)</strong>:</p>\n\n    <ul>\n      <li>Each expert independently selects the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-304-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2265\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2266\"><span class=\"mi\" id=\"MathJax-Span-2267\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-304\">k</script> tokens from the score matrix that best match its learned specialization.</li>\n      <li>This results in an allocation that maximizes compatibility while respecting the expert capacity constraint.</li>\n      <li>Mathematically, for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-305-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2268\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2269\"><span class=\"mi\" id=\"MathJax-Span-2270\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-305\">e</script>:</li>\n    </ul>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-306-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>T</mi></mrow><mi>e</mi></msub><mo>=</mo><mtext>TopK</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo maxsize=&quot;1.2em&quot; minsize=&quot;1.2em&quot;>(</mo></mrow><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub><mo>,</mo><msub><mi>C</mi><mi>e</mi></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo maxsize=&quot;1.2em&quot; minsize=&quot;1.2em&quot;>)</mo></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2271\" style=\"width: 9.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.128em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.086em, 1007.97em, 3.753em, -999.997em); top: -3.174em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2272\"><span class=\"msubsup\" id=\"MathJax-Span-2273\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.128em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2274\"><span class=\"mrow\" id=\"MathJax-Span-2275\"><span class=\"mi\" id=\"MathJax-Span-2276\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.211em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2277\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2278\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2279\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">TopK</span><span class=\"texatom\" id=\"MathJax-Span-2280\"><span class=\"mrow\" id=\"MathJax-Span-2281\"><span class=\"mo\" id=\"MathJax-Span-2282\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">(</span></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2283\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2284\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2285\"><span class=\"mrow\" id=\"MathJax-Span-2286\"><span class=\"mo\" id=\"MathJax-Span-2287\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">:</span><span class=\"mo\" id=\"MathJax-Span-2288\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2289\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2290\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2291\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2292\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2293\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-2294\"><span class=\"mrow\" id=\"MathJax-Span-2295\"><span class=\"mo\" id=\"MathJax-Span-2296\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">)</span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.18em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.559em; border-left: 0px solid; width: 0px; height: 1.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">T</mi></mrow><mi>e</mi></msub><mo>=</mo><mtext>TopK</mtext><mrow class=\"MJX-TeXAtom-ORD\"><mo maxsize=\"1.2em\" minsize=\"1.2em\">(</mo></mrow><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub><mo>,</mo><msub><mi>C</mi><mi>e</mi></msub><mrow class=\"MJX-TeXAtom-ORD\"><mo maxsize=\"1.2em\" minsize=\"1.2em\">)</mo></mrow></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-306\">\\mathcal{T}_e = \\text{TopK}\\big(S_{:, e}, C_e\\big)</script>\n\n    <ul>\n      <li>where:\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-307-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>T</mi></mrow><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2297\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2298\"><span class=\"msubsup\" id=\"MathJax-Span-2299\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.128em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2300\"><span class=\"mrow\" id=\"MathJax-Span-2301\"><span class=\"mi\" id=\"MathJax-Span-2302\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.211em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2303\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">T</mi></mrow><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-307\">\\mathcal{T}_e</script> denotes the set (or indices) of tokens selected by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-308-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2304\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2305\"><span class=\"mi\" id=\"MathJax-Span-2306\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-308\">e</script>,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-309-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2307\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2308\"><span class=\"msubsup\" id=\"MathJax-Span-2309\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2310\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2311\"><span class=\"mrow\" id=\"MathJax-Span-2312\"><span class=\"mo\" id=\"MathJax-Span-2313\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">:</span><span class=\"mo\" id=\"MathJax-Span-2314\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2315\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-309\">S_{:, e}</script> is the column of the score matrix corresponding to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-310-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2316\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2317\"><span class=\"mi\" id=\"MathJax-Span-2318\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-310\">e</script>,</li>\n          <li>and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-311-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2319\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2320\"><span class=\"msubsup\" id=\"MathJax-Span-2321\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2322\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2323\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>C</mi><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-311\">C_e</script> is the expert’s capacity (i.e., the number of tokens it can process).</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Permutation and Data Shuffling</strong>:</p>\n\n    <ul>\n      <li>Once all experts have chosen their tokens, a <em>permutation operation</em> is applied to reorganize the tokens into contiguous blocks assigned to specific experts.</li>\n      <li>This step is crucial for computational efficiency, as it enables grouped parallel computation on accelerators (such as GPUs and TPUs) without excessive communication overhead.</li>\n      <li>The tokens are then distributed to their respective experts in a format suitable for batched processing.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Expert Computation and Output Reassembly</strong>:</p>\n\n    <ul>\n      <li>Each expert performs its forward computation on its assigned tokens.</li>\n      <li>The processed outputs are then passed through an <em>inverse permutation</em> to restore the original token order.</li>\n      <li>Finally, the outputs are combined using learned or normalized weights, depending on the aggregation strategy used (e.g., mean pooling, weighted sum).</li>\n    </ul>\n  </li>\n</ol>\n<p><strong>Token-to-Expert Scoring</strong>:</p>\n<ul>\n      <li>\n        <p>The EC routing process begins by computing a <em>token-to-expert score matrix</em>, denoted as</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-295-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>S</mi><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mo>&amp;#x00D7;</mo><mi>E</mi></mrow></msup></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2212\" style=\"width: 4.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.961em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1003.96em, 2.451em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2213\"><span class=\"mi\" id=\"MathJax-Span-2214\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2215\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-2216\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2217\"><span class=\"mrow\" id=\"MathJax-Span-2218\"><span class=\"mi\" id=\"MathJax-Span-2219\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.424em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-2220\"><span class=\"mrow\" id=\"MathJax-Span-2221\"><span class=\"mi\" id=\"MathJax-Span-2222\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2223\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-2224\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>S</mi><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>T</mi><mo>×</mo><mi>E</mi></mrow></msup></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-295\">S \\in \\mathbb{R}^{T \\times E}</script>\n\n        <ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-296-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2225\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2226\"><span class=\"mi\" id=\"MathJax-Span-2227\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-296\">T</script> is the number of tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-297-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2228\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2229\"><span class=\"mi\" id=\"MathJax-Span-2230\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-297\">E</script> is the number of experts.</li>\n        </ul>\n      </li>\n      <li>\n        <p>Each element <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-298-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2231\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2232\"><span class=\"msubsup\" id=\"MathJax-Span-2233\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2234\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2235\"><span class=\"mrow\" id=\"MathJax-Span-2236\"><span class=\"mi\" id=\"MathJax-Span-2237\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2238\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2239\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-298\">S_{t,e}</script> represents the relevance or affinity score between token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-299-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2240\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2241\"><span class=\"mi\" id=\"MathJax-Span-2242\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-299\">t</script> and expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-300-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2243\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2244\"><span class=\"mi\" id=\"MathJax-Span-2245\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-300\">e</script>. This score is typically obtained via a linear projection or dot-product similarity in the embedding space.</p>\n      </li>\n    </ul>\n<p>The EC routing process begins by computing a <em>token-to-expert score matrix</em>, denoted as</p>\n<ul>\n          <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-296-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2225\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2226\"><span class=\"mi\" id=\"MathJax-Span-2227\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-296\">T</script> is the number of tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-297-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2228\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2229\"><span class=\"mi\" id=\"MathJax-Span-2230\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-297\">E</script> is the number of experts.</li>\n        </ul>\n<p>Each element <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-298-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2231\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2232\"><span class=\"msubsup\" id=\"MathJax-Span-2233\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2234\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2235\"><span class=\"mrow\" id=\"MathJax-Span-2236\"><span class=\"mi\" id=\"MathJax-Span-2237\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2238\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2239\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-298\">S_{t,e}</script> represents the relevance or affinity score between token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-299-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2240\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2241\"><span class=\"mi\" id=\"MathJax-Span-2242\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-299\">t</script> and expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-300-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2243\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2244\"><span class=\"mi\" id=\"MathJax-Span-2245\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-300\">e</script>. This score is typically obtained via a linear projection or dot-product similarity in the embedding space.</p>\n<p><strong>Expert Capacity Definition</strong>:</p>\n<ul>\n      <li>Each expert is assigned a maximum capacity <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-301-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2246\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2247\"><span class=\"msubsup\" id=\"MathJax-Span-2248\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2249\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2250\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>C</mi><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-301\">C_e</script>, defined as the number of tokens it can process concurrently.</li>\n      <li>\n        <p>The capacity is determined as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-302-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>C</mi><mi>e</mi></msub><mo>=</mo><mtext>Capacity Factor</mtext><mo>&amp;#x00D7;</mo><mfrac><mi>T</mi><mi>E</mi></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2251\" style=\"width: 12.763em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.68em, 1010.63em, 3.023em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2252\"><span class=\"msubsup\" id=\"MathJax-Span-2253\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2254\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2255\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2256\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2257\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">Capacity Factor</span><span class=\"mo\" id=\"MathJax-Span-2258\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mfrac\" id=\"MathJax-Span-2259\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-2260\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-2261\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.73em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.732em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>C</mi><mi>e</mi></msub><mo>=</mo><mtext>Capacity Factor</mtext><mo>×</mo><mfrac><mi>T</mi><mi>E</mi></mfrac></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-302\">C_e = \\text{Capacity Factor} \\times \\frac{T}{E}</script>\n\n        <ul>\n          <li>where the <em>capacity factor</em> is a hyperparameter controlling the trade-off between load balancing and computational efficiency.</li>\n        </ul>\n      </li>\n      <li>If the capacity factor is greater than 1, experts may overlap in token assignments, increasing redundancy but also resilience to routing noise.</li>\n    </ul>\n<p>The capacity is determined as:</p>\n<ul>\n          <li>where the <em>capacity factor</em> is a hyperparameter controlling the trade-off between load balancing and computational efficiency.</li>\n        </ul>\n<p><strong>Expert Token Selection (top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-303-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2262\" style=\"width: 0.622em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.519em; height: 0px; font-size: 121%;\"><span style=\"position: absolute; clip: rect(1.346em, 1000.52em, 2.327em, -999.997em); top: -2.167em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2263\"><span class=\"mi\" id=\"MathJax-Span-2264\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.172em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-303\">k</script> Selection)</strong>:</p>\n<ul>\n      <li>Each expert independently selects the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-304-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2265\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2266\"><span class=\"mi\" id=\"MathJax-Span-2267\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-304\">k</script> tokens from the score matrix that best match its learned specialization.</li>\n      <li>This results in an allocation that maximizes compatibility while respecting the expert capacity constraint.</li>\n      <li>Mathematically, for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-305-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2268\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2269\"><span class=\"mi\" id=\"MathJax-Span-2270\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-305\">e</script>:</li>\n    </ul>\n<ul>\n      <li>where:\n        <ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-307-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>T</mi></mrow><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2297\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2298\"><span class=\"msubsup\" id=\"MathJax-Span-2299\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.128em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2300\"><span class=\"mrow\" id=\"MathJax-Span-2301\"><span class=\"mi\" id=\"MathJax-Span-2302\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.211em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2303\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">T</mi></mrow><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-307\">\\mathcal{T}_e</script> denotes the set (or indices) of tokens selected by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-308-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2304\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2305\"><span class=\"mi\" id=\"MathJax-Span-2306\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-308\">e</script>,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-309-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2307\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2308\"><span class=\"msubsup\" id=\"MathJax-Span-2309\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2310\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2311\"><span class=\"mrow\" id=\"MathJax-Span-2312\"><span class=\"mo\" id=\"MathJax-Span-2313\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">:</span><span class=\"mo\" id=\"MathJax-Span-2314\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2315\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-309\">S_{:, e}</script> is the column of the score matrix corresponding to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-310-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2316\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2317\"><span class=\"mi\" id=\"MathJax-Span-2318\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-310\">e</script>,</li>\n          <li>and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-311-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2319\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2320\"><span class=\"msubsup\" id=\"MathJax-Span-2321\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2322\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2323\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>C</mi><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-311\">C_e</script> is the expert’s capacity (i.e., the number of tokens it can process).</li>\n        </ul>\n      </li>\n    </ul>\n<ul>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-307-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>T</mi></mrow><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2297\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2298\"><span class=\"msubsup\" id=\"MathJax-Span-2299\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.128em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2300\"><span class=\"mrow\" id=\"MathJax-Span-2301\"><span class=\"mi\" id=\"MathJax-Span-2302\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.211em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2303\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">T</mi></mrow><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-307\">\\mathcal{T}_e</script> denotes the set (or indices) of tokens selected by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-308-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2304\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2305\"><span class=\"mi\" id=\"MathJax-Span-2306\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-308\">e</script>,</li>\n          <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-309-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2307\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2308\"><span class=\"msubsup\" id=\"MathJax-Span-2309\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2310\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2311\"><span class=\"mrow\" id=\"MathJax-Span-2312\"><span class=\"mo\" id=\"MathJax-Span-2313\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">:</span><span class=\"mo\" id=\"MathJax-Span-2314\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2315\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo>:</mo><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-309\">S_{:, e}</script> is the column of the score matrix corresponding to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-310-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2316\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2317\"><span class=\"mi\" id=\"MathJax-Span-2318\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-310\">e</script>,</li>\n          <li>and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-311-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mi>e</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2319\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2320\"><span class=\"msubsup\" id=\"MathJax-Span-2321\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2322\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2323\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>C</mi><mi>e</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-311\">C_e</script> is the expert’s capacity (i.e., the number of tokens it can process).</li>\n        </ul>\n<p><strong>Permutation and Data Shuffling</strong>:</p>\n<ul>\n      <li>Once all experts have chosen their tokens, a <em>permutation operation</em> is applied to reorganize the tokens into contiguous blocks assigned to specific experts.</li>\n      <li>This step is crucial for computational efficiency, as it enables grouped parallel computation on accelerators (such as GPUs and TPUs) without excessive communication overhead.</li>\n      <li>The tokens are then distributed to their respective experts in a format suitable for batched processing.</li>\n    </ul>\n<p><strong>Expert Computation and Output Reassembly</strong>:</p>\n<ul>\n      <li>Each expert performs its forward computation on its assigned tokens.</li>\n      <li>The processed outputs are then passed through an <em>inverse permutation</em> to restore the original token order.</li>\n      <li>Finally, the outputs are combined using learned or normalized weights, depending on the aggregation strategy used (e.g., mean pooling, weighted sum).</li>\n    </ul>",
    "contentMarkdown": "1.  **Token-to-Expert Scoring**:\n    \n    *   The EC routing process begins by computing a _token-to-expert score matrix_, denoted as\n        \n        S∈ℝT×ES∈RT×E\n        \n        S \\\\in \\\\mathbb{R}^{T \\\\times E}\n        *   where TTT is the number of tokens and EEE is the number of experts.\n    *   Each element St,eSt,eS\\_{t,e} represents the relevance or affinity score between token ttt and expert eee. This score is typically obtained via a linear projection or dot-product similarity in the embedding space.\n        \n2.  **Expert Capacity Definition**:\n    \n    *   Each expert is assigned a maximum capacity CeCeC\\_e, defined as the number of tokens it can process concurrently.\n    *   The capacity is determined as:\n        \n        Ce\\=Capacity Factor×TECe\\=Capacity Factor×TE\n        \n        C\\_e = \\\\text{Capacity Factor} \\\\times \\\\frac{T}{E}\n        *   where the _capacity factor_ is a hyperparameter controlling the trade-off between load balancing and computational efficiency.\n    *   If the capacity factor is greater than 1, experts may overlap in token assignments, increasing redundancy but also resilience to routing noise.\n3.  **Expert Token Selection (top-kkk Selection)**:\n    \n    *   Each expert independently selects the top-kkk tokens from the score matrix that best match its learned specialization.\n    *   This results in an allocation that maximizes compatibility while respecting the expert capacity constraint.\n    *   Mathematically, for expert eee:\n    \n    e\\=TopK(S:,e,Ce)Te\\=TopK(S:,e,Ce)\n    \n    \\\\mathcal{T}\\_e = \\\\text{TopK}\\\\big(S\\_{:, e}, C\\_e\\\\big)\n    *   where:\n        *   eTe\\\\mathcal{T}\\_e denotes the set (or indices) of tokens selected by expert eee,\n        *   S:,eS:,eS\\_{:, e} is the column of the score matrix corresponding to expert eee,\n        *   and CeCeC\\_e is the expert’s capacity (i.e., the number of tokens it can process).\n4.  **Permutation and Data Shuffling**:\n    \n    *   Once all experts have chosen their tokens, a _permutation operation_ is applied to reorganize the tokens into contiguous blocks assigned to specific experts.\n    *   This step is crucial for computational efficiency, as it enables grouped parallel computation on accelerators (such as GPUs and TPUs) without excessive communication overhead.\n    *   The tokens are then distributed to their respective experts in a format suitable for batched processing.\n5.  **Expert Computation and Output Reassembly**:\n    \n    *   Each expert performs its forward computation on its assigned tokens.\n    *   The processed outputs are then passed through an _inverse permutation_ to restore the original token order.\n    *   Finally, the outputs are combined using learned or normalized weights, depending on the aggregation strategy used (e.g., mean pooling, weighted sum).\n\n**Token-to-Expert Scoring**:\n\n*   The EC routing process begins by computing a _token-to-expert score matrix_, denoted as\n    \n    S∈ℝT×ES∈RT×E\n    \n    S \\\\in \\\\mathbb{R}^{T \\\\times E}\n    *   where TTT is the number of tokens and EEE is the number of experts.\n*   Each element St,eSt,eS\\_{t,e} represents the relevance or affinity score between token ttt and expert eee. This score is typically obtained via a linear projection or dot-product similarity in the embedding space.\n    \n\nThe EC routing process begins by computing a _token-to-expert score matrix_, denoted as\n\n*   where TTT is the number of tokens and EEE is the number of experts.\n\nEach element St,eSt,eS\\_{t,e} represents the relevance or affinity score between token ttt and expert eee. This score is typically obtained via a linear projection or dot-product similarity in the embedding space.\n\n**Expert Capacity Definition**:\n\n*   Each expert is assigned a maximum capacity CeCeC\\_e, defined as the number of tokens it can process concurrently.\n*   The capacity is determined as:\n    \n    Ce\\=Capacity Factor×TECe\\=Capacity Factor×TE\n    \n    C\\_e = \\\\text{Capacity Factor} \\\\times \\\\frac{T}{E}\n    *   where the _capacity factor_ is a hyperparameter controlling the trade-off between load balancing and computational efficiency.\n*   If the capacity factor is greater than 1, experts may overlap in token assignments, increasing redundancy but also resilience to routing noise.\n\nThe capacity is determined as:\n\n*   where the _capacity factor_ is a hyperparameter controlling the trade-off between load balancing and computational efficiency.\n\n**Expert Token Selection (top-kkk Selection)**:\n\n*   Each expert independently selects the top-kkk tokens from the score matrix that best match its learned specialization.\n*   This results in an allocation that maximizes compatibility while respecting the expert capacity constraint.\n*   Mathematically, for expert eee:\n\n*   where:\n    *   eTe\\\\mathcal{T}\\_e denotes the set (or indices) of tokens selected by expert eee,\n    *   S:,eS:,eS\\_{:, e} is the column of the score matrix corresponding to expert eee,\n    *   and CeCeC\\_e is the expert’s capacity (i.e., the number of tokens it can process).\n\n*   eTe\\\\mathcal{T}\\_e denotes the set (or indices) of tokens selected by expert eee,\n*   S:,eS:,eS\\_{:, e} is the column of the score matrix corresponding to expert eee,\n*   and CeCeC\\_e is the expert’s capacity (i.e., the number of tokens it can process).\n\n**Permutation and Data Shuffling**:\n\n*   Once all experts have chosen their tokens, a _permutation operation_ is applied to reorganize the tokens into contiguous blocks assigned to specific experts.\n*   This step is crucial for computational efficiency, as it enables grouped parallel computation on accelerators (such as GPUs and TPUs) without excessive communication overhead.\n*   The tokens are then distributed to their respective experts in a format suitable for batched processing.\n\n**Expert Computation and Output Reassembly**:\n\n*   Each expert performs its forward computation on its assigned tokens.\n*   The processed outputs are then passed through an _inverse permutation_ to restore the original token order.\n*   Finally, the outputs are combined using learned or normalized weights, depending on the aggregation strategy used (e.g., mean pooling, weighted sum).",
    "contentLength": 87406,
    "wordCount": 850,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#step-by-step-workflow-of-expert-choice-routing"
  },
  {
    "id": "ai-mixture-of-experts-advantages-of-expert-choice-routing-41",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Choice Routing",
    "title": "Advantages of Expert Choice Routing",
    "order": 41,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>\n    <p><strong>Load Balancing Efficiency</strong>: By inverting the routing direction, EC ensures a more uniform distribution of tokens across experts. This eliminates the need for explicit load balancing losses, which are often added to standard MoE architectures to penalize expert overuse.</p>\n  </li>\n  <li>\n    <p><strong>Improved Expert Specialization</strong>: Each expert gains control over which tokens it processes, enabling it to develop a clearer and more consistent specialization. This improves convergence and prevents expert collapse (where multiple experts learn redundant behaviors).</p>\n  </li>\n  <li>\n    <p><strong>Reduced Dropping and Padding Overhead</strong>: In top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-312-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2324\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2325\"><span class=\"mi\" id=\"MathJax-Span-2326\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-312\">k</script> routing, when too many tokens are assigned to a popular expert, some must be dropped to maintain computational limits. EC routing’s predefined expert capacity removes the need for token dropping or padding, thereby reducing waste.</p>\n  </li>\n  <li>\n    <p><strong>Enhanced Scalability</strong>: EC is more scalable in distributed environments because experts can independently select and process tokens, reducing synchronization costs. This makes EC routing especially advantageous for large-scale systems with thousands of experts.</p>\n  </li>\n  <li>\n    <p><strong>Dynamic Token Prioritization</strong>: The EC mechanism naturally prioritizes difficult or ambiguous tokens, since these typically score highly across multiple experts. This adaptive attention to “hard” tokens allows the model to allocate more computational focus where it matters most.</p>\n  </li>\n</ul>\n<p><strong>Load Balancing Efficiency</strong>: By inverting the routing direction, EC ensures a more uniform distribution of tokens across experts. This eliminates the need for explicit load balancing losses, which are often added to standard MoE architectures to penalize expert overuse.</p>\n<p><strong>Improved Expert Specialization</strong>: Each expert gains control over which tokens it processes, enabling it to develop a clearer and more consistent specialization. This improves convergence and prevents expert collapse (where multiple experts learn redundant behaviors).</p>\n<p><strong>Reduced Dropping and Padding Overhead</strong>: In top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-312-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2324\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2325\"><span class=\"mi\" id=\"MathJax-Span-2326\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-312\">k</script> routing, when too many tokens are assigned to a popular expert, some must be dropped to maintain computational limits. EC routing’s predefined expert capacity removes the need for token dropping or padding, thereby reducing waste.</p>\n<p><strong>Enhanced Scalability</strong>: EC is more scalable in distributed environments because experts can independently select and process tokens, reducing synchronization costs. This makes EC routing especially advantageous for large-scale systems with thousands of experts.</p>\n<p><strong>Dynamic Token Prioritization</strong>: The EC mechanism naturally prioritizes difficult or ambiguous tokens, since these typically score highly across multiple experts. This adaptive attention to “hard” tokens allows the model to allocate more computational focus where it matters most.</p>",
    "contentMarkdown": "*   **Load Balancing Efficiency**: By inverting the routing direction, EC ensures a more uniform distribution of tokens across experts. This eliminates the need for explicit load balancing losses, which are often added to standard MoE architectures to penalize expert overuse.\n    \n*   **Improved Expert Specialization**: Each expert gains control over which tokens it processes, enabling it to develop a clearer and more consistent specialization. This improves convergence and prevents expert collapse (where multiple experts learn redundant behaviors).\n    \n*   **Reduced Dropping and Padding Overhead**: In top-kkk routing, when too many tokens are assigned to a popular expert, some must be dropped to maintain computational limits. EC routing’s predefined expert capacity removes the need for token dropping or padding, thereby reducing waste.\n    \n*   **Enhanced Scalability**: EC is more scalable in distributed environments because experts can independently select and process tokens, reducing synchronization costs. This makes EC routing especially advantageous for large-scale systems with thousands of experts.\n    \n*   **Dynamic Token Prioritization**: The EC mechanism naturally prioritizes difficult or ambiguous tokens, since these typically score highly across multiple experts. This adaptive attention to “hard” tokens allows the model to allocate more computational focus where it matters most.\n    \n\n**Load Balancing Efficiency**: By inverting the routing direction, EC ensures a more uniform distribution of tokens across experts. This eliminates the need for explicit load balancing losses, which are often added to standard MoE architectures to penalize expert overuse.\n\n**Improved Expert Specialization**: Each expert gains control over which tokens it processes, enabling it to develop a clearer and more consistent specialization. This improves convergence and prevents expert collapse (where multiple experts learn redundant behaviors).\n\n**Reduced Dropping and Padding Overhead**: In top-kkk routing, when too many tokens are assigned to a popular expert, some must be dropped to maintain computational limits. EC routing’s predefined expert capacity removes the need for token dropping or padding, thereby reducing waste.\n\n**Enhanced Scalability**: EC is more scalable in distributed environments because experts can independently select and process tokens, reducing synchronization costs. This makes EC routing especially advantageous for large-scale systems with thousands of experts.\n\n**Dynamic Token Prioritization**: The EC mechanism naturally prioritizes difficult or ambiguous tokens, since these typically score highly across multiple experts. This adaptive attention to “hard” tokens allows the model to allocate more computational focus where it matters most.",
    "contentLength": 5597,
    "wordCount": 379,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#advantages-of-expert-choice-routing"
  },
  {
    "id": "ai-mixture-of-experts-mathematical-intuition-42",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Choice Routing",
    "title": "Mathematical Intuition",
    "order": 42,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>\n    <p>At its core, EC routing optimizes a sparse assignment problem:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-313-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><munder><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>A</mi></mrow></munder><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi></mrow></munderover><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>E</mi></mrow></munderover><msub><mi>S</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x22C5;</mo><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2327\" style=\"width: 10.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.596em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.315em, 1008.6em, 3.648em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2328\"><span class=\"munderover\" id=\"MathJax-Span-2329\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1001.72em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2330\" style=\"font-family: STIXGeneral-Regular;\">max</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.273em, -999.997em); top: -3.331em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2331\"><span class=\"mrow\" id=\"MathJax-Span-2332\"><span class=\"mi\" id=\"MathJax-Span-2333\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">A</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-2334\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2335\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.99em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2336\"><span class=\"mrow\" id=\"MathJax-Span-2337\"><span class=\"mi\" id=\"MathJax-Span-2338\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2339\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2340\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.47em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"texatom\" id=\"MathJax-Span-2341\"><span class=\"mrow\" id=\"MathJax-Span-2342\"><span class=\"mi\" id=\"MathJax-Span-2343\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-2344\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2345\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.273em, -999.997em); top: -2.862em; left: 0.055em;\"><span class=\"texatom\" id=\"MathJax-Span-2346\"><span class=\"mrow\" id=\"MathJax-Span-2347\"><span class=\"mi\" id=\"MathJax-Span-2348\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-2349\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2350\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.47em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"texatom\" id=\"MathJax-Span-2351\"><span class=\"mrow\" id=\"MathJax-Span-2352\"><span class=\"mi\" id=\"MathJax-Span-2353\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2354\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2355\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2356\"><span class=\"mrow\" id=\"MathJax-Span-2357\"><span class=\"mi\" id=\"MathJax-Span-2358\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2359\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2360\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2361\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-2362\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2363\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2364\"><span class=\"mrow\" id=\"MathJax-Span-2365\"><span class=\"mi\" id=\"MathJax-Span-2366\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2367\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2368\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><munder><mo movablelimits=\"true\" form=\"prefix\">max</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>A</mi></mrow></munder><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>T</mi></mrow></munderover><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>E</mi></mrow></munderover><msub><mi>S</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>⋅</mo><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-313\">\\max_{A} \\sum_{t=1}^{T}\\sum_{e=1}^{E} S_{t,e} \\cdot A_{t,e}</script>\n\n    <ul>\n      <li>\n        <p>subject to:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-314-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi></mrow></munderover><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x2264;</mo><msub><mi>C</mi><mi>e</mi></msub><mo>,</mo><mspace width=&quot;1em&quot; /><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>0</mn><mo>,</mo><mn>1</mn></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2369\" style=\"width: 13.909em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.565em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1011.46em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2370\"><span class=\"munderover\" id=\"MathJax-Span-2371\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2372\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2373\"><span class=\"mrow\" id=\"MathJax-Span-2374\"><span class=\"mi\" id=\"MathJax-Span-2375\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.15em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2376\"><span class=\"mrow\" id=\"MathJax-Span-2377\"><span class=\"mi\" id=\"MathJax-Span-2378\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2379\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2380\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2381\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2382\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2383\"><span class=\"mrow\" id=\"MathJax-Span-2384\"><span class=\"mi\" id=\"MathJax-Span-2385\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2386\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2387\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2388\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≤</span><span class=\"msubsup\" id=\"MathJax-Span-2389\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2390\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2391\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2392\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mspace\" id=\"MathJax-Span-2393\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"msubsup\" id=\"MathJax-Span-2394\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2395\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2396\"><span class=\"mrow\" id=\"MathJax-Span-2397\"><span class=\"mi\" id=\"MathJax-Span-2398\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2399\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2400\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2401\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2402\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2403\"><span class=\"mn\" id=\"MathJax-Span-2404\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-2405\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-2406\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>T</mi></mrow></munderover><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>≤</mo><msub><mi>C</mi><mi>e</mi></msub><mo>,</mo><mspace width=\"1em\"></mspace><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>0</mn><mo>,</mo><mn>1</mn></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-314\">\\sum_{t=1}^{T} A_{t,e} \\leq C_e, \\quad A_{t,e} \\in {0,1}</script></p>\n      </li>\n      <li>\n        <p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-315-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2407\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.41em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2408\"><span class=\"msubsup\" id=\"MathJax-Span-2409\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2410\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2411\"><span class=\"mrow\" id=\"MathJax-Span-2412\"><span class=\"mi\" id=\"MathJax-Span-2413\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2414\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2415\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-315\">A_{t,e}</script> represents the binary assignment variable indicating whether token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-316-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2416\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2417\"><span class=\"mi\" id=\"MathJax-Span-2418\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-316\">t</script> is processed by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-317-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2419\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2420\"><span class=\"mi\" id=\"MathJax-Span-2421\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-317\">e</script>. This optimization ensures each expert operates within its capacity while maximizing global compatibility.</p>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>In practice, this problem is approximated using differentiable top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-318-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2422\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2423\"><span class=\"mi\" id=\"MathJax-Span-2424\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-318\">k</script> selection and softmax normalization, allowing the routing decisions to remain end-to-end trainable.</p>\n  </li>\n</ul>\n<p>At its core, EC routing optimizes a sparse assignment problem:</p>\n<ul>\n      <li>\n        <p>subject to:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-314-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi></mrow></munderover><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x2264;</mo><msub><mi>C</mi><mi>e</mi></msub><mo>,</mo><mspace width=&quot;1em&quot; /><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>0</mn><mo>,</mo><mn>1</mn></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2369\" style=\"width: 13.909em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.565em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1011.46em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2370\"><span class=\"munderover\" id=\"MathJax-Span-2371\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2372\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2373\"><span class=\"mrow\" id=\"MathJax-Span-2374\"><span class=\"mi\" id=\"MathJax-Span-2375\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.15em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2376\"><span class=\"mrow\" id=\"MathJax-Span-2377\"><span class=\"mi\" id=\"MathJax-Span-2378\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2379\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2380\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2381\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2382\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2383\"><span class=\"mrow\" id=\"MathJax-Span-2384\"><span class=\"mi\" id=\"MathJax-Span-2385\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2386\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2387\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2388\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≤</span><span class=\"msubsup\" id=\"MathJax-Span-2389\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2390\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2391\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2392\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mspace\" id=\"MathJax-Span-2393\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"msubsup\" id=\"MathJax-Span-2394\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2395\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2396\"><span class=\"mrow\" id=\"MathJax-Span-2397\"><span class=\"mi\" id=\"MathJax-Span-2398\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2399\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2400\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2401\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2402\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2403\"><span class=\"mn\" id=\"MathJax-Span-2404\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-2405\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-2406\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>T</mi></mrow></munderover><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>≤</mo><msub><mi>C</mi><mi>e</mi></msub><mo>,</mo><mspace width=\"1em\"></mspace><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>0</mn><mo>,</mo><mn>1</mn></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-314\">\\sum_{t=1}^{T} A_{t,e} \\leq C_e, \\quad A_{t,e} \\in {0,1}</script></p>\n      </li>\n      <li>\n        <p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-315-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2407\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.41em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2408\"><span class=\"msubsup\" id=\"MathJax-Span-2409\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2410\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2411\"><span class=\"mrow\" id=\"MathJax-Span-2412\"><span class=\"mi\" id=\"MathJax-Span-2413\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2414\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2415\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-315\">A_{t,e}</script> represents the binary assignment variable indicating whether token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-316-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2416\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2417\"><span class=\"mi\" id=\"MathJax-Span-2418\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-316\">t</script> is processed by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-317-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2419\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2420\"><span class=\"mi\" id=\"MathJax-Span-2421\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-317\">e</script>. This optimization ensures each expert operates within its capacity while maximizing global compatibility.</p>\n      </li>\n    </ul>\n<p>subject to:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-314-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi></mrow></munderover><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x2264;</mo><msub><mi>C</mi><mi>e</mi></msub><mo>,</mo><mspace width=&quot;1em&quot; /><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>0</mn><mo>,</mo><mn>1</mn></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2369\" style=\"width: 13.909em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.565em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1011.46em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2370\"><span class=\"munderover\" id=\"MathJax-Span-2371\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2372\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2373\"><span class=\"mrow\" id=\"MathJax-Span-2374\"><span class=\"mi\" id=\"MathJax-Span-2375\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.15em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2376\"><span class=\"mrow\" id=\"MathJax-Span-2377\"><span class=\"mi\" id=\"MathJax-Span-2378\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2379\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2380\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2381\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2382\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2383\"><span class=\"mrow\" id=\"MathJax-Span-2384\"><span class=\"mi\" id=\"MathJax-Span-2385\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2386\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2387\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2388\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≤</span><span class=\"msubsup\" id=\"MathJax-Span-2389\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2390\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2391\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2392\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mspace\" id=\"MathJax-Span-2393\" style=\"height: 0em; vertical-align: 0em; width: 1.148em; display: inline-block; overflow: hidden;\"></span><span class=\"msubsup\" id=\"MathJax-Span-2394\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2395\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2396\"><span class=\"mrow\" id=\"MathJax-Span-2397\"><span class=\"mi\" id=\"MathJax-Span-2398\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2399\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2400\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2401\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2402\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2403\"><span class=\"mn\" id=\"MathJax-Span-2404\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-2405\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-2406\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>T</mi></mrow></munderover><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>≤</mo><msub><mi>C</mi><mi>e</mi></msub><mo>,</mo><mspace width=\"1em\"></mspace><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>0</mn><mo>,</mo><mn>1</mn></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-314\">\\sum_{t=1}^{T} A_{t,e} \\leq C_e, \\quad A_{t,e} \\in {0,1}</script></p>\n<p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-315-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2407\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.41em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2408\"><span class=\"msubsup\" id=\"MathJax-Span-2409\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2410\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-2411\"><span class=\"mrow\" id=\"MathJax-Span-2412\"><span class=\"mi\" id=\"MathJax-Span-2413\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2414\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2415\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>A</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>,</mo><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-315\">A_{t,e}</script> represents the binary assignment variable indicating whether token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-316-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2416\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2417\"><span class=\"mi\" id=\"MathJax-Span-2418\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>t</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-316\">t</script> is processed by expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-317-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>e</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2419\" style=\"width: 0.576em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.42em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2420\"><span class=\"mi\" id=\"MathJax-Span-2421\" style=\"font-family: STIXGeneral-Italic;\">e</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>e</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-317\">e</script>. This optimization ensures each expert operates within its capacity while maximizing global compatibility.</p>\n<p>In practice, this problem is approximated using differentiable top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-318-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2422\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2423\"><span class=\"mi\" id=\"MathJax-Span-2424\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-318\">k</script> selection and softmax normalization, allowing the routing decisions to remain end-to-end trainable.</p>",
    "contentMarkdown": "*   At its core, EC routing optimizes a sparse assignment problem:\n    \n    maxA∑t\\=1T∑e\\=1ESt,e⋅At,emaxA∑t\\=1T∑e\\=1ESt,e⋅At,e\n    \n    \\\\max\\_{A} \\\\sum\\_{t=1}^{T}\\\\sum\\_{e=1}^{E} S\\_{t,e} \\\\cdot A\\_{t,e}\n    *   subject to: ∑Tt\\=1At,e≤Ce,At,e∈0,1∑t\\=1TAt,e≤Ce,At,e∈0,1\\\\sum\\_{t=1}^{T} A\\_{t,e} \\\\leq C\\_e, \\\\quad A\\_{t,e} \\\\in {0,1}\n        \n    *   where At,eAt,eA\\_{t,e} represents the binary assignment variable indicating whether token ttt is processed by expert eee. This optimization ensures each expert operates within its capacity while maximizing global compatibility.\n        \n*   In practice, this problem is approximated using differentiable top-kkk selection and softmax normalization, allowing the routing decisions to remain end-to-end trainable.\n    \n\nAt its core, EC routing optimizes a sparse assignment problem:\n\n*   subject to: ∑Tt\\=1At,e≤Ce,At,e∈0,1∑t\\=1TAt,e≤Ce,At,e∈0,1\\\\sum\\_{t=1}^{T} A\\_{t,e} \\\\leq C\\_e, \\\\quad A\\_{t,e} \\\\in {0,1}\n    \n*   where At,eAt,eA\\_{t,e} represents the binary assignment variable indicating whether token ttt is processed by expert eee. This optimization ensures each expert operates within its capacity while maximizing global compatibility.\n    \n\nsubject to: ∑Tt\\=1At,e≤Ce,At,e∈0,1∑t\\=1TAt,e≤Ce,At,e∈0,1\\\\sum\\_{t=1}^{T} A\\_{t,e} \\\\leq C\\_e, \\\\quad A\\_{t,e} \\\\in {0,1}\n\nwhere At,eAt,eA\\_{t,e} represents the binary assignment variable indicating whether token ttt is processed by expert eee. This optimization ensures each expert operates within its capacity while maximizing global compatibility.\n\nIn practice, this problem is approximated using differentiable top-kkk selection and softmax normalization, allowing the routing decisions to remain end-to-end trainable.",
    "contentLength": 50899,
    "wordCount": 191,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mathematical-intuition"
  },
  {
    "id": "ai-mixture-of-experts-implementation-and-integration-43",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Choice Routing",
    "title": "Implementation and Integration",
    "order": 43,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>EC routing integrates seamlessly with transformer-based MoE layers, requiring only modifications in the routing subnetwork.</li>\n  <li>It is compatible with common deep learning frameworks like TensorFlow and PyTorch, where implementation typically involves:\n    <ol>\n      <li>Computing token-to-expert scores.</li>\n      <li>Applying expert-wise top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-319-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2425\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2426\"><span class=\"mi\" id=\"MathJax-Span-2427\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-319\">k</script> selection.</li>\n      <li>Executing a permutation-based gather-scatter operation.</li>\n    </ol>\n  </li>\n  <li>The <a href=\"https://arxiv.org/abs/2202.09368\">paper</a> demonstrated that EC routing improves perplexity and throughput in language modeling tasks without introducing significant computational overhead, making it an attractive alternative to classic top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-320-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2428\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2429\"><span class=\"mi\" id=\"MathJax-Span-2430\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-320\">k</script> routing in large language models.</li>\n</ul>\n<ol>\n      <li>Computing token-to-expert scores.</li>\n      <li>Applying expert-wise top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-319-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2425\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2426\"><span class=\"mi\" id=\"MathJax-Span-2427\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-319\">k</script> selection.</li>\n      <li>Executing a permutation-based gather-scatter operation.</li>\n    </ol>",
    "contentMarkdown": "*   EC routing integrates seamlessly with transformer-based MoE layers, requiring only modifications in the routing subnetwork.\n*   It is compatible with common deep learning frameworks like TensorFlow and PyTorch, where implementation typically involves:\n    1.  Computing token-to-expert scores.\n    2.  Applying expert-wise top-kkk selection.\n    3.  Executing a permutation-based gather-scatter operation.\n*   The [paper](https://arxiv.org/abs/2202.09368) demonstrated that EC routing improves perplexity and throughput in language modeling tasks without introducing significant computational overhead, making it an attractive alternative to classic top-kkk routing in large language models.\n\n1.  Computing token-to-expert scores.\n2.  Applying expert-wise top-kkk selection.\n3.  Executing a permutation-based gather-scatter operation.",
    "contentLength": 4787,
    "wordCount": 96,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#implementation-and-integration"
  },
  {
    "id": "ai-mixture-of-experts-limitations-44",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Choice Routing",
    "title": "Limitations",
    "order": 44,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p><strong>Increased Routing Complexity</strong>: While EC routing balances loads effectively, it introduces additional computational steps during the selection and permutation phases. The construction and manipulation of the token-to-expert score matrix <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-321-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>S</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2431\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.58em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2432\"><span class=\"mi\" id=\"MathJax-Span-2433\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>S</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-321\">S</script> can become expensive for large-scale models with millions of tokens or thousands of experts.</p>\n  </li>\n  <li>\n    <p><strong>Communication Overhead</strong>: The expert-centric routing process requires collective communication when redistributing token batches among experts, especially in distributed settings. Although the permutation operation is designed for efficiency, it can still create latency in multi-node or multi-GPU environments.</p>\n  </li>\n  <li>\n    <p><strong>Hyperparameter Sensitivity</strong>: The performance of EC routing is sensitive to the <em>capacity factor</em> and <em>top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-322-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2434\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2435\"><span class=\"mi\" id=\"MathJax-Span-2436\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-322\">k</script></em> settings. Incorrect tuning may lead to token over- or under-assignment, harming both model accuracy and load distribution.</p>\n  </li>\n  <li>\n    <p><strong>Gradient Routing Challenges</strong>: Since routing decisions are discrete (due to top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-323-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2437\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2438\"><span class=\"mi\" id=\"MathJax-Span-2439\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-323\">k</script> selection), gradients must be approximated using continuous relaxations (e.g., Gumbel-softmax or soft top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-324-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2440\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2441\"><span class=\"mi\" id=\"MathJax-Span-2442\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-324\">k</script>). This approximation can introduce instability during early training or lead to suboptimal expert selection.</p>\n  </li>\n  <li>\n    <p><strong>Specialization Drift</strong>: Over the course of training, experts may begin to specialize on overlapping token distributions. Without additional regularization or entropy-based balancing, this overlap can reduce diversity across experts, negating some of the benefits of distributed specialization.</p>\n  </li>\n  <li>\n    <p><strong>Implementation Complexity in Practice</strong>: Integrating EC routing into large-scale frameworks requires careful engineering of parallel and distributed computation primitives. Many current deep learning libraries provide limited native support for expert-centric communication patterns, necessitating custom kernels or frameworks (such as GSPMD or DeepSpeed-MoE).</p>\n  </li>\n</ul>\n<p><strong>Increased Routing Complexity</strong>: While EC routing balances loads effectively, it introduces additional computational steps during the selection and permutation phases. The construction and manipulation of the token-to-expert score matrix <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-321-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>S</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2431\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.58em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2432\"><span class=\"mi\" id=\"MathJax-Span-2433\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>S</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-321\">S</script> can become expensive for large-scale models with millions of tokens or thousands of experts.</p>\n<p><strong>Communication Overhead</strong>: The expert-centric routing process requires collective communication when redistributing token batches among experts, especially in distributed settings. Although the permutation operation is designed for efficiency, it can still create latency in multi-node or multi-GPU environments.</p>\n<p><strong>Hyperparameter Sensitivity</strong>: The performance of EC routing is sensitive to the <em>capacity factor</em> and <em>top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-322-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2434\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2435\"><span class=\"mi\" id=\"MathJax-Span-2436\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-322\">k</script></em> settings. Incorrect tuning may lead to token over- or under-assignment, harming both model accuracy and load distribution.</p>\n<p><strong>Gradient Routing Challenges</strong>: Since routing decisions are discrete (due to top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-323-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2437\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2438\"><span class=\"mi\" id=\"MathJax-Span-2439\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-323\">k</script> selection), gradients must be approximated using continuous relaxations (e.g., Gumbel-softmax or soft top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-324-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2440\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2441\"><span class=\"mi\" id=\"MathJax-Span-2442\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-324\">k</script>). This approximation can introduce instability during early training or lead to suboptimal expert selection.</p>\n<p><strong>Specialization Drift</strong>: Over the course of training, experts may begin to specialize on overlapping token distributions. Without additional regularization or entropy-based balancing, this overlap can reduce diversity across experts, negating some of the benefits of distributed specialization.</p>\n<p><strong>Implementation Complexity in Practice</strong>: Integrating EC routing into large-scale frameworks requires careful engineering of parallel and distributed computation primitives. Many current deep learning libraries provide limited native support for expert-centric communication patterns, necessitating custom kernels or frameworks (such as GSPMD or DeepSpeed-MoE).</p>",
    "contentMarkdown": "*   **Increased Routing Complexity**: While EC routing balances loads effectively, it introduces additional computational steps during the selection and permutation phases. The construction and manipulation of the token-to-expert score matrix SSS can become expensive for large-scale models with millions of tokens or thousands of experts.\n    \n*   **Communication Overhead**: The expert-centric routing process requires collective communication when redistributing token batches among experts, especially in distributed settings. Although the permutation operation is designed for efficiency, it can still create latency in multi-node or multi-GPU environments.\n    \n*   **Hyperparameter Sensitivity**: The performance of EC routing is sensitive to the _capacity factor_ and _top-kkk_ settings. Incorrect tuning may lead to token over- or under-assignment, harming both model accuracy and load distribution.\n    \n*   **Gradient Routing Challenges**: Since routing decisions are discrete (due to top-kkk selection), gradients must be approximated using continuous relaxations (e.g., Gumbel-softmax or soft top-kkk). This approximation can introduce instability during early training or lead to suboptimal expert selection.\n    \n*   **Specialization Drift**: Over the course of training, experts may begin to specialize on overlapping token distributions. Without additional regularization or entropy-based balancing, this overlap can reduce diversity across experts, negating some of the benefits of distributed specialization.\n    \n*   **Implementation Complexity in Practice**: Integrating EC routing into large-scale frameworks requires careful engineering of parallel and distributed computation primitives. Many current deep learning libraries provide limited native support for expert-centric communication patterns, necessitating custom kernels or frameworks (such as GSPMD or DeepSpeed-MoE).\n    \n\n**Increased Routing Complexity**: While EC routing balances loads effectively, it introduces additional computational steps during the selection and permutation phases. The construction and manipulation of the token-to-expert score matrix SSS can become expensive for large-scale models with millions of tokens or thousands of experts.\n\n**Communication Overhead**: The expert-centric routing process requires collective communication when redistributing token batches among experts, especially in distributed settings. Although the permutation operation is designed for efficiency, it can still create latency in multi-node or multi-GPU environments.\n\n**Hyperparameter Sensitivity**: The performance of EC routing is sensitive to the _capacity factor_ and _top-kkk_ settings. Incorrect tuning may lead to token over- or under-assignment, harming both model accuracy and load distribution.\n\n**Gradient Routing Challenges**: Since routing decisions are discrete (due to top-kkk selection), gradients must be approximated using continuous relaxations (e.g., Gumbel-softmax or soft top-kkk). This approximation can introduce instability during early training or lead to suboptimal expert selection.\n\n**Specialization Drift**: Over the course of training, experts may begin to specialize on overlapping token distributions. Without additional regularization or entropy-based balancing, this overlap can reduce diversity across experts, negating some of the benefits of distributed specialization.\n\n**Implementation Complexity in Practice**: Integrating EC routing into large-scale frameworks requires careful engineering of parallel and distributed computation primitives. Many current deep learning libraries provide limited native support for expert-centric communication patterns, necessitating custom kernels or frameworks (such as GSPMD or DeepSpeed-MoE).",
    "contentLength": 14270,
    "wordCount": 466,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#limitations"
  },
  {
    "id": "ai-mixture-of-experts-motivation-45",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts Beyond MLP Layers",
    "title": "Motivation",
    "order": 45,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>Traditionally, MoE layers have been integrated primarily into the <strong>feed-forward (MLP) blocks</strong> of transformer architectures. This design exploits conditional computation to scale model parameters without proportional increases in compute. However, limiting MoE to the MLP layers underutilizes its potential — transformer blocks also include <strong>attention mechanisms</strong>, <strong>connectors</strong>, and <strong>modality-specific encoders</strong> that can benefit from conditional sparsity.</li>\n  <li>\n    <p>The evolution of MoE beyond MLP layers marks a significant turning point in scalable neural network design:</p>\n\n    <ul>\n      <li>MoE is no longer confined to feed-forward modules—it now extends to attention, connectors, and encoders.</li>\n      <li>These expansions enable <em>semantic specialization</em> across modalities, allowing experts to capture structured relationships in vision-language tasks.</li>\n      <li>Works like <a href=\"https://arxiv.org/abs/2405.05949\">CuMo</a>, <a href=\"https://arxiv.org/abs/2106.05974\">V-MoE</a>, <a href=\"https://arxiv.org/abs/2206.02770\">LIMoE</a>, and <a href=\"https://arxiv.org/abs/2312.07987\">Uni-MoE</a> collectively illustrate this trend, providing both theoretical justification and empirical success.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Recent works explore expanding MoE principles to these non-MLP components. The motivation is twofold:</p>\n\n    <ol>\n      <li><strong>Representation diversity:</strong> Different modalities (text, vision, audio) or architectural components (attention heads, encoders) require distinct forms of specialization.</li>\n      <li><strong>Compute efficiency:</strong> Selectively activating experts across broader network regions allows models to scale without saturating GPU memory or compute budgets.</li>\n    </ol>\n  </li>\n</ul>\n<p>The evolution of MoE beyond MLP layers marks a significant turning point in scalable neural network design:</p>\n<ul>\n      <li>MoE is no longer confined to feed-forward modules—it now extends to attention, connectors, and encoders.</li>\n      <li>These expansions enable <em>semantic specialization</em> across modalities, allowing experts to capture structured relationships in vision-language tasks.</li>\n      <li>Works like <a href=\"https://arxiv.org/abs/2405.05949\">CuMo</a>, <a href=\"https://arxiv.org/abs/2106.05974\">V-MoE</a>, <a href=\"https://arxiv.org/abs/2206.02770\">LIMoE</a>, and <a href=\"https://arxiv.org/abs/2312.07987\">Uni-MoE</a> collectively illustrate this trend, providing both theoretical justification and empirical success.</li>\n    </ul>\n<p>Recent works explore expanding MoE principles to these non-MLP components. The motivation is twofold:</p>\n<ol>\n      <li><strong>Representation diversity:</strong> Different modalities (text, vision, audio) or architectural components (attention heads, encoders) require distinct forms of specialization.</li>\n      <li><strong>Compute efficiency:</strong> Selectively activating experts across broader network regions allows models to scale without saturating GPU memory or compute budgets.</li>\n    </ol>",
    "contentMarkdown": "*   Traditionally, MoE layers have been integrated primarily into the **feed-forward (MLP) blocks** of transformer architectures. This design exploits conditional computation to scale model parameters without proportional increases in compute. However, limiting MoE to the MLP layers underutilizes its potential — transformer blocks also include **attention mechanisms**, **connectors**, and **modality-specific encoders** that can benefit from conditional sparsity.\n*   The evolution of MoE beyond MLP layers marks a significant turning point in scalable neural network design:\n    \n    *   MoE is no longer confined to feed-forward modules—it now extends to attention, connectors, and encoders.\n    *   These expansions enable _semantic specialization_ across modalities, allowing experts to capture structured relationships in vision-language tasks.\n    *   Works like [CuMo](https://arxiv.org/abs/2405.05949), [V-MoE](https://arxiv.org/abs/2106.05974), [LIMoE](https://arxiv.org/abs/2206.02770), and [Uni-MoE](https://arxiv.org/abs/2312.07987) collectively illustrate this trend, providing both theoretical justification and empirical success.\n*   Recent works explore expanding MoE principles to these non-MLP components. The motivation is twofold:\n    \n    1.  **Representation diversity:** Different modalities (text, vision, audio) or architectural components (attention heads, encoders) require distinct forms of specialization.\n    2.  **Compute efficiency:** Selectively activating experts across broader network regions allows models to scale without saturating GPU memory or compute budgets.\n\nThe evolution of MoE beyond MLP layers marks a significant turning point in scalable neural network design:\n\n*   MoE is no longer confined to feed-forward modules—it now extends to attention, connectors, and encoders.\n*   These expansions enable _semantic specialization_ across modalities, allowing experts to capture structured relationships in vision-language tasks.\n*   Works like [CuMo](https://arxiv.org/abs/2405.05949), [V-MoE](https://arxiv.org/abs/2106.05974), [LIMoE](https://arxiv.org/abs/2206.02770), and [Uni-MoE](https://arxiv.org/abs/2312.07987) collectively illustrate this trend, providing both theoretical justification and empirical success.\n\nRecent works explore expanding MoE principles to these non-MLP components. The motivation is twofold:\n\n1.  **Representation diversity:** Different modalities (text, vision, audio) or architectural components (attention heads, encoders) require distinct forms of specialization.\n2.  **Compute efficiency:** Selectively activating experts across broader network regions allows models to scale without saturating GPU memory or compute budgets.",
    "contentLength": 3136,
    "wordCount": 305,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#motivation"
  },
  {
    "id": "ai-mixture-of-experts-moe-in-attention-layers-46",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts Beyond MLP Layers",
    "title": "MoE in Attention Layers",
    "order": 46,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>\n    <p>A growing body of work investigates extending MoE to <em>attention sublayers</em>, which traditionally remain dense even in sparse architectures. The <strong>MoA (Mixture-of-Attention)</strong> concept replaces the single self-attention mechanism with a set of attention experts, each specializing in different token dependencies or context types.</p>\n  </li>\n  <li>\n    <p>Formally, for a token sequence <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-325-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>X</mi><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi><mo>&amp;#x00D7;</mo><mi>d</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2443\" style=\"width: 4.951em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.117em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1004.12em, 2.451em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2444\"><span class=\"mi\" id=\"MathJax-Span-2445\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2446\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-2447\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2448\"><span class=\"mrow\" id=\"MathJax-Span-2449\"><span class=\"mi\" id=\"MathJax-Span-2450\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-2451\"><span class=\"mrow\" id=\"MathJax-Span-2452\"><span class=\"mi\" id=\"MathJax-Span-2453\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2454\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-2455\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>X</mi><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-325\">X \\in \\mathbb{R}^{N \\times d}</script>, instead of computing one attention map:</p>\n  </li>\n</ul>\n<p>A growing body of work investigates extending MoE to <em>attention sublayers</em>, which traditionally remain dense even in sparse architectures. The <strong>MoA (Mixture-of-Attention)</strong> concept replaces the single self-attention mechanism with a set of attention experts, each specializing in different token dependencies or context types.</p>\n<p>Formally, for a token sequence <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-325-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>X</mi><mo>&amp;#x2208;</mo><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>R</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi><mo>&amp;#x00D7;</mo><mi>d</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2443\" style=\"width: 4.951em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.117em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1004.12em, 2.451em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2444\"><span class=\"mi\" id=\"MathJax-Span-2445\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2446\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-2447\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2448\"><span class=\"mrow\" id=\"MathJax-Span-2449\"><span class=\"mi\" id=\"MathJax-Span-2450\" style=\"font-family: STIXGeneral-Regular;\">ℝ</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-2451\"><span class=\"mrow\" id=\"MathJax-Span-2452\"><span class=\"mi\" id=\"MathJax-Span-2453\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2454\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">×</span><span class=\"mi\" id=\"MathJax-Span-2455\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>X</mi><mo>∈</mo><msup><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">R</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-325\">X \\in \\mathbb{R}^{N \\times d}</script>, instead of computing one attention map:</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-326-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>Attn</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo>(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi mathvariant=&quot;normal&quot;>&amp;#x22A4;</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2456\" style=\"width: 15.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.128em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.19em, 1013.08em, 5.576em, -999.997em); top: -4.112em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2457\"><span class=\"mtext\" id=\"MathJax-Span-2458\" style=\"font-family: STIXGeneral-Regular;\">Attn</span><span class=\"mo\" id=\"MathJax-Span-2459\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2460\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2461\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2462\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2463\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">softmax</span><span class=\"mrow\" id=\"MathJax-Span-2464\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-2465\" style=\"vertical-align: -0.779em;\"><span style=\"font-family: STIXSizeFourSym;\">(</span></span><span class=\"mfrac\" id=\"MathJax-Span-2466\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.023em, 1002.09em, 4.326em, -999.997em); top: -4.685em; left: 50%; margin-left: -1.039em;\"><span class=\"mrow\" id=\"MathJax-Span-2467\"><span class=\"mi\" id=\"MathJax-Span-2468\" style=\"font-family: STIXGeneral-Italic;\">Q</span><span class=\"msubsup\" id=\"MathJax-Span-2469\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2470\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-2471\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">⊤</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(2.971em, 1001.88em, 4.534em, -999.997em); top: -3.122em; left: 50%; margin-left: -0.935em;\"><span class=\"msqrt\" id=\"MathJax-Span-2472\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.326em, -999.997em); top: -4.008em; left: 0.94em;\"><span class=\"mrow\" id=\"MathJax-Span-2473\"><span class=\"msubsup\" id=\"MathJax-Span-2474\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2475\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2476\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.023em, 1000.94em, 3.388em, -999.997em); top: -4.06em; left: 0.94em;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; font-family: STIXGeneral-Regular; top: -4.008em; left: 0em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; font-family: STIXGeneral-Regular; top: -4.008em; left: 0.419em;\">‾<span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(2.867em, 1000.94em, 4.43em, -999.997em); top: -3.904em; left: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">√</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1002.19em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 2.19em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2477\" style=\"vertical-align: -0.779em;\"><span style=\"font-family: STIXSizeFourSym;\">)</span></span></span><span class=\"mi\" id=\"MathJax-Span-2478\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2479\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 4.117em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.622em; border-left: 0px solid; width: 0px; height: 3.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mtext>Attn</mtext><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo>(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi mathvariant=\"normal\">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><mo>,</mo></math></span></span></div>\n<ul>\n  <li>\n    <p>MoA introduces a router that assigns tokens to one or more attention experts:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-327-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>MoA</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>E</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><msub><mtext>Attn</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2480\" style=\"width: 15.263em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 12.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1012.66em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2481\"><span class=\"mtext\" id=\"MathJax-Span-2482\" style=\"font-family: STIXGeneral-Regular;\">MoA</span><span class=\"mo\" id=\"MathJax-Span-2483\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2484\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2485\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2486\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2487\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2488\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2489\"><span class=\"mrow\" id=\"MathJax-Span-2490\"><span class=\"mi\" id=\"MathJax-Span-2491\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2492\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2493\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.47em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-2494\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2495\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2496\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2497\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2498\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2499\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2500\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2501\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2502\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.77em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-2503\" style=\"font-family: STIXGeneral-Regular;\">Attn</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 1.773em;\"><span class=\"mi\" id=\"MathJax-Span-2504\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2505\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2506\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2507\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2508\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mtext>MoA</mtext><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>E</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo>,</mo><msub><mtext>Attn</mtext><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo>,</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-327\">\\text{MoA}(X) = \\sum_{i=1}^E g_i(X) , \\text{Attn}_i(X),</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-328-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2509\" style=\"width: 2.711em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.242em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2510\"><span class=\"msubsup\" id=\"MathJax-Span-2511\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2512\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2513\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2514\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2515\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2516\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-328\">g_i(X)</script> are routing weights (soft or hard) for each attention expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-329-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2517\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2518\"><span class=\"mi\" id=\"MathJax-Span-2519\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-329\">i</script>.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This approach, explored in works like <a href=\"https://arxiv.org/abs/2403.07816\">MoA-Transformer (Zhao et al., 2024)</a>, enables diverse attention patterns — for example, one expert may specialize in short-range syntactic dependencies while another captures long-range semantic relations. Such routing-driven diversity has shown improvements in language modeling perplexity and multimodal reasoning tasks.</p>\n  </li>\n</ul>\n<p>MoA introduces a router that assigns tokens to one or more attention experts:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-328-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2509\" style=\"width: 2.711em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.242em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.19em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2510\"><span class=\"msubsup\" id=\"MathJax-Span-2511\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2512\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2513\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2514\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2515\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2516\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-328\">g_i(X)</script> are routing weights (soft or hard) for each attention expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-329-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2517\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2518\"><span class=\"mi\" id=\"MathJax-Span-2519\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-329\">i</script>.</li>\n    </ul>\n<p>This approach, explored in works like <a href=\"https://arxiv.org/abs/2403.07816\">MoA-Transformer (Zhao et al., 2024)</a>, enables diverse attention patterns — for example, one expert may specialize in short-range syntactic dependencies while another captures long-range semantic relations. Such routing-driven diversity has shown improvements in language modeling perplexity and multimodal reasoning tasks.</p>",
    "contentMarkdown": "*   A growing body of work investigates extending MoE to _attention sublayers_, which traditionally remain dense even in sparse architectures. The **MoA (Mixture-of-Attention)** concept replaces the single self-attention mechanism with a set of attention experts, each specializing in different token dependencies or context types.\n    \n*   Formally, for a token sequence X∈ℝN×dX∈RN×dX \\\\in \\\\mathbb{R}^{N \\\\times d}, instead of computing one attention map:\n    \n\nA growing body of work investigates extending MoE to _attention sublayers_, which traditionally remain dense even in sparse architectures. The **MoA (Mixture-of-Attention)** concept replaces the single self-attention mechanism with a set of attention experts, each specializing in different token dependencies or context types.\n\nFormally, for a token sequence X∈ℝN×dX∈RN×dX \\\\in \\\\mathbb{R}^{N \\\\times d}, instead of computing one attention map:\n\nAttn(X)\\=softmax(QK⊤dk‾‾√)V,Attn(X)\\=softmax(QK⊤dk)V,\n\n*   MoA introduces a router that assigns tokens to one or more attention experts:\n    \n    MoA(X)\\=∑i\\=1Egi(X),Attni(X),MoA(X)\\=∑i\\=1Egi(X),Attni(X),\n    \n    \\\\text{MoA}(X) = \\\\sum\\_{i=1}^E g\\_i(X) , \\\\text{Attn}\\_i(X),\n    *   where gi(X)gi(X)g\\_i(X) are routing weights (soft or hard) for each attention expert iii.\n*   This approach, explored in works like [MoA-Transformer (Zhao et al., 2024)](https://arxiv.org/abs/2403.07816), enables diverse attention patterns — for example, one expert may specialize in short-range syntactic dependencies while another captures long-range semantic relations. Such routing-driven diversity has shown improvements in language modeling perplexity and multimodal reasoning tasks.\n    \n\nMoA introduces a router that assigns tokens to one or more attention experts:\n\n*   where gi(X)gi(X)g\\_i(X) are routing weights (soft or hard) for each attention expert iii.\n\nThis approach, explored in works like [MoA-Transformer (Zhao et al., 2024)](https://arxiv.org/abs/2403.07816), enables diverse attention patterns — for example, one expert may specialize in short-range syntactic dependencies while another captures long-range semantic relations. Such routing-driven diversity has shown improvements in language modeling perplexity and multimodal reasoning tasks.",
    "contentLength": 29109,
    "wordCount": 276,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#moe-in-attention-layers"
  },
  {
    "id": "ai-mixture-of-experts-moe-in-modality-encoders-and-connectors-47",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts Beyond MLP Layers",
    "title": "MoE in Modality Encoders and Connectors",
    "order": 47,
    "orderInChapter": 3,
    "contentHtml": "<h4 id=\"vision-encoders\">Vision Encoders</h4>\n<ul>\n  <li>\n    <p>In multimodal systems, the vision backbone represents a significant compute bottleneck. <a href=\"https://arxiv.org/abs/2405.05949\">CuMo by Li et al. (2024)</a> introduces <strong>Co-Upcycled MoE (CuMo)</strong>, which integrates sparse <strong>Top-K MoE blocks</strong> into both the <strong>vision encoder</strong> and the <strong>MLP connector</strong> of multimodal LLMs. Each MoE expert in the vision encoder is initialized (“upcycled”) from a pre-trained dense MLP block, maintaining stability while enhancing scalability.</p>\n  </li>\n  <li>\n    <p>Their training pipeline involves three stages — pre-training, pre-finetuning, and co-upcycled MoE integration — ensuring that the sparse experts inherit useful priors before specialization. This co-upcycling strategy achieves strong results on benchmarks like <strong>MMBench</strong>, <strong>GQA</strong>, and <strong>MMMU</strong>, outperforming models such as <strong>LLaVA-NeXT</strong> and <strong>Mini-Gemini</strong>.</p>\n  </li>\n  <li>\n    <p>Mathematically, the CuMo architecture replaces a dense vision-encoder layer:</p>\n  </li>\n</ul>\n<p>In multimodal systems, the vision backbone represents a significant compute bottleneck. <a href=\"https://arxiv.org/abs/2405.05949\">CuMo by Li et al. (2024)</a> introduces <strong>Co-Upcycled MoE (CuMo)</strong>, which integrates sparse <strong>Top-K MoE blocks</strong> into both the <strong>vision encoder</strong> and the <strong>MLP connector</strong> of multimodal LLMs. Each MoE expert in the vision encoder is initialized (“upcycled”) from a pre-trained dense MLP block, maintaining stability while enhancing scalability.</p>\n<p>Their training pipeline involves three stages — pre-training, pre-finetuning, and co-upcycled MoE integration — ensuring that the sparse experts inherit useful priors before specialization. This co-upcycling strategy achieves strong results on benchmarks like <strong>MMBench</strong>, <strong>GQA</strong>, and <strong>MMMU</strong>, outperforming models such as <strong>LLaVA-NeXT</strong> and <strong>Mini-Gemini</strong>.</p>\n<p>Mathematically, the CuMo architecture replaces a dense vision-encoder layer:</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-330-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>Y</mi><mo>=</mo><mtext>MLP</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2520\" style=\"width: 6.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.42em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2521\"><span class=\"mi\" id=\"MathJax-Span-2522\" style=\"font-family: STIXGeneral-Italic;\">Y<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2523\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2524\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">MLP</span><span class=\"mo\" id=\"MathJax-Span-2525\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2526\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2527\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>Y</mi><mo>=</mo><mtext>MLP</mtext><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>\n    <p>… with a sparse variant:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-331-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>Y</mi><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>K</mi></mrow></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><msub><mtext>Expert</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2528\" style=\"width: 13.596em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.305em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.315em, 1011.25em, 3.648em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2529\"><span class=\"mi\" id=\"MathJax-Span-2530\" style=\"font-family: STIXGeneral-Italic;\">Y<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2531\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2532\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2533\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2534\"><span class=\"mrow\" id=\"MathJax-Span-2535\"><span class=\"mi\" id=\"MathJax-Span-2536\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2537\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2538\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.52em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"texatom\" id=\"MathJax-Span-2539\"><span class=\"mrow\" id=\"MathJax-Span-2540\"><span class=\"mi\" id=\"MathJax-Span-2541\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2542\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2543\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2544\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2545\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2546\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2547\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2548\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-2549\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.919em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.66em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-2550\" style=\"font-family: STIXGeneral-Regular;\">Expert</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.747em; left: 2.659em;\"><span class=\"mi\" id=\"MathJax-Span-2551\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2552\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2553\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2554\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2555\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>Y</mi><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>K</mi></mrow></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><msub><mtext>Expert</mtext><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo>,</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-331\">Y = \\sum_{i=1}^{K} g_i(X) \\cdot \\text{Expert}_i(X),</script>\n\n    <ul>\n      <li>where the router selects top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-332-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2556\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2557\"><span class=\"mi\" id=\"MathJax-Span-2558\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-332\">K</script> experts and enforces balanced usage through auxiliary load-balancing losses.</li>\n    </ul>\n  </li>\n</ul>\n<p>… with a sparse variant:</p>\n<ul>\n      <li>where the router selects top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-332-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2556\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2557\"><span class=\"mi\" id=\"MathJax-Span-2558\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-332\">K</script> experts and enforces balanced usage through auxiliary load-balancing losses.</li>\n    </ul>\n<h4 id=\"connectors-and-adapters\">Connectors and Adapters</h4>\n<ul>\n  <li>The <strong>MLP connectors</strong> between modalities also benefit from expert routing. CuMo’s design integrates MoE into these connectors to improve the <em>alignment</em> between visual and textual embeddings. Similarly, <strong>MoE-LLaVA (Zhang et al., 2023)</strong> introduces expert-specialized adapters within multimodal connectors, achieving substantial improvements in instruction-following and grounding tasks without increasing inference cost.</li>\n</ul>",
    "contentMarkdown": "#### Vision Encoders\n\n*   In multimodal systems, the vision backbone represents a significant compute bottleneck. [CuMo by Li et al. (2024)](https://arxiv.org/abs/2405.05949) introduces **Co-Upcycled MoE (CuMo)**, which integrates sparse **Top-K MoE blocks** into both the **vision encoder** and the **MLP connector** of multimodal LLMs. Each MoE expert in the vision encoder is initialized (“upcycled”) from a pre-trained dense MLP block, maintaining stability while enhancing scalability.\n    \n*   Their training pipeline involves three stages — pre-training, pre-finetuning, and co-upcycled MoE integration — ensuring that the sparse experts inherit useful priors before specialization. This co-upcycling strategy achieves strong results on benchmarks like **MMBench**, **GQA**, and **MMMU**, outperforming models such as **LLaVA-NeXT** and **Mini-Gemini**.\n    \n*   Mathematically, the CuMo architecture replaces a dense vision-encoder layer:\n    \n\nIn multimodal systems, the vision backbone represents a significant compute bottleneck. [CuMo by Li et al. (2024)](https://arxiv.org/abs/2405.05949) introduces **Co-Upcycled MoE (CuMo)**, which integrates sparse **Top-K MoE blocks** into both the **vision encoder** and the **MLP connector** of multimodal LLMs. Each MoE expert in the vision encoder is initialized (“upcycled”) from a pre-trained dense MLP block, maintaining stability while enhancing scalability.\n\nTheir training pipeline involves three stages — pre-training, pre-finetuning, and co-upcycled MoE integration — ensuring that the sparse experts inherit useful priors before specialization. This co-upcycling strategy achieves strong results on benchmarks like **MMBench**, **GQA**, and **MMMU**, outperforming models such as **LLaVA-NeXT** and **Mini-Gemini**.\n\nMathematically, the CuMo architecture replaces a dense vision-encoder layer:\n\nY\\=MLP(X)Y\\=MLP(X)\n\n*   … with a sparse variant:\n    \n    Y\\=∑i\\=1Kgi(X)⋅Experti(X),Y\\=∑i\\=1Kgi(X)⋅Experti(X),\n    \n    Y = \\\\sum\\_{i=1}^{K} g\\_i(X) \\\\cdot \\\\text{Expert}\\_i(X),\n    *   where the router selects top-KKK experts and enforces balanced usage through auxiliary load-balancing losses.\n\n… with a sparse variant:\n\n*   where the router selects top-KKK experts and enforces balanced usage through auxiliary load-balancing losses.\n\n#### Connectors and Adapters\n\n*   The **MLP connectors** between modalities also benefit from expert routing. CuMo’s design integrates MoE into these connectors to improve the _alignment_ between visual and textual embeddings. Similarly, **MoE-LLaVA (Zhang et al., 2023)** introduces expert-specialized adapters within multimodal connectors, achieving substantial improvements in instruction-following and grounding tasks without increasing inference cost.",
    "contentLength": 14172,
    "wordCount": 336,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#moe-in-modality-encoders-and-connectors"
  },
  {
    "id": "ai-mixture-of-experts-cross-modal-and-multimodal-moe-48",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts Beyond MLP Layers",
    "title": "Cross-Modal and Multimodal MoE",
    "order": 48,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>\n    <p>Beyond individual encoders, multimodal frameworks have begun using MoE as a <em>cross-modal fusion mechanism</em>.\nFor instance, <a href=\"https://arxiv.org/abs/2206.02770\">LIMoE: Multimodal Contrastive Learning with LIMoE: the Language-Image Mixture of Experts</a> by Mustafa et al. (2022) extends MoE into <strong>CLIP</strong>-style architectures by inserting expert layers in both visual and text towers. Each expert specializes in a specific modality distribution or visual concept. This structure significantly improves <strong>zero-shot image classification</strong> and <strong>text-image retrieval</strong> performance while maintaining computational efficiency.</p>\n  </li>\n  <li>\n    <p>Similarly, <a href=\"https://arxiv.org/abs/2106.05974\">V-MoE: Scaling Vision with Sparse Mixture of Experts</a> by Riquelme et al. (2021) demonstrates that replacing dense MLP layers with sparse experts in vision transformers leads to comparable accuracy with half the compute. These advances confirm that MoE designs are not only scalable but also <em>modality-adaptive</em>, enabling cross-domain generalization.</p>\n  </li>\n</ul>\n<p>Beyond individual encoders, multimodal frameworks have begun using MoE as a <em>cross-modal fusion mechanism</em>.\nFor instance, <a href=\"https://arxiv.org/abs/2206.02770\">LIMoE: Multimodal Contrastive Learning with LIMoE: the Language-Image Mixture of Experts</a> by Mustafa et al. (2022) extends MoE into <strong>CLIP</strong>-style architectures by inserting expert layers in both visual and text towers. Each expert specializes in a specific modality distribution or visual concept. This structure significantly improves <strong>zero-shot image classification</strong> and <strong>text-image retrieval</strong> performance while maintaining computational efficiency.</p>\n<p>Similarly, <a href=\"https://arxiv.org/abs/2106.05974\">V-MoE: Scaling Vision with Sparse Mixture of Experts</a> by Riquelme et al. (2021) demonstrates that replacing dense MLP layers with sparse experts in vision transformers leads to comparable accuracy with half the compute. These advances confirm that MoE designs are not only scalable but also <em>modality-adaptive</em>, enabling cross-domain generalization.</p>",
    "contentMarkdown": "*   Beyond individual encoders, multimodal frameworks have begun using MoE as a _cross-modal fusion mechanism_. For instance, [LIMoE: Multimodal Contrastive Learning with LIMoE: the Language-Image Mixture of Experts](https://arxiv.org/abs/2206.02770) by Mustafa et al. (2022) extends MoE into **CLIP**\\-style architectures by inserting expert layers in both visual and text towers. Each expert specializes in a specific modality distribution or visual concept. This structure significantly improves **zero-shot image classification** and **text-image retrieval** performance while maintaining computational efficiency.\n    \n*   Similarly, [V-MoE: Scaling Vision with Sparse Mixture of Experts](https://arxiv.org/abs/2106.05974) by Riquelme et al. (2021) demonstrates that replacing dense MLP layers with sparse experts in vision transformers leads to comparable accuracy with half the compute. These advances confirm that MoE designs are not only scalable but also _modality-adaptive_, enabling cross-domain generalization.\n    \n\nBeyond individual encoders, multimodal frameworks have begun using MoE as a _cross-modal fusion mechanism_. For instance, [LIMoE: Multimodal Contrastive Learning with LIMoE: the Language-Image Mixture of Experts](https://arxiv.org/abs/2206.02770) by Mustafa et al. (2022) extends MoE into **CLIP**\\-style architectures by inserting expert layers in both visual and text towers. Each expert specializes in a specific modality distribution or visual concept. This structure significantly improves **zero-shot image classification** and **text-image retrieval** performance while maintaining computational efficiency.\n\nSimilarly, [V-MoE: Scaling Vision with Sparse Mixture of Experts](https://arxiv.org/abs/2106.05974) by Riquelme et al. (2021) demonstrates that replacing dense MLP layers with sparse experts in vision transformers leads to comparable accuracy with half the compute. These advances confirm that MoE designs are not only scalable but also _modality-adaptive_, enabling cross-domain generalization.",
    "contentLength": 2246,
    "wordCount": 248,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#cross-modal-and-multimodal-moe"
  },
  {
    "id": "ai-mixture-of-experts-joint-moe-architectures-49",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts Beyond MLP Layers",
    "title": "Joint MoE Architectures",
    "order": 49,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>\n    <p>Recent multimodal systems explore <em>joint MoE</em> formulations where both the <strong>attention</strong> and <strong>feed-forward</strong> layers are expert-based, creating a hierarchical sparsity pattern. For example:</p>\n\n    <ul>\n      <li><a href=\"https://arxiv.org/abs/2503.02495\">Union of Experts: Adapting Hierarchical Routing to Equivalently Decomposed Transformer</a> by Yang et al. (2025) proposes hierarchical routing, where global experts manage modality interaction, while local experts specialize in intra-modal refinement.</li>\n      <li><a href=\"https://arxiv.org/abs/2405.11273\">Uni-MoE: Scaling Unified Multimodal LLMs with Mixture of Experts</a> by Li et al. (2024) uses shared routing across text and vision experts, enabling parameter sharing and reducing routing entropy.</li>\n      <li><a href=\"https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf\">HC-SMoE: Retraining-Free Merging of Sparse MoE via Hierarchical Clustering</a> by Chen et al. (2025) introduces a hierarchical clustering approach for sparsely activated MoE—merging similar experts without retraining, which aligns naturally with hierarchical expert organization.</li>\n    </ul>\n  </li>\n  <li>\n    <p>These architectures embody a shift toward <strong>multi-granular expert specialization</strong>, where different experts handle distinct facets of reasoning—spatial, textual, semantic, or modality-specific.</p>\n  </li>\n</ul>\n<p>Recent multimodal systems explore <em>joint MoE</em> formulations where both the <strong>attention</strong> and <strong>feed-forward</strong> layers are expert-based, creating a hierarchical sparsity pattern. For example:</p>\n<ul>\n      <li><a href=\"https://arxiv.org/abs/2503.02495\">Union of Experts: Adapting Hierarchical Routing to Equivalently Decomposed Transformer</a> by Yang et al. (2025) proposes hierarchical routing, where global experts manage modality interaction, while local experts specialize in intra-modal refinement.</li>\n      <li><a href=\"https://arxiv.org/abs/2405.11273\">Uni-MoE: Scaling Unified Multimodal LLMs with Mixture of Experts</a> by Li et al. (2024) uses shared routing across text and vision experts, enabling parameter sharing and reducing routing entropy.</li>\n      <li><a href=\"https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf\">HC-SMoE: Retraining-Free Merging of Sparse MoE via Hierarchical Clustering</a> by Chen et al. (2025) introduces a hierarchical clustering approach for sparsely activated MoE—merging similar experts without retraining, which aligns naturally with hierarchical expert organization.</li>\n    </ul>\n<p>These architectures embody a shift toward <strong>multi-granular expert specialization</strong>, where different experts handle distinct facets of reasoning—spatial, textual, semantic, or modality-specific.</p>",
    "contentMarkdown": "*   Recent multimodal systems explore _joint MoE_ formulations where both the **attention** and **feed-forward** layers are expert-based, creating a hierarchical sparsity pattern. For example:\n    \n    *   [Union of Experts: Adapting Hierarchical Routing to Equivalently Decomposed Transformer](https://arxiv.org/abs/2503.02495) by Yang et al. (2025) proposes hierarchical routing, where global experts manage modality interaction, while local experts specialize in intra-modal refinement.\n    *   [Uni-MoE: Scaling Unified Multimodal LLMs with Mixture of Experts](https://arxiv.org/abs/2405.11273) by Li et al. (2024) uses shared routing across text and vision experts, enabling parameter sharing and reducing routing entropy.\n    *   [HC-SMoE: Retraining-Free Merging of Sparse MoE via Hierarchical Clustering](https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf) by Chen et al. (2025) introduces a hierarchical clustering approach for sparsely activated MoE—merging similar experts without retraining, which aligns naturally with hierarchical expert organization.\n*   These architectures embody a shift toward **multi-granular expert specialization**, where different experts handle distinct facets of reasoning—spatial, textual, semantic, or modality-specific.\n    \n\nRecent multimodal systems explore _joint MoE_ formulations where both the **attention** and **feed-forward** layers are expert-based, creating a hierarchical sparsity pattern. For example:\n\n*   [Union of Experts: Adapting Hierarchical Routing to Equivalently Decomposed Transformer](https://arxiv.org/abs/2503.02495) by Yang et al. (2025) proposes hierarchical routing, where global experts manage modality interaction, while local experts specialize in intra-modal refinement.\n*   [Uni-MoE: Scaling Unified Multimodal LLMs with Mixture of Experts](https://arxiv.org/abs/2405.11273) by Li et al. (2024) uses shared routing across text and vision experts, enabling parameter sharing and reducing routing entropy.\n*   [HC-SMoE: Retraining-Free Merging of Sparse MoE via Hierarchical Clustering](https://openreview.net/pdf/643366be110a2f570b95fab96c6edba91a84eaec.pdf) by Chen et al. (2025) introduces a hierarchical clustering approach for sparsely activated MoE—merging similar experts without retraining, which aligns naturally with hierarchical expert organization.\n\nThese architectures embody a shift toward **multi-granular expert specialization**, where different experts handle distinct facets of reasoning—spatial, textual, semantic, or modality-specific.",
    "contentLength": 2855,
    "wordCount": 284,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#joint-moe-architectures"
  },
  {
    "id": "ai-mixture-of-experts-theoretical-and-practical-implications-50",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Mixture-of-Experts Beyond MLP Layers",
    "title": "Theoretical and Practical Implications",
    "order": 50,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p>Expanding MoE beyond MLP layers introduces new challenges and opportunities:</p>\n\n    <ul>\n      <li><strong>Routing complexity</strong> increases, requiring hierarchical or differentiable router designs to maintain efficiency.</li>\n      <li><strong>Load balancing</strong> becomes multidimensional—covering both tokens and modalities.</li>\n      <li><strong>Transferability</strong> improves, as experts pre-trained on one modality can often generalize to others under joint training.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Formally, the total computation cost of multimodal MoE can be expressed as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-333-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>C</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoE-total</mtext></mrow></msub><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>L</mi></mrow></munderover><msub><mi>K</mi><mi>l</mi></msub><mo>&amp;#x22C5;</mo><msubsup><mi>C</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>expert</mtext></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>l</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2559\" style=\"width: 13.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.315em, 1010.99em, 3.648em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2560\"><span class=\"msubsup\" id=\"MathJax-Span-2561\"><span style=\"display: inline-block; position: relative; width: 3.648em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2562\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-2563\"><span class=\"mrow\" id=\"MathJax-Span-2564\"><span class=\"mtext\" id=\"MathJax-Span-2565\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoE-total</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2566\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2567\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2568\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2569\"><span class=\"mrow\" id=\"MathJax-Span-2570\"><span class=\"mi\" id=\"MathJax-Span-2571\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2572\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2573\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.42em, 4.169em, -999.997em); top: -5.206em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-2574\"><span class=\"mrow\" id=\"MathJax-Span-2575\"><span class=\"mi\" id=\"MathJax-Span-2576\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2577\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2578\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2579\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2580\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-2581\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.503em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2582\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.732em;\"><span class=\"texatom\" id=\"MathJax-Span-2583\"><span class=\"mrow\" id=\"MathJax-Span-2584\"><span class=\"mo\" id=\"MathJax-Span-2585\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2586\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2587\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.44em, 1001.83em, 4.326em, -999.997em); top: -3.747em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-2588\"><span class=\"mrow\" id=\"MathJax-Span-2589\"><span class=\"mtext\" id=\"MathJax-Span-2590\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">expert</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2591\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>C</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoE-total</mtext></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>L</mi></mrow></munderover><msub><mi>K</mi><mi>l</mi></msub><mo>⋅</mo><msubsup><mi>C</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>expert</mtext></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>l</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><mo>,</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-333\">C_{\\text{MoE-total}} = \\sum_{l=1}^{L} K_l \\cdot C_{\\text{expert}}^{(l)},</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-334-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>K</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2592\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.94em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2593\"><span class=\"msubsup\" id=\"MathJax-Span-2594\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2595\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2596\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>K</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-334\">K_l</script> is the number of active experts at layer <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-335-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>l</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2597\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2598\"><span class=\"mi\" id=\"MathJax-Span-2599\" style=\"font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>l</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-335\">l</script>. Balancing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-336-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>K</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2600\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.94em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2601\"><span class=\"msubsup\" id=\"MathJax-Span-2602\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2603\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2604\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>K</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-336\">K_l</script> across modalities is critical for maximizing hardware utilization and minimizing memory bandwidth constraints, as discussed in <a href=\"https://arxiv.org/abs/2405.05949\">CuMo</a> by Li et al. (2024) and <a href=\"https://arxiv.org/abs/2206.02770\">LIMoE</a> by Mustafa et al. (2022).</li>\n    </ul>\n  </li>\n</ul>\n<p>Expanding MoE beyond MLP layers introduces new challenges and opportunities:</p>\n<ul>\n      <li><strong>Routing complexity</strong> increases, requiring hierarchical or differentiable router designs to maintain efficiency.</li>\n      <li><strong>Load balancing</strong> becomes multidimensional—covering both tokens and modalities.</li>\n      <li><strong>Transferability</strong> improves, as experts pre-trained on one modality can often generalize to others under joint training.</li>\n    </ul>\n<p>Formally, the total computation cost of multimodal MoE can be expressed as:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-334-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>K</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2592\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.94em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2593\"><span class=\"msubsup\" id=\"MathJax-Span-2594\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2595\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2596\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>K</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-334\">K_l</script> is the number of active experts at layer <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-335-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>l</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2597\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2598\"><span class=\"mi\" id=\"MathJax-Span-2599\" style=\"font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>l</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-335\">l</script>. Balancing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-336-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>K</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2600\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.94em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2601\"><span class=\"msubsup\" id=\"MathJax-Span-2602\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2603\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2604\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>K</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-336\">K_l</script> across modalities is critical for maximizing hardware utilization and minimizing memory bandwidth constraints, as discussed in <a href=\"https://arxiv.org/abs/2405.05949\">CuMo</a> by Li et al. (2024) and <a href=\"https://arxiv.org/abs/2206.02770\">LIMoE</a> by Mustafa et al. (2022).</li>\n    </ul>",
    "contentMarkdown": "*   Expanding MoE beyond MLP layers introduces new challenges and opportunities:\n    \n    *   **Routing complexity** increases, requiring hierarchical or differentiable router designs to maintain efficiency.\n    *   **Load balancing** becomes multidimensional—covering both tokens and modalities.\n    *   **Transferability** improves, as experts pre-trained on one modality can often generalize to others under joint training.\n*   Formally, the total computation cost of multimodal MoE can be expressed as:\n    \n    CMoE-total\\=∑l\\=1LKl⋅C(l)expert,CMoE-total\\=∑l\\=1LKl⋅Cexpert(l),\n    \n    C\\_{\\\\text{MoE-total}} = \\\\sum\\_{l=1}^{L} K\\_l \\\\cdot C\\_{\\\\text{expert}}^{(l)},\n    *   where KlKlK\\_l is the number of active experts at layer lll. Balancing KlKlK\\_l across modalities is critical for maximizing hardware utilization and minimizing memory bandwidth constraints, as discussed in [CuMo](https://arxiv.org/abs/2405.05949) by Li et al. (2024) and [LIMoE](https://arxiv.org/abs/2206.02770) by Mustafa et al. (2022).\n\nExpanding MoE beyond MLP layers introduces new challenges and opportunities:\n\n*   **Routing complexity** increases, requiring hierarchical or differentiable router designs to maintain efficiency.\n*   **Load balancing** becomes multidimensional—covering both tokens and modalities.\n*   **Transferability** improves, as experts pre-trained on one modality can often generalize to others under joint training.\n\nFormally, the total computation cost of multimodal MoE can be expressed as:\n\n*   where KlKlK\\_l is the number of active experts at layer lll. Balancing KlKlK\\_l across modalities is critical for maximizing hardware utilization and minimizing memory bandwidth constraints, as discussed in [CuMo](https://arxiv.org/abs/2405.05949) by Li et al. (2024) and [LIMoE](https://arxiv.org/abs/2206.02770) by Mustafa et al. (2022).",
    "contentLength": 20343,
    "wordCount": 217,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#theoretical-and-practical-implications"
  },
  {
    "id": "ai-mixture-of-experts-overview-51",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Overview",
    "order": 51,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>Conventional MoE frameworks treated <strong>each token as an independent routing unit</strong>, sending it to the most compatible expert(s) based on gating scores. While effective, this <em>token-wise routing</em> neglects structural relationships — such as inter-token dependencies, syntactic grouping, or semantic coherence.</li>\n  <li>As models grow in size and context windows expand, such isolated routing becomes increasingly inefficient and unstable.</li>\n  <li>To address this, researchers have begun developing <strong>structure-aware</strong> and <strong>hierarchical routing</strong> paradigms that capture higher-order relationships — between tokens, concepts, or entire regions of input. These new paradigms leverage <strong>cluster formation</strong>, <strong>graph structures</strong>, and <strong>expert hierarchies</strong> to promote both interpretability and computational efficiency.</li>\n  <li>This evolution is well represented by works such as <a href=\"https://openreview.net/forum?id=QV79qiKAjD\">On the Benefits of Learning to Route in Mixture-of-Experts Models</a> by Dikkala et al. (2023), <a href=\"https://arxiv.org/abs/2202.09368\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), <a href=\"https://arxiv.org/abs/2505.00792\">Improving Routing in Sparse Mixture of Experts with Graph of Tokens</a> by Nguyen et al. (2025), and <a href=\"https://arxiv.org/abs/2406.13233\">AdaMoE: Token-Adaptive Routing with Null Experts for Mixture-of-Experts Language Models</a> by Zeng et al. (2024). Collectively, these works demonstrate a decisive shift from independent token-level decisions to <em>concept- and structure-driven routing</em> in large-scale MoE architectures.</li>\n  <li>The evolution from <em>token-wise</em> to <em>structure- and hierarchy-aware</em> routing represents a pivotal shift in Mixture-of-Experts research.\nBy leveraging clusters, attention graphs, and adaptive routing, these systems now <strong>learn to organize knowledge semantically</strong>, rather than relying purely on statistical matching.</li>\n</ul>",
    "contentMarkdown": "*   Conventional MoE frameworks treated **each token as an independent routing unit**, sending it to the most compatible expert(s) based on gating scores. While effective, this _token-wise routing_ neglects structural relationships — such as inter-token dependencies, syntactic grouping, or semantic coherence.\n*   As models grow in size and context windows expand, such isolated routing becomes increasingly inefficient and unstable.\n*   To address this, researchers have begun developing **structure-aware** and **hierarchical routing** paradigms that capture higher-order relationships — between tokens, concepts, or entire regions of input. These new paradigms leverage **cluster formation**, **graph structures**, and **expert hierarchies** to promote both interpretability and computational efficiency.\n*   This evolution is well represented by works such as [On the Benefits of Learning to Route in Mixture-of-Experts Models](https://openreview.net/forum?id=QV79qiKAjD) by Dikkala et al. (2023), [Mixture-of-Experts with Expert Choice Routing](https://arxiv.org/abs/2202.09368) by Zhou et al. (2022), [Improving Routing in Sparse Mixture of Experts with Graph of Tokens](https://arxiv.org/abs/2505.00792) by Nguyen et al. (2025), and [AdaMoE: Token-Adaptive Routing with Null Experts for Mixture-of-Experts Language Models](https://arxiv.org/abs/2406.13233) by Zeng et al. (2024). Collectively, these works demonstrate a decisive shift from independent token-level decisions to _concept- and structure-driven routing_ in large-scale MoE architectures.\n*   The evolution from _token-wise_ to _structure- and hierarchy-aware_ routing represents a pivotal shift in Mixture-of-Experts research. By leveraging clusters, attention graphs, and adaptive routing, these systems now **learn to organize knowledge semantically**, rather than relying purely on statistical matching.",
    "contentLength": 2086,
    "wordCount": 230,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#overview"
  },
  {
    "id": "ai-mixture-of-experts-motivation-52",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Motivation",
    "order": 52,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>\n    <p>The motivation for <strong>structural and hierarchical routing</strong> in MoE models stems from the growing recognition that token-level routing—though effective for sparsity and efficiency—fails to capture the deeper semantic, relational, and structural patterns inherent in data. As model capacity scales, <em>how</em> tokens are routed becomes as important as <em>which</em> experts they reach.</p>\n\n    <ul>\n      <li>\n        <p><strong>Semantic and structural coherence:</strong> Tokens or inputs that share semantic or syntactic functions (e.g., all math-related symbols, or tokens in a dialogue segment) should ideally be processed by the same or related experts. This coherence allows experts to specialize more deeply in conceptual domains rather than handling disjoint, unrelated inputs.</p>\n      </li>\n      <li>\n        <p><strong>Avoiding token fragmentation:</strong> Independent routing often fragments semantically related tokens across multiple experts, leading to unstable learning dynamics. This fragmentation reduces expert specialization and hinders generalization, as experts receive highly diverse or noisy data distributions. Works such as <a href=\"https://openreview.net/forum?id=QV79qiKAjD\">On the Benefits of Learning to Route in Mixture-of-Experts Models</a> by Dikkala et al. (2023) demonstrate that structured grouping of tokens yields more robust representations.</p>\n      </li>\n      <li>\n        <p><strong>Capturing inter-token dependencies:</strong> Incorporating token relationships through similarity metrics, attention maps, or graph structures—as in <a href=\"https://arxiv.org/abs/2505.00792\">Improving Routing in Sparse Mixture of Experts with Graph of Tokens</a> by Nguyen et al. (2025)—enables routing decisions that are context-aware rather than independent. This reduces routing “fluctuations” and improves specialization stability across training.</p>\n      </li>\n      <li>\n        <p><strong>Efficiency and interpretability:</strong> Structured routing also minimizes redundant computation by reducing frequent expert switching and unnecessary dispatch operations. Grouped tokens routed together lead to fewer communication overheads and more interpretable routing maps (e.g., <em>Expert A handles reasoning tokens</em>, <em>Expert B processes visual descriptions</em>). Such interpretability has been observed in architectures like <a href=\"https://arxiv.org/abs/2202.09368\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), where experts self-organize around coherent semantic patterns.</p>\n      </li>\n      <li>\n        <p><strong>Scalability and balance:</strong> Hierarchical and cluster-aware routing promotes scalability by balancing loads across groups of experts instead of individual experts. It ensures that no single expert is overwhelmed, while semantically aligned experts collaborate efficiently under shared routing hierarchies, as seen in hierarchical approaches like <a href=\"https://arxiv.org/abs/2505.07260\">Sparse-Transformer++</a> by Xu et al. (2024).</p>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>In essence, the motivation behind moving <em>beyond token-wise routing</em> is to align computational structure with semantic structure — enabling experts to mirror the inherent organization of language, vision, or multimodal data. This paradigm shift transforms routing from a purely statistical operation into a <strong>semantically informed decision process</strong>, laying the foundation for more interpretable, efficient, and stable sparse architectures.</p>\n  </li>\n</ul>\n<p>The motivation for <strong>structural and hierarchical routing</strong> in MoE models stems from the growing recognition that token-level routing—though effective for sparsity and efficiency—fails to capture the deeper semantic, relational, and structural patterns inherent in data. As model capacity scales, <em>how</em> tokens are routed becomes as important as <em>which</em> experts they reach.</p>\n<ul>\n      <li>\n        <p><strong>Semantic and structural coherence:</strong> Tokens or inputs that share semantic or syntactic functions (e.g., all math-related symbols, or tokens in a dialogue segment) should ideally be processed by the same or related experts. This coherence allows experts to specialize more deeply in conceptual domains rather than handling disjoint, unrelated inputs.</p>\n      </li>\n      <li>\n        <p><strong>Avoiding token fragmentation:</strong> Independent routing often fragments semantically related tokens across multiple experts, leading to unstable learning dynamics. This fragmentation reduces expert specialization and hinders generalization, as experts receive highly diverse or noisy data distributions. Works such as <a href=\"https://openreview.net/forum?id=QV79qiKAjD\">On the Benefits of Learning to Route in Mixture-of-Experts Models</a> by Dikkala et al. (2023) demonstrate that structured grouping of tokens yields more robust representations.</p>\n      </li>\n      <li>\n        <p><strong>Capturing inter-token dependencies:</strong> Incorporating token relationships through similarity metrics, attention maps, or graph structures—as in <a href=\"https://arxiv.org/abs/2505.00792\">Improving Routing in Sparse Mixture of Experts with Graph of Tokens</a> by Nguyen et al. (2025)—enables routing decisions that are context-aware rather than independent. This reduces routing “fluctuations” and improves specialization stability across training.</p>\n      </li>\n      <li>\n        <p><strong>Efficiency and interpretability:</strong> Structured routing also minimizes redundant computation by reducing frequent expert switching and unnecessary dispatch operations. Grouped tokens routed together lead to fewer communication overheads and more interpretable routing maps (e.g., <em>Expert A handles reasoning tokens</em>, <em>Expert B processes visual descriptions</em>). Such interpretability has been observed in architectures like <a href=\"https://arxiv.org/abs/2202.09368\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), where experts self-organize around coherent semantic patterns.</p>\n      </li>\n      <li>\n        <p><strong>Scalability and balance:</strong> Hierarchical and cluster-aware routing promotes scalability by balancing loads across groups of experts instead of individual experts. It ensures that no single expert is overwhelmed, while semantically aligned experts collaborate efficiently under shared routing hierarchies, as seen in hierarchical approaches like <a href=\"https://arxiv.org/abs/2505.07260\">Sparse-Transformer++</a> by Xu et al. (2024).</p>\n      </li>\n    </ul>\n<p><strong>Semantic and structural coherence:</strong> Tokens or inputs that share semantic or syntactic functions (e.g., all math-related symbols, or tokens in a dialogue segment) should ideally be processed by the same or related experts. This coherence allows experts to specialize more deeply in conceptual domains rather than handling disjoint, unrelated inputs.</p>\n<p><strong>Avoiding token fragmentation:</strong> Independent routing often fragments semantically related tokens across multiple experts, leading to unstable learning dynamics. This fragmentation reduces expert specialization and hinders generalization, as experts receive highly diverse or noisy data distributions. Works such as <a href=\"https://openreview.net/forum?id=QV79qiKAjD\">On the Benefits of Learning to Route in Mixture-of-Experts Models</a> by Dikkala et al. (2023) demonstrate that structured grouping of tokens yields more robust representations.</p>\n<p><strong>Capturing inter-token dependencies:</strong> Incorporating token relationships through similarity metrics, attention maps, or graph structures—as in <a href=\"https://arxiv.org/abs/2505.00792\">Improving Routing in Sparse Mixture of Experts with Graph of Tokens</a> by Nguyen et al. (2025)—enables routing decisions that are context-aware rather than independent. This reduces routing “fluctuations” and improves specialization stability across training.</p>\n<p><strong>Efficiency and interpretability:</strong> Structured routing also minimizes redundant computation by reducing frequent expert switching and unnecessary dispatch operations. Grouped tokens routed together lead to fewer communication overheads and more interpretable routing maps (e.g., <em>Expert A handles reasoning tokens</em>, <em>Expert B processes visual descriptions</em>). Such interpretability has been observed in architectures like <a href=\"https://arxiv.org/abs/2202.09368\">Mixture-of-Experts with Expert Choice Routing</a> by Zhou et al. (2022), where experts self-organize around coherent semantic patterns.</p>\n<p><strong>Scalability and balance:</strong> Hierarchical and cluster-aware routing promotes scalability by balancing loads across groups of experts instead of individual experts. It ensures that no single expert is overwhelmed, while semantically aligned experts collaborate efficiently under shared routing hierarchies, as seen in hierarchical approaches like <a href=\"https://arxiv.org/abs/2505.07260\">Sparse-Transformer++</a> by Xu et al. (2024).</p>\n<p>In essence, the motivation behind moving <em>beyond token-wise routing</em> is to align computational structure with semantic structure — enabling experts to mirror the inherent organization of language, vision, or multimodal data. This paradigm shift transforms routing from a purely statistical operation into a <strong>semantically informed decision process</strong>, laying the foundation for more interpretable, efficient, and stable sparse architectures.</p>",
    "contentMarkdown": "*   The motivation for **structural and hierarchical routing** in MoE models stems from the growing recognition that token-level routing—though effective for sparsity and efficiency—fails to capture the deeper semantic, relational, and structural patterns inherent in data. As model capacity scales, _how_ tokens are routed becomes as important as _which_ experts they reach.\n    \n    *   **Semantic and structural coherence:** Tokens or inputs that share semantic or syntactic functions (e.g., all math-related symbols, or tokens in a dialogue segment) should ideally be processed by the same or related experts. This coherence allows experts to specialize more deeply in conceptual domains rather than handling disjoint, unrelated inputs.\n        \n    *   **Avoiding token fragmentation:** Independent routing often fragments semantically related tokens across multiple experts, leading to unstable learning dynamics. This fragmentation reduces expert specialization and hinders generalization, as experts receive highly diverse or noisy data distributions. Works such as [On the Benefits of Learning to Route in Mixture-of-Experts Models](https://openreview.net/forum?id=QV79qiKAjD) by Dikkala et al. (2023) demonstrate that structured grouping of tokens yields more robust representations.\n        \n    *   **Capturing inter-token dependencies:** Incorporating token relationships through similarity metrics, attention maps, or graph structures—as in [Improving Routing in Sparse Mixture of Experts with Graph of Tokens](https://arxiv.org/abs/2505.00792) by Nguyen et al. (2025)—enables routing decisions that are context-aware rather than independent. This reduces routing “fluctuations” and improves specialization stability across training.\n        \n    *   **Efficiency and interpretability:** Structured routing also minimizes redundant computation by reducing frequent expert switching and unnecessary dispatch operations. Grouped tokens routed together lead to fewer communication overheads and more interpretable routing maps (e.g., _Expert A handles reasoning tokens_, _Expert B processes visual descriptions_). Such interpretability has been observed in architectures like [Mixture-of-Experts with Expert Choice Routing](https://arxiv.org/abs/2202.09368) by Zhou et al. (2022), where experts self-organize around coherent semantic patterns.\n        \n    *   **Scalability and balance:** Hierarchical and cluster-aware routing promotes scalability by balancing loads across groups of experts instead of individual experts. It ensures that no single expert is overwhelmed, while semantically aligned experts collaborate efficiently under shared routing hierarchies, as seen in hierarchical approaches like [Sparse-Transformer++](https://arxiv.org/abs/2505.07260) by Xu et al. (2024).\n        \n*   In essence, the motivation behind moving _beyond token-wise routing_ is to align computational structure with semantic structure — enabling experts to mirror the inherent organization of language, vision, or multimodal data. This paradigm shift transforms routing from a purely statistical operation into a **semantically informed decision process**, laying the foundation for more interpretable, efficient, and stable sparse architectures.\n    \n\nThe motivation for **structural and hierarchical routing** in MoE models stems from the growing recognition that token-level routing—though effective for sparsity and efficiency—fails to capture the deeper semantic, relational, and structural patterns inherent in data. As model capacity scales, _how_ tokens are routed becomes as important as _which_ experts they reach.\n\n*   **Semantic and structural coherence:** Tokens or inputs that share semantic or syntactic functions (e.g., all math-related symbols, or tokens in a dialogue segment) should ideally be processed by the same or related experts. This coherence allows experts to specialize more deeply in conceptual domains rather than handling disjoint, unrelated inputs.\n    \n*   **Avoiding token fragmentation:** Independent routing often fragments semantically related tokens across multiple experts, leading to unstable learning dynamics. This fragmentation reduces expert specialization and hinders generalization, as experts receive highly diverse or noisy data distributions. Works such as [On the Benefits of Learning to Route in Mixture-of-Experts Models](https://openreview.net/forum?id=QV79qiKAjD) by Dikkala et al. (2023) demonstrate that structured grouping of tokens yields more robust representations.\n    \n*   **Capturing inter-token dependencies:** Incorporating token relationships through similarity metrics, attention maps, or graph structures—as in [Improving Routing in Sparse Mixture of Experts with Graph of Tokens](https://arxiv.org/abs/2505.00792) by Nguyen et al. (2025)—enables routing decisions that are context-aware rather than independent. This reduces routing “fluctuations” and improves specialization stability across training.\n    \n*   **Efficiency and interpretability:** Structured routing also minimizes redundant computation by reducing frequent expert switching and unnecessary dispatch operations. Grouped tokens routed together lead to fewer communication overheads and more interpretable routing maps (e.g., _Expert A handles reasoning tokens_, _Expert B processes visual descriptions_). Such interpretability has been observed in architectures like [Mixture-of-Experts with Expert Choice Routing](https://arxiv.org/abs/2202.09368) by Zhou et al. (2022), where experts self-organize around coherent semantic patterns.\n    \n*   **Scalability and balance:** Hierarchical and cluster-aware routing promotes scalability by balancing loads across groups of experts instead of individual experts. It ensures that no single expert is overwhelmed, while semantically aligned experts collaborate efficiently under shared routing hierarchies, as seen in hierarchical approaches like [Sparse-Transformer++](https://arxiv.org/abs/2505.07260) by Xu et al. (2024).\n    \n\n**Semantic and structural coherence:** Tokens or inputs that share semantic or syntactic functions (e.g., all math-related symbols, or tokens in a dialogue segment) should ideally be processed by the same or related experts. This coherence allows experts to specialize more deeply in conceptual domains rather than handling disjoint, unrelated inputs.\n\n**Avoiding token fragmentation:** Independent routing often fragments semantically related tokens across multiple experts, leading to unstable learning dynamics. This fragmentation reduces expert specialization and hinders generalization, as experts receive highly diverse or noisy data distributions. Works such as [On the Benefits of Learning to Route in Mixture-of-Experts Models](https://openreview.net/forum?id=QV79qiKAjD) by Dikkala et al. (2023) demonstrate that structured grouping of tokens yields more robust representations.\n\n**Capturing inter-token dependencies:** Incorporating token relationships through similarity metrics, attention maps, or graph structures—as in [Improving Routing in Sparse Mixture of Experts with Graph of Tokens](https://arxiv.org/abs/2505.00792) by Nguyen et al. (2025)—enables routing decisions that are context-aware rather than independent. This reduces routing “fluctuations” and improves specialization stability across training.\n\n**Efficiency and interpretability:** Structured routing also minimizes redundant computation by reducing frequent expert switching and unnecessary dispatch operations. Grouped tokens routed together lead to fewer communication overheads and more interpretable routing maps (e.g., _Expert A handles reasoning tokens_, _Expert B processes visual descriptions_). Such interpretability has been observed in architectures like [Mixture-of-Experts with Expert Choice Routing](https://arxiv.org/abs/2202.09368) by Zhou et al. (2022), where experts self-organize around coherent semantic patterns.\n\n**Scalability and balance:** Hierarchical and cluster-aware routing promotes scalability by balancing loads across groups of experts instead of individual experts. It ensures that no single expert is overwhelmed, while semantically aligned experts collaborate efficiently under shared routing hierarchies, as seen in hierarchical approaches like [Sparse-Transformer++](https://arxiv.org/abs/2505.07260) by Xu et al. (2024).\n\nIn essence, the motivation behind moving _beyond token-wise routing_ is to align computational structure with semantic structure — enabling experts to mirror the inherent organization of language, vision, or multimodal data. This paradigm shift transforms routing from a purely statistical operation into a **semantically informed decision process**, laying the foundation for more interpretable, efficient, and stable sparse architectures.",
    "contentLength": 9632,
    "wordCount": 1070,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#motivation"
  },
  {
    "id": "ai-mixture-of-experts-structural-and-concept-aware-routing-53",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Structural and Concept-Aware Routing",
    "order": 53,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li><strong>Structural routing</strong> extends the traditional MoE paradigm by recognizing that tokens in natural language or multimodal data are rarely independent. Words in a phrase, patches in an image, or frames in a video exhibit strong contextual dependencies.</li>\n</ul>\n<h4 id=\"clustering-based-routing\">Clustering-Based Routing</h4>\n<ul>\n  <li>\n    <p>In <a href=\"https://aclanthology.org/2023.emnlp-main.583.pdf\">On the Benefits of Learning to Route in Mixture-of-Experts Models</a> by Dikkala et al. (2023), the gating network learns implicit clusters of tokens with similar semantics. The router automatically assigns tokens from the same latent group to a shared expert, effectively discovering <em>conceptual clusters</em> without explicit supervision.</p>\n  </li>\n  <li>\n    <p>Empirically, such clustering reduces expert fragmentation and stabilizes training, as related tokens are processed together. The clustering tendency can be formalized as minimizing intra-cluster variance:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-337-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>cluster</mtext></mrow></msub><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>E</mi></mrow></munderover><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>x</mi><mo>&amp;#x2208;</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>C</mi></mrow><mi>i</mi></msub></mrow></munder><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2212;</mo><msub><mi>&amp;#x03BC;</mi><mi>i</mi></msub><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mn>2</mn></msup></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2605\" style=\"width: 13.909em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.565em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.576em, 1011.57em, 4.013em, -999.997em); top: -2.497em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2606\"><span class=\"msubsup\" id=\"MathJax-Span-2607\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2608\"><span class=\"mrow\" id=\"MathJax-Span-2609\"><span class=\"mi\" id=\"MathJax-Span-2610\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-2611\"><span class=\"mrow\" id=\"MathJax-Span-2612\"><span class=\"mtext\" id=\"MathJax-Span-2613\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">cluster</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2614\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2615\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2616\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2617\"><span class=\"mrow\" id=\"MathJax-Span-2618\"><span class=\"mi\" id=\"MathJax-Span-2619\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2620\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2621\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.47em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"texatom\" id=\"MathJax-Span-2622\"><span class=\"mrow\" id=\"MathJax-Span-2623\"><span class=\"mi\" id=\"MathJax-Span-2624\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-2625\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.055em;\"><span class=\"mo\" id=\"MathJax-Span-2626\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.41em, 4.378em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2627\"><span class=\"mrow\" id=\"MathJax-Span-2628\"><span class=\"mi\" id=\"MathJax-Span-2629\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2630\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-2631\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2632\"><span class=\"mrow\" id=\"MathJax-Span-2633\"><span class=\"mi\" id=\"MathJax-Span-2634\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-2635\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-2636\" style=\"padding-left: 0.211em;\"><span class=\"mrow\" id=\"MathJax-Span-2637\"><span class=\"mo\" id=\"MathJax-Span-2638\" style=\"font-family: STIXVariants;\">|</span></span></span><span class=\"mi\" id=\"MathJax-Span-2639\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2640\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2641\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2642\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2643\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"msubsup\" id=\"MathJax-Span-2644\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2645\" style=\"font-family: STIXGeneral-Italic;\">μ</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2646\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2647\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.21em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2648\"><span class=\"mrow\" id=\"MathJax-Span-2649\"><span class=\"mo\" id=\"MathJax-Span-2650\" style=\"font-family: STIXVariants;\">|</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.424em; left: 0.315em;\"><span class=\"mn\" id=\"MathJax-Span-2651\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.503em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.684em; border-left: 0px solid; width: 0px; height: 3.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>cluster</mtext></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>E</mi></mrow></munderover><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>x</mi><mo>∈</mo><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">C</mi></mrow><mi>i</mi></msub></mrow></munder><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">|</mo></mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>−</mo><msub><mi>μ</mi><mi>i</mi></msub><msup><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">|</mo></mrow><mn>2</mn></msup></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-337\">\\mathcal{L}_{\\text{cluster}} = \\sum_{i=1}^{E} \\sum_{x \\in \\mathcal{C}_i} | f(x) - \\mu_i |^2</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-338-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2652\" style=\"width: 2.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.62em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2653\"><span class=\"mi\" id=\"MathJax-Span-2654\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2655\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2656\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2657\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>f</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-338\">f(x)</script> is the router embedding of token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-339-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2658\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2659\"><span class=\"mi\" id=\"MathJax-Span-2660\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-339\">x</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-340-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03BC;</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2661\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2662\"><span class=\"msubsup\" id=\"MathJax-Span-2663\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2664\" style=\"font-family: STIXGeneral-Italic;\">μ</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2665\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>μ</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-340\">\\mu_i</script> is the centroid for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-341-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2666\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2667\"><span class=\"mi\" id=\"MathJax-Span-2668\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-341\">i</script>, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-342-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>C</mi></mrow><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2669\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2670\"><span class=\"msubsup\" id=\"MathJax-Span-2671\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2672\"><span class=\"mrow\" id=\"MathJax-Span-2673\"><span class=\"mi\" id=\"MathJax-Span-2674\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-2675\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">C</mi></mrow><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-342\">\\mathcal{C}_i</script> is the token cluster routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-343-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2676\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2677\"><span class=\"mi\" id=\"MathJax-Span-2678\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-343\">i</script>.</li>\n    </ul>\n  </li>\n</ul>\n<p>In <a href=\"https://aclanthology.org/2023.emnlp-main.583.pdf\">On the Benefits of Learning to Route in Mixture-of-Experts Models</a> by Dikkala et al. (2023), the gating network learns implicit clusters of tokens with similar semantics. The router automatically assigns tokens from the same latent group to a shared expert, effectively discovering <em>conceptual clusters</em> without explicit supervision.</p>\n<p>Empirically, such clustering reduces expert fragmentation and stabilizes training, as related tokens are processed together. The clustering tendency can be formalized as minimizing intra-cluster variance:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-338-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2652\" style=\"width: 2.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.62em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2653\"><span class=\"mi\" id=\"MathJax-Span-2654\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2655\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2656\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2657\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>f</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-338\">f(x)</script> is the router embedding of token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-339-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2658\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2659\"><span class=\"mi\" id=\"MathJax-Span-2660\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-339\">x</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-340-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03BC;</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2661\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2662\"><span class=\"msubsup\" id=\"MathJax-Span-2663\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2664\" style=\"font-family: STIXGeneral-Italic;\">μ</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2665\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>μ</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-340\">\\mu_i</script> is the centroid for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-341-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2666\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2667\"><span class=\"mi\" id=\"MathJax-Span-2668\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-341\">i</script>, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-342-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>C</mi></mrow><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2669\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2670\"><span class=\"msubsup\" id=\"MathJax-Span-2671\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2672\"><span class=\"mrow\" id=\"MathJax-Span-2673\"><span class=\"mi\" id=\"MathJax-Span-2674\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-2675\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">C</mi></mrow><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-342\">\\mathcal{C}_i</script> is the token cluster routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-343-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2676\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2677\"><span class=\"mi\" id=\"MathJax-Span-2678\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-343\">i</script>.</li>\n    </ul>\n<h4 id=\"concept-driven-specialization\">Concept-Driven Specialization</h4>\n<ul>\n  <li>By associating experts with consistent conceptual regions of input space (e.g., math symbols, logical reasoning, or dialogue tone), models develop deeper specialization and interpretability. This emergent conceptual routing has been observed in both <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers</a> and follow-up works such as <a href=\"https://arxiv.org/abs/2202.09368\">Expert Choice Routing</a>, which show that experts often converge toward semantic roles without explicit supervision.</li>\n</ul>",
    "contentMarkdown": "*   **Structural routing** extends the traditional MoE paradigm by recognizing that tokens in natural language or multimodal data are rarely independent. Words in a phrase, patches in an image, or frames in a video exhibit strong contextual dependencies.\n\n#### Clustering-Based Routing\n\n*   In [On the Benefits of Learning to Route in Mixture-of-Experts Models](https://aclanthology.org/2023.emnlp-main.583.pdf) by Dikkala et al. (2023), the gating network learns implicit clusters of tokens with similar semantics. The router automatically assigns tokens from the same latent group to a shared expert, effectively discovering _conceptual clusters_ without explicit supervision.\n    \n*   Empirically, such clustering reduces expert fragmentation and stabilizes training, as related tokens are processed together. The clustering tendency can be formalized as minimizing intra-cluster variance:\n    \n    cluster\\=∑i\\=1E∑x∈i|f(x)−μi|2Lcluster\\=∑i\\=1E∑x∈Ci|f(x)−μi|2\n    \n    \\\\mathcal{L}\\_{\\\\text{cluster}} = \\\\sum\\_{i=1}^{E} \\\\sum\\_{x \\\\in \\\\mathcal{C}\\_i} | f(x) - \\\\mu\\_i |^2\n    *   where f(x)f(x)f(x) is the router embedding of token xxx, μiμi\\\\mu\\_i is the centroid for expert iii, and iCi\\\\mathcal{C}\\_i is the token cluster routed to expert iii.\n\nIn [On the Benefits of Learning to Route in Mixture-of-Experts Models](https://aclanthology.org/2023.emnlp-main.583.pdf) by Dikkala et al. (2023), the gating network learns implicit clusters of tokens with similar semantics. The router automatically assigns tokens from the same latent group to a shared expert, effectively discovering _conceptual clusters_ without explicit supervision.\n\nEmpirically, such clustering reduces expert fragmentation and stabilizes training, as related tokens are processed together. The clustering tendency can be formalized as minimizing intra-cluster variance:\n\n*   where f(x)f(x)f(x) is the router embedding of token xxx, μiμi\\\\mu\\_i is the centroid for expert iii, and iCi\\\\mathcal{C}\\_i is the token cluster routed to expert iii.\n\n#### Concept-Driven Specialization\n\n*   By associating experts with consistent conceptual regions of input space (e.g., math symbols, logical reasoning, or dialogue tone), models develop deeper specialization and interpretability. This emergent conceptual routing has been observed in both [Switch Transformers](https://arxiv.org/abs/2101.03961) and follow-up works such as [Expert Choice Routing](https://arxiv.org/abs/2202.09368), which show that experts often converge toward semantic roles without explicit supervision.",
    "contentLength": 31603,
    "wordCount": 314,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#structural-and-concept-aware-routing"
  },
  {
    "id": "ai-mixture-of-experts-hierarchical-routing-architectures-54",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Hierarchical Routing Architectures",
    "order": 54,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li><strong>Hierarchical routing</strong> introduces a multi-level expert organization where gating occurs at multiple granularities — e.g., clusters of experts managed by <em>super-experts</em> or <em>global routers</em>.</li>\n</ul>\n<h4 id=\"multi-level-expert-graphs\">Multi-Level Expert Graphs</h4>\n<ul>\n  <li>In <a href=\"https://arxiv.org/abs/2505.07260\">Sparse-Transformer++</a> by Xu et al. (2024), routing is decomposed into two stages:</li>\n</ul>\n<ol>\n  <li>A <strong>global router</strong> selects an expert group based on coarse semantic attributes.</li>\n  <li>A <strong>local router</strong> within that group selects the final expert(s) based on finer token-specific features.</li>\n</ol>\n<ul>\n  <li>\n    <p>This hierarchical structure is mathematically defined as:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-344-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><msub><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>global</mtext></mrow></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><msubsup><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>local</mtext></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2679\" style=\"width: 12.919em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.68em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2680\"><span class=\"msubsup\" id=\"MathJax-Span-2681\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2682\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2683\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2684\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2685\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2686\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2687\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-2688\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2689\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2690\"><span class=\"mrow\" id=\"MathJax-Span-2691\"><span class=\"mtext\" id=\"MathJax-Span-2692\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">global</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2693\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2694\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2695\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2696\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-2697\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2698\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2699\"><span class=\"mrow\" id=\"MathJax-Span-2700\"><span class=\"mo\" id=\"MathJax-Span-2701\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2702\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2703\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.46em, 4.169em, -999.997em); top: -3.695em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2704\"><span class=\"mrow\" id=\"MathJax-Span-2705\"><span class=\"mtext\" id=\"MathJax-Span-2706\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">local</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2707\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2708\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2709\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msub><mi>g</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>global</mtext></mrow></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><msubsup><mi>g</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>local</mtext></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-344\">g_i(x) = g_{\\text{global}}(x) \\cdot g_{\\text{local}}^{(i)}(x)</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-345-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>global</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2710\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1002.35em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2711\"><span class=\"msubsup\" id=\"MathJax-Span-2712\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2713\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2714\"><span class=\"mrow\" id=\"MathJax-Span-2715\"><span class=\"mtext\" id=\"MathJax-Span-2716\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">global</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>g</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>global</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-345\">g_{\\text{global}}</script> governs coarse-grained selection across groups and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-346-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>local</mtext></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2717\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.93em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2718\"><span class=\"msubsup\" id=\"MathJax-Span-2719\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2720\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2721\"><span class=\"mrow\" id=\"MathJax-Span-2722\"><span class=\"mo\" id=\"MathJax-Span-2723\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2724\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2725\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.46em, 4.169em, -999.997em); top: -3.695em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2726\"><span class=\"mrow\" id=\"MathJax-Span-2727\"><span class=\"mtext\" id=\"MathJax-Span-2728\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">local</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>g</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>local</mtext></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-346\">g_{\\text{local}}^{(i)}</script> refines the choice within group <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-347-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2729\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2730\"><span class=\"mi\" id=\"MathJax-Span-2731\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-347\">i</script>.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This two-level design improves <strong>routing efficiency</strong> (fewer gating operations per token) and enhances <strong>expert stability</strong>, as related experts co-evolve under shared global context.</p>\n  </li>\n</ul>\n<p>This hierarchical structure is mathematically defined as:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-345-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>global</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2710\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1002.35em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2711\"><span class=\"msubsup\" id=\"MathJax-Span-2712\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2713\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2714\"><span class=\"mrow\" id=\"MathJax-Span-2715\"><span class=\"mtext\" id=\"MathJax-Span-2716\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">global</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>g</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>global</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-345\">g_{\\text{global}}</script> governs coarse-grained selection across groups and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-346-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>g</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>local</mtext></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2717\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.93em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2718\"><span class=\"msubsup\" id=\"MathJax-Span-2719\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2720\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2721\"><span class=\"mrow\" id=\"MathJax-Span-2722\"><span class=\"mo\" id=\"MathJax-Span-2723\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2724\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2725\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.46em, 4.169em, -999.997em); top: -3.695em; left: 0.523em;\"><span class=\"texatom\" id=\"MathJax-Span-2726\"><span class=\"mrow\" id=\"MathJax-Span-2727\"><span class=\"mtext\" id=\"MathJax-Span-2728\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">local</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>g</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>local</mtext></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-346\">g_{\\text{local}}^{(i)}</script> refines the choice within group <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-347-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2729\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2730\"><span class=\"mi\" id=\"MathJax-Span-2731\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-347\">i</script>.</li>\n    </ul>\n<p>This two-level design improves <strong>routing efficiency</strong> (fewer gating operations per token) and enhances <strong>expert stability</strong>, as related experts co-evolve under shared global context.</p>\n<h4 id=\"hierarchical-load-balancing\">Hierarchical Load Balancing</h4>\n<ul>\n  <li>\n    <p>Hierarchical models require new balancing strategies to prevent group-level saturation. Load can be defined recursively:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-348-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mtext>Load</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mtext>group</mtext><mi>j</mi></msub></mrow></msub><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><msub><mtext>group</mtext><mi>j</mi></msub></mrow></munder><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2732\" style=\"width: 11.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 9.326em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1009.33em, 3.857em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2733\"><span class=\"msubsup\" id=\"MathJax-Span-2734\"><span style=\"display: inline-block; position: relative; width: 3.961em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-2735\" style=\"font-family: STIXGeneral-Regular;\">Load</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"texatom\" id=\"MathJax-Span-2736\"><span class=\"mrow\" id=\"MathJax-Span-2737\"><span class=\"msubsup\" id=\"MathJax-Span-2738\"><span style=\"display: inline-block; position: relative; width: 1.826em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1001.62em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-2739\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">group</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 1.669em;\"><span class=\"mi\" id=\"MathJax-Span-2740\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2741\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2742\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.503em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.628em;\"><span class=\"mo\" id=\"MathJax-Span-2743\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1002.5em, 4.534em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2744\"><span class=\"mrow\" id=\"MathJax-Span-2745\"><span class=\"mi\" id=\"MathJax-Span-2746\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2747\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-2748\"><span style=\"display: inline-block; position: relative; width: 1.826em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1001.62em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-2749\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">group</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 1.669em;\"><span class=\"mi\" id=\"MathJax-Span-2750\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2751\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2752\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2753\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2754\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2755\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2756\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.872em; border-left: 0px solid; width: 0px; height: 3.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mtext>Load</mtext><mrow class=\"MJX-TeXAtom-ORD\"><msub><mtext>group</mtext><mi>j</mi></msub></mrow></msub><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><msub><mtext>group</mtext><mi>j</mi></msub></mrow></munder><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-348\">\\text{Load}_{\\text{group}_j} = \\sum_{i \\in \\text{group}_j} f_i P_i</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-349-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2757\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2758\"><span class=\"msubsup\" id=\"MathJax-Span-2759\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2760\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2761\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-349\">f_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-350-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2762\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2763\"><span class=\"msubsup\" id=\"MathJax-Span-2764\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2765\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2766\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-350\">P_i</script> are the fraction and probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-351-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2767\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2768\"><span class=\"mi\" id=\"MathJax-Span-2769\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-351\">i</script> respectively (as defined in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>). Balancing at both the expert and group levels prevents bottlenecks and ensures smooth scaling to hundreds or thousands of experts.</li>\n    </ul>\n  </li>\n</ul>\n<p>Hierarchical models require new balancing strategies to prevent group-level saturation. Load can be defined recursively:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-349-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2757\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2758\"><span class=\"msubsup\" id=\"MathJax-Span-2759\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2760\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2761\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-349\">f_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-350-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2762\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2763\"><span class=\"msubsup\" id=\"MathJax-Span-2764\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2765\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2766\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-350\">P_i</script> are the fraction and probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-351-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2767\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2768\"><span class=\"mi\" id=\"MathJax-Span-2769\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-351\">i</script> respectively (as defined in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>). Balancing at both the expert and group levels prevents bottlenecks and ensures smooth scaling to hundreds or thousands of experts.</li>\n    </ul>",
    "contentMarkdown": "*   **Hierarchical routing** introduces a multi-level expert organization where gating occurs at multiple granularities — e.g., clusters of experts managed by _super-experts_ or _global routers_.\n\n#### Multi-Level Expert Graphs\n\n*   In [Sparse-Transformer++](https://arxiv.org/abs/2505.07260) by Xu et al. (2024), routing is decomposed into two stages:\n\n1.  A **global router** selects an expert group based on coarse semantic attributes.\n2.  A **local router** within that group selects the final expert(s) based on finer token-specific features.\n\n*   This hierarchical structure is mathematically defined as:\n    \n    gi(x)\\=gglobal(x)⋅g(i)local(x)gi(x)\\=gglobal(x)⋅glocal(i)(x)\n    \n    g\\_i(x) = g\\_{\\\\text{global}}(x) \\\\cdot g\\_{\\\\text{local}}^{(i)}(x)\n    *   where gglobalgglobalg\\_{\\\\text{global}} governs coarse-grained selection across groups and g(i)localglocal(i)g\\_{\\\\text{local}}^{(i)} refines the choice within group iii.\n*   This two-level design improves **routing efficiency** (fewer gating operations per token) and enhances **expert stability**, as related experts co-evolve under shared global context.\n    \n\nThis hierarchical structure is mathematically defined as:\n\n*   where gglobalgglobalg\\_{\\\\text{global}} governs coarse-grained selection across groups and g(i)localglocal(i)g\\_{\\\\text{local}}^{(i)} refines the choice within group iii.\n\nThis two-level design improves **routing efficiency** (fewer gating operations per token) and enhances **expert stability**, as related experts co-evolve under shared global context.\n\n#### Hierarchical Load Balancing\n\n*   Hierarchical models require new balancing strategies to prevent group-level saturation. Load can be defined recursively:\n    \n    Loadgroupj\\=∑i∈groupjfiPiLoadgroupj\\=∑i∈groupjfiPi\n    \n    \\\\text{Load}\\_{\\\\text{group}\\_j} = \\\\sum\\_{i \\\\in \\\\text{group}\\_j} f\\_i P\\_i\n    *   where fifif\\_i and PiPiP\\_i are the fraction and probability for expert iii respectively (as defined in [Switch Transformer](https://arxiv.org/abs/2101.03961)). Balancing at both the expert and group levels prevents bottlenecks and ensures smooth scaling to hundreds or thousands of experts.\n\nHierarchical models require new balancing strategies to prevent group-level saturation. Load can be defined recursively:\n\n*   where fifif\\_i and PiPiP\\_i are the fraction and probability for expert iii respectively (as defined in [Switch Transformer](https://arxiv.org/abs/2101.03961)). Balancing at both the expert and group levels prevents bottlenecks and ensures smooth scaling to hundreds or thousands of experts.",
    "contentLength": 38361,
    "wordCount": 293,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#hierarchical-routing-architectures"
  },
  {
    "id": "ai-mixture-of-experts-graph--and-attention-based-routing-55",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Graph- and Attention-Based Routing",
    "order": 55,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>\n    <p>Moving beyond pairwise similarity, recent work by <a href=\"https://arxiv.org/abs/2505.00792\">Nguyen et al. (2025)</a> introduces a <strong>Graph of Tokens (GoT)</strong> framework, in which routing is modeled as a message-passing process. Each token becomes a node, and edges encode semantic or attention-based affinities.</p>\n  </li>\n  <li>\n    <p>The routing distribution is then computed via a graph propagation function:</p>\n\n    <p><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-352-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>softmax</mtext><mo>!</mo><mrow><mo>(</mo><mrow><mfrac><mn>1</mn><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>N</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>N</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><mi>w</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mi>&amp;#x03D5;</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>)</mo></mrow><mo>,</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2770\" style=\"width: 24.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 20.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.138em, 1020.58em, 4.326em, -999.997em); top: -3.487em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2771\"><span class=\"msubsup\" id=\"MathJax-Span-2772\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2773\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2774\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2775\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2776\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2777\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2778\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2779\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">softmax</span><span class=\"mo\" id=\"MathJax-Span-2780\" style=\"font-family: STIXGeneral-Regular;\">!</span><span class=\"mrow\" id=\"MathJax-Span-2781\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-2782\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">(</span></span><span class=\"mrow\" id=\"MathJax-Span-2783\"><span class=\"mfrac\" id=\"MathJax-Span-2784\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-2785\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1001.93em, 4.326em, -999.997em); top: -3.539em; left: 50%; margin-left: -0.987em;\"><span class=\"mrow\" id=\"MathJax-Span-2786\"><span class=\"texatom\" id=\"MathJax-Span-2787\"><span class=\"mrow\" id=\"MathJax-Span-2788\"><span class=\"mo\" id=\"MathJax-Span-2789\" style=\"font-size: 70.7%; font-family: STIXVariants;\">|</span></span></span><span class=\"texatom\" id=\"MathJax-Span-2790\"><span class=\"mrow\" id=\"MathJax-Span-2791\"><span class=\"mi\" id=\"MathJax-Span-2792\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2793\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2794\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2795\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span class=\"texatom\" id=\"MathJax-Span-2796\"><span class=\"mrow\" id=\"MathJax-Span-2797\"><span class=\"mo\" id=\"MathJax-Span-2798\" style=\"font-size: 70.7%; font-family: STIXVariants;\">|</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1002.14em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 2.138em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-2799\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 3.596em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2800\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2801\"><span class=\"mrow\" id=\"MathJax-Span-2802\"><span class=\"msup\" id=\"MathJax-Span-2803\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2804\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.367em;\"><span class=\"mo\" id=\"MathJax-Span-2805\" style=\"font-size: 50%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2806\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2807\"><span class=\"mrow\" id=\"MathJax-Span-2808\"><span class=\"mi\" id=\"MathJax-Span-2809\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2810\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2811\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2812\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-2813\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">w</span><span class=\"mo\" id=\"MathJax-Span-2814\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2815\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2816\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msup\" id=\"MathJax-Span-2817\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2818\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2819\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2820\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2821\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2822\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">ϕ</span><span class=\"mo\" id=\"MathJax-Span-2823\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msup\" id=\"MathJax-Span-2824\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2825\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2826\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2827\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span class=\"mo\" id=\"MathJax-Span-2828\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">)</span></span></span><span class=\"mo\" id=\"MathJax-Span-2829\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 3.492em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>softmax</mtext><mo>!</mo><mrow><mo>(</mo><mrow><mfrac><mn>1</mn><mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">|</mo></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">N</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">|</mo></mrow></mrow></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><msup><mi>x</mi><mo>′</mo></msup><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">N</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow></munder><mi>w</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo><mo>,</mo><mi>ϕ</mi><mo stretchy=\"false\">(</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo></mrow><mo>)</mo></mrow><mo>,</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-352\">p_i(x) = \\text{softmax}!\\left( \\frac{1}{|\\mathcal{N}(x)|} \\sum_{x' \\in \\mathcal{N}(x)} w(x, x') , \\phi(x') \\right),</script></p>\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-353-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>w</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2830\" style=\"width: 3.857em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.18em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1003.13em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2831\"><span class=\"mi\" id=\"MathJax-Span-2832\" style=\"font-family: STIXGeneral-Italic;\">w</span><span class=\"mo\" id=\"MathJax-Span-2833\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2834\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2835\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msup\" id=\"MathJax-Span-2836\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2837\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2838\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2839\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>w</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-353\">w(x, x')</script> measures similarity between tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-354-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03D5;</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2840\" style=\"width: 2.451em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1001.98em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2841\"><span class=\"mi\" id=\"MathJax-Span-2842\" style=\"font-family: STIXGeneral-Italic;\">ϕ</span><span class=\"mo\" id=\"MathJax-Span-2843\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msup\" id=\"MathJax-Span-2844\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2845\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2846\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2847\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>ϕ</mi><mo stretchy=\"false\">(</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-354\">\\phi(x')</script> represents their local routing states.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This framework promotes <em>relational coherence</em>, routing similar tokens jointly and significantly improving generalization in sparse MoE models.</p>\n  </li>\n</ul>\n<p>Moving beyond pairwise similarity, recent work by <a href=\"https://arxiv.org/abs/2505.00792\">Nguyen et al. (2025)</a> introduces a <strong>Graph of Tokens (GoT)</strong> framework, in which routing is modeled as a message-passing process. Each token becomes a node, and edges encode semantic or attention-based affinities.</p>\n<p>The routing distribution is then computed via a graph propagation function:</p>\n<p><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-352-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>softmax</mtext><mo>!</mo><mrow><mo>(</mo><mrow><mfrac><mn>1</mn><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>N</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></mfrac><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>N</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><mi>w</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mi>&amp;#x03D5;</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>)</mo></mrow><mo>,</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2770\" style=\"width: 24.794em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 20.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.138em, 1020.58em, 4.326em, -999.997em); top: -3.487em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2771\"><span class=\"msubsup\" id=\"MathJax-Span-2772\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2773\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2774\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2775\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2776\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2777\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2778\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-2779\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">softmax</span><span class=\"mo\" id=\"MathJax-Span-2780\" style=\"font-family: STIXGeneral-Regular;\">!</span><span class=\"mrow\" id=\"MathJax-Span-2781\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-2782\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">(</span></span><span class=\"mrow\" id=\"MathJax-Span-2783\"><span class=\"mfrac\" id=\"MathJax-Span-2784\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-2785\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1001.93em, 4.326em, -999.997em); top: -3.539em; left: 50%; margin-left: -0.987em;\"><span class=\"mrow\" id=\"MathJax-Span-2786\"><span class=\"texatom\" id=\"MathJax-Span-2787\"><span class=\"mrow\" id=\"MathJax-Span-2788\"><span class=\"mo\" id=\"MathJax-Span-2789\" style=\"font-size: 70.7%; font-family: STIXVariants;\">|</span></span></span><span class=\"texatom\" id=\"MathJax-Span-2790\"><span class=\"mrow\" id=\"MathJax-Span-2791\"><span class=\"mi\" id=\"MathJax-Span-2792\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2793\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2794\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2795\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span class=\"texatom\" id=\"MathJax-Span-2796\"><span class=\"mrow\" id=\"MathJax-Span-2797\"><span class=\"mo\" id=\"MathJax-Span-2798\" style=\"font-size: 70.7%; font-family: STIXVariants;\">|</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1002.14em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 2.138em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-2799\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 3.596em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2800\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-2801\"><span class=\"mrow\" id=\"MathJax-Span-2802\"><span class=\"msup\" id=\"MathJax-Span-2803\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2804\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.367em;\"><span class=\"mo\" id=\"MathJax-Span-2805\" style=\"font-size: 50%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2806\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2807\"><span class=\"mrow\" id=\"MathJax-Span-2808\"><span class=\"mi\" id=\"MathJax-Span-2809\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2810\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2811\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2812\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-2813\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">w</span><span class=\"mo\" id=\"MathJax-Span-2814\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2815\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2816\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msup\" id=\"MathJax-Span-2817\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2818\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2819\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2820\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2821\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-2822\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">ϕ</span><span class=\"mo\" id=\"MathJax-Span-2823\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msup\" id=\"MathJax-Span-2824\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2825\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2826\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2827\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span class=\"mo\" id=\"MathJax-Span-2828\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">)</span></span></span><span class=\"mo\" id=\"MathJax-Span-2829\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 3.492em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>softmax</mtext><mo>!</mo><mrow><mo>(</mo><mrow><mfrac><mn>1</mn><mrow><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">|</mo></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">N</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">|</mo></mrow></mrow></mfrac><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><msup><mi>x</mi><mo>′</mo></msup><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">N</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow></munder><mi>w</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo><mo>,</mo><mi>ϕ</mi><mo stretchy=\"false\">(</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo></mrow><mo>)</mo></mrow><mo>,</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-352\">p_i(x) = \\text{softmax}!\\left( \\frac{1}{|\\mathcal{N}(x)|} \\sum_{x' \\in \\mathcal{N}(x)} w(x, x') , \\phi(x') \\right),</script></p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-353-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>w</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2830\" style=\"width: 3.857em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.18em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1003.13em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2831\"><span class=\"mi\" id=\"MathJax-Span-2832\" style=\"font-family: STIXGeneral-Italic;\">w</span><span class=\"mo\" id=\"MathJax-Span-2833\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2834\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2835\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msup\" id=\"MathJax-Span-2836\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2837\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2838\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2839\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>w</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo>,</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-353\">w(x, x')</script> measures similarity between tokens and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-354-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03D5;</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mi>x</mi><mo>&amp;#x2032;</mo></msup><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2840\" style=\"width: 2.451em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1001.98em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2841\"><span class=\"mi\" id=\"MathJax-Span-2842\" style=\"font-family: STIXGeneral-Italic;\">ϕ</span><span class=\"mo\" id=\"MathJax-Span-2843\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msup\" id=\"MathJax-Span-2844\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2845\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.523em;\"><span class=\"mo\" id=\"MathJax-Span-2846\" style=\"font-size: 70.7%; font-family: STIXVariants;\">′</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2847\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>ϕ</mi><mo stretchy=\"false\">(</mo><msup><mi>x</mi><mo>′</mo></msup><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-354\">\\phi(x')</script> represents their local routing states.</li>\n    </ul>\n<p>This framework promotes <em>relational coherence</em>, routing similar tokens jointly and significantly improving generalization in sparse MoE models.</p>",
    "contentMarkdown": "*   Moving beyond pairwise similarity, recent work by [Nguyen et al. (2025)](https://arxiv.org/abs/2505.00792) introduces a **Graph of Tokens (GoT)** framework, in which routing is modeled as a message-passing process. Each token becomes a node, and edges encode semantic or attention-based affinities.\n    \n*   The routing distribution is then computed via a graph propagation function:\n    \n    pi(x)\\=softmax!(1|(x)|∑x′∈(x)w(x,x′),ϕ(x′)),pi(x)\\=softmax!(1|N(x)|∑x′∈N(x)w(x,x′),ϕ(x′)),p\\_i(x) = \\\\text{softmax}!\\\\left( \\\\frac{1}{|\\\\mathcal{N}(x)|} \\\\sum\\_{x' \\\\in \\\\mathcal{N}(x)} w(x, x') , \\\\phi(x') \\\\right),\n    \n    *   where w(x,x′)w(x,x′)w(x, x') measures similarity between tokens and ϕ(x′)ϕ(x′)\\\\phi(x') represents their local routing states.\n*   This framework promotes _relational coherence_, routing similar tokens jointly and significantly improving generalization in sparse MoE models.\n    \n\nMoving beyond pairwise similarity, recent work by [Nguyen et al. (2025)](https://arxiv.org/abs/2505.00792) introduces a **Graph of Tokens (GoT)** framework, in which routing is modeled as a message-passing process. Each token becomes a node, and edges encode semantic or attention-based affinities.\n\nThe routing distribution is then computed via a graph propagation function:\n\npi(x)\\=softmax!(1|(x)|∑x′∈(x)w(x,x′),ϕ(x′)),pi(x)\\=softmax!(1|N(x)|∑x′∈N(x)w(x,x′),ϕ(x′)),p\\_i(x) = \\\\text{softmax}!\\\\left( \\\\frac{1}{|\\\\mathcal{N}(x)|} \\\\sum\\_{x' \\\\in \\\\mathcal{N}(x)} w(x, x') , \\\\phi(x') \\\\right),\n\n*   where w(x,x′)w(x,x′)w(x, x') measures similarity between tokens and ϕ(x′)ϕ(x′)\\\\phi(x') represents their local routing states.\n\nThis framework promotes _relational coherence_, routing similar tokens jointly and significantly improving generalization in sparse MoE models.",
    "contentLength": 36328,
    "wordCount": 191,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#graph--and-attention-based-routing"
  },
  {
    "id": "ai-mixture-of-experts-adaptive-and-token-group-routing-56",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Adaptive and Token-Group Routing",
    "order": 56,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p>Beyond static token clusters, models such as <a href=\"https://arxiv.org/abs/2406.13233\">AdaMoE</a> introduce <strong>dynamic token grouping</strong>. Each token adaptively decides:</p>\n\n    <ul>\n      <li>how many experts to engage, and</li>\n      <li>whether to skip computation entirely (via <em>null experts</em>).</li>\n    </ul>\n  </li>\n  <li>\n    <p>Formally, for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-355-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2848\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2849\"><span class=\"mi\" id=\"MathJax-Span-2850\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-355\">x</script>:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-356-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>Routing</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>S</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><msub><mtext>Expert</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2851\" style=\"width: 18.023em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 15.003em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1014.95em, 3.753em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2852\"><span class=\"mtext\" id=\"MathJax-Span-2853\" style=\"font-family: STIXGeneral-Regular;\">Routing</span><span class=\"mo\" id=\"MathJax-Span-2854\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2855\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2856\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2857\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2858\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.315em;\"><span class=\"mo\" id=\"MathJax-Span-2859\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.93em, 4.378em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-2860\"><span class=\"mrow\" id=\"MathJax-Span-2861\"><span class=\"mi\" id=\"MathJax-Span-2862\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2863\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-2864\"><span class=\"mrow\" id=\"MathJax-Span-2865\"><span class=\"mi\" id=\"MathJax-Span-2866\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2867\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2868\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2869\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2870\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2871\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2872\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2873\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2874\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2875\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2876\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-2877\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.919em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.66em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-2878\" style=\"font-family: STIXGeneral-Regular;\">Expert</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.747em; left: 2.659em;\"><span class=\"mi\" id=\"MathJax-Span-2879\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2880\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2881\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2882\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-2883\" style=\"font-family: STIXGeneral-Regular;\">,</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.684em; border-left: 0px solid; width: 0px; height: 2.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mtext>Routing</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">S</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow></munder><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><msub><mtext>Expert</mtext><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>,</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-356\">\\text{Routing}(x) = \\sum_{i \\in \\mathcal{S}(x)} g_i(x) \\cdot \\text{Expert}_i(x),</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-357-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>S</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2884\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.88em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2885\"><span class=\"texatom\" id=\"MathJax-Span-2886\"><span class=\"mrow\" id=\"MathJax-Span-2887\"><span class=\"mi\" id=\"MathJax-Span-2888\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2889\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2890\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2891\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">S</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-357\">\\mathcal{S}(x)</script> is a dynamically determined set of active experts, possibly empty.\nThis allows the model to modulate computation intensity based on token complexity, improving efficiency without degrading accuracy.</li>\n    </ul>\n  </li>\n</ul>\n<p>Beyond static token clusters, models such as <a href=\"https://arxiv.org/abs/2406.13233\">AdaMoE</a> introduce <strong>dynamic token grouping</strong>. Each token adaptively decides:</p>\n<ul>\n      <li>how many experts to engage, and</li>\n      <li>whether to skip computation entirely (via <em>null experts</em>).</li>\n    </ul>\n<p>Formally, for token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-355-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2848\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2849\"><span class=\"mi\" id=\"MathJax-Span-2850\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-355\">x</script>:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-357-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>S</mi></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2884\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.88em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2885\"><span class=\"texatom\" id=\"MathJax-Span-2886\"><span class=\"mrow\" id=\"MathJax-Span-2887\"><span class=\"mi\" id=\"MathJax-Span-2888\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2889\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2890\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2891\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">S</mi></mrow><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-357\">\\mathcal{S}(x)</script> is a dynamically determined set of active experts, possibly empty.\nThis allows the model to modulate computation intensity based on token complexity, improving efficiency without degrading accuracy.</li>\n    </ul>",
    "contentMarkdown": "*   Beyond static token clusters, models such as [AdaMoE](https://arxiv.org/abs/2406.13233) introduce **dynamic token grouping**. Each token adaptively decides:\n    \n    *   how many experts to engage, and\n    *   whether to skip computation entirely (via _null experts_).\n*   Formally, for token xxx:\n    \n    Routing(x)\\=∑i∈(x)gi(x)⋅Experti(x),Routing(x)\\=∑i∈S(x)gi(x)⋅Experti(x),\n    \n    \\\\text{Routing}(x) = \\\\sum\\_{i \\\\in \\\\mathcal{S}(x)} g\\_i(x) \\\\cdot \\\\text{Expert}\\_i(x),\n    *   where (x)S(x)\\\\mathcal{S}(x) is a dynamically determined set of active experts, possibly empty. This allows the model to modulate computation intensity based on token complexity, improving efficiency without degrading accuracy.\n\nBeyond static token clusters, models such as [AdaMoE](https://arxiv.org/abs/2406.13233) introduce **dynamic token grouping**. Each token adaptively decides:\n\n*   how many experts to engage, and\n*   whether to skip computation entirely (via _null experts_).\n\nFormally, for token xxx:\n\n*   where (x)S(x)\\\\mathcal{S}(x) is a dynamically determined set of active experts, possibly empty. This allows the model to modulate computation intensity based on token complexity, improving efficiency without degrading accuracy.",
    "contentLength": 15240,
    "wordCount": 143,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#adaptive-and-token-group-routing"
  },
  {
    "id": "ai-mixture-of-experts-benefits-limitations-and-open-questions-57",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Beyond Token-based Routing: Structural and Hierarchical Routing Paradigms",
    "title": "Benefits, Limitations, and Open Questions",
    "order": 57,
    "orderInChapter": 7,
    "contentHtml": "<h4 id=\"benefits\">Benefits</h4>\n<ul>\n  <li><strong>Improved specialization:</strong> Experts trained on coherent semantic groups learn deeper and more transferable representations.</li>\n  <li><strong>Stable routing dynamics:</strong> Structured gating mitigates routing noise, as observed in <a href=\"https://arxiv.org/abs/2505.00792\">Improving Routing in Sparse Mixture of Experts with Graph of Tokens</a> by Nguyen et al. (2025).</li>\n  <li><strong>Interpretability:</strong> Experts increasingly correspond to identifiable domains or concepts (e.g., reasoning, syntax).</li>\n  <li><strong>Efficiency gains:</strong> Clustering reduces redundant expert activations and routing overhead.</li>\n</ul>\n<h4 id=\"limitations-1\">Limitations</h4>\n<ul>\n  <li><strong>Latent specialization:</strong> Conceptual groupings are emergent rather than explicitly controlled.</li>\n  <li><strong>Computational overhead:</strong> Computing token-token similarity or maintaining graphs adds cost.</li>\n  <li><strong>Load balancing:</strong> Balancing across groups of experts or clusters remains non-trivial.</li>\n  <li><strong>Domain shift sensitivity:</strong> Clusters may drift under distributional changes.</li>\n</ul>\n<h4 id=\"open-questions\">Open Questions</h4>\n<ul>\n  <li>Can we <strong>explicitly label experts</strong> by domain or concept during training?</li>\n  <li>How does <strong>concept-aware routing</strong> scale to trillion-parameter MoEs?</li>\n  <li>What are the best <strong>metrics</strong> to evaluate semantic coherence in expert routing?</li>\n  <li>Can routing be made <strong>hierarchically differentiable</strong>, allowing backpropagation through cluster assignments?</li>\n  <li>How does <strong>routing hierarchy</strong> affect transfer and continual learning?</li>\n</ul>",
    "contentMarkdown": "#### Benefits\n\n*   **Improved specialization:** Experts trained on coherent semantic groups learn deeper and more transferable representations.\n*   **Stable routing dynamics:** Structured gating mitigates routing noise, as observed in [Improving Routing in Sparse Mixture of Experts with Graph of Tokens](https://arxiv.org/abs/2505.00792) by Nguyen et al. (2025).\n*   **Interpretability:** Experts increasingly correspond to identifiable domains or concepts (e.g., reasoning, syntax).\n*   **Efficiency gains:** Clustering reduces redundant expert activations and routing overhead.\n\n#### Limitations\n\n*   **Latent specialization:** Conceptual groupings are emergent rather than explicitly controlled.\n*   **Computational overhead:** Computing token-token similarity or maintaining graphs adds cost.\n*   **Load balancing:** Balancing across groups of experts or clusters remains non-trivial.\n*   **Domain shift sensitivity:** Clusters may drift under distributional changes.\n\n#### Open Questions\n\n*   Can we **explicitly label experts** by domain or concept during training?\n*   How does **concept-aware routing** scale to trillion-parameter MoEs?\n*   What are the best **metrics** to evaluate semantic coherence in expert routing?\n*   Can routing be made **hierarchically differentiable**, allowing backpropagation through cluster assignments?\n*   How does **routing hierarchy** affect transfer and continual learning?",
    "contentLength": 1781,
    "wordCount": 174,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#benefits,-limitations,-and-open-questions"
  },
  {
    "id": "ai-mixture-of-experts-overview-58",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Parallelism",
    "title": "Overview",
    "order": 58,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>Expert Parallelism (EP) refers to a model-parallelism strategy in which the distinct expert subnetworks are distributed across different devices (e.g., GPUs) rather than being replicated or tensor-sharded in the usual way. For high-level context: a typical MoE model comprises a gate (router) network that selects a subset of expert subnetworks (e.g., feed-forward layers) to process each token or input. By activating only a few experts per input, one gains a parameter-efficient model that uses a high total parameter count while keeping FLOPs somewhat restricted. Please refer <a href=\"https://en.wikipedia.org/wiki/Mixture_of_experts\">Wikipedia: Mixture of Experts</a> for further background.</p>\n  </li>\n  <li>\n    <p>EP enables leveraging that sparsity in a distributed training/inference setup: each device holds one (or more) full experts (rather than parts of all experts), and tokens are routed to the devices which hold the selected experts. This contrasts with tensor parallelism (splitting weights of a layer across devices) or pipeline parallelism (splitting layers across stages). EP is a type of model parallelism that distributes experts of an MoE across GPUs; unlike other model-parallel techniques, EP is applied to only the expert layers thus does not impact the parallel mapping of the rest of layers. The user guide for <a href=\"https://docs.nvidia.com/nemo-framework/user-guide/24.09/nemotoolkit/features/parallelisms.html\">NVIDIA NeMo Framework</a> offers further details on the specific steps to carry out EP.</p>\n  </li>\n  <li>\n    <p>In this section, we will lay out what EP is (definition and motivation), how it fits into the taxonomy of parallelism approaches (data, tensor, pipeline, expert), and the high-level benefits and trade-offs. In subsequent sections, we will dive deeper into implementation details, communication patterns, load-balancing issues, and scaling analysis.</p>\n  </li>\n</ul>\n<p>Expert Parallelism (EP) refers to a model-parallelism strategy in which the distinct expert subnetworks are distributed across different devices (e.g., GPUs) rather than being replicated or tensor-sharded in the usual way. For high-level context: a typical MoE model comprises a gate (router) network that selects a subset of expert subnetworks (e.g., feed-forward layers) to process each token or input. By activating only a few experts per input, one gains a parameter-efficient model that uses a high total parameter count while keeping FLOPs somewhat restricted. Please refer <a href=\"https://en.wikipedia.org/wiki/Mixture_of_experts\">Wikipedia: Mixture of Experts</a> for further background.</p>\n<p>EP enables leveraging that sparsity in a distributed training/inference setup: each device holds one (or more) full experts (rather than parts of all experts), and tokens are routed to the devices which hold the selected experts. This contrasts with tensor parallelism (splitting weights of a layer across devices) or pipeline parallelism (splitting layers across stages). EP is a type of model parallelism that distributes experts of an MoE across GPUs; unlike other model-parallel techniques, EP is applied to only the expert layers thus does not impact the parallel mapping of the rest of layers. The user guide for <a href=\"https://docs.nvidia.com/nemo-framework/user-guide/24.09/nemotoolkit/features/parallelisms.html\">NVIDIA NeMo Framework</a> offers further details on the specific steps to carry out EP.</p>\n<p>In this section, we will lay out what EP is (definition and motivation), how it fits into the taxonomy of parallelism approaches (data, tensor, pipeline, expert), and the high-level benefits and trade-offs. In subsequent sections, we will dive deeper into implementation details, communication patterns, load-balancing issues, and scaling analysis.</p>",
    "contentMarkdown": "*   Expert Parallelism (EP) refers to a model-parallelism strategy in which the distinct expert subnetworks are distributed across different devices (e.g., GPUs) rather than being replicated or tensor-sharded in the usual way. For high-level context: a typical MoE model comprises a gate (router) network that selects a subset of expert subnetworks (e.g., feed-forward layers) to process each token or input. By activating only a few experts per input, one gains a parameter-efficient model that uses a high total parameter count while keeping FLOPs somewhat restricted. Please refer [Wikipedia: Mixture of Experts](https://en.wikipedia.org/wiki/Mixture_of_experts) for further background.\n    \n*   EP enables leveraging that sparsity in a distributed training/inference setup: each device holds one (or more) full experts (rather than parts of all experts), and tokens are routed to the devices which hold the selected experts. This contrasts with tensor parallelism (splitting weights of a layer across devices) or pipeline parallelism (splitting layers across stages). EP is a type of model parallelism that distributes experts of an MoE across GPUs; unlike other model-parallel techniques, EP is applied to only the expert layers thus does not impact the parallel mapping of the rest of layers. The user guide for [NVIDIA NeMo Framework](https://docs.nvidia.com/nemo-framework/user-guide/24.09/nemotoolkit/features/parallelisms.html) offers further details on the specific steps to carry out EP.\n    \n*   In this section, we will lay out what EP is (definition and motivation), how it fits into the taxonomy of parallelism approaches (data, tensor, pipeline, expert), and the high-level benefits and trade-offs. In subsequent sections, we will dive deeper into implementation details, communication patterns, load-balancing issues, and scaling analysis.\n    \n\nExpert Parallelism (EP) refers to a model-parallelism strategy in which the distinct expert subnetworks are distributed across different devices (e.g., GPUs) rather than being replicated or tensor-sharded in the usual way. For high-level context: a typical MoE model comprises a gate (router) network that selects a subset of expert subnetworks (e.g., feed-forward layers) to process each token or input. By activating only a few experts per input, one gains a parameter-efficient model that uses a high total parameter count while keeping FLOPs somewhat restricted. Please refer [Wikipedia: Mixture of Experts](https://en.wikipedia.org/wiki/Mixture_of_experts) for further background.\n\nEP enables leveraging that sparsity in a distributed training/inference setup: each device holds one (or more) full experts (rather than parts of all experts), and tokens are routed to the devices which hold the selected experts. This contrasts with tensor parallelism (splitting weights of a layer across devices) or pipeline parallelism (splitting layers across stages). EP is a type of model parallelism that distributes experts of an MoE across GPUs; unlike other model-parallel techniques, EP is applied to only the expert layers thus does not impact the parallel mapping of the rest of layers. The user guide for [NVIDIA NeMo Framework](https://docs.nvidia.com/nemo-framework/user-guide/24.09/nemotoolkit/features/parallelisms.html) offers further details on the specific steps to carry out EP.\n\nIn this section, we will lay out what EP is (definition and motivation), how it fits into the taxonomy of parallelism approaches (data, tensor, pipeline, expert), and the high-level benefits and trade-offs. In subsequent sections, we will dive deeper into implementation details, communication patterns, load-balancing issues, and scaling analysis.",
    "contentLength": 3825,
    "wordCount": 511,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#overview"
  },
  {
    "id": "ai-mixture-of-experts-definition-and-taxonomy-59",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Parallelism",
    "title": "Definition and Taxonomy",
    "order": 59,
    "orderInChapter": 2,
    "contentHtml": "<h4 id=\"what-is-expert-parallelism\">What is Expert Parallelism?</h4>\n<ul>\n  <li>\n    <p>More formally, consider a MoE layer in a neural network. Suppose there are <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-358-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2892\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2893\"><span class=\"mi\" id=\"MathJax-Span-2894\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-358\">E</script> experts (sub-networks) in that layer, labeled <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-359-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mn>1</mn></msub><mo>,</mo><msub><mi>f</mi><mn>2</mn></msub><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><msub><mi>f</mi><mi>E</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2895\" style=\"width: 5.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.846em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1004.85em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2896\"><span class=\"msubsup\" id=\"MathJax-Span-2897\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2898\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mn\" id=\"MathJax-Span-2899\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2900\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2901\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2902\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mn\" id=\"MathJax-Span-2903\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2904\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-2905\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-2906\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2907\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2908\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2909\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mn>1</mn></msub><mo>,</mo><msub><mi>f</mi><mn>2</mn></msub><mo>,</mo><mo>…</mo><mo>,</mo><msub><mi>f</mi><mi>E</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-359\">f_1, f_2, \\dots, f_E</script>. An input token (or vector) <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-360-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2910\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2911\"><span class=\"mi\" id=\"MathJax-Span-2912\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-360\">x</script> is routed via a gating function <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-361-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2913\" style=\"width: 2.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.62em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2914\"><span class=\"mi\" id=\"MathJax-Span-2915\" style=\"font-family: STIXGeneral-Italic;\">g</span><span class=\"mo\" id=\"MathJax-Span-2916\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2917\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2918\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-361\">g(x)</script> which selects a subset of experts (often the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-362-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2919\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2920\"><span class=\"mi\" id=\"MathJax-Span-2921\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-362\">k</script> scoring experts) to process <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-363-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2922\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2923\"><span class=\"mi\" id=\"MathJax-Span-2924\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-363\">x</script>. In a standard MoE scenario, one writes:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-364-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>y</mi><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>E</mi></mrow></munderover><msub><mi>w</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2925\" style=\"width: 8.544em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.086em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1007.03em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2926\"><span class=\"mi\" id=\"MathJax-Span-2927\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-2928\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-2929\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-2930\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-2931\"><span class=\"mrow\" id=\"MathJax-Span-2932\"><span class=\"mi\" id=\"MathJax-Span-2933\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-2934\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-2935\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.47em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"texatom\" id=\"MathJax-Span-2936\"><span class=\"mrow\" id=\"MathJax-Span-2937\"><span class=\"mi\" id=\"MathJax-Span-2938\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-2939\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2940\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2941\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2942\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2943\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2944\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"msubsup\" id=\"MathJax-Span-2945\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2946\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2947\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2948\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2949\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2950\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>y</mi><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>E</mi></mrow></munderover><msub><mi>w</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-364\">y = \\sum_{i = 1}^{E} w_i(x) f_i(x)</script>\n\n    <ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-365-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>w</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2951\" style=\"width: 2.607em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2952\"><span class=\"msubsup\" id=\"MathJax-Span-2953\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2954\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2955\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2956\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2957\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2958\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>w</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-365\">w_i(x)</script> is non-zero only for a small subset of experts. (cf. <a href=\"https://arxiv.org/abs/1312.4314\">Learning Factored Representations in a Deep Mixture of Experts</a> by Eigen et al. (2013).)</li>\n    </ul>\n  </li>\n  <li>\n    <p>In EP, the distribution strategy is: each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-366-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2959\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2960\"><span class=\"msubsup\" id=\"MathJax-Span-2961\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2962\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2963\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-366\">f_i</script> is assigned to a particular device (or a group of devices). Thus device <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-367-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>d</mi><mi>j</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2964\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.78em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2965\"><span class=\"msubsup\" id=\"MathJax-Span-2966\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2967\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2968\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>d</mi><mi>j</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-367\">d_j</script> might host a subset of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-368-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>j</mi></msub><mo>&amp;#x2286;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>E</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2969\" style=\"width: 7.711em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1006.41em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2970\"><span class=\"msubsup\" id=\"MathJax-Span-2971\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2972\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2973\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2974\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">⊆</span><span class=\"texatom\" id=\"MathJax-Span-2975\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2976\"><span class=\"mn\" id=\"MathJax-Span-2977\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-2978\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-2979\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">2</span><span class=\"mo\" id=\"MathJax-Span-2980\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-2981\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-2982\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-2983\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>j</mi></msub><mo>⊆</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>E</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-368\">E_j \\subseteq {1,2,\\dots,E}</script>. Then when tokens are routed, one must send the token data to the device(s) hosting the selected experts, compute <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-369-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2984\" style=\"width: 2.138em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.773em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.72em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2985\"><span class=\"msubsup\" id=\"MathJax-Span-2986\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2987\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2988\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2989\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2990\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2991\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-369\">f_i(x)</script>, and then collect the outputs. This allows each device to perform full expert forward/backward passes for the ones it hosts.</p>\n  </li>\n</ul>\n<p>More formally, consider a MoE layer in a neural network. Suppose there are <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-358-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2892\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2893\"><span class=\"mi\" id=\"MathJax-Span-2894\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-358\">E</script> experts (sub-networks) in that layer, labeled <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-359-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mn>1</mn></msub><mo>,</mo><msub><mi>f</mi><mn>2</mn></msub><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><msub><mi>f</mi><mi>E</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2895\" style=\"width: 5.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.846em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1004.85em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2896\"><span class=\"msubsup\" id=\"MathJax-Span-2897\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2898\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mn\" id=\"MathJax-Span-2899\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2900\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2901\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2902\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mn\" id=\"MathJax-Span-2903\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2904\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-2905\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-2906\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-2907\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2908\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2909\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mn>1</mn></msub><mo>,</mo><msub><mi>f</mi><mn>2</mn></msub><mo>,</mo><mo>…</mo><mo>,</mo><msub><mi>f</mi><mi>E</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-359\">f_1, f_2, \\dots, f_E</script>. An input token (or vector) <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-360-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2910\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2911\"><span class=\"mi\" id=\"MathJax-Span-2912\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-360\">x</script> is routed via a gating function <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-361-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2913\" style=\"width: 2.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.62em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2914\"><span class=\"mi\" id=\"MathJax-Span-2915\" style=\"font-family: STIXGeneral-Italic;\">g</span><span class=\"mo\" id=\"MathJax-Span-2916\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2917\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2918\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-361\">g(x)</script> which selects a subset of experts (often the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-362-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2919\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2920\"><span class=\"mi\" id=\"MathJax-Span-2921\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-362\">k</script> scoring experts) to process <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-363-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2922\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2923\"><span class=\"mi\" id=\"MathJax-Span-2924\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-363\">x</script>. In a standard MoE scenario, one writes:</p>\n<ul>\n      <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-365-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>w</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2951\" style=\"width: 2.607em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2952\"><span class=\"msubsup\" id=\"MathJax-Span-2953\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2954\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"mi\" id=\"MathJax-Span-2955\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2956\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2957\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2958\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>w</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-365\">w_i(x)</script> is non-zero only for a small subset of experts. (cf. <a href=\"https://arxiv.org/abs/1312.4314\">Learning Factored Representations in a Deep Mixture of Experts</a> by Eigen et al. (2013).)</li>\n    </ul>\n<p>In EP, the distribution strategy is: each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-366-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2959\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2960\"><span class=\"msubsup\" id=\"MathJax-Span-2961\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2962\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2963\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-366\">f_i</script> is assigned to a particular device (or a group of devices). Thus device <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-367-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>d</mi><mi>j</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2964\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.78em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2965\"><span class=\"msubsup\" id=\"MathJax-Span-2966\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2967\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-2968\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>d</mi><mi>j</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-367\">d_j</script> might host a subset of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-368-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>j</mi></msub><mo>&amp;#x2286;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>E</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2969\" style=\"width: 7.711em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1006.41em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2970\"><span class=\"msubsup\" id=\"MathJax-Span-2971\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2972\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-2973\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2974\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">⊆</span><span class=\"texatom\" id=\"MathJax-Span-2975\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-2976\"><span class=\"mn\" id=\"MathJax-Span-2977\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-2978\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-2979\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">2</span><span class=\"mo\" id=\"MathJax-Span-2980\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-2981\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-2982\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-2983\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>j</mi></msub><mo>⊆</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>E</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-368\">E_j \\subseteq {1,2,\\dots,E}</script>. Then when tokens are routed, one must send the token data to the device(s) hosting the selected experts, compute <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-369-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2984\" style=\"width: 2.138em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.773em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.72em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2985\"><span class=\"msubsup\" id=\"MathJax-Span-2986\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-2987\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-2988\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-2989\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-2990\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-2991\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-369\">f_i(x)</script>, and then collect the outputs. This allows each device to perform full expert forward/backward passes for the ones it hosts.</p>\n<h4 id=\"positioning-among-parallelism-strategies\">Positioning Among Parallelism Strategies</h4>\n<ul>\n  <li>\n    <p>It helps to place EP alongside other common paradigms:</p>\n\n    <ul>\n      <li><strong>Data parallelism (DP):</strong> All devices hold a full copy of the model; different devices process different batches of data.</li>\n      <li><strong>Tensor parallelism (TP):</strong> A given layer’s weights are partitioned (e.g., split across columns/rows) across devices; each device computes a portion of that layer’s operation, and then results are combined. (See e.g., <a href=\"https://colossalai.org/docs/concepts/paradigms_of_parallelism/\">Paradigms of Parallelism</a> by Colossal-AI.)</li>\n      <li><strong>Pipeline parallelism (PP):</strong> Different layers are assigned to different devices; for a forward pass, tokens/properties are passed through the pipeline of devices.</li>\n      <li><strong>Expert parallelism (EP):</strong> A subtype of model parallelism where <strong>complete experts</strong> (sub-networks) are distributed, rather than splitting weights of a single expert. For example, the <a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed MoE implementation</a> tutorial states: “The GPUs (or ranks) participating in an expert-parallel group of size <code class=\"language-plaintext highlighter-rouge\">ep_size</code> will distribute the total number of experts specified by the layer.”</li>\n    </ul>\n  </li>\n  <li>\n    <p>Thus EP can be thought of as a specialization of model parallelism particular to MoE architectures; in fact, many large MoE systems use a <strong>hybrid parallelism</strong> combining DP + TP + EP (and sometimes PP) to scale in three dimensions (data, tensor weights, expert sub-networks). See Section 4 below for more on this.</p>\n  </li>\n</ul>\n<p>It helps to place EP alongside other common paradigms:</p>\n<ul>\n      <li><strong>Data parallelism (DP):</strong> All devices hold a full copy of the model; different devices process different batches of data.</li>\n      <li><strong>Tensor parallelism (TP):</strong> A given layer’s weights are partitioned (e.g., split across columns/rows) across devices; each device computes a portion of that layer’s operation, and then results are combined. (See e.g., <a href=\"https://colossalai.org/docs/concepts/paradigms_of_parallelism/\">Paradigms of Parallelism</a> by Colossal-AI.)</li>\n      <li><strong>Pipeline parallelism (PP):</strong> Different layers are assigned to different devices; for a forward pass, tokens/properties are passed through the pipeline of devices.</li>\n      <li><strong>Expert parallelism (EP):</strong> A subtype of model parallelism where <strong>complete experts</strong> (sub-networks) are distributed, rather than splitting weights of a single expert. For example, the <a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed MoE implementation</a> tutorial states: “The GPUs (or ranks) participating in an expert-parallel group of size <code class=\"language-plaintext highlighter-rouge\">ep_size</code> will distribute the total number of experts specified by the layer.”</li>\n    </ul>\n<p>Thus EP can be thought of as a specialization of model parallelism particular to MoE architectures; in fact, many large MoE systems use a <strong>hybrid parallelism</strong> combining DP + TP + EP (and sometimes PP) to scale in three dimensions (data, tensor weights, expert sub-networks). See Section 4 below for more on this.</p>\n<h4 id=\"why-expert-parallelism-matters\">Why Expert Parallelism Matters</h4>\n<ul>\n  <li>\n    <p>The rationale for EP is multi-fold:</p>\n\n    <ul>\n      <li><strong>Parameter scale:</strong> MoE models allow huge parameter counts (e.g., tens of billions) while only activating a small fraction per input. EP allows distributing those many parameters across devices, so no single device must hold all of them. For example, the blog about <a href=\"https://pytorch.org/blog/training-moes/\">training MoEs at scale with PyTorch</a> notes: “As models scale to larger sizes and fail to fit on a single GPU, we require more advanced forms of parallelism. EP is a form of model parallelism where we place different experts on different GPUs for better performance.”</li>\n      <li><strong>FLOP/activation efficiency:</strong> By routing only to a small subset of experts, each input performs fewer FLOPs than activating all experts. EP then ensures that the computational workload is distributed across devices and each device executes reasonably large matrix multiplications (better GPU utilization) rather than many tiny ones.</li>\n      <li><strong>Memory efficiency:</strong> Because not all experts are active for each input, and each device holds only part of the expert set, the peak memory footprint per device is reduced compared to naive replication of all experts.</li>\n      <li><strong>Scalability:</strong> EP enables scaling the number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-370-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2992\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2993\"><span class=\"mi\" id=\"MathJax-Span-2994\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-370\">E</script> and total model capacity without linearly increasing the per-token compute budget (assuming only a small number of experts active per token). This helps achieve almost constant cost per token with increasing parameter counts.</li>\n    </ul>\n  </li>\n</ul>\n<p>The rationale for EP is multi-fold:</p>\n<ul>\n      <li><strong>Parameter scale:</strong> MoE models allow huge parameter counts (e.g., tens of billions) while only activating a small fraction per input. EP allows distributing those many parameters across devices, so no single device must hold all of them. For example, the blog about <a href=\"https://pytorch.org/blog/training-moes/\">training MoEs at scale with PyTorch</a> notes: “As models scale to larger sizes and fail to fit on a single GPU, we require more advanced forms of parallelism. EP is a form of model parallelism where we place different experts on different GPUs for better performance.”</li>\n      <li><strong>FLOP/activation efficiency:</strong> By routing only to a small subset of experts, each input performs fewer FLOPs than activating all experts. EP then ensures that the computational workload is distributed across devices and each device executes reasonably large matrix multiplications (better GPU utilization) rather than many tiny ones.</li>\n      <li><strong>Memory efficiency:</strong> Because not all experts are active for each input, and each device holds only part of the expert set, the peak memory footprint per device is reduced compared to naive replication of all experts.</li>\n      <li><strong>Scalability:</strong> EP enables scaling the number of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-370-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2992\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2993\"><span class=\"mi\" id=\"MathJax-Span-2994\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-370\">E</script> and total model capacity without linearly increasing the per-token compute budget (assuming only a small number of experts active per token). This helps achieve almost constant cost per token with increasing parameter counts.</li>\n    </ul>",
    "contentMarkdown": "#### What is Expert Parallelism?\n\n*   More formally, consider a MoE layer in a neural network. Suppose there are EEE experts (sub-networks) in that layer, labeled f1,f2,…,fEf1,f2,…,fEf\\_1, f\\_2, \\\\dots, f\\_E. An input token (or vector) xxx is routed via a gating function g(x)g(x)g(x) which selects a subset of experts (often the top-kkk scoring experts) to process xxx. In a standard MoE scenario, one writes:\n    \n    y\\=∑i\\=1Ewi(x)fi(x)y\\=∑i\\=1Ewi(x)fi(x)\n    \n    y = \\\\sum\\_{i = 1}^{E} w\\_i(x) f\\_i(x)\n    *   where wi(x)wi(x)w\\_i(x) is non-zero only for a small subset of experts. (cf. [Learning Factored Representations in a Deep Mixture of Experts](https://arxiv.org/abs/1312.4314) by Eigen et al. (2013).)\n*   In EP, the distribution strategy is: each expert fifif\\_i is assigned to a particular device (or a group of devices). Thus device djdjd\\_j might host a subset of experts Ej⊆1,2,…,EEj⊆1,2,…,EE\\_j \\\\subseteq {1,2,\\\\dots,E}. Then when tokens are routed, one must send the token data to the device(s) hosting the selected experts, compute fi(x)fi(x)f\\_i(x), and then collect the outputs. This allows each device to perform full expert forward/backward passes for the ones it hosts.\n    \n\nMore formally, consider a MoE layer in a neural network. Suppose there are EEE experts (sub-networks) in that layer, labeled f1,f2,…,fEf1,f2,…,fEf\\_1, f\\_2, \\\\dots, f\\_E. An input token (or vector) xxx is routed via a gating function g(x)g(x)g(x) which selects a subset of experts (often the top-kkk scoring experts) to process xxx. In a standard MoE scenario, one writes:\n\n*   where wi(x)wi(x)w\\_i(x) is non-zero only for a small subset of experts. (cf. [Learning Factored Representations in a Deep Mixture of Experts](https://arxiv.org/abs/1312.4314) by Eigen et al. (2013).)\n\nIn EP, the distribution strategy is: each expert fifif\\_i is assigned to a particular device (or a group of devices). Thus device djdjd\\_j might host a subset of experts Ej⊆1,2,…,EEj⊆1,2,…,EE\\_j \\\\subseteq {1,2,\\\\dots,E}. Then when tokens are routed, one must send the token data to the device(s) hosting the selected experts, compute fi(x)fi(x)f\\_i(x), and then collect the outputs. This allows each device to perform full expert forward/backward passes for the ones it hosts.\n\n#### Positioning Among Parallelism Strategies\n\n*   It helps to place EP alongside other common paradigms:\n    \n    *   **Data parallelism (DP):** All devices hold a full copy of the model; different devices process different batches of data.\n    *   **Tensor parallelism (TP):** A given layer’s weights are partitioned (e.g., split across columns/rows) across devices; each device computes a portion of that layer’s operation, and then results are combined. (See e.g., [Paradigms of Parallelism](https://colossalai.org/docs/concepts/paradigms_of_parallelism/) by Colossal-AI.)\n    *   **Pipeline parallelism (PP):** Different layers are assigned to different devices; for a forward pass, tokens/properties are passed through the pipeline of devices.\n    *   **Expert parallelism (EP):** A subtype of model parallelism where **complete experts** (sub-networks) are distributed, rather than splitting weights of a single expert. For example, the [DeepSpeed MoE implementation](https://www.deepspeed.ai/tutorials/mixture-of-experts/) tutorial states: “The GPUs (or ranks) participating in an expert-parallel group of size `ep_size` will distribute the total number of experts specified by the layer.”\n*   Thus EP can be thought of as a specialization of model parallelism particular to MoE architectures; in fact, many large MoE systems use a **hybrid parallelism** combining DP + TP + EP (and sometimes PP) to scale in three dimensions (data, tensor weights, expert sub-networks). See Section 4 below for more on this.\n    \n\nIt helps to place EP alongside other common paradigms:\n\n*   **Data parallelism (DP):** All devices hold a full copy of the model; different devices process different batches of data.\n*   **Tensor parallelism (TP):** A given layer’s weights are partitioned (e.g., split across columns/rows) across devices; each device computes a portion of that layer’s operation, and then results are combined. (See e.g., [Paradigms of Parallelism](https://colossalai.org/docs/concepts/paradigms_of_parallelism/) by Colossal-AI.)\n*   **Pipeline parallelism (PP):** Different layers are assigned to different devices; for a forward pass, tokens/properties are passed through the pipeline of devices.\n*   **Expert parallelism (EP):** A subtype of model parallelism where **complete experts** (sub-networks) are distributed, rather than splitting weights of a single expert. For example, the [DeepSpeed MoE implementation](https://www.deepspeed.ai/tutorials/mixture-of-experts/) tutorial states: “The GPUs (or ranks) participating in an expert-parallel group of size `ep_size` will distribute the total number of experts specified by the layer.”\n\nThus EP can be thought of as a specialization of model parallelism particular to MoE architectures; in fact, many large MoE systems use a **hybrid parallelism** combining DP + TP + EP (and sometimes PP) to scale in three dimensions (data, tensor weights, expert sub-networks). See Section 4 below for more on this.\n\n#### Why Expert Parallelism Matters\n\n*   The rationale for EP is multi-fold:\n    \n    *   **Parameter scale:** MoE models allow huge parameter counts (e.g., tens of billions) while only activating a small fraction per input. EP allows distributing those many parameters across devices, so no single device must hold all of them. For example, the blog about [training MoEs at scale with PyTorch](https://pytorch.org/blog/training-moes/) notes: “As models scale to larger sizes and fail to fit on a single GPU, we require more advanced forms of parallelism. EP is a form of model parallelism where we place different experts on different GPUs for better performance.”\n    *   **FLOP/activation efficiency:** By routing only to a small subset of experts, each input performs fewer FLOPs than activating all experts. EP then ensures that the computational workload is distributed across devices and each device executes reasonably large matrix multiplications (better GPU utilization) rather than many tiny ones.\n    *   **Memory efficiency:** Because not all experts are active for each input, and each device holds only part of the expert set, the peak memory footprint per device is reduced compared to naive replication of all experts.\n    *   **Scalability:** EP enables scaling the number of experts EEE and total model capacity without linearly increasing the per-token compute budget (assuming only a small number of experts active per token). This helps achieve almost constant cost per token with increasing parameter counts.\n\nThe rationale for EP is multi-fold:\n\n*   **Parameter scale:** MoE models allow huge parameter counts (e.g., tens of billions) while only activating a small fraction per input. EP allows distributing those many parameters across devices, so no single device must hold all of them. For example, the blog about [training MoEs at scale with PyTorch](https://pytorch.org/blog/training-moes/) notes: “As models scale to larger sizes and fail to fit on a single GPU, we require more advanced forms of parallelism. EP is a form of model parallelism where we place different experts on different GPUs for better performance.”\n*   **FLOP/activation efficiency:** By routing only to a small subset of experts, each input performs fewer FLOPs than activating all experts. EP then ensures that the computational workload is distributed across devices and each device executes reasonably large matrix multiplications (better GPU utilization) rather than many tiny ones.\n*   **Memory efficiency:** Because not all experts are active for each input, and each device holds only part of the expert set, the peak memory footprint per device is reduced compared to naive replication of all experts.\n*   **Scalability:** EP enables scaling the number of experts EEE and total model capacity without linearly increasing the per-token compute budget (assuming only a small number of experts active per token). This helps achieve almost constant cost per token with increasing parameter counts.",
    "contentLength": 63525,
    "wordCount": 1180,
    "hasCode": true,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#definition-and-taxonomy"
  },
  {
    "id": "ai-mixture-of-experts-device-partitioning-token-routing-and-communicatio-60",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Parallelism",
    "title": "Device Partitioning, Token Routing, and Communication Mechanics",
    "order": 60,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>EP provides an elegant mechanism to map sparsely activated experts onto distributed hardware while preserving high model capacity. It relies on efficient all-to-all communication and balanced routing to ensure scalability. Modern frameworks optimize these aspects through load-balancing losses, fused collectives, and hybrid parallel designs.</li>\n</ul>\n<h4 id=\"conceptual-overview\">Conceptual Overview</h4>\n<ul>\n  <li>\n    <p>EP works by <em>partitioning experts across multiple devices</em> and dynamically routing token representations to the appropriate devices that host the selected experts. Each expert is a self-contained sub-network—typically a feed-forward block within a Transformer layer. During a forward pass, each input token is assigned to one or more experts according to the routing probabilities produced by the gating network (often a softmax-normalized linear projection of the token embeddings).</p>\n  </li>\n  <li>\n    <p>Formally, let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-371-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2995\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2996\"><span class=\"mi\" id=\"MathJax-Span-2997\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-371\">E</script> denote the total number of experts and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-372-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>D</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2998\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2999\"><span class=\"mi\" id=\"MathJax-Span-3000\" style=\"font-family: STIXGeneral-Italic;\">D</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>D</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-372\">D</script> the number of available devices. We define a device-to-expert mapping function</p>\n  </li>\n</ul>\n<p>EP works by <em>partitioning experts across multiple devices</em> and dynamically routing token representations to the appropriate devices that host the selected experts. Each expert is a self-contained sub-network—typically a feed-forward block within a Transformer layer. During a forward pass, each input token is assigned to one or more experts according to the routing probabilities produced by the gating network (often a softmax-normalized linear projection of the token embeddings).</p>\n<p>Formally, let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-371-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2995\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2996\"><span class=\"mi\" id=\"MathJax-Span-2997\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-371\">E</script> denote the total number of experts and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-372-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>D</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-2998\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-2999\"><span class=\"mi\" id=\"MathJax-Span-3000\" style=\"font-family: STIXGeneral-Italic;\">D</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>D</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-372\">D</script> the number of available devices. We define a device-to-expert mapping function</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-373-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>&amp;#x03D5;</mi><mo>:</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>E</mi></mrow><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><mi>D</mi></mrow></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3001\" style=\"width: 13.961em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.617em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1011.62em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3002\"><span class=\"mi\" id=\"MathJax-Span-3003\" style=\"font-family: STIXGeneral-Italic;\">ϕ</span><span class=\"mo\" id=\"MathJax-Span-3004\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">:</span><span class=\"texatom\" id=\"MathJax-Span-3005\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-3006\"><span class=\"mn\" id=\"MathJax-Span-3007\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-3008\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-3009\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">2</span><span class=\"mo\" id=\"MathJax-Span-3010\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-3011\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-3012\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-3013\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3014\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">→</span><span class=\"texatom\" id=\"MathJax-Span-3015\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-3016\"><span class=\"mn\" id=\"MathJax-Span-3017\" style=\"font-family: STIXGeneral-Regular;\">1</span><span class=\"mo\" id=\"MathJax-Span-3018\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-3019\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">2</span><span class=\"mo\" id=\"MathJax-Span-3020\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-3021\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-3022\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"mi\" id=\"MathJax-Span-3023\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">D</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>ϕ</mi><mo>:</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>E</mi></mrow><mo stretchy=\"false\">→</mo><mrow class=\"MJX-TeXAtom-ORD\"><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>D</mi></mrow></math></span></span></div>\n<ul>\n  <li>such that expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-374-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>e</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3024\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.73em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3025\"><span class=\"msubsup\" id=\"MathJax-Span-3026\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3027\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-3028\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>e</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-374\">e_i</script> resides on device <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-375-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03D5;</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3029\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.41em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3030\"><span class=\"mi\" id=\"MathJax-Span-3031\" style=\"font-family: STIXGeneral-Italic;\">ϕ</span><span class=\"mo\" id=\"MathJax-Span-3032\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3033\" style=\"font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3034\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>ϕ</mi><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-375\">\\phi(i)</script>. Each token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-376-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>x</mi><mi>j</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3035\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.73em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3036\"><span class=\"msubsup\" id=\"MathJax-Span-3037\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3038\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-3039\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>x</mi><mi>j</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-376\">x_j</script> is routed to a subset of experts <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-377-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>S</mi><mi>j</mi></msub><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mn>1</mn></mrow></msub><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><msub><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mi>k</mi></mrow></msub></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3040\" style=\"width: 7.503em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 6.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1006.25em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3041\"><span class=\"msubsup\" id=\"MathJax-Span-3042\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3043\" style=\"font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3044\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3045\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"texatom\" id=\"MathJax-Span-3046\" style=\"padding-left: 0.315em;\"><span class=\"mrow\" id=\"MathJax-Span-3047\"><span class=\"msubsup\" id=\"MathJax-Span-3048\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3049\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-3050\"><span class=\"mrow\" id=\"MathJax-Span-3051\"><span class=\"mi\" id=\"MathJax-Span-3052\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mn\" id=\"MathJax-Span-3053\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3054\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-3055\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-3056\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-3057\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3058\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-3059\"><span class=\"mrow\" id=\"MathJax-Span-3060\"><span class=\"mi\" id=\"MathJax-Span-3061\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3062\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>S</mi><mi>j</mi></msub><mo>=</mo><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mn>1</mn></mrow></msub><mo>,</mo><mo>…</mo><mo>,</mo><msub><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mi>k</mi></mrow></msub></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-377\">S_j = {e_{j1}, \\dots, e_{jk}}</script> with corresponding gating weights <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-378-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>w</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mn>1</mn></mrow></msub><mo>,</mo><mo>&amp;#x2026;</mo><mo>,</mo><msub><mi>w</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mi>k</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3063\" style=\"width: 5.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.69em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1004.69em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3064\"><span class=\"msubsup\" id=\"MathJax-Span-3065\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3066\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3067\"><span class=\"mrow\" id=\"MathJax-Span-3068\"><span class=\"mi\" id=\"MathJax-Span-3069\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mn\" id=\"MathJax-Span-3070\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3071\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mo\" id=\"MathJax-Span-3072\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">…</span><span class=\"mo\" id=\"MathJax-Span-3073\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-3074\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3075\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3076\"><span class=\"mrow\" id=\"MathJax-Span-3077\"><span class=\"mi\" id=\"MathJax-Span-3078\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3079\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>w</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mn>1</mn></mrow></msub><mo>,</mo><mo>…</mo><mo>,</mo><msub><mi>w</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mi>k</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-378\">w_{j1}, \\dots, w_{jk}</script>. The forward output is computed as</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-379-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>y</mi><mi>j</mi></msub><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>e</mi><mi>i</mi></msub><mo>&amp;#x2208;</mo><msub><mi>S</mi><mi>j</mi></msub></mrow></munder><msub><mi>w</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mi>i</mi></mrow></msub><msub><mi>f</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>e</mi><mi>i</mi></msub></mrow></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3080\" style=\"width: 8.44em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.034em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1006.98em, 3.805em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3081\"><span class=\"msubsup\" id=\"MathJax-Span-3082\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3083\" style=\"font-family: STIXGeneral-Italic;\">y</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-3084\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3085\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3086\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.107em;\"><span class=\"mo\" id=\"MathJax-Span-3087\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.51em, 4.482em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-3088\"><span class=\"mrow\" id=\"MathJax-Span-3089\"><span class=\"msubsup\" id=\"MathJax-Span-3090\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3091\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"mi\" id=\"MathJax-Span-3092\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3093\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3094\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3095\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3096\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3097\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3098\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3099\"><span class=\"mrow\" id=\"MathJax-Span-3100\"><span class=\"mi\" id=\"MathJax-Span-3101\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3102\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3103\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3104\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3105\"><span class=\"mrow\" id=\"MathJax-Span-3106\"><span class=\"msubsup\" id=\"MathJax-Span-3107\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3108\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"mi\" id=\"MathJax-Span-3109\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3110\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-3111\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3112\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-3113\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3114\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.809em; border-left: 0px solid; width: 0px; height: 3.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>y</mi><mi>j</mi></msub><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>e</mi><mi>i</mi></msub><mo>∈</mo><msub><mi>S</mi><mi>j</mi></msub></mrow></munder><msub><mi>w</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mi>i</mi></mrow></msub><msub><mi>f</mi><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>e</mi><mi>i</mi></msub></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>\n    <p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-380-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>e</mi><mi>i</mi></msub></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3115\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3116\"><span class=\"msubsup\" id=\"MathJax-Span-3117\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3118\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3119\"><span class=\"mrow\" id=\"MathJax-Span-3120\"><span class=\"msubsup\" id=\"MathJax-Span-3121\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3122\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"mi\" id=\"MathJax-Span-3123\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>e</mi><mi>i</mi></msub></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-380\">f_{e_i}</script> is the expert network’s transformation (typically a two-layer MLP with activation).</p>\n  </li>\n  <li>\n    <p>This dynamic routing implies an <strong>all-to-all communication pattern</strong> between devices: tokens assigned to experts on remote devices must be sent there, processed, and returned. The design challenge in EP is therefore to minimize communication overhead and maintain load balance so that each device receives a roughly equal number of tokens.</p>\n  </li>\n</ul>\n<p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-380-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>e</mi><mi>i</mi></msub></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3115\" style=\"width: 1.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.84em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3116\"><span class=\"msubsup\" id=\"MathJax-Span-3117\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3118\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3119\"><span class=\"mrow\" id=\"MathJax-Span-3120\"><span class=\"msubsup\" id=\"MathJax-Span-3121\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3122\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"mi\" id=\"MathJax-Span-3123\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.253em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>e</mi><mi>i</mi></msub></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-380\">f_{e_i}</script> is the expert network’s transformation (typically a two-layer MLP with activation).</p>\n<p>This dynamic routing implies an <strong>all-to-all communication pattern</strong> between devices: tokens assigned to experts on remote devices must be sent there, processed, and returned. The design challenge in EP is therefore to minimize communication overhead and maintain load balance so that each device receives a roughly equal number of tokens.</p>\n<h4 id=\"communication-flow\">Communication Flow</h4>\n<ul>\n  <li>The canonical all-to-all routing pipeline follows these steps (as used in systems like <a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al. (2020), <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), and <a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed-MoE</a>):</li>\n</ul>\n<ol>\n  <li><strong>Token grouping:</strong> For each token, the gate determines its top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-381-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3124\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3125\"><span class=\"mi\" id=\"MathJax-Span-3126\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-381\">k</script> experts. Tokens are grouped by destination expert.</li>\n  <li><strong>All-to-all dispatch:</strong> Each device sends token embeddings to the devices hosting the relevant experts. This step dominates communication cost.</li>\n  <li><strong>Local expert computation:</strong> Each device executes its local experts on the received tokens, producing expert outputs.</li>\n  <li><strong>All-to-all gather:</strong> Expert outputs are sent back to the originating devices.</li>\n  <li><strong>Combination:</strong> Each token’s outputs are recombined (weighted by its gating weights <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-382-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>w</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mi>i</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3127\" style=\"width: 1.409em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1001.15em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3128\"><span class=\"msubsup\" id=\"MathJax-Span-3129\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3130\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3131\"><span class=\"mrow\" id=\"MathJax-Span-3132\"><span class=\"mi\" id=\"MathJax-Span-3133\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3134\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>w</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mi>i</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-382\">w_{ji}</script>) to produce the final MoE layer output.</li>\n</ol>\n<ul>\n  <li>In modern frameworks, both dispatch and gather operations are implemented using highly optimized collective primitives such as NCCL all-to-all or fused CUDA kernels. The cost is largely proportional to <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-383-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>B</mi><mo>&amp;#x00D7;</mo><mi>H</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>D</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3135\" style=\"width: 5.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.951em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1004.9em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3136\"><span class=\"mi\" id=\"MathJax-Span-3137\" style=\"font-family: STIXGeneral-Italic;\">O</span><span class=\"mo\" id=\"MathJax-Span-3138\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3139\" style=\"font-family: STIXGeneral-Italic;\">B</span><span class=\"mo\" id=\"MathJax-Span-3140\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mi\" id=\"MathJax-Span-3141\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">H<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"texatom\" id=\"MathJax-Span-3142\"><span class=\"mrow\" id=\"MathJax-Span-3143\"><span class=\"mo\" id=\"MathJax-Span-3144\" style=\"font-family: STIXGeneral-Regular;\">/</span></span></span><span class=\"mi\" id=\"MathJax-Span-3145\" style=\"font-family: STIXGeneral-Italic;\">D</span><span class=\"mo\" id=\"MathJax-Span-3146\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>O</mi><mo stretchy=\"false\">(</mo><mi>B</mi><mo>×</mo><mi>H</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo>/</mo></mrow><mi>D</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-383\">O(B \\times H / D)</script> where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-384-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>B</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3147\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3148\"><span class=\"mi\" id=\"MathJax-Span-3149\" style=\"font-family: STIXGeneral-Italic;\">B</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>B</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-384\">B</script> is batch size and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-385-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>H</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3150\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3151\"><span class=\"mi\" id=\"MathJax-Span-3152\" style=\"font-family: STIXGeneral-Italic;\">H<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>H</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-385\">H</script> hidden dimension, assuming uniform routing.</li>\n</ul>\n<h4 id=\"load-balancing-across-experts\">Load Balancing Across Experts</h4>\n<ul>\n  <li>\n    <p>Because routing is probabilistic, some experts may receive more tokens than others. Uneven token-to-expert assignment creates two performance issues:</p>\n\n    <ol>\n      <li><strong>Underutilization:</strong> Idle GPUs waste compute capacity when few tokens are routed to their experts.</li>\n      <li><strong>Stragglers:</strong> Overloaded experts increase step time, since synchronization waits for all devices to finish processing.</li>\n    </ol>\n  </li>\n  <li>\n    <p>To mitigate this, MoE systems introduce an <em>auxiliary load-balancing loss</em>—for instance the formulation from <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>:</p>\n  </li>\n</ul>\n<p>Because routing is probabilistic, some experts may receive more tokens than others. Uneven token-to-expert assignment creates two performance issues:</p>\n<ol>\n      <li><strong>Underutilization:</strong> Idle GPUs waste compute capacity when few tokens are routed to their experts.</li>\n      <li><strong>Stragglers:</strong> Overloaded experts increase step time, since synchronization waits for all devices to finish processing.</li>\n    </ol>\n<p>To mitigate this, MoE systems introduce an <em>auxiliary load-balancing loss</em>—for instance the formulation from <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>:</p>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-386-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>balance</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03BB;</mi><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>E</mi></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3153\" style=\"width: 10.211em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.492em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.263em, 1008.49em, 3.596em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3154\"><span class=\"msubsup\" id=\"MathJax-Span-3155\"><span style=\"display: inline-block; position: relative; width: 2.815em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3156\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3157\"><span class=\"mrow\" id=\"MathJax-Span-3158\"><span class=\"mtext\" id=\"MathJax-Span-3159\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">balance</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3160\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-3161\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">λ</span><span class=\"mi\" id=\"MathJax-Span-3162\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-3163\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3164\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -2.862em; left: 0.107em;\"><span class=\"texatom\" id=\"MathJax-Span-3165\"><span class=\"mrow\" id=\"MathJax-Span-3166\"><span class=\"mi\" id=\"MathJax-Span-3167\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3168\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3169\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.284em, 1000.47em, 4.169em, -999.997em); top: -5.206em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-3170\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3171\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3172\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-3173\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3174\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3175\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3176\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.559em; border-left: 0px solid; width: 0px; height: 3.753em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>balance</mtext></mrow></msub><mo>=</mo><mi>λ</mi><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>E</mi></munderover><msub><mi>f</mi><mi>i</mi></msub><msub><mi>P</mi><mi>i</mi></msub></math></span></span></div>\n<ul>\n  <li>\n    <p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-387-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3177\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3178\"><span class=\"msubsup\" id=\"MathJax-Span-3179\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3180\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-3181\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-387\">f_i</script> is the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-388-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3182\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3183\"><span class=\"mi\" id=\"MathJax-Span-3184\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-388\">i</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-389-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3185\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3186\"><span class=\"msubsup\" id=\"MathJax-Span-3187\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3188\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3189\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-389\">P_i</script> is the average routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-390-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3190\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3191\"><span class=\"mi\" id=\"MathJax-Span-3192\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-390\">i</script>, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-391-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3193\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3194\"><span class=\"mi\" id=\"MathJax-Span-3195\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-391\">\\lambda</script> is a weighting coefficient. Minimizing this term encourages uniform token distribution, preventing collapse of routing onto a few experts. (Also discussed in <a href=\"https://arxiv.org/abs/2208.02813\">Towards Understanding Mixture of Experts in Deep Learning</a> by Chen et al. (2022).)</p>\n  </li>\n  <li>\n    <p>Another complementary approach is <strong>Expert Choice Routing</strong> (<a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture of Experts with Expert Choice Routing</a> by Zhou et al. (2022)), which inverts the routing direction: each expert selects which tokens to process based on its capacity and affinity, improving balance and locality. A detailed discourse on capacity factor is available in the <a href=\"#expert-choice-routing\">Expert Choice Routing</a> section.</p>\n  </li>\n</ul>\n<p>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-387-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3177\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3178\"><span class=\"msubsup\" id=\"MathJax-Span-3179\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3180\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-3181\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-387\">f_i</script> is the fraction of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-388-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3182\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3183\"><span class=\"mi\" id=\"MathJax-Span-3184\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-388\">i</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-389-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3185\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3186\"><span class=\"msubsup\" id=\"MathJax-Span-3187\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3188\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3189\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-389\">P_i</script> is the average routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-390-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3190\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3191\"><span class=\"mi\" id=\"MathJax-Span-3192\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-390\">i</script>, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-391-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BB;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3193\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.47em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3194\"><span class=\"mi\" id=\"MathJax-Span-3195\" style=\"font-family: STIXGeneral-Italic;\">λ</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>λ</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-391\">\\lambda</script> is a weighting coefficient. Minimizing this term encourages uniform token distribution, preventing collapse of routing onto a few experts. (Also discussed in <a href=\"https://arxiv.org/abs/2208.02813\">Towards Understanding Mixture of Experts in Deep Learning</a> by Chen et al. (2022).)</p>\n<p>Another complementary approach is <strong>Expert Choice Routing</strong> (<a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Mixture of Experts with Expert Choice Routing</a> by Zhou et al. (2022)), which inverts the routing direction: each expert selects which tokens to process based on its capacity and affinity, improving balance and locality. A detailed discourse on capacity factor is available in the <a href=\"#expert-choice-routing\">Expert Choice Routing</a> section.</p>\n<h4 id=\"communicationcomputation-trade-off\">Communication–computation Trade-off</h4>\n<ul>\n  <li>The performance of EP is determined by the ratio of communication time <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-392-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>comm</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3196\" style=\"width: 2.607em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.461em, 1002.14em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3197\"><span class=\"msubsup\" id=\"MathJax-Span-3198\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3199\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3200\"><span class=\"mrow\" id=\"MathJax-Span-3201\"><span class=\"mtext\" id=\"MathJax-Span-3202\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">comm</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>comm</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-392\">t_{\\text{comm}}</script> to computation time <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-393-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>comp</mtext></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3203\" style=\"width: 2.346em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.461em, 1001.93em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3204\"><span class=\"msubsup\" id=\"MathJax-Span-3205\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3206\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3207\"><span class=\"mrow\" id=\"MathJax-Span-3208\"><span class=\"mtext\" id=\"MathJax-Span-3209\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">comp</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>comp</mtext></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-393\">t_{\\text{comp}}</script>. Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-394-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3210\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3211\"><span class=\"mi\" id=\"MathJax-Span-3212\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-394\">T</script> denote the total number of tokens per batch, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-395-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3213\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3214\"><span class=\"mi\" id=\"MathJax-Span-3215\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-395\">k</script> the number of selected experts per token, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-396-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3216\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3217\"><span class=\"mi\" id=\"MathJax-Span-3218\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-396\">E</script> the number of experts, and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-397-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>D</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3219\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.73em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3220\"><span class=\"mi\" id=\"MathJax-Span-3221\" style=\"font-family: STIXGeneral-Italic;\">D</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>D</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-397\">D</script> the number of devices. A simplified cost model can be written as</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-398-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>total</mtext></mrow></msub><mo>&amp;#x2248;</mo><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>comp</mtext></mrow></msub><mo>+</mo><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>comm</mtext></mrow></msub></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3222\" style=\"width: 9.586em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.971em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.461em, 1007.97em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3223\"><span class=\"msubsup\" id=\"MathJax-Span-3224\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3225\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3226\"><span class=\"mrow\" id=\"MathJax-Span-3227\"><span class=\"mtext\" id=\"MathJax-Span-3228\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">total</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3229\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"msubsup\" id=\"MathJax-Span-3230\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3231\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3232\"><span class=\"mrow\" id=\"MathJax-Span-3233\"><span class=\"mtext\" id=\"MathJax-Span-3234\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">comp</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3235\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3236\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3237\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3238\"><span class=\"mrow\" id=\"MathJax-Span-3239\"><span class=\"mtext\" id=\"MathJax-Span-3240\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">comm</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>total</mtext></mrow></msub><mo>≈</mo><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>comp</mtext></mrow></msub><mo>+</mo><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>comm</mtext></mrow></msub></math></span></span></div>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-399-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>comm</mtext></mrow></msub><mo>&amp;#x221D;</mo><mfrac><mrow><mi>B</mi><mo>&amp;#x22C5;</mo><mi>k</mi><mo>&amp;#x22C5;</mo><mi>H</mi></mrow><mrow><mi>D</mi><mo>&amp;#x22C5;</mo><mtext>BW</mtext></mrow></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3241\" style=\"width: 8.544em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.086em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.732em, 1007.09em, 3.076em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3242\"><span class=\"msubsup\" id=\"MathJax-Span-3243\"><span style=\"display: inline-block; position: relative; width: 2.138em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3244\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3245\"><span class=\"mrow\" id=\"MathJax-Span-3246\"><span class=\"mtext\" id=\"MathJax-Span-3247\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">comm</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3248\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∝</span><span class=\"mfrac\" id=\"MathJax-Span-3249\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 3.596em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1003.49em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -1.716em;\"><span class=\"mrow\" id=\"MathJax-Span-3250\"><span class=\"mi\" id=\"MathJax-Span-3251\" style=\"font-family: STIXGeneral-Italic;\">B</span><span class=\"mo\" id=\"MathJax-Span-3252\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3253\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3254\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3255\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">H<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1003.13em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -1.56em;\"><span class=\"mrow\" id=\"MathJax-Span-3256\"><span class=\"mi\" id=\"MathJax-Span-3257\" style=\"font-family: STIXGeneral-Italic;\">D</span><span class=\"mo\" id=\"MathJax-Span-3258\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mtext\" id=\"MathJax-Span-3259\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">BW</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1003.6em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 3.596em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>comm</mtext></mrow></msub><mo>∝</mo><mfrac><mrow><mi>B</mi><mo>⋅</mo><mi>k</mi><mo>⋅</mo><mi>H</mi></mrow><mrow><mi>D</mi><mo>⋅</mo><mtext>BW</mtext></mrow></mfrac></math></span></span></div>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-400-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>t</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>comp</mtext></mrow></msub><mo>&amp;#x221D;</mo><mfrac><mrow><mi>B</mi><mo>&amp;#x22C5;</mo><mi>k</mi><mo>&amp;#x22C5;</mo><msup><mi>H</mi><mn>2</mn></msup></mrow><mrow><mi>D</mi><mo>&amp;#x22C5;</mo><mtext>TFLOPs</mtext></mrow></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3260\" style=\"width: 10.107em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.388em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.576em, 1008.39em, 3.076em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3261\"><span class=\"msubsup\" id=\"MathJax-Span-3262\"><span style=\"display: inline-block; position: relative; width: 1.93em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.336em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3263\" style=\"font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3264\"><span class=\"mrow\" id=\"MathJax-Span-3265\"><span class=\"mtext\" id=\"MathJax-Span-3266\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">comp</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3267\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∝</span><span class=\"mfrac\" id=\"MathJax-Span-3268\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 5.107em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.023em, 1003.96em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -1.977em;\"><span class=\"mrow\" id=\"MathJax-Span-3269\"><span class=\"mi\" id=\"MathJax-Span-3270\" style=\"font-family: STIXGeneral-Italic;\">B</span><span class=\"mo\" id=\"MathJax-Span-3271\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3272\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3273\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3274\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.78em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3275\" style=\"font-family: STIXGeneral-Italic;\">H<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.836em;\"><span class=\"mn\" id=\"MathJax-Span-3276\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1004.95em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -2.497em;\"><span class=\"mrow\" id=\"MathJax-Span-3277\"><span class=\"mi\" id=\"MathJax-Span-3278\" style=\"font-family: STIXGeneral-Italic;\">D</span><span class=\"mo\" id=\"MathJax-Span-3279\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mtext\" id=\"MathJax-Span-3280\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">TFLOPs</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1005.11em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 5.107em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>t</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>comp</mtext></mrow></msub><mo>∝</mo><mfrac><mrow><mi>B</mi><mo>⋅</mo><mi>k</mi><mo>⋅</mo><msup><mi>H</mi><mn>2</mn></msup></mrow><mrow><mi>D</mi><mo>⋅</mo><mtext>TFLOPs</mtext></mrow></mfrac></math></span></span></div>\n<ul>\n  <li>\n    <p>where BW is interconnect bandwidth and TFLOPs the compute throughput per device. Efficient systems therefore aim to (i) minimize <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-401-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3281\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3282\"><span class=\"mi\" id=\"MathJax-Span-3283\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-401\">k</script>, (ii) overlap communication with compute, and (iii) route tokens so that most stay local (intra-node routing).</p>\n  </li>\n  <li>\n    <p>State-of-the-art frameworks such as <a href=\"https://arxiv.org/abs/2211.15841\">Megablocks</a> by Gale et al. (2022) and <a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed-MoE</a> adopt block-sparse layouts and fused all-to-all operations to reach near-linear scaling up to hundreds of GPUs.</p>\n  </li>\n</ul>\n<p>where BW is interconnect bandwidth and TFLOPs the compute throughput per device. Efficient systems therefore aim to (i) minimize <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-401-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3281\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3282\"><span class=\"mi\" id=\"MathJax-Span-3283\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-401\">k</script>, (ii) overlap communication with compute, and (iii) route tokens so that most stay local (intra-node routing).</p>\n<p>State-of-the-art frameworks such as <a href=\"https://arxiv.org/abs/2211.15841\">Megablocks</a> by Gale et al. (2022) and <a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed-MoE</a> adopt block-sparse layouts and fused all-to-all operations to reach near-linear scaling up to hundreds of GPUs.</p>\n<h4 id=\"hybrid-parallel-strategies\">Hybrid Parallel Strategies</h4>\n<ul>\n  <li>\n    <p>Because EP only distributes MoE layers, production-grade systems often combine it with other parallelism types:</p>\n\n    <ul>\n      <li><strong>Data + EP:</strong> Each data-parallel replica holds a different subset of experts, reducing memory cost per GPU while maintaining large global batch size.</li>\n      <li><strong>Tensor + EP:</strong> Inside each expert, weight matrices may still be tensor-parallelized to fit very large hidden dimensions (e.g., in <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2021)).</li>\n      <li><strong>Pipeline + EP:</strong> Different layers are placed in pipeline stages while MoE experts are spread within each stage (see <a href=\"https://arxiv.org/abs/2203.12533\">Pathways</a> by Barham et al. (2022)).</li>\n    </ul>\n  </li>\n  <li>\n    <p>These hybrid designs achieve efficient scaling across thousands of accelerators. For instance, Google’s Pathways system demonstrated scaling of MoE models to trillions of parameters using combinations of data, tensor, and EP.</p>\n  </li>\n</ul>\n<p>Because EP only distributes MoE layers, production-grade systems often combine it with other parallelism types:</p>\n<ul>\n      <li><strong>Data + EP:</strong> Each data-parallel replica holds a different subset of experts, reducing memory cost per GPU while maintaining large global batch size.</li>\n      <li><strong>Tensor + EP:</strong> Inside each expert, weight matrices may still be tensor-parallelized to fit very large hidden dimensions (e.g., in <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a> by Du et al. (2021)).</li>\n      <li><strong>Pipeline + EP:</strong> Different layers are placed in pipeline stages while MoE experts are spread within each stage (see <a href=\"https://arxiv.org/abs/2203.12533\">Pathways</a> by Barham et al. (2022)).</li>\n    </ul>\n<p>These hybrid designs achieve efficient scaling across thousands of accelerators. For instance, Google’s Pathways system demonstrated scaling of MoE models to trillions of parameters using combinations of data, tensor, and EP.</p>",
    "contentMarkdown": "*   EP provides an elegant mechanism to map sparsely activated experts onto distributed hardware while preserving high model capacity. It relies on efficient all-to-all communication and balanced routing to ensure scalability. Modern frameworks optimize these aspects through load-balancing losses, fused collectives, and hybrid parallel designs.\n\n#### Conceptual Overview\n\n*   EP works by _partitioning experts across multiple devices_ and dynamically routing token representations to the appropriate devices that host the selected experts. Each expert is a self-contained sub-network—typically a feed-forward block within a Transformer layer. During a forward pass, each input token is assigned to one or more experts according to the routing probabilities produced by the gating network (often a softmax-normalized linear projection of the token embeddings).\n    \n*   Formally, let EEE denote the total number of experts and DDD the number of available devices. We define a device-to-expert mapping function\n    \n\nEP works by _partitioning experts across multiple devices_ and dynamically routing token representations to the appropriate devices that host the selected experts. Each expert is a self-contained sub-network—typically a feed-forward block within a Transformer layer. During a forward pass, each input token is assigned to one or more experts according to the routing probabilities produced by the gating network (often a softmax-normalized linear projection of the token embeddings).\n\nFormally, let EEE denote the total number of experts and DDD the number of available devices. We define a device-to-expert mapping function\n\nϕ:1,2,…,E→1,2,…,Dϕ:1,2,…,E→1,2,…,D\n\n*   such that expert eieie\\_i resides on device ϕ(i)ϕ(i)\\\\phi(i). Each token xjxjx\\_j is routed to a subset of experts Sj\\=ej1,…,ejkSj\\=ej1,…,ejkS\\_j = {e\\_{j1}, \\\\dots, e\\_{jk}} with corresponding gating weights wj1,…,wjkwj1,…,wjkw\\_{j1}, \\\\dots, w\\_{jk}. The forward output is computed as\n\nyj\\=∑ei∈Sjwjifei(xj)yj\\=∑ei∈Sjwjifei(xj)\n\n*   where feifeif\\_{e\\_i} is the expert network’s transformation (typically a two-layer MLP with activation).\n    \n*   This dynamic routing implies an **all-to-all communication pattern** between devices: tokens assigned to experts on remote devices must be sent there, processed, and returned. The design challenge in EP is therefore to minimize communication overhead and maintain load balance so that each device receives a roughly equal number of tokens.\n    \n\nwhere feifeif\\_{e\\_i} is the expert network’s transformation (typically a two-layer MLP with activation).\n\nThis dynamic routing implies an **all-to-all communication pattern** between devices: tokens assigned to experts on remote devices must be sent there, processed, and returned. The design challenge in EP is therefore to minimize communication overhead and maintain load balance so that each device receives a roughly equal number of tokens.\n\n#### Communication Flow\n\n*   The canonical all-to-all routing pipeline follows these steps (as used in systems like [GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al. (2020), [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), and [DeepSpeed-MoE](https://www.deepspeed.ai/tutorials/mixture-of-experts/)):\n\n1.  **Token grouping:** For each token, the gate determines its top-kkk experts. Tokens are grouped by destination expert.\n2.  **All-to-all dispatch:** Each device sends token embeddings to the devices hosting the relevant experts. This step dominates communication cost.\n3.  **Local expert computation:** Each device executes its local experts on the received tokens, producing expert outputs.\n4.  **All-to-all gather:** Expert outputs are sent back to the originating devices.\n5.  **Combination:** Each token’s outputs are recombined (weighted by its gating weights wjiwjiw\\_{ji}) to produce the final MoE layer output.\n\n*   In modern frameworks, both dispatch and gather operations are implemented using highly optimized collective primitives such as NCCL all-to-all or fused CUDA kernels. The cost is largely proportional to O(B×H/D)O(B×H/D)O(B \\\\times H / D) where BBB is batch size and HHH hidden dimension, assuming uniform routing.\n\n#### Load Balancing Across Experts\n\n*   Because routing is probabilistic, some experts may receive more tokens than others. Uneven token-to-expert assignment creates two performance issues:\n    \n    1.  **Underutilization:** Idle GPUs waste compute capacity when few tokens are routed to their experts.\n    2.  **Stragglers:** Overloaded experts increase step time, since synchronization waits for all devices to finish processing.\n*   To mitigate this, MoE systems introduce an _auxiliary load-balancing loss_—for instance the formulation from [Switch Transformer](https://arxiv.org/abs/2101.03961):\n    \n\nBecause routing is probabilistic, some experts may receive more tokens than others. Uneven token-to-expert assignment creates two performance issues:\n\n1.  **Underutilization:** Idle GPUs waste compute capacity when few tokens are routed to their experts.\n2.  **Stragglers:** Overloaded experts increase step time, since synchronization waits for all devices to finish processing.\n\nTo mitigate this, MoE systems introduce an _auxiliary load-balancing loss_—for instance the formulation from [Switch Transformer](https://arxiv.org/abs/2101.03961):\n\nLbalance\\=λN∑i\\=1EfiPiLbalance\\=λN∑i\\=1EfiPi\n\n*   where fifif\\_i is the fraction of tokens routed to expert iii, PiPiP\\_i is the average routing probability for expert iii, and λλ\\\\lambda is a weighting coefficient. Minimizing this term encourages uniform token distribution, preventing collapse of routing onto a few experts. (Also discussed in [Towards Understanding Mixture of Experts in Deep Learning](https://arxiv.org/abs/2208.02813) by Chen et al. (2022).)\n    \n*   Another complementary approach is **Expert Choice Routing** ([Mixture of Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022)), which inverts the routing direction: each expert selects which tokens to process based on its capacity and affinity, improving balance and locality. A detailed discourse on capacity factor is available in the [Expert Choice Routing](#expert-choice-routing) section.\n    \n\nwhere fifif\\_i is the fraction of tokens routed to expert iii, PiPiP\\_i is the average routing probability for expert iii, and λλ\\\\lambda is a weighting coefficient. Minimizing this term encourages uniform token distribution, preventing collapse of routing onto a few experts. (Also discussed in [Towards Understanding Mixture of Experts in Deep Learning](https://arxiv.org/abs/2208.02813) by Chen et al. (2022).)\n\nAnother complementary approach is **Expert Choice Routing** ([Mixture of Experts with Expert Choice Routing](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf) by Zhou et al. (2022)), which inverts the routing direction: each expert selects which tokens to process based on its capacity and affinity, improving balance and locality. A detailed discourse on capacity factor is available in the [Expert Choice Routing](#expert-choice-routing) section.\n\n#### Communication–computation Trade-off\n\n*   The performance of EP is determined by the ratio of communication time tcommtcommt\\_{\\\\text{comm}} to computation time tcomptcompt\\_{\\\\text{comp}}. Let TTT denote the total number of tokens per batch, kkk the number of selected experts per token, EEE the number of experts, and DDD the number of devices. A simplified cost model can be written as\n\nttotal≈tcomp+tcommttotal≈tcomp+tcomm\n\ntcomm∝B⋅k⋅HD⋅BWtcomm∝B⋅k⋅HD⋅BW\n\ntcomp∝B⋅k⋅H2D⋅TFLOPstcomp∝B⋅k⋅H2D⋅TFLOPs\n\n*   where BW is interconnect bandwidth and TFLOPs the compute throughput per device. Efficient systems therefore aim to (i) minimize kkk, (ii) overlap communication with compute, and (iii) route tokens so that most stay local (intra-node routing).\n    \n*   State-of-the-art frameworks such as [Megablocks](https://arxiv.org/abs/2211.15841) by Gale et al. (2022) and [DeepSpeed-MoE](https://www.deepspeed.ai/tutorials/mixture-of-experts/) adopt block-sparse layouts and fused all-to-all operations to reach near-linear scaling up to hundreds of GPUs.\n    \n\nwhere BW is interconnect bandwidth and TFLOPs the compute throughput per device. Efficient systems therefore aim to (i) minimize kkk, (ii) overlap communication with compute, and (iii) route tokens so that most stay local (intra-node routing).\n\nState-of-the-art frameworks such as [Megablocks](https://arxiv.org/abs/2211.15841) by Gale et al. (2022) and [DeepSpeed-MoE](https://www.deepspeed.ai/tutorials/mixture-of-experts/) adopt block-sparse layouts and fused all-to-all operations to reach near-linear scaling up to hundreds of GPUs.\n\n#### Hybrid Parallel Strategies\n\n*   Because EP only distributes MoE layers, production-grade systems often combine it with other parallelism types:\n    \n    *   **Data + EP:** Each data-parallel replica holds a different subset of experts, reducing memory cost per GPU while maintaining large global batch size.\n    *   **Tensor + EP:** Inside each expert, weight matrices may still be tensor-parallelized to fit very large hidden dimensions (e.g., in [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2021)).\n    *   **Pipeline + EP:** Different layers are placed in pipeline stages while MoE experts are spread within each stage (see [Pathways](https://arxiv.org/abs/2203.12533) by Barham et al. (2022)).\n*   These hybrid designs achieve efficient scaling across thousands of accelerators. For instance, Google’s Pathways system demonstrated scaling of MoE models to trillions of parameters using combinations of data, tensor, and EP.\n    \n\nBecause EP only distributes MoE layers, production-grade systems often combine it with other parallelism types:\n\n*   **Data + EP:** Each data-parallel replica holds a different subset of experts, reducing memory cost per GPU while maintaining large global batch size.\n*   **Tensor + EP:** Inside each expert, weight matrices may still be tensor-parallelized to fit very large hidden dimensions (e.g., in [GLaM](https://arxiv.org/abs/2112.06905) by Du et al. (2021)).\n*   **Pipeline + EP:** Different layers are placed in pipeline stages while MoE experts are spread within each stage (see [Pathways](https://arxiv.org/abs/2203.12533) by Barham et al. (2022)).\n\nThese hybrid designs achieve efficient scaling across thousands of accelerators. For instance, Google’s Pathways system demonstrated scaling of MoE models to trillions of parameters using combinations of data, tensor, and EP.",
    "contentLength": 104328,
    "wordCount": 1372,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#device-partitioning,-token-routing,-and-communication-mechanics"
  },
  {
    "id": "ai-mixture-of-experts-capacity-management-and-adaptive-token-to-expert-a-61",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Expert Parallelism",
    "title": "Capacity Management and Adaptive Token-to-Expert Assignment",
    "order": 61,
    "orderInChapter": 4,
    "contentHtml": "<h4 id=\"motivation-2\">Motivation</h4>\n<ul>\n  <li>\n    <p>In expert-parallel architectures, each expert has a <em>finite processing capacity</em> per forward pass—determined by GPU memory, batch size, and routing limits. When the gate assigns too many tokens to a single expert, that expert’s device may run out of memory or cause latency spikes due to queue imbalance. Therefore, MoE systems impose an explicit <em>capacity constraint</em> on each expert, which regulates the number of tokens it can process per batch.</p>\n  </li>\n  <li>\n    <p>Capacity management is a crucial aspect of EP, ensuring that per-device workloads remain balanced and memory-safe. Adaptive gating, dynamic capacity scaling, and fused dispatch kernels collectively stabilize large-scale MoE training. These optimizations make trillion-parameter MoE models—such as <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a>, <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, and <a href=\"https://arxiv.org/abs/2203.12533\">Pathways</a>—feasible on practical clusters.</p>\n  </li>\n  <li>\n    <p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-402-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3284\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3285\"><span class=\"mi\" id=\"MathJax-Span-3286\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-402\">C</script> denote the maximum number of tokens an expert can handle in one pass. If the total number of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-403-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>e</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3287\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.73em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3288\"><span class=\"msubsup\" id=\"MathJax-Span-3289\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3290\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-3291\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>e</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-403\">e_i</script> is <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-404-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3292\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.71em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3293\"><span class=\"msubsup\" id=\"MathJax-Span-3294\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3295\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3296\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3297\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-3298\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-404\">T_i > C</script>, the system must either drop or reassign the overflow tokens.</p>\n  </li>\n  <li>\n    <p>This issue was first highlighted in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), which introduced the <em>“expert capacity factor”</em> to control token routing loads and ensure training stability.</p>\n  </li>\n</ul>\n<p>In expert-parallel architectures, each expert has a <em>finite processing capacity</em> per forward pass—determined by GPU memory, batch size, and routing limits. When the gate assigns too many tokens to a single expert, that expert’s device may run out of memory or cause latency spikes due to queue imbalance. Therefore, MoE systems impose an explicit <em>capacity constraint</em> on each expert, which regulates the number of tokens it can process per batch.</p>\n<p>Capacity management is a crucial aspect of EP, ensuring that per-device workloads remain balanced and memory-safe. Adaptive gating, dynamic capacity scaling, and fused dispatch kernels collectively stabilize large-scale MoE training. These optimizations make trillion-parameter MoE models—such as <a href=\"https://arxiv.org/abs/2112.06905\">GLaM</a>, <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>, and <a href=\"https://arxiv.org/abs/2203.12533\">Pathways</a>—feasible on practical clusters.</p>\n<p>Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-402-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3284\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3285\"><span class=\"mi\" id=\"MathJax-Span-3286\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-402\">C</script> denote the maximum number of tokens an expert can handle in one pass. If the total number of tokens routed to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-403-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>e</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3287\" style=\"width: 0.888em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.73em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3288\"><span class=\"msubsup\" id=\"MathJax-Span-3289\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3290\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-3291\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>e</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-403\">e_i</script> is <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-404-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3292\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.71em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3293\"><span class=\"msubsup\" id=\"MathJax-Span-3294\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3295\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3296\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3297\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-3298\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-404\">T_i > C</script>, the system must either drop or reassign the overflow tokens.</p>\n<p>This issue was first highlighted in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> by Fedus et al. (2021), which introduced the <em>“expert capacity factor”</em> to control token routing loads and ensure training stability.</p>\n<h4 id=\"capacity-factor-and-token-dropping\">Capacity Factor and Token Dropping</h4>\n<ul>\n  <li>Each expert’s capacity is usually computed as:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-405-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>C</mi><mo>=</mo><mi>&amp;#x03B1;</mi><mo>&amp;#x22C5;</mo><mfrac><mrow><mi>T</mi><mo>&amp;#x22C5;</mo><mi>k</mi></mrow><mi>E</mi></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3299\" style=\"width: 6.826em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.732em, 1005.68em, 3.076em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3300\"><span class=\"mi\" id=\"MathJax-Span-3301\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3302\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-3303\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mo\" id=\"MathJax-Span-3304\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mfrac\" id=\"MathJax-Span-3305\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.93em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.935em;\"><span class=\"mrow\" id=\"MathJax-Span-3306\"><span class=\"mi\" id=\"MathJax-Span-3307\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3308\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3309\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -3.331em; left: 50%; margin-left: -0.31em;\"><span class=\"mi\" id=\"MathJax-Span-3310\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1002.03em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 2.034em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.872em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>C</mi><mo>=</mo><mi>α</mi><mo>⋅</mo><mfrac><mrow><mi>T</mi><mo>⋅</mo><mi>k</mi></mrow><mi>E</mi></mfrac></math></span></span></div>\n<ul>\n  <li>\n    <p>where:</p>\n\n    <ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-406-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3311\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3312\"><span class=\"mi\" id=\"MathJax-Span-3313\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-406\">T</script> is the total number of tokens in the batch,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-407-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3314\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3315\"><span class=\"mi\" id=\"MathJax-Span-3316\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-407\">k</script> is the number of experts each token is routed to (typically 1 or 2),</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-408-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3317\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3318\"><span class=\"mi\" id=\"MathJax-Span-3319\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-408\">E</script> is the total number of experts, and</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-409-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3320\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3321\"><span class=\"mi\" id=\"MathJax-Span-3322\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-409\">\\alpha</script> is the <strong>capacity factor</strong> (a scalar &gt; 1 to provide buffer capacity).</li>\n    </ul>\n  </li>\n  <li>\n    <p>If the assigned tokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-410-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3323\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.71em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3324\"><span class=\"msubsup\" id=\"MathJax-Span-3325\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3326\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3327\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3328\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-3329\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-410\">T_i > C</script>, excess tokens are handled by one of several strategies:</p>\n\n    <ol>\n      <li><strong>Dropping:</strong> The overflow tokens are ignored (their gradient is set to zero). This is simple but may slightly degrade accuracy.</li>\n      <li><strong>Random reassignment:</strong> Overflow tokens are redirected to underutilized experts.</li>\n      <li><strong>Padding/truncation:</strong> Tokens beyond capacity are truncated but still contribute partially to load statistics.</li>\n    </ol>\n  </li>\n  <li>\n    <p>For instance, the <a href=\"https://arxiv.org/abs/2112.06905\">GLaM model</a> by Du et al. (2021) used <em>top-2 gating with load balancing</em> and a fixed capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-411-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3330\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3331\"><span class=\"mi\" id=\"MathJax-Span-3332\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-3333\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3334\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-411\">\\alpha = 1.25</script>, ensuring that only ~1% of tokens were dropped at scale.</p>\n  </li>\n  <li>\n    <p>These mechanisms strike a balance between training efficiency, load uniformity, and memory constraints.</p>\n  </li>\n  <li>\n    <p>A detailed discourse on capacity factor is available in the <a href=\"#expert-capacity-and-capacity-factor\">Expert Capacity and Capacity Factor</a> section.</p>\n  </li>\n</ul>\n<p>where:</p>\n<ul>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-406-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>T</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3311\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.68em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3312\"><span class=\"mi\" id=\"MathJax-Span-3313\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>T</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-406\">T</script> is the total number of tokens in the batch,</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-407-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3314\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3315\"><span class=\"mi\" id=\"MathJax-Span-3316\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-407\">k</script> is the number of experts each token is routed to (typically 1 or 2),</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-408-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3317\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3318\"><span class=\"mi\" id=\"MathJax-Span-3319\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-408\">E</script> is the total number of experts, and</li>\n      <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-409-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3320\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3321\"><span class=\"mi\" id=\"MathJax-Span-3322\" style=\"font-family: STIXGeneral-Italic;\">α</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-409\">\\alpha</script> is the <strong>capacity factor</strong> (a scalar &gt; 1 to provide buffer capacity).</li>\n    </ul>\n<p>If the assigned tokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-410-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;gt;</mo><mi>C</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3323\" style=\"width: 3.284em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.711em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.71em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3324\"><span class=\"msubsup\" id=\"MathJax-Span-3325\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3326\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3327\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3328\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mi\" id=\"MathJax-Span-3329\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>T</mi><mi>i</mi></msub><mo>&gt;</mo><mi>C</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-410\">T_i > C</script>, excess tokens are handled by one of several strategies:</p>\n<ol>\n      <li><strong>Dropping:</strong> The overflow tokens are ignored (their gradient is set to zero). This is simple but may slightly degrade accuracy.</li>\n      <li><strong>Random reassignment:</strong> Overflow tokens are redirected to underutilized experts.</li>\n      <li><strong>Padding/truncation:</strong> Tokens beyond capacity are truncated but still contribute partially to load statistics.</li>\n    </ol>\n<p>For instance, the <a href=\"https://arxiv.org/abs/2112.06905\">GLaM model</a> by Du et al. (2021) used <em>top-2 gating with load balancing</em> and a fixed capacity factor <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-411-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3330\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3331\"><span class=\"mi\" id=\"MathJax-Span-3332\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-3333\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3334\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-411\">\\alpha = 1.25</script>, ensuring that only ~1% of tokens were dropped at scale.</p>\n<p>These mechanisms strike a balance between training efficiency, load uniformity, and memory constraints.</p>\n<p>A detailed discourse on capacity factor is available in the <a href=\"#expert-capacity-and-capacity-factor\">Expert Capacity and Capacity Factor</a> section.</p>\n<h4 id=\"dynamic-capacity-adjustment-1\">Dynamic Capacity Adjustment</h4>\n<ul>\n  <li>\n    <p>Recent MoE frameworks implement <strong>adaptive capacity management</strong>, where each expert’s capacity is automatically tuned based on observed routing statistics. For example:</p>\n\n    <ul>\n      <li><a href=\"https://arxiv.org/abs/2106.04426\">BASE Layers</a> by Lewis et al. (2021) introduced a layer-wise balancing mechanism where capacity allocation is proportional to historical token loads.</li>\n      <li><a href=\"https://www.microsoft.com/en-us/research/blog/introducing-tutel-an-efficient-mixture-of-experts-library/\">Tutel</a> (Microsoft Research, 2022) dynamically adjusts expert buffer sizes and uses <em>token sorting</em> to reduce dispatch irregularity.</li>\n      <li><a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed-MoE</a> implements adaptive “capacity-aware all-to-all” communication, skipping empty slots and compressing routing payloads for communication efficiency.</li>\n    </ul>\n  </li>\n  <li>\n    <p>The core idea is that if certain experts consistently receive fewer tokens, their capacity can be reduced to free resources for heavily used experts—improving both compute utilization and memory footprint.</p>\n  </li>\n</ul>\n<p>Recent MoE frameworks implement <strong>adaptive capacity management</strong>, where each expert’s capacity is automatically tuned based on observed routing statistics. For example:</p>\n<ul>\n      <li><a href=\"https://arxiv.org/abs/2106.04426\">BASE Layers</a> by Lewis et al. (2021) introduced a layer-wise balancing mechanism where capacity allocation is proportional to historical token loads.</li>\n      <li><a href=\"https://www.microsoft.com/en-us/research/blog/introducing-tutel-an-efficient-mixture-of-experts-library/\">Tutel</a> (Microsoft Research, 2022) dynamically adjusts expert buffer sizes and uses <em>token sorting</em> to reduce dispatch irregularity.</li>\n      <li><a href=\"https://www.deepspeed.ai/tutorials/mixture-of-experts/\">DeepSpeed-MoE</a> implements adaptive “capacity-aware all-to-all” communication, skipping empty slots and compressing routing payloads for communication efficiency.</li>\n    </ul>\n<p>The core idea is that if certain experts consistently receive fewer tokens, their capacity can be reduced to free resources for heavily used experts—improving both compute utilization and memory footprint.</p>\n<h4 id=\"routing-strategies-and-adaptive-gating\">Routing Strategies and Adaptive Gating</h4>\n<ul>\n  <li>\n    <p>The gate network itself can evolve to improve token assignment. Beyond static top-k routing, advanced strategies include:</p>\n\n    <ol>\n      <li><strong>Noisy Top-k Gating</strong> (<a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al., 2020): Adds Gaussian noise to logits before selecting experts to encourage exploration and load balance.</li>\n      <li><strong>Load-Balanced Routing</strong> (<a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>): Adds auxiliary loss to penalize expert imbalance.</li>\n      <li><strong>Expert Choice Routing</strong> (<a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Zhou et al., 2022</a>): Each expert independently selects a subset of tokens it wants to process, improving locality.</li>\n      <li><strong>Hash-based Routing</strong> (<a href=\"https://arxiv.org/abs/2106.04426\">Hash Layers</a> by Roller et al., 2021): Uses consistent hashing to deterministically map tokens to experts, removing the gate’s learned component for predictability and speed.</li>\n      <li><strong>Soft MoE</strong> (<a href=\"https://arxiv.org/abs/2110.01786\">Soft MoE</a> by Shen et al., 2021): Performs continuous, differentiable routing where all experts contribute but are weighted softly, removing discontinuities in gating gradients.</li>\n    </ol>\n  </li>\n  <li>\n    <p>These routing methods trade off between expressiveness (learned gates) and efficiency (deterministic or sparse routing). Hybrid approaches can even mix them layer-wise in the same model.</p>\n  </li>\n</ul>\n<p>The gate network itself can evolve to improve token assignment. Beyond static top-k routing, advanced strategies include:</p>\n<ol>\n      <li><strong>Noisy Top-k Gating</strong> (<a href=\"https://arxiv.org/abs/2006.16668\">GShard</a> by Lepikhin et al., 2020): Adds Gaussian noise to logits before selecting experts to encourage exploration and load balance.</li>\n      <li><strong>Load-Balanced Routing</strong> (<a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a>): Adds auxiliary loss to penalize expert imbalance.</li>\n      <li><strong>Expert Choice Routing</strong> (<a href=\"https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf\">Zhou et al., 2022</a>): Each expert independently selects a subset of tokens it wants to process, improving locality.</li>\n      <li><strong>Hash-based Routing</strong> (<a href=\"https://arxiv.org/abs/2106.04426\">Hash Layers</a> by Roller et al., 2021): Uses consistent hashing to deterministically map tokens to experts, removing the gate’s learned component for predictability and speed.</li>\n      <li><strong>Soft MoE</strong> (<a href=\"https://arxiv.org/abs/2110.01786\">Soft MoE</a> by Shen et al., 2021): Performs continuous, differentiable routing where all experts contribute but are weighted softly, removing discontinuities in gating gradients.</li>\n    </ol>\n<p>These routing methods trade off between expressiveness (learned gates) and efficiency (deterministic or sparse routing). Hybrid approaches can even mix them layer-wise in the same model.</p>\n<h4 id=\"capacity-overflow-analysis\">Capacity Overflow Analysis</h4>\n<ul>\n  <li>Consider the case of <em>top-1 gating</em>. Let <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-412-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3335\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3336\"><span class=\"msubsup\" id=\"MathJax-Span-3337\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3338\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3339\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-412\">p_i</script> denote the probability that a token is assigned to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-413-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3340\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3341\"><span class=\"mi\" id=\"MathJax-Span-3342\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-413\">i</script>, so <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-414-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><munder><mo>&amp;#x2211;</mo><mi>i</mi></munder><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3343\" style=\"width: 4.69em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.909em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1003.8em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3344\"><span class=\"munderover\" id=\"MathJax-Span-3345\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3346\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3347\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3348\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3349\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3350\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3351\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3352\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-414\">\\sum_i p_i = 1</script>. If routing is stochastic but independent across tokens, the number of tokens assigned to expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-415-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3353\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3354\"><span class=\"mi\" id=\"MathJax-Span-3355\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-415\">i</script> follows a Binomial distribution:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-416-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>T</mi><mi>i</mi></msub><mo>&amp;#x223C;</mo><mtext>Binomial</mtext><mo stretchy=&quot;false&quot;>(</mo><mi>T</mi><mo>,</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3356\" style=\"width: 10.003em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1008.28em, 2.607em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3357\"><span class=\"msubsup\" id=\"MathJax-Span-3358\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3359\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3360\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3361\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∼</span><span class=\"mtext\" id=\"MathJax-Span-3362\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">Binomial</span><span class=\"mo\" id=\"MathJax-Span-3363\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3364\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3365\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"msubsup\" id=\"MathJax-Span-3366\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3367\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3368\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3369\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>T</mi><mi>i</mi></msub><mo>∼</mo><mtext>Binomial</mtext><mo stretchy=\"false\">(</mo><mi>T</mi><mo>,</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>… and the expected number of overflows is:</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-417-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>[</mo><msub><mtext>overflow</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>]</mo><mo>=</mo><mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;>max</mo><mo stretchy=&quot;false&quot;>(</mo><mn>0</mn><mo>,</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>E</mi></mrow><mo stretchy=&quot;false&quot;>[</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x2212;</mo><mi>C</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3370\" style=\"width: 16.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.596em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.513em, 1013.54em, 2.659em, -999.997em); top: -2.341em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3371\"><span class=\"texatom\" id=\"MathJax-Span-3372\"><span class=\"mrow\" id=\"MathJax-Span-3373\"><span class=\"mi\" id=\"MathJax-Span-3374\" style=\"font-family: STIXGeneral-Regular;\">𝔼</span></span></span><span class=\"mo\" id=\"MathJax-Span-3375\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"msubsup\" id=\"MathJax-Span-3376\"><span style=\"display: inline-block; position: relative; width: 3.909em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1003.6em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3377\" style=\"font-family: STIXGeneral-Regular;\">overflow</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 3.596em;\"><span class=\"mi\" id=\"MathJax-Span-3378\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3379\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-3380\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mo\" id=\"MathJax-Span-3381\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">max</span><span class=\"mo\" id=\"MathJax-Span-3382\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mn\" id=\"MathJax-Span-3383\" style=\"font-family: STIXGeneral-Regular;\">0</span><span class=\"mo\" id=\"MathJax-Span-3384\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"texatom\" id=\"MathJax-Span-3385\" style=\"padding-left: 0.211em;\"><span class=\"mrow\" id=\"MathJax-Span-3386\"><span class=\"mi\" id=\"MathJax-Span-3387\" style=\"font-family: STIXGeneral-Regular;\">𝔼</span></span></span><span class=\"mo\" id=\"MathJax-Span-3388\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"msubsup\" id=\"MathJax-Span-3389\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3390\" style=\"font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3391\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3392\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-3393\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mi\" id=\"MathJax-Span-3394\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3395\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.346em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">E</mi></mrow><mo stretchy=\"false\">[</mo><msub><mtext>overflow</mtext><mi>i</mi></msub><mo stretchy=\"false\">]</mo><mo>=</mo><mo movablelimits=\"true\" form=\"prefix\">max</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>,</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi mathvariant=\"double-struck\">E</mi></mrow><mo stretchy=\"false\">[</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy=\"false\">]</mo><mo>−</mo><mi>C</mi><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>\n    <p>Balancing losses attempt to make <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-418-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3396\" style=\"width: 4.013em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.34em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3397\"><span class=\"msubsup\" id=\"MathJax-Span-3398\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3399\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3400\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3401\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mn\" id=\"MathJax-Span-3402\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span><span class=\"texatom\" id=\"MathJax-Span-3403\"><span class=\"mrow\" id=\"MathJax-Span-3404\"><span class=\"mo\" id=\"MathJax-Span-3405\" style=\"font-family: STIXGeneral-Regular;\">/</span></span></span><span class=\"mi\" id=\"MathJax-Span-3406\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo>≈</mo><mn>1</mn><mrow class=\"MJX-TeXAtom-ORD\"><mo>/</mo></mrow><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-418\">p_i \\approx 1/E</script>, thus minimizing expected overflow. In practice, systems choose <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-419-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;#x2208;</mo><mo stretchy=&quot;false&quot;>[</mo><mn>1.0</mn><mo>,</mo><mn>1.5</mn><mo stretchy=&quot;false&quot;>]</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3407\" style=\"width: 6.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1005.37em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3408\"><span class=\"mi\" id=\"MathJax-Span-3409\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-3410\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"mo\" id=\"MathJax-Span-3411\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">[</span><span class=\"mn\" id=\"MathJax-Span-3412\" style=\"font-family: STIXGeneral-Regular;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-3413\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-3414\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.5</span><span class=\"mo\" id=\"MathJax-Span-3415\" style=\"font-family: STIXGeneral-Regular;\">]</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>1.0</mn><mo>,</mo><mn>1.5</mn><mo stretchy=\"false\">]</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-419\">\\alpha \\in [1.0, 1.5]</script> for stable training with minimal drops.</p>\n  </li>\n  <li>\n    <p>Empirical results from <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> showed that for large-scale models with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-420-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi><mo>=</mo><mn>2048</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3416\" style=\"width: 4.586em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.805em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.75em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3417\"><span class=\"mi\" id=\"MathJax-Span-3418\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3419\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3420\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">2048</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi><mo>=</mo><mn>2048</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-420\">E=2048</script> experts, setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-421-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3421\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3422\"><span class=\"mi\" id=\"MathJax-Span-3423\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-3424\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3425\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-421\">\\alpha = 1.25</script> yielded optimal trade-offs between speed and accuracy, allowing &gt;99% tokens to be processed successfully per step.</p>\n  </li>\n</ul>\n<p>Balancing losses attempt to make <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-418-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub><mo>&amp;#x2248;</mo><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>E</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3396\" style=\"width: 4.013em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.34em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3397\"><span class=\"msubsup\" id=\"MathJax-Span-3398\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3399\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3400\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3401\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"mn\" id=\"MathJax-Span-3402\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span><span class=\"texatom\" id=\"MathJax-Span-3403\"><span class=\"mrow\" id=\"MathJax-Span-3404\"><span class=\"mo\" id=\"MathJax-Span-3405\" style=\"font-family: STIXGeneral-Regular;\">/</span></span></span><span class=\"mi\" id=\"MathJax-Span-3406\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub><mo>≈</mo><mn>1</mn><mrow class=\"MJX-TeXAtom-ORD\"><mo>/</mo></mrow><mi>E</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-418\">p_i \\approx 1/E</script>, thus minimizing expected overflow. In practice, systems choose <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-419-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>&amp;#x2208;</mo><mo stretchy=&quot;false&quot;>[</mo><mn>1.0</mn><mo>,</mo><mn>1.5</mn><mo stretchy=&quot;false&quot;>]</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3407\" style=\"width: 6.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.471em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1005.37em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3408\"><span class=\"mi\" id=\"MathJax-Span-3409\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-3410\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">∈</span><span class=\"mo\" id=\"MathJax-Span-3411\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">[</span><span class=\"mn\" id=\"MathJax-Span-3412\" style=\"font-family: STIXGeneral-Regular;\">1.0</span><span class=\"mo\" id=\"MathJax-Span-3413\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mn\" id=\"MathJax-Span-3414\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.211em;\">1.5</span><span class=\"mo\" id=\"MathJax-Span-3415\" style=\"font-family: STIXGeneral-Regular;\">]</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>1.0</mn><mo>,</mo><mn>1.5</mn><mo stretchy=\"false\">]</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-419\">\\alpha \\in [1.0, 1.5]</script> for stable training with minimal drops.</p>\n<p>Empirical results from <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformer</a> showed that for large-scale models with <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-420-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>E</mi><mo>=</mo><mn>2048</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3416\" style=\"width: 4.586em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.805em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.75em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3417\"><span class=\"mi\" id=\"MathJax-Span-3418\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3419\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3420\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">2048</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>E</mi><mo>=</mo><mn>2048</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-420\">E=2048</script> experts, setting <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-421-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>1.25</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3421\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.49em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3422\"><span class=\"mi\" id=\"MathJax-Span-3423\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-3424\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3425\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1.25</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>1.25</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-421\">\\alpha = 1.25</script> yielded optimal trade-offs between speed and accuracy, allowing &gt;99% tokens to be processed successfully per step.</p>\n<h4 id=\"example-capacity-aware-token-routing\">Example: Capacity-aware Token Routing</h4>\n<ul>\n  <li>\n    <p>In modern implementations such as <a href=\"https://docs.nvidia.com/megatron-core/developer-guide/latest/moe.html\">NVIDIA Megatron-Core MoE</a>, the routing kernel incorporates <em>capacity-aware padding</em>. Tokens are packed into contiguous buffers, respecting expert capacity, and an optimized fused kernel performs:</p>\n\n    <ol>\n      <li>Token sorting by expert ID</li>\n      <li>Capacity clipping</li>\n      <li>Memory offset computation</li>\n      <li>Expert batch matmul in fused CUDA kernel</li>\n      <li>Gather back using prefix-sum indices</li>\n    </ol>\n  </li>\n  <li>\n    <p>This design removes Python-level overhead and maintains consistent throughput even under non-uniform routing patterns. Benchmarks show that expert-parallel MoE with fused dispatch achieves near-linear scaling to 512 GPUs.</p>\n  </li>\n</ul>\n<p>In modern implementations such as <a href=\"https://docs.nvidia.com/megatron-core/developer-guide/latest/moe.html\">NVIDIA Megatron-Core MoE</a>, the routing kernel incorporates <em>capacity-aware padding</em>. Tokens are packed into contiguous buffers, respecting expert capacity, and an optimized fused kernel performs:</p>\n<ol>\n      <li>Token sorting by expert ID</li>\n      <li>Capacity clipping</li>\n      <li>Memory offset computation</li>\n      <li>Expert batch matmul in fused CUDA kernel</li>\n      <li>Gather back using prefix-sum indices</li>\n    </ol>\n<p>This design removes Python-level overhead and maintains consistent throughput even under non-uniform routing patterns. Benchmarks show that expert-parallel MoE with fused dispatch achieves near-linear scaling to 512 GPUs.</p>",
    "contentMarkdown": "#### Motivation\n\n*   In expert-parallel architectures, each expert has a _finite processing capacity_ per forward pass—determined by GPU memory, batch size, and routing limits. When the gate assigns too many tokens to a single expert, that expert’s device may run out of memory or cause latency spikes due to queue imbalance. Therefore, MoE systems impose an explicit _capacity constraint_ on each expert, which regulates the number of tokens it can process per batch.\n    \n*   Capacity management is a crucial aspect of EP, ensuring that per-device workloads remain balanced and memory-safe. Adaptive gating, dynamic capacity scaling, and fused dispatch kernels collectively stabilize large-scale MoE training. These optimizations make trillion-parameter MoE models—such as [GLaM](https://arxiv.org/abs/2112.06905), [Switch Transformer](https://arxiv.org/abs/2101.03961), and [Pathways](https://arxiv.org/abs/2203.12533)—feasible on practical clusters.\n    \n*   Let CCC denote the maximum number of tokens an expert can handle in one pass. If the total number of tokens routed to expert eieie\\_i is Ti\\>CTi\\>CT\\_i > C, the system must either drop or reassign the overflow tokens.\n    \n*   This issue was first highlighted in [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), which introduced the _“expert capacity factor”_ to control token routing loads and ensure training stability.\n    \n\nIn expert-parallel architectures, each expert has a _finite processing capacity_ per forward pass—determined by GPU memory, batch size, and routing limits. When the gate assigns too many tokens to a single expert, that expert’s device may run out of memory or cause latency spikes due to queue imbalance. Therefore, MoE systems impose an explicit _capacity constraint_ on each expert, which regulates the number of tokens it can process per batch.\n\nCapacity management is a crucial aspect of EP, ensuring that per-device workloads remain balanced and memory-safe. Adaptive gating, dynamic capacity scaling, and fused dispatch kernels collectively stabilize large-scale MoE training. These optimizations make trillion-parameter MoE models—such as [GLaM](https://arxiv.org/abs/2112.06905), [Switch Transformer](https://arxiv.org/abs/2101.03961), and [Pathways](https://arxiv.org/abs/2203.12533)—feasible on practical clusters.\n\nLet CCC denote the maximum number of tokens an expert can handle in one pass. If the total number of tokens routed to expert eieie\\_i is Ti\\>CTi\\>CT\\_i > C, the system must either drop or reassign the overflow tokens.\n\nThis issue was first highlighted in [Switch Transformer](https://arxiv.org/abs/2101.03961) by Fedus et al. (2021), which introduced the _“expert capacity factor”_ to control token routing loads and ensure training stability.\n\n#### Capacity Factor and Token Dropping\n\n*   Each expert’s capacity is usually computed as:\n\nC\\=α⋅T⋅kEC\\=α⋅T⋅kE\n\n*   where:\n    \n    *   TTT is the total number of tokens in the batch,\n    *   kkk is the number of experts each token is routed to (typically 1 or 2),\n    *   EEE is the total number of experts, and\n    *   αα\\\\alpha is the **capacity factor** (a scalar > 1 to provide buffer capacity).\n*   If the assigned tokens Ti\\>CTi\\>CT\\_i > C, excess tokens are handled by one of several strategies:\n    \n    1.  **Dropping:** The overflow tokens are ignored (their gradient is set to zero). This is simple but may slightly degrade accuracy.\n    2.  **Random reassignment:** Overflow tokens are redirected to underutilized experts.\n    3.  **Padding/truncation:** Tokens beyond capacity are truncated but still contribute partially to load statistics.\n*   For instance, the [GLaM model](https://arxiv.org/abs/2112.06905) by Du et al. (2021) used _top-2 gating with load balancing_ and a fixed capacity factor α\\=1.25α\\=1.25\\\\alpha = 1.25, ensuring that only ~1% of tokens were dropped at scale.\n    \n*   These mechanisms strike a balance between training efficiency, load uniformity, and memory constraints.\n    \n*   A detailed discourse on capacity factor is available in the [Expert Capacity and Capacity Factor](#expert-capacity-and-capacity-factor) section.\n    \n\nwhere:\n\n*   TTT is the total number of tokens in the batch,\n*   kkk is the number of experts each token is routed to (typically 1 or 2),\n*   EEE is the total number of experts, and\n*   αα\\\\alpha is the **capacity factor** (a scalar > 1 to provide buffer capacity).\n\nIf the assigned tokens Ti\\>CTi\\>CT\\_i > C, excess tokens are handled by one of several strategies:\n\n1.  **Dropping:** The overflow tokens are ignored (their gradient is set to zero). This is simple but may slightly degrade accuracy.\n2.  **Random reassignment:** Overflow tokens are redirected to underutilized experts.\n3.  **Padding/truncation:** Tokens beyond capacity are truncated but still contribute partially to load statistics.\n\nFor instance, the [GLaM model](https://arxiv.org/abs/2112.06905) by Du et al. (2021) used _top-2 gating with load balancing_ and a fixed capacity factor α\\=1.25α\\=1.25\\\\alpha = 1.25, ensuring that only ~1% of tokens were dropped at scale.\n\nThese mechanisms strike a balance between training efficiency, load uniformity, and memory constraints.\n\nA detailed discourse on capacity factor is available in the [Expert Capacity and Capacity Factor](#expert-capacity-and-capacity-factor) section.\n\n#### Dynamic Capacity Adjustment\n\n*   Recent MoE frameworks implement **adaptive capacity management**, where each expert’s capacity is automatically tuned based on observed routing statistics. For example:\n    \n    *   [BASE Layers](https://arxiv.org/abs/2106.04426) by Lewis et al. (2021) introduced a layer-wise balancing mechanism where capacity allocation is proportional to historical token loads.\n    *   [Tutel](https://www.microsoft.com/en-us/research/blog/introducing-tutel-an-efficient-mixture-of-experts-library/) (Microsoft Research, 2022) dynamically adjusts expert buffer sizes and uses _token sorting_ to reduce dispatch irregularity.\n    *   [DeepSpeed-MoE](https://www.deepspeed.ai/tutorials/mixture-of-experts/) implements adaptive “capacity-aware all-to-all” communication, skipping empty slots and compressing routing payloads for communication efficiency.\n*   The core idea is that if certain experts consistently receive fewer tokens, their capacity can be reduced to free resources for heavily used experts—improving both compute utilization and memory footprint.\n    \n\nRecent MoE frameworks implement **adaptive capacity management**, where each expert’s capacity is automatically tuned based on observed routing statistics. For example:\n\n*   [BASE Layers](https://arxiv.org/abs/2106.04426) by Lewis et al. (2021) introduced a layer-wise balancing mechanism where capacity allocation is proportional to historical token loads.\n*   [Tutel](https://www.microsoft.com/en-us/research/blog/introducing-tutel-an-efficient-mixture-of-experts-library/) (Microsoft Research, 2022) dynamically adjusts expert buffer sizes and uses _token sorting_ to reduce dispatch irregularity.\n*   [DeepSpeed-MoE](https://www.deepspeed.ai/tutorials/mixture-of-experts/) implements adaptive “capacity-aware all-to-all” communication, skipping empty slots and compressing routing payloads for communication efficiency.\n\nThe core idea is that if certain experts consistently receive fewer tokens, their capacity can be reduced to free resources for heavily used experts—improving both compute utilization and memory footprint.\n\n#### Routing Strategies and Adaptive Gating\n\n*   The gate network itself can evolve to improve token assignment. Beyond static top-k routing, advanced strategies include:\n    \n    1.  **Noisy Top-k Gating** ([GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al., 2020): Adds Gaussian noise to logits before selecting experts to encourage exploration and load balance.\n    2.  **Load-Balanced Routing** ([Switch Transformer](https://arxiv.org/abs/2101.03961)): Adds auxiliary loss to penalize expert imbalance.\n    3.  **Expert Choice Routing** ([Zhou et al., 2022](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf)): Each expert independently selects a subset of tokens it wants to process, improving locality.\n    4.  **Hash-based Routing** ([Hash Layers](https://arxiv.org/abs/2106.04426) by Roller et al., 2021): Uses consistent hashing to deterministically map tokens to experts, removing the gate’s learned component for predictability and speed.\n    5.  **Soft MoE** ([Soft MoE](https://arxiv.org/abs/2110.01786) by Shen et al., 2021): Performs continuous, differentiable routing where all experts contribute but are weighted softly, removing discontinuities in gating gradients.\n*   These routing methods trade off between expressiveness (learned gates) and efficiency (deterministic or sparse routing). Hybrid approaches can even mix them layer-wise in the same model.\n    \n\nThe gate network itself can evolve to improve token assignment. Beyond static top-k routing, advanced strategies include:\n\n1.  **Noisy Top-k Gating** ([GShard](https://arxiv.org/abs/2006.16668) by Lepikhin et al., 2020): Adds Gaussian noise to logits before selecting experts to encourage exploration and load balance.\n2.  **Load-Balanced Routing** ([Switch Transformer](https://arxiv.org/abs/2101.03961)): Adds auxiliary loss to penalize expert imbalance.\n3.  **Expert Choice Routing** ([Zhou et al., 2022](https://papers.neurips.cc/paper_files/paper/2022/file/2f00ecd787b432c1d36f3de9800728eb-Paper-Conference.pdf)): Each expert independently selects a subset of tokens it wants to process, improving locality.\n4.  **Hash-based Routing** ([Hash Layers](https://arxiv.org/abs/2106.04426) by Roller et al., 2021): Uses consistent hashing to deterministically map tokens to experts, removing the gate’s learned component for predictability and speed.\n5.  **Soft MoE** ([Soft MoE](https://arxiv.org/abs/2110.01786) by Shen et al., 2021): Performs continuous, differentiable routing where all experts contribute but are weighted softly, removing discontinuities in gating gradients.\n\nThese routing methods trade off between expressiveness (learned gates) and efficiency (deterministic or sparse routing). Hybrid approaches can even mix them layer-wise in the same model.\n\n#### Capacity Overflow Analysis\n\n*   Consider the case of _top-1 gating_. Let pipip\\_i denote the probability that a token is assigned to expert iii, so ∑ipi\\=1∑ipi\\=1\\\\sum\\_i p\\_i = 1. If routing is stochastic but independent across tokens, the number of tokens assigned to expert iii follows a Binomial distribution:\n\nTi∼Binomial(T,pi)Ti∼Binomial(T,pi)\n\n*   … and the expected number of overflows is:\n\n𝔼\\[overflowi\\]\\=max(0,𝔼\\[Ti\\]−C)E\\[overflowi\\]\\=max(0,E\\[Ti\\]−C)\n\n*   Balancing losses attempt to make pi≈1/Epi≈1/Ep\\_i \\\\approx 1/E, thus minimizing expected overflow. In practice, systems choose α∈\\[1.0,1.5\\]α∈\\[1.0,1.5\\]\\\\alpha \\\\in \\[1.0, 1.5\\] for stable training with minimal drops.\n    \n*   Empirical results from [Switch Transformer](https://arxiv.org/abs/2101.03961) showed that for large-scale models with E\\=2048E\\=2048E=2048 experts, setting α\\=1.25α\\=1.25\\\\alpha = 1.25 yielded optimal trade-offs between speed and accuracy, allowing >99% tokens to be processed successfully per step.\n    \n\nBalancing losses attempt to make pi≈1/Epi≈1/Ep\\_i \\\\approx 1/E, thus minimizing expected overflow. In practice, systems choose α∈\\[1.0,1.5\\]α∈\\[1.0,1.5\\]\\\\alpha \\\\in \\[1.0, 1.5\\] for stable training with minimal drops.\n\nEmpirical results from [Switch Transformer](https://arxiv.org/abs/2101.03961) showed that for large-scale models with E\\=2048E\\=2048E=2048 experts, setting α\\=1.25α\\=1.25\\\\alpha = 1.25 yielded optimal trade-offs between speed and accuracy, allowing >99% tokens to be processed successfully per step.\n\n#### Example: Capacity-aware Token Routing\n\n*   In modern implementations such as [NVIDIA Megatron-Core MoE](https://docs.nvidia.com/megatron-core/developer-guide/latest/moe.html), the routing kernel incorporates _capacity-aware padding_. Tokens are packed into contiguous buffers, respecting expert capacity, and an optimized fused kernel performs:\n    \n    1.  Token sorting by expert ID\n    2.  Capacity clipping\n    3.  Memory offset computation\n    4.  Expert batch matmul in fused CUDA kernel\n    5.  Gather back using prefix-sum indices\n*   This design removes Python-level overhead and maintains consistent throughput even under non-uniform routing patterns. Benchmarks show that expert-parallel MoE with fused dispatch achieves near-linear scaling to 512 GPUs.\n    \n\nIn modern implementations such as [NVIDIA Megatron-Core MoE](https://docs.nvidia.com/megatron-core/developer-guide/latest/moe.html), the routing kernel incorporates _capacity-aware padding_. Tokens are packed into contiguous buffers, respecting expert capacity, and an optimized fused kernel performs:\n\n1.  Token sorting by expert ID\n2.  Capacity clipping\n3.  Memory offset computation\n4.  Expert batch matmul in fused CUDA kernel\n5.  Gather back using prefix-sum indices\n\nThis design removes Python-level overhead and maintains consistent throughput even under non-uniform routing patterns. Benchmarks show that expert-parallel MoE with fused dispatch achieves near-linear scaling to 512 GPUs.",
    "contentLength": 78040,
    "wordCount": 1637,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#capacity-management-and-adaptive-token-to-expert-assignment"
  },
  {
    "id": "ai-mixture-of-experts-inference-time-memory-residency-and-vram-requireme-62",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Inference-Time Memory Residency and VRAM Requirements (Primary Limitation)",
    "order": 62,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>\n    <p>The single largest barrier to the adoption and deployment of MoE models is their <strong>inference-time memory footprint</strong>, which scales with total model capacity rather than with active computation.</p>\n  </li>\n  <li>\n    <p>Despite sparse activation, <strong>all experts must remain resident in memory during inference</strong>:</p>\n\n    <ul>\n      <li>Each expert is a distinct parameterized network.</li>\n      <li>Routing decisions are dynamic, token-level, and input-dependent.</li>\n      <li>It is generally impossible to know ahead of time which experts will be activated for a given request.</li>\n    </ul>\n  </li>\n  <li>\n    <p>As a result, inference systems must load and keep <em>every expert</em> in GPU (or accelerator) memory to guarantee low-latency access. This fundamentally breaks the intuitive expectation that sparse computation should imply sparse memory usage.</p>\n  </li>\n  <li>\n    <p><strong>Key consequences at inference time:</strong></p>\n\n    <ul>\n      <li>\n        <p><strong>Memory scales with total parameters, not active parameters</strong>: Even if only 1–2 experts are used per token, VRAM usage reflects the full MoE layer. This makes MoEs memory-bound rather than compute-bound at inference.</p>\n      </li>\n      <li>\n        <p><strong>Severe constraints on batch size and throughput</strong>: High VRAM pressure limits how many concurrent requests can be served. Increasing batch size often becomes impossible long before compute is saturated.</p>\n      </li>\n      <li>\n        <p><strong>High cold-start and autoscaling cost</strong>: All experts must be loaded before serving, leading to slow startup times and expensive autoscaling in production systems.</p>\n      </li>\n      <li>\n        <p><strong>Poor memory amortization across requests</strong>: Different inputs activate different experts, preventing aggressive caching or eviction strategies. Even “simple” inputs require the entire expert pool to be present.</p>\n      </li>\n      <li>\n        <p><strong>Multi-layer amplification</strong>: Modern MoEs typically place experts in multiple transformer layers. Memory usage compounds across layers, making deep MoEs especially difficult to deploy.</p>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p>Concrete examples illustrate the severity of this constraint:</p>\n\n    <ul>\n      <li>Switch Transformer and GLaM required full expert residency on high-memory TPU pods.</li>\n      <li>Large open MoEs such as Mixtral-8×7B must keep all experts loaded, consuming tens of gigabytes of VRAM per device—even though only a fraction are active per token.</li>\n    </ul>\n  </li>\n  <li>\n    <p>To serve MoEs at scale, practitioners must choose between:</p>\n\n    <ul>\n      <li><strong>Very high-memory accelerators</strong> (80–120 GB GPUs, large TPU slices), or</li>\n      <li><strong>Expert offloading to CPU/NVMe</strong>, which introduces substantial latency and negates many of MoE’s inference advantages.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Despite ongoing work on expert offloading, demand paging, pruning, and quantization, MoE architectures fundamentally lower compute per token while leaving inference-time memory requirements tied to the full model size.</p>\n  </li>\n  <li>\n    <p>In practice, this makes MoEs significantly harder—and often more expensive—to deploy than dense models, especially in latency-sensitive or cost-constrained environments.</p>\n  </li>\n</ul>\n<p>The single largest barrier to the adoption and deployment of MoE models is their <strong>inference-time memory footprint</strong>, which scales with total model capacity rather than with active computation.</p>\n<p>Despite sparse activation, <strong>all experts must remain resident in memory during inference</strong>:</p>\n<ul>\n      <li>Each expert is a distinct parameterized network.</li>\n      <li>Routing decisions are dynamic, token-level, and input-dependent.</li>\n      <li>It is generally impossible to know ahead of time which experts will be activated for a given request.</li>\n    </ul>\n<p>As a result, inference systems must load and keep <em>every expert</em> in GPU (or accelerator) memory to guarantee low-latency access. This fundamentally breaks the intuitive expectation that sparse computation should imply sparse memory usage.</p>\n<p><strong>Key consequences at inference time:</strong></p>\n<ul>\n      <li>\n        <p><strong>Memory scales with total parameters, not active parameters</strong>: Even if only 1–2 experts are used per token, VRAM usage reflects the full MoE layer. This makes MoEs memory-bound rather than compute-bound at inference.</p>\n      </li>\n      <li>\n        <p><strong>Severe constraints on batch size and throughput</strong>: High VRAM pressure limits how many concurrent requests can be served. Increasing batch size often becomes impossible long before compute is saturated.</p>\n      </li>\n      <li>\n        <p><strong>High cold-start and autoscaling cost</strong>: All experts must be loaded before serving, leading to slow startup times and expensive autoscaling in production systems.</p>\n      </li>\n      <li>\n        <p><strong>Poor memory amortization across requests</strong>: Different inputs activate different experts, preventing aggressive caching or eviction strategies. Even “simple” inputs require the entire expert pool to be present.</p>\n      </li>\n      <li>\n        <p><strong>Multi-layer amplification</strong>: Modern MoEs typically place experts in multiple transformer layers. Memory usage compounds across layers, making deep MoEs especially difficult to deploy.</p>\n      </li>\n    </ul>\n<p><strong>Memory scales with total parameters, not active parameters</strong>: Even if only 1–2 experts are used per token, VRAM usage reflects the full MoE layer. This makes MoEs memory-bound rather than compute-bound at inference.</p>\n<p><strong>Severe constraints on batch size and throughput</strong>: High VRAM pressure limits how many concurrent requests can be served. Increasing batch size often becomes impossible long before compute is saturated.</p>\n<p><strong>High cold-start and autoscaling cost</strong>: All experts must be loaded before serving, leading to slow startup times and expensive autoscaling in production systems.</p>\n<p><strong>Poor memory amortization across requests</strong>: Different inputs activate different experts, preventing aggressive caching or eviction strategies. Even “simple” inputs require the entire expert pool to be present.</p>\n<p><strong>Multi-layer amplification</strong>: Modern MoEs typically place experts in multiple transformer layers. Memory usage compounds across layers, making deep MoEs especially difficult to deploy.</p>\n<p>Concrete examples illustrate the severity of this constraint:</p>\n<ul>\n      <li>Switch Transformer and GLaM required full expert residency on high-memory TPU pods.</li>\n      <li>Large open MoEs such as Mixtral-8×7B must keep all experts loaded, consuming tens of gigabytes of VRAM per device—even though only a fraction are active per token.</li>\n    </ul>\n<p>To serve MoEs at scale, practitioners must choose between:</p>\n<ul>\n      <li><strong>Very high-memory accelerators</strong> (80–120 GB GPUs, large TPU slices), or</li>\n      <li><strong>Expert offloading to CPU/NVMe</strong>, which introduces substantial latency and negates many of MoE’s inference advantages.</li>\n    </ul>\n<p>Despite ongoing work on expert offloading, demand paging, pruning, and quantization, MoE architectures fundamentally lower compute per token while leaving inference-time memory requirements tied to the full model size.</p>\n<p>In practice, this makes MoEs significantly harder—and often more expensive—to deploy than dense models, especially in latency-sensitive or cost-constrained environments.</p>",
    "contentMarkdown": "*   The single largest barrier to the adoption and deployment of MoE models is their **inference-time memory footprint**, which scales with total model capacity rather than with active computation.\n    \n*   Despite sparse activation, **all experts must remain resident in memory during inference**:\n    \n    *   Each expert is a distinct parameterized network.\n    *   Routing decisions are dynamic, token-level, and input-dependent.\n    *   It is generally impossible to know ahead of time which experts will be activated for a given request.\n*   As a result, inference systems must load and keep _every expert_ in GPU (or accelerator) memory to guarantee low-latency access. This fundamentally breaks the intuitive expectation that sparse computation should imply sparse memory usage.\n    \n*   **Key consequences at inference time:**\n    \n    *   **Memory scales with total parameters, not active parameters**: Even if only 1–2 experts are used per token, VRAM usage reflects the full MoE layer. This makes MoEs memory-bound rather than compute-bound at inference.\n        \n    *   **Severe constraints on batch size and throughput**: High VRAM pressure limits how many concurrent requests can be served. Increasing batch size often becomes impossible long before compute is saturated.\n        \n    *   **High cold-start and autoscaling cost**: All experts must be loaded before serving, leading to slow startup times and expensive autoscaling in production systems.\n        \n    *   **Poor memory amortization across requests**: Different inputs activate different experts, preventing aggressive caching or eviction strategies. Even “simple” inputs require the entire expert pool to be present.\n        \n    *   **Multi-layer amplification**: Modern MoEs typically place experts in multiple transformer layers. Memory usage compounds across layers, making deep MoEs especially difficult to deploy.\n        \n*   Concrete examples illustrate the severity of this constraint:\n    \n    *   Switch Transformer and GLaM required full expert residency on high-memory TPU pods.\n    *   Large open MoEs such as Mixtral-8×7B must keep all experts loaded, consuming tens of gigabytes of VRAM per device—even though only a fraction are active per token.\n*   To serve MoEs at scale, practitioners must choose between:\n    \n    *   **Very high-memory accelerators** (80–120 GB GPUs, large TPU slices), or\n    *   **Expert offloading to CPU/NVMe**, which introduces substantial latency and negates many of MoE’s inference advantages.\n*   Despite ongoing work on expert offloading, demand paging, pruning, and quantization, MoE architectures fundamentally lower compute per token while leaving inference-time memory requirements tied to the full model size.\n    \n*   In practice, this makes MoEs significantly harder—and often more expensive—to deploy than dense models, especially in latency-sensitive or cost-constrained environments.\n    \n\nThe single largest barrier to the adoption and deployment of MoE models is their **inference-time memory footprint**, which scales with total model capacity rather than with active computation.\n\nDespite sparse activation, **all experts must remain resident in memory during inference**:\n\n*   Each expert is a distinct parameterized network.\n*   Routing decisions are dynamic, token-level, and input-dependent.\n*   It is generally impossible to know ahead of time which experts will be activated for a given request.\n\nAs a result, inference systems must load and keep _every expert_ in GPU (or accelerator) memory to guarantee low-latency access. This fundamentally breaks the intuitive expectation that sparse computation should imply sparse memory usage.\n\n**Key consequences at inference time:**\n\n*   **Memory scales with total parameters, not active parameters**: Even if only 1–2 experts are used per token, VRAM usage reflects the full MoE layer. This makes MoEs memory-bound rather than compute-bound at inference.\n    \n*   **Severe constraints on batch size and throughput**: High VRAM pressure limits how many concurrent requests can be served. Increasing batch size often becomes impossible long before compute is saturated.\n    \n*   **High cold-start and autoscaling cost**: All experts must be loaded before serving, leading to slow startup times and expensive autoscaling in production systems.\n    \n*   **Poor memory amortization across requests**: Different inputs activate different experts, preventing aggressive caching or eviction strategies. Even “simple” inputs require the entire expert pool to be present.\n    \n*   **Multi-layer amplification**: Modern MoEs typically place experts in multiple transformer layers. Memory usage compounds across layers, making deep MoEs especially difficult to deploy.\n    \n\n**Memory scales with total parameters, not active parameters**: Even if only 1–2 experts are used per token, VRAM usage reflects the full MoE layer. This makes MoEs memory-bound rather than compute-bound at inference.\n\n**Severe constraints on batch size and throughput**: High VRAM pressure limits how many concurrent requests can be served. Increasing batch size often becomes impossible long before compute is saturated.\n\n**High cold-start and autoscaling cost**: All experts must be loaded before serving, leading to slow startup times and expensive autoscaling in production systems.\n\n**Poor memory amortization across requests**: Different inputs activate different experts, preventing aggressive caching or eviction strategies. Even “simple” inputs require the entire expert pool to be present.\n\n**Multi-layer amplification**: Modern MoEs typically place experts in multiple transformer layers. Memory usage compounds across layers, making deep MoEs especially difficult to deploy.\n\nConcrete examples illustrate the severity of this constraint:\n\n*   Switch Transformer and GLaM required full expert residency on high-memory TPU pods.\n*   Large open MoEs such as Mixtral-8×7B must keep all experts loaded, consuming tens of gigabytes of VRAM per device—even though only a fraction are active per token.\n\nTo serve MoEs at scale, practitioners must choose between:\n\n*   **Very high-memory accelerators** (80–120 GB GPUs, large TPU slices), or\n*   **Expert offloading to CPU/NVMe**, which introduces substantial latency and negates many of MoE’s inference advantages.\n\nDespite ongoing work on expert offloading, demand paging, pruning, and quantization, MoE architectures fundamentally lower compute per token while leaving inference-time memory requirements tied to the full model size.\n\nIn practice, this makes MoEs significantly harder—and often more expensive—to deploy than dense models, especially in latency-sensitive or cost-constrained environments.",
    "contentLength": 7794,
    "wordCount": 919,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#inference-time-memory-residency-and-vram-requirements-(primary-limitation)"
  },
  {
    "id": "ai-mixture-of-experts-training-instability-and-load-imbalance-63",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Training Instability and Load Imbalance",
    "order": 63,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>\n    <p>MoE models are inherently prone to <strong>uneven expert utilization</strong>, where a small subset of experts receives the majority of tokens while others remain underused or idle. This load imbalance leads to unstable optimization, undertrained experts, and degraded generalization.</p>\n\n    <ul>\n      <li>The issue was first identified in <em>Sparsely-Gated MoE</em>, which introduced a load-balancing loss to encourage uniform routing.</li>\n      <li>Later work such as <em>Expert Choice Routing</em> reversed the routing direction, allowing experts to select tokens in an attempt to improve utilization.</li>\n      <li>Despite these advances, perfect balance remains elusive—especially at scale.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Imbalance has several compounding effects:</p>\n\n    <ul>\n      <li>Experts that receive fewer tokens learn more slowly or not at all.</li>\n      <li>Overused experts experience higher gradient variance and saturation.</li>\n      <li>The system becomes fragile to routing noise, increasing the risk of expert collapse.</li>\n    </ul>\n  </li>\n  <li>\n    <p>In large distributed setups, even small routing skews can significantly slow convergence and reduce effective capacity.</p>\n  </li>\n</ul>\n<p>MoE models are inherently prone to <strong>uneven expert utilization</strong>, where a small subset of experts receives the majority of tokens while others remain underused or idle. This load imbalance leads to unstable optimization, undertrained experts, and degraded generalization.</p>\n<ul>\n      <li>The issue was first identified in <em>Sparsely-Gated MoE</em>, which introduced a load-balancing loss to encourage uniform routing.</li>\n      <li>Later work such as <em>Expert Choice Routing</em> reversed the routing direction, allowing experts to select tokens in an attempt to improve utilization.</li>\n      <li>Despite these advances, perfect balance remains elusive—especially at scale.</li>\n    </ul>\n<p>Imbalance has several compounding effects:</p>\n<ul>\n      <li>Experts that receive fewer tokens learn more slowly or not at all.</li>\n      <li>Overused experts experience higher gradient variance and saturation.</li>\n      <li>The system becomes fragile to routing noise, increasing the risk of expert collapse.</li>\n    </ul>\n<p>In large distributed setups, even small routing skews can significantly slow convergence and reduce effective capacity.</p>",
    "contentMarkdown": "*   MoE models are inherently prone to **uneven expert utilization**, where a small subset of experts receives the majority of tokens while others remain underused or idle. This load imbalance leads to unstable optimization, undertrained experts, and degraded generalization.\n    \n    *   The issue was first identified in _Sparsely-Gated MoE_, which introduced a load-balancing loss to encourage uniform routing.\n    *   Later work such as _Expert Choice Routing_ reversed the routing direction, allowing experts to select tokens in an attempt to improve utilization.\n    *   Despite these advances, perfect balance remains elusive—especially at scale.\n*   Imbalance has several compounding effects:\n    \n    *   Experts that receive fewer tokens learn more slowly or not at all.\n    *   Overused experts experience higher gradient variance and saturation.\n    *   The system becomes fragile to routing noise, increasing the risk of expert collapse.\n*   In large distributed setups, even small routing skews can significantly slow convergence and reduce effective capacity.\n    \n\nMoE models are inherently prone to **uneven expert utilization**, where a small subset of experts receives the majority of tokens while others remain underused or idle. This load imbalance leads to unstable optimization, undertrained experts, and degraded generalization.\n\n*   The issue was first identified in _Sparsely-Gated MoE_, which introduced a load-balancing loss to encourage uniform routing.\n*   Later work such as _Expert Choice Routing_ reversed the routing direction, allowing experts to select tokens in an attempt to improve utilization.\n*   Despite these advances, perfect balance remains elusive—especially at scale.\n\nImbalance has several compounding effects:\n\n*   Experts that receive fewer tokens learn more slowly or not at all.\n*   Overused experts experience higher gradient variance and saturation.\n*   The system becomes fragile to routing noise, increasing the risk of expert collapse.\n\nIn large distributed setups, even small routing skews can significantly slow convergence and reduce effective capacity.",
    "contentLength": 2423,
    "wordCount": 295,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#training-instability-and-load-imbalance"
  },
  {
    "id": "ai-mixture-of-experts-communication-overhead-and-hardware-dependency-64",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Communication Overhead and Hardware Dependency",
    "order": 64,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>\n    <p>Although MoEs are computationally sparse, they are <strong>communication-heavy</strong>.</p>\n  </li>\n  <li>\n    <p>During training (and often inference), tokens must be dynamically routed to experts that may reside on different devices. This introduces expensive all-to-all communication patterns:</p>\n\n    <ul>\n      <li>Token activations must be exchanged across devices.</li>\n      <li>Synchronization barriers become frequent.</li>\n      <li>Network bandwidth, not FLOPs, often becomes the bottleneck.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Systems such as GShard and Switch Transformer rely on:</p>\n\n    <ul>\n      <li>custom kernels,</li>\n      <li>carefully engineered all-to-all collectives,</li>\n      <li>extremely high-bandwidth interconnects (TPU mesh, NVSwitch).</li>\n    </ul>\n  </li>\n  <li>\n    <p>On commodity GPU clusters, communication overhead can dominate total runtime, eroding or even reversing the theoretical efficiency gains of sparsity. This makes MoE training and inference feasible primarily on hyperscale infrastructure, limiting accessibility.</p>\n  </li>\n  <li>\n    <p>In short: MoEs trade dense compute for sparse compute—but replace it with dense communication.</p>\n  </li>\n</ul>\n<p>Although MoEs are computationally sparse, they are <strong>communication-heavy</strong>.</p>\n<p>During training (and often inference), tokens must be dynamically routed to experts that may reside on different devices. This introduces expensive all-to-all communication patterns:</p>\n<ul>\n      <li>Token activations must be exchanged across devices.</li>\n      <li>Synchronization barriers become frequent.</li>\n      <li>Network bandwidth, not FLOPs, often becomes the bottleneck.</li>\n    </ul>\n<p>Systems such as GShard and Switch Transformer rely on:</p>\n<ul>\n      <li>custom kernels,</li>\n      <li>carefully engineered all-to-all collectives,</li>\n      <li>extremely high-bandwidth interconnects (TPU mesh, NVSwitch).</li>\n    </ul>\n<p>On commodity GPU clusters, communication overhead can dominate total runtime, eroding or even reversing the theoretical efficiency gains of sparsity. This makes MoE training and inference feasible primarily on hyperscale infrastructure, limiting accessibility.</p>\n<p>In short: MoEs trade dense compute for sparse compute—but replace it with dense communication.</p>",
    "contentMarkdown": "*   Although MoEs are computationally sparse, they are **communication-heavy**.\n    \n*   During training (and often inference), tokens must be dynamically routed to experts that may reside on different devices. This introduces expensive all-to-all communication patterns:\n    \n    *   Token activations must be exchanged across devices.\n    *   Synchronization barriers become frequent.\n    *   Network bandwidth, not FLOPs, often becomes the bottleneck.\n*   Systems such as GShard and Switch Transformer rely on:\n    \n    *   custom kernels,\n    *   carefully engineered all-to-all collectives,\n    *   extremely high-bandwidth interconnects (TPU mesh, NVSwitch).\n*   On commodity GPU clusters, communication overhead can dominate total runtime, eroding or even reversing the theoretical efficiency gains of sparsity. This makes MoE training and inference feasible primarily on hyperscale infrastructure, limiting accessibility.\n    \n*   In short: MoEs trade dense compute for sparse compute—but replace it with dense communication.\n    \n\nAlthough MoEs are computationally sparse, they are **communication-heavy**.\n\nDuring training (and often inference), tokens must be dynamically routed to experts that may reside on different devices. This introduces expensive all-to-all communication patterns:\n\n*   Token activations must be exchanged across devices.\n*   Synchronization barriers become frequent.\n*   Network bandwidth, not FLOPs, often becomes the bottleneck.\n\nSystems such as GShard and Switch Transformer rely on:\n\n*   custom kernels,\n*   carefully engineered all-to-all collectives,\n*   extremely high-bandwidth interconnects (TPU mesh, NVSwitch).\n\nOn commodity GPU clusters, communication overhead can dominate total runtime, eroding or even reversing the theoretical efficiency gains of sparsity. This makes MoE training and inference feasible primarily on hyperscale infrastructure, limiting accessibility.\n\nIn short: MoEs trade dense compute for sparse compute—but replace it with dense communication.",
    "contentLength": 2343,
    "wordCount": 255,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#communication-overhead-and-hardware-dependency"
  },
  {
    "id": "ai-mixture-of-experts-routing-complexity-and-gradient-fragmentation-65",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Routing Complexity and Gradient Fragmentation",
    "order": 65,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>\n    <p>The routing mechanism that selects experts introduces both algorithmic and optimization complexity.</p>\n\n    <ul>\n      <li>Routing decisions are typically based on top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-422-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3426\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3427\"><span class=\"mi\" id=\"MathJax-Span-3428\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-422\">k</script> selection over expert logits.</li>\n      <li>These decisions are discrete and non-differentiable.</li>\n      <li>Approximations such as soft routing, stochastic gates, or straight-through estimators are required.</li>\n    </ul>\n  </li>\n  <li>\n    <p>These approximations introduce noise and instability:</p>\n\n    <ul>\n      <li>Small changes in router parameters can dramatically change expert assignments.</li>\n      <li>Tokens may be misrouted, slowing expert specialization.</li>\n      <li>Gradients become unevenly distributed across experts.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This leads to <strong>gradient fragmentation</strong>, where some experts receive dense, stable gradients, while others receive sparse, noisy, or delayed updates.</p>\n  </li>\n  <li>\n    <p>Fragmentation makes optimization more brittle and increases sensitivity to hyperparameters such as learning rate, routing temperature, and auxiliary loss weights.</p>\n  </li>\n</ul>\n<p>The routing mechanism that selects experts introduces both algorithmic and optimization complexity.</p>\n<ul>\n      <li>Routing decisions are typically based on top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-422-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3426\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3427\"><span class=\"mi\" id=\"MathJax-Span-3428\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-422\">k</script> selection over expert logits.</li>\n      <li>These decisions are discrete and non-differentiable.</li>\n      <li>Approximations such as soft routing, stochastic gates, or straight-through estimators are required.</li>\n    </ul>\n<p>These approximations introduce noise and instability:</p>\n<ul>\n      <li>Small changes in router parameters can dramatically change expert assignments.</li>\n      <li>Tokens may be misrouted, slowing expert specialization.</li>\n      <li>Gradients become unevenly distributed across experts.</li>\n    </ul>\n<p>This leads to <strong>gradient fragmentation</strong>, where some experts receive dense, stable gradients, while others receive sparse, noisy, or delayed updates.</p>\n<p>Fragmentation makes optimization more brittle and increases sensitivity to hyperparameters such as learning rate, routing temperature, and auxiliary loss weights.</p>",
    "contentMarkdown": "*   The routing mechanism that selects experts introduces both algorithmic and optimization complexity.\n    \n    *   Routing decisions are typically based on top-kkk selection over expert logits.\n    *   These decisions are discrete and non-differentiable.\n    *   Approximations such as soft routing, stochastic gates, or straight-through estimators are required.\n*   These approximations introduce noise and instability:\n    \n    *   Small changes in router parameters can dramatically change expert assignments.\n    *   Tokens may be misrouted, slowing expert specialization.\n    *   Gradients become unevenly distributed across experts.\n*   This leads to **gradient fragmentation**, where some experts receive dense, stable gradients, while others receive sparse, noisy, or delayed updates.\n    \n*   Fragmentation makes optimization more brittle and increases sensitivity to hyperparameters such as learning rate, routing temperature, and auxiliary loss weights.\n    \n\nThe routing mechanism that selects experts introduces both algorithmic and optimization complexity.\n\n*   Routing decisions are typically based on top-kkk selection over expert logits.\n*   These decisions are discrete and non-differentiable.\n*   Approximations such as soft routing, stochastic gates, or straight-through estimators are required.\n\nThese approximations introduce noise and instability:\n\n*   Small changes in router parameters can dramatically change expert assignments.\n*   Tokens may be misrouted, slowing expert specialization.\n*   Gradients become unevenly distributed across experts.\n\nThis leads to **gradient fragmentation**, where some experts receive dense, stable gradients, while others receive sparse, noisy, or delayed updates.\n\nFragmentation makes optimization more brittle and increases sensitivity to hyperparameters such as learning rate, routing temperature, and auxiliary loss weights.",
    "contentLength": 4738,
    "wordCount": 236,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#routing-complexity-and-gradient-fragmentation"
  },
  {
    "id": "ai-mixture-of-experts-underutilization-of-model-capacity-66",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Underutilization of Model Capacity",
    "order": 66,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>\n    <p>Although MoEs contain enormous numbers of parameters, <strong>only a tiny fraction are used per token</strong>.</p>\n\n    <ul>\n      <li>Typically 1–2 experts are active out of dozens.</li>\n      <li>Most parameters sit idle during any given forward pass.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This creates a gap between <em>nominal</em> capacity and <em>effective</em> capacity:</p>\n\n    <ul>\n      <li>Per-token expressivity grows much more slowly than total parameter count.</li>\n      <li>Rarely used experts may drift, degrade, or overfit to narrow distributions.</li>\n      <li>Capacity is difficult to reallocate dynamically once routing patterns stabilize.</li>\n    </ul>\n  </li>\n  <li>\n    <p>Methods such as adaptive routing, expert refreshing, and load-regularized training (e.g., AdaMoE) help, but they do not fully resolve the fundamental inefficiency of unused parameters.</p>\n  </li>\n  <li>\n    <p>As a result, MoEs can look dramatically larger on paper than they are in practice on a per-sample basis.</p>\n  </li>\n</ul>\n<p>Although MoEs contain enormous numbers of parameters, <strong>only a tiny fraction are used per token</strong>.</p>\n<ul>\n      <li>Typically 1–2 experts are active out of dozens.</li>\n      <li>Most parameters sit idle during any given forward pass.</li>\n    </ul>\n<p>This creates a gap between <em>nominal</em> capacity and <em>effective</em> capacity:</p>\n<ul>\n      <li>Per-token expressivity grows much more slowly than total parameter count.</li>\n      <li>Rarely used experts may drift, degrade, or overfit to narrow distributions.</li>\n      <li>Capacity is difficult to reallocate dynamically once routing patterns stabilize.</li>\n    </ul>\n<p>Methods such as adaptive routing, expert refreshing, and load-regularized training (e.g., AdaMoE) help, but they do not fully resolve the fundamental inefficiency of unused parameters.</p>\n<p>As a result, MoEs can look dramatically larger on paper than they are in practice on a per-sample basis.</p>",
    "contentMarkdown": "*   Although MoEs contain enormous numbers of parameters, **only a tiny fraction are used per token**.\n    \n    *   Typically 1–2 experts are active out of dozens.\n    *   Most parameters sit idle during any given forward pass.\n*   This creates a gap between _nominal_ capacity and _effective_ capacity:\n    \n    *   Per-token expressivity grows much more slowly than total parameter count.\n    *   Rarely used experts may drift, degrade, or overfit to narrow distributions.\n    *   Capacity is difficult to reallocate dynamically once routing patterns stabilize.\n*   Methods such as adaptive routing, expert refreshing, and load-regularized training (e.g., AdaMoE) help, but they do not fully resolve the fundamental inefficiency of unused parameters.\n    \n*   As a result, MoEs can look dramatically larger on paper than they are in practice on a per-sample basis.\n    \n\nAlthough MoEs contain enormous numbers of parameters, **only a tiny fraction are used per token**.\n\n*   Typically 1–2 experts are active out of dozens.\n*   Most parameters sit idle during any given forward pass.\n\nThis creates a gap between _nominal_ capacity and _effective_ capacity:\n\n*   Per-token expressivity grows much more slowly than total parameter count.\n*   Rarely used experts may drift, degrade, or overfit to narrow distributions.\n*   Capacity is difficult to reallocate dynamically once routing patterns stabilize.\n\nMethods such as adaptive routing, expert refreshing, and load-regularized training (e.g., AdaMoE) help, but they do not fully resolve the fundamental inefficiency of unused parameters.\n\nAs a result, MoEs can look dramatically larger on paper than they are in practice on a per-sample basis.",
    "contentLength": 2008,
    "wordCount": 248,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#underutilization-of-model-capacity"
  },
  {
    "id": "ai-mixture-of-experts-inference-instability-and-latency-variability-67",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Inference Instability and Latency Variability",
    "order": 67,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>\n    <p>Conditional computation introduces <strong>non-deterministic inference behavior</strong>.</p>\n\n    <ul>\n      <li>The same input can activate different experts depending on context.</li>\n      <li>Different experts may reside on different devices.</li>\n      <li>Routing decisions can trigger different communication paths.</li>\n    </ul>\n  </li>\n  <li>\n    <p>This leads to variable latency, unpredictable tail behavior, and difficulty meeting strict SLAs.</p>\n  </li>\n  <li>\n    <p>Batch inference amplifies the issue: if tokens in the same batch route to disjoint experts, synchronization delays can dominate runtime.</p>\n  </li>\n  <li>\n    <p>Some systems freeze routing or restrict expert choice at inference to stabilize latency, but this sacrifices adaptivity and often reduces accuracy—undermining one of MoE’s core benefits.</p>\n  </li>\n</ul>\n<p>Conditional computation introduces <strong>non-deterministic inference behavior</strong>.</p>\n<ul>\n      <li>The same input can activate different experts depending on context.</li>\n      <li>Different experts may reside on different devices.</li>\n      <li>Routing decisions can trigger different communication paths.</li>\n    </ul>\n<p>This leads to variable latency, unpredictable tail behavior, and difficulty meeting strict SLAs.</p>\n<p>Batch inference amplifies the issue: if tokens in the same batch route to disjoint experts, synchronization delays can dominate runtime.</p>\n<p>Some systems freeze routing or restrict expert choice at inference to stabilize latency, but this sacrifices adaptivity and often reduces accuracy—undermining one of MoE’s core benefits.</p>",
    "contentMarkdown": "*   Conditional computation introduces **non-deterministic inference behavior**.\n    \n    *   The same input can activate different experts depending on context.\n    *   Different experts may reside on different devices.\n    *   Routing decisions can trigger different communication paths.\n*   This leads to variable latency, unpredictable tail behavior, and difficulty meeting strict SLAs.\n    \n*   Batch inference amplifies the issue: if tokens in the same batch route to disjoint experts, synchronization delays can dominate runtime.\n    \n*   Some systems freeze routing or restrict expert choice at inference to stabilize latency, but this sacrifices adaptivity and often reduces accuracy—undermining one of MoE’s core benefits.\n    \n\nConditional computation introduces **non-deterministic inference behavior**.\n\n*   The same input can activate different experts depending on context.\n*   Different experts may reside on different devices.\n*   Routing decisions can trigger different communication paths.\n\nThis leads to variable latency, unpredictable tail behavior, and difficulty meeting strict SLAs.\n\nBatch inference amplifies the issue: if tokens in the same batch route to disjoint experts, synchronization delays can dominate runtime.\n\nSome systems freeze routing or restrict expert choice at inference to stabilize latency, but this sacrifices adaptivity and often reduces accuracy—undermining one of MoE’s core benefits.",
    "contentLength": 1649,
    "wordCount": 188,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#inference-instability-and-latency-variability"
  },
  {
    "id": "ai-mixture-of-experts-additional-structural-challenges-68",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Limitations",
    "title": "Additional Structural Challenges",
    "order": 68,
    "orderInChapter": 7,
    "contentHtml": "<ul>\n  <li>\n    <p>Beyond these primary limitations, MoE architectures face several secondary but non-trivial issues:</p>\n\n    <ul>\n      <li><strong>Interpretability:</strong> Experts rarely align with clean, human-interpretable concepts.</li>\n      <li><strong>Generalization:</strong> Over-specialized experts may struggle on out-of-distribution data.</li>\n      <li><strong>Implementation complexity:</strong> Distributed optimizers, expert sharding, checkpointing, and fault tolerance significantly increase engineering burden.</li>\n      <li><strong>Energy cost:</strong> Communication overhead and underutilized memory can cause total energy consumption to exceed that of dense models.</li>\n    </ul>\n  </li>\n</ul>\n<p>Beyond these primary limitations, MoE architectures face several secondary but non-trivial issues:</p>\n<ul>\n      <li><strong>Interpretability:</strong> Experts rarely align with clean, human-interpretable concepts.</li>\n      <li><strong>Generalization:</strong> Over-specialized experts may struggle on out-of-distribution data.</li>\n      <li><strong>Implementation complexity:</strong> Distributed optimizers, expert sharding, checkpointing, and fault tolerance significantly increase engineering burden.</li>\n      <li><strong>Energy cost:</strong> Communication overhead and underutilized memory can cause total energy consumption to exceed that of dense models.</li>\n    </ul>",
    "contentMarkdown": "*   Beyond these primary limitations, MoE architectures face several secondary but non-trivial issues:\n    \n    *   **Interpretability:** Experts rarely align with clean, human-interpretable concepts.\n    *   **Generalization:** Over-specialized experts may struggle on out-of-distribution data.\n    *   **Implementation complexity:** Distributed optimizers, expert sharding, checkpointing, and fault tolerance significantly increase engineering burden.\n    *   **Energy cost:** Communication overhead and underutilized memory can cause total energy consumption to exceed that of dense models.\n\nBeyond these primary limitations, MoE architectures face several secondary but non-trivial issues:\n\n*   **Interpretability:** Experts rarely align with clean, human-interpretable concepts.\n*   **Generalization:** Over-specialized experts may struggle on out-of-distribution data.\n*   **Implementation complexity:** Distributed optimizers, expert sharding, checkpointing, and fault tolerance significantly increase engineering burden.\n*   **Energy cost:** Communication overhead and underutilized memory can cause total energy consumption to exceed that of dense models.",
    "contentLength": 1408,
    "wordCount": 129,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#additional-structural-challenges"
  },
  {
    "id": "ai-mixture-of-experts-gpt-4-69",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Popular MoE Models",
    "title": "GPT-4",
    "order": 69,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>Read our GPT-4 primer <a href=\"../GPT-4\">here</a>.</li>\n  <li>Per a <a href=\"https://www.reddit.com/r/mlscaling/comments/14eowmw/gpt4_rumors_a_mixtureofexperts_w8_gpt3220bs/\">rumor</a>, GPT-4 might be an 8-way MoE model with 8 220B parameters (a total of 1.76T parameters).</li>\n  <li>A Mixture of Experts (MoE) model essentially revolves around a router that directs questions to the appropriate expert. If GPT-4 does adopt the MoE approach, it would consist of eight specialist models each trained in a specific domain, like mathematics, history, storytelling, etc. When a question is posed, the router analyses it and seamlessly forwards it to the most suitable expert.</li>\n  <li>The concept of MoE is quite prevalent (refer <a href=\"../../../papers/#outrageously-large-neural-networks-the-sparsely-gated-mixture-of-experts-layer\">Outrageously Large Neural Networks: the Sparsely-Gated Mixture-of-Experts Layer</a>), with Langchain’s high-level implementation of an <a href=\"https://python.langchain.com/docs/modules/chains/foundational/router\">LLMRouterChain</a>, and notable low-level integrated examples like Google’s Switch Transformer (refer <a href=\"../../../papers/#switch-transformers-scaling-to-trillion-parameter-models-with-simple-and-efficient-sparsity\">Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</a>).</li>\n  <li>Per yet another <a href=\"https://archive.is/2RQ8X#selection-449.1-1067.86\">rumor</a>, here are the specifics:\n    <ul>\n      <li><strong>Parameter count:</strong> GPT-4 is more than 10x the size of GPT-3; with a total of ~1.8 trillion parameters across 120 layers.</li>\n      <li><strong>Architecture:</strong> GPT-4 uses an MoE architecture; the main idea behind used an MoE model was to keep costs training/inference reasonable while ensuring great performance. In other words, it is not a dense transformer like, for instance, PaLM (or GPT-3). They utilizes 16 experts within their model, each is about ~111B parameters for MLP. 2 of these experts are routed per forward pass. There roughly ~55B shared parameters for attention.</li>\n      <li><strong>MoE routing:</strong> While the literature talks a lot about advanced routing algorithms for choosing which experts to route each token to, OpenAI’s is allegedly quite simple, for the current GPT-4 model.</li>\n      <li><strong>Inference:</strong> Each forward pass inference (generation of 1 token) only utilizes ~280B parameters and ~560 TFLOPs. This contrasts with the ~1.8 trillion parameters and ~3,700 TFLOP that would be required per forward pass of a purely dense model (vs. the MoE architecture that’s used).</li>\n      <li><strong>Dataset:</strong> GPT-4 is trained on ~13T tokens. These are not unique tokens, but the total amount of tokens seen over all epochs. There are millions of instruction fine-tuning data samples from ScaleAI &amp; internally (probably acquired through ChatGPT + their API before they changed the policy).</li>\n      <li><strong>Training epochs:</strong> 2 epochs for text-based data and 4 for code-based data.</li>\n      <li><strong>Training paradigm:</strong> For pre-training GPT-4 32K, they utilized an 8K context length. The 32K context version of GPT-4 was based on fine-tuning of the 8K after the pre-training. <a href=\"https://kaiokendev.github.io/context\">Extending context is hard… but not impossible</a> is a good reference on how to achieve this.</li>\n      <li><strong>Batch size:</strong> The batch size was gradually ramped up over a number of days on the cluster, but by the end, OpenAI was using a batch size of 60 million! This, of course, is “only” a batch size of 7.5 million tokens per expert due to not every expert seeing all tokens. For the real batch size:** Divide this number by the context width to get the real batch size.</li>\n      <li><strong>Parallelism strategies:</strong> To parallelize across all their A100s GPUs, they utilized 8-way tensor parallelism as that is the limit for NVLink. Beyond that, they used 15-way pipeline parallelism. Also apparently they used DeepSpeed ZeRo Stage 1 or block-level FSDP.</li>\n      <li><strong>Training cost</strong>: OpenAI’s training FLOPS for GPT-4 is ~2.15e25, on ~25,000 A100s for 90 to 100 days at about 32% to 36% MFU. Part of this extremely low utilization is due to an absurd number of failures requiring checkpoints that needed to be restarted from. If their cost in the cloud was about $1 per A100 hour, the training costs for this run alone would be about $63 million. Had H100s been used, pre-training could be done with ~8,192 H100s in ~55 days for $21.5 million at $2 per H100 hour.</li>\n      <li><strong>MoE tradeoffs</strong>: There are multiple MoE tradeoffs taken; for example, MoE is incredibly difficult to deal with on inference because not every part of the model is utilized on every token generation. This means some parts may sit dormant when other parts are being used. When serving users, this really hurts utilization rates. Researchers have shown that using 64 to 128 experts achieves better loss than 16 experts, but that’s purely research. There are multiple reasons to go with fewer experts. One reason for OpenAI choosing 16 experts is because more experts are difficult to generalize at many tasks. More experts can also be more difficult to achieve convergence with. With such a large training run, OpenAI instead chose to be more conservative on the number of experts.</li>\n      <li><strong>GPT-4 inference cost</strong>: GPT-4 costs 3x that of the 175B parameter DaVinci. This is largely due to the larger clusters required for GPT-4 and much lower utilization achieved. An estimate of it’s costs is $0.0049 cents per 1K tokens for 128 A100s to inference GPT-4 8K context width and $0.0021 cents per 1K tokens for 128 H100s to inference GPT-4 8K context width. It should be noted that they assume decent high utilization and keep batch sizes large.</li>\n      <li><strong>Multi-Query Attention</strong>: GPT-4 uses MQA instead of MHA (MQA is a classic choice at this point). Because of that only 1 head is needed and memory capacity can be significantly reduced for the KV cache. Even then, the 32K context width GPT-4 definitely cannot run on 40GB A100s, and the 8K is capped on max batch size.</li>\n      <li><strong>Continuous batching</strong>: OpenAI implements both variable batch sizes and continuous batching. This is so as to allow some level of maximum latency as well optimizing the inference costs.</li>\n      <li><strong>Vision multi-modal</strong>: They have a separate vision encoder from the text encoder, with cross-attention. The architecture is similar to Google DeepMind’s <a href=\"../../../papers/#flamingo-a-visual-language-model-for-few-shot-learning\">Flamingo</a>. This adds more parameters on top of the 1.8T text-only GPT-4. It is fine-tuned with another ~2 trillion tokens, after the text only pre-training. On the vision model, OpenAI wanted to train it from scratch, but it wasn’t mature enough, so they wanted to derisk it by starting with text. One of the primary purposes of this vision capability is for autonomous agents able to read web pages and transcribe what’s in images and video. Some of the data they train on is joint data (rendered LaTeX/text), screenshots of web pages, YouTube videos: sampling frames, and run Whisper around it to get transcript.</li>\n      <li><strong>Speculative decoding</strong>: OpenAI might be using speculative decoding on GPT-4’s inference. The idea is to use a smaller faster model to decode several tokens in advance, and then feeds them into a large oracle model as a single batch. If the small model was right about its predictions (i.e., the larger model agrees), we can decode several tokens in a single batch. But if the larger model rejects the tokens predicted by the draft model then the rest of the batch is discarded. And we continue with the larger model. <strong>The conspiracy theory that the new GPT-4 quality had been deteriorated might be simply because they are letting the oracle model accept lower probability sequences from the speculative decoding model.</strong>\n        <ul>\n          <li>Per <a href=\"https://twitter.com/karpathy/status/1697318534555336961\">Andrej Karpathy</a>, speculative sampling/decoding/execution for LLMs is an excellent inference-time optimization. It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-423-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3429\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3430\"><span class=\"mi\" id=\"MathJax-Span-3431\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-423\">K</script> input tokens in a batch (for larger <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-424-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3432\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3433\"><span class=\"mi\" id=\"MathJax-Span-3434\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-424\">K</script> than what might be obvious). This unintuitive fact is because sampling is heavily memory bound: most of the “work” is not doing compute, it is reading in the weights of the transformer from VRAM into on-chip cache for processing. So if you’re going to do all that work of reading in all those weights, you might as well apply them to a whole batch of input vectors.\n            <ul>\n              <li>At batch_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.</li>\n              <li>Let’s take a look:\n                <ul>\n                  <li>A100: 1935 GB/s memory bandwidth, 1248 TOPS</li>\n                  <li>MacBook M2: 100 GB/s, 7 TFLOPS</li>\n                </ul>\n              </li>\n              <li>The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.</li>\n              <li>The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.</li>\n              <li>In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.</li>\n            </ul>\n          </li>\n          <li>The reason we can’t naively use this fact to sample in chunks of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-425-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3435\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3436\"><span class=\"mi\" id=\"MathJax-Span-3437\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-425\">K</script> tokens at a time is that every <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-426-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>N</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3438\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.46em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3439\"><span class=\"msubsup\" id=\"MathJax-Span-3440\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3441\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"texatom\" id=\"MathJax-Span-3442\"><span class=\"mrow\" id=\"MathJax-Span-3443\"><span class=\"mi\" id=\"MathJax-Span-3444\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3445\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>N</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-426\">N^{th}</script> token depends on what token we sample at time at step <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-427-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3446\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.24em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3447\"><span class=\"mi\" id=\"MathJax-Span-3448\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3449\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mn\" id=\"MathJax-Span-3450\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi><mo>−</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-427\">N-1</script>. There is a serial dependency, so the baseline implementation just goes one by one left to right.</li>\n          <li>Now the clever idea is to use a small and cheap draft model to first generate a candidate sequence of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-428-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3451\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3452\"><span class=\"mi\" id=\"MathJax-Span-3453\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-428\">K</script> tokens – a “draft”. Then we feed all of these together through the big model in a batch. This is almost as fast as feeding in just one token, per the above. Then we go from left to right over the logits predicted by the model and sample tokens. Any sample that agrees with the draft allows us to immediately skip forward to the next token. If there is a disagreement then we throw the draft away and eat the cost of doing some throwaway work (sampling the draft and the forward passing for all the later tokens).</li>\n          <li>The reason this works in practice is that most of the time the draft tokens get accepted, because they are easy, so even a much smaller draft model gets them. As these easy tokens get accepted, we skip through those parts in leaps. The hard tokens where the big model disagrees “fall back” to original speed, but actually a bit slower because of all the extra work.</li>\n          <li>In summary, this one weird trick works because LLMs are memory bound at inference time, in the “batch size 1” setting of sampling a single sequence of interest, that a large fraction of “local LLM” use cases fall into. And because most tokens are “easy”.</li>\n          <li>More on this here: <a href=\"https://arxiv.org/abs/1811.03115\">Blockwise Parallel Decoding for Deep Autoregressive Models</a>, <a href=\"https://arxiv.org/abs/2302.01318\">Accelerating Large Language Model Decoding with Speculative Sampling</a>, and <a href=\"https://arxiv.org/abs/2211.17192\">Fast Inference from Transformers via Speculative Decoding</a></li>\n        </ul>\n      </li>\n      <li><strong>Inference architecture</strong>: The inference runs on a cluster of 128 GPUs. There are multiple of these clusters in multiple datacenters in different locations. It is done in 8-way tensor parallelism and 16-way pipeline parallelism. Each node of 8 GPUs has only ~130B parameters, or less than 30GB per GPU at FP16 and less than 15GB at FP8/int8. The model has 120 layers, so it fits in 15 different nodes. (Possibly the there are less layers on the first node since it needs to also compute the embeddings). According to these numbers: OpenAI should have trained on 2x the tokens if they were trying to go by Chinchilla’s optimal. This goes to show that they are struggling to get high quality data.</li>\n      <li><strong>Why no Fully Sharded Data Parallel (FSDP)?</strong> A possible reason for this could be that some of the hardware infra they secured is of an older generation. This is pretty common at local compute clusters as the organisation usually upgrade the infra in several “waves” to avoid a complete pause of operation. With such a high amount of pipeline parallelism it is very likely that they suffer from the “batch bubble”: slight idle time between batches.</li>\n      <li><strong>Dataset mixture</strong>: They trained on 13T tokens. CommonCrawl &amp; RefinedWeb are both 5T. Remove the duplication of tokens from multiple epochs and we get to a much reasonable number of “unaccounted for” tokens: the “secret” data – parts of it probably came from Twitter, Reddit, and YouTube. Some speculations are: LibGen (4M+ books), Sci-Hub (80M+ papers), all of GitHub. Part of the missing dataset could also be custom dataset of college textbooks collected by hand for as much courses as possible. This is very easy to convert to text form and than use <a href=\"../../../papers/#self-instruct-aligning-language-model-with-self-generated-instructions\">Self-Instruct</a> to transform it into instruction form. This creates the “illusion” that GPT-4 “is smart” no matter who uses it: for computer scientists, it can help you with your questions about P!=NP; for a philosophy major, it can totally talk to you about epistemology. There are also papers that try to extract by force memorized parts of books from GPT-4 to understand what it trained on. There are some books it knows so well that it had seen them for sure. Moreover, it even knows the unique ids of project Euler problems.</li>\n    </ul>\n  </li>\n</ul>\n<ul>\n      <li><strong>Parameter count:</strong> GPT-4 is more than 10x the size of GPT-3; with a total of ~1.8 trillion parameters across 120 layers.</li>\n      <li><strong>Architecture:</strong> GPT-4 uses an MoE architecture; the main idea behind used an MoE model was to keep costs training/inference reasonable while ensuring great performance. In other words, it is not a dense transformer like, for instance, PaLM (or GPT-3). They utilizes 16 experts within their model, each is about ~111B parameters for MLP. 2 of these experts are routed per forward pass. There roughly ~55B shared parameters for attention.</li>\n      <li><strong>MoE routing:</strong> While the literature talks a lot about advanced routing algorithms for choosing which experts to route each token to, OpenAI’s is allegedly quite simple, for the current GPT-4 model.</li>\n      <li><strong>Inference:</strong> Each forward pass inference (generation of 1 token) only utilizes ~280B parameters and ~560 TFLOPs. This contrasts with the ~1.8 trillion parameters and ~3,700 TFLOP that would be required per forward pass of a purely dense model (vs. the MoE architecture that’s used).</li>\n      <li><strong>Dataset:</strong> GPT-4 is trained on ~13T tokens. These are not unique tokens, but the total amount of tokens seen over all epochs. There are millions of instruction fine-tuning data samples from ScaleAI &amp; internally (probably acquired through ChatGPT + their API before they changed the policy).</li>\n      <li><strong>Training epochs:</strong> 2 epochs for text-based data and 4 for code-based data.</li>\n      <li><strong>Training paradigm:</strong> For pre-training GPT-4 32K, they utilized an 8K context length. The 32K context version of GPT-4 was based on fine-tuning of the 8K after the pre-training. <a href=\"https://kaiokendev.github.io/context\">Extending context is hard… but not impossible</a> is a good reference on how to achieve this.</li>\n      <li><strong>Batch size:</strong> The batch size was gradually ramped up over a number of days on the cluster, but by the end, OpenAI was using a batch size of 60 million! This, of course, is “only” a batch size of 7.5 million tokens per expert due to not every expert seeing all tokens. For the real batch size:** Divide this number by the context width to get the real batch size.</li>\n      <li><strong>Parallelism strategies:</strong> To parallelize across all their A100s GPUs, they utilized 8-way tensor parallelism as that is the limit for NVLink. Beyond that, they used 15-way pipeline parallelism. Also apparently they used DeepSpeed ZeRo Stage 1 or block-level FSDP.</li>\n      <li><strong>Training cost</strong>: OpenAI’s training FLOPS for GPT-4 is ~2.15e25, on ~25,000 A100s for 90 to 100 days at about 32% to 36% MFU. Part of this extremely low utilization is due to an absurd number of failures requiring checkpoints that needed to be restarted from. If their cost in the cloud was about $1 per A100 hour, the training costs for this run alone would be about $63 million. Had H100s been used, pre-training could be done with ~8,192 H100s in ~55 days for $21.5 million at $2 per H100 hour.</li>\n      <li><strong>MoE tradeoffs</strong>: There are multiple MoE tradeoffs taken; for example, MoE is incredibly difficult to deal with on inference because not every part of the model is utilized on every token generation. This means some parts may sit dormant when other parts are being used. When serving users, this really hurts utilization rates. Researchers have shown that using 64 to 128 experts achieves better loss than 16 experts, but that’s purely research. There are multiple reasons to go with fewer experts. One reason for OpenAI choosing 16 experts is because more experts are difficult to generalize at many tasks. More experts can also be more difficult to achieve convergence with. With such a large training run, OpenAI instead chose to be more conservative on the number of experts.</li>\n      <li><strong>GPT-4 inference cost</strong>: GPT-4 costs 3x that of the 175B parameter DaVinci. This is largely due to the larger clusters required for GPT-4 and much lower utilization achieved. An estimate of it’s costs is $0.0049 cents per 1K tokens for 128 A100s to inference GPT-4 8K context width and $0.0021 cents per 1K tokens for 128 H100s to inference GPT-4 8K context width. It should be noted that they assume decent high utilization and keep batch sizes large.</li>\n      <li><strong>Multi-Query Attention</strong>: GPT-4 uses MQA instead of MHA (MQA is a classic choice at this point). Because of that only 1 head is needed and memory capacity can be significantly reduced for the KV cache. Even then, the 32K context width GPT-4 definitely cannot run on 40GB A100s, and the 8K is capped on max batch size.</li>\n      <li><strong>Continuous batching</strong>: OpenAI implements both variable batch sizes and continuous batching. This is so as to allow some level of maximum latency as well optimizing the inference costs.</li>\n      <li><strong>Vision multi-modal</strong>: They have a separate vision encoder from the text encoder, with cross-attention. The architecture is similar to Google DeepMind’s <a href=\"../../../papers/#flamingo-a-visual-language-model-for-few-shot-learning\">Flamingo</a>. This adds more parameters on top of the 1.8T text-only GPT-4. It is fine-tuned with another ~2 trillion tokens, after the text only pre-training. On the vision model, OpenAI wanted to train it from scratch, but it wasn’t mature enough, so they wanted to derisk it by starting with text. One of the primary purposes of this vision capability is for autonomous agents able to read web pages and transcribe what’s in images and video. Some of the data they train on is joint data (rendered LaTeX/text), screenshots of web pages, YouTube videos: sampling frames, and run Whisper around it to get transcript.</li>\n      <li><strong>Speculative decoding</strong>: OpenAI might be using speculative decoding on GPT-4’s inference. The idea is to use a smaller faster model to decode several tokens in advance, and then feeds them into a large oracle model as a single batch. If the small model was right about its predictions (i.e., the larger model agrees), we can decode several tokens in a single batch. But if the larger model rejects the tokens predicted by the draft model then the rest of the batch is discarded. And we continue with the larger model. <strong>The conspiracy theory that the new GPT-4 quality had been deteriorated might be simply because they are letting the oracle model accept lower probability sequences from the speculative decoding model.</strong>\n        <ul>\n          <li>Per <a href=\"https://twitter.com/karpathy/status/1697318534555336961\">Andrej Karpathy</a>, speculative sampling/decoding/execution for LLMs is an excellent inference-time optimization. It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-423-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3429\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3430\"><span class=\"mi\" id=\"MathJax-Span-3431\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-423\">K</script> input tokens in a batch (for larger <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-424-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3432\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3433\"><span class=\"mi\" id=\"MathJax-Span-3434\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-424\">K</script> than what might be obvious). This unintuitive fact is because sampling is heavily memory bound: most of the “work” is not doing compute, it is reading in the weights of the transformer from VRAM into on-chip cache for processing. So if you’re going to do all that work of reading in all those weights, you might as well apply them to a whole batch of input vectors.\n            <ul>\n              <li>At batch_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.</li>\n              <li>Let’s take a look:\n                <ul>\n                  <li>A100: 1935 GB/s memory bandwidth, 1248 TOPS</li>\n                  <li>MacBook M2: 100 GB/s, 7 TFLOPS</li>\n                </ul>\n              </li>\n              <li>The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.</li>\n              <li>The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.</li>\n              <li>In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.</li>\n            </ul>\n          </li>\n          <li>The reason we can’t naively use this fact to sample in chunks of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-425-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3435\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3436\"><span class=\"mi\" id=\"MathJax-Span-3437\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-425\">K</script> tokens at a time is that every <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-426-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>N</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3438\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.46em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3439\"><span class=\"msubsup\" id=\"MathJax-Span-3440\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3441\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"texatom\" id=\"MathJax-Span-3442\"><span class=\"mrow\" id=\"MathJax-Span-3443\"><span class=\"mi\" id=\"MathJax-Span-3444\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3445\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>N</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-426\">N^{th}</script> token depends on what token we sample at time at step <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-427-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3446\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.24em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3447\"><span class=\"mi\" id=\"MathJax-Span-3448\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3449\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mn\" id=\"MathJax-Span-3450\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi><mo>−</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-427\">N-1</script>. There is a serial dependency, so the baseline implementation just goes one by one left to right.</li>\n          <li>Now the clever idea is to use a small and cheap draft model to first generate a candidate sequence of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-428-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3451\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3452\"><span class=\"mi\" id=\"MathJax-Span-3453\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-428\">K</script> tokens – a “draft”. Then we feed all of these together through the big model in a batch. This is almost as fast as feeding in just one token, per the above. Then we go from left to right over the logits predicted by the model and sample tokens. Any sample that agrees with the draft allows us to immediately skip forward to the next token. If there is a disagreement then we throw the draft away and eat the cost of doing some throwaway work (sampling the draft and the forward passing for all the later tokens).</li>\n          <li>The reason this works in practice is that most of the time the draft tokens get accepted, because they are easy, so even a much smaller draft model gets them. As these easy tokens get accepted, we skip through those parts in leaps. The hard tokens where the big model disagrees “fall back” to original speed, but actually a bit slower because of all the extra work.</li>\n          <li>In summary, this one weird trick works because LLMs are memory bound at inference time, in the “batch size 1” setting of sampling a single sequence of interest, that a large fraction of “local LLM” use cases fall into. And because most tokens are “easy”.</li>\n          <li>More on this here: <a href=\"https://arxiv.org/abs/1811.03115\">Blockwise Parallel Decoding for Deep Autoregressive Models</a>, <a href=\"https://arxiv.org/abs/2302.01318\">Accelerating Large Language Model Decoding with Speculative Sampling</a>, and <a href=\"https://arxiv.org/abs/2211.17192\">Fast Inference from Transformers via Speculative Decoding</a></li>\n        </ul>\n      </li>\n      <li><strong>Inference architecture</strong>: The inference runs on a cluster of 128 GPUs. There are multiple of these clusters in multiple datacenters in different locations. It is done in 8-way tensor parallelism and 16-way pipeline parallelism. Each node of 8 GPUs has only ~130B parameters, or less than 30GB per GPU at FP16 and less than 15GB at FP8/int8. The model has 120 layers, so it fits in 15 different nodes. (Possibly the there are less layers on the first node since it needs to also compute the embeddings). According to these numbers: OpenAI should have trained on 2x the tokens if they were trying to go by Chinchilla’s optimal. This goes to show that they are struggling to get high quality data.</li>\n      <li><strong>Why no Fully Sharded Data Parallel (FSDP)?</strong> A possible reason for this could be that some of the hardware infra they secured is of an older generation. This is pretty common at local compute clusters as the organisation usually upgrade the infra in several “waves” to avoid a complete pause of operation. With such a high amount of pipeline parallelism it is very likely that they suffer from the “batch bubble”: slight idle time between batches.</li>\n      <li><strong>Dataset mixture</strong>: They trained on 13T tokens. CommonCrawl &amp; RefinedWeb are both 5T. Remove the duplication of tokens from multiple epochs and we get to a much reasonable number of “unaccounted for” tokens: the “secret” data – parts of it probably came from Twitter, Reddit, and YouTube. Some speculations are: LibGen (4M+ books), Sci-Hub (80M+ papers), all of GitHub. Part of the missing dataset could also be custom dataset of college textbooks collected by hand for as much courses as possible. This is very easy to convert to text form and than use <a href=\"../../../papers/#self-instruct-aligning-language-model-with-self-generated-instructions\">Self-Instruct</a> to transform it into instruction form. This creates the “illusion” that GPT-4 “is smart” no matter who uses it: for computer scientists, it can help you with your questions about P!=NP; for a philosophy major, it can totally talk to you about epistemology. There are also papers that try to extract by force memorized parts of books from GPT-4 to understand what it trained on. There are some books it knows so well that it had seen them for sure. Moreover, it even knows the unique ids of project Euler problems.</li>\n    </ul>\n<ul>\n          <li>Per <a href=\"https://twitter.com/karpathy/status/1697318534555336961\">Andrej Karpathy</a>, speculative sampling/decoding/execution for LLMs is an excellent inference-time optimization. It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-423-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3429\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3430\"><span class=\"mi\" id=\"MathJax-Span-3431\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-423\">K</script> input tokens in a batch (for larger <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-424-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3432\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3433\"><span class=\"mi\" id=\"MathJax-Span-3434\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-424\">K</script> than what might be obvious). This unintuitive fact is because sampling is heavily memory bound: most of the “work” is not doing compute, it is reading in the weights of the transformer from VRAM into on-chip cache for processing. So if you’re going to do all that work of reading in all those weights, you might as well apply them to a whole batch of input vectors.\n            <ul>\n              <li>At batch_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.</li>\n              <li>Let’s take a look:\n                <ul>\n                  <li>A100: 1935 GB/s memory bandwidth, 1248 TOPS</li>\n                  <li>MacBook M2: 100 GB/s, 7 TFLOPS</li>\n                </ul>\n              </li>\n              <li>The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.</li>\n              <li>The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.</li>\n              <li>In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.</li>\n            </ul>\n          </li>\n          <li>The reason we can’t naively use this fact to sample in chunks of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-425-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3435\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3436\"><span class=\"mi\" id=\"MathJax-Span-3437\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-425\">K</script> tokens at a time is that every <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-426-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>N</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3438\" style=\"width: 1.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.46em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3439\"><span class=\"msubsup\" id=\"MathJax-Span-3440\"><span style=\"display: inline-block; position: relative; width: 1.461em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.73em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3441\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"texatom\" id=\"MathJax-Span-3442\"><span class=\"mrow\" id=\"MathJax-Span-3443\"><span class=\"mi\" id=\"MathJax-Span-3444\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3445\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>N</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-426\">N^{th}</script> token depends on what token we sample at time at step <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-427-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3446\" style=\"width: 2.815em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.24em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3447\"><span class=\"mi\" id=\"MathJax-Span-3448\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3449\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">−</span><span class=\"mn\" id=\"MathJax-Span-3450\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi><mo>−</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-427\">N-1</script>. There is a serial dependency, so the baseline implementation just goes one by one left to right.</li>\n          <li>Now the clever idea is to use a small and cheap draft model to first generate a candidate sequence of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-428-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3451\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3452\"><span class=\"mi\" id=\"MathJax-Span-3453\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-428\">K</script> tokens – a “draft”. Then we feed all of these together through the big model in a batch. This is almost as fast as feeding in just one token, per the above. Then we go from left to right over the logits predicted by the model and sample tokens. Any sample that agrees with the draft allows us to immediately skip forward to the next token. If there is a disagreement then we throw the draft away and eat the cost of doing some throwaway work (sampling the draft and the forward passing for all the later tokens).</li>\n          <li>The reason this works in practice is that most of the time the draft tokens get accepted, because they are easy, so even a much smaller draft model gets them. As these easy tokens get accepted, we skip through those parts in leaps. The hard tokens where the big model disagrees “fall back” to original speed, but actually a bit slower because of all the extra work.</li>\n          <li>In summary, this one weird trick works because LLMs are memory bound at inference time, in the “batch size 1” setting of sampling a single sequence of interest, that a large fraction of “local LLM” use cases fall into. And because most tokens are “easy”.</li>\n          <li>More on this here: <a href=\"https://arxiv.org/abs/1811.03115\">Blockwise Parallel Decoding for Deep Autoregressive Models</a>, <a href=\"https://arxiv.org/abs/2302.01318\">Accelerating Large Language Model Decoding with Speculative Sampling</a>, and <a href=\"https://arxiv.org/abs/2211.17192\">Fast Inference from Transformers via Speculative Decoding</a></li>\n        </ul>\n<ul>\n              <li>At batch_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.</li>\n              <li>Let’s take a look:\n                <ul>\n                  <li>A100: 1935 GB/s memory bandwidth, 1248 TOPS</li>\n                  <li>MacBook M2: 100 GB/s, 7 TFLOPS</li>\n                </ul>\n              </li>\n              <li>The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.</li>\n              <li>The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.</li>\n              <li>In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.</li>\n            </ul>\n<ul>\n                  <li>A100: 1935 GB/s memory bandwidth, 1248 TOPS</li>\n                  <li>MacBook M2: 100 GB/s, 7 TFLOPS</li>\n                </ul>",
    "contentMarkdown": "*   Read our GPT-4 primer [here](../GPT-4).\n*   Per a [rumor](https://www.reddit.com/r/mlscaling/comments/14eowmw/gpt4_rumors_a_mixtureofexperts_w8_gpt3220bs/), GPT-4 might be an 8-way MoE model with 8 220B parameters (a total of 1.76T parameters).\n*   A Mixture of Experts (MoE) model essentially revolves around a router that directs questions to the appropriate expert. If GPT-4 does adopt the MoE approach, it would consist of eight specialist models each trained in a specific domain, like mathematics, history, storytelling, etc. When a question is posed, the router analyses it and seamlessly forwards it to the most suitable expert.\n*   The concept of MoE is quite prevalent (refer [Outrageously Large Neural Networks: the Sparsely-Gated Mixture-of-Experts Layer](../../../papers/#outrageously-large-neural-networks-the-sparsely-gated-mixture-of-experts-layer)), with Langchain’s high-level implementation of an [LLMRouterChain](https://python.langchain.com/docs/modules/chains/foundational/router), and notable low-level integrated examples like Google’s Switch Transformer (refer [Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity](../../../papers/#switch-transformers-scaling-to-trillion-parameter-models-with-simple-and-efficient-sparsity)).\n*   Per yet another [rumor](https://archive.is/2RQ8X#selection-449.1-1067.86), here are the specifics:\n    *   **Parameter count:** GPT-4 is more than 10x the size of GPT-3; with a total of ~1.8 trillion parameters across 120 layers.\n    *   **Architecture:** GPT-4 uses an MoE architecture; the main idea behind used an MoE model was to keep costs training/inference reasonable while ensuring great performance. In other words, it is not a dense transformer like, for instance, PaLM (or GPT-3). They utilizes 16 experts within their model, each is about ~111B parameters for MLP. 2 of these experts are routed per forward pass. There roughly ~55B shared parameters for attention.\n    *   **MoE routing:** While the literature talks a lot about advanced routing algorithms for choosing which experts to route each token to, OpenAI’s is allegedly quite simple, for the current GPT-4 model.\n    *   **Inference:** Each forward pass inference (generation of 1 token) only utilizes ~280B parameters and ~560 TFLOPs. This contrasts with the ~1.8 trillion parameters and ~3,700 TFLOP that would be required per forward pass of a purely dense model (vs. the MoE architecture that’s used).\n    *   **Dataset:** GPT-4 is trained on ~13T tokens. These are not unique tokens, but the total amount of tokens seen over all epochs. There are millions of instruction fine-tuning data samples from ScaleAI & internally (probably acquired through ChatGPT + their API before they changed the policy).\n    *   **Training epochs:** 2 epochs for text-based data and 4 for code-based data.\n    *   **Training paradigm:** For pre-training GPT-4 32K, they utilized an 8K context length. The 32K context version of GPT-4 was based on fine-tuning of the 8K after the pre-training. [Extending context is hard… but not impossible](https://kaiokendev.github.io/context) is a good reference on how to achieve this.\n    *   **Batch size:** The batch size was gradually ramped up over a number of days on the cluster, but by the end, OpenAI was using a batch size of 60 million! This, of course, is “only” a batch size of 7.5 million tokens per expert due to not every expert seeing all tokens. For the real batch size:\\*\\* Divide this number by the context width to get the real batch size.\n    *   **Parallelism strategies:** To parallelize across all their A100s GPUs, they utilized 8-way tensor parallelism as that is the limit for NVLink. Beyond that, they used 15-way pipeline parallelism. Also apparently they used DeepSpeed ZeRo Stage 1 or block-level FSDP.\n    *   **Training cost**: OpenAI’s training FLOPS for GPT-4 is ~2.15e25, on ~25,000 A100s for 90 to 100 days at about 32% to 36% MFU. Part of this extremely low utilization is due to an absurd number of failures requiring checkpoints that needed to be restarted from. If their cost in the cloud was about $1 per A100 hour, the training costs for this run alone would be about $63 million. Had H100s been used, pre-training could be done with ~8,192 H100s in ~55 days for $21.5 million at $2 per H100 hour.\n    *   **MoE tradeoffs**: There are multiple MoE tradeoffs taken; for example, MoE is incredibly difficult to deal with on inference because not every part of the model is utilized on every token generation. This means some parts may sit dormant when other parts are being used. When serving users, this really hurts utilization rates. Researchers have shown that using 64 to 128 experts achieves better loss than 16 experts, but that’s purely research. There are multiple reasons to go with fewer experts. One reason for OpenAI choosing 16 experts is because more experts are difficult to generalize at many tasks. More experts can also be more difficult to achieve convergence with. With such a large training run, OpenAI instead chose to be more conservative on the number of experts.\n    *   **GPT-4 inference cost**: GPT-4 costs 3x that of the 175B parameter DaVinci. This is largely due to the larger clusters required for GPT-4 and much lower utilization achieved. An estimate of it’s costs is $0.0049 cents per 1K tokens for 128 A100s to inference GPT-4 8K context width and $0.0021 cents per 1K tokens for 128 H100s to inference GPT-4 8K context width. It should be noted that they assume decent high utilization and keep batch sizes large.\n    *   **Multi-Query Attention**: GPT-4 uses MQA instead of MHA (MQA is a classic choice at this point). Because of that only 1 head is needed and memory capacity can be significantly reduced for the KV cache. Even then, the 32K context width GPT-4 definitely cannot run on 40GB A100s, and the 8K is capped on max batch size.\n    *   **Continuous batching**: OpenAI implements both variable batch sizes and continuous batching. This is so as to allow some level of maximum latency as well optimizing the inference costs.\n    *   **Vision multi-modal**: They have a separate vision encoder from the text encoder, with cross-attention. The architecture is similar to Google DeepMind’s [Flamingo](../../../papers/#flamingo-a-visual-language-model-for-few-shot-learning). This adds more parameters on top of the 1.8T text-only GPT-4. It is fine-tuned with another ~2 trillion tokens, after the text only pre-training. On the vision model, OpenAI wanted to train it from scratch, but it wasn’t mature enough, so they wanted to derisk it by starting with text. One of the primary purposes of this vision capability is for autonomous agents able to read web pages and transcribe what’s in images and video. Some of the data they train on is joint data (rendered LaTeX/text), screenshots of web pages, YouTube videos: sampling frames, and run Whisper around it to get transcript.\n    *   **Speculative decoding**: OpenAI might be using speculative decoding on GPT-4’s inference. The idea is to use a smaller faster model to decode several tokens in advance, and then feeds them into a large oracle model as a single batch. If the small model was right about its predictions (i.e., the larger model agrees), we can decode several tokens in a single batch. But if the larger model rejects the tokens predicted by the draft model then the rest of the batch is discarded. And we continue with the larger model. **The conspiracy theory that the new GPT-4 quality had been deteriorated might be simply because they are letting the oracle model accept lower probability sequences from the speculative decoding model.**\n        *   Per [Andrej Karpathy](https://twitter.com/karpathy/status/1697318534555336961), speculative sampling/decoding/execution for LLMs is an excellent inference-time optimization. It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on KKK input tokens in a batch (for larger KKK than what might be obvious). This unintuitive fact is because sampling is heavily memory bound: most of the “work” is not doing compute, it is reading in the weights of the transformer from VRAM into on-chip cache for processing. So if you’re going to do all that work of reading in all those weights, you might as well apply them to a whole batch of input vectors.\n            *   At batch\\_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.\n            *   Let’s take a look:\n                *   A100: 1935 GB/s memory bandwidth, 1248 TOPS\n                *   MacBook M2: 100 GB/s, 7 TFLOPS\n            *   The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.\n            *   The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.\n            *   In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.\n        *   The reason we can’t naively use this fact to sample in chunks of KKK tokens at a time is that every NthNthN^{th} token depends on what token we sample at time at step N−1N−1N-1. There is a serial dependency, so the baseline implementation just goes one by one left to right.\n        *   Now the clever idea is to use a small and cheap draft model to first generate a candidate sequence of KKK tokens – a “draft”. Then we feed all of these together through the big model in a batch. This is almost as fast as feeding in just one token, per the above. Then we go from left to right over the logits predicted by the model and sample tokens. Any sample that agrees with the draft allows us to immediately skip forward to the next token. If there is a disagreement then we throw the draft away and eat the cost of doing some throwaway work (sampling the draft and the forward passing for all the later tokens).\n        *   The reason this works in practice is that most of the time the draft tokens get accepted, because they are easy, so even a much smaller draft model gets them. As these easy tokens get accepted, we skip through those parts in leaps. The hard tokens where the big model disagrees “fall back” to original speed, but actually a bit slower because of all the extra work.\n        *   In summary, this one weird trick works because LLMs are memory bound at inference time, in the “batch size 1” setting of sampling a single sequence of interest, that a large fraction of “local LLM” use cases fall into. And because most tokens are “easy”.\n        *   More on this here: [Blockwise Parallel Decoding for Deep Autoregressive Models](https://arxiv.org/abs/1811.03115), [Accelerating Large Language Model Decoding with Speculative Sampling](https://arxiv.org/abs/2302.01318), and [Fast Inference from Transformers via Speculative Decoding](https://arxiv.org/abs/2211.17192)\n    *   **Inference architecture**: The inference runs on a cluster of 128 GPUs. There are multiple of these clusters in multiple datacenters in different locations. It is done in 8-way tensor parallelism and 16-way pipeline parallelism. Each node of 8 GPUs has only ~130B parameters, or less than 30GB per GPU at FP16 and less than 15GB at FP8/int8. The model has 120 layers, so it fits in 15 different nodes. (Possibly the there are less layers on the first node since it needs to also compute the embeddings). According to these numbers: OpenAI should have trained on 2x the tokens if they were trying to go by Chinchilla’s optimal. This goes to show that they are struggling to get high quality data.\n    *   **Why no Fully Sharded Data Parallel (FSDP)?** A possible reason for this could be that some of the hardware infra they secured is of an older generation. This is pretty common at local compute clusters as the organisation usually upgrade the infra in several “waves” to avoid a complete pause of operation. With such a high amount of pipeline parallelism it is very likely that they suffer from the “batch bubble”: slight idle time between batches.\n    *   **Dataset mixture**: They trained on 13T tokens. CommonCrawl & RefinedWeb are both 5T. Remove the duplication of tokens from multiple epochs and we get to a much reasonable number of “unaccounted for” tokens: the “secret” data – parts of it probably came from Twitter, Reddit, and YouTube. Some speculations are: LibGen (4M+ books), Sci-Hub (80M+ papers), all of GitHub. Part of the missing dataset could also be custom dataset of college textbooks collected by hand for as much courses as possible. This is very easy to convert to text form and than use [Self-Instruct](../../../papers/#self-instruct-aligning-language-model-with-self-generated-instructions) to transform it into instruction form. This creates the “illusion” that GPT-4 “is smart” no matter who uses it: for computer scientists, it can help you with your questions about P!=NP; for a philosophy major, it can totally talk to you about epistemology. There are also papers that try to extract by force memorized parts of books from GPT-4 to understand what it trained on. There are some books it knows so well that it had seen them for sure. Moreover, it even knows the unique ids of project Euler problems.\n\n*   **Parameter count:** GPT-4 is more than 10x the size of GPT-3; with a total of ~1.8 trillion parameters across 120 layers.\n*   **Architecture:** GPT-4 uses an MoE architecture; the main idea behind used an MoE model was to keep costs training/inference reasonable while ensuring great performance. In other words, it is not a dense transformer like, for instance, PaLM (or GPT-3). They utilizes 16 experts within their model, each is about ~111B parameters for MLP. 2 of these experts are routed per forward pass. There roughly ~55B shared parameters for attention.\n*   **MoE routing:** While the literature talks a lot about advanced routing algorithms for choosing which experts to route each token to, OpenAI’s is allegedly quite simple, for the current GPT-4 model.\n*   **Inference:** Each forward pass inference (generation of 1 token) only utilizes ~280B parameters and ~560 TFLOPs. This contrasts with the ~1.8 trillion parameters and ~3,700 TFLOP that would be required per forward pass of a purely dense model (vs. the MoE architecture that’s used).\n*   **Dataset:** GPT-4 is trained on ~13T tokens. These are not unique tokens, but the total amount of tokens seen over all epochs. There are millions of instruction fine-tuning data samples from ScaleAI & internally (probably acquired through ChatGPT + their API before they changed the policy).\n*   **Training epochs:** 2 epochs for text-based data and 4 for code-based data.\n*   **Training paradigm:** For pre-training GPT-4 32K, they utilized an 8K context length. The 32K context version of GPT-4 was based on fine-tuning of the 8K after the pre-training. [Extending context is hard… but not impossible](https://kaiokendev.github.io/context) is a good reference on how to achieve this.\n*   **Batch size:** The batch size was gradually ramped up over a number of days on the cluster, but by the end, OpenAI was using a batch size of 60 million! This, of course, is “only” a batch size of 7.5 million tokens per expert due to not every expert seeing all tokens. For the real batch size:\\*\\* Divide this number by the context width to get the real batch size.\n*   **Parallelism strategies:** To parallelize across all their A100s GPUs, they utilized 8-way tensor parallelism as that is the limit for NVLink. Beyond that, they used 15-way pipeline parallelism. Also apparently they used DeepSpeed ZeRo Stage 1 or block-level FSDP.\n*   **Training cost**: OpenAI’s training FLOPS for GPT-4 is ~2.15e25, on ~25,000 A100s for 90 to 100 days at about 32% to 36% MFU. Part of this extremely low utilization is due to an absurd number of failures requiring checkpoints that needed to be restarted from. If their cost in the cloud was about $1 per A100 hour, the training costs for this run alone would be about $63 million. Had H100s been used, pre-training could be done with ~8,192 H100s in ~55 days for $21.5 million at $2 per H100 hour.\n*   **MoE tradeoffs**: There are multiple MoE tradeoffs taken; for example, MoE is incredibly difficult to deal with on inference because not every part of the model is utilized on every token generation. This means some parts may sit dormant when other parts are being used. When serving users, this really hurts utilization rates. Researchers have shown that using 64 to 128 experts achieves better loss than 16 experts, but that’s purely research. There are multiple reasons to go with fewer experts. One reason for OpenAI choosing 16 experts is because more experts are difficult to generalize at many tasks. More experts can also be more difficult to achieve convergence with. With such a large training run, OpenAI instead chose to be more conservative on the number of experts.\n*   **GPT-4 inference cost**: GPT-4 costs 3x that of the 175B parameter DaVinci. This is largely due to the larger clusters required for GPT-4 and much lower utilization achieved. An estimate of it’s costs is $0.0049 cents per 1K tokens for 128 A100s to inference GPT-4 8K context width and $0.0021 cents per 1K tokens for 128 H100s to inference GPT-4 8K context width. It should be noted that they assume decent high utilization and keep batch sizes large.\n*   **Multi-Query Attention**: GPT-4 uses MQA instead of MHA (MQA is a classic choice at this point). Because of that only 1 head is needed and memory capacity can be significantly reduced for the KV cache. Even then, the 32K context width GPT-4 definitely cannot run on 40GB A100s, and the 8K is capped on max batch size.\n*   **Continuous batching**: OpenAI implements both variable batch sizes and continuous batching. This is so as to allow some level of maximum latency as well optimizing the inference costs.\n*   **Vision multi-modal**: They have a separate vision encoder from the text encoder, with cross-attention. The architecture is similar to Google DeepMind’s [Flamingo](../../../papers/#flamingo-a-visual-language-model-for-few-shot-learning). This adds more parameters on top of the 1.8T text-only GPT-4. It is fine-tuned with another ~2 trillion tokens, after the text only pre-training. On the vision model, OpenAI wanted to train it from scratch, but it wasn’t mature enough, so they wanted to derisk it by starting with text. One of the primary purposes of this vision capability is for autonomous agents able to read web pages and transcribe what’s in images and video. Some of the data they train on is joint data (rendered LaTeX/text), screenshots of web pages, YouTube videos: sampling frames, and run Whisper around it to get transcript.\n*   **Speculative decoding**: OpenAI might be using speculative decoding on GPT-4’s inference. The idea is to use a smaller faster model to decode several tokens in advance, and then feeds them into a large oracle model as a single batch. If the small model was right about its predictions (i.e., the larger model agrees), we can decode several tokens in a single batch. But if the larger model rejects the tokens predicted by the draft model then the rest of the batch is discarded. And we continue with the larger model. **The conspiracy theory that the new GPT-4 quality had been deteriorated might be simply because they are letting the oracle model accept lower probability sequences from the speculative decoding model.**\n    *   Per [Andrej Karpathy](https://twitter.com/karpathy/status/1697318534555336961), speculative sampling/decoding/execution for LLMs is an excellent inference-time optimization. It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on KKK input tokens in a batch (for larger KKK than what might be obvious). This unintuitive fact is because sampling is heavily memory bound: most of the “work” is not doing compute, it is reading in the weights of the transformer from VRAM into on-chip cache for processing. So if you’re going to do all that work of reading in all those weights, you might as well apply them to a whole batch of input vectors.\n        *   At batch\\_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.\n        *   Let’s take a look:\n            *   A100: 1935 GB/s memory bandwidth, 1248 TOPS\n            *   MacBook M2: 100 GB/s, 7 TFLOPS\n        *   The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.\n        *   The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.\n        *   In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.\n    *   The reason we can’t naively use this fact to sample in chunks of KKK tokens at a time is that every NthNthN^{th} token depends on what token we sample at time at step N−1N−1N-1. There is a serial dependency, so the baseline implementation just goes one by one left to right.\n    *   Now the clever idea is to use a small and cheap draft model to first generate a candidate sequence of KKK tokens – a “draft”. Then we feed all of these together through the big model in a batch. This is almost as fast as feeding in just one token, per the above. Then we go from left to right over the logits predicted by the model and sample tokens. Any sample that agrees with the draft allows us to immediately skip forward to the next token. If there is a disagreement then we throw the draft away and eat the cost of doing some throwaway work (sampling the draft and the forward passing for all the later tokens).\n    *   The reason this works in practice is that most of the time the draft tokens get accepted, because they are easy, so even a much smaller draft model gets them. As these easy tokens get accepted, we skip through those parts in leaps. The hard tokens where the big model disagrees “fall back” to original speed, but actually a bit slower because of all the extra work.\n    *   In summary, this one weird trick works because LLMs are memory bound at inference time, in the “batch size 1” setting of sampling a single sequence of interest, that a large fraction of “local LLM” use cases fall into. And because most tokens are “easy”.\n    *   More on this here: [Blockwise Parallel Decoding for Deep Autoregressive Models](https://arxiv.org/abs/1811.03115), [Accelerating Large Language Model Decoding with Speculative Sampling](https://arxiv.org/abs/2302.01318), and [Fast Inference from Transformers via Speculative Decoding](https://arxiv.org/abs/2211.17192)\n*   **Inference architecture**: The inference runs on a cluster of 128 GPUs. There are multiple of these clusters in multiple datacenters in different locations. It is done in 8-way tensor parallelism and 16-way pipeline parallelism. Each node of 8 GPUs has only ~130B parameters, or less than 30GB per GPU at FP16 and less than 15GB at FP8/int8. The model has 120 layers, so it fits in 15 different nodes. (Possibly the there are less layers on the first node since it needs to also compute the embeddings). According to these numbers: OpenAI should have trained on 2x the tokens if they were trying to go by Chinchilla’s optimal. This goes to show that they are struggling to get high quality data.\n*   **Why no Fully Sharded Data Parallel (FSDP)?** A possible reason for this could be that some of the hardware infra they secured is of an older generation. This is pretty common at local compute clusters as the organisation usually upgrade the infra in several “waves” to avoid a complete pause of operation. With such a high amount of pipeline parallelism it is very likely that they suffer from the “batch bubble”: slight idle time between batches.\n*   **Dataset mixture**: They trained on 13T tokens. CommonCrawl & RefinedWeb are both 5T. Remove the duplication of tokens from multiple epochs and we get to a much reasonable number of “unaccounted for” tokens: the “secret” data – parts of it probably came from Twitter, Reddit, and YouTube. Some speculations are: LibGen (4M+ books), Sci-Hub (80M+ papers), all of GitHub. Part of the missing dataset could also be custom dataset of college textbooks collected by hand for as much courses as possible. This is very easy to convert to text form and than use [Self-Instruct](../../../papers/#self-instruct-aligning-language-model-with-self-generated-instructions) to transform it into instruction form. This creates the “illusion” that GPT-4 “is smart” no matter who uses it: for computer scientists, it can help you with your questions about P!=NP; for a philosophy major, it can totally talk to you about epistemology. There are also papers that try to extract by force memorized parts of books from GPT-4 to understand what it trained on. There are some books it knows so well that it had seen them for sure. Moreover, it even knows the unique ids of project Euler problems.\n\n*   Per [Andrej Karpathy](https://twitter.com/karpathy/status/1697318534555336961), speculative sampling/decoding/execution for LLMs is an excellent inference-time optimization. It hinges on the following unintuitive observation: forwarding an LLM on a single input token takes about as much time as forwarding an LLM on KKK input tokens in a batch (for larger KKK than what might be obvious). This unintuitive fact is because sampling is heavily memory bound: most of the “work” is not doing compute, it is reading in the weights of the transformer from VRAM into on-chip cache for processing. So if you’re going to do all that work of reading in all those weights, you might as well apply them to a whole batch of input vectors.\n    *   At batch\\_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.\n    *   Let’s take a look:\n        *   A100: 1935 GB/s memory bandwidth, 1248 TOPS\n        *   MacBook M2: 100 GB/s, 7 TFLOPS\n    *   The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.\n    *   The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.\n    *   In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.\n*   The reason we can’t naively use this fact to sample in chunks of KKK tokens at a time is that every NthNthN^{th} token depends on what token we sample at time at step N−1N−1N-1. There is a serial dependency, so the baseline implementation just goes one by one left to right.\n*   Now the clever idea is to use a small and cheap draft model to first generate a candidate sequence of KKK tokens – a “draft”. Then we feed all of these together through the big model in a batch. This is almost as fast as feeding in just one token, per the above. Then we go from left to right over the logits predicted by the model and sample tokens. Any sample that agrees with the draft allows us to immediately skip forward to the next token. If there is a disagreement then we throw the draft away and eat the cost of doing some throwaway work (sampling the draft and the forward passing for all the later tokens).\n*   The reason this works in practice is that most of the time the draft tokens get accepted, because they are easy, so even a much smaller draft model gets them. As these easy tokens get accepted, we skip through those parts in leaps. The hard tokens where the big model disagrees “fall back” to original speed, but actually a bit slower because of all the extra work.\n*   In summary, this one weird trick works because LLMs are memory bound at inference time, in the “batch size 1” setting of sampling a single sequence of interest, that a large fraction of “local LLM” use cases fall into. And because most tokens are “easy”.\n*   More on this here: [Blockwise Parallel Decoding for Deep Autoregressive Models](https://arxiv.org/abs/1811.03115), [Accelerating Large Language Model Decoding with Speculative Sampling](https://arxiv.org/abs/2302.01318), and [Fast Inference from Transformers via Speculative Decoding](https://arxiv.org/abs/2211.17192)\n\n*   At batch\\_size=1 (i.e. just generating a single stream of prediction on your computer), the inference is super duper memory-bound. The on-chip compute units are twiddling their thumbs while sucking model weights through a straw from DRAM. Every individual weight that is expensively loaded from DRAM onto the chip is only used for a single instant multiply to process each new input token. So the stat to look at is not FLOPS but the memory bandwidth.\n*   Let’s take a look:\n    *   A100: 1935 GB/s memory bandwidth, 1248 TOPS\n    *   MacBook M2: 100 GB/s, 7 TFLOPS\n*   The compute is ~200X but the memory bandwidth only ~20X. So the little M2 chip that could will only be about ~20X slower than a mighty A100. This is ~10X faster than you might naively expect just looking at ops.\n*   The situation becomes a lot more different when you inference at a very high batch size (e.g. ~160+), such as when you’re hosting an LLM engine simultaneously serving a lot of parallel requests. Or in training, where you aren’t forced to go serially token by token and can parallelize across both batch and time dimension, because the next token targets (labels) are known. In these cases, once you load the weights into on-chip cache and pay that large fixed cost, you can re-use them across many input examples and reach ~50%+ utilization, actually making those FLOPS count.\n*   In summary, why is LLM inference surprisingly fast on your MacBook? If all you want to do is batch 1 inference (i.e. a single “stream” of generation), only the memory bandwidth matters. And the memory bandwidth gap between chips is a lot smaller, and has been a lot harder to scale compared to flops.\n\n*   A100: 1935 GB/s memory bandwidth, 1248 TOPS\n*   MacBook M2: 100 GB/s, 7 TFLOPS",
    "contentLength": 62504,
    "wordCount": 5410,
    "hasCode": false,
    "hasMath": true,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#gpt-4"
  },
  {
    "id": "ai-mixture-of-experts-mixtral-mistrals-8x7b-moe-model-70",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Popular MoE Models",
    "title": "Mixtral: Mistral’s 8x7B MoE Model",
    "order": 70,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>Mixtral 8x7B (56B params) from Mistral follows a Mixture of Experts (MoE) architecture, consisting of 8x 7B experts. With 8 experts and a router network that selects two of them at every layer for the inference of each token, it looks directly inspired from rumors about GPT-4’s architecture. This information can be derived from the model metadata:</li>\n</ul>\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><div><button class=\"btn-copy\" data-clipboard-action=\"copy\" data-clipboard-target=\"#code0\"><img src=\"https://aman.ai/images/copy.png\" style=\"margin:0; border:none; padding:2px 0px; width:100%; height:18px; width:18px;\"></button></div><code id=\"code0\"><span class=\"p\">{</span><span class=\"s\">\"dim\"</span><span class=\"p\">:</span> <span class=\"mi\">4096</span><span class=\"p\">,</span> <span class=\"s\">\"n_layers\"</span><span class=\"p\">:</span> <span class=\"mi\">32</span><span class=\"p\">,</span> <span class=\"s\">\"head_dim\"</span><span class=\"p\">:</span> <span class=\"mi\">128</span><span class=\"p\">,</span> <span class=\"s\">\"hidden_dim\"</span><span class=\"p\">:</span> <span class=\"mi\">14336</span><span class=\"p\">,</span> <span class=\"s\">\"n_heads\"</span><span class=\"p\">:</span> <span class=\"mi\">32</span><span class=\"p\">,</span> <span class=\"s\">\"n_kv_heads\"</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">,</span> <span class=\"s\">\"norm_eps\"</span><span class=\"p\">:</span> <span class=\"mf\">1e-05</span><span class=\"p\">,</span> <span class=\"s\">\"vocab_size\"</span><span class=\"p\">:</span> <span class=\"mi\">32000</span><span class=\"p\">,</span> <span class=\"s\">\"moe\"</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s\">\"num_experts_per_tok\"</span><span class=\"p\">:</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"s\">\"num_experts\"</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">}}</span>\n</code></pre></div></div>\n<pre class=\"highlight\"><div><button class=\"btn-copy\" data-clipboard-action=\"copy\" data-clipboard-target=\"#code0\"><img src=\"https://aman.ai/images/copy.png\" style=\"margin:0; border:none; padding:2px 0px; width:100%; height:18px; width:18px;\"></button></div><code id=\"code0\"><span class=\"p\">{</span><span class=\"s\">\"dim\"</span><span class=\"p\">:</span> <span class=\"mi\">4096</span><span class=\"p\">,</span> <span class=\"s\">\"n_layers\"</span><span class=\"p\">:</span> <span class=\"mi\">32</span><span class=\"p\">,</span> <span class=\"s\">\"head_dim\"</span><span class=\"p\">:</span> <span class=\"mi\">128</span><span class=\"p\">,</span> <span class=\"s\">\"hidden_dim\"</span><span class=\"p\">:</span> <span class=\"mi\">14336</span><span class=\"p\">,</span> <span class=\"s\">\"n_heads\"</span><span class=\"p\">:</span> <span class=\"mi\">32</span><span class=\"p\">,</span> <span class=\"s\">\"n_kv_heads\"</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">,</span> <span class=\"s\">\"norm_eps\"</span><span class=\"p\">:</span> <span class=\"mf\">1e-05</span><span class=\"p\">,</span> <span class=\"s\">\"vocab_size\"</span><span class=\"p\">:</span> <span class=\"mi\">32000</span><span class=\"p\">,</span> <span class=\"s\">\"moe\"</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s\">\"num_experts_per_tok\"</span><span class=\"p\">:</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"s\">\"num_experts\"</span><span class=\"p\">:</span> <span class=\"mi\">8</span><span class=\"p\">}}</span>\n</code></pre>\n<ul>\n  <li>From GPT-4 leaks, we can speculate that GPT-4 is a MoE model with 8 experts, each with 111B parameters of their own and 55B shared attention parameters (166B parameters per model). For the inference of each token, also only 2 experts are used.</li>\n  <li>Since the model size (87GB) is smaller than 8x Mistral 7B (8*15GB=120GB), we could assume that the new model uses the same architecture as Mistral 7B but the attention parameters are shared, reducing the naïve 8x7B model size estimation.</li>\n  <li>The conclusion is that (probably) Mistral 8x7B uses a very similar architecture to that of GPT-4, but scaled down:\n    <ul>\n      <li>8 total experts instead of 16 (2x reduction).</li>\n      <li>7B parameters per expert instead of 166B (24x reduction).</li>\n      <li>42B total parameters (estimated) instead of 1.8T (42x reduction).</li>\n      <li>Free to use under Apache 2.0 license</li>\n      <li>Outperforms Llama 2 70B with 6x faster inference.</li>\n      <li>Matches or outperforms GPT-3.5</li>\n      <li>Multilingual: vastly outperforms LLaMA 2 70B on French, Italian, German and Spanish</li>\n      <li>Same 32K context as the original GPT-4.</li>\n    </ul>\n  </li>\n  <li>Each layer in a 8x MoE model has its FFN split into 8 chunks and a router picks 2 of them, while the attention weights are always used in full for each token. This means that if the new mistral model uses 5B parameters for the attention, you will use 5+(42-5)/4 = 14.25B params per forward pass.</li>\n  <li>Mixtral is basically 8 models in a trenchcoat: the feedforward layers of the decoder blocks are divided into 8 experts, and for each token, a router will decide which 2 experts to allocate the processing to. The advantage of this architecture is that even though you have <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-429-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>7</mn><mo>&amp;#x00D7;</mo><mn>8</mn><mi>B</mi><mo>=</mo><mn>47</mn><mi>B</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3454\" style=\"width: 6.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1005.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3455\"><span class=\"mn\" id=\"MathJax-Span-3456\" style=\"font-family: STIXGeneral-Regular;\">7</span><span class=\"mo\" id=\"MathJax-Span-3457\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">×</span><span class=\"mn\" id=\"MathJax-Span-3458\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">8</span><span class=\"mi\" id=\"MathJax-Span-3459\" style=\"font-family: STIXGeneral-Italic;\">B</span><span class=\"mo\" id=\"MathJax-Span-3460\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3461\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">47</span><span class=\"mi\" id=\"MathJax-Span-3462\" style=\"font-family: STIXGeneral-Italic;\">B</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mn>7</mn><mo>×</mo><mn>8</mn><mi>B</mi><mo>=</mo><mn>47</mn><mi>B</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-429\">7 \\times 8B =  47B</script> parameters in total (considering shared parameters which are not unique to each expery), the model is much cheaper and fast to run since only <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-430-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mfrac><mn>2</mn><mn>8</mn></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3463\" style=\"width: 0.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1000.68em, 2.711em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3464\"><span class=\"mfrac\" id=\"MathJax-Span-3465\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.32em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-3466\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.32em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-3467\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">8</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.47em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.471em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.559em; border-left: 0px solid; width: 0px; height: 1.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mfrac><mn>2</mn><mn>8</mn></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-430\">\\frac{2}{8}</script> experts are activated for each prediction.</li>\n</ul>\n<ul>\n      <li>8 total experts instead of 16 (2x reduction).</li>\n      <li>7B parameters per expert instead of 166B (24x reduction).</li>\n      <li>42B total parameters (estimated) instead of 1.8T (42x reduction).</li>\n      <li>Free to use under Apache 2.0 license</li>\n      <li>Outperforms Llama 2 70B with 6x faster inference.</li>\n      <li>Matches or outperforms GPT-3.5</li>\n      <li>Multilingual: vastly outperforms LLaMA 2 70B on French, Italian, German and Spanish</li>\n      <li>Same 32K context as the original GPT-4.</li>\n    </ul>\n<blockquote>\n  <p>But how do you maintain good performance with only <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-431-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mfrac><mn>1</mn><mn>4</mn></mfrac><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3468\" style=\"width: 1.623em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.345em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.975em, 1001.35em, 2.688em, -999.998em); top: -2.174em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3469\"><span class=\"msubsup\" id=\"MathJax-Span-3470\"><span style=\"display: inline-block; position: relative; width: 1.345em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.965em, 1000.7em, 4.493em, -999.998em); top: -3.979em; left: 0em;\"><span class=\"mfrac\" id=\"MathJax-Span-3471\"><span style=\"display: inline-block; position: relative; width: 0.465em; height: 0px; margin-right: 0.141em; margin-left: 0.141em;\"><span style=\"position: absolute; clip: rect(3.382em, 1000.28em, 4.123em, -999.998em); top: -4.396em; left: 50%; margin-left: -0.183em;\"><span class=\"mn\" id=\"MathJax-Span-3472\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span><span style=\"position: absolute; clip: rect(3.382em, 1000.33em, 4.123em, -999.998em); top: -3.609em; left: 50%; margin-left: -0.183em;\"><span class=\"mn\" id=\"MathJax-Span-3473\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">4</span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span><span style=\"position: absolute; clip: rect(0.882em, 1000.47em, 1.206em, -999.998em); top: -1.294em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.465em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.067em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span><span style=\"position: absolute; top: -4.581em; left: 0.697em;\"><span class=\"texatom\" id=\"MathJax-Span-3474\"><span class=\"mrow\" id=\"MathJax-Span-3475\"><span class=\"mi\" id=\"MathJax-Span-3476\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.002em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3477\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.178em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.892em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mfrac><mn>1</mn><mn>4</mn></mfrac><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-431\">\\frac{1}{4}^{th}</script> of your model running at one time? The image below <a href=\"https://www.linkedin.com/in/a-roucher/\">(source)</a> gives us a view of the answer: there’s a marked specialization between experts, with one being stronger on logic, the other on history, and so on. The router knows which one is good at each subject, and like an excellent TV host, it carefully pick its experts to always get a good answer.</p>\n</blockquote>\n<p>But how do you maintain good performance with only <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-431-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mfrac><mn>1</mn><mn>4</mn></mfrac><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3468\" style=\"width: 1.623em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.345em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.975em, 1001.35em, 2.688em, -999.998em); top: -2.174em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3469\"><span class=\"msubsup\" id=\"MathJax-Span-3470\"><span style=\"display: inline-block; position: relative; width: 1.345em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.965em, 1000.7em, 4.493em, -999.998em); top: -3.979em; left: 0em;\"><span class=\"mfrac\" id=\"MathJax-Span-3471\"><span style=\"display: inline-block; position: relative; width: 0.465em; height: 0px; margin-right: 0.141em; margin-left: 0.141em;\"><span style=\"position: absolute; clip: rect(3.382em, 1000.28em, 4.123em, -999.998em); top: -4.396em; left: 50%; margin-left: -0.183em;\"><span class=\"mn\" id=\"MathJax-Span-3472\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span><span style=\"position: absolute; clip: rect(3.382em, 1000.33em, 4.123em, -999.998em); top: -3.609em; left: 50%; margin-left: -0.183em;\"><span class=\"mn\" id=\"MathJax-Span-3473\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">4</span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span><span style=\"position: absolute; clip: rect(0.882em, 1000.47em, 1.206em, -999.998em); top: -1.294em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.465em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.067em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span><span style=\"position: absolute; top: -4.581em; left: 0.697em;\"><span class=\"texatom\" id=\"MathJax-Span-3474\"><span class=\"mrow\" id=\"MathJax-Span-3475\"><span class=\"mi\" id=\"MathJax-Span-3476\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.002em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3477\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 3.984em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.178em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 1.892em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mfrac><mn>1</mn><mn>4</mn></mfrac><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-431\">\\frac{1}{4}^{th}</script> of your model running at one time? The image below <a href=\"https://www.linkedin.com/in/a-roucher/\">(source)</a> gives us a view of the answer: there’s a marked specialization between experts, with one being stronger on logic, the other on history, and so on. The router knows which one is good at each subject, and like an excellent TV host, it carefully pick its experts to always get a good answer.</p>\n<p><img src=\"/primers/ai/assets/mixture-of-experts/MoEexperts.jpeg\" alt=\"\"></p>\n<ul>\n  <li>Mistral has also released Mixtral 8x7B Instruct v0.1 trained using supervised fine-tuning and direct preference optimization (DPO). It scores 8.3 on MT-Bench making it the best open-source model, with performance comparable to GPT3.5.</li>\n  <li>Mistral offers three chat endpoints with competitive pricing via Mistral AI La Plateforme:\n    <ul>\n      <li>Mistral-tiny: Mistral 7B Instruct v0.2, upgraded base model with higher context length 8K <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-432-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3478\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.94em, 2.294em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3479\"><span class=\"mo\" id=\"MathJax-Span-3480\" style=\"font-family: STIXGeneral-Regular;\">→</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: 0.003em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">→</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-432\">\\rightarrow</script> 32K and better finetuning, 6.84 <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-433-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3481\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.94em, 2.294em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3482\"><span class=\"mo\" id=\"MathJax-Span-3483\" style=\"font-family: STIXGeneral-Regular;\">→</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: 0.003em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">→</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-433\">\\rightarrow</script> 7.61 on MT Bench.</li>\n      <li>Mistral-small: Mistral 8x7B Instruct v0.1, matches or exceeds GPT-3.5 performance, multilingual.</li>\n      <li>Mistral-medium: Outperforms GPT-3.5 on all metrics, multilingual.</li>\n    </ul>\n  </li>\n  <li>They’ve also announced Mistral-embed, an embedding model with a 1024 embedding dimension, which achieves 55.26 on MTEB.</li>\n  <li>Refer <a href=\"https://youtu.be/ccBMRryxGog?si=QPmlkNMIDFnRTJGR&amp;t=1038\">MoE Explanation</a>.</li>\n  <li><a href=\"https://mistral.ai/news/mixtral-of-experts/\">Blog</a>; <a href=\"https://mistral.ai/news/la-plateforme/\">La Plateforme</a>; <a href=\"https://huggingface.co/mistralai/Mixtral-8x7B-v0.1\">Mixtral-8x7B-v0.1 Base model</a>; <a href=\"https://huggingface.co/mistralai/Mixtral-8x7B-Instruct-v0.1\">Mixtral-8x7B-v0.1 Instruct model</a>.</li>\n</ul>\n<ul>\n      <li>Mistral-tiny: Mistral 7B Instruct v0.2, upgraded base model with higher context length 8K <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-432-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3478\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.94em, 2.294em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3479\"><span class=\"mo\" id=\"MathJax-Span-3480\" style=\"font-family: STIXGeneral-Regular;\">→</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: 0.003em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">→</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-432\">\\rightarrow</script> 32K and better finetuning, 6.84 <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-433-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3481\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.94em, 2.294em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3482\"><span class=\"mo\" id=\"MathJax-Span-3483\" style=\"font-family: STIXGeneral-Regular;\">→</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: 0.003em; border-left: 0px solid; width: 0px; height: 0.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mo stretchy=\"false\">→</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-433\">\\rightarrow</script> 7.61 on MT Bench.</li>\n      <li>Mistral-small: Mistral 8x7B Instruct v0.1, matches or exceeds GPT-3.5 performance, multilingual.</li>\n      <li>Mistral-medium: Outperforms GPT-3.5 on all metrics, multilingual.</li>\n    </ul>\n<h4 id=\"results\">Results</h4>\n<ul>\n  <li>Benchmark results comparing against the other SOTA OSS models as of this writing: LLaMA-2, Yi-34B (from 01.AI led by Kai-Fu Lee), and DeepSeek-67B (a strong model made by a quant trading company).</li>\n</ul>\n<p><img src=\"/primers/ai/assets/LLM/MMoE.jpeg\" alt=\"\"></p>",
    "contentMarkdown": "*   Mixtral 8x7B (56B params) from Mistral follows a Mixture of Experts (MoE) architecture, consisting of 8x 7B experts. With 8 experts and a router network that selects two of them at every layer for the inference of each token, it looks directly inspired from rumors about GPT-4’s architecture. This information can be derived from the model metadata:\n\n![](https://aman.ai/images/copy.png)\n\n`{\"dim\": 4096, \"n_layers\": 32, \"head_dim\": 128, \"hidden_dim\": 14336, \"n_heads\": 32, \"n_kv_heads\": 8, \"norm_eps\": 1e-05, \"vocab_size\": 32000, \"moe\": {\"num_experts_per_tok\": 2, \"num_experts\": 8}}`\n\n![](https://aman.ai/images/copy.png)\n\n`{\"dim\": 4096, \"n_layers\": 32, \"head_dim\": 128, \"hidden_dim\": 14336, \"n_heads\": 32, \"n_kv_heads\": 8, \"norm_eps\": 1e-05, \"vocab_size\": 32000, \"moe\": {\"num_experts_per_tok\": 2, \"num_experts\": 8}}`\n\n*   From GPT-4 leaks, we can speculate that GPT-4 is a MoE model with 8 experts, each with 111B parameters of their own and 55B shared attention parameters (166B parameters per model). For the inference of each token, also only 2 experts are used.\n*   Since the model size (87GB) is smaller than 8x Mistral 7B (8\\*15GB=120GB), we could assume that the new model uses the same architecture as Mistral 7B but the attention parameters are shared, reducing the naïve 8x7B model size estimation.\n*   The conclusion is that (probably) Mistral 8x7B uses a very similar architecture to that of GPT-4, but scaled down:\n    *   8 total experts instead of 16 (2x reduction).\n    *   7B parameters per expert instead of 166B (24x reduction).\n    *   42B total parameters (estimated) instead of 1.8T (42x reduction).\n    *   Free to use under Apache 2.0 license\n    *   Outperforms Llama 2 70B with 6x faster inference.\n    *   Matches or outperforms GPT-3.5\n    *   Multilingual: vastly outperforms LLaMA 2 70B on French, Italian, German and Spanish\n    *   Same 32K context as the original GPT-4.\n*   Each layer in a 8x MoE model has its FFN split into 8 chunks and a router picks 2 of them, while the attention weights are always used in full for each token. This means that if the new mistral model uses 5B parameters for the attention, you will use 5+(42-5)/4 = 14.25B params per forward pass.\n*   Mixtral is basically 8 models in a trenchcoat: the feedforward layers of the decoder blocks are divided into 8 experts, and for each token, a router will decide which 2 experts to allocate the processing to. The advantage of this architecture is that even though you have 7×8B\\=47B7×8B\\=47B7 \\\\times 8B = 47B parameters in total (considering shared parameters which are not unique to each expery), the model is much cheaper and fast to run since only 2828\\\\frac{2}{8} experts are activated for each prediction.\n\n*   8 total experts instead of 16 (2x reduction).\n*   7B parameters per expert instead of 166B (24x reduction).\n*   42B total parameters (estimated) instead of 1.8T (42x reduction).\n*   Free to use under Apache 2.0 license\n*   Outperforms Llama 2 70B with 6x faster inference.\n*   Matches or outperforms GPT-3.5\n*   Multilingual: vastly outperforms LLaMA 2 70B on French, Italian, German and Spanish\n*   Same 32K context as the original GPT-4.\n\n> But how do you maintain good performance with only 14th14th\\\\frac{1}{4}^{th} of your model running at one time? The image below [(source)](https://www.linkedin.com/in/a-roucher/) gives us a view of the answer: there’s a marked specialization between experts, with one being stronger on logic, the other on history, and so on. The router knows which one is good at each subject, and like an excellent TV host, it carefully pick its experts to always get a good answer.\n\nBut how do you maintain good performance with only 14th14th\\\\frac{1}{4}^{th} of your model running at one time? The image below [(source)](https://www.linkedin.com/in/a-roucher/) gives us a view of the answer: there’s a marked specialization between experts, with one being stronger on logic, the other on history, and so on. The router knows which one is good at each subject, and like an excellent TV host, it carefully pick its experts to always get a good answer.\n\n![](/primers/ai/assets/mixture-of-experts/MoEexperts.jpeg)\n\n*   Mistral has also released Mixtral 8x7B Instruct v0.1 trained using supervised fine-tuning and direct preference optimization (DPO). It scores 8.3 on MT-Bench making it the best open-source model, with performance comparable to GPT3.5.\n*   Mistral offers three chat endpoints with competitive pricing via Mistral AI La Plateforme:\n    *   Mistral-tiny: Mistral 7B Instruct v0.2, upgraded base model with higher context length 8K →→\\\\rightarrow 32K and better finetuning, 6.84 →→\\\\rightarrow 7.61 on MT Bench.\n    *   Mistral-small: Mistral 8x7B Instruct v0.1, matches or exceeds GPT-3.5 performance, multilingual.\n    *   Mistral-medium: Outperforms GPT-3.5 on all metrics, multilingual.\n*   They’ve also announced Mistral-embed, an embedding model with a 1024 embedding dimension, which achieves 55.26 on MTEB.\n*   Refer [MoE Explanation](https://youtu.be/ccBMRryxGog?si=QPmlkNMIDFnRTJGR&t=1038).\n*   [Blog](https://mistral.ai/news/mixtral-of-experts/); [La Plateforme](https://mistral.ai/news/la-plateforme/); [Mixtral-8x7B-v0.1 Base model](https://huggingface.co/mistralai/Mixtral-8x7B-v0.1); [Mixtral-8x7B-v0.1 Instruct model](https://huggingface.co/mistralai/Mixtral-8x7B-Instruct-v0.1).\n\n*   Mistral-tiny: Mistral 7B Instruct v0.2, upgraded base model with higher context length 8K →→\\\\rightarrow 32K and better finetuning, 6.84 →→\\\\rightarrow 7.61 on MT Bench.\n*   Mistral-small: Mistral 8x7B Instruct v0.1, matches or exceeds GPT-3.5 performance, multilingual.\n*   Mistral-medium: Outperforms GPT-3.5 on all metrics, multilingual.\n\n#### Results\n\n*   Benchmark results comparing against the other SOTA OSS models as of this writing: LLaMA-2, Yi-34B (from 01.AI led by Kai-Fu Lee), and DeepSeek-67B (a strong model made by a quant trading company).\n\n![](/primers/ai/assets/LLM/MMoE.jpeg)",
    "contentLength": 25007,
    "wordCount": 848,
    "hasCode": true,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mixtral:-mistral’s-8x7b-moe-model"
  },
  {
    "id": "ai-mixture-of-experts-openmoe-71",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Popular MoE Models",
    "title": "OpenMoE",
    "order": 71,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>OpenMoE, one of the earliest open-source MoE implementations, is a family of open-sourced MoE LLMs.</li>\n  <li>Related: Colossal AI’s <a href=\"https://github.com/hpcaitech/ColossalAI/tree/main/examples/language/openmoe\">PyTorch OpenMoE implementation</a> including both training and inference with expert parallelism.</li>\n</ul>",
    "contentMarkdown": "*   OpenMoE, one of the earliest open-source MoE implementations, is a family of open-sourced MoE LLMs.\n*   Related: Colossal AI’s [PyTorch OpenMoE implementation](https://github.com/hpcaitech/ColossalAI/tree/main/examples/language/openmoe) including both training and inference with expert parallelism.",
    "contentLength": 339,
    "wordCount": 31,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#openmoe"
  },
  {
    "id": "ai-mixture-of-experts-a-visual-guide-to-mixture-of-experts-moe-72",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Learning Resources",
    "title": "A Visual Guide to Mixture of Experts (MoE)",
    "order": 72,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>A deep-dive into the MoE architecture. Goes into details about what the separate experts learn, how to route between them, vision-MoE.</li>\n</ul>",
    "contentMarkdown": "*   A deep-dive into the MoE architecture. Goes into details about what the separate experts learn, how to route between them, vision-MoE.",
    "contentLength": 156,
    "wordCount": 22,
    "hasCode": false,
    "hasMath": false,
    "hasImages": false,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#a-visual-guide-to-mixture-of-experts-(moe)"
  },
  {
    "id": "ai-mixture-of-experts-outrageously-large-neural-networks-the-sparsely-ga-73",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Outrageously Large Neural Networks: the Sparsely-Gated Mixture-of-Experts Layer",
    "order": 73,
    "orderInChapter": 1,
    "contentHtml": "<ul>\n  <li>The capacity of a neural network to absorb information is limited by its number of parameters. Conditional computation, where parts of the network are active on a per-example basis, has been proposed in theory as a way of dramatically increasing model capacity without a proportional increase in computation. In practice, however, there are significant algorithmic and performance challenges. Also, static neural network architectures apply the same function to every example. In contrast, input dependent models attempt to tailor the function to each example. While it is straightforward for a human to manually specify a single static architecture, it is infeasible to specify every input-dependent function by hand. Instead, the input-dependent function must be automatically inferred by the model, which introduces an extra level of complexity in optimization.</li>\n  <li>Given the need to automatically infer architectures for each example, a natural solution is to define a single large model (supernetwork) with a numerous sub-networks (experts), and route examples through a path in the supernetwork. The figure below from <a href=\"#diversity-and-depth-in-per-example-routing-models\">Ramachandran and Le (2019)</a> visualizes an example of a routing network.. Intuitively, similar examples can be routed through similar paths and dissimilar examples can be routed through different paths. The example-dependent routing also encourages expert specialization, in which experts devote their representational capacity to transforming a chosen subset of examples.</li>\n</ul>\n<p><img src=\"../../../images/papers/Router.jpg\" alt=\"\"></p>\n<ul>\n  <li>Learning to route examples to well-matched experts is critical for good performance. Effective routing can be achieved by training another small neural network (router) that learns to route examples through the supernetwork. The router takes the example as input and outputs the next expert to use. The router can take advantage of the intermediate representations of the example produced in the supernetwork.</li>\n  <li>This paper by Shazeer et al. in ICLR 2017 addresses these challenges and finally realize the promise of conditional computation, achieving greater than 1000x improvements in model capacity with only minor losses in computational efficiency on modern GPU clusters.</li>\n  <li>They introduce a Sparsely-Gated Mixture-of-Experts layer (MoE), consisting of up to thousands of feed-forward sub-networks. A trainable gating network determines a sparse combination of these experts to use for each example. In this per-example routing setup, different examples are processed by different subcomponents, or experts, inside a larger model, a.k.a. a supernetwork.</li>\n  <li>Specifically, the proposed MoE layer takes as an input a token representation <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-434-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3484\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3485\"><span class=\"mi\" id=\"MathJax-Span-3486\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-434\">x</script> and then routes this to the best determined top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-435-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3487\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3488\"><span class=\"mi\" id=\"MathJax-Span-3489\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-435\">k</script> experts, selected from a set <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-436-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mrow><mo>{</mo><mrow><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>}</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3490\" style=\"width: 4.898em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.065em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1004.07em, 2.555em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3491\"><span class=\"msubsup\" id=\"MathJax-Span-3492\"><span style=\"display: inline-block; position: relative; width: 4.065em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.87em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3493\"><span class=\"mo\" id=\"MathJax-Span-3494\" style=\"font-family: STIXGeneral-Regular;\">{</span><span class=\"mrow\" id=\"MathJax-Span-3495\"><span class=\"msubsup\" id=\"MathJax-Span-3496\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3497\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3498\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3499\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3500\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3501\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span class=\"mo\" id=\"MathJax-Span-3502\" style=\"font-family: STIXGeneral-Regular;\">}</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.424em; left: 2.971em;\"><span class=\"mi\" id=\"MathJax-Span-3503\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.747em; left: 2.971em;\"><span class=\"texatom\" id=\"MathJax-Span-3504\"><span class=\"mrow\" id=\"MathJax-Span-3505\"><span class=\"mi\" id=\"MathJax-Span-3506\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3507\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3508\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.503em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mrow><mo>{</mo><mrow><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><mo>}</mo></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-436\">\\left\\{E_i(x)\\right\\}_{i=1}^N</script> of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-437-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3509\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3510\"><span class=\"mi\" id=\"MathJax-Span-3511\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-437\">N</script> experts. The router variable <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-438-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>r</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3512\" style=\"width: 1.461em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.2em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3513\"><span class=\"msubsup\" id=\"MathJax-Span-3514\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3515\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3516\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>r</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-438\">W_r</script> produces logits <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-439-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>h</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><msub><mi>W</mi><mi>r</mi></msub><mo>&amp;#x22C5;</mo><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3517\" style=\"width: 6.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.409em, 1005.52em, 2.555em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3518\"><span class=\"mi\" id=\"MathJax-Span-3519\" style=\"font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-3520\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3521\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3522\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3523\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-3524\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3525\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3526\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">r<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3527\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3528\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>h</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msub><mi>W</mi><mi>r</mi></msub><mo>⋅</mo><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-439\">h(x)=W_r \\cdot x</script> which are normalized via a softmax distribution over the available <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-440-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3529\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3530\"><span class=\"mi\" id=\"MathJax-Span-3531\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-440\">N</script> experts at that layer. The gate-value for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-441-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3532\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3533\"><span class=\"mi\" id=\"MathJax-Span-3534\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-441\">i</script> is given by,</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-442-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mfrac><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><msub><mo stretchy=&quot;false&quot;>)</mo><mi>i</mi></msub></mrow></msup><mrow><munderover><mo>&amp;#x2211;</mo><mi>j</mi><mi>N</mi></munderover><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><msub><mo stretchy=&quot;false&quot;>)</mo><mi>j</mi></msub></mrow></msup></mrow></mfrac></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3535\" style=\"width: 8.544em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.086em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.523em, 1007.09em, 3.701em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3536\"><span class=\"msubsup\" id=\"MathJax-Span-3537\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3538\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3539\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3540\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3541\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3542\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3543\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-3544\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.023em, 1001.88em, 4.169em, -999.997em); top: -4.685em; left: 50%; margin-left: -0.935em;\"><span class=\"msubsup\" id=\"MathJax-Span-3545\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3546\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-3547\"><span class=\"mrow\" id=\"MathJax-Span-3548\"><span class=\"mi\" id=\"MathJax-Span-3549\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-3550\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3551\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-3552\"><span style=\"display: inline-block; position: relative; width: 0.419em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.21em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3553\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-3554\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(2.919em, 1003.54em, 4.638em, -999.997em); top: -3.07em; left: 50%; margin-left: -1.768em;\"><span class=\"mrow\" id=\"MathJax-Span-3555\"><span class=\"munderover\" id=\"MathJax-Span-3556\"><span style=\"display: inline-block; position: relative; width: 1.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3557\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3558\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.326em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3559\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3560\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3561\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-3562\"><span class=\"mrow\" id=\"MathJax-Span-3563\"><span class=\"mi\" id=\"MathJax-Span-3564\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-3565\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3566\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-3567\"><span style=\"display: inline-block; position: relative; width: 0.419em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.21em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3568\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-3569\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1003.7em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 3.701em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.684em; border-left: 0px solid; width: 0px; height: 3.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo stretchy=\"false\">(</mo><mi>x</mi><msub><mo stretchy=\"false\">)</mo><mi>i</mi></msub></mrow></msup><mrow><munderover><mo>∑</mo><mi>j</mi><mi>N</mi></munderover><msup><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo stretchy=\"false\">(</mo><mi>x</mi><msub><mo stretchy=\"false\">)</mo><mi>j</mi></msub></mrow></msup></mrow></mfrac></math></span></span></div>\n<ul>\n  <li>The top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-443-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3570\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3571\"><span class=\"mi\" id=\"MathJax-Span-3572\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-443\">k</script> gate values are selected for routing the token <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-444-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3573\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3574\"><span class=\"mi\" id=\"MathJax-Span-3575\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-444\">x</script>. If <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-445-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>T</mi></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3576\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.94em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3577\"><span class=\"texatom\" id=\"MathJax-Span-3578\"><span class=\"mrow\" id=\"MathJax-Span-3579\"><span class=\"mi\" id=\"MathJax-Span-3580\" style=\"font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.211em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">T</mi></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-445\">\\mathcal{T}</script> is the set of selected top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-446-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3581\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3582\"><span class=\"mi\" id=\"MathJax-Span-3583\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-446\">k</script> indices then the output computation of the layer is the linearly weighted combination of each expert’s computation on the token by the gate value,</li>\n</ul>\n<div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-447-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>y</mi><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>T</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3584\" style=\"width: 8.701em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 7.242em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1007.19em, 3.648em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3585\"><span class=\"mi\" id=\"MathJax-Span-3586\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-3587\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3588\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3589\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.336em, 1001.2em, 4.273em, -999.997em); top: -2.81em; left: 0.055em;\"><span class=\"texatom\" id=\"MathJax-Span-3590\"><span class=\"mrow\" id=\"MathJax-Span-3591\"><span class=\"mi\" id=\"MathJax-Span-3592\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3593\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"texatom\" id=\"MathJax-Span-3594\"><span class=\"mrow\" id=\"MathJax-Span-3595\"><span class=\"mi\" id=\"MathJax-Span-3596\" style=\"font-size: 70.7%; font-family: STIXNonUnicode-Italic;\"><span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3597\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3598\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3599\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3600\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3601\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3602\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"msubsup\" id=\"MathJax-Span-3603\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3604\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3605\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3606\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3607\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3608\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.622em; border-left: 0px solid; width: 0px; height: 2.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><mi>y</mi><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">T</mi></mrow></mrow></munder><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span></div>\n<ul>\n  <li>They apply the MoE to the tasks of language modeling and machine translation, where model capacity is critical for absorbing the vast quantities of knowledge available in the training corpora. We present model architectures in which a MoE with up to 137 billion parameters is applied convolutionally between stacked LSTM layers. On large language modeling and machine translation benchmarks, these models achieve significantly better results than state-of-the-art at lower computational cost.</li>\n  <li>The following diagram from the paper illustrates a Mixture of Experts (MoE) layer embedded within a recurrent language model. In this case, the sparse gating function selects two experts to perform computations. Their outputs are modulated by the outputs of the gating network.</li>\n</ul>\n<p><img src=\"../../../images/papers/MoE.jpg\" alt=\"\"></p>",
    "contentMarkdown": "*   The capacity of a neural network to absorb information is limited by its number of parameters. Conditional computation, where parts of the network are active on a per-example basis, has been proposed in theory as a way of dramatically increasing model capacity without a proportional increase in computation. In practice, however, there are significant algorithmic and performance challenges. Also, static neural network architectures apply the same function to every example. In contrast, input dependent models attempt to tailor the function to each example. While it is straightforward for a human to manually specify a single static architecture, it is infeasible to specify every input-dependent function by hand. Instead, the input-dependent function must be automatically inferred by the model, which introduces an extra level of complexity in optimization.\n*   Given the need to automatically infer architectures for each example, a natural solution is to define a single large model (supernetwork) with a numerous sub-networks (experts), and route examples through a path in the supernetwork. The figure below from [Ramachandran and Le (2019)](#diversity-and-depth-in-per-example-routing-models) visualizes an example of a routing network.. Intuitively, similar examples can be routed through similar paths and dissimilar examples can be routed through different paths. The example-dependent routing also encourages expert specialization, in which experts devote their representational capacity to transforming a chosen subset of examples.\n\n![](../../../images/papers/Router.jpg)\n\n*   Learning to route examples to well-matched experts is critical for good performance. Effective routing can be achieved by training another small neural network (router) that learns to route examples through the supernetwork. The router takes the example as input and outputs the next expert to use. The router can take advantage of the intermediate representations of the example produced in the supernetwork.\n*   This paper by Shazeer et al. in ICLR 2017 addresses these challenges and finally realize the promise of conditional computation, achieving greater than 1000x improvements in model capacity with only minor losses in computational efficiency on modern GPU clusters.\n*   They introduce a Sparsely-Gated Mixture-of-Experts layer (MoE), consisting of up to thousands of feed-forward sub-networks. A trainable gating network determines a sparse combination of these experts to use for each example. In this per-example routing setup, different examples are processed by different subcomponents, or experts, inside a larger model, a.k.a. a supernetwork.\n*   Specifically, the proposed MoE layer takes as an input a token representation xxx and then routes this to the best determined top-kkk experts, selected from a set {Ei(x)}Ni\\=1{Ei(x)}i\\=1N\\\\left\\\\{E\\_i(x)\\\\right\\\\}\\_{i=1}^N of NNN experts. The router variable WrWrW\\_r produces logits h(x)\\=Wr⋅xh(x)\\=Wr⋅xh(x)=W\\_r \\\\cdot x which are normalized via a softmax distribution over the available NNN experts at that layer. The gate-value for expert iii is given by,\n\npi(x)\\=eh(x)i∑Njeh(x)jpi(x)\\=eh(x)i∑jNeh(x)j\n\n*   The top-kkk gate values are selected for routing the token xxx. If T\\\\mathcal{T} is the set of selected top-kkk indices then the output computation of the layer is the linearly weighted combination of each expert’s computation on the token by the gate value,\n\ny\\=∑i∈pi(x)Ei(x)y\\=∑i∈Tpi(x)Ei(x)\n\n*   They apply the MoE to the tasks of language modeling and machine translation, where model capacity is critical for absorbing the vast quantities of knowledge available in the training corpora. We present model architectures in which a MoE with up to 137 billion parameters is applied convolutionally between stacked LSTM layers. On large language modeling and machine translation benchmarks, these models achieve significantly better results than state-of-the-art at lower computational cost.\n*   The following diagram from the paper illustrates a Mixture of Experts (MoE) layer embedded within a recurrent language model. In this case, the sparse gating function selects two experts to perform computations. Their outputs are modulated by the outputs of the gating network.\n\n![](../../../images/papers/MoE.jpg)",
    "contentLength": 40414,
    "wordCount": 602,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#outrageously-large-neural-networks:-the-sparsely-gated-mixture-of-experts-layer"
  },
  {
    "id": "ai-mixture-of-experts-scaling-vision-with-sparse-mixture-of-experts-74",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Scaling Vision with Sparse Mixture of Experts",
    "order": 74,
    "orderInChapter": 2,
    "contentHtml": "<ul>\n  <li>Almost all prevalent computer vision models networks are “dense,” that is, every input is processed by every parameter.</li>\n  <li>This paper by Riquelme et al. from Google Brain introduces the Vision Mixture of Experts (V-MoE), a novel approach for scaling vision models. The V-MoE is a sparsely activated version of the Vision Transformer (ViT) that demonstrates scalability and competitiveness with larger dense networks in image recognition tasks.</li>\n  <li>The paper proposes a sparse variant of the Vision Transformer (ViT) that uses a mixture-of-experts architecture. This approach routes each image patch to a subset of experts, making it possible to scale up to 15B parameters while matching the performance of state-of-the-art dense models.</li>\n  <li>An innovative extension to the routing algorithm is presented, allowing prioritization of subsets of each input across the entire batch. This adaptive per-image compute leads to a trade-off between performance and computational efficiency during inference.</li>\n  <li>The figure below from the paper shows an overview of the architecture. V-MoE is composed of <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-448-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3609\" style=\"width: 0.784em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.63em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3610\"><span class=\"mi\" id=\"MathJax-Span-3611\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-448\">L</script> ViT blocks. In some, we replace the MLP with a sparsely activated mixture of MLPs. Each MLP (the expert) is stored on a separate device, and processes a fixed number of tokens. The communication of these tokens between devices is shown in this example, which depicts the case when <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-449-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3612\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3613\"><span class=\"mi\" id=\"MathJax-Span-3614\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3615\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3616\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-449\">k=1</script> expert is selected per token. Here each expert uses a capacity ratio <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-450-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mo>=</mo><mfrac><mn>4</mn><mn>3</mn></mfrac></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3617\" style=\"width: 3.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.555em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1002.55em, 2.763em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3618\"><span class=\"mi\" id=\"MathJax-Span-3619\" style=\"font-family: STIXGeneral-Italic;\">C<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3620\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-3621\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.32em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-3622\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">4</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.32em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-3623\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">3</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.47em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.471em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.559em; border-left: 0px solid; width: 0px; height: 1.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>C</mi><mo>=</mo><mfrac><mn>4</mn><mn>3</mn></mfrac></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-450\">C=\\frac{4}{3}</script>: the sparse MoE layer receives 12 tokens per device, but each expert has capacity for <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-451-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>16</mn><mrow><mo>(</mo><mrow><mfrac><mrow><mn>16</mn><mo>&amp;#x22C5;</mo><mn>1</mn></mrow><mn>12</mn></mfrac><mo>=</mo><mfrac><mn>4</mn><mn>3</mn></mfrac></mrow><mo fence=&quot;true&quot; stretchy=&quot;true&quot; symmetric=&quot;true&quot;></mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3624\" style=\"width: 6.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 5.159em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.878em, 1005.16em, 3.492em, -999.997em); top: -2.914em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3625\"><span class=\"mn\" id=\"MathJax-Span-3626\" style=\"font-family: STIXGeneral-Regular;\">16</span><span class=\"mrow\" id=\"MathJax-Span-3627\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-3628\" style=\"vertical-align: -0.206em;\"><span style=\"font-family: STIXSizeOneSym;\">(</span></span><span class=\"mrow\" id=\"MathJax-Span-3629\"><span class=\"mfrac\" id=\"MathJax-Span-3630\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1001.2em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.622em;\"><span class=\"mrow\" id=\"MathJax-Span-3631\"><span class=\"mn\" id=\"MathJax-Span-3632\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">16</span><span class=\"mo\" id=\"MathJax-Span-3633\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">⋅</span><span class=\"mn\" id=\"MathJax-Span-3634\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.68em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.362em;\"><span class=\"mn\" id=\"MathJax-Span-3635\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">12</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1001.41em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 1.409em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3636\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-3637\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.471em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.32em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-3638\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">4</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.32em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-3639\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">3</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.47em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.471em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3640\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.919em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.559em; border-left: 0px solid; width: 0px; height: 1.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mn>16</mn><mrow><mo>(</mo><mrow><mfrac><mrow><mn>16</mn><mo>⋅</mo><mn>1</mn></mrow><mn>12</mn></mfrac><mo>=</mo><mfrac><mn>4</mn><mn>3</mn></mfrac></mrow><mo fence=\"true\" stretchy=\"true\" symmetric=\"true\"></mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-451\">16\\left(\\frac{16 \\cdot 1}{12}=\\frac{4}{3}\\right.</script>). Non-expert components of V-MoE such as routers, attention layers and normal MLP blocks are replicated identically across devices.</li>\n</ul>\n<p><img src=\"../../../images/papers/V-MoE.jpg\" alt=\"\"></p>\n<ul>\n  <li>The V-MoE shows impressive scalability, successfully trained up to 15B parameters, and demonstrates strong performance, including 90.35% accuracy on ImageNet.</li>\n  <li>The paper explores the transfer learning abilities of V-MoE, showing its adaptability and effectiveness across different tasks and datasets, even with limited data.</li>\n  <li>A detailed analysis of the V-MoE’s routing decisions and the behavior of its experts is provided, offering insights into the model’s internal workings and guiding future improvements.</li>\n  <li>V-MoE models require less computational resources than dense counterparts, both in training and inference, thanks to their sparsely activated nature and the efficient use of the Batch Prioritized Routing algorithm.</li>\n  <li>The paper concludes with the potential of sparse conditional computation in vision tasks, emphasizing the environmental benefits due to reduced CO2 emissions and the promising directions for future research in large-scale multimodal or video modeling.</li>\n  <li>The paper represents a significant advancement in the field of computer vision, particularly in the development of scalable and efficient vision models.</li>\n</ul>",
    "contentMarkdown": "*   Almost all prevalent computer vision models networks are “dense,” that is, every input is processed by every parameter.\n*   This paper by Riquelme et al. from Google Brain introduces the Vision Mixture of Experts (V-MoE), a novel approach for scaling vision models. The V-MoE is a sparsely activated version of the Vision Transformer (ViT) that demonstrates scalability and competitiveness with larger dense networks in image recognition tasks.\n*   The paper proposes a sparse variant of the Vision Transformer (ViT) that uses a mixture-of-experts architecture. This approach routes each image patch to a subset of experts, making it possible to scale up to 15B parameters while matching the performance of state-of-the-art dense models.\n*   An innovative extension to the routing algorithm is presented, allowing prioritization of subsets of each input across the entire batch. This adaptive per-image compute leads to a trade-off between performance and computational efficiency during inference.\n*   The figure below from the paper shows an overview of the architecture. V-MoE is composed of LLL ViT blocks. In some, we replace the MLP with a sparsely activated mixture of MLPs. Each MLP (the expert) is stored on a separate device, and processes a fixed number of tokens. The communication of these tokens between devices is shown in this example, which depicts the case when k\\=1k\\=1k=1 expert is selected per token. Here each expert uses a capacity ratio C\\=43C\\=43C=\\\\frac{4}{3}: the sparse MoE layer receives 12 tokens per device, but each expert has capacity for 16(16⋅112\\=4316(16⋅112\\=4316\\\\left(\\\\frac{16 \\\\cdot 1}{12}=\\\\frac{4}{3}\\\\right.). Non-expert components of V-MoE such as routers, attention layers and normal MLP blocks are replicated identically across devices.\n\n![](../../../images/papers/V-MoE.jpg)\n\n*   The V-MoE shows impressive scalability, successfully trained up to 15B parameters, and demonstrates strong performance, including 90.35% accuracy on ImageNet.\n*   The paper explores the transfer learning abilities of V-MoE, showing its adaptability and effectiveness across different tasks and datasets, even with limited data.\n*   A detailed analysis of the V-MoE’s routing decisions and the behavior of its experts is provided, offering insights into the model’s internal workings and guiding future improvements.\n*   V-MoE models require less computational resources than dense counterparts, both in training and inference, thanks to their sparsely activated nature and the efficient use of the Batch Prioritized Routing algorithm.\n*   The paper concludes with the potential of sparse conditional computation in vision tasks, emphasizing the environmental benefits due to reduced CO2 emissions and the promising directions for future research in large-scale multimodal or video modeling.\n*   The paper represents a significant advancement in the field of computer vision, particularly in the development of scalable and efficient vision models.",
    "contentLength": 13223,
    "wordCount": 430,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#scaling-vision-with-sparse-mixture-of-experts"
  },
  {
    "id": "ai-mixture-of-experts-modeling-task-relationships-in-multi-task-learning-75",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Modeling Task Relationships in Multi-task Learning with Multi-gate Mixture-of-Experts",
    "order": 75,
    "orderInChapter": 3,
    "contentHtml": "<ul>\n  <li>This paper by Ma et al. published in KDD 2018, introduces a novel approach to multi-task learning called Multi-gate Mixture-of-Experts (MMoE). The method aims to enhance the performance of multi-task learning models by better handling the relationships between different tasks.</li>\n  <li>The MMoE model adapts the MoE framework to multi-task learning by sharing expert submodels across all tasks and using a gating network optimized for each task. This design allows the model to dynamically allocate shared and task-specific resources, efficiently handling tasks with varying degrees of relatedness.</li>\n  <li>The paper presents experiments using synthetic data and real datasets, including a binary classification benchmark and a large-scale content recommendation system at Google. These experiments demonstrate MMoE’s effectiveness in scenarios where tasks have low relatedness and its superiority over traditional shared-bottom multi-task models in terms of both performance and trainability.</li>\n  <li>MMoE’s architecture consists of multiple experts (feed-forward networks) and a gating network for each task, which determines the contribution of each expert to the task. This setup allows the model to learn nuanced relationships between tasks and allocate computation resources more effectively.</li>\n  <li>The following figure from the paper shows a (a) shared-Bottom model, (b) one-gate MoE model, (c) multi-gate MoE model.</li>\n</ul>\n<p><img src=\"../../../images/papers/MMoE.jpg\" alt=\"\"></p>\n<ul>\n  <li>In the experiments with the Census-income dataset, a UCI benchmark dataset, the task was to predict whether an individual’s income exceeds $50,000 based on census data. The dataset contains demographic and employment-related information. MMoE’s application to this dataset involved addressing the challenge of binary classification using multiple socio-economic factors as input features.</li>\n  <li>On synthetic data, MMoE showed better performance, especially when task correlation is low, and demonstrated improved trainability with less variance in model performance across runs. On real-world datasets, including the UCI Census-income dataset and Google’s content recommendation system, MMoE consistently outperformed baseline models in terms of accuracy and robustness.</li>\n  <li>MMoE offers computational efficiency by using lightweight gating networks and shared expert networks, making it suitable for large-scale applications. The experiments on Google’s recommendation system highlighted MMoE’s ability to improve both engagement and satisfaction metrics in live experiments compared to single-task and shared-bottom models.</li>\n</ul>",
    "contentMarkdown": "*   This paper by Ma et al. published in KDD 2018, introduces a novel approach to multi-task learning called Multi-gate Mixture-of-Experts (MMoE). The method aims to enhance the performance of multi-task learning models by better handling the relationships between different tasks.\n*   The MMoE model adapts the MoE framework to multi-task learning by sharing expert submodels across all tasks and using a gating network optimized for each task. This design allows the model to dynamically allocate shared and task-specific resources, efficiently handling tasks with varying degrees of relatedness.\n*   The paper presents experiments using synthetic data and real datasets, including a binary classification benchmark and a large-scale content recommendation system at Google. These experiments demonstrate MMoE’s effectiveness in scenarios where tasks have low relatedness and its superiority over traditional shared-bottom multi-task models in terms of both performance and trainability.\n*   MMoE’s architecture consists of multiple experts (feed-forward networks) and a gating network for each task, which determines the contribution of each expert to the task. This setup allows the model to learn nuanced relationships between tasks and allocate computation resources more effectively.\n*   The following figure from the paper shows a (a) shared-Bottom model, (b) one-gate MoE model, (c) multi-gate MoE model.\n\n![](../../../images/papers/MMoE.jpg)\n\n*   In the experiments with the Census-income dataset, a UCI benchmark dataset, the task was to predict whether an individual’s income exceeds $50,000 based on census data. The dataset contains demographic and employment-related information. MMoE’s application to this dataset involved addressing the challenge of binary classification using multiple socio-economic factors as input features.\n*   On synthetic data, MMoE showed better performance, especially when task correlation is low, and demonstrated improved trainability with less variance in model performance across runs. On real-world datasets, including the UCI Census-income dataset and Google’s content recommendation system, MMoE consistently outperformed baseline models in terms of accuracy and robustness.\n*   MMoE offers computational efficiency by using lightweight gating networks and shared expert networks, making it suitable for large-scale applications. The experiments on Google’s recommendation system highlighted MMoE’s ability to improve both engagement and satisfaction metrics in live experiments compared to single-task and shared-bottom models.",
    "contentLength": 2676,
    "wordCount": 351,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#modeling-task-relationships-in-multi-task-learning-with-multi-gate-mixture-of-experts"
  },
  {
    "id": "ai-mixture-of-experts-mixture-of-experts-meets-instruction-tuning-a-winn-76",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Mixture-of-Experts Meets Instruction Tuning: a Winning Combination for Large Language Models",
    "order": 76,
    "orderInChapter": 4,
    "contentHtml": "<ul>\n  <li>The paper titled “Mixture-of-Experts Meets Instruction Tuning: A Winning Combination for Large Language Models” presents an innovative approach to enhancing the performance and scalability of Large Language Models (LLMs) by combining Sparse MoE architecture with instruction tuning. - Sparse MoE is a neural architecture that adds learnable parameters to LLMs without increasing inference costs. In contrast, instruction tuning trains LLMs to follow instructions more effectively.</li>\n  <li>The authors advocate for the combination of these two approaches, demonstrating that MoE models benefit significantly more from instruction tuning compared to their dense model counterparts.</li>\n  <li>The paper presents three experimental setups: direct finetuning on individual downstream tasks without instruction tuning; instruction tuning followed by few-shot or zero-shot generalization on downstream tasks; and instruction tuning supplemented by further finetuning on individual tasks.</li>\n  <li>The findings indicate that MoE models generally underperform compared to dense models of the same computational capacity in the absence of instruction tuning. However, this changes with the introduction of instruction tuning, where MoE models outperform dense models.</li>\n  <li>The paper introduces the FLAN-MOE32B model, which outperforms FLAN-PALM62B on four benchmark tasks while using only a third of the FLOPs. This highlights the efficiency and effectiveness of the FLAN-MOE approach.</li>\n  <li>The authors conduct a comprehensive series of experiments to compare the performance of various MoE models subjected to instruction tuning. These experiments include evaluations in natural language understanding, reasoning, and question-answering tasks. The study also explores the impact of different routing strategies and the number of experts on the performance of FLAN-MOE models, showing that performance scales with the number of tasks rather than the number of experts.</li>\n  <li>The following image from the paper shows the effect of instruction tuning on MOE models versus dense counterparts for base-size models (same flops across all models in this figure). They perform single-task finetuning for each model on held-out benchmarks. Compared to dense models, MoE models benefit more from instruction-tuning, and are more sensitive to the number of instruction-tuning tasks. Overall, the performance of MoE models scales better with respect to the number of tasks, than the number of experts.</li>\n</ul>\n<p><img src=\"../../../images/papers/MOEIT.jpg\" alt=\"\"></p>\n<ul>\n  <li>The paper discusses the challenge of adapting MoE models to multilingual benchmarks and highlights the importance of incorporating diverse linguistic data during training to ensure effective language coverage.</li>\n  <li>Overall, the paper “Mixture-of-Experts Meets Instruction Tuning” by Sheng Shen et al. presents significant advancements in the scalability and efficiency of LLMs through the novel integration of MoE architecture and instruction tuning, setting new standards in the field of natural language processing.</li>\n</ul>",
    "contentMarkdown": "*   The paper titled “Mixture-of-Experts Meets Instruction Tuning: A Winning Combination for Large Language Models” presents an innovative approach to enhancing the performance and scalability of Large Language Models (LLMs) by combining Sparse MoE architecture with instruction tuning. - Sparse MoE is a neural architecture that adds learnable parameters to LLMs without increasing inference costs. In contrast, instruction tuning trains LLMs to follow instructions more effectively.\n*   The authors advocate for the combination of these two approaches, demonstrating that MoE models benefit significantly more from instruction tuning compared to their dense model counterparts.\n*   The paper presents three experimental setups: direct finetuning on individual downstream tasks without instruction tuning; instruction tuning followed by few-shot or zero-shot generalization on downstream tasks; and instruction tuning supplemented by further finetuning on individual tasks.\n*   The findings indicate that MoE models generally underperform compared to dense models of the same computational capacity in the absence of instruction tuning. However, this changes with the introduction of instruction tuning, where MoE models outperform dense models.\n*   The paper introduces the FLAN-MOE32B model, which outperforms FLAN-PALM62B on four benchmark tasks while using only a third of the FLOPs. This highlights the efficiency and effectiveness of the FLAN-MOE approach.\n*   The authors conduct a comprehensive series of experiments to compare the performance of various MoE models subjected to instruction tuning. These experiments include evaluations in natural language understanding, reasoning, and question-answering tasks. The study also explores the impact of different routing strategies and the number of experts on the performance of FLAN-MOE models, showing that performance scales with the number of tasks rather than the number of experts.\n*   The following image from the paper shows the effect of instruction tuning on MOE models versus dense counterparts for base-size models (same flops across all models in this figure). They perform single-task finetuning for each model on held-out benchmarks. Compared to dense models, MoE models benefit more from instruction-tuning, and are more sensitive to the number of instruction-tuning tasks. Overall, the performance of MoE models scales better with respect to the number of tasks, than the number of experts.\n\n![](../../../images/papers/MOEIT.jpg)\n\n*   The paper discusses the challenge of adapting MoE models to multilingual benchmarks and highlights the importance of incorporating diverse linguistic data during training to ensure effective language coverage.\n*   Overall, the paper “Mixture-of-Experts Meets Instruction Tuning” by Sheng Shen et al. presents significant advancements in the scalability and efficiency of LLMs through the novel integration of MoE architecture and instruction tuning, setting new standards in the field of natural language processing.",
    "contentLength": 3130,
    "wordCount": 423,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mixture-of-experts-meets-instruction-tuning:-a-winning-combination-for-large-language-models"
  },
  {
    "id": "ai-mixture-of-experts-from-sparse-to-soft-mixtures-of-experts-77",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "From Sparse to Soft Mixtures of Experts",
    "order": 77,
    "orderInChapter": 5,
    "contentHtml": "<ul>\n  <li>Sparse Mixture of Experts (MoE) architectures scale model capacity without large increases in training or inference costs. MoE allows us to dramatically scale model sizes without significantly increasing inference latency. In short, each “expert” can separately attend to a different subset of tasks via different data subsets before they are combined via an input routing mechanism. Thus, the model can learn a wide variety of tasks, but still specialize when appropriate. Despite their success, MoEs suffer from a number of issues: training instability, token dropping, inability to scale the number of experts, or ineffective finetuning.</li>\n  <li>This paper by Puigcerver et al. from Google DeepMind proposes Soft MoE, a fully-differentiable sparse Transformer that addresses these challenges, while maintaining the benefits of MoEs.</li>\n  <li>Extra-large models like Google’s PaLM (540B parameters) or OpenAI’s GPT-4 use Sparse MoE under the hood, which suffers from training instabilities, because it’s not fully differentiable. Soft-MoE replaces the non-differentiable expert routing with a differentiable layer. The end-to-end model is fully differentiable again, can be trained with ordinary SGD-like optimizers, and the training instabilities go away.</li>\n  <li>Soft MoE performs an implicit soft assignment by passing different weighted combinations of all input tokens to each expert. As in other MoE works, experts in Soft MoE only process a subset of the (combined) tokens, enabling larger model capacity at lower inference cost.</li>\n  <li>The following figure from the paper illustrates the main differences between Sparse and Soft MoE layers. While the router in Sparse MoE layers (left) learns to assign individual input tokens to each of the available slots, in Soft MoE layers (right) each slot is the result of a (different) weighted average of all the input tokens. Learning to make discrete assignments introduces several optimization and implementation issues that Soft MoE sidesteps.</li>\n</ul>\n<p><img src=\"../../../images/papers/Soft-Experts.jpg\" alt=\"\"></p>\n<ul>\n  <li>They propose a fully-differentiable sparse vision transformer (ViT) that addresses aforementioned challenges such as training instability, token dropping, and inefficient finetuning. In the context of visual recognition, Soft MoE greatly outperforms the standard ViT and popular MoE variants (Tokens Choice and Experts Choice). Soft MoE scales ViT models to &gt;50B parameters with little effect on inference latency. For example, Soft MoE-Base/16 requires 10.5x lower inference cost (5.7x lower wall-clock time) than ViT-Huge/14 while matching its performance after similar training. Soft MoE also scales well: Soft MoE Huge/14 with 128 experts in 16 MoE layers has over 40x more parameters than ViT Huge/14, while inference time cost grows by only 2%, and it performs substantially better.</li>\n  <li>The following figure from the paper illustrates the Soft MoE routing algorithm. Soft MoE first computes scores or logits for every pair of input token and slot, based on some learnable per-slot parameters. These logits are then normalized per slot (columns) and every slot computes a linear combination of all the input tokens based on these weights (in green). Each expert (an MLP in this work) then processes its slots (e.g. 2 slots per expert, in this diagram). Finally, the same original logits are normalized per token (i.e., by row) and used to combine all the slot outputs, for every input token (in blue). Dashed boxes represent learnable parameters.</li>\n</ul>\n<p><img src=\"../../../images/papers/Soft-Experts2.jpg\" alt=\"\"></p>\n<ul>\n  <li>The following infographic <a href=\"https://www.linkedin.com/in/sebastianraschka/\">(source)</a> presents an overview of their results:</li>\n</ul>\n<p><img src=\"../../../images/papers/Soft-Experts3.jpg\" alt=\"\"></p>\n<ul>\n  <li>PyTorch <a href=\"https://github.com/fkodom/soft-mixture-of-experts\">implementation</a>.</li>\n</ul>",
    "contentMarkdown": "*   Sparse Mixture of Experts (MoE) architectures scale model capacity without large increases in training or inference costs. MoE allows us to dramatically scale model sizes without significantly increasing inference latency. In short, each “expert” can separately attend to a different subset of tasks via different data subsets before they are combined via an input routing mechanism. Thus, the model can learn a wide variety of tasks, but still specialize when appropriate. Despite their success, MoEs suffer from a number of issues: training instability, token dropping, inability to scale the number of experts, or ineffective finetuning.\n*   This paper by Puigcerver et al. from Google DeepMind proposes Soft MoE, a fully-differentiable sparse Transformer that addresses these challenges, while maintaining the benefits of MoEs.\n*   Extra-large models like Google’s PaLM (540B parameters) or OpenAI’s GPT-4 use Sparse MoE under the hood, which suffers from training instabilities, because it’s not fully differentiable. Soft-MoE replaces the non-differentiable expert routing with a differentiable layer. The end-to-end model is fully differentiable again, can be trained with ordinary SGD-like optimizers, and the training instabilities go away.\n*   Soft MoE performs an implicit soft assignment by passing different weighted combinations of all input tokens to each expert. As in other MoE works, experts in Soft MoE only process a subset of the (combined) tokens, enabling larger model capacity at lower inference cost.\n*   The following figure from the paper illustrates the main differences between Sparse and Soft MoE layers. While the router in Sparse MoE layers (left) learns to assign individual input tokens to each of the available slots, in Soft MoE layers (right) each slot is the result of a (different) weighted average of all the input tokens. Learning to make discrete assignments introduces several optimization and implementation issues that Soft MoE sidesteps.\n\n![](../../../images/papers/Soft-Experts.jpg)\n\n*   They propose a fully-differentiable sparse vision transformer (ViT) that addresses aforementioned challenges such as training instability, token dropping, and inefficient finetuning. In the context of visual recognition, Soft MoE greatly outperforms the standard ViT and popular MoE variants (Tokens Choice and Experts Choice). Soft MoE scales ViT models to >50B parameters with little effect on inference latency. For example, Soft MoE-Base/16 requires 10.5x lower inference cost (5.7x lower wall-clock time) than ViT-Huge/14 while matching its performance after similar training. Soft MoE also scales well: Soft MoE Huge/14 with 128 experts in 16 MoE layers has over 40x more parameters than ViT Huge/14, while inference time cost grows by only 2%, and it performs substantially better.\n*   The following figure from the paper illustrates the Soft MoE routing algorithm. Soft MoE first computes scores or logits for every pair of input token and slot, based on some learnable per-slot parameters. These logits are then normalized per slot (columns) and every slot computes a linear combination of all the input tokens based on these weights (in green). Each expert (an MLP in this work) then processes its slots (e.g. 2 slots per expert, in this diagram). Finally, the same original logits are normalized per token (i.e., by row) and used to combine all the slot outputs, for every input token (in blue). Dashed boxes represent learnable parameters.\n\n![](../../../images/papers/Soft-Experts2.jpg)\n\n*   The following infographic [(source)](https://www.linkedin.com/in/sebastianraschka/) presents an overview of their results:\n\n![](../../../images/papers/Soft-Experts3.jpg)\n\n*   PyTorch [implementation](https://github.com/fkodom/soft-mixture-of-experts).",
    "contentLength": 3983,
    "wordCount": 540,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#from-sparse-to-soft-mixtures-of-experts"
  },
  {
    "id": "ai-mixture-of-experts-switch-transformers-78",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Switch Transformers",
    "order": 78,
    "orderInChapter": 6,
    "contentHtml": "<ul>\n  <li>Proposed in <a href=\"https://arxiv.org/abs/2101.03961\">Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</a>.</li>\n  <li>In deep learning, models typically reuse the same parameters for all inputs. Mixture of Experts (MoE) defies this and instead selects different parameters for each incoming example. The result is a sparsely-activated model – with outrageous numbers of parameters – but a constant computational cost.</li>\n  <li>This paper by Fedus et al. from Google in JMLR 2022 introduces the Switch Transformer which seeks to address the lack of widespread adoption of MoE which has been hindered by complexity, communication costs, and training instability.</li>\n  <li>They simplify the MoE routing algorithm and design intuitive improved models with reduced communication and computational costs. Our proposed training techniques help wrangle the instabilities and they show large sparse models may be trained, for the first time, with lower precision (bfloat16) formats.</li>\n  <li>The guiding design principle for Switch Transformers is to maximize the parameter count of a Transformer model (Vaswani et al., 2017) in a simple and computationally efficient way. The benefit of scale was exhaustively studied in Kaplan et al. (2020) which uncovered powerlaw scaling with model size, data set size and computational budget. Importantly, this work advocates training large models on relatively small amounts of data as the computationally optimal approach. Heeding these results, they investigate a fourth axis: increase the parameter count while keeping the floating point operations (FLOPs) per example constant. Our hypothesis is that the parameter count, independent of total computation performed, is a separately important axis on which to scale. They achieve this by designing a sparsely activated model that efficiently uses hardware designed for dense matrix multiplications such as GPUs and TPUs. In their distributed training setup, their sparsely activated layers split unique weights on different devices. Therefore, the weights of the model increase with the number of devices, all while maintaining a manageable memory and computational footprint on each device.</li>\n  <li>Their switch routing proposal reimagines MoE. <a href=\"#outrageously-large-neural-networks-the-sparsely-gated-mixture-of-experts-layer\">Shazeer et al. (2017)</a> conjectured that routing to <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-452-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;gt;</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3641\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3642\"><span class=\"mi\" id=\"MathJax-Span-3643\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3644\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">&gt;</span><span class=\"mn\" id=\"MathJax-Span-3645\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>&gt;</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-452\">k > 1</script> experts was necessary in order to have non-trivial gradients to the routing functions. The authors intuited that learning to route would not work without the ability to compare at least two experts. <a href=\"#diversity-and-depth-in-per-example-routing-models\">Ramachandran and Le (2018)</a> went further to study the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-453-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3646\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3647\"><span class=\"mi\" id=\"MathJax-Span-3648\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-453\">k</script> decision and found that higher <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-454-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3649\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3650\"><span class=\"mi\" id=\"MathJax-Span-3651\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-454\">k</script>-values in lower layers in the model were important for models with many routing layers. Contrary to these ideas, they instead use a simplified strategy where they route to only a single expert. They show this simplification preserves model quality, reduces routing computation and performs better. This <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-455-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>=</mo><mn>1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3652\" style=\"width: 2.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.19em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.09em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3653\"><span class=\"mi\" id=\"MathJax-Span-3654\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3655\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3656\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><mo>=</mo><mn>1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-455\">k = 1</script> routing strategy is later referred to as a Switch layer.</li>\n  <li>The following figure from the paper illustrates the Switch Transformer encoder block. We replace the dense feed forward network (FFN) layer present in the Transformer with a sparse Switch FFN layer (light blue). The layer operates independently on the tokens in the sequence. They diagram two tokens (<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-456-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>x</mi><mn>1</mn></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3657\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3658\"><span class=\"msubsup\" id=\"MathJax-Span-3659\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3660\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mn\" id=\"MathJax-Span-3661\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>x</mi><mn>1</mn></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-456\">x_1</script> = “More” and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-457-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>x</mi><mn>2</mn></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3662\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3663\"><span class=\"msubsup\" id=\"MathJax-Span-3664\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3665\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mn\" id=\"MathJax-Span-3666\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>x</mi><mn>2</mn></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-457\">x_2</script> = “Parameters” below) being routed (solid lines) across four FFN experts, where the router independently routes each token. The switch FFN layer returns the output of the selected FFN multiplied by the router gate value (dotted-line).</li>\n</ul>\n<p><img src=\"../../../images/papers/SwitchT.jpg\" alt=\"\"></p>\n<ul>\n  <li>They design models based off T5-Base and T5-Large to obtain up to 7x increases in pre-training speed with the same computational resources. These improvements extend into multilingual settings where they measure gains over the mT5-Base version across all 101 languages.</li>\n  <li>Finally, they advance the current scale of language models by pre-training up to trillion parameter models on the “Colossal Clean Crawled Corpus” and achieve a 4x speedup over the T5-XXL model.</li>\n  <li><a href=\"https://huggingface.co/google/switch-c-2048\">Code</a>.</li>\n</ul>",
    "contentMarkdown": "*   Proposed in [Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity](https://arxiv.org/abs/2101.03961).\n*   In deep learning, models typically reuse the same parameters for all inputs. Mixture of Experts (MoE) defies this and instead selects different parameters for each incoming example. The result is a sparsely-activated model – with outrageous numbers of parameters – but a constant computational cost.\n*   This paper by Fedus et al. from Google in JMLR 2022 introduces the Switch Transformer which seeks to address the lack of widespread adoption of MoE which has been hindered by complexity, communication costs, and training instability.\n*   They simplify the MoE routing algorithm and design intuitive improved models with reduced communication and computational costs. Our proposed training techniques help wrangle the instabilities and they show large sparse models may be trained, for the first time, with lower precision (bfloat16) formats.\n*   The guiding design principle for Switch Transformers is to maximize the parameter count of a Transformer model (Vaswani et al., 2017) in a simple and computationally efficient way. The benefit of scale was exhaustively studied in Kaplan et al. (2020) which uncovered powerlaw scaling with model size, data set size and computational budget. Importantly, this work advocates training large models on relatively small amounts of data as the computationally optimal approach. Heeding these results, they investigate a fourth axis: increase the parameter count while keeping the floating point operations (FLOPs) per example constant. Our hypothesis is that the parameter count, independent of total computation performed, is a separately important axis on which to scale. They achieve this by designing a sparsely activated model that efficiently uses hardware designed for dense matrix multiplications such as GPUs and TPUs. In their distributed training setup, their sparsely activated layers split unique weights on different devices. Therefore, the weights of the model increase with the number of devices, all while maintaining a manageable memory and computational footprint on each device.\n*   Their switch routing proposal reimagines MoE. [Shazeer et al. (2017)](#outrageously-large-neural-networks-the-sparsely-gated-mixture-of-experts-layer) conjectured that routing to k\\>1k\\>1k > 1 experts was necessary in order to have non-trivial gradients to the routing functions. The authors intuited that learning to route would not work without the ability to compare at least two experts. [Ramachandran and Le (2018)](#diversity-and-depth-in-per-example-routing-models) went further to study the top-kkk decision and found that higher kkk\\-values in lower layers in the model were important for models with many routing layers. Contrary to these ideas, they instead use a simplified strategy where they route to only a single expert. They show this simplification preserves model quality, reduces routing computation and performs better. This k\\=1k\\=1k = 1 routing strategy is later referred to as a Switch layer.\n*   The following figure from the paper illustrates the Switch Transformer encoder block. We replace the dense feed forward network (FFN) layer present in the Transformer with a sparse Switch FFN layer (light blue). The layer operates independently on the tokens in the sequence. They diagram two tokens (x1x1x\\_1 = “More” and x2x2x\\_2 = “Parameters” below) being routed (solid lines) across four FFN experts, where the router independently routes each token. The switch FFN layer returns the output of the selected FFN multiplied by the router gate value (dotted-line).\n\n![](../../../images/papers/SwitchT.jpg)\n\n*   They design models based off T5-Base and T5-Large to obtain up to 7x increases in pre-training speed with the same computational resources. These improvements extend into multilingual settings where they measure gains over the mT5-Base version across all 101 languages.\n*   Finally, they advance the current scale of language models by pre-training up to trillion parameter models on the “Colossal Clean Crawled Corpus” and achieve a 4x speedup over the T5-XXL model.\n*   [Code](https://huggingface.co/google/switch-c-2048).",
    "contentLength": 13839,
    "wordCount": 610,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#switch-transformers"
  },
  {
    "id": "ai-mixture-of-experts-qmoe-practical-sub-1-bit-compression-of-trillion-p-79",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "QMoE: Practical Sub-1-Bit Compression of Trillion-Parameter Models",
    "order": 79,
    "orderInChapter": 7,
    "contentHtml": "<ul>\n  <li>This paper by Frantar and Alistarh from the Institute of Science and Technology Austria and Neural Magic Inc. presents QMoE, a framework designed to address the memory challenges in deploying large language models (LLMs) with MoE architectures.</li>\n  <li>The key problem QMoE addresses is the massive memory requirement of large models, exemplified by the 1.6 trillion-parameter SwitchTransformer-c2048 model, which typically requires 3.2TB of memory. QMoE effectively compresses such models to less than 1 bit per parameter, enabling their execution on commodity hardware with minor runtime overheads.</li>\n  <li>QMoE employs a scalable algorithm and a custom compression format paired with GPU decoding kernels. It compresses the SwitchTransformer-c2048 model to less than 160GB (0.8 bits per parameter) with minor accuracy loss in under a day on a single GPU.</li>\n  <li>The implementation includes a highly scalable compression algorithm and a bespoke compression format, facilitating efficient end-to-end compressed inference. The framework enables running trillion-parameter models on affordable hardware, like servers equipped with NVIDIA GPUs, at less than 5% runtime overhead compared to ideal uncompressed execution.</li>\n  <li>The paper discusses the challenges in compressing MoE models, including conceptual issues with existing post-training compression methods and practical scaling challenges. It overcomes these by introducing a custom compression format and highly-efficient decoding algorithms optimized for GPU accelerators.</li>\n  <li>The technical contributions include a novel approach to handling massive activation sets and a unique system design for optimized activation offloading, expert grouping, and robustness modifications, ensuring efficient application of data-dependent compression to massive MoEs.</li>\n  <li>The framework significantly reduces the size of large models, with QMoE compressed models achieving over 20x compression rates compared to 16-bit precision models. This reduction in size is accompanied by minor increases in loss on pretraining validation and zero-shot data.</li>\n  <li>The paper also discusses the system design and optimizations made to address memory costs, GPU utilization, and reliability requirements. These include techniques like optimized activation offloading, list buffer data structures, lazy weight fetching, and expert grouping.</li>\n  <li>The following figure from the paper illustrates the offloading execution for the sparse part of a Transformer block. An expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-458-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mn>2</mn></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3667\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3668\"><span class=\"msubsup\" id=\"MathJax-Span-3669\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3670\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mn\" id=\"MathJax-Span-3671\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mn>2</mn></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-458\">E_2</script> and its corresponding input\ntokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-459-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mi>E</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3672\" style=\"width: 1.409em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.15em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3673\"><span class=\"msubsup\" id=\"MathJax-Span-3674\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3675\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3676\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>X</mi><mi>E</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-459\">X_E</script> are fetched to GPU memory to produce <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-460-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mn>2</mn></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2032;</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3677\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.2em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3678\"><span class=\"msubsup\" id=\"MathJax-Span-3679\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3680\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mn\" id=\"MathJax-Span-3681\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-3682\"><span class=\"mrow\" id=\"MathJax-Span-3683\"><span class=\"mo\" id=\"MathJax-Span-3684\" style=\"font-family: STIXGeneral-Regular;\">′</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mn>2</mn></msub><mrow class=\"MJX-TeXAtom-ORD\"><mo>′</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-460\">E_2′</script>, which together with the corresponding outputs <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-461-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>Y</mi><mi>E</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3685\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3686\"><span class=\"msubsup\" id=\"MathJax-Span-3687\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3688\" style=\"font-family: STIXGeneral-Italic;\">Y<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3689\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>Y</mi><mi>E</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-461\">Y_E</script> are written back to CPU again.</li>\n</ul>\n<p><img src=\"../../../images/papers/QMoE.jpg\" alt=\"\"></p>\n<ul>\n  <li>The experiments demonstrate that QMoE effectively compresses MoE models while maintaining performance. The system was tested on various datasets, including Arxiv, GitHub, StackExchange, and Wikipedia, showing good performance preservation even for highly compressed models.</li>\n  <li>The paper provides detailed insights into the encoding and decoding processes and the kernel implementation for the GPU, highlighting the challenges and solutions for achieving sub-1-bit per parameter compression.</li>\n  <li>The QMoE framework is a significant step towards practical deployment of massive-scale MoE models, addressing key limitations of MoE architectures and facilitating further research and understanding of such models.</li>\n  <li>The paper’s findings are significant as they make it feasible to deploy and research trillion-parameter models on more accessible hardware, potentially democratizing access to high-performance LLMs and spurring further innovation in the field.</li>\n</ul>",
    "contentMarkdown": "*   This paper by Frantar and Alistarh from the Institute of Science and Technology Austria and Neural Magic Inc. presents QMoE, a framework designed to address the memory challenges in deploying large language models (LLMs) with MoE architectures.\n*   The key problem QMoE addresses is the massive memory requirement of large models, exemplified by the 1.6 trillion-parameter SwitchTransformer-c2048 model, which typically requires 3.2TB of memory. QMoE effectively compresses such models to less than 1 bit per parameter, enabling their execution on commodity hardware with minor runtime overheads.\n*   QMoE employs a scalable algorithm and a custom compression format paired with GPU decoding kernels. It compresses the SwitchTransformer-c2048 model to less than 160GB (0.8 bits per parameter) with minor accuracy loss in under a day on a single GPU.\n*   The implementation includes a highly scalable compression algorithm and a bespoke compression format, facilitating efficient end-to-end compressed inference. The framework enables running trillion-parameter models on affordable hardware, like servers equipped with NVIDIA GPUs, at less than 5% runtime overhead compared to ideal uncompressed execution.\n*   The paper discusses the challenges in compressing MoE models, including conceptual issues with existing post-training compression methods and practical scaling challenges. It overcomes these by introducing a custom compression format and highly-efficient decoding algorithms optimized for GPU accelerators.\n*   The technical contributions include a novel approach to handling massive activation sets and a unique system design for optimized activation offloading, expert grouping, and robustness modifications, ensuring efficient application of data-dependent compression to massive MoEs.\n*   The framework significantly reduces the size of large models, with QMoE compressed models achieving over 20x compression rates compared to 16-bit precision models. This reduction in size is accompanied by minor increases in loss on pretraining validation and zero-shot data.\n*   The paper also discusses the system design and optimizations made to address memory costs, GPU utilization, and reliability requirements. These include techniques like optimized activation offloading, list buffer data structures, lazy weight fetching, and expert grouping.\n*   The following figure from the paper illustrates the offloading execution for the sparse part of a Transformer block. An expert E2E2E\\_2 and its corresponding input tokens XEXEX\\_E are fetched to GPU memory to produce E2′E2′E\\_2′, which together with the corresponding outputs YEYEY\\_E are written back to CPU again.\n\n![](../../../images/papers/QMoE.jpg)\n\n*   The experiments demonstrate that QMoE effectively compresses MoE models while maintaining performance. The system was tested on various datasets, including Arxiv, GitHub, StackExchange, and Wikipedia, showing good performance preservation even for highly compressed models.\n*   The paper provides detailed insights into the encoding and decoding processes and the kernel implementation for the GPU, highlighting the challenges and solutions for achieving sub-1-bit per parameter compression.\n*   The QMoE framework is a significant step towards practical deployment of massive-scale MoE models, addressing key limitations of MoE architectures and facilitating further research and understanding of such models.\n*   The paper’s findings are significant as they make it feasible to deploy and research trillion-parameter models on more accessible hardware, potentially democratizing access to high-performance LLMs and spurring further innovation in the field.",
    "contentLength": 11914,
    "wordCount": 505,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#qmoe:-practical-sub-1-bit-compression-of-trillion-parameter-models"
  },
  {
    "id": "ai-mixture-of-experts-megablocks-efficient-sparse-training-with-mixture--80",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "MegaBlocks: Efficient Sparse Training with Mixture-of-Experts",
    "order": 80,
    "orderInChapter": 8,
    "contentHtml": "<ul>\n  <li>This paper by Gale et al. from Stanford University, Microsoft Research, and Google Research, introduces Dropless MoE, a novel system for efficient MoE training on GPUs.</li>\n  <li>The system, named MegaBlocks, addresses the limitations of current frameworks that restrict dynamic routing in MoE layers, often leading to a tradeoff between model quality and hardware efficiency due to the necessity of dropping tokens or wasting computation on excessive padding. Token dropping leads to information loss, as it involves selectively ignoring part of the input data, while padding adds redundant data to make the varying input sizes uniform, which increases computational load without contributing to model learning. This challenge arises from the difficulty in efficiently handling the dynamic routing and load-imbalanced computation characteristic of MoE architectures, especially in the context of deep learning hardware and software constraints.</li>\n  <li>MegaBlocks innovatively reformulates MoE computations as block-sparse operations, developing new GPU kernels specifically for this purpose. These kernels efficiently manage dynamic, load-imbalanced computations inherent in MoEs without resorting to token dropping. This results in up to 40% faster end-to-end training compared to MoEs trained with the Tutel library, and 2.4 times speedup over DNNs trained with Megatron-LM.</li>\n  <li>The system’s core contributions include high-performance GPU kernels for block-sparse matrix multiplication, leveraging blocked-CSR-COO encoding and transpose indices. This setup enables efficient handling of sparse inputs and outputs in both transposed and non-transposed forms.</li>\n  <li>Built upon the Megatron-LM library for Transformer model training, MegaBlocks supports distributed MoE training with data and expert model parallelism. Its unique ability to avoid token dropping through block-sparse computation provides a fresh approach to MoE algorithms as a form of dynamic structured activation sparsity.</li>\n  <li>The figure below from the paper shows a Mixture-of-Experts Layer. Shown for <code class=\"language-plaintext highlighter-rouge\">num experts=3</code>, <code class=\"language-plaintext highlighter-rouge\">top k=1</code> and <code class=\"language-plaintext highlighter-rouge\">capacity factor=1</code> with the prevalent, token dropping formulation. First (1), tokens are mapped to experts by the router. Along with expert assignments, the router produces probabilities that reflect the confidence of the assignments. Second (2), the feature vectors are permuted to group tokens by expert assignment. If the number of tokens assigned to an expert exceeds its capacity, extra tokens are dropped. Third (3), the expert layers are computed for the set of tokens they were assigned as well as any padding needed for unused capacity. Lastly (4), the results of the expert computation are un-permuted and weighted by the router probabilities. The outputs for dropped tokens are shown here set to zero.</li>\n</ul>\n<p><img src=\"../../../images/papers/MegaBlocks.jpg\" alt=\"\"></p>\n<ul>\n  <li>Experiments demonstrate that MegaBlocks enables significant end-to-end training speedups for MoE models compared to existing approaches, especially as model size increases. The system also reduces the computational overhead and memory requirements associated with MoE layers, leading to more efficient utilization of hardware resources. Furthermore, the approach decreases the number of hyperparameters that need to be re-tuned for each model and task, simplifying the process of training large MoE models.</li>\n  <li>The paper provides detailed insights into the design and performance of the block-sparse kernels, including analyses of throughput relative to cuBLAS batched matrix multiplication and discussions on efficient routing and permutation for MoEs. The results show that MegaBlocks’ kernels perform comparably to cuBLAS, achieving an average of 98.6% of cuBLAS’s throughput with minimal variations across different configurations.</li>\n  <li><a href=\"https://github.com/stanford-futuredata/megablocks\">Code</a></li>\n</ul>",
    "contentMarkdown": "*   This paper by Gale et al. from Stanford University, Microsoft Research, and Google Research, introduces Dropless MoE, a novel system for efficient MoE training on GPUs.\n*   The system, named MegaBlocks, addresses the limitations of current frameworks that restrict dynamic routing in MoE layers, often leading to a tradeoff between model quality and hardware efficiency due to the necessity of dropping tokens or wasting computation on excessive padding. Token dropping leads to information loss, as it involves selectively ignoring part of the input data, while padding adds redundant data to make the varying input sizes uniform, which increases computational load without contributing to model learning. This challenge arises from the difficulty in efficiently handling the dynamic routing and load-imbalanced computation characteristic of MoE architectures, especially in the context of deep learning hardware and software constraints.\n*   MegaBlocks innovatively reformulates MoE computations as block-sparse operations, developing new GPU kernels specifically for this purpose. These kernels efficiently manage dynamic, load-imbalanced computations inherent in MoEs without resorting to token dropping. This results in up to 40% faster end-to-end training compared to MoEs trained with the Tutel library, and 2.4 times speedup over DNNs trained with Megatron-LM.\n*   The system’s core contributions include high-performance GPU kernels for block-sparse matrix multiplication, leveraging blocked-CSR-COO encoding and transpose indices. This setup enables efficient handling of sparse inputs and outputs in both transposed and non-transposed forms.\n*   Built upon the Megatron-LM library for Transformer model training, MegaBlocks supports distributed MoE training with data and expert model parallelism. Its unique ability to avoid token dropping through block-sparse computation provides a fresh approach to MoE algorithms as a form of dynamic structured activation sparsity.\n*   The figure below from the paper shows a Mixture-of-Experts Layer. Shown for `num experts=3`, `top k=1` and `capacity factor=1` with the prevalent, token dropping formulation. First (1), tokens are mapped to experts by the router. Along with expert assignments, the router produces probabilities that reflect the confidence of the assignments. Second (2), the feature vectors are permuted to group tokens by expert assignment. If the number of tokens assigned to an expert exceeds its capacity, extra tokens are dropped. Third (3), the expert layers are computed for the set of tokens they were assigned as well as any padding needed for unused capacity. Lastly (4), the results of the expert computation are un-permuted and weighted by the router probabilities. The outputs for dropped tokens are shown here set to zero.\n\n![](../../../images/papers/MegaBlocks.jpg)\n\n*   Experiments demonstrate that MegaBlocks enables significant end-to-end training speedups for MoE models compared to existing approaches, especially as model size increases. The system also reduces the computational overhead and memory requirements associated with MoE layers, leading to more efficient utilization of hardware resources. Furthermore, the approach decreases the number of hyperparameters that need to be re-tuned for each model and task, simplifying the process of training large MoE models.\n*   The paper provides detailed insights into the design and performance of the block-sparse kernels, including analyses of throughput relative to cuBLAS batched matrix multiplication and discussions on efficient routing and permutation for MoEs. The results show that MegaBlocks’ kernels perform comparably to cuBLAS, achieving an average of 98.6% of cuBLAS’s throughput with minimal variations across different configurations.\n*   [Code](https://github.com/stanford-futuredata/megablocks)",
    "contentLength": 4140,
    "wordCount": 537,
    "hasCode": true,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#megablocks:-efficient-sparse-training-with-mixture-of-experts"
  },
  {
    "id": "ai-mixture-of-experts-moe-llava-mixture-of-experts-for-large-vision-lang-81",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "MoE-LLaVA: Mixture of Experts for Large Vision-Language Models",
    "order": 81,
    "orderInChapter": 9,
    "contentHtml": "<ul>\n  <li>This paper by Lin et al. from Peking University, Sun Yat-sen University, FarReel Ai Lab, Tencent Data Platform, and Peng Cheng Laboratory introduces MoE-LLaVA, a novel training strategy for Large Vision-Language Models (LVLMs). The strategy, known as MoE-tuning, constructs a sparse model with a large number of parameters while maintaining constant computational costs and effectively addressing performance degradation in multi-modal learning and model sparsity.</li>\n  <li>MoE-LLaVA uniquely activates only the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-462-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3690\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3691\"><span class=\"mi\" id=\"MathJax-Span-3692\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-462\">k</script> experts through routers during deployment, keeping the remaining experts inactive. This approach results in impressive visual understanding capabilities and reduces hallucinations in model outputs. Remarkably, with 3 billion sparsely activated parameters, MoE-LLaVA performs comparably to the LLaVA-1.5-7B and surpasses the LLaVA-1.5-13B in object hallucination benchmarks.</li>\n  <li>The architecture of MoE-LLaVA includes a vision encoder, a visual projection layer (MLP), a word embedding layer, multiple stacked LLM blocks, and MoE blocks. The MoE-tuning process involves three stages: In Stage I, an MLP adapts visual tokens to the LLM. Stage II trains the whole LLM’s parameters except for the Vision Encoder (VE), and in Stage III, FFNs are used to initialize the experts in MoE, and only the MoE layers are trained.</li>\n  <li>The following image from the paper illustrates MoE-tuning. The MoE-tuning consists of three stages. In stage I, only the MLP is trained. In stage II, all parameters are trained except for the Vision Encoder (VE). In stage III, FFNs are used to initialize the experts in MoE, and only the MoE layers are trained. For each MoE layer, only two experts are activated for each token, while the other experts remain silent.</li>\n</ul>\n<p><img src=\"../../../images/papers/MoE-LLaVA.jpg\" alt=\"\"></p>\n<ul>\n  <li>The model was evaluated on various visual understanding datasets, demonstrating its efficiency and effectiveness. MoE-LLaVA’s performance was on par with or even superior to state-of-the-art models with fewer activated parameters. The paper also includes extensive ablation studies and visualizations to illustrate the effectiveness of the MoE-tuning strategy and the MoE-LLaVA architecture.</li>\n  <li>The paper provides a significant contribution to the field of multi-modal learning systems, offering insights for future research in developing more efficient and effective systems.</li>\n  <li><a href=\"https://github.com/PKU-YuanGroup/MoE-LLaVA\">Code</a></li>\n</ul>",
    "contentMarkdown": "*   This paper by Lin et al. from Peking University, Sun Yat-sen University, FarReel Ai Lab, Tencent Data Platform, and Peng Cheng Laboratory introduces MoE-LLaVA, a novel training strategy for Large Vision-Language Models (LVLMs). The strategy, known as MoE-tuning, constructs a sparse model with a large number of parameters while maintaining constant computational costs and effectively addressing performance degradation in multi-modal learning and model sparsity.\n*   MoE-LLaVA uniquely activates only the top-kkk experts through routers during deployment, keeping the remaining experts inactive. This approach results in impressive visual understanding capabilities and reduces hallucinations in model outputs. Remarkably, with 3 billion sparsely activated parameters, MoE-LLaVA performs comparably to the LLaVA-1.5-7B and surpasses the LLaVA-1.5-13B in object hallucination benchmarks.\n*   The architecture of MoE-LLaVA includes a vision encoder, a visual projection layer (MLP), a word embedding layer, multiple stacked LLM blocks, and MoE blocks. The MoE-tuning process involves three stages: In Stage I, an MLP adapts visual tokens to the LLM. Stage II trains the whole LLM’s parameters except for the Vision Encoder (VE), and in Stage III, FFNs are used to initialize the experts in MoE, and only the MoE layers are trained.\n*   The following image from the paper illustrates MoE-tuning. The MoE-tuning consists of three stages. In stage I, only the MLP is trained. In stage II, all parameters are trained except for the Vision Encoder (VE). In stage III, FFNs are used to initialize the experts in MoE, and only the MoE layers are trained. For each MoE layer, only two experts are activated for each token, while the other experts remain silent.\n\n![](../../../images/papers/MoE-LLaVA.jpg)\n\n*   The model was evaluated on various visual understanding datasets, demonstrating its efficiency and effectiveness. MoE-LLaVA’s performance was on par with or even superior to state-of-the-art models with fewer activated parameters. The paper also includes extensive ablation studies and visualizations to illustrate the effectiveness of the MoE-tuning strategy and the MoE-LLaVA architecture.\n*   The paper provides a significant contribution to the field of multi-modal learning systems, offering insights for future research in developing more efficient and effective systems.\n*   [Code](https://github.com/PKU-YuanGroup/MoE-LLaVA)",
    "contentLength": 3811,
    "wordCount": 346,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#moe-llava:-mixture-of-experts-for-large-vision-language-models"
  },
  {
    "id": "ai-mixture-of-experts-mixture-of-lora-experts-82",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Mixture of LoRA Experts",
    "order": 82,
    "orderInChapter": 10,
    "contentHtml": "<ul>\n  <li>This paper by Wu et al. from MSR Asia and Tsinghua University, published in ICLR 2024, proposes Mixture of LoRA Experts (MOLE), focusing on efficient composition of Low-Rank Adaptation (LoRA) techniques. It addresses the challenge of effectively integrating multiple trained LoRAs, a method previously developed to fine-tune large pre-trained models with minimal computational overhead.</li>\n  <li><strong>MOLE</strong> employs a hierarchical weight control approach where each layer of a LoRA is treated as an expert. By integrating a learnable gating function within each layer, MOLE determines optimal composition weights tailored to specific domain objectives. This method enhances the performance of LoRA compositions and preserves their flexibility, addressing the limitations of linear arithmetic and reference tuning-based compositions which either diminish generative capabilities or involve high training costs.</li>\n  <li>The figure below from the paper illustrates an overview of LoRA composition methods: (a) Linear arithmetic composition, which commonly applies the same composition weight <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-463-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi mathvariant=&quot;bold-italic&quot;>W</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3693\" style=\"width: 1.409em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.15em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3694\"><span class=\"msubsup\" id=\"MathJax-Span-3695\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.94em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3696\" style=\"font-family: STIXGeneral; font-style: italic; font-weight: bold;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.888em;\"><span class=\"mi\" id=\"MathJax-Span-3697\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi mathvariant=\"bold-italic\">W</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-463\">\\boldsymbol{W}_i</script> to all layers of the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-464-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>th</mtext></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3698\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.89em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3699\"><span class=\"msubsup\" id=\"MathJax-Span-3700\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3701\" style=\"font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3702\"><span class=\"mrow\" id=\"MathJax-Span-3703\"><span class=\"mtext\" id=\"MathJax-Span-3704\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">th</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>th</mtext></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-464\">i^{\\text {th}}</script> LoRA. (b) Reference tuning-based composition involves retraining a large model by integrating outputs from multiple LoRAs using manually-crafted mask information. (c) Our MoLE, which learns a distribution <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-465-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi mathvariant=&quot;normal&quot;>&amp;#x03A5;</mi><mi>j</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3705\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.99em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3706\"><span class=\"msubsup\" id=\"MathJax-Span-3707\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3708\" style=\"font-family: STIXGeneral-Regular;\">Υ</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-3709\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi mathvariant=\"normal\">Υ</mi><mi>j</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-465\">\\Upsilon^j</script> for the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-466-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>j</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>th</mtext></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3710\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.94em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3711\"><span class=\"msubsup\" id=\"MathJax-Span-3712\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3713\" style=\"font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.315em;\"><span class=\"texatom\" id=\"MathJax-Span-3714\"><span class=\"mrow\" id=\"MathJax-Span-3715\"><span class=\"mtext\" id=\"MathJax-Span-3716\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">th</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>j</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>th</mtext></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-466\">j^{\\text {th}}</script> layer of LoRAs to determine the composition weight <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-467-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi mathvariant=&quot;bold-italic&quot;>W</mi><mi>i</mi><mi>j</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3717\" style=\"width: 1.565em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.044em, 1001.3em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3718\"><span class=\"msubsup\" id=\"MathJax-Span-3719\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.94em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3720\" style=\"font-family: STIXGeneral; font-style: italic; font-weight: bold;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.326em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-3721\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.888em;\"><span class=\"mi\" id=\"MathJax-Span-3722\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi mathvariant=\"bold-italic\">W</mi><mi>i</mi><mi>j</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-467\">\\boldsymbol{W}_i^j</script>.</li>\n</ul>\n<p><img src=\"../../../images/papers/MOLE.jpg\" alt=\"\"></p>\n<ul>\n  <li>During the training phase, MOLE predicts weights for each expert using a gating function while keeping other parameters frozen, resulting in minimal computational costs. In the inference phase, MOLE can utilize all trained LoRAs with preserved characteristics or allow for manual masking of LoRAs to adjust weights dynamically without retraining.</li>\n  <li>The architecture incorporates gating functions at various hierarchical levels to effectively manage the contributions of different LoRA layers. The paper details two distinct inference modes facilitated by MOLE, enhancing its adaptability across various scenarios and tasks in both NLP and Vision &amp; Language domains.</li>\n  <li>The figure below from the paper illustrates the orkflow of MOLE. In the training phase, MOLE predicts weights for multiple LoRAs. In the inference phase, MOLE can allocate weights to multiple LoRAs, or, without altering the gating weights, achieve a more flexible LoRA composition by masking out undesired LoRAs and recalculating and distributing weights proportionally.</li>\n</ul>\n<p><img src=\"../../../images/papers/MOLE2.jpg\" alt=\"\"></p>\n<ul>\n  <li>Extensive experiments demonstrate that MOLE outperforms existing LoRA composition methods in terms of both qualitative and quantitative measures. Results from NLP and Vision &amp; Language tasks illustrate that MOLE consistently achieves superior performance compared to traditional composition methods, validating its approach in a real-world setting.</li>\n  <li><a href=\"https://github.com/yushuiwx/MoLE\">Code</a></li>\n</ul>",
    "contentMarkdown": "*   This paper by Wu et al. from MSR Asia and Tsinghua University, published in ICLR 2024, proposes Mixture of LoRA Experts (MOLE), focusing on efficient composition of Low-Rank Adaptation (LoRA) techniques. It addresses the challenge of effectively integrating multiple trained LoRAs, a method previously developed to fine-tune large pre-trained models with minimal computational overhead.\n*   **MOLE** employs a hierarchical weight control approach where each layer of a LoRA is treated as an expert. By integrating a learnable gating function within each layer, MOLE determines optimal composition weights tailored to specific domain objectives. This method enhances the performance of LoRA compositions and preserves their flexibility, addressing the limitations of linear arithmetic and reference tuning-based compositions which either diminish generative capabilities or involve high training costs.\n*   The figure below from the paper illustrates an overview of LoRA composition methods: (a) Linear arithmetic composition, which commonly applies the same composition weight WiWi\\\\boldsymbol{W}\\_i to all layers of the ithithi^{\\\\text {th}} LoRA. (b) Reference tuning-based composition involves retraining a large model by integrating outputs from multiple LoRAs using manually-crafted mask information. (c) Our MoLE, which learns a distribution ΥjΥj\\\\Upsilon^j for the jthjthj^{\\\\text {th}} layer of LoRAs to determine the composition weight WjiWij\\\\boldsymbol{W}\\_i^j.\n\n![](../../../images/papers/MOLE.jpg)\n\n*   During the training phase, MOLE predicts weights for each expert using a gating function while keeping other parameters frozen, resulting in minimal computational costs. In the inference phase, MOLE can utilize all trained LoRAs with preserved characteristics or allow for manual masking of LoRAs to adjust weights dynamically without retraining.\n*   The architecture incorporates gating functions at various hierarchical levels to effectively manage the contributions of different LoRA layers. The paper details two distinct inference modes facilitated by MOLE, enhancing its adaptability across various scenarios and tasks in both NLP and Vision & Language domains.\n*   The figure below from the paper illustrates the orkflow of MOLE. In the training phase, MOLE predicts weights for multiple LoRAs. In the inference phase, MOLE can allocate weights to multiple LoRAs, or, without altering the gating weights, achieve a more flexible LoRA composition by masking out undesired LoRAs and recalculating and distributing weights proportionally.\n\n![](../../../images/papers/MOLE2.jpg)\n\n*   Extensive experiments demonstrate that MOLE outperforms existing LoRA composition methods in terms of both qualitative and quantitative measures. Results from NLP and Vision & Language tasks illustrate that MOLE consistently achieves superior performance compared to traditional composition methods, validating its approach in a real-world setting.\n*   [Code](https://github.com/yushuiwx/MoLE)",
    "contentLength": 13717,
    "wordCount": 401,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mixture-of-lora-experts"
  },
  {
    "id": "ai-mixture-of-experts-jetmoe-reaching-llama2-performance-with-01m-dollar-83",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "JetMoE: Reaching Llama2 Performance with 0.1M Dollars",
    "order": 83,
    "orderInChapter": 11,
    "contentHtml": "<ul>\n  <li>This paper by Shen et al. from MIT-IBM Watson AI Lab, MIT EECS, Princeton University, and MyShell.ai &amp; MIT introduces JetMoE-8B, a cost-effective large language model developed at the MIT-IBM Watson AI Lab, outperforming established models like Llama2-7B and Llama2-13B-Chat. JetMoE-8B extends the concept of sparse activation to both the attention and feed-forward layers. Despite being trained on a tight budget of under $100,000, JetMoE-8B employs 8 billion parameters, leveraging a Sparsely-gated Mixture-of-Experts (SMoE) architecture that activates only 2 billion parameters per input token. This architecture reduces inference computation by approximately 70% compared to Llama2-7B.</li>\n  <li>JetMoE-8B is trained using the Megatron framework with Megablock enhancements, using pipeline parallelism to optimize computational costs and load balance during training. Notably, it incorporates innovations like shared KV projection in attention layers and a frequency-based auxiliary loss for training efficiency.</li>\n  <li>The figure below from the paper illustrates the JetMoE architecture.</li>\n</ul>\n<p><img src=\"../../../images/papers/JetMoE.jpg\" alt=\"\"></p>\n<ul>\n  <li>For pretraining, JetMoE-8B utilized a mixture of real-world and synthetic datasets, totaling 1.25 trillion tokens. Datasets include RefinedWeb, StarCoder, and various components from The Pile, combined with synthetic datasets like OpenHermes 2.5 for diverse training inputs.</li>\n  <li>Utilized a two-phase training approach, incorporating a mix of real and synthetic datasets with adjustments in data weighting during the learning rate decay phase to enhance model performance.</li>\n  <li>The model underwent Distilled Supervised Fine-Tuning (dSFT) and Distilled Direct Preference Optimization (dDPO), refining model responses based on preferences from a teacher model to improve alignment with human-like conversational abilities.</li>\n  <li>JetMoE-8B’s performance was benchmarked against other models in tasks like ARC-challenge, Hellaswag, and MMLU, showing superior performance in many areas, particularly in code-related benchmarks like MBPP and HumanEval.</li>\n  <li>The training parameters, model configurations, and data mixtures are fully documented and made open-source to foster further academic and practical advancements in efficient LLM training methodologies.</li>\n  <li><a href=\"https://github.com/myshell-ai/JetMoE\">Code</a></li>\n</ul>",
    "contentMarkdown": "*   This paper by Shen et al. from MIT-IBM Watson AI Lab, MIT EECS, Princeton University, and MyShell.ai & MIT introduces JetMoE-8B, a cost-effective large language model developed at the MIT-IBM Watson AI Lab, outperforming established models like Llama2-7B and Llama2-13B-Chat. JetMoE-8B extends the concept of sparse activation to both the attention and feed-forward layers. Despite being trained on a tight budget of under $100,000, JetMoE-8B employs 8 billion parameters, leveraging a Sparsely-gated Mixture-of-Experts (SMoE) architecture that activates only 2 billion parameters per input token. This architecture reduces inference computation by approximately 70% compared to Llama2-7B.\n*   JetMoE-8B is trained using the Megatron framework with Megablock enhancements, using pipeline parallelism to optimize computational costs and load balance during training. Notably, it incorporates innovations like shared KV projection in attention layers and a frequency-based auxiliary loss for training efficiency.\n*   The figure below from the paper illustrates the JetMoE architecture.\n\n![](../../../images/papers/JetMoE.jpg)\n\n*   For pretraining, JetMoE-8B utilized a mixture of real-world and synthetic datasets, totaling 1.25 trillion tokens. Datasets include RefinedWeb, StarCoder, and various components from The Pile, combined with synthetic datasets like OpenHermes 2.5 for diverse training inputs.\n*   Utilized a two-phase training approach, incorporating a mix of real and synthetic datasets with adjustments in data weighting during the learning rate decay phase to enhance model performance.\n*   The model underwent Distilled Supervised Fine-Tuning (dSFT) and Distilled Direct Preference Optimization (dDPO), refining model responses based on preferences from a teacher model to improve alignment with human-like conversational abilities.\n*   JetMoE-8B’s performance was benchmarked against other models in tasks like ARC-challenge, Hellaswag, and MMLU, showing superior performance in many areas, particularly in code-related benchmarks like MBPP and HumanEval.\n*   The training parameters, model configurations, and data mixtures are fully documented and made open-source to foster further academic and practical advancements in efficient LLM training methodologies.\n*   [Code](https://github.com/myshell-ai/JetMoE)",
    "contentLength": 2449,
    "wordCount": 305,
    "hasCode": false,
    "hasMath": false,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#jetmoe:-reaching-llama2-performance-with-0.1m-dollars"
  },
  {
    "id": "ai-mixture-of-experts-qmoe-practical-sub-1-bit-compression-of-trillion-p-84",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "QMoE: Practical Sub-1-Bit Compression of Trillion-Parameter Models",
    "order": 84,
    "orderInChapter": 12,
    "contentHtml": "<ul>\n  <li>This paper by Frantar and Alistarh from the Institute of Science and Technology Austria and Neural Magic Inc. presents QMoE, a framework designed to address the memory challenges in deploying large language models (LLMs) with MoE architectures.</li>\n  <li>The key problem QMoE addresses is the massive memory requirement of large models, exemplified by the 1.6 trillion-parameter SwitchTransformer-c2048 model, which typically requires 3.2TB of memory. QMoE effectively compresses such models to less than 1 bit per parameter, enabling their execution on commodity hardware with minor runtime overheads.</li>\n  <li>QMoE employs a scalable algorithm and a custom compression format paired with GPU decoding kernels. It compresses the SwitchTransformer-c2048 model to less than 160GB (0.8 bits per parameter) with minor accuracy loss in under a day on a single GPU.</li>\n  <li>The implementation includes a highly scalable compression algorithm and a bespoke compression format, facilitating efficient end-to-end compressed inference. The framework enables running trillion-parameter models on affordable hardware, like servers equipped with NVIDIA GPUs, at less than 5% runtime overhead compared to ideal uncompressed execution.</li>\n  <li>The paper discusses the challenges in compressing MoE models, including conceptual issues with existing post-training compression methods and practical scaling challenges. It overcomes these by introducing a custom compression format and highly-efficient decoding algorithms optimized for GPU accelerators.</li>\n  <li>The technical contributions include a novel approach to handling massive activation sets and a unique system design for optimized activation offloading, expert grouping, and robustness modifications, ensuring efficient application of data-dependent compression to massive MoEs.</li>\n  <li>The framework significantly reduces the size of large models, with QMoE compressed models achieving over 20x compression rates compared to 16-bit precision models. This reduction in size is accompanied by minor increases in loss on pretraining validation and zero-shot data.</li>\n  <li>The paper also discusses the system design and optimizations made to address memory costs, GPU utilization, and reliability requirements. These include techniques like optimized activation offloading, list buffer data structures, lazy weight fetching, and expert grouping.</li>\n  <li>The following figure from the paper illustrates the offloading execution for the sparse part of a Transformer block. An expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-468-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mn>2</mn></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3723\" style=\"width: 1.253em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.04em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3724\"><span class=\"msubsup\" id=\"MathJax-Span-3725\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3726\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mn\" id=\"MathJax-Span-3727\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mn>2</mn></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-468\">E_2</script> and its corresponding input\ntokens <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-469-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mi>E</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3728\" style=\"width: 1.409em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.15em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3729\"><span class=\"msubsup\" id=\"MathJax-Span-3730\"><span style=\"display: inline-block; position: relative; width: 1.148em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3731\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-3732\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>X</mi><mi>E</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-469\">X_E</script> are fetched to GPU memory to produce <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-470-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mn>2</mn></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2032;</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3733\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1001.2em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3734\"><span class=\"msubsup\" id=\"MathJax-Span-3735\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3736\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mn\" id=\"MathJax-Span-3737\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"texatom\" id=\"MathJax-Span-3738\"><span class=\"mrow\" id=\"MathJax-Span-3739\"><span class=\"mo\" id=\"MathJax-Span-3740\" style=\"font-family: STIXGeneral-Regular;\">′</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mn>2</mn></msub><mrow class=\"MJX-TeXAtom-ORD\"><mo>′</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-470\">E_2′</script>, which together with the corresponding outputs <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-471-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>Y</mi><mi>E</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3741\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3742\"><span class=\"msubsup\" id=\"MathJax-Span-3743\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3744\" style=\"font-family: STIXGeneral-Italic;\">Y<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3745\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>Y</mi><mi>E</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-471\">Y_E</script> are written back to CPU again.</li>\n</ul>\n<p><img src=\"../../../images/papers/QMoE.jpg\" alt=\"\"></p>\n<ul>\n  <li>The experiments demonstrate that QMoE effectively compresses MoE models while maintaining performance. The system was tested on various datasets, including Arxiv, GitHub, StackExchange, and Wikipedia, showing good performance preservation even for highly compressed models.</li>\n  <li>The paper provides detailed insights into the encoding and decoding processes and the kernel implementation for the GPU, highlighting the challenges and solutions for achieving sub-1-bit per parameter compression.</li>\n  <li>The QMoE framework is a significant step towards practical deployment of massive-scale MoE models, addressing key limitations of MoE architectures and facilitating further research and understanding of such models.</li>\n  <li>The paper’s findings are significant as they make it feasible to deploy and research trillion-parameter models on more accessible hardware, potentially democratizing access to high-performance LLMs and spurring further innovation in the field.</li>\n</ul>",
    "contentMarkdown": "*   This paper by Frantar and Alistarh from the Institute of Science and Technology Austria and Neural Magic Inc. presents QMoE, a framework designed to address the memory challenges in deploying large language models (LLMs) with MoE architectures.\n*   The key problem QMoE addresses is the massive memory requirement of large models, exemplified by the 1.6 trillion-parameter SwitchTransformer-c2048 model, which typically requires 3.2TB of memory. QMoE effectively compresses such models to less than 1 bit per parameter, enabling their execution on commodity hardware with minor runtime overheads.\n*   QMoE employs a scalable algorithm and a custom compression format paired with GPU decoding kernels. It compresses the SwitchTransformer-c2048 model to less than 160GB (0.8 bits per parameter) with minor accuracy loss in under a day on a single GPU.\n*   The implementation includes a highly scalable compression algorithm and a bespoke compression format, facilitating efficient end-to-end compressed inference. The framework enables running trillion-parameter models on affordable hardware, like servers equipped with NVIDIA GPUs, at less than 5% runtime overhead compared to ideal uncompressed execution.\n*   The paper discusses the challenges in compressing MoE models, including conceptual issues with existing post-training compression methods and practical scaling challenges. It overcomes these by introducing a custom compression format and highly-efficient decoding algorithms optimized for GPU accelerators.\n*   The technical contributions include a novel approach to handling massive activation sets and a unique system design for optimized activation offloading, expert grouping, and robustness modifications, ensuring efficient application of data-dependent compression to massive MoEs.\n*   The framework significantly reduces the size of large models, with QMoE compressed models achieving over 20x compression rates compared to 16-bit precision models. This reduction in size is accompanied by minor increases in loss on pretraining validation and zero-shot data.\n*   The paper also discusses the system design and optimizations made to address memory costs, GPU utilization, and reliability requirements. These include techniques like optimized activation offloading, list buffer data structures, lazy weight fetching, and expert grouping.\n*   The following figure from the paper illustrates the offloading execution for the sparse part of a Transformer block. An expert E2E2E\\_2 and its corresponding input tokens XEXEX\\_E are fetched to GPU memory to produce E2′E2′E\\_2′, which together with the corresponding outputs YEYEY\\_E are written back to CPU again.\n\n![](../../../images/papers/QMoE.jpg)\n\n*   The experiments demonstrate that QMoE effectively compresses MoE models while maintaining performance. The system was tested on various datasets, including Arxiv, GitHub, StackExchange, and Wikipedia, showing good performance preservation even for highly compressed models.\n*   The paper provides detailed insights into the encoding and decoding processes and the kernel implementation for the GPU, highlighting the challenges and solutions for achieving sub-1-bit per parameter compression.\n*   The QMoE framework is a significant step towards practical deployment of massive-scale MoE models, addressing key limitations of MoE architectures and facilitating further research and understanding of such models.\n*   The paper’s findings are significant as they make it feasible to deploy and research trillion-parameter models on more accessible hardware, potentially democratizing access to high-performance LLMs and spurring further innovation in the field.",
    "contentLength": 11914,
    "wordCount": 505,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#qmoe:-practical-sub-1-bit-compression-of-trillion-parameter-models"
  },
  {
    "id": "ai-mixture-of-experts-cumo-scaling-multimodal-llm-with-co-upcycled-mixtu-85",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "CuMo: Scaling Multimodal LLM with Co-Upcycled Mixture-of-Experts",
    "order": 85,
    "orderInChapter": 13,
    "contentHtml": "<ul>\n  <li>\n    <p>This paper by Li et al. from SHI Labs (Georgia Tech &amp; UIUC) and ByteDance introduces <strong>CuMo</strong>, a multimodal large language model (LLM) framework that scales visual understanding capabilities using <strong>Co-Upcycled MoE</strong> blocks integrated into the <strong>vision encoder</strong> and <strong>MLP connector</strong>, while maintaining minimal additional inference cost. CuMo aims to improve the scalability and efficiency of multimodal LLMs by incorporating sparsity through MoE design, especially on the <strong>vision side</strong>, which has been underexplored in previous works.</p>\n  </li>\n  <li>\n    <p><strong>Core Concept and Motivation</strong>: Prior efforts in scaling multimodal LLMs focused primarily on increasing paired image-text data or enhancing LLMs, which is computationally intensive. CuMo instead targets the <strong>vision modules</strong> by integrating <strong>sparsely-gated Top-K MoE blocks</strong> to enhance capability without substantially increasing inference costs.</p>\n  </li>\n  <li>\n    <p><strong>Architecture and Implementation</strong>:</p>\n\n    <ul>\n      <li>\n        <p><strong>MoE Integration</strong>:</p>\n\n        <ul>\n          <li>\n            <p>CuMo inserts Top-K sparsely-gated MoE blocks into:</p>\n\n            <ul>\n              <li><strong>Vision Encoder</strong> (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.</li>\n              <li><strong>Vision-Language MLP Connector</strong>: A two-layer MLP is replaced by a sparse MoE block.</li>\n            </ul>\n          </li>\n          <li>Each MoE block consists of multiple experts (e.g., 4 or 8), with a <strong>router network</strong> trained to select Top-K experts (usually K=2) for each input token.</li>\n          <li>Output of MoE block:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-472-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>K</mi></mrow></munderover><msub><mi>W</mi><mi>i</mi></msub><mo>&amp;#x22C5;</mo><msub><mtext>MLP</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3746\" style=\"width: 13.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.84em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3747\"><span class=\"msubsup\" id=\"MathJax-Span-3748\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3749\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-3750\"><span class=\"mrow\" id=\"MathJax-Span-3751\"><span class=\"mi\" id=\"MathJax-Span-3752\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span class=\"mi\" id=\"MathJax-Span-3753\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">u</span><span class=\"mi\" id=\"MathJax-Span-3754\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3755\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3756\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3757\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3758\"><span class=\"mrow\" id=\"MathJax-Span-3759\"><span class=\"mi\" id=\"MathJax-Span-3760\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3761\"><span class=\"mrow\" id=\"MathJax-Span-3762\"><span class=\"mi\" id=\"MathJax-Span-3763\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3764\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3765\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3766\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3767\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3768\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3769\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3770\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3771\" style=\"font-family: STIXGeneral-Regular;\">MLP</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-3772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3773\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3774\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3775\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>X</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>K</mi></mrow></munderover><msub><mi>W</mi><mi>i</mi></msub><mo>⋅</mo><msub><mtext>MLP</mtext><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-472\">X_{out} = \\sum_{i=1}^{K} W_i \\cdot \\text{MLP}_i(X)</script>\nwhere <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-473-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3776\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3777\"><span class=\"msubsup\" id=\"MathJax-Span-3778\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3779\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3780\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-473\">W_i</script> is the re-normalized gating weight for the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-474-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3781\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.94em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3782\"><span class=\"msubsup\" id=\"MathJax-Span-3783\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3784\" style=\"font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3785\"><span class=\"mrow\" id=\"MathJax-Span-3786\"><span class=\"mi\" id=\"MathJax-Span-3787\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3788\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-474\">i^{th}</script> selected expert.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training Methodology</strong>:</p>\n\n        <ul>\n          <li>\n            <p><strong>Three-Stage Training</strong>:</p>\n\n            <ol>\n              <li><strong>Pre-training Stage</strong>: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.</li>\n              <li><strong>Pre-finetuning Stage</strong>: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.</li>\n              <li><strong>Visual Instruction Tuning</strong>: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.</li>\n            </ol>\n          </li>\n          <li>\n            <p><strong>Co-Upcycling Initialization</strong>:</p>\n\n            <ul>\n              <li>Experts in MoE blocks are <strong>initialized from pretrained MLP layers</strong>, which stabilizes convergence and reduces training cost. This technique is referred to as <strong>co-upcycling</strong>.</li>\n              <li>The Top-K router is trained from scratch during instruction tuning.</li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Loss Function</strong>:</p>\n\n        <ul>\n          <li>\n            <p>Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-475-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3789\" style=\"width: 10.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 9.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1009.01em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3790\"><span class=\"mi\" id=\"MathJax-Span-3791\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3792\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-3793\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3794\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3795\"><span class=\"mrow\" id=\"MathJax-Span-3796\"><span class=\"mi\" id=\"MathJax-Span-3797\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3798\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3799\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3800\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3801\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3802\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3803\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3804\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3805\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3806\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3807\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3808\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3809\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3810\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3811\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3812\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>α</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>α</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-475\">L = L_{ce} + \\alpha_b L_b + \\alpha_z L_z</script>\nwhere:</p>\n\n            <ul>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-476-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3813\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3814\"><span class=\"msubsup\" id=\"MathJax-Span-3815\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3816\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3817\"><span class=\"mrow\" id=\"MathJax-Span-3818\"><span class=\"mi\" id=\"MathJax-Span-3819\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3820\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-476\">L_{ce}</script>: language modeling loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-477-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>b</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3821\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3822\"><span class=\"msubsup\" id=\"MathJax-Span-3823\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3824\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>b</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-477\">L_b</script>: load balancing loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-478-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3826\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3827\"><span class=\"msubsup\" id=\"MathJax-Span-3828\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3829\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3830\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-478\">L_z</script>: router z-loss</li>\n              <li>Constants: <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-479-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3831\" style=\"width: 4.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.44em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.34em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3832\"><span class=\"msubsup\" id=\"MathJax-Span-3833\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3834\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3835\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3836\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3837\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-479\">\\alpha_b = 0.1</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-480-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3838\" style=\"width: 4.638em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.857em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.75em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3839\"><span class=\"msubsup\" id=\"MathJax-Span-3840\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3841\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3842\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3843\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3844\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-480\">\\alpha_z = 0.01</script></li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>LLM Backbone</strong>:</p>\n\n        <ul>\n          <li>Uses Mistral-7B as base LLM.</li>\n          <li>Authors tested upcycling LLM as well, but found pre-trained MoE models (e.g., Mixtral 8×7B) significantly better, so <strong>LLMs are not upcycled</strong> in final CuMo.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Training Datasets</strong>:</p>\n\n    <ul>\n      <li>Visual instruction tuning leverages a blend of public datasets: LLaVA-665K, ShareGPT4V, LAION-GPT-V, DocVQA, ChartQA, AI2D, InfoVQA, SynDog-EN, ALLaVA, and LIMA.</li>\n    </ul>\n  </li>\n  <li>\n    <p>The following figure from the paper shows the architecture of CuMo, which incorporates sparse Top-K MoE blocks into the CLIP vision encoder and vision-language MLP connector, thereby improving the multimodal LLM capabilities from the vision side. Skip connections are omitted for simplicity.</p>\n  </li>\n</ul>\n<p>This paper by Li et al. from SHI Labs (Georgia Tech &amp; UIUC) and ByteDance introduces <strong>CuMo</strong>, a multimodal large language model (LLM) framework that scales visual understanding capabilities using <strong>Co-Upcycled MoE</strong> blocks integrated into the <strong>vision encoder</strong> and <strong>MLP connector</strong>, while maintaining minimal additional inference cost. CuMo aims to improve the scalability and efficiency of multimodal LLMs by incorporating sparsity through MoE design, especially on the <strong>vision side</strong>, which has been underexplored in previous works.</p>\n<p><strong>Core Concept and Motivation</strong>: Prior efforts in scaling multimodal LLMs focused primarily on increasing paired image-text data or enhancing LLMs, which is computationally intensive. CuMo instead targets the <strong>vision modules</strong> by integrating <strong>sparsely-gated Top-K MoE blocks</strong> to enhance capability without substantially increasing inference costs.</p>\n<p><strong>Architecture and Implementation</strong>:</p>\n<ul>\n      <li>\n        <p><strong>MoE Integration</strong>:</p>\n\n        <ul>\n          <li>\n            <p>CuMo inserts Top-K sparsely-gated MoE blocks into:</p>\n\n            <ul>\n              <li><strong>Vision Encoder</strong> (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.</li>\n              <li><strong>Vision-Language MLP Connector</strong>: A two-layer MLP is replaced by a sparse MoE block.</li>\n            </ul>\n          </li>\n          <li>Each MoE block consists of multiple experts (e.g., 4 or 8), with a <strong>router network</strong> trained to select Top-K experts (usually K=2) for each input token.</li>\n          <li>Output of MoE block:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-472-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>K</mi></mrow></munderover><msub><mi>W</mi><mi>i</mi></msub><mo>&amp;#x22C5;</mo><msub><mtext>MLP</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3746\" style=\"width: 13.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.84em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3747\"><span class=\"msubsup\" id=\"MathJax-Span-3748\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3749\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-3750\"><span class=\"mrow\" id=\"MathJax-Span-3751\"><span class=\"mi\" id=\"MathJax-Span-3752\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span class=\"mi\" id=\"MathJax-Span-3753\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">u</span><span class=\"mi\" id=\"MathJax-Span-3754\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3755\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3756\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3757\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3758\"><span class=\"mrow\" id=\"MathJax-Span-3759\"><span class=\"mi\" id=\"MathJax-Span-3760\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3761\"><span class=\"mrow\" id=\"MathJax-Span-3762\"><span class=\"mi\" id=\"MathJax-Span-3763\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3764\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3765\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3766\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3767\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3768\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3769\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3770\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3771\" style=\"font-family: STIXGeneral-Regular;\">MLP</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-3772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3773\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3774\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3775\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>X</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>K</mi></mrow></munderover><msub><mi>W</mi><mi>i</mi></msub><mo>⋅</mo><msub><mtext>MLP</mtext><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-472\">X_{out} = \\sum_{i=1}^{K} W_i \\cdot \\text{MLP}_i(X)</script>\nwhere <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-473-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3776\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3777\"><span class=\"msubsup\" id=\"MathJax-Span-3778\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3779\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3780\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-473\">W_i</script> is the re-normalized gating weight for the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-474-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3781\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.94em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3782\"><span class=\"msubsup\" id=\"MathJax-Span-3783\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3784\" style=\"font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3785\"><span class=\"mrow\" id=\"MathJax-Span-3786\"><span class=\"mi\" id=\"MathJax-Span-3787\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3788\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-474\">i^{th}</script> selected expert.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training Methodology</strong>:</p>\n\n        <ul>\n          <li>\n            <p><strong>Three-Stage Training</strong>:</p>\n\n            <ol>\n              <li><strong>Pre-training Stage</strong>: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.</li>\n              <li><strong>Pre-finetuning Stage</strong>: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.</li>\n              <li><strong>Visual Instruction Tuning</strong>: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.</li>\n            </ol>\n          </li>\n          <li>\n            <p><strong>Co-Upcycling Initialization</strong>:</p>\n\n            <ul>\n              <li>Experts in MoE blocks are <strong>initialized from pretrained MLP layers</strong>, which stabilizes convergence and reduces training cost. This technique is referred to as <strong>co-upcycling</strong>.</li>\n              <li>The Top-K router is trained from scratch during instruction tuning.</li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Loss Function</strong>:</p>\n\n        <ul>\n          <li>\n            <p>Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-475-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3789\" style=\"width: 10.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 9.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1009.01em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3790\"><span class=\"mi\" id=\"MathJax-Span-3791\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3792\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-3793\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3794\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3795\"><span class=\"mrow\" id=\"MathJax-Span-3796\"><span class=\"mi\" id=\"MathJax-Span-3797\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3798\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3799\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3800\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3801\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3802\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3803\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3804\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3805\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3806\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3807\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3808\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3809\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3810\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3811\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3812\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>α</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>α</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-475\">L = L_{ce} + \\alpha_b L_b + \\alpha_z L_z</script>\nwhere:</p>\n\n            <ul>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-476-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3813\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3814\"><span class=\"msubsup\" id=\"MathJax-Span-3815\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3816\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3817\"><span class=\"mrow\" id=\"MathJax-Span-3818\"><span class=\"mi\" id=\"MathJax-Span-3819\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3820\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-476\">L_{ce}</script>: language modeling loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-477-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>b</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3821\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3822\"><span class=\"msubsup\" id=\"MathJax-Span-3823\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3824\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>b</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-477\">L_b</script>: load balancing loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-478-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3826\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3827\"><span class=\"msubsup\" id=\"MathJax-Span-3828\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3829\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3830\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-478\">L_z</script>: router z-loss</li>\n              <li>Constants: <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-479-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3831\" style=\"width: 4.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.44em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.34em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3832\"><span class=\"msubsup\" id=\"MathJax-Span-3833\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3834\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3835\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3836\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3837\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-479\">\\alpha_b = 0.1</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-480-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3838\" style=\"width: 4.638em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.857em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.75em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3839\"><span class=\"msubsup\" id=\"MathJax-Span-3840\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3841\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3842\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3843\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3844\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-480\">\\alpha_z = 0.01</script></li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>LLM Backbone</strong>:</p>\n\n        <ul>\n          <li>Uses Mistral-7B as base LLM.</li>\n          <li>Authors tested upcycling LLM as well, but found pre-trained MoE models (e.g., Mixtral 8×7B) significantly better, so <strong>LLMs are not upcycled</strong> in final CuMo.</li>\n        </ul>\n      </li>\n    </ul>\n<p><strong>MoE Integration</strong>:</p>\n<ul>\n          <li>\n            <p>CuMo inserts Top-K sparsely-gated MoE blocks into:</p>\n\n            <ul>\n              <li><strong>Vision Encoder</strong> (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.</li>\n              <li><strong>Vision-Language MLP Connector</strong>: A two-layer MLP is replaced by a sparse MoE block.</li>\n            </ul>\n          </li>\n          <li>Each MoE block consists of multiple experts (e.g., 4 or 8), with a <strong>router network</strong> trained to select Top-K experts (usually K=2) for each input token.</li>\n          <li>Output of MoE block:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-472-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>K</mi></mrow></munderover><msub><mi>W</mi><mi>i</mi></msub><mo>&amp;#x22C5;</mo><msub><mtext>MLP</mtext><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3746\" style=\"width: 13.076em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.84em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3747\"><span class=\"msubsup\" id=\"MathJax-Span-3748\"><span style=\"display: inline-block; position: relative; width: 1.617em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3749\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"texatom\" id=\"MathJax-Span-3750\"><span class=\"mrow\" id=\"MathJax-Span-3751\"><span class=\"mi\" id=\"MathJax-Span-3752\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span class=\"mi\" id=\"MathJax-Span-3753\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">u</span><span class=\"mi\" id=\"MathJax-Span-3754\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3755\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3756\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3757\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3758\"><span class=\"mrow\" id=\"MathJax-Span-3759\"><span class=\"mi\" id=\"MathJax-Span-3760\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3761\"><span class=\"mrow\" id=\"MathJax-Span-3762\"><span class=\"mi\" id=\"MathJax-Span-3763\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3764\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3765\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3766\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3767\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3768\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3769\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3770\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.346em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1002.03em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3771\" style=\"font-family: STIXGeneral-Regular;\">MLP</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 2.034em;\"><span class=\"mi\" id=\"MathJax-Span-3772\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3773\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3774\" style=\"font-family: STIXGeneral-Italic;\">X<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3775\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>X</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>K</mi></mrow></munderover><msub><mi>W</mi><mi>i</mi></msub><mo>⋅</mo><msub><mtext>MLP</mtext><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-472\">X_{out} = \\sum_{i=1}^{K} W_i \\cdot \\text{MLP}_i(X)</script>\nwhere <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-473-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3776\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3777\"><span class=\"msubsup\" id=\"MathJax-Span-3778\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3779\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3780\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-473\">W_i</script> is the re-normalized gating weight for the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-474-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mi>h</mi></mrow></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3781\" style=\"width: 1.148em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1000.94em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3782\"><span class=\"msubsup\" id=\"MathJax-Span-3783\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.26em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3784\" style=\"font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.263em;\"><span class=\"texatom\" id=\"MathJax-Span-3785\"><span class=\"mrow\" id=\"MathJax-Span-3786\"><span class=\"mi\" id=\"MathJax-Span-3787\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3788\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>i</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mi>h</mi></mrow></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-474\">i^{th}</script> selected expert.</li>\n        </ul>\n<p>CuMo inserts Top-K sparsely-gated MoE blocks into:</p>\n<ul>\n              <li><strong>Vision Encoder</strong> (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.</li>\n              <li><strong>Vision-Language MLP Connector</strong>: A two-layer MLP is replaced by a sparse MoE block.</li>\n            </ul>\n<p><strong>Training Methodology</strong>:</p>\n<ul>\n          <li>\n            <p><strong>Three-Stage Training</strong>:</p>\n\n            <ol>\n              <li><strong>Pre-training Stage</strong>: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.</li>\n              <li><strong>Pre-finetuning Stage</strong>: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.</li>\n              <li><strong>Visual Instruction Tuning</strong>: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.</li>\n            </ol>\n          </li>\n          <li>\n            <p><strong>Co-Upcycling Initialization</strong>:</p>\n\n            <ul>\n              <li>Experts in MoE blocks are <strong>initialized from pretrained MLP layers</strong>, which stabilizes convergence and reduces training cost. This technique is referred to as <strong>co-upcycling</strong>.</li>\n              <li>The Top-K router is trained from scratch during instruction tuning.</li>\n            </ul>\n          </li>\n        </ul>\n<p><strong>Three-Stage Training</strong>:</p>\n<ol>\n              <li><strong>Pre-training Stage</strong>: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.</li>\n              <li><strong>Pre-finetuning Stage</strong>: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.</li>\n              <li><strong>Visual Instruction Tuning</strong>: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.</li>\n            </ol>\n<p><strong>Co-Upcycling Initialization</strong>:</p>\n<ul>\n              <li>Experts in MoE blocks are <strong>initialized from pretrained MLP layers</strong>, which stabilizes convergence and reduces training cost. This technique is referred to as <strong>co-upcycling</strong>.</li>\n              <li>The Top-K router is trained from scratch during instruction tuning.</li>\n            </ul>\n<p><strong>Loss Function</strong>:</p>\n<ul>\n          <li>\n            <p>Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-475-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3789\" style=\"width: 10.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 9.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1009.01em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3790\"><span class=\"mi\" id=\"MathJax-Span-3791\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3792\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-3793\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3794\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3795\"><span class=\"mrow\" id=\"MathJax-Span-3796\"><span class=\"mi\" id=\"MathJax-Span-3797\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3798\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3799\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3800\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3801\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3802\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3803\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3804\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3805\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3806\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3807\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3808\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3809\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3810\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3811\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3812\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>α</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>α</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-475\">L = L_{ce} + \\alpha_b L_b + \\alpha_z L_z</script>\nwhere:</p>\n\n            <ul>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-476-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3813\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3814\"><span class=\"msubsup\" id=\"MathJax-Span-3815\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3816\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3817\"><span class=\"mrow\" id=\"MathJax-Span-3818\"><span class=\"mi\" id=\"MathJax-Span-3819\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3820\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-476\">L_{ce}</script>: language modeling loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-477-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>b</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3821\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3822\"><span class=\"msubsup\" id=\"MathJax-Span-3823\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3824\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>b</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-477\">L_b</script>: load balancing loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-478-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3826\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3827\"><span class=\"msubsup\" id=\"MathJax-Span-3828\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3829\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3830\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-478\">L_z</script>: router z-loss</li>\n              <li>Constants: <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-479-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3831\" style=\"width: 4.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.44em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.34em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3832\"><span class=\"msubsup\" id=\"MathJax-Span-3833\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3834\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3835\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3836\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3837\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-479\">\\alpha_b = 0.1</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-480-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3838\" style=\"width: 4.638em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.857em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.75em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3839\"><span class=\"msubsup\" id=\"MathJax-Span-3840\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3841\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3842\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3843\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3844\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-480\">\\alpha_z = 0.01</script></li>\n            </ul>\n          </li>\n        </ul>\n<p>Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-475-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3789\" style=\"width: 10.836em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 9.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1009.01em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3790\"><span class=\"mi\" id=\"MathJax-Span-3791\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3792\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-3793\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3794\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3795\"><span class=\"mrow\" id=\"MathJax-Span-3796\"><span class=\"mi\" id=\"MathJax-Span-3797\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3798\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3799\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3800\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3801\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3802\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3803\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3804\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3805\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3806\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"msubsup\" id=\"MathJax-Span-3807\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3808\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3809\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3810\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3811\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3812\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>α</mi><mi>b</mi></msub><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><msub><mi>α</mi><mi>z</mi></msub><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-475\">L = L_{ce} + \\alpha_b L_b + \\alpha_z L_z</script>\nwhere:</p>\n<ul>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-476-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>e</mi></mrow></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3813\" style=\"width: 1.513em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.25em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3814\"><span class=\"msubsup\" id=\"MathJax-Span-3815\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3816\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"texatom\" id=\"MathJax-Span-3817\"><span class=\"mrow\" id=\"MathJax-Span-3818\"><span class=\"mi\" id=\"MathJax-Span-3819\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">c</span><span class=\"mi\" id=\"MathJax-Span-3820\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>c</mi><mi>e</mi></mrow></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-476\">L_{ce}</script>: language modeling loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-477-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>b</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3821\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3822\"><span class=\"msubsup\" id=\"MathJax-Span-3823\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3824\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3825\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>b</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-477\">L_b</script>: load balancing loss</li>\n              <li><span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-478-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3826\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3827\"><span class=\"msubsup\" id=\"MathJax-Span-3828\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3829\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3830\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-478\">L_z</script>: router z-loss</li>\n              <li>Constants: <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-479-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3831\" style=\"width: 4.169em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.44em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.34em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3832\"><span class=\"msubsup\" id=\"MathJax-Span-3833\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3834\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3835\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3836\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3837\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.1</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>b</mi></msub><mo>=</mo><mn>0.1</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-479\">\\alpha_b = 0.1</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-480-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>&amp;#x03B1;</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3838\" style=\"width: 4.638em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.857em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.75em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3839\"><span class=\"msubsup\" id=\"MathJax-Span-3840\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3841\" style=\"font-family: STIXGeneral-Italic;\">α</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-3842\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3843\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-3844\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>α</mi><mi>z</mi></msub><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-480\">\\alpha_z = 0.01</script></li>\n            </ul>\n<p><strong>LLM Backbone</strong>:</p>\n<ul>\n          <li>Uses Mistral-7B as base LLM.</li>\n          <li>Authors tested upcycling LLM as well, but found pre-trained MoE models (e.g., Mixtral 8×7B) significantly better, so <strong>LLMs are not upcycled</strong> in final CuMo.</li>\n        </ul>\n<p><strong>Training Datasets</strong>:</p>\n<ul>\n      <li>Visual instruction tuning leverages a blend of public datasets: LLaVA-665K, ShareGPT4V, LAION-GPT-V, DocVQA, ChartQA, AI2D, InfoVQA, SynDog-EN, ALLaVA, and LIMA.</li>\n    </ul>\n<p>The following figure from the paper shows the architecture of CuMo, which incorporates sparse Top-K MoE blocks into the CLIP vision encoder and vision-language MLP connector, thereby improving the multimodal LLM capabilities from the vision side. Skip connections are omitted for simplicity.</p>\n<p><img src=\"../../../images/papers/CuMo.jpg\" alt=\"\"></p>\n<ul>\n  <li>\n    <p><strong>Benchmarks and Results</strong>:</p>\n\n    <ul>\n      <li><strong>CuMo Mistral-7B</strong> outperforms existing 7B multimodal LLMs (e.g., LLaVA-NeXT, Mini-Gemini) and rivals many 13B models across diverse benchmarks such as VQAv2, GQA, TextVQA, MME, MMVet, and SEED-IMG.</li>\n      <li><strong>CuMo Mixtral-8×7B</strong>, the stronger variant, achieves top performance in the 7B MoE model group and even matches private SOTA models like MM1.</li>\n      <li>Strong performance even under limited data settings, outperforming baselines trained with similar data volumes.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Ablation Studies</strong>:</p>\n\n    <ul>\n      <li>Validated that <strong>upcycling MoE blocks</strong> (vs. training from scratch) significantly stabilizes training and improves performance.</li>\n      <li><strong>Auxiliary bzloss</strong> (load balance + router z-loss) further improves expert utilization and model accuracy.</li>\n      <li>Adding <strong>multi-resolution visual inputs</strong> (1× + 3×) to CLIP enhances understanding without increasing token count.</li>\n      <li><strong>ALLaVA-based pre-finetuning</strong> yields superior results over ShareGPT4V in the warm-up stage.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Qualitative Findings</strong>:</p>\n\n    <ul>\n      <li>CuMo is strong at visual grounding and reasoning, often outperforming other models in complex dialogue tasks.</li>\n      <li>Some hallucinations remain, indicating room for improvement in response accuracy.</li>\n    </ul>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/SHI-Labs/CuMo\">Code</a></p>\n  </li>\n</ul>\n<p><strong>Benchmarks and Results</strong>:</p>\n<ul>\n      <li><strong>CuMo Mistral-7B</strong> outperforms existing 7B multimodal LLMs (e.g., LLaVA-NeXT, Mini-Gemini) and rivals many 13B models across diverse benchmarks such as VQAv2, GQA, TextVQA, MME, MMVet, and SEED-IMG.</li>\n      <li><strong>CuMo Mixtral-8×7B</strong>, the stronger variant, achieves top performance in the 7B MoE model group and even matches private SOTA models like MM1.</li>\n      <li>Strong performance even under limited data settings, outperforming baselines trained with similar data volumes.</li>\n    </ul>\n<p><strong>Ablation Studies</strong>:</p>\n<ul>\n      <li>Validated that <strong>upcycling MoE blocks</strong> (vs. training from scratch) significantly stabilizes training and improves performance.</li>\n      <li><strong>Auxiliary bzloss</strong> (load balance + router z-loss) further improves expert utilization and model accuracy.</li>\n      <li>Adding <strong>multi-resolution visual inputs</strong> (1× + 3×) to CLIP enhances understanding without increasing token count.</li>\n      <li><strong>ALLaVA-based pre-finetuning</strong> yields superior results over ShareGPT4V in the warm-up stage.</li>\n    </ul>\n<p><strong>Qualitative Findings</strong>:</p>\n<ul>\n      <li>CuMo is strong at visual grounding and reasoning, often outperforming other models in complex dialogue tasks.</li>\n      <li>Some hallucinations remain, indicating room for improvement in response accuracy.</li>\n    </ul>\n<p><a href=\"https://github.com/SHI-Labs/CuMo\">Code</a></p>",
    "contentMarkdown": "*   This paper by Li et al. from SHI Labs (Georgia Tech & UIUC) and ByteDance introduces **CuMo**, a multimodal large language model (LLM) framework that scales visual understanding capabilities using **Co-Upcycled MoE** blocks integrated into the **vision encoder** and **MLP connector**, while maintaining minimal additional inference cost. CuMo aims to improve the scalability and efficiency of multimodal LLMs by incorporating sparsity through MoE design, especially on the **vision side**, which has been underexplored in previous works.\n    \n*   **Core Concept and Motivation**: Prior efforts in scaling multimodal LLMs focused primarily on increasing paired image-text data or enhancing LLMs, which is computationally intensive. CuMo instead targets the **vision modules** by integrating **sparsely-gated Top-K MoE blocks** to enhance capability without substantially increasing inference costs.\n    \n*   **Architecture and Implementation**:\n    \n    *   **MoE Integration**:\n        \n        *   CuMo inserts Top-K sparsely-gated MoE blocks into:\n            \n            *   **Vision Encoder** (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.\n            *   **Vision-Language MLP Connector**: A two-layer MLP is replaced by a sparse MoE block.\n        *   Each MoE block consists of multiple experts (e.g., 4 or 8), with a **router network** trained to select Top-K experts (usually K=2) for each input token.\n        *   Output of MoE block: Xout\\=∑Ki\\=1Wi⋅MLPi(X)Xout\\=∑i\\=1KWi⋅MLPi(X)X\\_{out} = \\\\sum\\_{i=1}^{K} W\\_i \\\\cdot \\\\text{MLP}\\_i(X) where WiWiW\\_i is the re-normalized gating weight for the ithithi^{th} selected expert.\n    *   **Training Methodology**:\n        \n        *   **Three-Stage Training**:\n            \n            1.  **Pre-training Stage**: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.\n            2.  **Pre-finetuning Stage**: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.\n            3.  **Visual Instruction Tuning**: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.\n        *   **Co-Upcycling Initialization**:\n            \n            *   Experts in MoE blocks are **initialized from pretrained MLP layers**, which stabilizes convergence and reduces training cost. This technique is referred to as **co-upcycling**.\n            *   The Top-K router is trained from scratch during instruction tuning.\n    *   **Loss Function**:\n        \n        *   Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage: L\\=Lce+αbLb+αzLzL\\=Lce+αbLb+αzLzL = L\\_{ce} + \\\\alpha\\_b L\\_b + \\\\alpha\\_z L\\_z where:\n            \n            *   LceLceL\\_{ce}: language modeling loss\n            *   LbLbL\\_b: load balancing loss\n            *   LzLzL\\_z: router z-loss\n            *   Constants: αb\\=0.1αb\\=0.1\\\\alpha\\_b = 0.1, αz\\=0.01αz\\=0.01\\\\alpha\\_z = 0.01\n    *   **LLM Backbone**:\n        \n        *   Uses Mistral-7B as base LLM.\n        *   Authors tested upcycling LLM as well, but found pre-trained MoE models (e.g., Mixtral 8×7B) significantly better, so **LLMs are not upcycled** in final CuMo.\n*   **Training Datasets**:\n    \n    *   Visual instruction tuning leverages a blend of public datasets: LLaVA-665K, ShareGPT4V, LAION-GPT-V, DocVQA, ChartQA, AI2D, InfoVQA, SynDog-EN, ALLaVA, and LIMA.\n*   The following figure from the paper shows the architecture of CuMo, which incorporates sparse Top-K MoE blocks into the CLIP vision encoder and vision-language MLP connector, thereby improving the multimodal LLM capabilities from the vision side. Skip connections are omitted for simplicity.\n    \n\nThis paper by Li et al. from SHI Labs (Georgia Tech & UIUC) and ByteDance introduces **CuMo**, a multimodal large language model (LLM) framework that scales visual understanding capabilities using **Co-Upcycled MoE** blocks integrated into the **vision encoder** and **MLP connector**, while maintaining minimal additional inference cost. CuMo aims to improve the scalability and efficiency of multimodal LLMs by incorporating sparsity through MoE design, especially on the **vision side**, which has been underexplored in previous works.\n\n**Core Concept and Motivation**: Prior efforts in scaling multimodal LLMs focused primarily on increasing paired image-text data or enhancing LLMs, which is computationally intensive. CuMo instead targets the **vision modules** by integrating **sparsely-gated Top-K MoE blocks** to enhance capability without substantially increasing inference costs.\n\n**Architecture and Implementation**:\n\n*   **MoE Integration**:\n    \n    *   CuMo inserts Top-K sparsely-gated MoE blocks into:\n        \n        *   **Vision Encoder** (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.\n        *   **Vision-Language MLP Connector**: A two-layer MLP is replaced by a sparse MoE block.\n    *   Each MoE block consists of multiple experts (e.g., 4 or 8), with a **router network** trained to select Top-K experts (usually K=2) for each input token.\n    *   Output of MoE block: Xout\\=∑Ki\\=1Wi⋅MLPi(X)Xout\\=∑i\\=1KWi⋅MLPi(X)X\\_{out} = \\\\sum\\_{i=1}^{K} W\\_i \\\\cdot \\\\text{MLP}\\_i(X) where WiWiW\\_i is the re-normalized gating weight for the ithithi^{th} selected expert.\n*   **Training Methodology**:\n    \n    *   **Three-Stage Training**:\n        \n        1.  **Pre-training Stage**: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.\n        2.  **Pre-finetuning Stage**: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.\n        3.  **Visual Instruction Tuning**: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.\n    *   **Co-Upcycling Initialization**:\n        \n        *   Experts in MoE blocks are **initialized from pretrained MLP layers**, which stabilizes convergence and reduces training cost. This technique is referred to as **co-upcycling**.\n        *   The Top-K router is trained from scratch during instruction tuning.\n*   **Loss Function**:\n    \n    *   Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage: L\\=Lce+αbLb+αzLzL\\=Lce+αbLb+αzLzL = L\\_{ce} + \\\\alpha\\_b L\\_b + \\\\alpha\\_z L\\_z where:\n        \n        *   LceLceL\\_{ce}: language modeling loss\n        *   LbLbL\\_b: load balancing loss\n        *   LzLzL\\_z: router z-loss\n        *   Constants: αb\\=0.1αb\\=0.1\\\\alpha\\_b = 0.1, αz\\=0.01αz\\=0.01\\\\alpha\\_z = 0.01\n*   **LLM Backbone**:\n    \n    *   Uses Mistral-7B as base LLM.\n    *   Authors tested upcycling LLM as well, but found pre-trained MoE models (e.g., Mixtral 8×7B) significantly better, so **LLMs are not upcycled** in final CuMo.\n\n**MoE Integration**:\n\n*   CuMo inserts Top-K sparsely-gated MoE blocks into:\n    \n    *   **Vision Encoder** (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.\n    *   **Vision-Language MLP Connector**: A two-layer MLP is replaced by a sparse MoE block.\n*   Each MoE block consists of multiple experts (e.g., 4 or 8), with a **router network** trained to select Top-K experts (usually K=2) for each input token.\n*   Output of MoE block: Xout\\=∑Ki\\=1Wi⋅MLPi(X)Xout\\=∑i\\=1KWi⋅MLPi(X)X\\_{out} = \\\\sum\\_{i=1}^{K} W\\_i \\\\cdot \\\\text{MLP}\\_i(X) where WiWiW\\_i is the re-normalized gating weight for the ithithi^{th} selected expert.\n\nCuMo inserts Top-K sparsely-gated MoE blocks into:\n\n*   **Vision Encoder** (CLIP-ViT): Each dense MLP block is replaced with a Top-K MoE block.\n*   **Vision-Language MLP Connector**: A two-layer MLP is replaced by a sparse MoE block.\n\n**Training Methodology**:\n\n*   **Three-Stage Training**:\n    \n    1.  **Pre-training Stage**: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.\n    2.  **Pre-finetuning Stage**: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.\n    3.  **Visual Instruction Tuning**: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.\n*   **Co-Upcycling Initialization**:\n    \n    *   Experts in MoE blocks are **initialized from pretrained MLP layers**, which stabilizes convergence and reduces training cost. This technique is referred to as **co-upcycling**.\n    *   The Top-K router is trained from scratch during instruction tuning.\n\n**Three-Stage Training**:\n\n1.  **Pre-training Stage**: Only the MLP connector is trained using LLaVA-558K to align visual tokens with text space.\n2.  **Pre-finetuning Stage**: All parameters are unfrozen and trained with high-quality captions (e.g., ALLaVA) to warm up the model.\n3.  **Visual Instruction Tuning**: Final training stage with full open-sourced multimodal datasets (~1.65M samples), where the MoE blocks are incorporated and trained.\n\n**Co-Upcycling Initialization**:\n\n*   Experts in MoE blocks are **initialized from pretrained MLP layers**, which stabilizes convergence and reduces training cost. This technique is referred to as **co-upcycling**.\n*   The Top-K router is trained from scratch during instruction tuning.\n\n**Loss Function**:\n\n*   Combines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage: L\\=Lce+αbLb+αzLzL\\=Lce+αbLb+αzLzL = L\\_{ce} + \\\\alpha\\_b L\\_b + \\\\alpha\\_z L\\_z where:\n    \n    *   LceLceL\\_{ce}: language modeling loss\n    *   LbLbL\\_b: load balancing loss\n    *   LzLzL\\_z: router z-loss\n    *   Constants: αb\\=0.1αb\\=0.1\\\\alpha\\_b = 0.1, αz\\=0.01αz\\=0.01\\\\alpha\\_z = 0.01\n\nCombines standard cross-entropy loss with auxiliary losses to ensure balanced expert usage: L\\=Lce+αbLb+αzLzL\\=Lce+αbLb+αzLzL = L\\_{ce} + \\\\alpha\\_b L\\_b + \\\\alpha\\_z L\\_z where:\n\n*   LceLceL\\_{ce}: language modeling loss\n*   LbLbL\\_b: load balancing loss\n*   LzLzL\\_z: router z-loss\n*   Constants: αb\\=0.1αb\\=0.1\\\\alpha\\_b = 0.1, αz\\=0.01αz\\=0.01\\\\alpha\\_z = 0.01\n\n**LLM Backbone**:\n\n*   Uses Mistral-7B as base LLM.\n*   Authors tested upcycling LLM as well, but found pre-trained MoE models (e.g., Mixtral 8×7B) significantly better, so **LLMs are not upcycled** in final CuMo.\n\n**Training Datasets**:\n\n*   Visual instruction tuning leverages a blend of public datasets: LLaVA-665K, ShareGPT4V, LAION-GPT-V, DocVQA, ChartQA, AI2D, InfoVQA, SynDog-EN, ALLaVA, and LIMA.\n\nThe following figure from the paper shows the architecture of CuMo, which incorporates sparse Top-K MoE blocks into the CLIP vision encoder and vision-language MLP connector, thereby improving the multimodal LLM capabilities from the vision side. Skip connections are omitted for simplicity.\n\n![](../../../images/papers/CuMo.jpg)\n\n*   **Benchmarks and Results**:\n    \n    *   **CuMo Mistral-7B** outperforms existing 7B multimodal LLMs (e.g., LLaVA-NeXT, Mini-Gemini) and rivals many 13B models across diverse benchmarks such as VQAv2, GQA, TextVQA, MME, MMVet, and SEED-IMG.\n    *   **CuMo Mixtral-8×7B**, the stronger variant, achieves top performance in the 7B MoE model group and even matches private SOTA models like MM1.\n    *   Strong performance even under limited data settings, outperforming baselines trained with similar data volumes.\n*   **Ablation Studies**:\n    \n    *   Validated that **upcycling MoE blocks** (vs. training from scratch) significantly stabilizes training and improves performance.\n    *   **Auxiliary bzloss** (load balance + router z-loss) further improves expert utilization and model accuracy.\n    *   Adding **multi-resolution visual inputs** (1× + 3×) to CLIP enhances understanding without increasing token count.\n    *   **ALLaVA-based pre-finetuning** yields superior results over ShareGPT4V in the warm-up stage.\n*   **Qualitative Findings**:\n    \n    *   CuMo is strong at visual grounding and reasoning, often outperforming other models in complex dialogue tasks.\n    *   Some hallucinations remain, indicating room for improvement in response accuracy.\n*   [Code](https://github.com/SHI-Labs/CuMo)\n    \n\n**Benchmarks and Results**:\n\n*   **CuMo Mistral-7B** outperforms existing 7B multimodal LLMs (e.g., LLaVA-NeXT, Mini-Gemini) and rivals many 13B models across diverse benchmarks such as VQAv2, GQA, TextVQA, MME, MMVet, and SEED-IMG.\n*   **CuMo Mixtral-8×7B**, the stronger variant, achieves top performance in the 7B MoE model group and even matches private SOTA models like MM1.\n*   Strong performance even under limited data settings, outperforming baselines trained with similar data volumes.\n\n**Ablation Studies**:\n\n*   Validated that **upcycling MoE blocks** (vs. training from scratch) significantly stabilizes training and improves performance.\n*   **Auxiliary bzloss** (load balance + router z-loss) further improves expert utilization and model accuracy.\n*   Adding **multi-resolution visual inputs** (1× + 3×) to CLIP enhances understanding without increasing token count.\n*   **ALLaVA-based pre-finetuning** yields superior results over ShareGPT4V in the warm-up stage.\n\n**Qualitative Findings**:\n\n*   CuMo is strong at visual grounding and reasoning, often outperforming other models in complex dialogue tasks.\n*   Some hallucinations remain, indicating room for improvement in response accuracy.\n\n[Code](https://github.com/SHI-Labs/CuMo)",
    "contentLength": 114982,
    "wordCount": 1711,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#cumo:-scaling-multimodal-llm-with-co-upcycled-mixture-of-experts"
  },
  {
    "id": "ai-mixture-of-experts-branch-train-mix-mixing-expert-llms-into-a-mixture-86",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Branch-Train-MiX: Mixing Expert LLMs Into a Mixture-of-Experts LLM",
    "order": 86,
    "orderInChapter": 14,
    "contentHtml": "<ul>\n  <li>\n    <p>This paper from Sukhbaatar et al. (Meta FAIR) proposes <strong>Branch-Train-MiX (BTX)</strong>, a scalable and efficient method for continued pretraining of Large Language Models (LLMs) across multiple specialized domains (e.g., math, code, knowledge) using a MoE architecture. BTX blends embarrassingly parallel expert training with sparse MoE integration, allowing a single unified model to retain and expand its capabilities across diverse domains while being finetuneable for downstream tasks.</p>\n  </li>\n  <li>\n    <p><strong>Core Idea</strong>: Instead of either training a dense model on all data or training separate domain-specific experts (as in Branch-Train-Merge), BTX trains multiple domain-specific expert models in parallel and merges only their feedforward layers into MoE layers. All other modules (e.g., attention layers) are averaged across experts. The model is then finetuned to learn token-level routing, forming a unified and sparsely activated MoE LLM.</p>\n  </li>\n  <li>\n    <p><strong>Architecture and Implementation</strong>:</p>\n\n    <ul>\n      <li>\n        <p><strong>Seed Model</strong>: Llama-2 7B is used as the base model.</p>\n      </li>\n      <li>\n        <p><strong>Step 1 – Branch &amp; Train</strong>:</p>\n\n        <ul>\n          <li>Create <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-481-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3845\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3846\"><span class=\"mi\" id=\"MathJax-Span-3847\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-481\">N</script> copies of the seed model.</li>\n          <li>Each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-482-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>M</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3848\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3849\"><span class=\"msubsup\" id=\"MathJax-Span-3850\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3851\" style=\"font-family: STIXGeneral-Italic;\">M<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3852\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>M</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-482\">M_i</script> is trained independently on a domain-specific dataset <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-483-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>D</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3853\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3854\"><span class=\"msubsup\" id=\"MathJax-Span-3855\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3856\" style=\"font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-3857\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>D</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-483\">D_i</script> using standard language modeling objectives.</li>\n          <li>Domains used include: Math (201B tokens, 48K steps), Code (210B tokens, 50K steps), Wikipedia (42B tokens).</li>\n          <li>Training is fully asynchronous and parallel, allowing linear scaling of training throughput.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Step 2 – MiX</strong>:</p>\n\n        <ul>\n          <li>Feedforward layers from the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-484-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3858\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3859\"><span class=\"mi\" id=\"MathJax-Span-3860\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-484\">N</script> expert models are combined into sparse <strong>MoE feedforward layers</strong>.</li>\n          <li>For each transformer layer <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-485-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>l</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3861\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3862\"><span class=\"mi\" id=\"MathJax-Span-3863\" style=\"font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>l</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-485\">l</script> and input <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-486-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3864\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3865\"><span class=\"mi\" id=\"MathJax-Span-3866\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-486\">x</script>:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-487-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mtext>FF</mtext><mi>l</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoE</mtext></mrow></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>W</mi><mi>l</mi></msub><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><msub><mtext>FF</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3867\" style=\"width: 16.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.961em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1013.91em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3868\"><span class=\"msubsup\" id=\"MathJax-Span-3869\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.1em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3870\" style=\"font-family: STIXGeneral-Regular;\">FF</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.51em, 4.169em, -999.997em); top: -4.372em; left: 1.096em;\"><span class=\"texatom\" id=\"MathJax-Span-3871\"><span class=\"mrow\" id=\"MathJax-Span-3872\"><span class=\"mtext\" id=\"MathJax-Span-3873\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoE</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.747em; left: 1.096em;\"><span class=\"mi\" id=\"MathJax-Span-3874\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3875\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3876\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3877\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3878\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3879\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3880\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3881\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3882\"><span class=\"mrow\" id=\"MathJax-Span-3883\"><span class=\"mi\" id=\"MathJax-Span-3884\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3885\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3886\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3887\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3888\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3889\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3890\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-3891\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3892\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3893\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-3894\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3895\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3896\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3897\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.565em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.1em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3898\" style=\"font-family: STIXGeneral-Regular;\">FF</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 1.096em;\"><span class=\"texatom\" id=\"MathJax-Span-3899\"><span class=\"mrow\" id=\"MathJax-Span-3900\"><span class=\"mi\" id=\"MathJax-Span-3901\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3902\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3903\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3904\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3905\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mtext>FF</mtext><mi>l</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoE</mtext></mrow></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mi>l</mi></msub><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><msub><mtext>FF</mtext><mrow class=\"MJX-TeXAtom-ORD\"><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-487\">\\text{FF}^{\\text{MoE}}_l(x) = \\sum_{i=1}^N g_i(W_lx) \\cdot \\text{FF}_{li}(x)</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-488-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3906\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3907\"><span class=\"msubsup\" id=\"MathJax-Span-3908\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3909\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3910\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-488\">W_l</script> is the router projection matrix and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-489-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3911\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.47em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3912\"><span class=\"mi\" id=\"MathJax-Span-3913\" style=\"font-family: STIXGeneral-Italic;\">g</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-489\">g</script> is the routing function (Top-2 routing by default).</li>\n            </ul>\n          </li>\n          <li>Self-attention layers and other components are averaged across experts.</li>\n          <li>A lightweight router is introduced and finetuned using the combined training data to guide expert selection.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>MoE Finetuning</strong>:</p>\n\n        <ul>\n          <li>Conducted using 80B tokens over all datasets.</li>\n          <li>Supports multiple routing strategies: Top-k (k=2), Sample Top-1 (Gumbel-Softmax), Soft Routing, and Switch routing.</li>\n          <li>Load balancing loss is added to prevent dead experts and ensure fair usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-490-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>LB</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03B1;</mi><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>u</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3914\" style=\"width: 9.951em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.284em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1008.28em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3915\"><span class=\"msubsup\" id=\"MathJax-Span-3916\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-3917\"><span class=\"mrow\" id=\"MathJax-Span-3918\"><span class=\"mi\" id=\"MathJax-Span-3919\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3920\"><span class=\"mrow\" id=\"MathJax-Span-3921\"><span class=\"mtext\" id=\"MathJax-Span-3922\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">LB</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3923\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-3924\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mi\" id=\"MathJax-Span-3925\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-3926\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3927\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3928\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3929\"><span class=\"mrow\" id=\"MathJax-Span-3930\"><span class=\"mi\" id=\"MathJax-Span-3931\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3932\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3933\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3934\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3935\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3936\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3937\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3938\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3939\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>LB</mtext></mrow></msub><mo>=</mo><mi>α</mi><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>u</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-490\">\\mathcal{L}_{\\text{LB}} = \\alpha N \\sum_{i=1}^N u_i p_i</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-491-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>u</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3940\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3941\"><span class=\"msubsup\" id=\"MathJax-Span-3942\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3943\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3944\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>u</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-491\">u_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-492-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3945\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3946\"><span class=\"msubsup\" id=\"MathJax-Span-3947\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3948\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3949\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-492\">p_i</script> are expert usage and router probabilities, respectively.</li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Alternative Strategies</strong>:</p>\n\n        <ul>\n          <li><strong>Split Experts</strong>: Divide FF modules into chunks for increased MoE granularity.</li>\n          <li><strong>Blended Experts</strong>: Construct each MoE expert from mixed domain chunks (shown to degrade performance).</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>The following figure from the paper shows the Branch-Train-MiX (BTX) method, which involves branching from a seed model into multiple domain-specific experts, training each expert separately, then mixing their feedforward layers into an MoE model and finetuning for token-level routing.</strong></p>\n  </li>\n</ul>\n<p>This paper from Sukhbaatar et al. (Meta FAIR) proposes <strong>Branch-Train-MiX (BTX)</strong>, a scalable and efficient method for continued pretraining of Large Language Models (LLMs) across multiple specialized domains (e.g., math, code, knowledge) using a MoE architecture. BTX blends embarrassingly parallel expert training with sparse MoE integration, allowing a single unified model to retain and expand its capabilities across diverse domains while being finetuneable for downstream tasks.</p>\n<p><strong>Core Idea</strong>: Instead of either training a dense model on all data or training separate domain-specific experts (as in Branch-Train-Merge), BTX trains multiple domain-specific expert models in parallel and merges only their feedforward layers into MoE layers. All other modules (e.g., attention layers) are averaged across experts. The model is then finetuned to learn token-level routing, forming a unified and sparsely activated MoE LLM.</p>\n<p><strong>Architecture and Implementation</strong>:</p>\n<ul>\n      <li>\n        <p><strong>Seed Model</strong>: Llama-2 7B is used as the base model.</p>\n      </li>\n      <li>\n        <p><strong>Step 1 – Branch &amp; Train</strong>:</p>\n\n        <ul>\n          <li>Create <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-481-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3845\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3846\"><span class=\"mi\" id=\"MathJax-Span-3847\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-481\">N</script> copies of the seed model.</li>\n          <li>Each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-482-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>M</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3848\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3849\"><span class=\"msubsup\" id=\"MathJax-Span-3850\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3851\" style=\"font-family: STIXGeneral-Italic;\">M<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3852\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>M</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-482\">M_i</script> is trained independently on a domain-specific dataset <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-483-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>D</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3853\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3854\"><span class=\"msubsup\" id=\"MathJax-Span-3855\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3856\" style=\"font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-3857\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>D</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-483\">D_i</script> using standard language modeling objectives.</li>\n          <li>Domains used include: Math (201B tokens, 48K steps), Code (210B tokens, 50K steps), Wikipedia (42B tokens).</li>\n          <li>Training is fully asynchronous and parallel, allowing linear scaling of training throughput.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Step 2 – MiX</strong>:</p>\n\n        <ul>\n          <li>Feedforward layers from the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-484-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3858\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3859\"><span class=\"mi\" id=\"MathJax-Span-3860\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-484\">N</script> expert models are combined into sparse <strong>MoE feedforward layers</strong>.</li>\n          <li>For each transformer layer <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-485-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>l</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3861\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3862\"><span class=\"mi\" id=\"MathJax-Span-3863\" style=\"font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>l</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-485\">l</script> and input <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-486-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3864\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3865\"><span class=\"mi\" id=\"MathJax-Span-3866\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-486\">x</script>:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-487-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mtext>FF</mtext><mi>l</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoE</mtext></mrow></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>W</mi><mi>l</mi></msub><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><msub><mtext>FF</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3867\" style=\"width: 16.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.961em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1013.91em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3868\"><span class=\"msubsup\" id=\"MathJax-Span-3869\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.1em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3870\" style=\"font-family: STIXGeneral-Regular;\">FF</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.51em, 4.169em, -999.997em); top: -4.372em; left: 1.096em;\"><span class=\"texatom\" id=\"MathJax-Span-3871\"><span class=\"mrow\" id=\"MathJax-Span-3872\"><span class=\"mtext\" id=\"MathJax-Span-3873\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoE</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.747em; left: 1.096em;\"><span class=\"mi\" id=\"MathJax-Span-3874\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3875\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3876\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3877\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3878\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3879\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3880\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3881\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3882\"><span class=\"mrow\" id=\"MathJax-Span-3883\"><span class=\"mi\" id=\"MathJax-Span-3884\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3885\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3886\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3887\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3888\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3889\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3890\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-3891\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3892\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3893\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-3894\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3895\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3896\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3897\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.565em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.1em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3898\" style=\"font-family: STIXGeneral-Regular;\">FF</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 1.096em;\"><span class=\"texatom\" id=\"MathJax-Span-3899\"><span class=\"mrow\" id=\"MathJax-Span-3900\"><span class=\"mi\" id=\"MathJax-Span-3901\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3902\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3903\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3904\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3905\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mtext>FF</mtext><mi>l</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoE</mtext></mrow></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mi>l</mi></msub><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><msub><mtext>FF</mtext><mrow class=\"MJX-TeXAtom-ORD\"><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-487\">\\text{FF}^{\\text{MoE}}_l(x) = \\sum_{i=1}^N g_i(W_lx) \\cdot \\text{FF}_{li}(x)</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-488-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3906\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3907\"><span class=\"msubsup\" id=\"MathJax-Span-3908\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3909\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3910\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-488\">W_l</script> is the router projection matrix and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-489-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3911\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.47em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3912\"><span class=\"mi\" id=\"MathJax-Span-3913\" style=\"font-family: STIXGeneral-Italic;\">g</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-489\">g</script> is the routing function (Top-2 routing by default).</li>\n            </ul>\n          </li>\n          <li>Self-attention layers and other components are averaged across experts.</li>\n          <li>A lightweight router is introduced and finetuned using the combined training data to guide expert selection.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>MoE Finetuning</strong>:</p>\n\n        <ul>\n          <li>Conducted using 80B tokens over all datasets.</li>\n          <li>Supports multiple routing strategies: Top-k (k=2), Sample Top-1 (Gumbel-Softmax), Soft Routing, and Switch routing.</li>\n          <li>Load balancing loss is added to prevent dead experts and ensure fair usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-490-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>LB</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03B1;</mi><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>u</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3914\" style=\"width: 9.951em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.284em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1008.28em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3915\"><span class=\"msubsup\" id=\"MathJax-Span-3916\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-3917\"><span class=\"mrow\" id=\"MathJax-Span-3918\"><span class=\"mi\" id=\"MathJax-Span-3919\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3920\"><span class=\"mrow\" id=\"MathJax-Span-3921\"><span class=\"mtext\" id=\"MathJax-Span-3922\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">LB</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3923\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-3924\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mi\" id=\"MathJax-Span-3925\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-3926\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3927\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3928\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3929\"><span class=\"mrow\" id=\"MathJax-Span-3930\"><span class=\"mi\" id=\"MathJax-Span-3931\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3932\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3933\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3934\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3935\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3936\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3937\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3938\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3939\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>LB</mtext></mrow></msub><mo>=</mo><mi>α</mi><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>u</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-490\">\\mathcal{L}_{\\text{LB}} = \\alpha N \\sum_{i=1}^N u_i p_i</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-491-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>u</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3940\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3941\"><span class=\"msubsup\" id=\"MathJax-Span-3942\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3943\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3944\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>u</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-491\">u_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-492-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3945\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3946\"><span class=\"msubsup\" id=\"MathJax-Span-3947\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3948\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3949\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-492\">p_i</script> are expert usage and router probabilities, respectively.</li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Alternative Strategies</strong>:</p>\n\n        <ul>\n          <li><strong>Split Experts</strong>: Divide FF modules into chunks for increased MoE granularity.</li>\n          <li><strong>Blended Experts</strong>: Construct each MoE expert from mixed domain chunks (shown to degrade performance).</li>\n        </ul>\n      </li>\n    </ul>\n<p><strong>Seed Model</strong>: Llama-2 7B is used as the base model.</p>\n<p><strong>Step 1 – Branch &amp; Train</strong>:</p>\n<ul>\n          <li>Create <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-481-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3845\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3846\"><span class=\"mi\" id=\"MathJax-Span-3847\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-481\">N</script> copies of the seed model.</li>\n          <li>Each expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-482-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>M</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3848\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3849\"><span class=\"msubsup\" id=\"MathJax-Span-3850\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3851\" style=\"font-family: STIXGeneral-Italic;\">M<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3852\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>M</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-482\">M_i</script> is trained independently on a domain-specific dataset <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-483-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>D</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3853\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3854\"><span class=\"msubsup\" id=\"MathJax-Span-3855\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3856\" style=\"font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-3857\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>D</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-483\">D_i</script> using standard language modeling objectives.</li>\n          <li>Domains used include: Math (201B tokens, 48K steps), Code (210B tokens, 50K steps), Wikipedia (42B tokens).</li>\n          <li>Training is fully asynchronous and parallel, allowing linear scaling of training throughput.</li>\n        </ul>\n<p><strong>Step 2 – MiX</strong>:</p>\n<ul>\n          <li>Feedforward layers from the <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-484-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3858\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.78em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3859\"><span class=\"mi\" id=\"MathJax-Span-3860\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>N</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-484\">N</script> expert models are combined into sparse <strong>MoE feedforward layers</strong>.</li>\n          <li>For each transformer layer <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-485-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>l</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3861\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3862\"><span class=\"mi\" id=\"MathJax-Span-3863\" style=\"font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>l</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-485\">l</script> and input <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-486-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3864\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3865\"><span class=\"mi\" id=\"MathJax-Span-3866\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.691em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>x</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-486\">x</script>:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-487-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mtext>FF</mtext><mi>l</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoE</mtext></mrow></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>W</mi><mi>l</mi></msub><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><msub><mtext>FF</mtext><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3867\" style=\"width: 16.773em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.961em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1013.91em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3868\"><span class=\"msubsup\" id=\"MathJax-Span-3869\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.1em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3870\" style=\"font-family: STIXGeneral-Regular;\">FF</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.51em, 4.169em, -999.997em); top: -4.372em; left: 1.096em;\"><span class=\"texatom\" id=\"MathJax-Span-3871\"><span class=\"mrow\" id=\"MathJax-Span-3872\"><span class=\"mtext\" id=\"MathJax-Span-3873\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoE</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.747em; left: 1.096em;\"><span class=\"mi\" id=\"MathJax-Span-3874\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3875\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3876\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3877\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3878\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3879\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3880\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3881\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3882\"><span class=\"mrow\" id=\"MathJax-Span-3883\"><span class=\"mi\" id=\"MathJax-Span-3884\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3885\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3886\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3887\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3888\" style=\"font-family: STIXGeneral-Italic;\">g</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3889\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3890\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-3891\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3892\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3893\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mi\" id=\"MathJax-Span-3894\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3895\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-3896\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-3897\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.565em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1001.1em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mtext\" id=\"MathJax-Span-3898\" style=\"font-family: STIXGeneral-Regular;\">FF</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 1.096em;\"><span class=\"texatom\" id=\"MathJax-Span-3899\"><span class=\"mrow\" id=\"MathJax-Span-3900\"><span class=\"mi\" id=\"MathJax-Span-3901\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mi\" id=\"MathJax-Span-3902\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3903\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-3904\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-3905\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mtext>FF</mtext><mi>l</mi><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoE</mtext></mrow></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>g</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mi>l</mi></msub><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⋅</mo><msub><mtext>FF</mtext><mrow class=\"MJX-TeXAtom-ORD\"><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-487\">\\text{FF}^{\\text{MoE}}_l(x) = \\sum_{i=1}^N g_i(W_lx) \\cdot \\text{FF}_{li}(x)</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-488-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3906\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3907\"><span class=\"msubsup\" id=\"MathJax-Span-3908\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3909\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3910\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-488\">W_l</script> is the router projection matrix and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-489-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3911\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.47em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3912\"><span class=\"mi\" id=\"MathJax-Span-3913\" style=\"font-family: STIXGeneral-Italic;\">g</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-489\">g</script> is the routing function (Top-2 routing by default).</li>\n            </ul>\n          </li>\n          <li>Self-attention layers and other components are averaged across experts.</li>\n          <li>A lightweight router is introduced and finetuned using the combined training data to guide expert selection.</li>\n        </ul>\n<ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-488-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>W</mi><mi>l</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3906\" style=\"width: 1.357em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.1em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3907\"><span class=\"msubsup\" id=\"MathJax-Span-3908\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3909\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3910\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">l<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>W</mi><mi>l</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-488\">W_l</script> is the router projection matrix and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-489-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>g</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3911\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.617em, 1000.47em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3912\"><span class=\"mi\" id=\"MathJax-Span-3913\" style=\"font-family: STIXGeneral-Italic;\">g</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>g</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-489\">g</script> is the routing function (Top-2 routing by default).</li>\n            </ul>\n<p><strong>MoE Finetuning</strong>:</p>\n<ul>\n          <li>Conducted using 80B tokens over all datasets.</li>\n          <li>Supports multiple routing strategies: Top-k (k=2), Sample Top-1 (Gumbel-Softmax), Soft Routing, and Switch routing.</li>\n          <li>Load balancing loss is added to prevent dead experts and ensure fair usage:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-490-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;>L</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>LB</mtext></mrow></msub><mo>=</mo><mi>&amp;#x03B1;</mi><mi>N</mi><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>u</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3914\" style=\"width: 9.951em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.284em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1008.28em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3915\"><span class=\"msubsup\" id=\"MathJax-Span-3916\"><span style=\"display: inline-block; position: relative; width: 1.669em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-3917\"><span class=\"mrow\" id=\"MathJax-Span-3918\"><span class=\"mi\" id=\"MathJax-Span-3919\" style=\"font-family: STIXNonUnicode-Italic;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-3920\"><span class=\"mrow\" id=\"MathJax-Span-3921\"><span class=\"mtext\" id=\"MathJax-Span-3922\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">LB</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3923\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-3924\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">α</span><span class=\"mi\" id=\"MathJax-Span-3925\" style=\"font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"munderover\" id=\"MathJax-Span-3926\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3927\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3928\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3929\"><span class=\"mrow\" id=\"MathJax-Span-3930\"><span class=\"mi\" id=\"MathJax-Span-3931\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-3932\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-3933\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3934\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3935\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3936\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3937\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3938\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3939\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mrow class=\"MJX-TeXAtom-ORD\"><mi class=\"MJX-tex-caligraphic\" mathvariant=\"script\">L</mi></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mtext>LB</mtext></mrow></msub><mo>=</mo><mi>α</mi><mi>N</mi><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>u</mi><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-490\">\\mathcal{L}_{\\text{LB}} = \\alpha N \\sum_{i=1}^N u_i p_i</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-491-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>u</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3940\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3941\"><span class=\"msubsup\" id=\"MathJax-Span-3942\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3943\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3944\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>u</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-491\">u_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-492-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3945\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3946\"><span class=\"msubsup\" id=\"MathJax-Span-3947\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3948\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3949\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-492\">p_i</script> are expert usage and router probabilities, respectively.</li>\n            </ul>\n          </li>\n        </ul>\n<ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-491-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>u</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3940\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3941\"><span class=\"msubsup\" id=\"MathJax-Span-3942\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3943\" style=\"font-family: STIXGeneral-Italic;\">u</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3944\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>u</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-491\">u_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-492-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3945\" style=\"width: 0.94em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.565em, 1000.78em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3946\"><span class=\"msubsup\" id=\"MathJax-Span-3947\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3948\" style=\"font-family: STIXGeneral-Italic;\">p</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3949\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-492\">p_i</script> are expert usage and router probabilities, respectively.</li>\n            </ul>\n<p><strong>Alternative Strategies</strong>:</p>\n<ul>\n          <li><strong>Split Experts</strong>: Divide FF modules into chunks for increased MoE granularity.</li>\n          <li><strong>Blended Experts</strong>: Construct each MoE expert from mixed domain chunks (shown to degrade performance).</li>\n        </ul>\n<p><strong>The following figure from the paper shows the Branch-Train-MiX (BTX) method, which involves branching from a seed model into multiple domain-specific experts, training each expert separately, then mixing their feedforward layers into an MoE model and finetuning for token-level routing.</strong></p>\n<p><img src=\"../../../images/papers/Branch-Train-MiX.jpg\" alt=\"\"></p>\n<ul>\n  <li>\n    <p><strong>Results</strong>:</p>\n\n    <ul>\n      <li>\n        <p>BTX outperforms baselines including:</p>\n\n        <ul>\n          <li><strong>Llama-2 7B/13B</strong> (dense)</li>\n          <li><strong>Branch-Train-Merge (BTM)</strong></li>\n          <li><strong>Sparse Upcycling</strong> (MoE from duplicated seed FF layers)</li>\n          <li><strong>Specialists like Llemma and CodeLlama</strong> in multi-domain performance.</li>\n        </ul>\n      </li>\n      <li>\n        <p>On benchmarks (GSM8K, MATH, HumanEval, MBPP, Natural Questions, MMLU):</p>\n\n        <ul>\n          <li>BTX-Top2 achieves best average score (47.9), matching or exceeding specialists in their domains while maintaining generalist performance.</li>\n          <li>BTX surpasses Llama-2 13B in all domains except reasoning, despite using half the compute.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Empirical Findings</strong>:</p>\n\n    <ul>\n      <li><strong>Routing Analysis</strong>: Load balancing during MoE finetuning ensures even usage of experts and avoids dead experts (especially Code expert).</li>\n      <li><strong>Efficiency</strong>: In compute-matched settings, BTX trains on &gt;2× data than Sparse Upcycling and achieves better generalization.</li>\n      <li>\n        <p><strong>Ablations</strong>:</p>\n\n        <ul>\n          <li>Blending experts harms performance.</li>\n          <li>Freezing expert FF modules during MoE finetuning has minimal impact, indicating pretrained domain knowledge suffices.</li>\n          <li>Sample Top-1 routing offers better compute-performance tradeoffs than Switch or Soft routing.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n</ul>\n<p><strong>Results</strong>:</p>\n<ul>\n      <li>\n        <p>BTX outperforms baselines including:</p>\n\n        <ul>\n          <li><strong>Llama-2 7B/13B</strong> (dense)</li>\n          <li><strong>Branch-Train-Merge (BTM)</strong></li>\n          <li><strong>Sparse Upcycling</strong> (MoE from duplicated seed FF layers)</li>\n          <li><strong>Specialists like Llemma and CodeLlama</strong> in multi-domain performance.</li>\n        </ul>\n      </li>\n      <li>\n        <p>On benchmarks (GSM8K, MATH, HumanEval, MBPP, Natural Questions, MMLU):</p>\n\n        <ul>\n          <li>BTX-Top2 achieves best average score (47.9), matching or exceeding specialists in their domains while maintaining generalist performance.</li>\n          <li>BTX surpasses Llama-2 13B in all domains except reasoning, despite using half the compute.</li>\n        </ul>\n      </li>\n    </ul>\n<p>BTX outperforms baselines including:</p>\n<ul>\n          <li><strong>Llama-2 7B/13B</strong> (dense)</li>\n          <li><strong>Branch-Train-Merge (BTM)</strong></li>\n          <li><strong>Sparse Upcycling</strong> (MoE from duplicated seed FF layers)</li>\n          <li><strong>Specialists like Llemma and CodeLlama</strong> in multi-domain performance.</li>\n        </ul>\n<p>On benchmarks (GSM8K, MATH, HumanEval, MBPP, Natural Questions, MMLU):</p>\n<ul>\n          <li>BTX-Top2 achieves best average score (47.9), matching or exceeding specialists in their domains while maintaining generalist performance.</li>\n          <li>BTX surpasses Llama-2 13B in all domains except reasoning, despite using half the compute.</li>\n        </ul>\n<p><strong>Empirical Findings</strong>:</p>\n<ul>\n      <li><strong>Routing Analysis</strong>: Load balancing during MoE finetuning ensures even usage of experts and avoids dead experts (especially Code expert).</li>\n      <li><strong>Efficiency</strong>: In compute-matched settings, BTX trains on &gt;2× data than Sparse Upcycling and achieves better generalization.</li>\n      <li>\n        <p><strong>Ablations</strong>:</p>\n\n        <ul>\n          <li>Blending experts harms performance.</li>\n          <li>Freezing expert FF modules during MoE finetuning has minimal impact, indicating pretrained domain knowledge suffices.</li>\n          <li>Sample Top-1 routing offers better compute-performance tradeoffs than Switch or Soft routing.</li>\n        </ul>\n      </li>\n    </ul>\n<p><strong>Ablations</strong>:</p>\n<ul>\n          <li>Blending experts harms performance.</li>\n          <li>Freezing expert FF modules during MoE finetuning has minimal impact, indicating pretrained domain knowledge suffices.</li>\n          <li>Sample Top-1 routing offers better compute-performance tradeoffs than Switch or Soft routing.</li>\n        </ul>",
    "contentMarkdown": "*   This paper from Sukhbaatar et al. (Meta FAIR) proposes **Branch-Train-MiX (BTX)**, a scalable and efficient method for continued pretraining of Large Language Models (LLMs) across multiple specialized domains (e.g., math, code, knowledge) using a MoE architecture. BTX blends embarrassingly parallel expert training with sparse MoE integration, allowing a single unified model to retain and expand its capabilities across diverse domains while being finetuneable for downstream tasks.\n    \n*   **Core Idea**: Instead of either training a dense model on all data or training separate domain-specific experts (as in Branch-Train-Merge), BTX trains multiple domain-specific expert models in parallel and merges only their feedforward layers into MoE layers. All other modules (e.g., attention layers) are averaged across experts. The model is then finetuned to learn token-level routing, forming a unified and sparsely activated MoE LLM.\n    \n*   **Architecture and Implementation**:\n    \n    *   **Seed Model**: Llama-2 7B is used as the base model.\n        \n    *   **Step 1 – Branch & Train**:\n        \n        *   Create NNN copies of the seed model.\n        *   Each expert MiMiM\\_i is trained independently on a domain-specific dataset DiDiD\\_i using standard language modeling objectives.\n        *   Domains used include: Math (201B tokens, 48K steps), Code (210B tokens, 50K steps), Wikipedia (42B tokens).\n        *   Training is fully asynchronous and parallel, allowing linear scaling of training throughput.\n    *   **Step 2 – MiX**:\n        \n        *   Feedforward layers from the NNN expert models are combined into sparse **MoE feedforward layers**.\n        *   For each transformer layer lll and input xxx: FFMoEl(x)\\=∑Ni\\=1gi(Wlx)⋅FFli(x)FFlMoE(x)\\=∑i\\=1Ngi(Wlx)⋅FFli(x)\\\\text{FF}^{\\\\text{MoE}}\\_l(x) = \\\\sum\\_{i=1}^N g\\_i(W\\_lx) \\\\cdot \\\\text{FF}\\_{li}(x)\n            *   where WlWlW\\_l is the router projection matrix and ggg is the routing function (Top-2 routing by default).\n        *   Self-attention layers and other components are averaged across experts.\n        *   A lightweight router is introduced and finetuned using the combined training data to guide expert selection.\n    *   **MoE Finetuning**:\n        \n        *   Conducted using 80B tokens over all datasets.\n        *   Supports multiple routing strategies: Top-k (k=2), Sample Top-1 (Gumbel-Softmax), Soft Routing, and Switch routing.\n        *   Load balancing loss is added to prevent dead experts and ensure fair usage: LB\\=αN∑Ni\\=1uipiLLB\\=αN∑i\\=1Nuipi\\\\mathcal{L}\\_{\\\\text{LB}} = \\\\alpha N \\\\sum\\_{i=1}^N u\\_i p\\_i\n            *   where uiuiu\\_i and pipip\\_i are expert usage and router probabilities, respectively.\n    *   **Alternative Strategies**:\n        \n        *   **Split Experts**: Divide FF modules into chunks for increased MoE granularity.\n        *   **Blended Experts**: Construct each MoE expert from mixed domain chunks (shown to degrade performance).\n*   **The following figure from the paper shows the Branch-Train-MiX (BTX) method, which involves branching from a seed model into multiple domain-specific experts, training each expert separately, then mixing their feedforward layers into an MoE model and finetuning for token-level routing.**\n    \n\nThis paper from Sukhbaatar et al. (Meta FAIR) proposes **Branch-Train-MiX (BTX)**, a scalable and efficient method for continued pretraining of Large Language Models (LLMs) across multiple specialized domains (e.g., math, code, knowledge) using a MoE architecture. BTX blends embarrassingly parallel expert training with sparse MoE integration, allowing a single unified model to retain and expand its capabilities across diverse domains while being finetuneable for downstream tasks.\n\n**Core Idea**: Instead of either training a dense model on all data or training separate domain-specific experts (as in Branch-Train-Merge), BTX trains multiple domain-specific expert models in parallel and merges only their feedforward layers into MoE layers. All other modules (e.g., attention layers) are averaged across experts. The model is then finetuned to learn token-level routing, forming a unified and sparsely activated MoE LLM.\n\n**Architecture and Implementation**:\n\n*   **Seed Model**: Llama-2 7B is used as the base model.\n    \n*   **Step 1 – Branch & Train**:\n    \n    *   Create NNN copies of the seed model.\n    *   Each expert MiMiM\\_i is trained independently on a domain-specific dataset DiDiD\\_i using standard language modeling objectives.\n    *   Domains used include: Math (201B tokens, 48K steps), Code (210B tokens, 50K steps), Wikipedia (42B tokens).\n    *   Training is fully asynchronous and parallel, allowing linear scaling of training throughput.\n*   **Step 2 – MiX**:\n    \n    *   Feedforward layers from the NNN expert models are combined into sparse **MoE feedforward layers**.\n    *   For each transformer layer lll and input xxx: FFMoEl(x)\\=∑Ni\\=1gi(Wlx)⋅FFli(x)FFlMoE(x)\\=∑i\\=1Ngi(Wlx)⋅FFli(x)\\\\text{FF}^{\\\\text{MoE}}\\_l(x) = \\\\sum\\_{i=1}^N g\\_i(W\\_lx) \\\\cdot \\\\text{FF}\\_{li}(x)\n        *   where WlWlW\\_l is the router projection matrix and ggg is the routing function (Top-2 routing by default).\n    *   Self-attention layers and other components are averaged across experts.\n    *   A lightweight router is introduced and finetuned using the combined training data to guide expert selection.\n*   **MoE Finetuning**:\n    \n    *   Conducted using 80B tokens over all datasets.\n    *   Supports multiple routing strategies: Top-k (k=2), Sample Top-1 (Gumbel-Softmax), Soft Routing, and Switch routing.\n    *   Load balancing loss is added to prevent dead experts and ensure fair usage: LB\\=αN∑Ni\\=1uipiLLB\\=αN∑i\\=1Nuipi\\\\mathcal{L}\\_{\\\\text{LB}} = \\\\alpha N \\\\sum\\_{i=1}^N u\\_i p\\_i\n        *   where uiuiu\\_i and pipip\\_i are expert usage and router probabilities, respectively.\n*   **Alternative Strategies**:\n    \n    *   **Split Experts**: Divide FF modules into chunks for increased MoE granularity.\n    *   **Blended Experts**: Construct each MoE expert from mixed domain chunks (shown to degrade performance).\n\n**Seed Model**: Llama-2 7B is used as the base model.\n\n**Step 1 – Branch & Train**:\n\n*   Create NNN copies of the seed model.\n*   Each expert MiMiM\\_i is trained independently on a domain-specific dataset DiDiD\\_i using standard language modeling objectives.\n*   Domains used include: Math (201B tokens, 48K steps), Code (210B tokens, 50K steps), Wikipedia (42B tokens).\n*   Training is fully asynchronous and parallel, allowing linear scaling of training throughput.\n\n**Step 2 – MiX**:\n\n*   Feedforward layers from the NNN expert models are combined into sparse **MoE feedforward layers**.\n*   For each transformer layer lll and input xxx: FFMoEl(x)\\=∑Ni\\=1gi(Wlx)⋅FFli(x)FFlMoE(x)\\=∑i\\=1Ngi(Wlx)⋅FFli(x)\\\\text{FF}^{\\\\text{MoE}}\\_l(x) = \\\\sum\\_{i=1}^N g\\_i(W\\_lx) \\\\cdot \\\\text{FF}\\_{li}(x)\n    *   where WlWlW\\_l is the router projection matrix and ggg is the routing function (Top-2 routing by default).\n*   Self-attention layers and other components are averaged across experts.\n*   A lightweight router is introduced and finetuned using the combined training data to guide expert selection.\n\n*   where WlWlW\\_l is the router projection matrix and ggg is the routing function (Top-2 routing by default).\n\n**MoE Finetuning**:\n\n*   Conducted using 80B tokens over all datasets.\n*   Supports multiple routing strategies: Top-k (k=2), Sample Top-1 (Gumbel-Softmax), Soft Routing, and Switch routing.\n*   Load balancing loss is added to prevent dead experts and ensure fair usage: LB\\=αN∑Ni\\=1uipiLLB\\=αN∑i\\=1Nuipi\\\\mathcal{L}\\_{\\\\text{LB}} = \\\\alpha N \\\\sum\\_{i=1}^N u\\_i p\\_i\n    *   where uiuiu\\_i and pipip\\_i are expert usage and router probabilities, respectively.\n\n*   where uiuiu\\_i and pipip\\_i are expert usage and router probabilities, respectively.\n\n**Alternative Strategies**:\n\n*   **Split Experts**: Divide FF modules into chunks for increased MoE granularity.\n*   **Blended Experts**: Construct each MoE expert from mixed domain chunks (shown to degrade performance).\n\n**The following figure from the paper shows the Branch-Train-MiX (BTX) method, which involves branching from a seed model into multiple domain-specific experts, training each expert separately, then mixing their feedforward layers into an MoE model and finetuning for token-level routing.**\n\n![](../../../images/papers/Branch-Train-MiX.jpg)\n\n*   **Results**:\n    \n    *   BTX outperforms baselines including:\n        \n        *   **Llama-2 7B/13B** (dense)\n        *   **Branch-Train-Merge (BTM)**\n        *   **Sparse Upcycling** (MoE from duplicated seed FF layers)\n        *   **Specialists like Llemma and CodeLlama** in multi-domain performance.\n    *   On benchmarks (GSM8K, MATH, HumanEval, MBPP, Natural Questions, MMLU):\n        \n        *   BTX-Top2 achieves best average score (47.9), matching or exceeding specialists in their domains while maintaining generalist performance.\n        *   BTX surpasses Llama-2 13B in all domains except reasoning, despite using half the compute.\n*   **Empirical Findings**:\n    \n    *   **Routing Analysis**: Load balancing during MoE finetuning ensures even usage of experts and avoids dead experts (especially Code expert).\n    *   **Efficiency**: In compute-matched settings, BTX trains on >2× data than Sparse Upcycling and achieves better generalization.\n    *   **Ablations**:\n        \n        *   Blending experts harms performance.\n        *   Freezing expert FF modules during MoE finetuning has minimal impact, indicating pretrained domain knowledge suffices.\n        *   Sample Top-1 routing offers better compute-performance tradeoffs than Switch or Soft routing.\n\n**Results**:\n\n*   BTX outperforms baselines including:\n    \n    *   **Llama-2 7B/13B** (dense)\n    *   **Branch-Train-Merge (BTM)**\n    *   **Sparse Upcycling** (MoE from duplicated seed FF layers)\n    *   **Specialists like Llemma and CodeLlama** in multi-domain performance.\n*   On benchmarks (GSM8K, MATH, HumanEval, MBPP, Natural Questions, MMLU):\n    \n    *   BTX-Top2 achieves best average score (47.9), matching or exceeding specialists in their domains while maintaining generalist performance.\n    *   BTX surpasses Llama-2 13B in all domains except reasoning, despite using half the compute.\n\nBTX outperforms baselines including:\n\n*   **Llama-2 7B/13B** (dense)\n*   **Branch-Train-Merge (BTM)**\n*   **Sparse Upcycling** (MoE from duplicated seed FF layers)\n*   **Specialists like Llemma and CodeLlama** in multi-domain performance.\n\nOn benchmarks (GSM8K, MATH, HumanEval, MBPP, Natural Questions, MMLU):\n\n*   BTX-Top2 achieves best average score (47.9), matching or exceeding specialists in their domains while maintaining generalist performance.\n*   BTX surpasses Llama-2 13B in all domains except reasoning, despite using half the compute.\n\n**Empirical Findings**:\n\n*   **Routing Analysis**: Load balancing during MoE finetuning ensures even usage of experts and avoids dead experts (especially Code expert).\n*   **Efficiency**: In compute-matched settings, BTX trains on >2× data than Sparse Upcycling and achieves better generalization.\n*   **Ablations**:\n    \n    *   Blending experts harms performance.\n    *   Freezing expert FF modules during MoE finetuning has minimal impact, indicating pretrained domain knowledge suffices.\n    *   Sample Top-1 routing offers better compute-performance tradeoffs than Switch or Soft routing.\n\n**Ablations**:\n\n*   Blending experts harms performance.\n*   Freezing expert FF modules during MoE finetuning has minimal impact, indicating pretrained domain knowledge suffices.\n*   Sample Top-1 routing offers better compute-performance tradeoffs than Switch or Soft routing.",
    "contentLength": 113245,
    "wordCount": 1508,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#branch-train-mix:-mixing-expert-llms-into-a-mixture-of-experts-llm"
  },
  {
    "id": "ai-mixture-of-experts-switchhead-accelerating-transformers-with-mixture--87",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "SwitchHead: Accelerating Transformers with Mixture-of-Experts Attention",
    "order": 87,
    "orderInChapter": 15,
    "contentHtml": "<ul>\n  <li>\n    <p>This paper by Csordás et al. introduces <strong>SwitchHead</strong>, a novel MoE architecture designed specifically for the attention layer in Transformers, a direction underexplored in prior work where MoE has largely been applied only to the feedforward components (MLPs). SwitchHead significantly reduces computational and memory overhead, while maintaining or exceeding the performance of dense, parameter-matched Transformer baselines.</p>\n  </li>\n  <li>\n    <p><strong>Core Idea</strong>: Unlike prior attempts at MoE in attention (e.g., MoA), SwitchHead reduces the number of attention matrices by computing MoE projections <em>outside</em> the attention core. It conditionally applies expert selection to value and output projections only, keeping query and key projections fixed per head. This design enables up to 8x fewer attention computations without harming model expressiveness or performance.</p>\n  </li>\n  <li>\n    <p><strong>Architecture and Implementation</strong>:</p>\n\n    <ul>\n      <li>\n        <p><strong>Redefinition of Head</strong>: A “head” in SwitchHead is redefined as an instance of an attention matrix computation. Each head has its own set of value and output experts (E experts per head).</p>\n      </li>\n      <li>\n        <p><strong>Expert Routing</strong>:</p>\n\n        <ul>\n          <li>Uses non-competitive sigmoid gating (σ-MoE style).</li>\n          <li>Selection is done independently for source (value) and destination (output) projections.</li>\n          <li>For a given head <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-493-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>h</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3950\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3951\"><span class=\"mi\" id=\"MathJax-Span-3952\" style=\"font-family: STIXGeneral-Italic;\">h</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>h</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-493\">h</script>, the value projection is:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-494-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>V</mi><mi>h</mi></msup><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>&amp;#x2208;</mo><msubsup><mi>E</mi><mi>S</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>S</mi><mi>h</mi></msubsup><mo stretchy=&quot;false&quot;>[</mo><mi>e</mi><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x22C5;</mo><mi>x</mi><msubsup><mi>W</mi><mi>V</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3953\" style=\"width: 12.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.52em, 2.919em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3954\"><span class=\"msubsup\" id=\"MathJax-Span-3955\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3956\" style=\"font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-3957\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3958\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3959\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3960\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3961\"><span class=\"mrow\" id=\"MathJax-Span-3962\"><span class=\"mi\" id=\"MathJax-Span-3963\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3964\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3965\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3966\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.492em, 1000.32em, 4.169em, -999.997em); top: -4.268em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3967\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -3.799em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-3968\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3969\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3970\" style=\"font-family: STIXGeneral-Italic;\">s</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3971\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -3.695em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3972\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3973\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mi\" id=\"MathJax-Span-3974\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3975\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-3976\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3977\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-3978\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3979\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-3980\"><span class=\"mrow\" id=\"MathJax-Span-3981\"><span class=\"mi\" id=\"MathJax-Span-3982\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-3983\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-3984\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3985\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.684em; border-left: 0px solid; width: 0px; height: 1.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>V</mi><mi>h</mi></msup><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>∈</mo><msubsup><mi>E</mi><mi>S</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>S</mi><mi>h</mi></msubsup><mo stretchy=\"false\">[</mo><mi>e</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><mi>x</mi><msubsup><mi>W</mi><mi>V</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-494\">V^h = \\sum_{e \\in E^h_S} s^h_S[e] \\cdot xW^{h,e}_V</script></li>\n          <li>The final output is:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-495-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>y</mi><mo>=</mo><munder><mo>&amp;#x2211;</mo><mi>h</mi></munder><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>&amp;#x2208;</mo><msubsup><mi>E</mi><mi>D</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>D</mi><mi>h</mi></msubsup><mo stretchy=&quot;false&quot;>[</mo><mi>e</mi><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x22C5;</mo><msup><mi>A</mi><mi>h</mi></msup><msup><mi>V</mi><mi>h</mi></msup><msubsup><mi>W</mi><mi>O</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3986\" style=\"width: 16.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1013.34em, 2.867em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3987\"><span class=\"mi\" id=\"MathJax-Span-3988\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-3989\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3990\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3991\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3992\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-3993\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3994\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3995\"><span class=\"mrow\" id=\"MathJax-Span-3996\"><span class=\"mi\" id=\"MathJax-Span-3997\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3998\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3999\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4000\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.492em, 1000.32em, 4.169em, -999.997em); top: -4.268em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4001\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -3.799em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-4002\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4003\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4004\" style=\"font-family: STIXGeneral-Italic;\">s</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4005\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4006\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4007\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mi\" id=\"MathJax-Span-4008\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-4009\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-4010\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4011\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4012\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4013\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4014\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4015\" style=\"font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-4016\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4017\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4018\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4019\"><span class=\"mrow\" id=\"MathJax-Span-4020\"><span class=\"mi\" id=\"MathJax-Span-4021\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-4022\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4023\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4024\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.622em; border-left: 0px solid; width: 0px; height: 1.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>y</mi><mo>=</mo><munder><mo>∑</mo><mi>h</mi></munder><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>∈</mo><msubsup><mi>E</mi><mi>D</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>D</mi><mi>h</mi></msubsup><mo stretchy=\"false\">[</mo><mi>e</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><msup><mi>A</mi><mi>h</mi></msup><msup><mi>V</mi><mi>h</mi></msup><msubsup><mi>W</mi><mi>O</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-495\">y = \\sum_h \\sum_{e \\in E^h_D} s^h_D[e] \\cdot A^h V^h W^{h,e}_O</script></li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training</strong>:</p>\n\n        <ul>\n          <li>No special regularization or tricks are required (unlike softmax-gated MoEs).</li>\n          <li>All models are trained for 100k steps using Adam with standard learning rates and dropout.</li>\n          <li>Language modeling tasks are evaluated under both parameter-matched and MAC-matched settings.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Model Configuration</strong>:</p>\n\n        <ul>\n          <li>Uses 2 or 4 heads, each with multiple experts (typically 4–5).</li>\n          <li>Expert selection budget <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-496-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4025\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4026\"><span class=\"mi\" id=\"MathJax-Span-4027\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-496\">k</script> (number of active experts) ranges from 2–4.</li>\n          <li>Transformer XL and RoPE positional encodings are supported.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Datasets</strong>: C4, Wikitext-103, Enwik8, and peS2o for pretraining; Lambada, BLiMP, and CBT for zero-shot downstream evaluation.</p>\n      </li>\n      <li>\n        <p><strong>Performance Comparison</strong>:</p>\n\n        <ul>\n          <li>In parameter-matched settings, SwitchHead achieves similar perplexity with only <strong>44% compute and 27% memory usage</strong>.</li>\n          <li>In MAC-matched settings, it outperforms the baseline in both perplexity and zero-shot accuracy.</li>\n          <li>Compared to Mixture of Attention Heads (MoA), SwitchHead is more compute-efficient due to fewer attention matrices and avoids competitive gating complexities.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>SwitchAll</strong>: Combines SwitchHead attention with σ-MoE-based MLPs for a fully MoE Transformer. Demonstrates further reductions in compute and memory with no degradation in language modeling performance.</p>\n      </li>\n      <li>\n        <p><strong>Analysis</strong>:</p>\n\n        <ul>\n          <li>SwitchHead’s attention maps are qualitatively similar to dense Transformers, including interpretable induction heads.</li>\n          <li>Attention head usage is sparse and often semantically specialized.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Key Empirical Finding</strong>:</p>\n\n        <ul>\n          <li>MoE for <strong>value and output</strong> projections is essential; MoE for key and query projections offers no benefit under parameter-matching.</li>\n        </ul>\n      </li>\n      <li>\n        <p>The following figure from the paper shows a schematic representation of SwitchHead. It consists of a few independent heads, each with multiple experts for value and output projections. Each head has a single attention matrix.</p>\n      </li>\n    </ul>\n\n    <p><img src=\"../../../images/papers/SwitchHead.jpg\" alt=\"\"></p>\n  </li>\n  <li>\n    <p><strong>Benchmarks</strong>:</p>\n\n    <ul>\n      <li>On Wikitext-103, a 47M SwitchHead matches the baseline (perplexity ~12.3) with <strong>62% fewer MACs</strong> and <strong>77% less memory usage</strong>.</li>\n      <li>On downstream tasks (Lambada, BLiMP, CBT), SwitchHead outperforms dense baselines in zero-shot accuracy.</li>\n    </ul>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/robertcsordas/switchhead\">Code</a></p>\n  </li>\n</ul>\n<p>This paper by Csordás et al. introduces <strong>SwitchHead</strong>, a novel MoE architecture designed specifically for the attention layer in Transformers, a direction underexplored in prior work where MoE has largely been applied only to the feedforward components (MLPs). SwitchHead significantly reduces computational and memory overhead, while maintaining or exceeding the performance of dense, parameter-matched Transformer baselines.</p>\n<p><strong>Core Idea</strong>: Unlike prior attempts at MoE in attention (e.g., MoA), SwitchHead reduces the number of attention matrices by computing MoE projections <em>outside</em> the attention core. It conditionally applies expert selection to value and output projections only, keeping query and key projections fixed per head. This design enables up to 8x fewer attention computations without harming model expressiveness or performance.</p>\n<p><strong>Architecture and Implementation</strong>:</p>\n<ul>\n      <li>\n        <p><strong>Redefinition of Head</strong>: A “head” in SwitchHead is redefined as an instance of an attention matrix computation. Each head has its own set of value and output experts (E experts per head).</p>\n      </li>\n      <li>\n        <p><strong>Expert Routing</strong>:</p>\n\n        <ul>\n          <li>Uses non-competitive sigmoid gating (σ-MoE style).</li>\n          <li>Selection is done independently for source (value) and destination (output) projections.</li>\n          <li>For a given head <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-493-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>h</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3950\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3951\"><span class=\"mi\" id=\"MathJax-Span-3952\" style=\"font-family: STIXGeneral-Italic;\">h</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>h</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-493\">h</script>, the value projection is:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-494-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>V</mi><mi>h</mi></msup><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>&amp;#x2208;</mo><msubsup><mi>E</mi><mi>S</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>S</mi><mi>h</mi></msubsup><mo stretchy=&quot;false&quot;>[</mo><mi>e</mi><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x22C5;</mo><mi>x</mi><msubsup><mi>W</mi><mi>V</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3953\" style=\"width: 12.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.52em, 2.919em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3954\"><span class=\"msubsup\" id=\"MathJax-Span-3955\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3956\" style=\"font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-3957\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3958\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3959\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3960\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3961\"><span class=\"mrow\" id=\"MathJax-Span-3962\"><span class=\"mi\" id=\"MathJax-Span-3963\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3964\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3965\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3966\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.492em, 1000.32em, 4.169em, -999.997em); top: -4.268em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3967\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -3.799em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-3968\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3969\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3970\" style=\"font-family: STIXGeneral-Italic;\">s</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3971\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -3.695em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3972\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3973\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mi\" id=\"MathJax-Span-3974\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3975\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-3976\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3977\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-3978\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3979\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-3980\"><span class=\"mrow\" id=\"MathJax-Span-3981\"><span class=\"mi\" id=\"MathJax-Span-3982\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-3983\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-3984\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3985\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.684em; border-left: 0px solid; width: 0px; height: 1.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>V</mi><mi>h</mi></msup><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>∈</mo><msubsup><mi>E</mi><mi>S</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>S</mi><mi>h</mi></msubsup><mo stretchy=\"false\">[</mo><mi>e</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><mi>x</mi><msubsup><mi>W</mi><mi>V</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-494\">V^h = \\sum_{e \\in E^h_S} s^h_S[e] \\cdot xW^{h,e}_V</script></li>\n          <li>The final output is:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-495-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>y</mi><mo>=</mo><munder><mo>&amp;#x2211;</mo><mi>h</mi></munder><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>&amp;#x2208;</mo><msubsup><mi>E</mi><mi>D</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>D</mi><mi>h</mi></msubsup><mo stretchy=&quot;false&quot;>[</mo><mi>e</mi><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x22C5;</mo><msup><mi>A</mi><mi>h</mi></msup><msup><mi>V</mi><mi>h</mi></msup><msubsup><mi>W</mi><mi>O</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3986\" style=\"width: 16.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1013.34em, 2.867em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3987\"><span class=\"mi\" id=\"MathJax-Span-3988\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-3989\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3990\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3991\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3992\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-3993\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3994\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3995\"><span class=\"mrow\" id=\"MathJax-Span-3996\"><span class=\"mi\" id=\"MathJax-Span-3997\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3998\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3999\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4000\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.492em, 1000.32em, 4.169em, -999.997em); top: -4.268em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4001\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -3.799em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-4002\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4003\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4004\" style=\"font-family: STIXGeneral-Italic;\">s</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4005\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4006\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4007\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mi\" id=\"MathJax-Span-4008\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-4009\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-4010\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4011\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4012\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4013\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4014\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4015\" style=\"font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-4016\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4017\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4018\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4019\"><span class=\"mrow\" id=\"MathJax-Span-4020\"><span class=\"mi\" id=\"MathJax-Span-4021\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-4022\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4023\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4024\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.622em; border-left: 0px solid; width: 0px; height: 1.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>y</mi><mo>=</mo><munder><mo>∑</mo><mi>h</mi></munder><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>∈</mo><msubsup><mi>E</mi><mi>D</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>D</mi><mi>h</mi></msubsup><mo stretchy=\"false\">[</mo><mi>e</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><msup><mi>A</mi><mi>h</mi></msup><msup><mi>V</mi><mi>h</mi></msup><msubsup><mi>W</mi><mi>O</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-495\">y = \\sum_h \\sum_{e \\in E^h_D} s^h_D[e] \\cdot A^h V^h W^{h,e}_O</script></li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training</strong>:</p>\n\n        <ul>\n          <li>No special regularization or tricks are required (unlike softmax-gated MoEs).</li>\n          <li>All models are trained for 100k steps using Adam with standard learning rates and dropout.</li>\n          <li>Language modeling tasks are evaluated under both parameter-matched and MAC-matched settings.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Model Configuration</strong>:</p>\n\n        <ul>\n          <li>Uses 2 or 4 heads, each with multiple experts (typically 4–5).</li>\n          <li>Expert selection budget <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-496-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4025\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4026\"><span class=\"mi\" id=\"MathJax-Span-4027\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-496\">k</script> (number of active experts) ranges from 2–4.</li>\n          <li>Transformer XL and RoPE positional encodings are supported.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Datasets</strong>: C4, Wikitext-103, Enwik8, and peS2o for pretraining; Lambada, BLiMP, and CBT for zero-shot downstream evaluation.</p>\n      </li>\n      <li>\n        <p><strong>Performance Comparison</strong>:</p>\n\n        <ul>\n          <li>In parameter-matched settings, SwitchHead achieves similar perplexity with only <strong>44% compute and 27% memory usage</strong>.</li>\n          <li>In MAC-matched settings, it outperforms the baseline in both perplexity and zero-shot accuracy.</li>\n          <li>Compared to Mixture of Attention Heads (MoA), SwitchHead is more compute-efficient due to fewer attention matrices and avoids competitive gating complexities.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>SwitchAll</strong>: Combines SwitchHead attention with σ-MoE-based MLPs for a fully MoE Transformer. Demonstrates further reductions in compute and memory with no degradation in language modeling performance.</p>\n      </li>\n      <li>\n        <p><strong>Analysis</strong>:</p>\n\n        <ul>\n          <li>SwitchHead’s attention maps are qualitatively similar to dense Transformers, including interpretable induction heads.</li>\n          <li>Attention head usage is sparse and often semantically specialized.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Key Empirical Finding</strong>:</p>\n\n        <ul>\n          <li>MoE for <strong>value and output</strong> projections is essential; MoE for key and query projections offers no benefit under parameter-matching.</li>\n        </ul>\n      </li>\n      <li>\n        <p>The following figure from the paper shows a schematic representation of SwitchHead. It consists of a few independent heads, each with multiple experts for value and output projections. Each head has a single attention matrix.</p>\n      </li>\n    </ul>\n<p><strong>Redefinition of Head</strong>: A “head” in SwitchHead is redefined as an instance of an attention matrix computation. Each head has its own set of value and output experts (E experts per head).</p>\n<p><strong>Expert Routing</strong>:</p>\n<ul>\n          <li>Uses non-competitive sigmoid gating (σ-MoE style).</li>\n          <li>Selection is done independently for source (value) and destination (output) projections.</li>\n          <li>For a given head <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-493-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>h</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3950\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3951\"><span class=\"mi\" id=\"MathJax-Span-3952\" style=\"font-family: STIXGeneral-Italic;\">h</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>h</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-493\">h</script>, the value projection is:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-494-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>V</mi><mi>h</mi></msup><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>&amp;#x2208;</mo><msubsup><mi>E</mi><mi>S</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>S</mi><mi>h</mi></msubsup><mo stretchy=&quot;false&quot;>[</mo><mi>e</mi><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x22C5;</mo><mi>x</mi><msubsup><mi>W</mi><mi>V</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3953\" style=\"width: 12.659em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010.52em, 2.919em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3954\"><span class=\"msubsup\" id=\"MathJax-Span-3955\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3956\" style=\"font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-3957\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3958\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3959\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.607em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3960\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3961\"><span class=\"mrow\" id=\"MathJax-Span-3962\"><span class=\"mi\" id=\"MathJax-Span-3963\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3964\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3965\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3966\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.492em, 1000.32em, 4.169em, -999.997em); top: -4.268em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-3967\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -3.799em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-3968\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-3969\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3970\" style=\"font-family: STIXGeneral-Italic;\">s</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3971\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -3.695em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-3972\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">S<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-3973\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mi\" id=\"MathJax-Span-3974\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3975\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-3976\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"mi\" id=\"MathJax-Span-3977\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-3978\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-3979\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-3980\"><span class=\"mrow\" id=\"MathJax-Span-3981\"><span class=\"mi\" id=\"MathJax-Span-3982\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-3983\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-3984\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-3985\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.684em; border-left: 0px solid; width: 0px; height: 1.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>V</mi><mi>h</mi></msup><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>∈</mo><msubsup><mi>E</mi><mi>S</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>S</mi><mi>h</mi></msubsup><mo stretchy=\"false\">[</mo><mi>e</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><mi>x</mi><msubsup><mi>W</mi><mi>V</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-494\">V^h = \\sum_{e \\in E^h_S} s^h_S[e] \\cdot xW^{h,e}_V</script></li>\n          <li>The final output is:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-495-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>y</mi><mo>=</mo><munder><mo>&amp;#x2211;</mo><mi>h</mi></munder><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mo>&amp;#x2208;</mo><msubsup><mi>E</mi><mi>D</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>D</mi><mi>h</mi></msubsup><mo stretchy=&quot;false&quot;>[</mo><mi>e</mi><mo stretchy=&quot;false&quot;>]</mo><mo>&amp;#x22C5;</mo><msup><mi>A</mi><mi>h</mi></msup><msup><mi>V</mi><mi>h</mi></msup><msubsup><mi>W</mi><mi>O</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-3986\" style=\"width: 16.044em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.336em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1013.34em, 2.867em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-3987\"><span class=\"mi\" id=\"MathJax-Span-3988\" style=\"font-family: STIXGeneral-Italic;\">y</span><span class=\"mo\" id=\"MathJax-Span-3989\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-3990\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3991\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-3992\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-3993\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.659em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-3994\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-3995\"><span class=\"mrow\" id=\"MathJax-Span-3996\"><span class=\"mi\" id=\"MathJax-Span-3997\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-3998\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"msubsup\" id=\"MathJax-Span-3999\"><span style=\"display: inline-block; position: relative; width: 0.836em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4000\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.492em, 1000.32em, 4.169em, -999.997em); top: -4.268em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4001\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -3.799em; left: 0.419em;\"><span class=\"mi\" id=\"MathJax-Span-4002\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4003\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4004\" style=\"font-family: STIXGeneral-Italic;\">s</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4005\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4006\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">D</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4007\" style=\"font-family: STIXGeneral-Regular;\">[</span><span class=\"mi\" id=\"MathJax-Span-4008\" style=\"font-family: STIXGeneral-Italic;\">e</span><span class=\"mo\" id=\"MathJax-Span-4009\" style=\"font-family: STIXGeneral-Regular;\">]</span><span class=\"mo\" id=\"MathJax-Span-4010\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4011\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 1.044em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4012\" style=\"font-family: STIXGeneral-Italic;\">A</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4013\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4014\"><span style=\"display: inline-block; position: relative; width: 1.201em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4015\" style=\"font-family: STIXGeneral-Italic;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.784em;\"><span class=\"mi\" id=\"MathJax-Span-4016\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4017\"><span style=\"display: inline-block; position: relative; width: 1.878em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4018\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.94em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4019\"><span class=\"mrow\" id=\"MathJax-Span-4020\"><span class=\"mi\" id=\"MathJax-Span-4021\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span class=\"mo\" id=\"MathJax-Span-4022\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4023\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">e</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4024\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">O</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.622em; border-left: 0px solid; width: 0px; height: 1.816em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>y</mi><mo>=</mo><munder><mo>∑</mo><mi>h</mi></munder><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>e</mi><mo>∈</mo><msubsup><mi>E</mi><mi>D</mi><mi>h</mi></msubsup></mrow></munder><msubsup><mi>s</mi><mi>D</mi><mi>h</mi></msubsup><mo stretchy=\"false\">[</mo><mi>e</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><msup><mi>A</mi><mi>h</mi></msup><msup><mi>V</mi><mi>h</mi></msup><msubsup><mi>W</mi><mi>O</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>h</mi><mo>,</mo><mi>e</mi></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-495\">y = \\sum_h \\sum_{e \\in E^h_D} s^h_D[e] \\cdot A^h V^h W^{h,e}_O</script></li>\n        </ul>\n<p><strong>Training</strong>:</p>\n<ul>\n          <li>No special regularization or tricks are required (unlike softmax-gated MoEs).</li>\n          <li>All models are trained for 100k steps using Adam with standard learning rates and dropout.</li>\n          <li>Language modeling tasks are evaluated under both parameter-matched and MAC-matched settings.</li>\n        </ul>\n<p><strong>Model Configuration</strong>:</p>\n<ul>\n          <li>Uses 2 or 4 heads, each with multiple experts (typically 4–5).</li>\n          <li>Expert selection budget <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-496-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4025\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4026\"><span class=\"mi\" id=\"MathJax-Span-4027\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-496\">k</script> (number of active experts) ranges from 2–4.</li>\n          <li>Transformer XL and RoPE positional encodings are supported.</li>\n        </ul>\n<p><strong>Datasets</strong>: C4, Wikitext-103, Enwik8, and peS2o for pretraining; Lambada, BLiMP, and CBT for zero-shot downstream evaluation.</p>\n<p><strong>Performance Comparison</strong>:</p>\n<ul>\n          <li>In parameter-matched settings, SwitchHead achieves similar perplexity with only <strong>44% compute and 27% memory usage</strong>.</li>\n          <li>In MAC-matched settings, it outperforms the baseline in both perplexity and zero-shot accuracy.</li>\n          <li>Compared to Mixture of Attention Heads (MoA), SwitchHead is more compute-efficient due to fewer attention matrices and avoids competitive gating complexities.</li>\n        </ul>\n<p><strong>SwitchAll</strong>: Combines SwitchHead attention with σ-MoE-based MLPs for a fully MoE Transformer. Demonstrates further reductions in compute and memory with no degradation in language modeling performance.</p>\n<p><strong>Analysis</strong>:</p>\n<ul>\n          <li>SwitchHead’s attention maps are qualitatively similar to dense Transformers, including interpretable induction heads.</li>\n          <li>Attention head usage is sparse and often semantically specialized.</li>\n        </ul>\n<p><strong>Key Empirical Finding</strong>:</p>\n<ul>\n          <li>MoE for <strong>value and output</strong> projections is essential; MoE for key and query projections offers no benefit under parameter-matching.</li>\n        </ul>\n<p>The following figure from the paper shows a schematic representation of SwitchHead. It consists of a few independent heads, each with multiple experts for value and output projections. Each head has a single attention matrix.</p>\n<p><img src=\"../../../images/papers/SwitchHead.jpg\" alt=\"\"></p>\n<p><strong>Benchmarks</strong>:</p>\n<ul>\n      <li>On Wikitext-103, a 47M SwitchHead matches the baseline (perplexity ~12.3) with <strong>62% fewer MACs</strong> and <strong>77% less memory usage</strong>.</li>\n      <li>On downstream tasks (Lambada, BLiMP, CBT), SwitchHead outperforms dense baselines in zero-shot accuracy.</li>\n    </ul>\n<p><a href=\"https://github.com/robertcsordas/switchhead\">Code</a></p>",
    "contentMarkdown": "*   This paper by Csordás et al. introduces **SwitchHead**, a novel MoE architecture designed specifically for the attention layer in Transformers, a direction underexplored in prior work where MoE has largely been applied only to the feedforward components (MLPs). SwitchHead significantly reduces computational and memory overhead, while maintaining or exceeding the performance of dense, parameter-matched Transformer baselines.\n    \n*   **Core Idea**: Unlike prior attempts at MoE in attention (e.g., MoA), SwitchHead reduces the number of attention matrices by computing MoE projections _outside_ the attention core. It conditionally applies expert selection to value and output projections only, keeping query and key projections fixed per head. This design enables up to 8x fewer attention computations without harming model expressiveness or performance.\n    \n*   **Architecture and Implementation**:\n    \n    *   **Redefinition of Head**: A “head” in SwitchHead is redefined as an instance of an attention matrix computation. Each head has its own set of value and output experts (E experts per head).\n        \n    *   **Expert Routing**:\n        \n        *   Uses non-competitive sigmoid gating (σ-MoE style).\n        *   Selection is done independently for source (value) and destination (output) projections.\n        *   For a given head hhh, the value projection is: Vh\\=∑e∈EhSshS\\[e\\]⋅xWh,eVVh\\=∑e∈EShsSh\\[e\\]⋅xWVh,eV^h = \\\\sum\\_{e \\\\in E^h\\_S} s^h\\_S\\[e\\] \\\\cdot xW^{h,e}\\_V\n        *   The final output is: y\\=∑h∑e∈EhDshD\\[e\\]⋅AhVhWh,eOy\\=∑h∑e∈EDhsDh\\[e\\]⋅AhVhWOh,ey = \\\\sum\\_h \\\\sum\\_{e \\\\in E^h\\_D} s^h\\_D\\[e\\] \\\\cdot A^h V^h W^{h,e}\\_O\n    *   **Training**:\n        \n        *   No special regularization or tricks are required (unlike softmax-gated MoEs).\n        *   All models are trained for 100k steps using Adam with standard learning rates and dropout.\n        *   Language modeling tasks are evaluated under both parameter-matched and MAC-matched settings.\n    *   **Model Configuration**:\n        \n        *   Uses 2 or 4 heads, each with multiple experts (typically 4–5).\n        *   Expert selection budget kkk (number of active experts) ranges from 2–4.\n        *   Transformer XL and RoPE positional encodings are supported.\n    *   **Datasets**: C4, Wikitext-103, Enwik8, and peS2o for pretraining; Lambada, BLiMP, and CBT for zero-shot downstream evaluation.\n        \n    *   **Performance Comparison**:\n        \n        *   In parameter-matched settings, SwitchHead achieves similar perplexity with only **44% compute and 27% memory usage**.\n        *   In MAC-matched settings, it outperforms the baseline in both perplexity and zero-shot accuracy.\n        *   Compared to Mixture of Attention Heads (MoA), SwitchHead is more compute-efficient due to fewer attention matrices and avoids competitive gating complexities.\n    *   **SwitchAll**: Combines SwitchHead attention with σ-MoE-based MLPs for a fully MoE Transformer. Demonstrates further reductions in compute and memory with no degradation in language modeling performance.\n        \n    *   **Analysis**:\n        \n        *   SwitchHead’s attention maps are qualitatively similar to dense Transformers, including interpretable induction heads.\n        *   Attention head usage is sparse and often semantically specialized.\n    *   **Key Empirical Finding**:\n        \n        *   MoE for **value and output** projections is essential; MoE for key and query projections offers no benefit under parameter-matching.\n    *   The following figure from the paper shows a schematic representation of SwitchHead. It consists of a few independent heads, each with multiple experts for value and output projections. Each head has a single attention matrix.\n        \n    \n    ![](../../../images/papers/SwitchHead.jpg)\n    \n*   **Benchmarks**:\n    \n    *   On Wikitext-103, a 47M SwitchHead matches the baseline (perplexity ~12.3) with **62% fewer MACs** and **77% less memory usage**.\n    *   On downstream tasks (Lambada, BLiMP, CBT), SwitchHead outperforms dense baselines in zero-shot accuracy.\n*   [Code](https://github.com/robertcsordas/switchhead)\n    \n\nThis paper by Csordás et al. introduces **SwitchHead**, a novel MoE architecture designed specifically for the attention layer in Transformers, a direction underexplored in prior work where MoE has largely been applied only to the feedforward components (MLPs). SwitchHead significantly reduces computational and memory overhead, while maintaining or exceeding the performance of dense, parameter-matched Transformer baselines.\n\n**Core Idea**: Unlike prior attempts at MoE in attention (e.g., MoA), SwitchHead reduces the number of attention matrices by computing MoE projections _outside_ the attention core. It conditionally applies expert selection to value and output projections only, keeping query and key projections fixed per head. This design enables up to 8x fewer attention computations without harming model expressiveness or performance.\n\n**Architecture and Implementation**:\n\n*   **Redefinition of Head**: A “head” in SwitchHead is redefined as an instance of an attention matrix computation. Each head has its own set of value and output experts (E experts per head).\n    \n*   **Expert Routing**:\n    \n    *   Uses non-competitive sigmoid gating (σ-MoE style).\n    *   Selection is done independently for source (value) and destination (output) projections.\n    *   For a given head hhh, the value projection is: Vh\\=∑e∈EhSshS\\[e\\]⋅xWh,eVVh\\=∑e∈EShsSh\\[e\\]⋅xWVh,eV^h = \\\\sum\\_{e \\\\in E^h\\_S} s^h\\_S\\[e\\] \\\\cdot xW^{h,e}\\_V\n    *   The final output is: y\\=∑h∑e∈EhDshD\\[e\\]⋅AhVhWh,eOy\\=∑h∑e∈EDhsDh\\[e\\]⋅AhVhWOh,ey = \\\\sum\\_h \\\\sum\\_{e \\\\in E^h\\_D} s^h\\_D\\[e\\] \\\\cdot A^h V^h W^{h,e}\\_O\n*   **Training**:\n    \n    *   No special regularization or tricks are required (unlike softmax-gated MoEs).\n    *   All models are trained for 100k steps using Adam with standard learning rates and dropout.\n    *   Language modeling tasks are evaluated under both parameter-matched and MAC-matched settings.\n*   **Model Configuration**:\n    \n    *   Uses 2 or 4 heads, each with multiple experts (typically 4–5).\n    *   Expert selection budget kkk (number of active experts) ranges from 2–4.\n    *   Transformer XL and RoPE positional encodings are supported.\n*   **Datasets**: C4, Wikitext-103, Enwik8, and peS2o for pretraining; Lambada, BLiMP, and CBT for zero-shot downstream evaluation.\n    \n*   **Performance Comparison**:\n    \n    *   In parameter-matched settings, SwitchHead achieves similar perplexity with only **44% compute and 27% memory usage**.\n    *   In MAC-matched settings, it outperforms the baseline in both perplexity and zero-shot accuracy.\n    *   Compared to Mixture of Attention Heads (MoA), SwitchHead is more compute-efficient due to fewer attention matrices and avoids competitive gating complexities.\n*   **SwitchAll**: Combines SwitchHead attention with σ-MoE-based MLPs for a fully MoE Transformer. Demonstrates further reductions in compute and memory with no degradation in language modeling performance.\n    \n*   **Analysis**:\n    \n    *   SwitchHead’s attention maps are qualitatively similar to dense Transformers, including interpretable induction heads.\n    *   Attention head usage is sparse and often semantically specialized.\n*   **Key Empirical Finding**:\n    \n    *   MoE for **value and output** projections is essential; MoE for key and query projections offers no benefit under parameter-matching.\n*   The following figure from the paper shows a schematic representation of SwitchHead. It consists of a few independent heads, each with multiple experts for value and output projections. Each head has a single attention matrix.\n    \n\n**Redefinition of Head**: A “head” in SwitchHead is redefined as an instance of an attention matrix computation. Each head has its own set of value and output experts (E experts per head).\n\n**Expert Routing**:\n\n*   Uses non-competitive sigmoid gating (σ-MoE style).\n*   Selection is done independently for source (value) and destination (output) projections.\n*   For a given head hhh, the value projection is: Vh\\=∑e∈EhSshS\\[e\\]⋅xWh,eVVh\\=∑e∈EShsSh\\[e\\]⋅xWVh,eV^h = \\\\sum\\_{e \\\\in E^h\\_S} s^h\\_S\\[e\\] \\\\cdot xW^{h,e}\\_V\n*   The final output is: y\\=∑h∑e∈EhDshD\\[e\\]⋅AhVhWh,eOy\\=∑h∑e∈EDhsDh\\[e\\]⋅AhVhWOh,ey = \\\\sum\\_h \\\\sum\\_{e \\\\in E^h\\_D} s^h\\_D\\[e\\] \\\\cdot A^h V^h W^{h,e}\\_O\n\n**Training**:\n\n*   No special regularization or tricks are required (unlike softmax-gated MoEs).\n*   All models are trained for 100k steps using Adam with standard learning rates and dropout.\n*   Language modeling tasks are evaluated under both parameter-matched and MAC-matched settings.\n\n**Model Configuration**:\n\n*   Uses 2 or 4 heads, each with multiple experts (typically 4–5).\n*   Expert selection budget kkk (number of active experts) ranges from 2–4.\n*   Transformer XL and RoPE positional encodings are supported.\n\n**Datasets**: C4, Wikitext-103, Enwik8, and peS2o for pretraining; Lambada, BLiMP, and CBT for zero-shot downstream evaluation.\n\n**Performance Comparison**:\n\n*   In parameter-matched settings, SwitchHead achieves similar perplexity with only **44% compute and 27% memory usage**.\n*   In MAC-matched settings, it outperforms the baseline in both perplexity and zero-shot accuracy.\n*   Compared to Mixture of Attention Heads (MoA), SwitchHead is more compute-efficient due to fewer attention matrices and avoids competitive gating complexities.\n\n**SwitchAll**: Combines SwitchHead attention with σ-MoE-based MLPs for a fully MoE Transformer. Demonstrates further reductions in compute and memory with no degradation in language modeling performance.\n\n**Analysis**:\n\n*   SwitchHead’s attention maps are qualitatively similar to dense Transformers, including interpretable induction heads.\n*   Attention head usage is sparse and often semantically specialized.\n\n**Key Empirical Finding**:\n\n*   MoE for **value and output** projections is essential; MoE for key and query projections offers no benefit under parameter-matching.\n\nThe following figure from the paper shows a schematic representation of SwitchHead. It consists of a few independent heads, each with multiple experts for value and output projections. Each head has a single attention matrix.\n\n![](../../../images/papers/SwitchHead.jpg)\n\n**Benchmarks**:\n\n*   On Wikitext-103, a 47M SwitchHead matches the baseline (perplexity ~12.3) with **62% fewer MACs** and **77% less memory usage**.\n*   On downstream tasks (Lambada, BLiMP, CBT), SwitchHead outperforms dense baselines in zero-shot accuracy.\n\n[Code](https://github.com/robertcsordas/switchhead)",
    "contentLength": 73507,
    "wordCount": 1360,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#switchhead:-accelerating-transformers-with-mixture-of-experts-attention"
  },
  {
    "id": "ai-mixture-of-experts-umoe-unifying-attention-and-ffn-with-shared-expert-88",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "UMoE: Unifying Attention and FFN with Shared Experts",
    "order": 88,
    "orderInChapter": 16,
    "contentHtml": "<ul>\n  <li>\n    <p>This paper by Yang et al. introduces <strong>UMoE</strong>, a novel MoE architecture that unifies attention and feed-forward network (FFN) layers in Transformer models. The core innovation lies in reformulating attention mechanisms to reveal an FFN-like structure, enabling shared expert design and efficient parameter sharing across both attention and FFN modules. This approach enhances performance while maintaining computational efficiency and model scalability.</p>\n  </li>\n  <li>\n    <p>Traditional sparse MoE models apply expert selection only in FFN layers due to structural simplicity. Attempts to extend MoE to attention layers face challenges related to complex attention operations and expert routing. UMoE addresses these challenges by decomposing attention into <strong>token mixing</strong> followed by <strong>expert processing</strong>, thus aligning attention with the structure of FFN layers.</p>\n  </li>\n  <li>\n    <p><strong>Architecture and Implementation</strong>:</p>\n\n    <ul>\n      <li>\n        <p><strong>Pre-mixing Attention Reformulation</strong>: The authors reinterpret multi-head attention to highlight a two-step process:</p>\n\n        <ul>\n          <li>First, perform <strong>token mixing</strong> (contextualization) using softmax attention over keys and values.</li>\n          <li>Then apply <strong>expert processing</strong> via two consecutive matrix multiplications—mirroring the FFN structure.</li>\n          <li>Expert outputs are then aggregated using weighted attention scores.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Expert Design</strong>:</p>\n\n        <ul>\n          <li>Experts are two-layer MLPs (with non-linearity), sized similarly to FFN modules but configured with reduced intermediate dimension <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-497-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>d</mi><mi>v</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4028\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4029\"><span class=\"msubsup\" id=\"MathJax-Span-4030\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4031\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4032\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>d</mi><mi>v</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-497\">d_v</script>.</li>\n          <li>Experts are <strong>shared across both attention and FFN layers</strong>, reducing parameter redundancy.</li>\n          <li>To mitigate parameter bloat due to unique query projections per expert, <strong>low-rank parameterization</strong> (LoRA-style) is used:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-498-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mi>x</mi><msub><mi>W</mi><mi>q</mi></msub><mo>+</mo><mi>x</mi><msubsup><mi>W</mi><mi>a</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><msubsup><mi>W</mi><mi>b</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4033\" style=\"width: 10.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.753em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1008.75em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4034\"><span class=\"msubsup\" id=\"MathJax-Span-4035\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4036\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4037\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4038\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-4039\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4040\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4041\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4042\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4043\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-4044\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4045\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4046\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4047\"><span class=\"mrow\" id=\"MathJax-Span-4048\"><span class=\"mo\" id=\"MathJax-Span-4049\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4050\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4051\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4052\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4053\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4054\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4055\"><span class=\"mrow\" id=\"MathJax-Span-4056\"><span class=\"mo\" id=\"MathJax-Span-4057\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4058\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4059\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4060\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mi>x</mi><msub><mi>W</mi><mi>q</mi></msub><mo>+</mo><mi>x</mi><msubsup><mi>W</mi><mi>a</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><msubsup><mi>W</mi><mi>b</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-498\">q_i = xW_q + xW_a^{(i)}W_b^{(i)}</script></li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Routing Mechanism</strong>:</p>\n\n        <ul>\n          <li>A <strong>top-k router</strong> selects the most relevant experts for each token.</li>\n          <li>In attention modules, all tokens share key/value matrices, while each expert contributes uniquely parameterized query projections.</li>\n          <li>In FFN layers, each token is processed independently by its top-k selected experts.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>UMoE Layer Structure</strong>:</p>\n\n        <ul>\n          <li>Incorporates <strong>pre-mixing attention</strong> followed by FFN, with shared experts used in both parts.</li>\n          <li>Attention experts operate on token-mixed (contextual) inputs; FFN experts operate on independent tokens.</li>\n          <li>The design generalizes FFN-MoE as a special case of attention-MoE with identity attention weights.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training and Optimization</strong>:</p>\n\n        <ul>\n          <li>UMoE uses decoder-only Transformer blocks with rotary embeddings.</li>\n          <li>Incorporates Switch Transformer’s <strong>load balancing loss</strong> to encourage even expert utilization.</li>\n          <li>Models are trained on FineWeb-Edu (100B tokens) and Wikitext-103 (100M tokens) using standard setups (12-layer 134M and 24-layer 1.1B models).</li>\n        </ul>\n      </li>\n      <li>\n        <p>The following figure from the paper shows (;eft) the architecture of a UMoE layer, incorporating MoE into both FFN and attention modules with shared experts. The primary distinction between attention-MoE and FFN-MoE lies in an additional token mixing operation; (right) Two formulations of the multi-head attention mechanism. (a) Vanilla attention interleaves mixing operations with value and output projections. (b) Pre-mixing attention performs token mixing prior to projections.</p>\n      </li>\n    </ul>\n\n    <p><img src=\"../../../images/papers/UMoE.jpg\" alt=\"\"></p>\n  </li>\n  <li>\n    <p><strong>Empirical Results</strong>:</p>\n\n    <ul>\n      <li>On both pretraining (perplexity) and zero-shot downstream tasks, UMoE consistently outperforms dense, FFN-MoE, and prior attention-MoE baselines (e.g., MoA, SwitchHead).</li>\n      <li><strong>Zero-shot accuracy</strong> improvements are observed on benchmarks like MMLU, ARC, RACE, and HellaSwag.</li>\n      <li><strong>MAC-matched comparisons</strong> show UMoE retains its edge even when other models are given equivalent compute budgets.</li>\n      <li><strong>Inference efficiency</strong>: While introducing ~1.17× latency at smaller scales, UMoE’s overhead drops to ~1.03× in large models due to amortized compute in expert layers.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Ablation Studies and Analysis</strong>:</p>\n\n    <ul>\n      <li><strong>Pre-mixing vs. Post-mixing</strong>: Pre-mixing (contextual input → expert) significantly outperforms post-mixing (expert output → attention) in both training speed and final performance.</li>\n      <li><strong>Expert Allocation</strong>: Allocating more experts to attention layers rather than FFNs improves performance, reinforcing the theoretical equivalence of FFNs as limited-attention layers.</li>\n      <li><strong>Activation Functions</strong>: Including activation between expert matrix layers boosts performance; removing them leads to consistent degradation, highlighting the role of non-linearity.</li>\n      <li><strong>Expert Specialization</strong>: Routing analysis shows interpretable specialization patterns (e.g., determiners or punctuation tokens routing to specific experts across layers).</li>\n    </ul>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/ysngki/UMoE\">Code</a></p>\n  </li>\n</ul>\n<p>This paper by Yang et al. introduces <strong>UMoE</strong>, a novel MoE architecture that unifies attention and feed-forward network (FFN) layers in Transformer models. The core innovation lies in reformulating attention mechanisms to reveal an FFN-like structure, enabling shared expert design and efficient parameter sharing across both attention and FFN modules. This approach enhances performance while maintaining computational efficiency and model scalability.</p>\n<p>Traditional sparse MoE models apply expert selection only in FFN layers due to structural simplicity. Attempts to extend MoE to attention layers face challenges related to complex attention operations and expert routing. UMoE addresses these challenges by decomposing attention into <strong>token mixing</strong> followed by <strong>expert processing</strong>, thus aligning attention with the structure of FFN layers.</p>\n<p><strong>Architecture and Implementation</strong>:</p>\n<ul>\n      <li>\n        <p><strong>Pre-mixing Attention Reformulation</strong>: The authors reinterpret multi-head attention to highlight a two-step process:</p>\n\n        <ul>\n          <li>First, perform <strong>token mixing</strong> (contextualization) using softmax attention over keys and values.</li>\n          <li>Then apply <strong>expert processing</strong> via two consecutive matrix multiplications—mirroring the FFN structure.</li>\n          <li>Expert outputs are then aggregated using weighted attention scores.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Expert Design</strong>:</p>\n\n        <ul>\n          <li>Experts are two-layer MLPs (with non-linearity), sized similarly to FFN modules but configured with reduced intermediate dimension <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-497-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>d</mi><mi>v</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4028\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4029\"><span class=\"msubsup\" id=\"MathJax-Span-4030\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4031\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4032\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>d</mi><mi>v</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-497\">d_v</script>.</li>\n          <li>Experts are <strong>shared across both attention and FFN layers</strong>, reducing parameter redundancy.</li>\n          <li>To mitigate parameter bloat due to unique query projections per expert, <strong>low-rank parameterization</strong> (LoRA-style) is used:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-498-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mi>x</mi><msub><mi>W</mi><mi>q</mi></msub><mo>+</mo><mi>x</mi><msubsup><mi>W</mi><mi>a</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><msubsup><mi>W</mi><mi>b</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4033\" style=\"width: 10.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.753em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1008.75em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4034\"><span class=\"msubsup\" id=\"MathJax-Span-4035\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4036\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4037\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4038\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-4039\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4040\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4041\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4042\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4043\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-4044\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4045\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4046\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4047\"><span class=\"mrow\" id=\"MathJax-Span-4048\"><span class=\"mo\" id=\"MathJax-Span-4049\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4050\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4051\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4052\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4053\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4054\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4055\"><span class=\"mrow\" id=\"MathJax-Span-4056\"><span class=\"mo\" id=\"MathJax-Span-4057\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4058\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4059\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4060\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mi>x</mi><msub><mi>W</mi><mi>q</mi></msub><mo>+</mo><mi>x</mi><msubsup><mi>W</mi><mi>a</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><msubsup><mi>W</mi><mi>b</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-498\">q_i = xW_q + xW_a^{(i)}W_b^{(i)}</script></li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Routing Mechanism</strong>:</p>\n\n        <ul>\n          <li>A <strong>top-k router</strong> selects the most relevant experts for each token.</li>\n          <li>In attention modules, all tokens share key/value matrices, while each expert contributes uniquely parameterized query projections.</li>\n          <li>In FFN layers, each token is processed independently by its top-k selected experts.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>UMoE Layer Structure</strong>:</p>\n\n        <ul>\n          <li>Incorporates <strong>pre-mixing attention</strong> followed by FFN, with shared experts used in both parts.</li>\n          <li>Attention experts operate on token-mixed (contextual) inputs; FFN experts operate on independent tokens.</li>\n          <li>The design generalizes FFN-MoE as a special case of attention-MoE with identity attention weights.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training and Optimization</strong>:</p>\n\n        <ul>\n          <li>UMoE uses decoder-only Transformer blocks with rotary embeddings.</li>\n          <li>Incorporates Switch Transformer’s <strong>load balancing loss</strong> to encourage even expert utilization.</li>\n          <li>Models are trained on FineWeb-Edu (100B tokens) and Wikitext-103 (100M tokens) using standard setups (12-layer 134M and 24-layer 1.1B models).</li>\n        </ul>\n      </li>\n      <li>\n        <p>The following figure from the paper shows (;eft) the architecture of a UMoE layer, incorporating MoE into both FFN and attention modules with shared experts. The primary distinction between attention-MoE and FFN-MoE lies in an additional token mixing operation; (right) Two formulations of the multi-head attention mechanism. (a) Vanilla attention interleaves mixing operations with value and output projections. (b) Pre-mixing attention performs token mixing prior to projections.</p>\n      </li>\n    </ul>\n<p><strong>Pre-mixing Attention Reformulation</strong>: The authors reinterpret multi-head attention to highlight a two-step process:</p>\n<ul>\n          <li>First, perform <strong>token mixing</strong> (contextualization) using softmax attention over keys and values.</li>\n          <li>Then apply <strong>expert processing</strong> via two consecutive matrix multiplications—mirroring the FFN structure.</li>\n          <li>Expert outputs are then aggregated using weighted attention scores.</li>\n        </ul>\n<p><strong>Expert Design</strong>:</p>\n<ul>\n          <li>Experts are two-layer MLPs (with non-linearity), sized similarly to FFN modules but configured with reduced intermediate dimension <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-497-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>d</mi><mi>v</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4028\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4029\"><span class=\"msubsup\" id=\"MathJax-Span-4030\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4031\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4032\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>d</mi><mi>v</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-497\">d_v</script>.</li>\n          <li>Experts are <strong>shared across both attention and FFN layers</strong>, reducing parameter redundancy.</li>\n          <li>To mitigate parameter bloat due to unique query projections per expert, <strong>low-rank parameterization</strong> (LoRA-style) is used:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-498-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mi>x</mi><msub><mi>W</mi><mi>q</mi></msub><mo>+</mo><mi>x</mi><msubsup><mi>W</mi><mi>a</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup><msubsup><mi>W</mi><mi>b</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4033\" style=\"width: 10.523em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 8.753em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1008.75em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4034\"><span class=\"msubsup\" id=\"MathJax-Span-4035\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4036\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4037\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4038\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-4039\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4040\"><span style=\"display: inline-block; position: relative; width: 1.253em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4041\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4042\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4043\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-4044\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4045\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4046\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4047\"><span class=\"mrow\" id=\"MathJax-Span-4048\"><span class=\"mo\" id=\"MathJax-Span-4049\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4050\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4051\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -3.852em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4052\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4053\"><span style=\"display: inline-block; position: relative; width: 1.721em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4054\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.73em, 4.273em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"texatom\" id=\"MathJax-Span-4055\"><span class=\"mrow\" id=\"MathJax-Span-4056\"><span class=\"mo\" id=\"MathJax-Span-4057\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4058\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4059\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.42em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4060\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">b</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mi>x</mi><msub><mi>W</mi><mi>q</mi></msub><mo>+</mo><mi>x</mi><msubsup><mi>W</mi><mi>a</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup><msubsup><mi>W</mi><mi>b</mi><mrow class=\"MJX-TeXAtom-ORD\"><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-498\">q_i = xW_q + xW_a^{(i)}W_b^{(i)}</script></li>\n        </ul>\n<p><strong>Routing Mechanism</strong>:</p>\n<ul>\n          <li>A <strong>top-k router</strong> selects the most relevant experts for each token.</li>\n          <li>In attention modules, all tokens share key/value matrices, while each expert contributes uniquely parameterized query projections.</li>\n          <li>In FFN layers, each token is processed independently by its top-k selected experts.</li>\n        </ul>\n<p><strong>UMoE Layer Structure</strong>:</p>\n<ul>\n          <li>Incorporates <strong>pre-mixing attention</strong> followed by FFN, with shared experts used in both parts.</li>\n          <li>Attention experts operate on token-mixed (contextual) inputs; FFN experts operate on independent tokens.</li>\n          <li>The design generalizes FFN-MoE as a special case of attention-MoE with identity attention weights.</li>\n        </ul>\n<p><strong>Training and Optimization</strong>:</p>\n<ul>\n          <li>UMoE uses decoder-only Transformer blocks with rotary embeddings.</li>\n          <li>Incorporates Switch Transformer’s <strong>load balancing loss</strong> to encourage even expert utilization.</li>\n          <li>Models are trained on FineWeb-Edu (100B tokens) and Wikitext-103 (100M tokens) using standard setups (12-layer 134M and 24-layer 1.1B models).</li>\n        </ul>\n<p>The following figure from the paper shows (;eft) the architecture of a UMoE layer, incorporating MoE into both FFN and attention modules with shared experts. The primary distinction between attention-MoE and FFN-MoE lies in an additional token mixing operation; (right) Two formulations of the multi-head attention mechanism. (a) Vanilla attention interleaves mixing operations with value and output projections. (b) Pre-mixing attention performs token mixing prior to projections.</p>\n<p><img src=\"../../../images/papers/UMoE.jpg\" alt=\"\"></p>\n<p><strong>Empirical Results</strong>:</p>\n<ul>\n      <li>On both pretraining (perplexity) and zero-shot downstream tasks, UMoE consistently outperforms dense, FFN-MoE, and prior attention-MoE baselines (e.g., MoA, SwitchHead).</li>\n      <li><strong>Zero-shot accuracy</strong> improvements are observed on benchmarks like MMLU, ARC, RACE, and HellaSwag.</li>\n      <li><strong>MAC-matched comparisons</strong> show UMoE retains its edge even when other models are given equivalent compute budgets.</li>\n      <li><strong>Inference efficiency</strong>: While introducing ~1.17× latency at smaller scales, UMoE’s overhead drops to ~1.03× in large models due to amortized compute in expert layers.</li>\n    </ul>\n<p><strong>Ablation Studies and Analysis</strong>:</p>\n<ul>\n      <li><strong>Pre-mixing vs. Post-mixing</strong>: Pre-mixing (contextual input → expert) significantly outperforms post-mixing (expert output → attention) in both training speed and final performance.</li>\n      <li><strong>Expert Allocation</strong>: Allocating more experts to attention layers rather than FFNs improves performance, reinforcing the theoretical equivalence of FFNs as limited-attention layers.</li>\n      <li><strong>Activation Functions</strong>: Including activation between expert matrix layers boosts performance; removing them leads to consistent degradation, highlighting the role of non-linearity.</li>\n      <li><strong>Expert Specialization</strong>: Routing analysis shows interpretable specialization patterns (e.g., determiners or punctuation tokens routing to specific experts across layers).</li>\n    </ul>\n<p><a href=\"https://github.com/ysngki/UMoE\">Code</a></p>",
    "contentMarkdown": "*   This paper by Yang et al. introduces **UMoE**, a novel MoE architecture that unifies attention and feed-forward network (FFN) layers in Transformer models. The core innovation lies in reformulating attention mechanisms to reveal an FFN-like structure, enabling shared expert design and efficient parameter sharing across both attention and FFN modules. This approach enhances performance while maintaining computational efficiency and model scalability.\n    \n*   Traditional sparse MoE models apply expert selection only in FFN layers due to structural simplicity. Attempts to extend MoE to attention layers face challenges related to complex attention operations and expert routing. UMoE addresses these challenges by decomposing attention into **token mixing** followed by **expert processing**, thus aligning attention with the structure of FFN layers.\n    \n*   **Architecture and Implementation**:\n    \n    *   **Pre-mixing Attention Reformulation**: The authors reinterpret multi-head attention to highlight a two-step process:\n        \n        *   First, perform **token mixing** (contextualization) using softmax attention over keys and values.\n        *   Then apply **expert processing** via two consecutive matrix multiplications—mirroring the FFN structure.\n        *   Expert outputs are then aggregated using weighted attention scores.\n    *   **Expert Design**:\n        \n        *   Experts are two-layer MLPs (with non-linearity), sized similarly to FFN modules but configured with reduced intermediate dimension dvdvd\\_v.\n        *   Experts are **shared across both attention and FFN layers**, reducing parameter redundancy.\n        *   To mitigate parameter bloat due to unique query projections per expert, **low-rank parameterization** (LoRA-style) is used: qi\\=xWq+xW(i)aW(i)bqi\\=xWq+xWa(i)Wb(i)q\\_i = xW\\_q + xW\\_a^{(i)}W\\_b^{(i)}\n    *   **Routing Mechanism**:\n        \n        *   A **top-k router** selects the most relevant experts for each token.\n        *   In attention modules, all tokens share key/value matrices, while each expert contributes uniquely parameterized query projections.\n        *   In FFN layers, each token is processed independently by its top-k selected experts.\n    *   **UMoE Layer Structure**:\n        \n        *   Incorporates **pre-mixing attention** followed by FFN, with shared experts used in both parts.\n        *   Attention experts operate on token-mixed (contextual) inputs; FFN experts operate on independent tokens.\n        *   The design generalizes FFN-MoE as a special case of attention-MoE with identity attention weights.\n    *   **Training and Optimization**:\n        \n        *   UMoE uses decoder-only Transformer blocks with rotary embeddings.\n        *   Incorporates Switch Transformer’s **load balancing loss** to encourage even expert utilization.\n        *   Models are trained on FineWeb-Edu (100B tokens) and Wikitext-103 (100M tokens) using standard setups (12-layer 134M and 24-layer 1.1B models).\n    *   The following figure from the paper shows (;eft) the architecture of a UMoE layer, incorporating MoE into both FFN and attention modules with shared experts. The primary distinction between attention-MoE and FFN-MoE lies in an additional token mixing operation; (right) Two formulations of the multi-head attention mechanism. (a) Vanilla attention interleaves mixing operations with value and output projections. (b) Pre-mixing attention performs token mixing prior to projections.\n        \n    \n    ![](../../../images/papers/UMoE.jpg)\n    \n*   **Empirical Results**:\n    \n    *   On both pretraining (perplexity) and zero-shot downstream tasks, UMoE consistently outperforms dense, FFN-MoE, and prior attention-MoE baselines (e.g., MoA, SwitchHead).\n    *   **Zero-shot accuracy** improvements are observed on benchmarks like MMLU, ARC, RACE, and HellaSwag.\n    *   **MAC-matched comparisons** show UMoE retains its edge even when other models are given equivalent compute budgets.\n    *   **Inference efficiency**: While introducing ~1.17× latency at smaller scales, UMoE’s overhead drops to ~1.03× in large models due to amortized compute in expert layers.\n*   **Ablation Studies and Analysis**:\n    \n    *   **Pre-mixing vs. Post-mixing**: Pre-mixing (contextual input → expert) significantly outperforms post-mixing (expert output → attention) in both training speed and final performance.\n    *   **Expert Allocation**: Allocating more experts to attention layers rather than FFNs improves performance, reinforcing the theoretical equivalence of FFNs as limited-attention layers.\n    *   **Activation Functions**: Including activation between expert matrix layers boosts performance; removing them leads to consistent degradation, highlighting the role of non-linearity.\n    *   **Expert Specialization**: Routing analysis shows interpretable specialization patterns (e.g., determiners or punctuation tokens routing to specific experts across layers).\n*   [Code](https://github.com/ysngki/UMoE)\n    \n\nThis paper by Yang et al. introduces **UMoE**, a novel MoE architecture that unifies attention and feed-forward network (FFN) layers in Transformer models. The core innovation lies in reformulating attention mechanisms to reveal an FFN-like structure, enabling shared expert design and efficient parameter sharing across both attention and FFN modules. This approach enhances performance while maintaining computational efficiency and model scalability.\n\nTraditional sparse MoE models apply expert selection only in FFN layers due to structural simplicity. Attempts to extend MoE to attention layers face challenges related to complex attention operations and expert routing. UMoE addresses these challenges by decomposing attention into **token mixing** followed by **expert processing**, thus aligning attention with the structure of FFN layers.\n\n**Architecture and Implementation**:\n\n*   **Pre-mixing Attention Reformulation**: The authors reinterpret multi-head attention to highlight a two-step process:\n    \n    *   First, perform **token mixing** (contextualization) using softmax attention over keys and values.\n    *   Then apply **expert processing** via two consecutive matrix multiplications—mirroring the FFN structure.\n    *   Expert outputs are then aggregated using weighted attention scores.\n*   **Expert Design**:\n    \n    *   Experts are two-layer MLPs (with non-linearity), sized similarly to FFN modules but configured with reduced intermediate dimension dvdvd\\_v.\n    *   Experts are **shared across both attention and FFN layers**, reducing parameter redundancy.\n    *   To mitigate parameter bloat due to unique query projections per expert, **low-rank parameterization** (LoRA-style) is used: qi\\=xWq+xW(i)aW(i)bqi\\=xWq+xWa(i)Wb(i)q\\_i = xW\\_q + xW\\_a^{(i)}W\\_b^{(i)}\n*   **Routing Mechanism**:\n    \n    *   A **top-k router** selects the most relevant experts for each token.\n    *   In attention modules, all tokens share key/value matrices, while each expert contributes uniquely parameterized query projections.\n    *   In FFN layers, each token is processed independently by its top-k selected experts.\n*   **UMoE Layer Structure**:\n    \n    *   Incorporates **pre-mixing attention** followed by FFN, with shared experts used in both parts.\n    *   Attention experts operate on token-mixed (contextual) inputs; FFN experts operate on independent tokens.\n    *   The design generalizes FFN-MoE as a special case of attention-MoE with identity attention weights.\n*   **Training and Optimization**:\n    \n    *   UMoE uses decoder-only Transformer blocks with rotary embeddings.\n    *   Incorporates Switch Transformer’s **load balancing loss** to encourage even expert utilization.\n    *   Models are trained on FineWeb-Edu (100B tokens) and Wikitext-103 (100M tokens) using standard setups (12-layer 134M and 24-layer 1.1B models).\n*   The following figure from the paper shows (;eft) the architecture of a UMoE layer, incorporating MoE into both FFN and attention modules with shared experts. The primary distinction between attention-MoE and FFN-MoE lies in an additional token mixing operation; (right) Two formulations of the multi-head attention mechanism. (a) Vanilla attention interleaves mixing operations with value and output projections. (b) Pre-mixing attention performs token mixing prior to projections.\n    \n\n**Pre-mixing Attention Reformulation**: The authors reinterpret multi-head attention to highlight a two-step process:\n\n*   First, perform **token mixing** (contextualization) using softmax attention over keys and values.\n*   Then apply **expert processing** via two consecutive matrix multiplications—mirroring the FFN structure.\n*   Expert outputs are then aggregated using weighted attention scores.\n\n**Expert Design**:\n\n*   Experts are two-layer MLPs (with non-linearity), sized similarly to FFN modules but configured with reduced intermediate dimension dvdvd\\_v.\n*   Experts are **shared across both attention and FFN layers**, reducing parameter redundancy.\n*   To mitigate parameter bloat due to unique query projections per expert, **low-rank parameterization** (LoRA-style) is used: qi\\=xWq+xW(i)aW(i)bqi\\=xWq+xWa(i)Wb(i)q\\_i = xW\\_q + xW\\_a^{(i)}W\\_b^{(i)}\n\n**Routing Mechanism**:\n\n*   A **top-k router** selects the most relevant experts for each token.\n*   In attention modules, all tokens share key/value matrices, while each expert contributes uniquely parameterized query projections.\n*   In FFN layers, each token is processed independently by its top-k selected experts.\n\n**UMoE Layer Structure**:\n\n*   Incorporates **pre-mixing attention** followed by FFN, with shared experts used in both parts.\n*   Attention experts operate on token-mixed (contextual) inputs; FFN experts operate on independent tokens.\n*   The design generalizes FFN-MoE as a special case of attention-MoE with identity attention weights.\n\n**Training and Optimization**:\n\n*   UMoE uses decoder-only Transformer blocks with rotary embeddings.\n*   Incorporates Switch Transformer’s **load balancing loss** to encourage even expert utilization.\n*   Models are trained on FineWeb-Edu (100B tokens) and Wikitext-103 (100M tokens) using standard setups (12-layer 134M and 24-layer 1.1B models).\n\nThe following figure from the paper shows (;eft) the architecture of a UMoE layer, incorporating MoE into both FFN and attention modules with shared experts. The primary distinction between attention-MoE and FFN-MoE lies in an additional token mixing operation; (right) Two formulations of the multi-head attention mechanism. (a) Vanilla attention interleaves mixing operations with value and output projections. (b) Pre-mixing attention performs token mixing prior to projections.\n\n![](../../../images/papers/UMoE.jpg)\n\n**Empirical Results**:\n\n*   On both pretraining (perplexity) and zero-shot downstream tasks, UMoE consistently outperforms dense, FFN-MoE, and prior attention-MoE baselines (e.g., MoA, SwitchHead).\n*   **Zero-shot accuracy** improvements are observed on benchmarks like MMLU, ARC, RACE, and HellaSwag.\n*   **MAC-matched comparisons** show UMoE retains its edge even when other models are given equivalent compute budgets.\n*   **Inference efficiency**: While introducing ~1.17× latency at smaller scales, UMoE’s overhead drops to ~1.03× in large models due to amortized compute in expert layers.\n\n**Ablation Studies and Analysis**:\n\n*   **Pre-mixing vs. Post-mixing**: Pre-mixing (contextual input → expert) significantly outperforms post-mixing (expert output → attention) in both training speed and final performance.\n*   **Expert Allocation**: Allocating more experts to attention layers rather than FFNs improves performance, reinforcing the theoretical equivalence of FFNs as limited-attention layers.\n*   **Activation Functions**: Including activation between expert matrix layers boosts performance; removing them leads to consistent degradation, highlighting the role of non-linearity.\n*   **Expert Specialization**: Routing analysis shows interpretable specialization patterns (e.g., determiners or punctuation tokens routing to specific experts across layers).\n\n[Code](https://github.com/ysngki/UMoE)",
    "contentLength": 40806,
    "wordCount": 1526,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#umoe:-unifying-attention-and-ffn-with-shared-experts"
  },
  {
    "id": "ai-mixture-of-experts-mixture-of-attention-heads-selecting-attention-hea-89",
    "articleSlug": "mixture-of-experts",
    "articleTitle": "Mixture-of-Experts",
    "category": "Algorithms/Architecture",
    "chapter": "Related Papers",
    "title": "Mixture of Attention Heads: Selecting Attention Heads Per Token",
    "order": 89,
    "orderInChapter": 17,
    "contentHtml": "<ul>\n  <li>\n    <p>This paper by Zhang et al. from Beihang University, Mila, and Tencent introduces the <strong>Mixture of Attention Heads (MoA)</strong>, a novel attention mechanism that integrates the MoE framework into the multi-head attention (MHA) component of Transformer architectures. While previous MoE work mainly focused on feedforward layers, MoA innovatively applies conditional computation to attention heads, allowing different tokens to dynamically select specialized attention heads, thereby improving performance and computational efficiency.</p>\n  </li>\n  <li>\n    <p><strong>Core Architecture and Computation</strong>:</p>\n\n    <ul>\n      <li>\n        <p><strong>Model Composition</strong>: MoA replaces the standard MHA with a structure containing:</p>\n\n        <ul>\n          <li>A <strong>routing network</strong> that assigns confidence scores to each attention head (called attention experts).</li>\n          <li>A <strong>set of attention experts</strong>, each with its own query and output projection weights but shared key and value projections to reduce redundancy.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Token-specific Selection</strong>: For each input token, the routing network selects the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-499-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4061\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4062\"><span class=\"mi\" id=\"MathJax-Span-4063\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-499\">k</script> attention experts based on softmax-normalized scores derived from a linear projection of the query. The selected heads’ outputs are weighted by their routing confidence and summed to produce the token-level output:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-500-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>y</mi><mi>t</mi></msub><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mi>G</mi><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><msub><mi>w</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>&amp;#x22C5;</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4064\" style=\"width: 13.753em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1011.41em, 3.805em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4065\"><span class=\"msubsup\" id=\"MathJax-Span-4066\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4067\" style=\"font-family: STIXGeneral-Italic;\">y</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-4068\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4069\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-4070\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.242em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.471em;\"><span class=\"mo\" id=\"MathJax-Span-4071\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1002.19em, 4.43em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-4072\"><span class=\"mrow\" id=\"MathJax-Span-4073\"><span class=\"mi\" id=\"MathJax-Span-4074\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4075\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"mi\" id=\"MathJax-Span-4076\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">G</span><span class=\"mo\" id=\"MathJax-Span-4077\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4078\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.37em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4079\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4080\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4081\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4082\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4083\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-4084\"><span class=\"mrow\" id=\"MathJax-Span-4085\"><span class=\"mi\" id=\"MathJax-Span-4086\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4087\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4088\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4089\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4090\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4091\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4092\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4093\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4094\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4095\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4096\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4097\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4098\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4099\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4100\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4101\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.747em; border-left: 0px solid; width: 0px; height: 3.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>y</mi><mi>t</mi></msub><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><mi>G</mi><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo stretchy=\"false\">)</mo></mrow></munder><msub><mi>w</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>⋅</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-500\">y_t = \\sum_{i \\in G(q_t)} w_{i,t} \\cdot E_i(q_t, K, V)</script>\n      </li>\n      <li>\n        <p><strong>Expert Attention Computation</strong>:</p>\n\n        <ul>\n          <li>Each expert performs scaled dot-product attention using its own <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-501-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4102\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1001.41em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4103\"><span class=\"msubsup\" id=\"MathJax-Span-4104\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4105\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.326em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4106\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4107\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.441em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-501\">W^q_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-502-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4108\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.41em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4109\"><span class=\"msubsup\" id=\"MathJax-Span-4110\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4111\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4112\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4113\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-502\">W^o_i</script>, while sharing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-503-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>W</mi><mi>k</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4114\" style=\"width: 1.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.36em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4115\"><span class=\"msubsup\" id=\"MathJax-Span-4116\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4117\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4118\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>W</mi><mi>k</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-503\">W^k</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-504-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>W</mi><mi>v</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4119\" style=\"width: 1.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.36em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4120\"><span class=\"msubsup\" id=\"MathJax-Span-4121\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4122\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4123\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>W</mi><mi>v</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-504\">W^v</script> across all experts.</li>\n          <li>Output per expert:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-505-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>Softmax</mtext><mrow><mo>(</mo><mfrac><mrow><msub><mi>q</mi><mi>t</mi></msub><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>K</mi><msup><mi>W</mi><mi>k</mi></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><msup><mi>W</mi><mi>v</mi></msup><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4124\" style=\"width: 22.607em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 18.805em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.086em, 1018.8em, 4.43em, -999.997em); top: -3.487em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4125\"><span class=\"msubsup\" id=\"MathJax-Span-4126\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4127\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4128\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4129\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4130\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4131\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4132\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4133\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4134\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4135\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4136\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4137\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4138\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-4139\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">Softmax</span><span class=\"mrow\" id=\"MathJax-Span-4140\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-4141\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">(</span></span><span class=\"mfrac\" id=\"MathJax-Span-4142\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.232em, 1003.91em, 4.378em, -999.997em); top: -4.633em; left: 50%; margin-left: -1.924em;\"><span class=\"mrow\" id=\"MathJax-Span-4143\"><span class=\"msubsup\" id=\"MathJax-Span-4144\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.37em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4145\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4146\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4147\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4148\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.648em, 1000.32em, 4.273em, -999.997em); top: -4.372em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-4149\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.21em, 4.169em, -999.997em); top: -3.799em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4150\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4151\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4152\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4153\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4154\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-4155\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4156\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.21em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4157\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4158\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.232em, 1001.3em, 4.43em, -999.997em); top: -3.487em; left: 50%; margin-left: -0.674em;\"><span class=\"msqrt\" id=\"MathJax-Span-4159\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.68em, 4.273em, -999.997em); top: -4.008em; left: 0.68em;\"><span class=\"mrow\" id=\"MathJax-Span-4160\"><span class=\"msubsup\" id=\"MathJax-Span-4161\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4162\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4163\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.94em, 1000.68em, 1.253em, -999.997em); top: -1.664em; left: 0.68em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.049em; border-top: 1.2px solid; width: 0.68em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.378em, -999.997em); top: -3.956em; left: 0em;\"><span><span style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">√</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1004.01em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 4.013em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4164\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">)</span></span></span><span class=\"mi\" id=\"MathJax-Span-4165\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4166\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4167\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4168\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4169\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4170\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4171\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4172\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.492em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.997em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>Softmax</mtext><mrow><mo>(</mo><mfrac><mrow><msub><mi>q</mi><mi>t</mi></msub><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup><mo stretchy=\"false\">(</mo><mi>K</mi><msup><mi>W</mi><mi>k</mi></msup><msup><mo stretchy=\"false\">)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><msup><mi>W</mi><mi>v</mi></msup><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-505\">E_i(q_t, K, V) = \\text{Softmax}\\left(\\frac{q_t W^q_i (K W^k)^T}{\\sqrt{d_h}}\\right) V W^v W^o_i</script></li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training Losses</strong>:</p>\n\n        <ul>\n          <li><strong>Auxiliary Load Balancing Loss</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-506-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>a</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4173\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4174\"><span class=\"msubsup\" id=\"MathJax-Span-4175\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4176\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4177\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>a</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-506\">L_a</script> to promote expert usage diversity:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-507-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>a</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>Q</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>N</mi><mo>&amp;#x22C5;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x22C5;</mo><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4178\" style=\"width: 12.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.003em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4179\"><span class=\"msubsup\" id=\"MathJax-Span-4180\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4181\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4182\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4183\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4184\" style=\"font-family: STIXGeneral-Italic;\">Q</span><span class=\"mo\" id=\"MathJax-Span-4185\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4186\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-4187\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4188\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"munderover\" id=\"MathJax-Span-4189\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4190\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4191\"><span class=\"mrow\" id=\"MathJax-Span-4192\"><span class=\"mi\" id=\"MathJax-Span-4193\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4194\"><span class=\"mrow\" id=\"MathJax-Span-4195\"><span class=\"mi\" id=\"MathJax-Span-4196\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4197\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4198\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4199\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4200\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4201\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4202\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4203\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4204\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4205\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>a</mi></msub><mo stretchy=\"false\">(</mo><mi>Q</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>N</mi><mo>⋅</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-507\">L_a(Q) = N \\cdot \\sum_{i=1}^{N} f_i \\cdot P_i</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-508-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4206\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4207\"><span class=\"msubsup\" id=\"MathJax-Span-4208\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4209\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4210\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-508\">f_i</script> counts token assignments and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-509-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4211\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4212\"><span class=\"msubsup\" id=\"MathJax-Span-4213\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4214\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4215\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-509\">P_i</script> is the aggregated routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-510-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4216\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4217\"><span class=\"mi\" id=\"MathJax-Span-4218\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-510\">i</script>.</li>\n            </ul>\n          </li>\n          <li><strong>Router Z-loss</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-511-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4219\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4220\"><span class=\"msubsup\" id=\"MathJax-Span-4221\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4222\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4223\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-511\">L_z</script> stabilizes training by penalizing large pre-softmax logits:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-512-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msup><mrow><mo>(</mo><mrow><mi>log</mi><mo>&amp;#x2061;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mrow></msup></mrow><mo>)</mo></mrow><mn>2</mn></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4224\" style=\"width: 15.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.023em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.888em, 1013.02em, 2.815em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4225\"><span class=\"msubsup\" id=\"MathJax-Span-4226\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4227\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4228\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4229\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4230\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4231\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4232\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-4233\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-4234\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-4235\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.58em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.576em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-4236\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4237\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-4238\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.326em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4239\"><span class=\"mrow\" id=\"MathJax-Span-4240\"><span class=\"mi\" id=\"MathJax-Span-4241\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4242\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4243\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4244\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 6.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.919em, 1005.89em, 4.586em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4245\"><span class=\"mo\" id=\"MathJax-Span-4246\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">(</span></span></span><span class=\"mrow\" id=\"MathJax-Span-4247\"><span class=\"mi\" id=\"MathJax-Span-4248\" style=\"font-family: STIXGeneral-Regular;\">log</span><span class=\"mo\" id=\"MathJax-Span-4249\"></span><span class=\"munderover\" id=\"MathJax-Span-4250\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4251\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-4252\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.15em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4253\"><span class=\"mrow\" id=\"MathJax-Span-4254\"><span class=\"mi\" id=\"MathJax-Span-4255\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4256\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4257\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4258\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4259\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-4260\"><span class=\"mrow\" id=\"MathJax-Span-4261\"><span class=\"msubsup\" id=\"MathJax-Span-4262\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4263\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"texatom\" id=\"MathJax-Span-4264\"><span class=\"mrow\" id=\"MathJax-Span-4265\"><span class=\"mi\" id=\"MathJax-Span-4266\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4267\" style=\"font-size: 50%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4268\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4269\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">)</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.685em; left: 6.044em;\"><span class=\"mn\" id=\"MathJax-Span-4270\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.622em; border-left: 0px solid; width: 0px; height: 2.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msup><mrow><mo>(</mo><mrow><mi>log</mi><mo>⁡</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>x</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mrow></msup></mrow><mo>)</mo></mrow><mn>2</mn></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-512\">L_z(x) = \\frac{1}{T} \\sum_{j=1}^T \\left(\\log \\sum_{t=1}^N e^{x_{i,t}} \\right)^2</script></li>\n          <li>Total training loss:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-513-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mtext>model</mtext></msub><mo>+</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoA modules</mtext></mrow></munder><mrow><mo>(</mo><mrow><mi>&amp;#x03B1;</mi><msub><mi>L</mi><mi>a</mi></msub><mo>+</mo><mi>&amp;#x03B2;</mi><msub><mi>L</mi><mi>z</mi></msub></mrow><mo>)</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4271\" style=\"width: 18.44em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 15.367em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1015.32em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4272\"><span class=\"mi\" id=\"MathJax-Span-4273\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4274\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-4275\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.398em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4276\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mtext\" id=\"MathJax-Span-4277\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">model</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4278\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"munderover\" id=\"MathJax-Span-4279\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 5.055em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4280\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4281\"><span class=\"mrow\" id=\"MathJax-Span-4282\"><span class=\"mtext\" id=\"MathJax-Span-4283\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoA modules</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mrow\" id=\"MathJax-Span-4284\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-4285\" style=\"vertical-align: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">(</span></span><span class=\"mrow\" id=\"MathJax-Span-4286\"><span class=\"mi\" id=\"MathJax-Span-4287\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"msubsup\" id=\"MathJax-Span-4288\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4289\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4290\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4291\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-4292\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4293\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4294\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4295\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4296\" style=\"vertical-align: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">)</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mtext>model</mtext></msub><mo>+</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoA modules</mtext></mrow></munder><mrow><mo>(</mo><mrow><mi>α</mi><msub><mi>L</mi><mi>a</mi></msub><mo>+</mo><mi>β</mi><msub><mi>L</mi><mi>z</mi></msub></mrow><mo>)</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-513\">L = L_\\text{model} + \\sum_{\\text{MoA modules}} \\left(\\alpha L_a + \\beta L_z\\right)</script>\n            <ul>\n              <li>with default hyperparameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-514-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4297\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.44em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4298\"><span class=\"mi\" id=\"MathJax-Span-4299\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-4300\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4301\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-514\">\\alpha = 0.01</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-515-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B2;</mi><mo>=</mo><mn>0.001</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4302\" style=\"width: 4.846em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.91em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4303\"><span class=\"mi\" id=\"MathJax-Span-4304\" style=\"font-family: STIXGeneral-Italic;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4305\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4306\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.001</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>β</mi><mo>=</mo><mn>0.001</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-515\">\\beta = 0.001</script>.</li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Efficiency</strong>:</p>\n\n        <ul>\n          <li>MoA can scale to more attention heads with only modest increases in memory/computation.</li>\n          <li>Computation and parameter complexity are reduced relative to standard MHA when <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-516-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>d</mi><mi>h</mi></msub><mo>&amp;#x2248;</mo><msub><mi>d</mi><mi>m</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4307\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.7em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4308\"><span class=\"mi\" id=\"MathJax-Span-4309\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4310\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4311\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4312\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4313\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"msubsup\" id=\"MathJax-Span-4314\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4315\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4316\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">m</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><msub><mi>d</mi><mi>h</mi></msub><mo>≈</mo><msub><mi>d</mi><mi>m</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-516\">k d_h \\approx d_m</script>.</li>\n        </ul>\n      </li>\n      <li>\n        <p>The following figure from the paper shows the MoA architecture: attention heads are grouped as experts, each token routes to a top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-517-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4317\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4318\"><span class=\"mi\" id=\"MathJax-Span-4319\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-517\">k</script> subset, and final outputs are a weighted sum of selected experts’ outputs.</p>\n      </li>\n    </ul>\n\n    <p><img src=\"../../../images/papers/MoA.jpg\" alt=\"\"></p>\n  </li>\n  <li>\n    <p><strong>Experimental Results</strong>:</p>\n\n    <ul>\n      <li>\n        <p><strong>Machine Translation</strong>:</p>\n\n        <ul>\n          <li>Benchmarked on WMT14 En-De and En-Fr with BLEU scores.</li>\n          <li>MoA-base (8K8E128D) outperforms Transformer-base (28.4 vs. 27.3 BLEU) and matches or beats deeper models with less computation.</li>\n          <li>MoA-big (16K32E256D) achieves near-SOTA with fewer MACs (e.g., 43.7 BLEU vs. Admin-60L-12L’s 43.8, but with less than half the MACs).</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Masked Language Modeling</strong>:</p>\n\n        <ul>\n          <li>Evaluated on WikiText-103 using perplexity (PPL).</li>\n          <li>MoA models consistently outperform standard Transformers, with performance improving as number of experts and head dimensions increase, while keeping computational cost nearly fixed.</li>\n        </ul>\n      </li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Interpretability and Analysis</strong>:</p>\n\n    <ul>\n      <li>MoA allows analysis of <strong>expert load balancing</strong>—experts receive diverse token subsets, with usage roughly balanced.</li>\n      <li>Specialization emerges among experts; PMI analysis reveals certain experts correlate strongly with specific semantic classes (e.g., locations, tech terms, names), indicating improved model interpretability.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Implementation Details</strong>:</p>\n\n    <ul>\n      <li>Uses pre-computed shared <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-518-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi><mo>,</mo><mi>V</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4320\" style=\"width: 2.451em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.03em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4321\"><span class=\"mi\" id=\"MathJax-Span-4322\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4323\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4324\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi><mo>,</mo><mi>V</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-518\">K, V</script> projections for all experts.</li>\n      <li>Trained with Adam optimizer and inverse square root scheduler.</li>\n      <li>Evaluated using standard benchmarks and MACs (Multiply–Accumulate Operations) for computational cost.</li>\n    </ul>\n  </li>\n  <li>\n    <p><strong>Scalability and Efficiency</strong>:</p>\n\n    <ul>\n      <li>MoA is highly scalable in terms of the number of experts without proportionally increasing compute.</li>\n      <li>Ablation studies confirm the value of auxiliary losses for load balancing and performance.</li>\n      <li>Despite low theoretical compute, implementation needs CUDA-level optimization for faster wall-clock execution.</li>\n    </ul>\n  </li>\n  <li>\n    <p><a href=\"https://github.com/yikangshen/MoA\">Code</a></p>\n  </li>\n</ul>\n<p>This paper by Zhang et al. from Beihang University, Mila, and Tencent introduces the <strong>Mixture of Attention Heads (MoA)</strong>, a novel attention mechanism that integrates the MoE framework into the multi-head attention (MHA) component of Transformer architectures. While previous MoE work mainly focused on feedforward layers, MoA innovatively applies conditional computation to attention heads, allowing different tokens to dynamically select specialized attention heads, thereby improving performance and computational efficiency.</p>\n<p><strong>Core Architecture and Computation</strong>:</p>\n<ul>\n      <li>\n        <p><strong>Model Composition</strong>: MoA replaces the standard MHA with a structure containing:</p>\n\n        <ul>\n          <li>A <strong>routing network</strong> that assigns confidence scores to each attention head (called attention experts).</li>\n          <li>A <strong>set of attention experts</strong>, each with its own query and output projection weights but shared key and value projections to reduce redundancy.</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Token-specific Selection</strong>: For each input token, the routing network selects the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-499-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4061\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4062\"><span class=\"mi\" id=\"MathJax-Span-4063\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-499\">k</script> attention experts based on softmax-normalized scores derived from a linear projection of the query. The selected heads’ outputs are weighted by their routing confidence and summed to produce the token-level output:</p>\n\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><div class=\"MathJax_Display\" style=\"text-align: center;\"><span class=\"MathJax\" id=\"MathJax-Element-500-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>y</mi><mi>t</mi></msub><mo>=</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>&amp;#x2208;</mo><mi>G</mi><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo stretchy=&quot;false&quot;>)</mo></mrow></munder><msub><mi>w</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>&amp;#x22C5;</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=&quot;false&quot;>)</mo></math>\" role=\"presentation\" style=\"text-align: center; position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4064\" style=\"width: 13.753em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 11.461em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.096em, 1011.41em, 3.805em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4065\"><span class=\"msubsup\" id=\"MathJax-Span-4066\"><span style=\"display: inline-block; position: relative; width: 0.732em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4067\" style=\"font-family: STIXGeneral-Italic;\">y</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.471em;\"><span class=\"mi\" id=\"MathJax-Span-4068\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4069\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"munderover\" id=\"MathJax-Span-4070\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.242em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.867em, 1001.2em, 4.638em, -999.997em); top: -4.008em; left: 0.471em;\"><span class=\"mo\" id=\"MathJax-Span-4071\" style=\"font-family: STIXSizeOneSym; vertical-align: -0.518em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1002.19em, 4.43em, -999.997em); top: -2.862em; left: 0em;\"><span class=\"texatom\" id=\"MathJax-Span-4072\"><span class=\"mrow\" id=\"MathJax-Span-4073\"><span class=\"mi\" id=\"MathJax-Span-4074\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4075\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">∈</span><span class=\"mi\" id=\"MathJax-Span-4076\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">G</span><span class=\"mo\" id=\"MathJax-Span-4077\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4078\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.37em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4079\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4080\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4081\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4082\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4083\" style=\"font-family: STIXGeneral-Italic;\">w</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.68em;\"><span class=\"texatom\" id=\"MathJax-Span-4084\"><span class=\"mrow\" id=\"MathJax-Span-4085\"><span class=\"mi\" id=\"MathJax-Span-4086\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4087\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4088\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4089\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4090\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4091\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4092\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4093\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4094\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4095\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4096\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4097\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4098\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4099\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4100\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4101\" style=\"font-family: STIXGeneral-Regular;\">)</span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -1.747em; border-left: 0px solid; width: 0px; height: 3.003em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML MJX_Assistive_MathML_Block\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><msub><mi>y</mi><mi>t</mi></msub><mo>=</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>∈</mo><mi>G</mi><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo stretchy=\"false\">)</mo></mrow></munder><msub><mi>w</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>⋅</mo><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=\"false\">)</mo></math></span></span></div><script type=\"math/tex; mode=display\" id=\"MathJax-Element-500\">y_t = \\sum_{i \\in G(q_t)} w_{i,t} \\cdot E_i(q_t, K, V)</script>\n      </li>\n      <li>\n        <p><strong>Expert Attention Computation</strong>:</p>\n\n        <ul>\n          <li>Each expert performs scaled dot-product attention using its own <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-501-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4102\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1001.41em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4103\"><span class=\"msubsup\" id=\"MathJax-Span-4104\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4105\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.326em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4106\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4107\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.441em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-501\">W^q_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-502-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4108\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.41em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4109\"><span class=\"msubsup\" id=\"MathJax-Span-4110\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4111\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4112\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4113\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-502\">W^o_i</script>, while sharing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-503-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>W</mi><mi>k</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4114\" style=\"width: 1.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.36em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4115\"><span class=\"msubsup\" id=\"MathJax-Span-4116\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4117\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4118\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>W</mi><mi>k</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-503\">W^k</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-504-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>W</mi><mi>v</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4119\" style=\"width: 1.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.36em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4120\"><span class=\"msubsup\" id=\"MathJax-Span-4121\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4122\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4123\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>W</mi><mi>v</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-504\">W^v</script> across all experts.</li>\n          <li>Output per expert:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-505-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>Softmax</mtext><mrow><mo>(</mo><mfrac><mrow><msub><mi>q</mi><mi>t</mi></msub><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>K</mi><msup><mi>W</mi><mi>k</mi></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><msup><mi>W</mi><mi>v</mi></msup><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4124\" style=\"width: 22.607em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 18.805em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.086em, 1018.8em, 4.43em, -999.997em); top: -3.487em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4125\"><span class=\"msubsup\" id=\"MathJax-Span-4126\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4127\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4128\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4129\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4130\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4131\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4132\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4133\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4134\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4135\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4136\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4137\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4138\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-4139\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">Softmax</span><span class=\"mrow\" id=\"MathJax-Span-4140\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-4141\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">(</span></span><span class=\"mfrac\" id=\"MathJax-Span-4142\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.232em, 1003.91em, 4.378em, -999.997em); top: -4.633em; left: 50%; margin-left: -1.924em;\"><span class=\"mrow\" id=\"MathJax-Span-4143\"><span class=\"msubsup\" id=\"MathJax-Span-4144\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.37em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4145\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4146\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4147\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4148\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.648em, 1000.32em, 4.273em, -999.997em); top: -4.372em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-4149\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.21em, 4.169em, -999.997em); top: -3.799em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4150\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4151\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4152\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4153\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4154\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-4155\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4156\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.21em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4157\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4158\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.232em, 1001.3em, 4.43em, -999.997em); top: -3.487em; left: 50%; margin-left: -0.674em;\"><span class=\"msqrt\" id=\"MathJax-Span-4159\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.68em, 4.273em, -999.997em); top: -4.008em; left: 0.68em;\"><span class=\"mrow\" id=\"MathJax-Span-4160\"><span class=\"msubsup\" id=\"MathJax-Span-4161\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4162\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4163\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.94em, 1000.68em, 1.253em, -999.997em); top: -1.664em; left: 0.68em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.049em; border-top: 1.2px solid; width: 0.68em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.378em, -999.997em); top: -3.956em; left: 0em;\"><span><span style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">√</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1004.01em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 4.013em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4164\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">)</span></span></span><span class=\"mi\" id=\"MathJax-Span-4165\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4166\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4167\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4168\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4169\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4170\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4171\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4172\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.492em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.997em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>Softmax</mtext><mrow><mo>(</mo><mfrac><mrow><msub><mi>q</mi><mi>t</mi></msub><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup><mo stretchy=\"false\">(</mo><mi>K</mi><msup><mi>W</mi><mi>k</mi></msup><msup><mo stretchy=\"false\">)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><msup><mi>W</mi><mi>v</mi></msup><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-505\">E_i(q_t, K, V) = \\text{Softmax}\\left(\\frac{q_t W^q_i (K W^k)^T}{\\sqrt{d_h}}\\right) V W^v W^o_i</script></li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Training Losses</strong>:</p>\n\n        <ul>\n          <li><strong>Auxiliary Load Balancing Loss</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-506-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>a</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4173\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4174\"><span class=\"msubsup\" id=\"MathJax-Span-4175\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4176\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4177\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>a</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-506\">L_a</script> to promote expert usage diversity:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-507-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>a</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>Q</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>N</mi><mo>&amp;#x22C5;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x22C5;</mo><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4178\" style=\"width: 12.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.003em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4179\"><span class=\"msubsup\" id=\"MathJax-Span-4180\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4181\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4182\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4183\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4184\" style=\"font-family: STIXGeneral-Italic;\">Q</span><span class=\"mo\" id=\"MathJax-Span-4185\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4186\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-4187\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4188\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"munderover\" id=\"MathJax-Span-4189\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4190\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4191\"><span class=\"mrow\" id=\"MathJax-Span-4192\"><span class=\"mi\" id=\"MathJax-Span-4193\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4194\"><span class=\"mrow\" id=\"MathJax-Span-4195\"><span class=\"mi\" id=\"MathJax-Span-4196\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4197\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4198\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4199\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4200\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4201\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4202\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4203\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4204\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4205\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>a</mi></msub><mo stretchy=\"false\">(</mo><mi>Q</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>N</mi><mo>⋅</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-507\">L_a(Q) = N \\cdot \\sum_{i=1}^{N} f_i \\cdot P_i</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-508-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4206\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4207\"><span class=\"msubsup\" id=\"MathJax-Span-4208\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4209\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4210\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-508\">f_i</script> counts token assignments and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-509-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4211\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4212\"><span class=\"msubsup\" id=\"MathJax-Span-4213\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4214\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4215\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-509\">P_i</script> is the aggregated routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-510-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4216\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4217\"><span class=\"mi\" id=\"MathJax-Span-4218\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-510\">i</script>.</li>\n            </ul>\n          </li>\n          <li><strong>Router Z-loss</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-511-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4219\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4220\"><span class=\"msubsup\" id=\"MathJax-Span-4221\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4222\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4223\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-511\">L_z</script> stabilizes training by penalizing large pre-softmax logits:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-512-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msup><mrow><mo>(</mo><mrow><mi>log</mi><mo>&amp;#x2061;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mrow></msup></mrow><mo>)</mo></mrow><mn>2</mn></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4224\" style=\"width: 15.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.023em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.888em, 1013.02em, 2.815em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4225\"><span class=\"msubsup\" id=\"MathJax-Span-4226\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4227\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4228\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4229\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4230\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4231\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4232\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-4233\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-4234\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-4235\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.58em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.576em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-4236\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4237\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-4238\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.326em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4239\"><span class=\"mrow\" id=\"MathJax-Span-4240\"><span class=\"mi\" id=\"MathJax-Span-4241\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4242\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4243\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4244\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 6.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.919em, 1005.89em, 4.586em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4245\"><span class=\"mo\" id=\"MathJax-Span-4246\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">(</span></span></span><span class=\"mrow\" id=\"MathJax-Span-4247\"><span class=\"mi\" id=\"MathJax-Span-4248\" style=\"font-family: STIXGeneral-Regular;\">log</span><span class=\"mo\" id=\"MathJax-Span-4249\"></span><span class=\"munderover\" id=\"MathJax-Span-4250\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4251\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-4252\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.15em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4253\"><span class=\"mrow\" id=\"MathJax-Span-4254\"><span class=\"mi\" id=\"MathJax-Span-4255\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4256\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4257\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4258\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4259\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-4260\"><span class=\"mrow\" id=\"MathJax-Span-4261\"><span class=\"msubsup\" id=\"MathJax-Span-4262\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4263\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"texatom\" id=\"MathJax-Span-4264\"><span class=\"mrow\" id=\"MathJax-Span-4265\"><span class=\"mi\" id=\"MathJax-Span-4266\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4267\" style=\"font-size: 50%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4268\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4269\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">)</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.685em; left: 6.044em;\"><span class=\"mn\" id=\"MathJax-Span-4270\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.622em; border-left: 0px solid; width: 0px; height: 2.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msup><mrow><mo>(</mo><mrow><mi>log</mi><mo>⁡</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>x</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mrow></msup></mrow><mo>)</mo></mrow><mn>2</mn></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-512\">L_z(x) = \\frac{1}{T} \\sum_{j=1}^T \\left(\\log \\sum_{t=1}^N e^{x_{i,t}} \\right)^2</script></li>\n          <li>Total training loss:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-513-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mtext>model</mtext></msub><mo>+</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoA modules</mtext></mrow></munder><mrow><mo>(</mo><mrow><mi>&amp;#x03B1;</mi><msub><mi>L</mi><mi>a</mi></msub><mo>+</mo><mi>&amp;#x03B2;</mi><msub><mi>L</mi><mi>z</mi></msub></mrow><mo>)</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4271\" style=\"width: 18.44em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 15.367em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1015.32em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4272\"><span class=\"mi\" id=\"MathJax-Span-4273\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4274\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-4275\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.398em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4276\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mtext\" id=\"MathJax-Span-4277\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">model</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4278\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"munderover\" id=\"MathJax-Span-4279\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 5.055em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4280\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4281\"><span class=\"mrow\" id=\"MathJax-Span-4282\"><span class=\"mtext\" id=\"MathJax-Span-4283\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoA modules</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mrow\" id=\"MathJax-Span-4284\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-4285\" style=\"vertical-align: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">(</span></span><span class=\"mrow\" id=\"MathJax-Span-4286\"><span class=\"mi\" id=\"MathJax-Span-4287\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"msubsup\" id=\"MathJax-Span-4288\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4289\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4290\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4291\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-4292\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4293\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4294\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4295\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4296\" style=\"vertical-align: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">)</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mtext>model</mtext></msub><mo>+</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoA modules</mtext></mrow></munder><mrow><mo>(</mo><mrow><mi>α</mi><msub><mi>L</mi><mi>a</mi></msub><mo>+</mo><mi>β</mi><msub><mi>L</mi><mi>z</mi></msub></mrow><mo>)</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-513\">L = L_\\text{model} + \\sum_{\\text{MoA modules}} \\left(\\alpha L_a + \\beta L_z\\right)</script>\n            <ul>\n              <li>with default hyperparameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-514-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4297\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.44em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4298\"><span class=\"mi\" id=\"MathJax-Span-4299\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-4300\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4301\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-514\">\\alpha = 0.01</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-515-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B2;</mi><mo>=</mo><mn>0.001</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4302\" style=\"width: 4.846em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.91em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4303\"><span class=\"mi\" id=\"MathJax-Span-4304\" style=\"font-family: STIXGeneral-Italic;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4305\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4306\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.001</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>β</mi><mo>=</mo><mn>0.001</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-515\">\\beta = 0.001</script>.</li>\n            </ul>\n          </li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Efficiency</strong>:</p>\n\n        <ul>\n          <li>MoA can scale to more attention heads with only modest increases in memory/computation.</li>\n          <li>Computation and parameter complexity are reduced relative to standard MHA when <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-516-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>d</mi><mi>h</mi></msub><mo>&amp;#x2248;</mo><msub><mi>d</mi><mi>m</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4307\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.7em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4308\"><span class=\"mi\" id=\"MathJax-Span-4309\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4310\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4311\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4312\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4313\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"msubsup\" id=\"MathJax-Span-4314\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4315\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4316\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">m</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><msub><mi>d</mi><mi>h</mi></msub><mo>≈</mo><msub><mi>d</mi><mi>m</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-516\">k d_h \\approx d_m</script>.</li>\n        </ul>\n      </li>\n      <li>\n        <p>The following figure from the paper shows the MoA architecture: attention heads are grouped as experts, each token routes to a top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-517-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4317\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4318\"><span class=\"mi\" id=\"MathJax-Span-4319\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-517\">k</script> subset, and final outputs are a weighted sum of selected experts’ outputs.</p>\n      </li>\n    </ul>\n<p><strong>Model Composition</strong>: MoA replaces the standard MHA with a structure containing:</p>\n<ul>\n          <li>A <strong>routing network</strong> that assigns confidence scores to each attention head (called attention experts).</li>\n          <li>A <strong>set of attention experts</strong>, each with its own query and output projection weights but shared key and value projections to reduce redundancy.</li>\n        </ul>\n<p><strong>Token-specific Selection</strong>: For each input token, the routing network selects the top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-499-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4061\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4062\"><span class=\"mi\" id=\"MathJax-Span-4063\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-499\">k</script> attention experts based on softmax-normalized scores derived from a linear projection of the query. The selected heads’ outputs are weighted by their routing confidence and summed to produce the token-level output:</p>\n<p><strong>Expert Attention Computation</strong>:</p>\n<ul>\n          <li>Each expert performs scaled dot-product attention using its own <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-501-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4102\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.201em, 1001.41em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4103\"><span class=\"msubsup\" id=\"MathJax-Span-4104\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4105\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.326em, -999.997em); top: -4.477em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4106\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4107\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.441em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-501\">W^q_i</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-502-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4108\" style=\"width: 1.721em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.41em, 2.607em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4109\"><span class=\"msubsup\" id=\"MathJax-Span-4110\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4111\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4112\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4113\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.316em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-502\">W^o_i</script>, while sharing <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-503-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>W</mi><mi>k</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4114\" style=\"width: 1.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1001.36em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4115\"><span class=\"msubsup\" id=\"MathJax-Span-4116\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4117\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4118\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>W</mi><mi>k</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-503\">W^k</script> and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-504-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>W</mi><mi>v</mi></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4119\" style=\"width: 1.669em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1001.36em, 2.294em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4120\"><span class=\"msubsup\" id=\"MathJax-Span-4121\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4122\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4123\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msup><mi>W</mi><mi>v</mi></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-504\">W^v</script> across all experts.</li>\n          <li>Output per expert:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-505-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mtext>Softmax</mtext><mrow><mo>(</mo><mfrac><mrow><msub><mi>q</mi><mi>t</mi></msub><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup><mo stretchy=&quot;false&quot;>(</mo><mi>K</mi><msup><mi>W</mi><mi>k</mi></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><msup><mi>W</mi><mi>v</mi></msup><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4124\" style=\"width: 22.607em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 18.805em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(2.086em, 1018.8em, 4.43em, -999.997em); top: -3.487em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4125\"><span class=\"msubsup\" id=\"MathJax-Span-4126\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4127\" style=\"font-family: STIXGeneral-Italic;\">E<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4128\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4129\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"msubsup\" id=\"MathJax-Span-4130\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.47em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4131\" style=\"font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4132\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4133\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4134\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4135\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4136\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4137\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4138\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mtext\" id=\"MathJax-Span-4139\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">Softmax</span><span class=\"mrow\" id=\"MathJax-Span-4140\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-4141\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">(</span></span><span class=\"mfrac\" id=\"MathJax-Span-4142\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.232em, 1003.91em, 4.378em, -999.997em); top: -4.633em; left: 50%; margin-left: -1.924em;\"><span class=\"mrow\" id=\"MathJax-Span-4143\"><span class=\"msubsup\" id=\"MathJax-Span-4144\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.37em, 4.326em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4145\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4146\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4147\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4148\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.648em, 1000.32em, 4.273em, -999.997em); top: -4.372em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-4149\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">q</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.21em, 4.169em, -999.997em); top: -3.799em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4150\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4151\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4152\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4153\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4154\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.732em;\"><span class=\"mi\" id=\"MathJax-Span-4155\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4156\"><span style=\"display: inline-block; position: relative; width: 0.628em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.21em, 4.273em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4157\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">)</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.268em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4158\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.232em, 1001.3em, 4.43em, -999.997em); top: -3.487em; left: 50%; margin-left: -0.674em;\"><span class=\"msqrt\" id=\"MathJax-Span-4159\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.68em, 4.273em, -999.997em); top: -4.008em; left: 0.68em;\"><span class=\"mrow\" id=\"MathJax-Span-4160\"><span class=\"msubsup\" id=\"MathJax-Span-4161\"><span style=\"display: inline-block; position: relative; width: 0.68em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.37em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4162\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.367em;\"><span class=\"mi\" id=\"MathJax-Span-4163\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.94em, 1000.68em, 1.253em, -999.997em); top: -1.664em; left: 0.68em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.049em; border-top: 1.2px solid; width: 0.68em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span><span style=\"position: absolute; clip: rect(3.18em, 1000.68em, 4.378em, -999.997em); top: -3.956em; left: 0em;\"><span><span style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">√</span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1004.01em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 4.013em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4164\" style=\"vertical-align: -0.414em;\"><span style=\"font-family: STIXSizeTwoSym;\">)</span></span></span><span class=\"mi\" id=\"MathJax-Span-4165\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4166\"><span style=\"display: inline-block; position: relative; width: 1.357em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4167\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4168\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">v</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4169\"><span style=\"display: inline-block; position: relative; width: 1.409em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.89em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4170\" style=\"font-family: STIXGeneral-Italic;\">W<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.544em, 1000.42em, 4.169em, -999.997em); top: -4.372em; left: 0.992em;\"><span class=\"mi\" id=\"MathJax-Span-4171\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">o</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -3.695em; left: 0.836em;\"><span class=\"mi\" id=\"MathJax-Span-4172\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 3.492em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.997em; border-left: 0px solid; width: 0px; height: 2.566em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>E</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>t</mi></msub><mo>,</mo><mi>K</mi><mo>,</mo><mi>V</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>Softmax</mtext><mrow><mo>(</mo><mfrac><mrow><msub><mi>q</mi><mi>t</mi></msub><msubsup><mi>W</mi><mi>i</mi><mi>q</mi></msubsup><mo stretchy=\"false\">(</mo><mi>K</mi><msup><mi>W</mi><mi>k</mi></msup><msup><mo stretchy=\"false\">)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo>)</mo></mrow><mi>V</mi><msup><mi>W</mi><mi>v</mi></msup><msubsup><mi>W</mi><mi>i</mi><mi>o</mi></msubsup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-505\">E_i(q_t, K, V) = \\text{Softmax}\\left(\\frac{q_t W^q_i (K W^k)^T}{\\sqrt{d_h}}\\right) V W^v W^o_i</script></li>\n        </ul>\n<p><strong>Training Losses</strong>:</p>\n<ul>\n          <li><strong>Auxiliary Load Balancing Loss</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-506-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>a</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4173\" style=\"width: 1.201em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.99em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4174\"><span class=\"msubsup\" id=\"MathJax-Span-4175\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4176\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4177\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>a</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-506\">L_a</script> to promote expert usage diversity:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-507-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>a</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>Q</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>N</mi><mo>&amp;#x22C5;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><mo>&amp;#x22C5;</mo><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4178\" style=\"width: 12.034em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 10.003em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.148em, 1010em, 2.711em, -999.997em); top: -2.237em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4179\"><span class=\"msubsup\" id=\"MathJax-Span-4180\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4181\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4182\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4183\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4184\" style=\"font-family: STIXGeneral-Italic;\">Q</span><span class=\"mo\" id=\"MathJax-Span-4185\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4186\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mi\" id=\"MathJax-Span-4187\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.315em;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4188\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"munderover\" id=\"MathJax-Span-4189\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4190\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4191\"><span class=\"mrow\" id=\"MathJax-Span-4192\"><span class=\"mi\" id=\"MathJax-Span-4193\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4194\"><span class=\"mrow\" id=\"MathJax-Span-4195\"><span class=\"mi\" id=\"MathJax-Span-4196\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4197\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4198\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4199\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4200\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4201\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4202\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">⋅</span><span class=\"msubsup\" id=\"MathJax-Span-4203\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4204\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4205\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.242em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.628em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>a</mi></msub><mo stretchy=\"false\">(</mo><mi>Q</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>N</mi><mo>⋅</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow class=\"MJX-TeXAtom-ORD\"><mi>N</mi></mrow></munderover><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-507\">L_a(Q) = N \\cdot \\sum_{i=1}^{N} f_i \\cdot P_i</script>\n            <ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-508-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4206\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4207\"><span class=\"msubsup\" id=\"MathJax-Span-4208\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4209\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4210\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-508\">f_i</script> counts token assignments and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-509-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4211\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4212\"><span class=\"msubsup\" id=\"MathJax-Span-4213\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4214\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4215\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-509\">P_i</script> is the aggregated routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-510-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4216\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4217\"><span class=\"mi\" id=\"MathJax-Span-4218\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-510\">i</script>.</li>\n            </ul>\n          </li>\n          <li><strong>Router Z-loss</strong> <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-511-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4219\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4220\"><span class=\"msubsup\" id=\"MathJax-Span-4221\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4222\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4223\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-511\">L_z</script> stabilizes training by penalizing large pre-softmax logits:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-512-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>L</mi><mi>z</mi></msub><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msup><mrow><mo>(</mo><mrow><mi>log</mi><mo>&amp;#x2061;</mo><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mrow></msup></mrow><mo>)</mo></mrow><mn>2</mn></msup></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4224\" style=\"width: 15.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 13.023em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(0.888em, 1013.02em, 2.815em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4225\"><span class=\"msubsup\" id=\"MathJax-Span-4226\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4227\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4228\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4229\" style=\"font-family: STIXGeneral-Regular;\">(</span><span class=\"mi\" id=\"MathJax-Span-4230\" style=\"font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4231\" style=\"font-family: STIXGeneral-Regular;\">)</span><span class=\"mo\" id=\"MathJax-Span-4232\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mfrac\" id=\"MathJax-Span-4233\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; margin-right: 0.107em; margin-left: 0.107em;\"><span style=\"position: absolute; clip: rect(3.388em, 1000.26em, 4.169em, -999.997em); top: -4.424em; left: 50%; margin-left: -0.154em;\"><span class=\"mn\" id=\"MathJax-Span-4234\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.47em, 4.169em, -999.997em); top: -3.643em; left: 50%; margin-left: -0.206em;\"><span class=\"mi\" id=\"MathJax-Span-4235\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(0.836em, 1000.58em, 1.201em, -999.997em); top: -1.247em; left: 0em;\"><span style=\"display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 0.576em; height: 0px;\"></span><span style=\"display: inline-block; width: 0px; height: 1.044em;\"></span></span></span></span><span class=\"munderover\" id=\"MathJax-Span-4236\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4237\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.52em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-4238\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">T<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.1em, 4.326em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4239\"><span class=\"mrow\" id=\"MathJax-Span-4240\"><span class=\"mi\" id=\"MathJax-Span-4241\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">j<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4242\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4243\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4244\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 6.513em; height: 0px;\"><span style=\"position: absolute; clip: rect(2.919em, 1005.89em, 4.586em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4245\"><span class=\"mo\" id=\"MathJax-Span-4246\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">(</span></span></span><span class=\"mrow\" id=\"MathJax-Span-4247\"><span class=\"mi\" id=\"MathJax-Span-4248\" style=\"font-family: STIXGeneral-Regular;\">log</span><span class=\"mo\" id=\"MathJax-Span-4249\"></span><span class=\"munderover\" id=\"MathJax-Span-4250\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4251\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1000.58em, 4.169em, -999.997em); top: -4.477em; left: 0.94em;\"><span class=\"mi\" id=\"MathJax-Span-4252\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">N<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; clip: rect(3.388em, 1001.15em, 4.169em, -999.997em); top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4253\"><span class=\"mrow\" id=\"MathJax-Span-4254\"><span class=\"mi\" id=\"MathJax-Span-4255\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4256\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">=</span><span class=\"mn\" id=\"MathJax-Span-4257\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">1</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"msubsup\" id=\"MathJax-Span-4258\" style=\"padding-left: 0.211em;\"><span style=\"display: inline-block; position: relative; width: 1.305em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.44em, 1000.42em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4259\" style=\"font-family: STIXGeneral-Italic;\">e</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.372em; left: 0.471em;\"><span class=\"texatom\" id=\"MathJax-Span-4260\"><span class=\"mrow\" id=\"MathJax-Span-4261\"><span class=\"msubsup\" id=\"MathJax-Span-4262\"><span style=\"display: inline-block; position: relative; width: 0.784em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.544em, 1000.32em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4263\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">x<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.904em; left: 0.315em;\"><span class=\"texatom\" id=\"MathJax-Span-4264\"><span class=\"mrow\" id=\"MathJax-Span-4265\"><span class=\"mi\" id=\"MathJax-Span-4266\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">i</span><span class=\"mo\" id=\"MathJax-Span-4267\" style=\"font-size: 50%; font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4268\" style=\"font-size: 50%; font-family: STIXGeneral-Italic;\">t<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4269\" style=\"vertical-align: -0.258em;\"><span><span style=\"font-size: 110%; font-family: STIXSizeOneSym;\">)</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -4.685em; left: 6.044em;\"><span class=\"mn\" id=\"MathJax-Span-4270\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">2</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.622em; border-left: 0px solid; width: 0px; height: 2.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>L</mi><mi>z</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><msup><mrow><mo>(</mo><mrow><mi>log</mi><mo>⁡</mo><munderover><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msup><mi>e</mi><mrow class=\"MJX-TeXAtom-ORD\"><msub><mi>x</mi><mrow class=\"MJX-TeXAtom-ORD\"><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mrow></msup></mrow><mo>)</mo></mrow><mn>2</mn></msup></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-512\">L_z(x) = \\frac{1}{T} \\sum_{j=1}^T \\left(\\log \\sum_{t=1}^N e^{x_{i,t}} \\right)^2</script></li>\n          <li>Total training loss:\n<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-513-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>L</mi><mo>=</mo><msub><mi>L</mi><mtext>model</mtext></msub><mo>+</mo><munder><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mtext>MoA modules</mtext></mrow></munder><mrow><mo>(</mo><mrow><mi>&amp;#x03B1;</mi><msub><mi>L</mi><mi>a</mi></msub><mo>+</mo><mi>&amp;#x03B2;</mi><msub><mi>L</mi><mi>z</mi></msub></mrow><mo>)</mo></mrow></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4271\" style=\"width: 18.44em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 15.367em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.253em, 1015.32em, 2.659em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4272\"><span class=\"mi\" id=\"MathJax-Span-4273\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4274\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"msubsup\" id=\"MathJax-Span-4275\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 2.398em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4276\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mtext\" id=\"MathJax-Span-4277\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">model</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4278\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"munderover\" id=\"MathJax-Span-4279\" style=\"padding-left: 0.263em;\"><span style=\"display: inline-block; position: relative; width: 5.055em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.076em, 1000.84em, 4.43em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mo\" id=\"MathJax-Span-4280\" style=\"font-family: STIXGeneral-Regular; vertical-align: 0.003em;\">∑</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.695em; left: 0.94em;\"><span class=\"texatom\" id=\"MathJax-Span-4281\"><span class=\"mrow\" id=\"MathJax-Span-4282\"><span class=\"mtext\" id=\"MathJax-Span-4283\" style=\"font-size: 70.7%; font-family: STIXGeneral-Regular;\">MoA modules</span></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mrow\" id=\"MathJax-Span-4284\" style=\"padding-left: 0.211em;\"><span class=\"mo\" id=\"MathJax-Span-4285\" style=\"vertical-align: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">(</span></span><span class=\"mrow\" id=\"MathJax-Span-4286\"><span class=\"mi\" id=\"MathJax-Span-4287\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"msubsup\" id=\"MathJax-Span-4288\"><span style=\"display: inline-block; position: relative; width: 0.992em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4289\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4290\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">a</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4291\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.263em;\">+</span><span class=\"mi\" id=\"MathJax-Span-4292\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.263em;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4293\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.58em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4294\" style=\"font-family: STIXGeneral-Italic;\">L<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.576em;\"><span class=\"mi\" id=\"MathJax-Span-4295\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">z</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4296\" style=\"vertical-align: 0em;\"><span style=\"font-family: STIXGeneral-Regular;\">)</span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>L</mi><mo>=</mo><msub><mi>L</mi><mtext>model</mtext></msub><mo>+</mo><munder><mo>∑</mo><mrow class=\"MJX-TeXAtom-ORD\"><mtext>MoA modules</mtext></mrow></munder><mrow><mo>(</mo><mrow><mi>α</mi><msub><mi>L</mi><mi>a</mi></msub><mo>+</mo><mi>β</mi><msub><mi>L</mi><mi>z</mi></msub></mrow><mo>)</mo></mrow></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-513\">L = L_\\text{model} + \\sum_{\\text{MoA modules}} \\left(\\alpha L_a + \\beta L_z\\right)</script>\n            <ul>\n              <li>with default hyperparameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-514-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4297\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.44em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4298\"><span class=\"mi\" id=\"MathJax-Span-4299\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-4300\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4301\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-514\">\\alpha = 0.01</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-515-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B2;</mi><mo>=</mo><mn>0.001</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4302\" style=\"width: 4.846em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.91em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4303\"><span class=\"mi\" id=\"MathJax-Span-4304\" style=\"font-family: STIXGeneral-Italic;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4305\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4306\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.001</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>β</mi><mo>=</mo><mn>0.001</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-515\">\\beta = 0.001</script>.</li>\n            </ul>\n          </li>\n        </ul>\n<ul>\n              <li>where <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-508-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>f</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4206\" style=\"width: 0.732em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.58em, 2.503em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4207\"><span class=\"msubsup\" id=\"MathJax-Span-4208\"><span style=\"display: inline-block; position: relative; width: 0.576em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.42em, 4.378em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4209\" style=\"font-family: STIXGeneral-Italic;\">f<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.159em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.263em;\"><span class=\"mi\" id=\"MathJax-Span-4210\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>f</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-508\">f_i</script> counts token assignments and <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-509-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>P</mi><mi>i</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4211\" style=\"width: 1.096em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.305em, 1000.89em, 2.451em, -999.997em); top: -2.133em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4212\"><span class=\"msubsup\" id=\"MathJax-Span-4213\"><span style=\"display: inline-block; position: relative; width: 0.888em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.63em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4214\" style=\"font-family: STIXGeneral-Italic;\">P</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.628em;\"><span class=\"mi\" id=\"MathJax-Span-4215\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">i</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.138em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><msub><mi>P</mi><mi>i</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-509\">P_i</script> is the aggregated routing probability for expert <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-510-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4216\" style=\"width: 0.315em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.263em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.26em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4217\"><span class=\"mi\" id=\"MathJax-Span-4218\" style=\"font-family: STIXGeneral-Italic;\">i</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>i</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-510\">i</script>.</li>\n            </ul>\n<ul>\n              <li>with default hyperparameters <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-514-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B1;</mi><mo>=</mo><mn>0.01</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4297\" style=\"width: 4.273em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.544em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.44em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4298\"><span class=\"mi\" id=\"MathJax-Span-4299\" style=\"font-family: STIXGeneral-Italic;\">α</span><span class=\"mo\" id=\"MathJax-Span-4300\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4301\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.01</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>α</mi><mo>=</mo><mn>0.01</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-514\">\\alpha = 0.01</script>, <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-515-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03B2;</mi><mo>=</mo><mn>0.001</mn></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4302\" style=\"width: 4.846em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 4.013em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.91em, 2.555em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4303\"><span class=\"mi\" id=\"MathJax-Span-4304\" style=\"font-family: STIXGeneral-Italic;\">β<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4305\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">=</span><span class=\"mn\" id=\"MathJax-Span-4306\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">0.001</span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.191em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>β</mi><mo>=</mo><mn>0.001</mn></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-515\">\\beta = 0.001</script>.</li>\n            </ul>\n<p><strong>Efficiency</strong>:</p>\n<ul>\n          <li>MoA can scale to more attention heads with only modest increases in memory/computation.</li>\n          <li>Computation and parameter complexity are reduced relative to standard MHA when <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-516-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>d</mi><mi>h</mi></msub><mo>&amp;#x2248;</mo><msub><mi>d</mi><mi>m</mi></msub></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4307\" style=\"width: 4.482em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 3.701em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1003.7em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4308\"><span class=\"mi\" id=\"MathJax-Span-4309\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span><span class=\"msubsup\" id=\"MathJax-Span-4310\"><span style=\"display: inline-block; position: relative; width: 0.94em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4311\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4312\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">h</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span><span class=\"mo\" id=\"MathJax-Span-4313\" style=\"font-family: STIXGeneral-Regular; padding-left: 0.315em;\">≈</span><span class=\"msubsup\" id=\"MathJax-Span-4314\" style=\"padding-left: 0.315em;\"><span style=\"display: inline-block; position: relative; width: 1.096em; height: 0px;\"><span style=\"position: absolute; clip: rect(3.18em, 1000.52em, 4.169em, -999.997em); top: -4.008em; left: 0em;\"><span class=\"mi\" id=\"MathJax-Span-4315\" style=\"font-family: STIXGeneral-Italic;\">d<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span><span style=\"position: absolute; top: -3.852em; left: 0.523em;\"><span class=\"mi\" id=\"MathJax-Span-4316\" style=\"font-size: 70.7%; font-family: STIXGeneral-Italic;\">m</span><span style=\"display: inline-block; width: 0px; height: 4.013em;\"></span></span></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi><msub><mi>d</mi><mi>h</mi></msub><mo>≈</mo><msub><mi>d</mi><mi>m</mi></msub></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-516\">k d_h \\approx d_m</script>.</li>\n        </ul>\n<p>The following figure from the paper shows the MoA architecture: attention heads are grouped as experts, each token routes to a top-<span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-517-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4317\" style=\"width: 0.628em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1000.52em, 2.346em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4318\"><span class=\"mi\" id=\"MathJax-Span-4319\" style=\"font-family: STIXGeneral-Italic;\">k<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>k</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-517\">k</script> subset, and final outputs are a weighted sum of selected experts’ outputs.</p>\n<p><img src=\"../../../images/papers/MoA.jpg\" alt=\"\"></p>\n<p><strong>Experimental Results</strong>:</p>\n<ul>\n      <li>\n        <p><strong>Machine Translation</strong>:</p>\n\n        <ul>\n          <li>Benchmarked on WMT14 En-De and En-Fr with BLEU scores.</li>\n          <li>MoA-base (8K8E128D) outperforms Transformer-base (28.4 vs. 27.3 BLEU) and matches or beats deeper models with less computation.</li>\n          <li>MoA-big (16K32E256D) achieves near-SOTA with fewer MACs (e.g., 43.7 BLEU vs. Admin-60L-12L’s 43.8, but with less than half the MACs).</li>\n        </ul>\n      </li>\n      <li>\n        <p><strong>Masked Language Modeling</strong>:</p>\n\n        <ul>\n          <li>Evaluated on WikiText-103 using perplexity (PPL).</li>\n          <li>MoA models consistently outperform standard Transformers, with performance improving as number of experts and head dimensions increase, while keeping computational cost nearly fixed.</li>\n        </ul>\n      </li>\n    </ul>\n<p><strong>Machine Translation</strong>:</p>\n<ul>\n          <li>Benchmarked on WMT14 En-De and En-Fr with BLEU scores.</li>\n          <li>MoA-base (8K8E128D) outperforms Transformer-base (28.4 vs. 27.3 BLEU) and matches or beats deeper models with less computation.</li>\n          <li>MoA-big (16K32E256D) achieves near-SOTA with fewer MACs (e.g., 43.7 BLEU vs. Admin-60L-12L’s 43.8, but with less than half the MACs).</li>\n        </ul>\n<p><strong>Masked Language Modeling</strong>:</p>\n<ul>\n          <li>Evaluated on WikiText-103 using perplexity (PPL).</li>\n          <li>MoA models consistently outperform standard Transformers, with performance improving as number of experts and head dimensions increase, while keeping computational cost nearly fixed.</li>\n        </ul>\n<p><strong>Interpretability and Analysis</strong>:</p>\n<ul>\n      <li>MoA allows analysis of <strong>expert load balancing</strong>—experts receive diverse token subsets, with usage roughly balanced.</li>\n      <li>Specialization emerges among experts; PMI analysis reveals certain experts correlate strongly with specific semantic classes (e.g., locations, tech terms, names), indicating improved model interpretability.</li>\n    </ul>\n<p><strong>Implementation Details</strong>:</p>\n<ul>\n      <li>Uses pre-computed shared <span class=\"MathJax_Preview\" style=\"color: inherit; display: none;\"></span><span class=\"MathJax\" id=\"MathJax-Element-518-Frame\" tabindex=\"0\" data-mathml=\"<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi><mo>,</mo><mi>V</mi></math>\" role=\"presentation\" style=\"position: relative;\"><nobr aria-hidden=\"true\"><span class=\"math\" id=\"MathJax-Span-4320\" style=\"width: 2.451em; display: inline-block;\"><span style=\"display: inline-block; position: relative; width: 2.034em; height: 0px; font-size: 120%;\"><span style=\"position: absolute; clip: rect(1.357em, 1002.03em, 2.503em, -999.997em); top: -2.185em; left: 0em;\"><span class=\"mrow\" id=\"MathJax-Span-4321\"><span class=\"mi\" id=\"MathJax-Span-4322\" style=\"font-family: STIXGeneral-Italic;\">K<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span><span class=\"mo\" id=\"MathJax-Span-4323\" style=\"font-family: STIXGeneral-Regular;\">,</span><span class=\"mi\" id=\"MathJax-Span-4324\" style=\"font-family: STIXGeneral-Italic; padding-left: 0.211em;\">V<span style=\"display: inline-block; overflow: hidden; height: 1px; width: 0.055em;\"></span></span></span><span style=\"display: inline-block; width: 0px; height: 2.19em;\"></span></span></span><span style=\"display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;\"></span></span></nobr><span class=\"MJX_Assistive_MathML\" role=\"presentation\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mi>K</mi><mo>,</mo><mi>V</mi></math></span></span><script type=\"math/tex\" id=\"MathJax-Element-518\">K, V</script> projections for all experts.</li>\n      <li>Trained with Adam optimizer and inverse square root scheduler.</li>\n      <li>Evaluated using standard benchmarks and MACs (Multiply–Accumulate Operations) for computational cost.</li>\n    </ul>\n<p><strong>Scalability and Efficiency</strong>:</p>\n<ul>\n      <li>MoA is highly scalable in terms of the number of experts without proportionally increasing compute.</li>\n      <li>Ablation studies confirm the value of auxiliary losses for load balancing and performance.</li>\n      <li>Despite low theoretical compute, implementation needs CUDA-level optimization for faster wall-clock execution.</li>\n    </ul>\n<p><a href=\"https://github.com/yikangshen/MoA\">Code</a></p>",
    "contentMarkdown": "*   This paper by Zhang et al. from Beihang University, Mila, and Tencent introduces the **Mixture of Attention Heads (MoA)**, a novel attention mechanism that integrates the MoE framework into the multi-head attention (MHA) component of Transformer architectures. While previous MoE work mainly focused on feedforward layers, MoA innovatively applies conditional computation to attention heads, allowing different tokens to dynamically select specialized attention heads, thereby improving performance and computational efficiency.\n    \n*   **Core Architecture and Computation**:\n    \n    *   **Model Composition**: MoA replaces the standard MHA with a structure containing:\n        \n        *   A **routing network** that assigns confidence scores to each attention head (called attention experts).\n        *   A **set of attention experts**, each with its own query and output projection weights but shared key and value projections to reduce redundancy.\n    *   **Token-specific Selection**: For each input token, the routing network selects the top-kkk attention experts based on softmax-normalized scores derived from a linear projection of the query. The selected heads’ outputs are weighted by their routing confidence and summed to produce the token-level output:\n        \n        yt\\=∑i∈G(qt)wi,t⋅Ei(qt,K,V)yt\\=∑i∈G(qt)wi,t⋅Ei(qt,K,V)\n        \n        y\\_t = \\\\sum\\_{i \\\\in G(q\\_t)} w\\_{i,t} \\\\cdot E\\_i(q\\_t, K, V)\n    *   **Expert Attention Computation**:\n        \n        *   Each expert performs scaled dot-product attention using its own WqiWiqW^q\\_i and WoiWioW^o\\_i, while sharing WkWkW^k and WvWvW^v across all experts.\n        *   Output per expert: Ei(qt,K,V)\\=Softmax(qtWqi(KWk)Tdh√)VWvWoiEi(qt,K,V)\\=Softmax(qtWiq(KWk)Tdh)VWvWioE\\_i(q\\_t, K, V) = \\\\text{Softmax}\\\\left(\\\\frac{q\\_t W^q\\_i (K W^k)^T}{\\\\sqrt{d\\_h}}\\\\right) V W^v W^o\\_i\n    *   **Training Losses**:\n        \n        *   **Auxiliary Load Balancing Loss** LaLaL\\_a to promote expert usage diversity: La(Q)\\=N⋅∑Ni\\=1fi⋅PiLa(Q)\\=N⋅∑i\\=1Nfi⋅PiL\\_a(Q) = N \\\\cdot \\\\sum\\_{i=1}^{N} f\\_i \\\\cdot P\\_i\n            *   where fifif\\_i counts token assignments and PiPiP\\_i is the aggregated routing probability for expert iii.\n        *   **Router Z-loss** LzLzL\\_z stabilizes training by penalizing large pre-softmax logits: Lz(x)\\=1T∑Tj\\=1(log∑Nt\\=1exi,t)2Lz(x)\\=1T∑j\\=1T(log⁡∑t\\=1Nexi,t)2L\\_z(x) = \\\\frac{1}{T} \\\\sum\\_{j=1}^T \\\\left(\\\\log \\\\sum\\_{t=1}^N e^{x\\_{i,t}} \\\\right)^2\n        *   Total training loss: L\\=Lmodel+∑MoA modules(αLa+βLz)L\\=Lmodel+∑MoA modules(αLa+βLz)L = L\\_\\\\text{model} + \\\\sum\\_{\\\\text{MoA modules}} \\\\left(\\\\alpha L\\_a + \\\\beta L\\_z\\\\right)\n            *   with default hyperparameters α\\=0.01α\\=0.01\\\\alpha = 0.01, β\\=0.001β\\=0.001\\\\beta = 0.001.\n    *   **Efficiency**:\n        \n        *   MoA can scale to more attention heads with only modest increases in memory/computation.\n        *   Computation and parameter complexity are reduced relative to standard MHA when kdh≈dmkdh≈dmk d\\_h \\\\approx d\\_m.\n    *   The following figure from the paper shows the MoA architecture: attention heads are grouped as experts, each token routes to a top-kkk subset, and final outputs are a weighted sum of selected experts’ outputs.\n        \n    \n    ![](../../../images/papers/MoA.jpg)\n    \n*   **Experimental Results**:\n    \n    *   **Machine Translation**:\n        \n        *   Benchmarked on WMT14 En-De and En-Fr with BLEU scores.\n        *   MoA-base (8K8E128D) outperforms Transformer-base (28.4 vs. 27.3 BLEU) and matches or beats deeper models with less computation.\n        *   MoA-big (16K32E256D) achieves near-SOTA with fewer MACs (e.g., 43.7 BLEU vs. Admin-60L-12L’s 43.8, but with less than half the MACs).\n    *   **Masked Language Modeling**:\n        \n        *   Evaluated on WikiText-103 using perplexity (PPL).\n        *   MoA models consistently outperform standard Transformers, with performance improving as number of experts and head dimensions increase, while keeping computational cost nearly fixed.\n*   **Interpretability and Analysis**:\n    \n    *   MoA allows analysis of **expert load balancing**—experts receive diverse token subsets, with usage roughly balanced.\n    *   Specialization emerges among experts; PMI analysis reveals certain experts correlate strongly with specific semantic classes (e.g., locations, tech terms, names), indicating improved model interpretability.\n*   **Implementation Details**:\n    \n    *   Uses pre-computed shared K,VK,VK, V projections for all experts.\n    *   Trained with Adam optimizer and inverse square root scheduler.\n    *   Evaluated using standard benchmarks and MACs (Multiply–Accumulate Operations) for computational cost.\n*   **Scalability and Efficiency**:\n    \n    *   MoA is highly scalable in terms of the number of experts without proportionally increasing compute.\n    *   Ablation studies confirm the value of auxiliary losses for load balancing and performance.\n    *   Despite low theoretical compute, implementation needs CUDA-level optimization for faster wall-clock execution.\n*   [Code](https://github.com/yikangshen/MoA)\n    \n\nThis paper by Zhang et al. from Beihang University, Mila, and Tencent introduces the **Mixture of Attention Heads (MoA)**, a novel attention mechanism that integrates the MoE framework into the multi-head attention (MHA) component of Transformer architectures. While previous MoE work mainly focused on feedforward layers, MoA innovatively applies conditional computation to attention heads, allowing different tokens to dynamically select specialized attention heads, thereby improving performance and computational efficiency.\n\n**Core Architecture and Computation**:\n\n*   **Model Composition**: MoA replaces the standard MHA with a structure containing:\n    \n    *   A **routing network** that assigns confidence scores to each attention head (called attention experts).\n    *   A **set of attention experts**, each with its own query and output projection weights but shared key and value projections to reduce redundancy.\n*   **Token-specific Selection**: For each input token, the routing network selects the top-kkk attention experts based on softmax-normalized scores derived from a linear projection of the query. The selected heads’ outputs are weighted by their routing confidence and summed to produce the token-level output:\n    \n    yt\\=∑i∈G(qt)wi,t⋅Ei(qt,K,V)yt\\=∑i∈G(qt)wi,t⋅Ei(qt,K,V)\n    \n    y\\_t = \\\\sum\\_{i \\\\in G(q\\_t)} w\\_{i,t} \\\\cdot E\\_i(q\\_t, K, V)\n*   **Expert Attention Computation**:\n    \n    *   Each expert performs scaled dot-product attention using its own WqiWiqW^q\\_i and WoiWioW^o\\_i, while sharing WkWkW^k and WvWvW^v across all experts.\n    *   Output per expert: Ei(qt,K,V)\\=Softmax(qtWqi(KWk)Tdh√)VWvWoiEi(qt,K,V)\\=Softmax(qtWiq(KWk)Tdh)VWvWioE\\_i(q\\_t, K, V) = \\\\text{Softmax}\\\\left(\\\\frac{q\\_t W^q\\_i (K W^k)^T}{\\\\sqrt{d\\_h}}\\\\right) V W^v W^o\\_i\n*   **Training Losses**:\n    \n    *   **Auxiliary Load Balancing Loss** LaLaL\\_a to promote expert usage diversity: La(Q)\\=N⋅∑Ni\\=1fi⋅PiLa(Q)\\=N⋅∑i\\=1Nfi⋅PiL\\_a(Q) = N \\\\cdot \\\\sum\\_{i=1}^{N} f\\_i \\\\cdot P\\_i\n        *   where fifif\\_i counts token assignments and PiPiP\\_i is the aggregated routing probability for expert iii.\n    *   **Router Z-loss** LzLzL\\_z stabilizes training by penalizing large pre-softmax logits: Lz(x)\\=1T∑Tj\\=1(log∑Nt\\=1exi,t)2Lz(x)\\=1T∑j\\=1T(log⁡∑t\\=1Nexi,t)2L\\_z(x) = \\\\frac{1}{T} \\\\sum\\_{j=1}^T \\\\left(\\\\log \\\\sum\\_{t=1}^N e^{x\\_{i,t}} \\\\right)^2\n    *   Total training loss: L\\=Lmodel+∑MoA modules(αLa+βLz)L\\=Lmodel+∑MoA modules(αLa+βLz)L = L\\_\\\\text{model} + \\\\sum\\_{\\\\text{MoA modules}} \\\\left(\\\\alpha L\\_a + \\\\beta L\\_z\\\\right)\n        *   with default hyperparameters α\\=0.01α\\=0.01\\\\alpha = 0.01, β\\=0.001β\\=0.001\\\\beta = 0.001.\n*   **Efficiency**:\n    \n    *   MoA can scale to more attention heads with only modest increases in memory/computation.\n    *   Computation and parameter complexity are reduced relative to standard MHA when kdh≈dmkdh≈dmk d\\_h \\\\approx d\\_m.\n*   The following figure from the paper shows the MoA architecture: attention heads are grouped as experts, each token routes to a top-kkk subset, and final outputs are a weighted sum of selected experts’ outputs.\n    \n\n**Model Composition**: MoA replaces the standard MHA with a structure containing:\n\n*   A **routing network** that assigns confidence scores to each attention head (called attention experts).\n*   A **set of attention experts**, each with its own query and output projection weights but shared key and value projections to reduce redundancy.\n\n**Token-specific Selection**: For each input token, the routing network selects the top-kkk attention experts based on softmax-normalized scores derived from a linear projection of the query. The selected heads’ outputs are weighted by their routing confidence and summed to produce the token-level output:\n\n**Expert Attention Computation**:\n\n*   Each expert performs scaled dot-product attention using its own WqiWiqW^q\\_i and WoiWioW^o\\_i, while sharing WkWkW^k and WvWvW^v across all experts.\n*   Output per expert: Ei(qt,K,V)\\=Softmax(qtWqi(KWk)Tdh√)VWvWoiEi(qt,K,V)\\=Softmax(qtWiq(KWk)Tdh)VWvWioE\\_i(q\\_t, K, V) = \\\\text{Softmax}\\\\left(\\\\frac{q\\_t W^q\\_i (K W^k)^T}{\\\\sqrt{d\\_h}}\\\\right) V W^v W^o\\_i\n\n**Training Losses**:\n\n*   **Auxiliary Load Balancing Loss** LaLaL\\_a to promote expert usage diversity: La(Q)\\=N⋅∑Ni\\=1fi⋅PiLa(Q)\\=N⋅∑i\\=1Nfi⋅PiL\\_a(Q) = N \\\\cdot \\\\sum\\_{i=1}^{N} f\\_i \\\\cdot P\\_i\n    *   where fifif\\_i counts token assignments and PiPiP\\_i is the aggregated routing probability for expert iii.\n*   **Router Z-loss** LzLzL\\_z stabilizes training by penalizing large pre-softmax logits: Lz(x)\\=1T∑Tj\\=1(log∑Nt\\=1exi,t)2Lz(x)\\=1T∑j\\=1T(log⁡∑t\\=1Nexi,t)2L\\_z(x) = \\\\frac{1}{T} \\\\sum\\_{j=1}^T \\\\left(\\\\log \\\\sum\\_{t=1}^N e^{x\\_{i,t}} \\\\right)^2\n*   Total training loss: L\\=Lmodel+∑MoA modules(αLa+βLz)L\\=Lmodel+∑MoA modules(αLa+βLz)L = L\\_\\\\text{model} + \\\\sum\\_{\\\\text{MoA modules}} \\\\left(\\\\alpha L\\_a + \\\\beta L\\_z\\\\right)\n    *   with default hyperparameters α\\=0.01α\\=0.01\\\\alpha = 0.01, β\\=0.001β\\=0.001\\\\beta = 0.001.\n\n*   where fifif\\_i counts token assignments and PiPiP\\_i is the aggregated routing probability for expert iii.\n\n*   with default hyperparameters α\\=0.01α\\=0.01\\\\alpha = 0.01, β\\=0.001β\\=0.001\\\\beta = 0.001.\n\n**Efficiency**:\n\n*   MoA can scale to more attention heads with only modest increases in memory/computation.\n*   Computation and parameter complexity are reduced relative to standard MHA when kdh≈dmkdh≈dmk d\\_h \\\\approx d\\_m.\n\nThe following figure from the paper shows the MoA architecture: attention heads are grouped as experts, each token routes to a top-kkk subset, and final outputs are a weighted sum of selected experts’ outputs.\n\n![](../../../images/papers/MoA.jpg)\n\n**Experimental Results**:\n\n*   **Machine Translation**:\n    \n    *   Benchmarked on WMT14 En-De and En-Fr with BLEU scores.\n    *   MoA-base (8K8E128D) outperforms Transformer-base (28.4 vs. 27.3 BLEU) and matches or beats deeper models with less computation.\n    *   MoA-big (16K32E256D) achieves near-SOTA with fewer MACs (e.g., 43.7 BLEU vs. Admin-60L-12L’s 43.8, but with less than half the MACs).\n*   **Masked Language Modeling**:\n    \n    *   Evaluated on WikiText-103 using perplexity (PPL).\n    *   MoA models consistently outperform standard Transformers, with performance improving as number of experts and head dimensions increase, while keeping computational cost nearly fixed.\n\n**Machine Translation**:\n\n*   Benchmarked on WMT14 En-De and En-Fr with BLEU scores.\n*   MoA-base (8K8E128D) outperforms Transformer-base (28.4 vs. 27.3 BLEU) and matches or beats deeper models with less computation.\n*   MoA-big (16K32E256D) achieves near-SOTA with fewer MACs (e.g., 43.7 BLEU vs. Admin-60L-12L’s 43.8, but with less than half the MACs).\n\n**Masked Language Modeling**:\n\n*   Evaluated on WikiText-103 using perplexity (PPL).\n*   MoA models consistently outperform standard Transformers, with performance improving as number of experts and head dimensions increase, while keeping computational cost nearly fixed.\n\n**Interpretability and Analysis**:\n\n*   MoA allows analysis of **expert load balancing**—experts receive diverse token subsets, with usage roughly balanced.\n*   Specialization emerges among experts; PMI analysis reveals certain experts correlate strongly with specific semantic classes (e.g., locations, tech terms, names), indicating improved model interpretability.\n\n**Implementation Details**:\n\n*   Uses pre-computed shared K,VK,VK, V projections for all experts.\n*   Trained with Adam optimizer and inverse square root scheduler.\n*   Evaluated using standard benchmarks and MACs (Multiply–Accumulate Operations) for computational cost.\n\n**Scalability and Efficiency**:\n\n*   MoA is highly scalable in terms of the number of experts without proportionally increasing compute.\n*   Ablation studies confirm the value of auxiliary losses for load balancing and performance.\n*   Despite low theoretical compute, implementation needs CUDA-level optimization for faster wall-clock execution.\n\n[Code](https://github.com/yikangshen/MoA)",
    "contentLength": 234704,
    "wordCount": 1568,
    "hasCode": false,
    "hasMath": true,
    "hasImages": true,
    "url": "https://aman.ai/primers/ai/mixture-of-experts/#mixture-of-attention-heads:-selecting-attention-heads-per-token"
  }
]